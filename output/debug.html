<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LLM å­¦ä¹ æŒ‡å—</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <style>
    /* LLM å­¦ä¹ æŒ‡å— - ç”µå­ä¹¦æ ·å¼ */

/* === åŸºç¡€è®¾ç½® === */
@page {
  size: A4;
  margin: 25mm;
}

@media print {
  .page-break {
    page-break-before: always;
  }
}

/* === å­—ä½“å®šä¹‰ === */
:root {
  --font-chinese: "Noto Sans SC", "PingFang SC", "Microsoft YaHei", "Hiragino Sans GB", sans-serif;
  --font-code: "Fira Code", "SF Mono", "Monaco", "Consolas", "Liberation Mono", monospace;
  --font-main: var(--font-chinese);
}

/* === æ­£æ–‡æ ·å¼ === */
body {
  font-family: var(--font-main);
  font-size: 12pt;
  line-height: 1.8;
  color: #333;
  text-align: justify;
  hyphens: auto;
}

/* === ç« èŠ‚æ ‡é¢˜æ ·å¼ (h1-h6) === */
h1 {
  font-size: 24pt;
  font-weight: bold;
  color: #1a1a1a;
  margin-top: 0;
  margin-bottom: 24pt;
  padding-bottom: 12pt;
  border-bottom: 2px solid #333;
  page-break-after: avoid;
}

h2 {
  font-size: 18pt;
  font-weight: bold;
  color: #2a2a2a;
  margin-top: 24pt;
  margin-bottom: 12pt;
  page-break-after: avoid;
}

h3 {
  font-size: 14pt;
  font-weight: bold;
  color: #3a3a3a;
  margin-top: 18pt;
  margin-bottom: 10pt;
  page-break-after: avoid;
}

h4 {
  font-size: 12pt;
  font-weight: bold;
  color: #4a4a4a;
  margin-top: 14pt;
  margin-bottom: 8pt;
  page-break-after: avoid;
}

h5 {
  font-size: 11pt;
  font-weight: bold;
  color: #5a5a5a;
  margin-top: 12pt;
  margin-bottom: 6pt;
  page-break-after: avoid;
}

h6 {
  font-size: 10pt;
  font-weight: bold;
  color: #6a6a6a;
  margin-top: 10pt;
  margin-bottom: 6pt;
  page-break-after: avoid;
}

/* === æ®µè½æ ·å¼ === */
p {
  margin-top: 0;
  margin-bottom: 12pt;
  text-indent: 2em;
}

/* é¦–æ®µä¸ç¼©è¿› */
h1 + p,
h2 + p,
h3 + p,
h4 + p {
  text-indent: 0;
}

/* === ä»£ç å—æ ·å¼ === */
pre {
  font-family: var(--font-code);
  font-size: 9pt;
  line-height: 1.5;
  background-color: #f8f9fa;
  border: 1px solid #e9ecef;
  border-radius: 4pt;
  padding: 12pt;
  margin-top: 12pt;
  margin-bottom: 12pt;
  overflow-x: auto;
  white-space: pre-wrap;
  word-wrap: break-word;
}

code {
  font-family: var(--font-code);
  font-size: 9pt;
  background-color: #f1f3f4;
  padding: 2pt 4pt;
  border-radius: 2pt;
}

/* è¡Œå†…ä»£ç  */
p code,
li code {
  font-size: 10pt;
}

/* === è¯­æ³•é«˜äº® === */
.hljs-keyword { color: #d73a49; }
.hljs-string { color: #032f62; }
.hljs-number { color: #005cc5; }
.hljs-comment { color: #6a737d; font-style: italic; }
.hljs-function { color: #6f42c1; }
.hljs-class { color: #6f42c1; }
.hljs-variable { color: #e36209; }
.hljs-operator { color: #d73a49; }
.hljs-punctuation { color: #24292e; }
.hljs-built_in { color: #005cc5; }
.hljs-literal { color: #005cc5; }
.hljs-params { color: #24292e; }
.hljs-title { color: #6f42c1; }
.hljs-meta { color: #005cc5; }

/* === è¡¨æ ¼æ ·å¼ === */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 12pt;
  margin-bottom: 12pt;
  font-size: 10pt;
}

th {
  background-color: #f1f3f4;
  font-weight: bold;
  text-align: left;
  padding: 8pt 10pt;
  border: 1px solid #dfe2e5;
}

td {
  padding: 8pt 10pt;
  border: 1px solid #dfe2e5;
}

tr:nth-child(even) {
  background-color: #fafbfc;
}

/* === åˆ—è¡¨æ ·å¼ === */
ul, ol {
  margin-top: 8pt;
  margin-bottom: 12pt;
  padding-left: 24pt;
}

li {
  margin-bottom: 6pt;
  line-height: 1.6;
}

/* åµŒå¥—åˆ—è¡¨ */
ul ul, ol ol, ul ol, ol ul {
  margin-top: 6pt;
  margin-bottom: 6pt;
}

/* === é“¾æ¥æ ·å¼ === */
a {
  color: #0366d6;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

/* === å¼•ç”¨å—æ ·å¼ === */
blockquote {
  margin: 12pt 0;
  padding: 12pt 16pt;
  border-left: 4pt solid #dfe2e5;
  background-color: #f8f9fa;
  color: #6a737d;
}

blockquote p {
  margin-bottom: 0;
  text-indent: 0;
}

/* === Mermaid å›¾è¡¨æ ·å¼ === */
.mermaid {
  text-align: center;
  margin: 16pt 0;
}

/* === KaTeX æ•°å­¦å…¬å¼æ ·å¼ === */
.katex-display {
  margin: 16pt 0;
  text-align: center;
}

.katex {
  font-size: 11pt;
}

/* === å›¾ç‰‡æ ·å¼ === */
img {
  max-width: 100%;
  height: auto;
  display: block;
  margin: 12pt auto;
}

/* === åˆ†éš”çº¿ === */
hr {
  border: none;
  border-top: 1px solid #e9ecef;
  margin: 24pt 0;
}

/* === ç›®å½•æ ·å¼ === */
.toc {
  page-break-after: always;
}

.toc h1 {
  text-align: center;
  font-size: 20pt;
  margin-bottom: 24pt;
  border-bottom: none;
}

.toc ul {
  list-style: none;
  padding-left: 0;
}

.toc li {
  margin-bottom: 10pt;
  font-size: 12pt;
}

.toc a {
  color: #333;
}

/* ç›®å½•ç« èŠ‚æ ‡é¢˜ */
.toc-chapter {
  font-weight: bold;
}

/* === ä»£ç é™„å½•æ ·å¼ === */
.code-appendix {
  margin-top: 24pt;
  padding-top: 12pt;
  border-top: 2px solid #333;
}

.code-appendix h2 {
  font-size: 14pt;
  margin-top: 0;
}

.code-file {
  margin-top: 16pt;
}

.code-file h3 {
  font-size: 11pt;
  color: #555;
  font-family: var(--font-code);
  margin-bottom: 8pt;
}

/* === ç« èŠ‚åˆ†éš” === */
.chapter {
  page-break-before: always;
}

.chapter:first-of-type {
  page-break-before: avoid;
}

/* === å­ç« èŠ‚æ ‡é¢˜ === */
.subtopic-title {
  font-size: 16pt;
  font-weight: bold;
  color: #2a2a2a;
  margin-top: 24pt;
  margin-bottom: 12pt;
  padding-bottom: 8pt;
  border-bottom: 1px solid #ccc;
}

/* === æ‰“å°ä¼˜åŒ– === */
@media print {
  body {
    font-size: 11pt;
  }

  pre {
    font-size: 8pt;
  }

  code {
    font-size: 8pt;
  }

  h1 {
    font-size: 22pt;
  }

  h2 {
    font-size: 16pt;
  }

  h3 {
    font-size: 13pt;
  }
}

  </style>
</head>
<body>
  <div class="toc"><h1>ç›®å½•</h1><ul><li class="toc-chapter">ç¬¬1ç«  ç®€ä»‹ä¸å­¦ä¹ è·¯å¾„</li><li class="toc-chapter">ç¬¬2ç«  Embedding åµŒå…¥å±‚</li><ul><li>2.1 è¯åµŒå…¥ (Word Embedding)</li><li>2.2 ä½ç½®åµŒå…¥ (Position Embedding)</li></ul><li class="toc-chapter">ç¬¬3ç«  Normalization å½’ä¸€åŒ–</li><li class="toc-chapter">ç¬¬4ç«  Activation æ¿€æ´»å‡½æ•°</li><li class="toc-chapter">ç¬¬5ç«  Attention æ³¨æ„åŠ›æœºåˆ¶</li><li class="toc-chapter">ç¬¬6ç«  FFN å‰é¦ˆç½‘ç»œå±‚</li><li class="toc-chapter">ç¬¬7ç«  Encoder ç¼–ç å™¨</li><li class="toc-chapter">ç¬¬8ç«  Decoder è§£ç å™¨</li><li class="toc-chapter">ç¬¬9ç«  MoE æ··åˆä¸“å®¶æ¨¡å‹</li><li class="toc-chapter">ç¬¬10ç«  Fine-tuning å¾®è°ƒæŠ€æœ¯</li><ul><li>10.1 å…¨é‡å¾®è°ƒ (Full Fine-tuning)</li><li>10.2 LoRA å¾®è°ƒ</li></ul><li class="toc-chapter">ç¬¬11ç«  Quantization æ¨¡å‹é‡åŒ–</li><li class="toc-chapter">ç¬¬12ç«  Inference Acceleration æ¨ç†åŠ é€Ÿ</li><li class="toc-chapter">é™„å½•ï¼šå…¬å¼è¯¦è§£</li></ul></div><div class="chapter"><h1>ç¬¬1ç«  ç®€ä»‹ä¸å­¦ä¹ è·¯å¾„</h1><h1>LLM æ ¸å¿ƒç»„ä»¶å­¦ä¹ æŒ‡å—</h1>
<p>æœ¬ç›®å½•åŒ…å«å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰æ ¸å¿ƒç»„ä»¶çš„å­¦ä¹ èµ„æ–™ï¼Œæ¶µç›–ä»åŸºç¡€åˆ°è¿›é˜¶çš„å®Œæ•´çŸ¥è¯†ä½“ç³»ã€‚</p>
<h2>æ¨¡å—ç»“æ„</h2>
<pre class="hljs"><code>topics/
â”œâ”€â”€ embedding/        # åµŒå…¥å±‚
â”‚   â”œâ”€â”€ word-embedding/
â”‚   â””â”€â”€ position-embedding/
â”œâ”€â”€ normalization/    # å½’ä¸€åŒ–
â”œâ”€â”€ activation/       # æ¿€æ´»å‡½æ•°
â”œâ”€â”€ attention/        # æ³¨æ„åŠ›æœºåˆ¶
â”œâ”€â”€ encoder/          # ç¼–ç å™¨
â”œâ”€â”€ decoder/          # è§£ç å™¨
â”œâ”€â”€ ffn/              # å‰é¦ˆç½‘ç»œå±‚
â”œâ”€â”€ moe/              # æ··åˆä¸“å®¶æ¨¡å‹
â”œâ”€â”€ fine-tuning/      # å¾®è°ƒæŠ€æœ¯
â”‚   ï¿½ï¿½â”€â”€ lora-finetune/
â”‚   â””â”€â”€ full-finetune/
â””â”€â”€ inference/        # æ¨ç†ä¼˜åŒ–
    â”œâ”€â”€ quantization/
    â””â”€â”€ inference-acceleration/
</code></pre>
<h2>æ¨èå­¦ä¹ è·¯å¾„</h2>
<h3>ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€çŸ¥è¯†</h3>
<p>æŒ‰ç…§ä»¥ä¸‹é¡ºåºå­¦ä¹ åŸºç¡€ç»„ä»¶ï¼š</p>
<ol>
<li>
<p><strong><a href="embedding/README.md">Embeddingï¼ˆåµŒå…¥ï¼‰</a></strong></p>
<ul>
<li>ç†è§£å¦‚ä½•å°†ç¦»æ•£ç¬¦å·è½¬æ¢ä¸ºè¿ç»­å‘é‡</li>
<li>è¯åµŒå…¥å’Œä½ç½®åµŒå…¥æ˜¯æ‰€æœ‰ LLM çš„è¾“å…¥å±‚</li>
</ul>
</li>
<li>
<p><strong><a href="normalization/beginner-guide.md">å½’ä¸€åŒ–ï¼ˆNormalizationï¼‰</a></strong></p>
<ul>
<li>LayerNormã€RMSNorm çš„åŸç†</li>
<li>ç†è§£ä¸ºä»€ä¹ˆ Transformer éœ€è¦ Pre-LN</li>
</ul>
</li>
<li>
<p><strong><a href="activation/beginner-guide.md">æ¿€æ´»å‡½æ•°ï¼ˆActivationï¼‰</a></strong></p>
<ul>
<li>ReLUã€GELUã€Swish çš„ç‰¹ç‚¹</li>
<li>ä¸ºä»€ä¹ˆ Transformer ä½¿ç”¨ GELU</li>
</ul>
</li>
</ol>
<h3>ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒæœºåˆ¶</h3>
<ol start="4">
<li>
<p><strong><a href="attention/beginner-guide.md">æ³¨æ„åŠ›æœºåˆ¶ï¼ˆAttentionï¼‰</a></strong></p>
<ul>
<li>Self-Attention çš„æ ¸å¿ƒæ€æƒ³</li>
<li>Multi-Head Attention çš„è®¾è®¡åŠ¨æœº</li>
<li>è¿™æ˜¯ Transformer çš„&quot;å¿ƒè„&quot;</li>
</ul>
</li>
<li>
<p><strong><a href="ffn/beginner-guide.md">å‰é¦ˆç½‘ç»œå±‚ï¼ˆFFNï¼‰</a></strong></p>
<ul>
<li>FFN çš„&quot;å‡ç»´-æ¿€æ´»-é™ç»´&quot;ç»“æ„</li>
<li>SwiGLU ç­‰ç°ä»£å˜ä½“</li>
<li>çŸ¥è¯†å­˜å‚¨çš„è½½ä½“</li>
</ul>
</li>
</ol>
<h3>ç¬¬ä¸‰é˜¶æ®µï¼šæ¶æ„ç†è§£</h3>
<ol start="6">
<li>
<p><strong><a href="encoder/beginner-guide.md">ç¼–ç å™¨ï¼ˆEncoderï¼‰</a></strong></p>
<ul>
<li>åŒå‘ä¸Šä¸‹æ–‡ç†è§£</li>
<li>BERT æ¶æ„è¯¦è§£</li>
<li>é€‚åˆç†è§£ä»»åŠ¡</li>
</ul>
</li>
<li>
<p><strong><a href="decoder/beginner-guide.md">è§£ç å™¨ï¼ˆDecoderï¼‰</a></strong></p>
<ul>
<li>è‡ªå›å½’ç”ŸæˆåŸç†</li>
<li>GPT æ¶æ„è¯¦è§£</li>
<li>KV Cache ä¼˜åŒ–</li>
</ul>
</li>
</ol>
<h3>ç¬¬å››é˜¶æ®µï¼šè¿›é˜¶ä¸»ï¿½ï¿½</h3>
<ol start="8">
<li><strong><a href="moe/beginner-guide.md">æ··åˆä¸“å®¶æ¨¡å‹ï¼ˆMoEï¼‰</a></strong>
<ul>
<li>ç¨€ç–æ¿€æ´»åŸç†</li>
<li>è·¯ç”±ç­–ç•¥è®¾è®¡</li>
<li>ç°ä»£å¤§æ¨¡å‹çš„æ ¸å¿ƒæŠ€æœ¯</li>
</ul>
</li>
</ol>
<h3>ç¬¬äº”é˜¶æ®µï¼šå¾®è°ƒä¸éƒ¨ç½²</h3>
<ol start="9">
<li>
<p><strong><a href="fine-tuning/README.md">å¾®è°ƒæŠ€æœ¯ï¼ˆFine-tuningï¼‰</a></strong></p>
<ul>
<li>LoRA/QLoRA å‚æ•°é«˜æ•ˆå¾®è°ƒ</li>
<li>å…¨å‚æ•°å¾®è°ƒ</li>
<li>æ¨¡ï¿½ï¿½é€‚é…ç‰¹å®šä»»åŠ¡</li>
</ul>
</li>
<li>
<p><strong><a href="inference/README.md">æ¨ç†ä¼˜åŒ–ï¼ˆInferenceï¼‰</a></strong></p>
<ul>
<li>æ¨¡å‹é‡åŒ–ï¼ˆGPTQã€AWQï¼‰</li>
<li>æ¨ç†åŠ é€Ÿï¼ˆvLLMã€KV Cacheï¼‰</li>
<li>é«˜æ•ˆéƒ¨ç½²å¤§æ¨¡å‹</li>
</ul>
</li>
</ol>
<h2>æ¯ä¸ªæ¨¡å—çš„å†…å®¹</h2>
<p>æ¯ä¸ªä¸»é¢˜ç›®å½•åŒ…å«ï¼š</p>
<table>
<thead>
<tr>
<th>æ–‡ä»¶</th>
<th>å†…å®¹</th>
<th>é€‚åˆè¯»è€…</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>beginner-guide.md</code></td>
<td>ç§‘æ™®ç‰ˆï¼Œä½¿ç”¨ç±»æ¯”å’Œç›´è§‚è§£é‡Š</td>
<td>é›¶åŸºç¡€è¯»è€…</td>
</tr>
<tr>
<td><code>advanced-guide.md</code></td>
<td>æ·±å…¥ç‰ˆï¼ŒåŒ…å«æ•°å­¦æ¨å¯¼å’Œè®ºæ–‡å¼•ç”¨</td>
<td>æœ‰ ML åŸºç¡€çš„è¯»è€…</td>
</tr>
<tr>
<td><code>diagram.md</code></td>
<td>æµç¨‹å›¾è§£ï¼ŒMermaid å¯è§†åŒ–</td>
<td>æ‰€æœ‰è¯»è€…</td>
</tr>
<tr>
<td><code>examples/</code></td>
<td>Python ä»£ç ç¤ºä¾‹ï¼Œå¯è¿è¡Œ</td>
<td>æ‰€æœ‰è¯»è€…</td>
</tr>
</tbody>
</table>
<h2>å¿«é€Ÿç´¢å¼•</h2>
<h3>æŒ‰ç»„ä»¶ç±»å‹</h3>
<table>
<thead>
<tr>
<th>ç»„ä»¶</th>
<th>ä½œç”¨</th>
<th>ä»£è¡¨æ¨¡å‹</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="embedding/">Embedding</a></td>
<td>è¾“å…¥è¡¨ç¤º</td>
<td>æ‰€æœ‰ LLM</td>
</tr>
<tr>
<td><a href="normalization/">Normalization</a></td>
<td>ç¨³å®šè®­ç»ƒ</td>
<td>æ‰€æœ‰ LLM</td>
</tr>
<tr>
<td><a href="attention/">Attention</a></td>
<td>ä¿¡æ¯èšåˆ</td>
<td>æ‰€æœ‰ Transformer</td>
</tr>
<tr>
<td><a href="ffn/">FFN</a></td>
<td>ç‰¹å¾å˜æ¢</td>
<td>æ‰€æœ‰ Transformer</td>
</tr>
<tr>
<td><a href="encoder/">Encoder</a></td>
<td>åŒå‘ç†è§£</td>
<td>BERT</td>
</tr>
<tr>
<td><a href="decoder/">Decoder</a></td>
<td>è‡ªå›å½’ç”Ÿæˆ</td>
<td>GPT</td>
</tr>
<tr>
<td><a href="moe/">MoE</a></td>
<td>é«˜æ•ˆæ‰©å±•</td>
<td>Mixtral, DeepSeek</td>
</tr>
<tr>
<td><a href="fine-tuning/">Fine-tuning</a></td>
<td>æ¨¡å‹é€‚é…</td>
<td>é¢†åŸŸå®šåˆ¶</td>
</tr>
<tr>
<td><a href="inference/">Inference</a></td>
<td>é«˜æ•ˆéƒ¨ç½²</td>
<td>ç”Ÿäº§ç¯å¢ƒ</td>
</tr>
</tbody>
</table>
<h3>æŒ‰æ¨¡å‹æ¶æ„</h3>
<table>
<thead>
<tr>
<th>æ¨¡å‹ç±»å‹</th>
<th>æ ¸å¿ƒç»„ä»¶</th>
<th>å­¦ä¹ é‡ç‚¹</th>
</tr>
</thead>
<tbody>
<tr>
<td>BERT</td>
<td>Encoder</td>
<td>åŒå‘æ³¨æ„åŠ›ã€MLM é¢„è®­ç»ƒ</td>
</tr>
<tr>
<td>GPT</td>
<td>Decoder</td>
<td>å› æœæ©ç ã€è‡ªå›å½’ç”Ÿæˆã€KV Cache</td>
</tr>
<tr>
<td>T5</td>
<td>Encoder + Decoder</td>
<td>Cross-Attentionã€æ¡ä»¶ç”Ÿæˆ</td>
</tr>
<tr>
<td>LLaMA</td>
<td>Decoder (w/ RMSNorm + SwiGLU)</td>
<td>ç°ä»£ä¼˜åŒ–æŠ€æœ¯</td>
</tr>
<tr>
<td>Mixtral</td>
<td>MoE Decoder</td>
<td>ç¨€ç–è·¯ç”±ã€è´Ÿè½½å‡è¡¡</td>
</tr>
</tbody>
</table>
<h2>å­¦ä¹ å»ºè®®</h2>
<ol>
<li><strong>å¾ªåºæ¸è¿›</strong>ï¼šæŒ‰ç…§æ¨èè·¯å¾„å­¦ä¹ ï¼Œå‰é¢çš„çŸ¥è¯†æ˜¯åé¢çš„åŸºç¡€</li>
<li><strong>åŠ¨æ‰‹å®è·µ</strong>ï¼šè¿è¡Œ <code>examples/</code> ä¸­çš„ä»£ç ï¼ŒåŠ æ·±ç†è§£</li>
<li><strong>å¯¹æ¯”å­¦ä¹ </strong>ï¼šæ¯”è¾ƒ Encoder å’Œ Decoder çš„åŒºåˆ«</li>
<li><strong>å…³æ³¨ç»†èŠ‚</strong>ï¼šå¦‚ Pre-LN vs Post-LNã€ä¸åŒæ¿€æ´»å‡½æ•°çš„é€‰æ‹©</li>
</ol>
<h2>å‰ç½®çŸ¥è¯†</h2>
<ul>
<li><strong>ç§‘æ™®ç‰ˆ</strong>ï¼šæ— éœ€ä»»ä½•åŸºç¡€</li>
<li><strong>æ·±å…¥ç‰ˆ</strong>ï¼šçº¿æ€§ä»£æ•°ã€æ¦‚ç‡è®ºã€æœºå™¨å­¦ä¹ åŸºç¡€</li>
<li><strong>ä»£ç ç¤ºä¾‹</strong>ï¼šPythonã€PyTorch åŸºç¡€</li>
</ul>
<h2>å‚è€ƒèµ„æº</h2>
<ul>
<li><a href="https://arxiv.org/abs/1706.03762">Attention Is All You Need</a> - Transformer åŸå§‹è®ºæ–‡</li>
<li><a href="https://arxiv.org/abs/1810.04805">BERT</a> - åŒå‘ç¼–ç å™¨</li>
<li><a href="https://arxiv.org/abs/2005.14165">GPT-3</a> - è‡ªå›å½’è§£ç å™¨</li>
<li><a href="https://arxiv.org/abs/2302.13971">LLaMA</a> - ç°ä»£ LLM æ¶æ„</li>
<li><a href="https://arxiv.org/abs/2401.04088">Mixtral</a> - MoE æ¶æ„</li>
</ul>
</div><div class="chapter"><h1>ç¬¬2ç«  Embedding åµŒå…¥å±‚</h1><h1>Embeddingï¼ˆåµŒå…¥ï¼‰</h1>
<p>Embedding æ˜¯å°†ç¦»æ•£çš„ç¬¦å·ï¼ˆå¦‚å•è¯ã€ä½ç½®ï¼‰æ˜ å°„åˆ°è¿ç»­å‘é‡ç©ºé—´çš„æŠ€æœ¯ã€‚å®ƒæ˜¯ç°ä»£æ·±åº¦å­¦ä¹ å’Œè‡ªç„¶è¯­è¨€å¤„ç†çš„åŸºçŸ³ã€‚</p>
<h2>æ¨¡å—ç»“æ„</h2>
<pre class="hljs"><code>embedding/
â”œâ”€â”€ word-embedding/      # è¯åµŒå…¥
â”‚   â”œâ”€â”€ beginner-guide.md
â”‚   â”œâ”€â”€ advanced-guide.md
â”‚   â””â”€â”€ examples/
â””â”€â”€ position-embedding/  # ä½ç½®åµŒå…¥
    â”œâ”€â”€ beginner-guide.md
    â”œâ”€â”€ advanced-guide.md
    â””â”€â”€ examples/
</code></pre>
<h2>å­¦ä¹ è·¯å¾„</h2>
<h3>1. Word Embeddingï¼ˆè¯åµŒå…¥ï¼‰</h3>
<p>å°†è¯è¯­è½¬æ¢ä¸ºç¨ å¯†å‘é‡è¡¨ç¤ºï¼Œä½¿è¯­ä¹‰ç›¸è¿‘çš„è¯åœ¨å‘é‡ç©ºé—´ä¸­è·ç¦»ç›¸è¿‘ã€‚</p>
<ul>
<li><strong>ç§‘æ™®ç‰ˆ</strong>: <a href="word-embedding/beginner-guide.md">beginner-guide.md</a> - é€‚åˆé›¶åŸºç¡€è¯»è€…</li>
<li><strong>æ·±å…¥ç‰ˆ</strong>: <a href="word-embedding/advanced-guide.md">advanced-guide.md</a> - é€‚åˆæœ‰æœºå™¨å­¦ä¹ åŸºç¡€çš„è¯»è€…</li>
</ul>
<h3>2. Position Embeddingï¼ˆä½ç½®åµŒå…¥ï¼‰</h3>
<p>ä¸ºåºåˆ—ä¸­çš„æ¯ä¸ªä½ç½®ç”Ÿæˆå”¯ä¸€çš„å‘é‡è¡¨ç¤ºï¼Œè®©æ¨¡å‹èƒ½å¤Ÿç†è§£è¯åºä¿¡æ¯ã€‚</p>
<ul>
<li><strong>ç§‘æ™®ç‰ˆ</strong>: <a href="position-embedding/beginner-guide.md">beginner-guide.md</a> - é€‚åˆé›¶åŸºç¡€è¯»è€…</li>
<li><strong>æ·±å…¥ç‰ˆ</strong>: <a href="position-embedding/advanced-guide.md">advanced-guide.md</a> - é€‚åˆæœ‰æœºå™¨å­¦ä¹ åŸºç¡€çš„è¯»è€…</li>
</ul>
<h2>å­¦ä¹ å»ºè®®</h2>
<ol>
<li>å…ˆé˜…è¯» Word Embeddingï¼Œç†è§£&quot;å°†è¯å˜æˆå‘é‡&quot;çš„åŸºæœ¬æ¦‚å¿µ</li>
<li>å†å­¦ä¹  Position Embeddingï¼Œç†è§£&quot;å¦‚ä½•è¡¨ç¤ºé¡ºåºä¿¡æ¯&quot;</li>
<li>ä¸¤è€…ï¿½ï¿½åˆï¼Œç†è§£ Transformer çš„è¾“å…¥è¡¨ç¤º</li>
</ol>
<h2>å‰ç½®çŸ¥è¯†</h2>
<ul>
<li>ç§‘æ™®ç‰ˆï¼šæ— éœ€åŸºç¡€</li>
<li>æ·±å…¥ç‰ˆï¼šçº¿æ€§ä»£æ•°ã€æ¦‚ç‡è®ºåŸºç¡€</li>
</ul>
<h1>Embedding æµç¨‹å›¾è§£</h1>
<blockquote>
<p>é€šè¿‡å¯ï¿½ï¿½ï¿½åŒ–å›¾è¡¨ç†è§£ Embedding çš„å·¥ä½œæµç¨‹</p>
</blockquote>
<h2>Token Embedding æµç¨‹</h2>
<p><div class="mermaid">flowchart LR
    A["è¾“å…¥æ–‡æœ¬&lt;br/&gt;'ä½ å¥½ä¸–ç•Œ'"] --&gt; B["åˆ†è¯&lt;br/&gt;[ä½ , å¥½, ä¸–, ç•Œ]"]
    B --&gt; C["Token ID&lt;br/&gt;[101, 234, 567, 890]"]
    C --&gt; D["æŸ¥è¡¨&lt;br/&gt;Embedding Matrix"]
    D --&gt; E["å‘é‡åºåˆ—&lt;br/&gt;[v1, v2, v3, v4]"]

    style A fill:#e1f5fe
    style E fill:#c8e6c9</div></p>
<h2>Embedding çŸ©é˜µæŸ¥è¡¨</h2>
<p><div class="mermaid">flowchart TB
    subgraph æŸ¥è¡¨è¿‡ç¨‹
        A["Token ID: 101"] --&gt; B{"æŸ¥è¡¨&lt;br/&gt;W[101]"}
        B --&gt; C["å‘é‡&lt;br/&gt;[0.1, 0.2, ..., 0.768]"]
    end

    subgraph EmbeddingçŸ©é˜µ
        D["W[0]: [0.0, 0.0, ...]"]
        E["W[1]: [0.1, 0.2, ...]"]
        F["..."]
        G["W[101]: [0.1, 0.2, ..., 0.768]"]
        H["..."]
        I["W[V-1]: [0.9, 0.8, ...]"]
    end

    A -.-&gt; G

    style C fill:#c8e6c9</div></p>
<h2>å®Œæ•´ Embedding æµç¨‹</h2>
<p><div class="mermaid">flowchart TB
    A["è¾“å…¥: 'æˆ‘çˆ±AI'"] --&gt; B["åˆ†è¯"]
    B --&gt; C["Token IDs&lt;br/&gt;[50, 123, 789]"]

    C --&gt; D["Token Embedding&lt;br/&gt;æŸ¥è¡¨å¾—åˆ°å‘é‡"]
    C --&gt; E["Position Embedding&lt;br/&gt;ä½ç½®ç¼–ç "]

    D --&gt; F["ç›¸åŠ "]
    E --&gt; F

    F --&gt; G["æœ€ç»ˆ Embedding&lt;br/&gt;[3, 768]"]

    style G fill:#c8e6c9</div></p>
<h2>Word2Vec è®­ç»ƒæµç¨‹</h2>
<p><div class="mermaid">flowchart LR
    subgraph Skip-gram
        A["ä¸­å¿ƒè¯&lt;br/&gt;'cat'"] --&gt; B["é¢„æµ‹ä¸Šä¸‹æ–‡"]
        B --&gt; C["'the'"]
        B --&gt; D["'sat'"]
        B --&gt; E["'on'"]
    end

    subgraph è®­ç»ƒç›®æ ‡
        F["æœ€å¤§åŒ–&lt;br/&gt;P(context|center)"]
    end

    A -.-&gt; F

    style A fill:#bbdefb</div></p>
<h2>ä½ç½®ç¼–ç æµç¨‹</h2>
<p><div class="mermaid">flowchart TB
    A["ä½ç½® 0"] --&gt; B["PE(0) = sin/cos&lt;br/&gt;[0.0, 1.0, 0.0, ...]"]
    C["ä½ç½® 1"] --&gt; D["PE(1) = sin/cos&lt;br/&gt;[0.84, 0.54, ...]"]
    E["ä½ç½® 2"] --&gt; F["PE(2) = sin/cos&lt;br/&gt;[0.91, -0.41, ...]"]

    B --&gt; G["ä½ç½®å‘é‡åºåˆ—"]
    D --&gt; G
    F --&gt; G

    style G fill:#c8e6c9</div></p>
<h2>RoPE æ—‹è½¬ä½ç½®ç¼–ç </h2>
<p><div class="mermaid">flowchart LR
    A["å‘é‡ x"] --&gt; B["æ—‹è½¬è§’åº¦ Î¸&lt;br/&gt;ç”±ä½ç½®å†³å®š"]
    B --&gt; C["x' = x * e^(iÎ¸)"]

    subgraph ç‰¹ç‚¹
        D["ç›¸å¯¹ä½ç½®æ„ŸçŸ¥"]
        E["å¤–æ¨èƒ½åŠ›å¼º"]
    end

    C --&gt; D
    C --&gt; E

    style C fill:#c8e6c9</div></p>
<h2>å›¾è§£è¯´æ˜</h2>
<h3>å…³é”®æ¦‚å¿µ</h3>
<table>
<thead>
<tr>
<th>æ¦‚å¿µ</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>Token Embedding</td>
<td>å°†è¯ ID æ˜ å°„ä¸ºå‘é‡</td>
</tr>
<tr>
<td>Position Embedding</td>
<td>ç¼–ç ä½ç½®ä¿¡æ¯</td>
</tr>
<tr>
<td>Embedding Matrix</td>
<td>å­¦ä¹ çš„æŸ¥æ‰¾è¡¨</td>
</tr>
<tr>
<td>ç»´åº¦</td>
<td>é€šå¸¸ 768-4096</td>
</tr>
</tbody>
</table>
<h3>æµç¨‹è¦ç‚¹</h3>
<ol>
<li><strong>åˆ†è¯</strong>ï¼šæ–‡æœ¬ â†’ Token IDs</li>
<li><strong>æŸ¥è¡¨</strong>ï¼šID â†’ å‘é‡</li>
<li><strong>ä½ç½®ç¼–ç </strong>ï¼šåŠ å…¥ä½ç½®ä¿¡æ¯</li>
<li><strong>è¾“å‡º</strong>ï¼šé€å…¥ Transformer</li>
</ol>
<h2 class="subtopic-title">2.1 è¯åµŒå…¥ (Word Embedding)</h2><h1>Word Embedding ç§‘æ™®ç‰ˆ</h1>
<blockquote>
<p>é¢å‘é›¶åŸºç¡€è¯»è€…çš„è¯åµŒå…¥å…¥é—¨æŒ‡å—</p>
</blockquote>
<h2>ä¸€å¥è¯æ¦‚æ‹¬</h2>
<p><strong>è¯åµŒå…¥å°±æ˜¯æŠŠæ¯ä¸ªè¯å˜æˆä¸€ä¸²æ•°å­—ï¼Œè®©æ„æ€ç›¸è¿‘çš„è¯ï¼Œæ•°å­—ä¹Ÿç›¸è¿‘ã€‚</strong></p>
<h2>ä»ä¸€ä¸ªé—®é¢˜å¼€å§‹</h2>
<p>æƒ³è±¡ä½ æ˜¯ä¸€ä¸ªå¤–å›½äººï¼Œåˆšå­¦ä¸­æ–‡ã€‚ä½ çœ‹åˆ°ä¸¤ä¸ªå¥å­ï¼š</p>
<ul>
<li>â€œæˆ‘å–œæ¬¢åƒ<strong>è‹¹æœ</strong>â€</li>
<li>â€œæˆ‘å–œæ¬¢åƒ<strong>é¦™è•‰</strong>â€</li>
</ul>
<p>ä½ æ€ä¹ˆçŸ¥é“&quot;è‹¹æœ&quot;å’Œ&quot;é¦™è•‰&quot;æ˜¯ç±»ä¼¼çš„ä¸œè¥¿ï¼Ÿ</p>
<p>ä½œä¸ºäººç±»ï¼Œä½ ç†è§£å®ƒä»¬éƒ½æ˜¯æ°´æœã€‚ä½†è®¡ç®—æœºåªçœ‹åˆ°ä¸¤ä¸ªä¸åŒçš„å­—ç¬¦ä¸²ï¼Œå®ƒä»¬æ²¡æœ‰ä»»ä½•å…³ç³»ã€‚</p>
<p><strong>è¯åµŒå…¥å°±æ˜¯è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼šè®©è®¡ç®—æœºä¹Ÿèƒ½&quot;ç†è§£&quot;è¯è¯­ä¹‹é—´çš„ç›¸ä¼¼æ€§ã€‚</strong></p>
<h2>æ ¸å¿ƒæ€æƒ³ï¼šç”¨æ•°å­—è¡¨ç¤ºè¯</h2>
<h3>æœ€ç®€å•çš„æ–¹æ³•ï¼šç¼–å·</h3>
<p>ç»™æ¯ä¸ªè¯ä¸€ä¸ªç¼–å·ï¼š</p>
<ul>
<li>è‹¹æœ = 1</li>
<li>é¦™è•‰ = 2</li>
<li>æ±½è½¦ = 3</li>
<li>é£æœº = 4</li>
</ul>
<p><strong>é—®é¢˜</strong>ï¼šè‹¹æœ(1)å’Œé¦™è•‰(2)çš„ç¼–å·ç›¸è¿‘ï¼Œä½†é¦™è•‰(2)å’Œæ±½è½¦(3)ä¹Ÿç›¸è¿‘ï¼ç¼–å·çš„ç›¸è¿‘ç¨‹åº¦ä¸ç­‰äºè¯­ä¹‰çš„ç›¸è¿‘ç¨‹åº¦ã€‚</p>
<h3>æ›´å¥½çš„æ–¹æ³•ï¼šç”¨å¤šä¸ªæ•°å­—ï¼ˆå‘é‡ï¼‰</h3>
<p>ä¸å…¶ç”¨ä¸€ä¸ªæ•°å­—ï¼Œä¸å¦‚ç”¨å¤šä¸ªæ•°å­—æ¥æè¿°ä¸€ä¸ªè¯çš„&quot;ç‰¹å¾&quot;ã€‚</p>
<p>æƒ³è±¡æˆ‘ä»¬ç”¨ 3 ä¸ªç‰¹å¾æ¥æè¿°æ¯ä¸ªè¯ï¼š</p>
<table>
<thead>
<tr>
<th>è¯è¯­</th>
<th>æ˜¯æ°´æœå—ï¼Ÿ</th>
<th>æ˜¯äº¤é€šå·¥å…·å—ï¼Ÿ</th>
<th>èƒ½åƒå—ï¼Ÿ</th>
</tr>
</thead>
<tbody>
<tr>
<td>è‹¹æœ</td>
<td>1.0</td>
<td>0.0</td>
<td>1.0</td>
</tr>
<tr>
<td>é¦™è•‰</td>
<td>1.0</td>
<td>0.0</td>
<td>1.0</td>
</tr>
<tr>
<td>æ±½è½¦</td>
<td>0.0</td>
<td>1.0</td>
<td>0.0</td>
</tr>
<tr>
<td>é£æœº</td>
<td>0.0</td>
<td>1.0</td>
<td>0.0</td>
</tr>
</tbody>
</table>
<p>ç°åœ¨ï¼Œè‹¹æœå’Œé¦™è•‰çš„æ•°å­—å‡ ä¹ä¸€æ · <code>[1, 0, 1]</code>ï¼Œè€Œå®ƒä»¬å’Œæ±½è½¦ <code>[0, 1, 0]</code> å®Œå…¨ä¸åŒï¼</p>
<p>è¿™å°±æ˜¯<strong>è¯åµŒå…¥</strong>çš„æ ¸å¿ƒï¼šç”¨ä¸€ç»„æ•°å­—ï¼ˆå‘é‡ï¼‰æ¥è¡¨ç¤ºæ¯ä¸ªè¯ï¼Œè®©è¯­ä¹‰ç›¸ä¼¼çš„è¯æœ‰ç›¸ä¼¼çš„æ•°å­—è¡¨ç¤ºã€‚</p>
<h2>å®é™…çš„è¯åµŒå…¥</h2>
<p>ç°å®ä¸­ï¼Œæˆ‘ä»¬ä¸ç”¨ 3 ä¸ªæ•°å­—ï¼Œè€Œæ˜¯ç”¨ <strong>å‡ ç™¾ä¸ªæ•°å­—</strong>ï¼ˆæ¯”å¦‚ 300 ç»´ï¼‰ã€‚</p>
<p>è¿™äº›æ•°å­—ä¸æ˜¯äººå·¥å®šä¹‰çš„&quot;æ˜¯æ°´æœå—&quot;è¿™ç§ç‰¹å¾ï¼Œè€Œæ˜¯<strong>è®©æœºå™¨è‡ªå·±ä»å¤§é‡æ–‡æœ¬ä¸­å­¦å‡ºæ¥çš„</strong>ã€‚</p>
<p>æœºå™¨ä¼šè§‚å¯Ÿï¼š</p>
<ul>
<li>â€œè‹¹æœ&quot;ç»å¸¸å’Œ&quot;åƒâ€ã€â€œæ°´æœâ€ã€&quot;ç”œ&quot;ä¸€èµ·å‡ºç°</li>
<li>â€œé¦™è•‰&quot;ä¹Ÿç»å¸¸å’Œ&quot;åƒâ€ã€â€œæ°´æœâ€ã€&quot;ç”œ&quot;ä¸€èµ·å‡ºç°</li>
<li>æ‰€ä»¥å®ƒä»¬çš„å‘é‡åº”è¯¥å¾ˆç›¸ä¼¼</li>
</ul>
<h2>ä¸€ä¸ªç¥å¥‡çš„ç‰¹æ€§ï¼šè¯­ä¹‰è¿ç®—</h2>
<p>è¯åµŒå…¥æœ‰ä¸€ä¸ªæƒŠäººçš„ç‰¹æ€§â€”â€”å¯ä»¥åš&quot;è¯è¯­è¿ç®—&quot;ï¼š</p>
<pre class="hljs"><code>å›½ç‹ - ç”·äºº + å¥³äºº â‰ˆ ç‹å
</code></pre>
<p>å‘é‡ä¹‹é—´çš„åŠ å‡æ³•ç«Ÿç„¶èƒ½åæ˜ è¯­ä¹‰å…³ç³»ï¼è¿™è¯´æ˜è¯åµŒå…¥çœŸçš„&quot;å­¦ä¼š&quot;äº†è¯è¯­çš„å«ä¹‰ã€‚</p>
<h2>ç»å…¸æ–¹æ³•</h2>
<h3>Word2Vec (2013)</h3>
<p>Google æå‡ºçš„æ–¹æ³•ï¼Œè®©è¯åµŒå…¥çœŸæ­£æµè¡Œèµ·æ¥ã€‚æ ¸å¿ƒæ€æƒ³å¾ˆç®€å•ï¼š</p>
<ul>
<li>çœ‹ä¸€ä¸ªè¯<strong>å‘¨å›´</strong>æœ‰å“ªäº›è¯</li>
<li>è¯­å¢ƒç›¸ä¼¼çš„è¯ï¼Œæ„æ€ä¹Ÿç›¸ä¼¼</li>
</ul>
<h3>GloVe (2014)</h3>
<p>Stanford æå‡ºçš„æ–¹æ³•ï¼Œç»“åˆäº†å…¨å±€ç»Ÿè®¡ä¿¡æ¯ã€‚</p>
<h2>æ€»ç»“</h2>
<table>
<thead>
<tr>
<th>æ¦‚å¿µ</th>
<th>é€šä¿—ç†è§£</th>
</tr>
</thead>
<tbody>
<tr>
<td>è¯åµŒå…¥</td>
<td>æŠŠè¯å˜æˆæ•°å­—ä¸²</td>
</tr>
<tr>
<td>å‘é‡</td>
<td>é‚£ä¸²æ•°å­—</td>
</tr>
<tr>
<td>ç›¸ä¼¼åº¦</td>
<td>ä¸¤ä¸²æ•°å­—çš„&quot;è·ç¦»&quot;</td>
</tr>
<tr>
<td>ç»´åº¦</td>
<td>æ•°å­—ä¸²çš„é•¿åº¦</td>
</tr>
</tbody>
</table>
<h2>ä¸‹ä¸€æ­¥</h2>
<ul>
<li>æƒ³äº†è§£æ•°å­¦åŸç†ï¼Ÿé˜…è¯» <a href="advanced-guide.md">æ·±å…¥ç‰ˆ</a></li>
<li>æƒ³çœ‹ä»£ç å®ç°ï¼ŸæŸ¥çœ‹ <code>examples/</code> ç›®å½•</li>
</ul>
<h1>Word Embedding æ·±å…¥ç‰ˆ</h1>
<blockquote>
<p>é¢å‘æœ‰æœºå™¨å­¦ä¹ åŸºç¡€è¯»è€…çš„æŠ€æœ¯è¯¦è§£</p>
</blockquote>
<h2>æ¦‚è¿°</h2>
<p>è¯åµŒå…¥ï¼ˆWord Embeddingï¼‰æ˜¯å°†ç¦»æ•£çš„è¯ç¬¦å·æ˜ å°„åˆ°è¿ç»­ç¨ å¯†å‘é‡ç©ºé—´çš„æŠ€æœ¯ã€‚å½¢å¼åŒ–åœ°ï¼Œå¯¹äºè¯æ±‡è¡¨ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span>ï¼Œè¯åµŒå…¥æ˜¯ä¸€ä¸ªæ˜ å°„å‡½æ•°ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â†’</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8991em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><a id="formula-word-embedding-1"></a>
<a href="#formula-word-embedding-1-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šå°†è¯æ±‡è¡¨ä¸­çš„æ¯ä¸ªè¯æ˜ å°„åˆ°ä¸€ä¸ª <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span> ç»´å®æ•°å‘é‡ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span> ä¸ºè¯æ±‡è¡¨ï¼ˆç¦»æ•£ç¬¦å·é›†åˆï¼‰ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span></span></span></span> ä¸º <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span> ç»´å®æ•°å‘é‡ç©ºé—´ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šç”¨ç¨ å¯†å‘é‡è¡¨ç¤ºè¯è¯­ï¼Œä½¿è¯­ä¹‰ç›¸è¿‘çš„è¯åœ¨å‘é‡ç©ºé—´ä¸­è·ç¦»ä¹Ÿç›¸è¿‘ã€‚</li>
</ul>
<p>å…¶ä¸­ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span> æ˜¯åµŒå…¥ç»´åº¦ï¼ˆé€šå¸¸ 100-300ï¼‰ã€‚</p>
<h2>åˆ†å¸ƒå¼å‡è®¾</h2>
<blockquote>
<p>â€œYou shall know a word by the company it keepsâ€ â€” J.R. Firth (1957)</p>
</blockquote>
<p>è¯åµŒå…¥çš„ç†è®ºåŸºç¡€æ˜¯<strong>åˆ†å¸ƒå¼å‡è®¾</strong>ï¼šè¯­ä¹‰ç›¸ä¼¼çš„è¯å‡ºç°åœ¨ç›¸ä¼¼çš„ä¸Šä¸‹æ–‡ä¸­ã€‚</p>
<h2>Word2Vec</h2>
<h3>1. Skip-gram æ¨¡å‹</h3>
<p>ç»™å®šè¯åºåˆ— <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">â€¦</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>ï¼ŒSkip-gram çš„ç›®æ ‡æ˜¯æœ€å¤§åŒ–å¹³å‡å¯¹æ•°æ¦‚ç‡ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3.2666em;vertical-align:-1.4382em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8829em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.2671em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8479em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">âˆ’</span><span class="mord mathnormal mtight">c</span><span class="mrel mtight">â‰¤</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">â‰¤</span><span class="mord mathnormal mtight">c</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight"><span class="mrel mtight"><span class="mord vbox mtight"><span class="thinbox mtight"><span class="rlap mtight"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="inner"><span class="mord mtight"><span class="mrel mtight">î€ </span></span></span><span class="fix"></span></span></span></span></span><span class="mspace nobreak mtight"></span><span class="mrel mtight">=</span></span><span class="mord mtight">0</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.4382em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord">âˆ£</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><a id="formula-word-embedding-2"></a>
<a href="#formula-word-embedding-2-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šç”¨ä¸­å¿ƒè¯é¢„æµ‹ä¸Šä¸‹æ–‡è¯ï¼Œæœ€å¤§åŒ–æ‰€æœ‰ä½ç½®çš„å¯¹æ•°æ¦‚ç‡ä¹‹å’Œã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span> ä¸ºåºåˆ—é•¿åº¦ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">c</span></span></span></span> ä¸ºä¸Šä¸‹æ–‡çª—å£å¤§å°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord">âˆ£</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> ä¸ºç”¨ä¸­å¿ƒè¯é¢„æµ‹ä¸Šä¸‹æ–‡è¯çš„æ¦‚ç‡ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šè®©ä¸­å¿ƒè¯çš„å‘é‡èƒ½&quot;é¢„æµ‹&quot;å‘¨å›´è¯ï¼Œè¯­ä¹‰ç›¸è¿‘çš„è¯ä¼šæœ‰ç›¸ä¼¼çš„å‘é‡ã€‚</li>
</ul>
<p>å…¶ä¸­ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">c</span></span></span></span> æ˜¯ä¸Šä¸‹æ–‡çª—å£å¤§å°ã€‚</p>
<p>ä½¿ç”¨ softmax å®šä¹‰æ¡ä»¶æ¦‚ç‡ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">o</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">âˆ£</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.7494em;vertical-align:-1.1709em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5784em;"><span style="top:-2.1288em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">âˆ‘</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">W</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">exp</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7673em;"><span style="top:-2.453em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2501em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.7371em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop">exp</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.453em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">o</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3471em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2501em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.1709em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><a id="formula-word-embedding-3"></a>
<a href="#formula-word-embedding-3-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šç”¨ä¸¤ä¸ªè¯å‘é‡çš„ç‚¹ç§¯è®¡ç®—ç›¸ä¼¼åº¦ï¼Œå†ç» softmax å½’ä¸€åŒ–ä¸ºæ¦‚ç‡ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6807em;vertical-align:-0.2501em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">o</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2501em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºä¸Šä¸‹æ–‡è¯å‘é‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6807em;vertical-align:-0.2501em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2501em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºä¸­å¿ƒè¯å‘é‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span></span></span> ä¸ºè¯è¡¨å¤§å°ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šç‚¹ç§¯è¡¡é‡ç›¸ä¼¼åº¦ï¼Œç›¸ä¼¼åº¦é«˜çš„è¯å¯¹é¢„æµ‹æ¦‚ç‡æ›´å¤§ã€‚</li>
</ul>
<p>å…¶ä¸­ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> æ˜¯è¯ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span></span></span></span> çš„åµŒå…¥å‘é‡ã€‚</p>
<h3>2. è´Ÿé‡‡æ · (Negative Sampling)</h3>
<p>åŸå§‹ softmax è®¡ç®—é‡å¤ªå¤§ï¼ˆéœ€è¦éå†æ•´ä¸ªè¯è¡¨ï¼‰ã€‚è´Ÿé‡‡æ ·å°†å…¶è½¬åŒ–ä¸ºäºŒåˆ†ç±»é—®é¢˜ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">o</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">âˆ£</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2384em;vertical-align:-0.3471em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.453em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">o</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3471em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2501em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:3.1304em;vertical-align:-1.3021em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8479em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.3021em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathbb">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span><span class="mrel mtight">âˆ¼</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.1389em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span></span></span></span><span class="mopen">[</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="mopen">(</span><span class="mord">âˆ’</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.453em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3529em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2501em;"><span></span></span></span></span></span></span><span class="mclose">)]</span></span></span></span></span></p>
<p><a id="formula-word-embedding-4"></a>
<a href="#formula-word-embedding-4-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šæ­£æ ·æœ¬ï¼ˆçœŸå®ä¸Šä¸‹æ–‡ï¼‰æ¦‚ç‡æœ€å¤§åŒ– + è´Ÿæ ·æœ¬ï¼ˆå™ªå£°è¯ï¼‰æ¦‚ç‡æœ€å°åŒ–ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span></span></span></span> ä¸º sigmoid å‡½æ•°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span> ä¸ºè´Ÿæ ·æœ¬æ•°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mclose">)</span></span></span></span> ä¸ºå™ªå£°åˆ†å¸ƒï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6864em;vertical-align:-0.2559em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2559em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºè´Ÿæ ·æœ¬è¯å‘é‡ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šåªéœ€è®¡ç®— <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> ä¸ªè¯è€Œéæ•´ä¸ªè¯è¡¨ï¼Œå¤§å¹…åŠ é€Ÿè®­ç»ƒã€‚</li>
</ul>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2484em;vertical-align:-0.4033em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mbin mtight">+</span><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7027em;"><span style="top:-2.786em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">âˆ’</span><span class="mord mathnormal mtight">x</span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.4033em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span> æ˜¯ sigmoid å‡½æ•°</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span> æ˜¯è´Ÿæ ·æœ¬æ•°é‡ï¼ˆé€šå¸¸ 5-20ï¼‰</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mclose">)</span></span></span></span> æ˜¯å™ªå£°åˆ†å¸ƒï¼Œé€šå¸¸å– <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0.75</span></span></span></span></span></span></span></span></span></span></span></span></li>
</ul>
<h3>3. CBOW æ¨¡å‹</h3>
<p>CBOW (Continuous Bag of Words) ä¸ Skip-gram ç›¸åï¼šç”¨ä¸Šä¸‹æ–‡é¢„æµ‹ä¸­å¿ƒè¯ã€‚</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">âˆ£</span><span class="mord text"><span class="mord">context</span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.7494em;vertical-align:-1.1709em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5784em;"><span style="top:-2.1288em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">âˆ‘</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">W</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">exp</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7673em;"><span style="top:-2.453em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">Ë‰</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">context</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.7371em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop">exp</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.453em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2963em;"><span style="top:-2.357em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3471em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">Ë‰</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">context</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.1709em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><a id="formula-word-embedding-5"></a>
<a href="#formula-word-embedding-5-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šç”¨ä¸Šä¸‹æ–‡è¯å‘é‡çš„å¹³å‡æ¥é¢„æµ‹ä¸­å¿ƒè¯çš„æ¦‚ç‡åˆ†å¸ƒã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7178em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">Ë‰</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">context</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºä¸Šä¸‹æ–‡è¯å‘é‡çš„å¹³å‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6807em;vertical-align:-0.2501em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2963em;"><span style="top:-2.357em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2501em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºä¸­å¿ƒè¯å‘é‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span></span></span> ä¸ºè¯è¡¨å¤§å°ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šä¸Šä¸‹æ–‡ä¿¡æ¯èšåˆæˆä¸€ä¸ªè¡¨ç¤ºï¼Œå†é¢„æµ‹æœ€å¯èƒ½çš„ä¸­å¿ƒè¯ã€‚</li>
</ul>
<p>å…¶ä¸­ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7178em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">Ë‰</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">context</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2809em;vertical-align:-0.4358em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight">c</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">âˆ‘</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1864em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">âˆ’</span><span class="mord mathnormal mtight">c</span><span class="mrel mtight">â‰¤</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">â‰¤</span><span class="mord mathnormal mtight">c</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight"><span class="mrel mtight"><span class="mord vbox mtight"><span class="thinbox mtight"><span class="rlap mtight"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="inner"><span class="mord mtight"><span class="mrel mtight">î€ </span></span></span><span class="fix"></span></span></span></span></span><span class="mspace nobreak mtight"></span><span class="mrel mtight">=</span></span><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.4358em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3473em;"><span></span></span></span></span></span></span></span></span></span></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šå¯¹çª—å£å†…æ‰€æœ‰ä¸Šä¸‹æ–‡è¯å‘é‡å–å¹³å‡ï¼Œå¾—åˆ°ä¸Šä¸‹æ–‡è¡¨ç¤ºã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">c</span></span></span></span> ä¸ºçª—å£åŠå¾„ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7779em;vertical-align:-0.3473em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3473em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºä¸Šä¸‹æ–‡è¯å‘é‡ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šç®€å•å¹³å‡èšåˆä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä¸åŒºåˆ†è¯çš„ä½ç½®å’Œé‡è¦ç¨‹åº¦ã€‚</li>
</ul>
<h2>GloVe</h2>
<p>GloVe (Global Vectors) ç»“åˆäº†å…¨å±€çŸ©é˜µåˆ†è§£å’Œå±€éƒ¨ä¸Šä¸‹æ–‡çª—å£æ–¹æ³•ã€‚</p>
<h3>å…±ç°çŸ©é˜µ</h3>
<p>å®šä¹‰å…±ç°çŸ©é˜µ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span>ï¼Œå…¶ä¸­ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> è¡¨ç¤ºè¯ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> å’Œè¯ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span> åœ¨ä¸Šä¸‹æ–‡ä¸­å…±ç°çš„æ¬¡æ•°ã€‚</p>
<h3>ç›®æ ‡å‡½æ•°</h3>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.2421em;vertical-align:-1.4138em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.4138em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.453em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6679em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span></span><span style="top:-3.35em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1667em;"><span class="mord">~</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.2174em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9313em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">b</span></span><span style="top:-3.6134em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">~</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.1502em;vertical-align:-0.2861em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><a id="formula-word-embedding-6"></a>
<a href="#formula-word-embedding-6-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šè®©è¯å‘é‡çš„ç‚¹ç§¯ + åç½®é€¼è¿‘å…±ç°æ¬¡æ•°çš„å¯¹æ•°ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºè¯ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> å’Œ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span> çš„å…±ç°æ¬¡æ•°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.954em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6679em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span></span><span style="top:-3.35em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1667em;"><span class="mord">~</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºä¸­å¿ƒè¯å’Œä¸Šä¸‹æ–‡è¯å‘é‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> ä¸ºæƒé‡å‡½æ•°ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šåˆ©ç”¨å…¨å±€å…±ç°ç»Ÿè®¡ï¼Œå­¦ä¹ èƒ½æ•æ‰è¯é—´å…³ç³»çš„å‘é‡è¡¨ç¤ºã€‚</li>
</ul>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> æ˜¯ä¸­å¿ƒè¯å‘é‡</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.954em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6679em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span></span><span style="top:-3.35em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1667em;"><span class="mord">~</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> æ˜¯ä¸Šä¸‹æ–‡è¯å‘é‡</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2174em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9313em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">b</span></span><span style="top:-3.6134em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">~</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> æ˜¯åç½®é¡¹</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> æ˜¯æƒé‡å‡½æ•°ï¼Œç”¨äºå‡å°‘é«˜é¢‘è¯çš„å½±å“ï¼š</li>
</ul>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord">/</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mtight">m</span><span class="mtight">a</span><span class="mtight">x</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.0037em;">Î±</span></span></span></span></span></span></span></span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">ifÂ </span></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mtight">m</span><span class="mtight">a</span><span class="mtight">x</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">otherwise</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><a id="formula-word-embedding-7"></a>
<a href="#formula-word-embedding-7-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šå¯¹ä½é¢‘å…±ç°ç»™äºˆè¾ƒå°æƒé‡ï¼Œé«˜é¢‘å…±ç°æƒé‡å°é¡¶ä¸º 1ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mtight">m</span><span class="mtight">a</span><span class="mtight">x</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºæˆªæ–­é˜ˆå€¼ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span></span></span></span> ä¸ºå¹‚æ¬¡å‚æ•°ï¼ˆé€šå¸¸ 0.75ï¼‰ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šé˜²æ­¢é«˜é¢‘è¯ï¼ˆå¦‚&quot;çš„&quot;ï¼‰ä¸»å¯¼è®­ç»ƒç›®æ ‡ã€‚</li>
</ul>
<h2>è¯­ä¹‰å±æ€§</h2>
<h3>1. ä½™å¼¦ç›¸ä¼¼åº¦</h3>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">sim</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0575em;vertical-align:-0.9361em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1215em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">âˆ¥</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2501em;"><span></span></span></span></span></span></span><span class="mord">âˆ¥âˆ¥</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2501em;"><span></span></span></span></span></span></span><span class="mord">âˆ¥</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2501em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2501em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.9361em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><a id="formula-word-embedding-8"></a>
<a href="#formula-word-embedding-8-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šç”¨ä¸¤ä¸ªå‘é‡çš„å¤¹è§’ä½™å¼¦å€¼è¡¡é‡ç›¸ä¼¼åº¦ï¼ŒèŒƒå›´ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">âˆ’</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span>ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6807em;vertical-align:-0.2501em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2501em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2501em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºä¸¤ä¸ªè¯çš„å‘é‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">âˆ¥</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">âˆ¥</span></span></span></span> ä¸ºå‘é‡æ¨¡é•¿ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šå½’ä¸€åŒ–ååªçœ‹æ–¹å‘ä¸çœ‹å¤§å°ï¼Œè¯­ä¹‰ç›¸è¿‘çš„è¯å¤¹è§’å°ã€ä½™å¼¦å€¼å¤§ã€‚</li>
</ul>
<h3>2. ç±»æ¯”å…³ç³»</h3>
<p>è¯åµŒå…¥å¯ä»¥æ•æ‰è¯­ä¹‰ç±»æ¯”å…³ç³»ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0001em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2077em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z"/></svg></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mord mathnormal mtight">in</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.864em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2077em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z"/></svg></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">man</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.864em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2077em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z"/></svg></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">man</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â‰ˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0001em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2077em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z"/></svg></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">ee</span><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p><a id="formula-word-embedding-9"></a>
<a href="#formula-word-embedding-9-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šè¯å‘é‡ç©ºé—´ä¸­çš„çº¿æ€§è¿ç®—å¯è¡¨ç¤ºè¯­ä¹‰ç±»æ¯”å…³ç³»ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.864em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2077em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z"/></svg></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">or</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºè¯çš„å‘é‡è¡¨ç¤ºï¼›å‡æ³•å’ŒåŠ æ³•ä¸ºå‘é‡è¿ç®—ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šâ€œking - man + womanâ€ ä½“ç°äº†&quot;ç”·æ€§â†’å¥³æ€§&quot;çš„è¯­ä¹‰æ–¹å‘ï¼Œåº”ç”¨åˆ° king å¾—åˆ° queenã€‚</li>
</ul>
<p>è¿™è¡¨æ˜è¯å‘é‡ç©ºé—´ä¸­å­˜åœ¨æœ‰æ„ä¹‰çš„çº¿æ€§å­ç»“æ„ã€‚</p>
<h2>å±€é™æ€§</h2>
<h3>1. å¤šä¹‰è¯é—®é¢˜</h3>
<p>ä¸€ä¸ªè¯å¯èƒ½æœ‰å¤šä¸ªå«ä¹‰ï¼Œä½†åªæœ‰ä¸€ä¸ªå‘é‡è¡¨ç¤ºï¼š</p>
<ul>
<li>â€œbankâ€ å¯ä»¥æ˜¯æ²³å²¸ï¼Œä¹Ÿå¯ä»¥æ˜¯é“¶è¡Œ</li>
<li>ä¼ ç»Ÿè¯åµŒå…¥æ— æ³•åŒºåˆ†</li>
</ul>
<h3>2. OOV é—®é¢˜</h3>
<p>æœªç™»å½•è¯ï¼ˆOut-of-Vocabularyï¼‰æ— æ³•è·å¾—å‘é‡è¡¨ç¤ºã€‚</p>
<h3>3. é™æ€è¡¨ç¤º</h3>
<p>è¯å‘é‡æ˜¯å›ºå®šçš„ï¼Œæ— æ³•æ ¹æ®ä¸Šä¸‹æ–‡åŠ¨æ€å˜åŒ–ã€‚</p>
<h2>ä»é™æ€åˆ°åŠ¨æ€</h2>
<p>è¿™äº›å±€é™æ€§å‚¬ç”Ÿäº†ä¸Šä¸‹æ–‡ç›¸å…³çš„è¯è¡¨ç¤ºæ–¹æ³•ï¼ˆå¦‚ ELMoã€BERTï¼‰ï¼Œæˆ‘ä»¬å°†åœ¨åç»­ç« èŠ‚è®¨è®ºã€‚</p>
<h2>å‚è€ƒæ–‡çŒ®</h2>
<ol>
<li>Mikolov et al. (2013). <em>Efficient Estimation of Word Representations in Vector Space</em></li>
<li>Mikolov et al. (2013). <em>Distributed Representations of Words and Phrases and their Compositionality</em></li>
<li>Pennington et al. (2014). <em>GloVe: Global Vectors for Word Representation</em></li>
<li>Goldberg &amp; Levy (2014). <em>word2vec Explained: Deriving Mikolov et al.'s Negative-Sampling Word-Embedding Method</em></li>
</ol>
<div class="code-appendix page-break"><h2>é™„å½•ï¼šä»£ç ç¤ºä¾‹</h2><div class="code-file"><h3>bert_embedding_example.py</h3><pre class="hljs"><code><span class="hljs-string">&quot;&quot;&quot;
BERT Embedding ç¤ºä¾‹ä»£ç  / BERT Embedding Example Code
======================================================

æœ¬ç¤ºä¾‹å±•ç¤ºå¦‚ä½•ä½¿ç”¨ HuggingFace Transformers è·å– BERT çš„è¯/å¥åµŒå…¥ã€‚
This example demonstrates how to get BERT word/sentence embeddings using
HuggingFace Transformers.

BERT (Bidirectional Encoder Representations from Transformers) æ˜¯ Google æå‡ºçš„
é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹ï¼Œå¯ä»¥ç”Ÿæˆä¸Šä¸‹æ–‡ç›¸å…³çš„è¯åµŒå…¥ã€‚
BERT (Bidirectional Encoder Representations from Transformers) is a pre-trained
language model proposed by Google, capable of generating context-aware word embeddings.

ä¸ Word2Vec/GloVe ä¸åŒï¼ŒBERT çš„è¯å‘é‡æ˜¯åŠ¨æ€çš„ï¼ŒåŒä¸€ä¸ªè¯åœ¨ä¸åŒä¸Šä¸‹æ–‡ä¸­æœ‰ä¸åŒçš„å‘é‡è¡¨ç¤ºã€‚
Unlike Word2Vec/GloVe, BERT word vectors are dynamic - the same word has different
vector representations in different contexts.

ä¾èµ–å®‰è£… / Dependencies:
    pip install transformers torch
&quot;&quot;&quot;</span>

<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> BertTokenizer, BertModel

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 1. åŠ è½½ BERT æ¨¡å‹ / Loading BERT Model</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-comment"># ä½¿ç”¨ BERT-base ä¸­æ–‡æ¨¡å‹</span>
<span class="hljs-comment"># Use BERT-base Chinese model</span>
<span class="hljs-comment"># å…¶ä»–å¯ç”¨æ¨¡å‹ / Other available models:</span>
<span class="hljs-comment">#   - &#x27;bert-base-uncased&#x27;: è‹±æ–‡å°å†™æ¨¡å‹ / English lowercase model</span>
<span class="hljs-comment">#   - &#x27;bert-base-cased&#x27;: è‹±æ–‡å¤§å°å†™æ•æ„Ÿ / English case-sensitive model</span>
<span class="hljs-comment">#   - &#x27;bert-large-uncased&#x27;: è‹±æ–‡å¤§æ¨¡å‹ / English large model</span>
<span class="hljs-comment">#   - &#x27;bert-base-multilingual-cased&#x27;: å¤šè¯­è¨€æ¨¡å‹ / Multilingual model</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;æ­£åœ¨åŠ è½½ BERT æ¨¡å‹... / Loading BERT model...&quot;</span>)
MODEL_NAME = <span class="hljs-string">&quot;bert-base-chinese&quot;</span>  <span class="hljs-comment"># ä¸­æ–‡ BERT / Chinese BERT</span>

<span class="hljs-comment"># åŠ è½½åˆ†è¯å™¨ / Load tokenizer</span>
<span class="hljs-comment"># åˆ†è¯å™¨è´Ÿè´£å°†æ–‡æœ¬è½¬æ¢ä¸ºæ¨¡å‹å¯ç†è§£çš„ token åºåˆ—</span>
<span class="hljs-comment"># Tokenizer converts text to token sequences that the model can understand</span>
tokenizer = BertTokenizer.from_pretrained(MODEL_NAME)

<span class="hljs-comment"># åŠ è½½æ¨¡å‹ / Load model</span>
<span class="hljs-comment"># BertModel åªåŒ…å«ç¼–ç å™¨éƒ¨åˆ†ï¼Œä¸åŒ…å«ä¸‹æ¸¸ä»»åŠ¡å¤´</span>
<span class="hljs-comment"># BertModel only contains the encoder, without downstream task heads</span>
model = BertModel.from_pretrained(MODEL_NAME)

<span class="hljs-comment"># è®¾ç½®ä¸ºè¯„ä¼°æ¨¡å¼ï¼ˆä¸è®¡ç®—æ¢¯åº¦ï¼‰</span>
<span class="hljs-comment"># Set to evaluation mode (no gradient computation)</span>
model.<span class="hljs-built_in">eval</span>()

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;æ¨¡å‹åŠ è½½å®Œæˆï¼ / Model loaded!&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;è¯è¡¨å¤§å° / Vocabulary size: <span class="hljs-subst">{tokenizer.vocab_size}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;éšè—å±‚ç»´åº¦ / Hidden size: <span class="hljs-subst">{model.config.hidden_size}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;å±‚æ•° / Number of layers: <span class="hljs-subst">{model.config.num_hidden_layers}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 2. æ–‡æœ¬ç¼–ç  / Text Encoding</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">encode_text</span>(<span class="hljs-params">text, tokenizer, max_length=<span class="hljs-number">128</span></span>):
    <span class="hljs-string">&quot;&quot;&quot;
    å°†æ–‡æœ¬ç¼–ç ä¸º BERT è¾“å…¥æ ¼å¼
    Encode text to BERT input format

    å‚æ•° / Args:
        text: è¾“å…¥æ–‡æœ¬ / Input text
        tokenizer: BERT åˆ†è¯å™¨ / BERT tokenizer
        max_length: æœ€å¤§åºåˆ—é•¿åº¦ / Maximum sequence length

    è¿”å› / Returns:
        input_ids: token ID åºåˆ— / Token ID sequence
        attention_mask: æ³¨æ„åŠ›æ©ç  / Attention mask
    &quot;&quot;&quot;</span>
    <span class="hljs-comment"># tokenizer ä¼šè‡ªåŠ¨æ·»åŠ  [CLS] å’Œ [SEP] token</span>
    <span class="hljs-comment"># tokenizer automatically adds [CLS] and [SEP] tokens</span>
    <span class="hljs-comment"># [CLS]: å¥å­å¼€å¤´ï¼Œç”¨äºåˆ†ç±»ä»»åŠ¡ / Start of sentence, used for classification</span>
    <span class="hljs-comment"># [SEP]: å¥å­åˆ†éš”ç¬¦ / Sentence separator</span>
    encoded = tokenizer(
        text,
        padding=<span class="hljs-string">&#x27;max_length&#x27;</span>,      <span class="hljs-comment"># å¡«å……åˆ°æœ€å¤§é•¿åº¦ / Pad to max length</span>
        truncation=<span class="hljs-literal">True</span>,           <span class="hljs-comment"># è¶…é•¿æˆªæ–­ / Truncate if too long</span>
        max_length=max_length,
        return_tensors=<span class="hljs-string">&#x27;pt&#x27;</span>        <span class="hljs-comment"># è¿”å› PyTorch å¼ é‡ / Return PyTorch tensors</span>
    )

    <span class="hljs-keyword">return</span> encoded[<span class="hljs-string">&#x27;input_ids&#x27;</span>], encoded[<span class="hljs-string">&#x27;attention_mask&#x27;</span>]


<span class="hljs-comment"># ç¼–ç ç¤ºä¾‹æ–‡æœ¬</span>
<span class="hljs-comment"># Encode example text</span>
text = <span class="hljs-string">&quot;è‡ªç„¶è¯­è¨€å¤„ç†æ˜¯äººå·¥æ™ºèƒ½çš„é‡è¦åˆ†æ”¯ã€‚&quot;</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nåŸå§‹æ–‡æœ¬ / Original text: <span class="hljs-subst">{text}</span>&quot;</span>)

input_ids, attention_mask = encode_text(text, tokenizer)

<span class="hljs-comment"># æ˜¾ç¤ºç¼–ç ç»“æœ</span>
<span class="hljs-comment"># Show encoding result</span>
tokens = tokenizer.convert_ids_to_tokens(input_ids[<span class="hljs-number">0</span>])
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Token åºåˆ— / Token sequence: <span class="hljs-subst">{tokens[:<span class="hljs-number">15</span>]}</span>...&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Input IDs å½¢çŠ¶ / Input IDs shape: <span class="hljs-subst">{input_ids.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Attention Mask å½¢çŠ¶ / Attention mask shape: <span class="hljs-subst">{attention_mask.shape}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 3. è·å– BERT åµŒå…¥ / Getting BERT Embeddings</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_bert_embeddings</span>(<span class="hljs-params">model, input_ids, attention_mask</span>):
    <span class="hljs-string">&quot;&quot;&quot;
    è·å– BERT çš„å„ç§åµŒå…¥è¡¨ç¤º
    Get various BERT embedding representations

    å‚æ•° / Args:
        model: BERT æ¨¡å‹ / BERT model
        input_ids: token ID åºåˆ— / Token ID sequence
        attention_mask: æ³¨æ„åŠ›æ©ç  / Attention mask

    è¿”å› / Returns:
        last_hidden_state: æœ€åä¸€å±‚çš„éšè—çŠ¶æ€ (batch, seq_len, hidden_size)
                          Last layer hidden states
        pooler_output: [CLS] token ç»è¿‡æ± åŒ–å±‚çš„è¾“å‡º (batch, hidden_size)
                      Pooled output of [CLS] token
        hidden_states: æ‰€æœ‰å±‚çš„éšè—çŠ¶æ€ï¼ˆå¯é€‰ï¼‰
                      Hidden states from all layers (optional)
    &quot;&quot;&quot;</span>
    <span class="hljs-comment"># ä¸è®¡ç®—æ¢¯åº¦ï¼ˆæ¨ç†æ¨¡å¼ï¼‰</span>
    <span class="hljs-comment"># No gradient computation (inference mode)</span>
    <span class="hljs-keyword">with</span> torch.no_grad():
        outputs = model(
            input_ids=input_ids,
            attention_mask=attention_mask,
            output_hidden_states=<span class="hljs-literal">True</span>  <span class="hljs-comment"># è¾“å‡ºæ‰€æœ‰å±‚ / Output all layers</span>
        )

    <span class="hljs-keyword">return</span> outputs


<span class="hljs-comment"># è·å–åµŒå…¥</span>
<span class="hljs-comment"># Get embeddings</span>
outputs = get_bert_embeddings(model, input_ids, attention_mask)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nBERT è¾“å‡º / BERT Outputs:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  last_hidden_state å½¢çŠ¶ / shape: <span class="hljs-subst">{outputs.last_hidden_state.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  pooler_output å½¢çŠ¶ / shape: <span class="hljs-subst">{outputs.pooler_output.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  hidden_states æ•°é‡ / count: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(outputs.hidden_states)}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 4. è·å–è¯çº§åµŒå…¥ / Getting Word-Level Embeddings</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_word_embedding</span>(<span class="hljs-params">outputs, token_index</span>):
    <span class="hljs-string">&quot;&quot;&quot;
    è·å–ç‰¹å®šä½ç½® token çš„åµŒå…¥å‘é‡
    Get embedding vector for a token at specific position

    å‚æ•° / Args:
        outputs: BERT æ¨¡å‹è¾“å‡º / BERT model outputs
        token_index: token ä½ç½®ç´¢å¼• / Token position index

    è¿”å› / Returns:
        è¯åµŒå…¥å‘é‡ (hidden_size,) / Word embedding vector
    &quot;&quot;&quot;</span>
    <span class="hljs-comment"># last_hidden_state: (batch_size, seq_len, hidden_size)</span>
    <span class="hljs-keyword">return</span> outputs.last_hidden_state[<span class="hljs-number">0</span>, token_index, :].numpy()


<span class="hljs-comment"># è·å– [CLS] token çš„åµŒå…¥ï¼ˆå¸¸ç”¨äºå¥å­çº§è¡¨ç¤ºï¼‰</span>
<span class="hljs-comment"># Get [CLS] token embedding (commonly used for sentence-level representation)</span>
cls_embedding = get_word_embedding(outputs, <span class="hljs-number">0</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n[CLS] token åµŒå…¥å‰10ç»´ / First 10 dimensions: <span class="hljs-subst">{cls_embedding[:<span class="hljs-number">10</span>]}</span>&quot;</span>)

<span class="hljs-comment"># è·å–å®é™…è¯çš„åµŒå…¥</span>
<span class="hljs-comment"># Get embeddings for actual words</span>
<span class="hljs-comment"># æ³¨æ„ï¼šä¸­æ–‡ BERT ä½¿ç”¨å­—ç¬¦çº§åˆ†è¯ï¼Œæ¯ä¸ªæ±‰å­—æ˜¯ä¸€ä¸ª token</span>
<span class="hljs-comment"># Note: Chinese BERT uses character-level tokenization, each character is a token</span>
<span class="hljs-keyword">for</span> i, token <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(tokens[:<span class="hljs-number">10</span>]):
    <span class="hljs-keyword">if</span> token <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> [<span class="hljs-string">&#x27;[CLS]&#x27;</span>, <span class="hljs-string">&#x27;[SEP]&#x27;</span>, <span class="hljs-string">&#x27;[PAD]&#x27;</span>]:
        embedding = get_word_embedding(outputs, i)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Token &#x27;<span class="hljs-subst">{token}</span>&#x27; åµŒå…¥èŒƒæ•° / embedding norm: <span class="hljs-subst">{np.linalg.norm(embedding):<span class="hljs-number">.4</span>f}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 5. è·å–å¥å­åµŒå…¥ / Getting Sentence Embeddings</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_sentence_embedding</span>(<span class="hljs-params">outputs, method=<span class="hljs-string">&#x27;cls&#x27;</span></span>):
    <span class="hljs-string">&quot;&quot;&quot;
    ä» BERT è¾“å‡ºè·å–å¥å­åµŒå…¥
    Get sentence embedding from BERT outputs

    å‚æ•° / Args:
        outputs: BERT æ¨¡å‹è¾“å‡º / BERT model outputs
        method: æ± åŒ–æ–¹æ³• / Pooling method
            - &#x27;cls&#x27;: ä½¿ç”¨ [CLS] token çš„è¡¨ç¤º / Use [CLS] token representation
            - &#x27;mean&#x27;: å¯¹æ‰€æœ‰ token å–å¹³å‡ / Average all tokens
            - &#x27;max&#x27;: å¯¹æ‰€æœ‰ token å–æœ€å¤§å€¼ / Max pooling all tokens
            - &#x27;pooler&#x27;: ä½¿ç”¨ pooler_output / Use pooler_output

    è¿”å› / Returns:
        å¥å­åµŒå…¥å‘é‡ / Sentence embedding vector
    &quot;&quot;&quot;</span>
    <span class="hljs-keyword">if</span> method == <span class="hljs-string">&#x27;cls&#x27;</span>:
        <span class="hljs-comment"># [CLS] token çš„åµŒå…¥</span>
        <span class="hljs-comment"># Embedding of [CLS] token</span>
        <span class="hljs-keyword">return</span> outputs.last_hidden_state[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, :].numpy()

    <span class="hljs-keyword">elif</span> method == <span class="hljs-string">&#x27;mean&#x27;</span>:
        <span class="hljs-comment"># å¯¹æ‰€æœ‰ token çš„åµŒå…¥å–å¹³å‡</span>
        <span class="hljs-comment"># Average embeddings of all tokens</span>
        <span class="hljs-comment"># æ³¨æ„ï¼šåº”è¯¥æ’é™¤ padding token</span>
        <span class="hljs-comment"># Note: Should exclude padding tokens</span>
        <span class="hljs-keyword">return</span> outputs.last_hidden_state[<span class="hljs-number">0</span>, :, :].mean(dim=<span class="hljs-number">0</span>).numpy()

    <span class="hljs-keyword">elif</span> method == <span class="hljs-string">&#x27;max&#x27;</span>:
        <span class="hljs-comment"># å¯¹æ‰€æœ‰ token çš„åµŒå…¥å–æœ€å¤§å€¼</span>
        <span class="hljs-comment"># Max pooling of all token embeddings</span>
        <span class="hljs-keyword">return</span> outputs.last_hidden_state[<span class="hljs-number">0</span>, :, :].<span class="hljs-built_in">max</span>(dim=<span class="hljs-number">0</span>)[<span class="hljs-number">0</span>].numpy()

    <span class="hljs-keyword">elif</span> method == <span class="hljs-string">&#x27;pooler&#x27;</span>:
        <span class="hljs-comment"># ä½¿ç”¨ BERT çš„ pooler è¾“å‡º</span>
        <span class="hljs-comment"># Use BERT&#x27;s pooler output</span>
        <span class="hljs-comment"># pooler_output æ˜¯ [CLS] ç»è¿‡ tanh æ¿€æ´»åçš„ç»“æœ</span>
        <span class="hljs-comment"># pooler_output is [CLS] after tanh activation</span>
        <span class="hljs-keyword">return</span> outputs.pooler_output[<span class="hljs-number">0</span>].numpy()

    <span class="hljs-keyword">return</span> outputs.last_hidden_state[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, :].numpy()


<span class="hljs-comment"># æ¯”è¾ƒä¸åŒæ± åŒ–æ–¹æ³•</span>
<span class="hljs-comment"># Compare different pooling methods</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\nå¥å­åµŒå…¥æ¯”è¾ƒ / Sentence Embedding Comparison:&quot;</span>)
<span class="hljs-keyword">for</span> method <span class="hljs-keyword">in</span> [<span class="hljs-string">&#x27;cls&#x27;</span>, <span class="hljs-string">&#x27;mean&#x27;</span>, <span class="hljs-string">&#x27;max&#x27;</span>, <span class="hljs-string">&#x27;pooler&#x27;</span>]:
    embedding = get_sentence_embedding(outputs, method)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  <span class="hljs-subst">{method:<span class="hljs-number">8</span>}</span>: èŒƒæ•°/norm=<span class="hljs-subst">{np.linalg.norm(embedding):<span class="hljs-number">.4</span>f}</span>, å‰5ç»´/first 5: <span class="hljs-subst">{embedding[:<span class="hljs-number">5</span>]}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 6. ä¸Šä¸‹æ–‡ç›¸å…³çš„è¯åµŒå…¥ / Context-Aware Word Embeddings</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">compare_contextual_embeddings</span>(<span class="hljs-params">model, tokenizer, word, contexts</span>):
    <span class="hljs-string">&quot;&quot;&quot;
    æ¯”è¾ƒåŒä¸€ä¸ªè¯åœ¨ä¸åŒä¸Šä¸‹æ–‡ä¸­çš„åµŒå…¥
    Compare embeddings of the same word in different contexts

    è¿™æ˜¯ BERT ä¸é™æ€è¯åµŒå…¥ï¼ˆWord2Vec/GloVeï¼‰çš„å…³é”®åŒºåˆ«
    This is the key difference between BERT and static embeddings (Word2Vec/GloVe)

    å‚æ•° / Args:
        model: BERT æ¨¡å‹ / BERT model
        tokenizer: åˆ†è¯å™¨ / Tokenizer
        word: ç›®æ ‡è¯ / Target word
        contexts: ä¸Šä¸‹æ–‡å¥å­åˆ—è¡¨ / List of context sentences
    &quot;&quot;&quot;</span>
    embeddings = []

    <span class="hljs-keyword">for</span> context <span class="hljs-keyword">in</span> contexts:
        <span class="hljs-comment"># æ‰¾åˆ°ç›®æ ‡è¯åœ¨å¥å­ä¸­çš„ä½ç½®</span>
        <span class="hljs-comment"># Find position of target word in sentence</span>
        encoded = tokenizer(context, return_tensors=<span class="hljs-string">&#x27;pt&#x27;</span>)

        <span class="hljs-keyword">with</span> torch.no_grad():
            outputs = model(**encoded)

        <span class="hljs-comment"># è·å– token åˆ—è¡¨</span>
        <span class="hljs-comment"># Get token list</span>
        tokens = tokenizer.convert_ids_to_tokens(encoded[<span class="hljs-string">&#x27;input_ids&#x27;</span>][<span class="hljs-number">0</span>])

        <span class="hljs-comment"># æ‰¾åˆ°ç›®æ ‡è¯çš„ç´¢å¼•ï¼ˆç®€åŒ–ç‰ˆï¼Œå®é™…éœ€è¦æ›´ç²¾ç¡®çš„åŒ¹é…ï¼‰</span>
        <span class="hljs-comment"># Find index of target word (simplified, needs more precise matching)</span>
        target_idx = <span class="hljs-literal">None</span>
        <span class="hljs-keyword">for</span> i, token <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(tokens):
            <span class="hljs-keyword">if</span> word <span class="hljs-keyword">in</span> token:
                target_idx = i
                <span class="hljs-keyword">break</span>

        <span class="hljs-keyword">if</span> target_idx:
            emb = outputs.last_hidden_state[<span class="hljs-number">0</span>, target_idx, :].numpy()
            embeddings.append((context, emb))

    <span class="hljs-keyword">return</span> embeddings


<span class="hljs-comment"># æ¯”è¾ƒ&quot;è‹¹æœ&quot;åœ¨ä¸åŒä¸Šä¸‹æ–‡ä¸­çš„åµŒå…¥</span>
<span class="hljs-comment"># Compare embeddings of &quot;è‹¹æœ&quot; (apple/Apple) in different contexts</span>
word = <span class="hljs-string">&quot;æœ&quot;</span>
contexts = [
    <span class="hljs-string">&quot;æˆ‘å–œæ¬¢åƒè‹¹æœï¼Œéå¸¸ç”œã€‚&quot;</span>,        <span class="hljs-comment"># æ°´æœ / Fruit</span>
    <span class="hljs-string">&quot;è‹¹æœå…¬å¸å‘å¸ƒäº†æ–°æ‰‹æœºã€‚&quot;</span>,        <span class="hljs-comment"># å…¬å¸ / Company</span>
    <span class="hljs-string">&quot;è¿™ä¸ªè‹¹æœå¾ˆçº¢å¾ˆå¥½çœ‹ã€‚&quot;</span>,          <span class="hljs-comment"># æ°´æœ / Fruit</span>
]

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\nä¸Šä¸‹æ–‡ç›¸å…³åµŒå…¥æ¯”è¾ƒ / Context-Aware Embedding Comparison:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;ç›®æ ‡è¯ / Target word: &#x27;<span class="hljs-subst">{word}</span>&#x27;&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">60</span>)

context_embeddings = compare_contextual_embeddings(model, tokenizer, word, contexts)
<span class="hljs-keyword">for</span> context, emb <span class="hljs-keyword">in</span> context_embeddings:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;ä¸Šä¸‹æ–‡ / Context: <span class="hljs-subst">{context}</span>&quot;</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  åµŒå…¥èŒƒæ•° / Embedding norm: <span class="hljs-subst">{np.linalg.norm(emb):<span class="hljs-number">.4</span>f}</span>&quot;</span>)
    <span class="hljs-built_in">print</span>()

<span class="hljs-comment"># è®¡ç®—ä¸åŒä¸Šä¸‹æ–‡ä¸­åŒä¸€è¯çš„ç›¸ä¼¼åº¦</span>
<span class="hljs-comment"># Compute similarity of same word in different contexts</span>
<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(context_embeddings) &gt;= <span class="hljs-number">2</span>:
    emb1, emb2 = context_embeddings[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>], context_embeddings[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>]
    similarity = np.dot(emb1, emb2) / (np.linalg.norm(emb1) * np.linalg.norm(emb2))
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;ä¸Šä¸‹æ–‡1å’Œä¸Šä¸‹æ–‡2ä¸­ &#x27;<span class="hljs-subst">{word}</span>&#x27; çš„ç›¸ä¼¼åº¦: <span class="hljs-subst">{similarity:<span class="hljs-number">.4</span>f}</span>&quot;</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Similarity of &#x27;<span class="hljs-subst">{word}</span>&#x27; in context 1 and context 2: <span class="hljs-subst">{similarity:<span class="hljs-number">.4</span>f}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 7. å¥å­ç›¸ä¼¼åº¦è®¡ç®— / Sentence Similarity Computation</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">compute_sentence_similarity</span>(<span class="hljs-params">model, tokenizer, sent1, sent2, method=<span class="hljs-string">&#x27;cls&#x27;</span></span>):
    <span class="hljs-string">&quot;&quot;&quot;
    è®¡ç®—ä¸¤ä¸ªå¥å­çš„è¯­ä¹‰ç›¸ä¼¼åº¦
    Compute semantic similarity between two sentences

    å‚æ•° / Args:
        model: BERT æ¨¡å‹ / BERT model
        tokenizer: åˆ†è¯å™¨ / Tokenizer
        sent1, sent2: å¥å­ / Sentences
        method: æ± åŒ–æ–¹æ³• / Pooling method

    è¿”å› / Returns:
        ä½™å¼¦ç›¸ä¼¼åº¦ / Cosine similarity
    &quot;&quot;&quot;</span>
    <span class="hljs-comment"># ç¼–ç å¥å­ / Encode sentences</span>
    ids1, mask1 = encode_text(sent1, tokenizer)
    ids2, mask2 = encode_text(sent2, tokenizer)

    <span class="hljs-comment"># è·å–åµŒå…¥ / Get embeddings</span>
    <span class="hljs-keyword">with</span> torch.no_grad():
        outputs1 = model(ids1, attention_mask=mask1, output_hidden_states=<span class="hljs-literal">True</span>)
        outputs2 = model(ids2, attention_mask=mask2, output_hidden_states=<span class="hljs-literal">True</span>)

    <span class="hljs-comment"># è·å–å¥å­åµŒå…¥ / Get sentence embeddings</span>
    emb1 = get_sentence_embedding(outputs1, method)
    emb2 = get_sentence_embedding(outputs2, method)

    <span class="hljs-comment"># è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦ / Compute cosine similarity</span>
    similarity = np.dot(emb1, emb2) / (np.linalg.norm(emb1) * np.linalg.norm(emb2))

    <span class="hljs-keyword">return</span> similarity


<span class="hljs-comment"># å¥å­ç›¸ä¼¼åº¦ç¤ºä¾‹</span>
<span class="hljs-comment"># Sentence similarity examples</span>
sentence_pairs = [
    (<span class="hljs-string">&quot;æˆ‘å–œæ¬¢åƒè‹¹æœã€‚&quot;</span>, <span class="hljs-string">&quot;æˆ‘çˆ±åƒæ°´æœã€‚&quot;</span>),           <span class="hljs-comment"># è¯­ä¹‰ç›¸è¿‘ / Semantically similar</span>
    (<span class="hljs-string">&quot;æˆ‘å–œæ¬¢åƒè‹¹æœã€‚&quot;</span>, <span class="hljs-string">&quot;ä»Šå¤©å¤©æ°”å¾ˆå¥½ã€‚&quot;</span>),         <span class="hljs-comment"># è¯­ä¹‰ä¸ç›¸å…³ / Semantically unrelated</span>
    (<span class="hljs-string">&quot;æœºå™¨å­¦ä¹ å¾ˆæœ‰è¶£ã€‚&quot;</span>, <span class="hljs-string">&quot;æ·±åº¦å­¦ä¹ æ˜¯AIçš„åˆ†æ”¯ã€‚&quot;</span>), <span class="hljs-comment"># ç›¸å…³è¯é¢˜ / Related topics</span>
    (<span class="hljs-string">&quot;ä»–åœ¨åŒ—äº¬å·¥ä½œã€‚&quot;</span>, <span class="hljs-string">&quot;ä»–åœ¨ä¸Šæµ·å·¥ä½œã€‚&quot;</span>),         <span class="hljs-comment"># å¥å¼ç›¸åŒ / Same structure</span>
]

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\nå¥å­ç›¸ä¼¼åº¦ / Sentence Similarity:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-keyword">for</span> sent1, sent2 <span class="hljs-keyword">in</span> sentence_pairs:
    sim = compute_sentence_similarity(model, tokenizer, sent1, sent2)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;å¥å­1 / Sentence 1: <span class="hljs-subst">{sent1}</span>&quot;</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;å¥å­2 / Sentence 2: <span class="hljs-subst">{sent2}</span>&quot;</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;ç›¸ä¼¼åº¦ / Similarity: <span class="hljs-subst">{sim:<span class="hljs-number">.4</span>f}</span>&quot;</span>)
    <span class="hljs-built_in">print</span>()

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 8. æ‰¹é‡å¤„ç† / Batch Processing</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">batch_encode</span>(<span class="hljs-params">texts, tokenizer, max_length=<span class="hljs-number">128</span></span>):
    <span class="hljs-string">&quot;&quot;&quot;
    æ‰¹é‡ç¼–ç æ–‡æœ¬
    Batch encode texts

    å‚æ•° / Args:
        texts: æ–‡æœ¬åˆ—è¡¨ / List of texts
        tokenizer: åˆ†è¯å™¨ / Tokenizer
        max_length: æœ€å¤§é•¿åº¦ / Maximum length

    è¿”å› / Returns:
        input_ids, attention_mask å¼ é‡ / Tensors
    &quot;&quot;&quot;</span>
    encoded = tokenizer(
        texts,
        padding=<span class="hljs-literal">True</span>,               <span class="hljs-comment"># å¡«å……åˆ°æ‰¹æ¬¡ä¸­æœ€é•¿ / Pad to longest in batch</span>
        truncation=<span class="hljs-literal">True</span>,
        max_length=max_length,
        return_tensors=<span class="hljs-string">&#x27;pt&#x27;</span>
    )
    <span class="hljs-keyword">return</span> encoded[<span class="hljs-string">&#x27;input_ids&#x27;</span>], encoded[<span class="hljs-string">&#x27;attention_mask&#x27;</span>]


<span class="hljs-keyword">def</span> <span class="hljs-title function_">batch_get_embeddings</span>(<span class="hljs-params">model, input_ids, attention_mask</span>):
    <span class="hljs-string">&quot;&quot;&quot;
    æ‰¹é‡è·å–åµŒå…¥
    Batch get embeddings

    å‚æ•° / Args:
        model: BERT æ¨¡å‹ / BERT model
        input_ids: token ID å¼ é‡ / Token ID tensor
        attention_mask: æ³¨æ„åŠ›æ©ç  / Attention mask

    è¿”å› / Returns:
        å¥å­åµŒå…¥çŸ©é˜µ (batch_size, hidden_size) / Sentence embedding matrix
    &quot;&quot;&quot;</span>
    <span class="hljs-keyword">with</span> torch.no_grad():
        outputs = model(input_ids=input_ids, attention_mask=attention_mask)

    <span class="hljs-comment"># ä½¿ç”¨ [CLS] token ä½œä¸ºå¥å­è¡¨ç¤º</span>
    <span class="hljs-comment"># Use [CLS] token as sentence representation</span>
    <span class="hljs-keyword">return</span> outputs.last_hidden_state[:, <span class="hljs-number">0</span>, :].numpy()


<span class="hljs-comment"># æ‰¹é‡å¤„ç†ç¤ºä¾‹</span>
<span class="hljs-comment"># Batch processing example</span>
texts = [
    <span class="hljs-string">&quot;è‡ªç„¶è¯­è¨€å¤„ç†å¾ˆæœ‰è¶£ã€‚&quot;</span>,
    <span class="hljs-string">&quot;æ·±åº¦å­¦ä¹ æ”¹å˜äº†äººå·¥æ™ºèƒ½é¢†åŸŸã€‚&quot;</span>,
    <span class="hljs-string">&quot;ä»Šå¤©å¤©æ°”æ™´æœ—ã€‚&quot;</span>
]

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\næ‰¹é‡å¤„ç† / Batch Processing:&quot;</span>)
batch_ids, batch_mask = batch_encode(texts, tokenizer)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;æ‰¹æ¬¡å¤§å° / Batch size: <span class="hljs-subst">{batch_ids.shape[<span class="hljs-number">0</span>]}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;åºåˆ—é•¿åº¦ / Sequence length: <span class="hljs-subst">{batch_ids.shape[<span class="hljs-number">1</span>]}</span>&quot;</span>)

batch_embeddings = batch_get_embeddings(model, batch_ids, batch_mask)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;åµŒå…¥çŸ©é˜µå½¢çŠ¶ / Embedding matrix shape: <span class="hljs-subst">{batch_embeddings.shape}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 9. ä½¿ç”¨ä¸åŒå±‚çš„åµŒå…¥ / Using Embeddings from Different Layers</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_layer_embedding</span>(<span class="hljs-params">outputs, layer_idx, token_idx=<span class="hljs-number">0</span></span>):
    <span class="hljs-string">&quot;&quot;&quot;
    è·å–ç‰¹å®šå±‚çš„ token åµŒå…¥
    Get token embedding from a specific layer

    BERT çš„ä¸åŒå±‚æ•æ‰ä¸åŒå±‚æ¬¡çš„ä¿¡æ¯ï¼š
    - æµ…å±‚ï¼šè¯­æ³•ä¿¡æ¯ï¼ˆè¯æ€§ã€å¥æ³•ç»“æ„ï¼‰
    - æ·±å±‚ï¼šè¯­ä¹‰ä¿¡æ¯ï¼ˆå«ä¹‰ã€æ¨ç†ï¼‰

    Different BERT layers capture different levels of information:
    - Lower layers: syntactic info (POS, syntax structure)
    - Higher layers: semantic info (meaning, reasoning)

    å‚æ•° / Args:
        outputs: BERT è¾“å‡º / BERT outputs
        layer_idx: å±‚ç´¢å¼• (0=embeddingå±‚, 1-12=transformerå±‚)
                  Layer index (0=embedding layer, 1-12=transformer layers)
        token_idx: token ç´¢å¼• / Token index

    è¿”å› / Returns:
        åµŒå…¥å‘é‡ / Embedding vector
    &quot;&quot;&quot;</span>
    <span class="hljs-comment"># hidden_states æ˜¯ä¸€ä¸ªå…ƒç»„ï¼ŒåŒ…å« embedding å±‚ + 12 ä¸ª transformer å±‚</span>
    <span class="hljs-comment"># hidden_states is a tuple containing embedding layer + 12 transformer layers</span>
    <span class="hljs-keyword">return</span> outputs.hidden_states[layer_idx][<span class="hljs-number">0</span>, token_idx, :].numpy()


<span class="hljs-comment"># æ¯”è¾ƒä¸åŒå±‚çš„åµŒå…¥</span>
<span class="hljs-comment"># Compare embeddings from different layers</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\nä¸åŒå±‚çš„åµŒå…¥æ¯”è¾ƒ / Embeddings from Different Layers:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">60</span>)

layer_indices = [<span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">8</span>, <span class="hljs-number">12</span>]  <span class="hljs-comment"># embeddingå±‚, ä¸­é—´å±‚, é«˜å±‚ / embedding, middle, high layers</span>
<span class="hljs-keyword">for</span> layer_idx <span class="hljs-keyword">in</span> layer_indices:
    emb = get_layer_embedding(outputs, layer_idx, token_idx=<span class="hljs-number">1</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;å±‚ <span class="hljs-subst">{layer_idx:2d}</span>: èŒƒæ•°/norm=<span class="hljs-subst">{np.linalg.norm(emb):<span class="hljs-number">.4</span>f}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 10. å…¶ä»–é¢„è®­ç»ƒæ¨¡å‹ / Other Pre-trained Models</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-comment"># é™¤äº† BERTï¼Œè¿˜æœ‰è®¸å¤šå…¶ä»–é¢„è®­ç»ƒæ¨¡å‹å¯ç”¨äºè·å–åµŒå…¥</span>
<span class="hljs-comment"># Besides BERT, many other pre-trained models can be used for embeddings</span>

OTHER_MODELS = <span class="hljs-string">&quot;&quot;&quot;
å…¶ä»–å¸¸ç”¨æ¨¡å‹ / Other Common Models:

1. RoBERTa (robustly optimized BERT approach)
   - BERT çš„æ”¹è¿›ç‰ˆæœ¬ï¼Œæ›´å¥½çš„é¢„è®­ç»ƒç­–ç•¥
   - Improved BERT with better pre-training strategies
   - æ¨¡å‹å: &#x27;roberta-base&#x27;, &#x27;roberta-large&#x27;

2. DistilBERT
   - BERT çš„è½»é‡åŒ–ç‰ˆæœ¬ï¼Œé€Ÿåº¦æ›´å¿«
   - Lightweight BERT, faster inference
   - æ¨¡å‹å: &#x27;distilbert-base-uncased&#x27;

3. ALBERT (A Lite BERT)
   - å‚æ•°é«˜æ•ˆçš„ BERT å˜ä½“
   - Parameter-efficient BERT variant
   - æ¨¡å‹å: &#x27;albert-base-v2&#x27;

4. DeBERTa
   - è§£è€¦æ³¨æ„åŠ›æœºåˆ¶ï¼Œæ€§èƒ½æ›´å¼º
   - Disentangled attention, better performance
   - æ¨¡å‹å: &#x27;microsoft/deberta-base&#x27;

5. Sentence-BERT (SBERT)
   - ä¸“é—¨ä¸ºå¥å­ç›¸ä¼¼åº¦ä¼˜åŒ–çš„ BERT
   - BERT optimized for sentence similarity
   - éœ€è¦å®‰è£…: pip install sentence-transformers

ä½¿ç”¨ç¤ºä¾‹ / Usage Example:
    from sentence_transformers import SentenceTransformer
    model = SentenceTransformer(&#x27;paraphrase-multilingual-MiniLM-L12-v2&#x27;)
    embeddings = model.encode([&quot;å¥å­1&quot;, &quot;å¥å­2&quot;])
&quot;&quot;&quot;</span>
<span class="hljs-built_in">print</span>(OTHER_MODELS)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># æ€»ç»“ / Summary</span>
<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-string">&quot;&quot;&quot;
æœ¬ç¤ºä¾‹å±•ç¤ºäº† BERT Embedding çš„å¸¸ç”¨æ“ä½œ:
This example demonstrates common BERT embedding operations:

1. åŠ è½½ BERT æ¨¡å‹å’Œåˆ†è¯å™¨ / Loading BERT model and tokenizer
2. æ–‡æœ¬ç¼–ç  / Text encoding
3. è·å–è¯çº§åµŒå…¥ / Getting word-level embeddings
4. è·å–å¥å­åµŒå…¥ï¼ˆå¤šç§æ± åŒ–æ–¹æ³•ï¼‰/ Getting sentence embeddings (various pooling methods)
5. ä¸Šä¸‹æ–‡ç›¸å…³çš„è¯åµŒå…¥ / Context-aware word embeddings
6. å¥å­ç›¸ä¼¼åº¦è®¡ç®— / Sentence similarity computation
7. æ‰¹é‡å¤„ç† / Batch processing
8. ä½¿ç”¨ä¸åŒå±‚çš„åµŒå…¥ / Using embeddings from different layers
9. å…¶ä»–é¢„è®­ç»ƒæ¨¡å‹ / Other pre-trained models

BERT vs é™æ€è¯åµŒå…¥çš„ä¸»è¦ä¼˜åŠ¿ / Main advantages of BERT over static embeddings:
1. ä¸Šä¸‹æ–‡ç›¸å…³ / Context-aware: åŒä¸€ä¸ªè¯åœ¨ä¸åŒä¸Šä¸‹æ–‡ä¸­æœ‰ä¸åŒè¡¨ç¤º
2. å¤„ç†å¤šä¹‰è¯ / Handle polysemy: èƒ½åŒºåˆ†ä¸€è¯å¤šä¹‰
3. æ— éœ€é¢å¤–è®­ç»ƒ / No additional training: å¯ç›´æ¥ç”¨äºå„ç§ä»»åŠ¡

åœ¨ LLM åº”ç”¨ä¸­çš„ä½¿ç”¨åœºæ™¯ / Use cases in LLM applications:
- è¯­ä¹‰æœç´¢ / Semantic search
- æ–‡æœ¬ç›¸ä¼¼åº¦ / Text similarity
- æ–‡æœ¬åˆ†ç±» / Text classification
- å‘½åå®ä½“è¯†åˆ« / Named entity recognition
- é—®ç­”ç³»ç»Ÿ / Question answering
- æƒ…æ„Ÿåˆ†æ / Sentiment analysis
&quot;&quot;&quot;</span>
</code></pre></div><div class="code-file"><h3>glove_example.py</h3><pre class="hljs"><code><span class="hljs-string">&quot;&quot;&quot;
GloVe ç¤ºä¾‹ä»£ç  / GloVe Example Code
====================================

æœ¬ç¤ºä¾‹å±•ç¤ºå¦‚ä½•åŠ è½½å’Œä½¿ç”¨ GloVe (Global Vectors for Word Representation) è¯å‘é‡ã€‚
This example demonstrates how to load and use GloVe word vectors.

GloVe æ˜¯ Stanford æå‡ºçš„è¯åµŒå…¥æ–¹æ³•ï¼Œç»“åˆäº†å…¨å±€çŸ©é˜µåˆ†è§£å’Œå±€éƒ¨ä¸Šä¸‹æ–‡çª—å£çš„ä¼˜ç‚¹ã€‚
GloVe is a word embedding method proposed by Stanford, combining global matrix
factorization with local context window advantages.

è®ºæ–‡ / Paper: GloVe: Global Vectors for Word Representation (Pennington et al., 2014)

ä¾èµ–å®‰è£… / Dependencies:
    pip install numpy scipy

GloVe é¢„è®­ç»ƒå‘é‡ä¸‹è½½ / Pre-trained GloVe vectors download:
    https://nlp.stanford.edu/projects/glove/
&quot;&quot;&quot;</span>

<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 1. åŠ è½½ GloVe å‘é‡ / Loading GloVe Vectors</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">load_glove_vectors</span>(<span class="hljs-params">glove_file</span>):
    <span class="hljs-string">&quot;&quot;&quot;
    ä»æ–‡ä»¶åŠ è½½ GloVe è¯å‘é‡
    Load GloVe word vectors from file

    å‚æ•° / Args:
        glove_file: GloVe æ–‡ä»¶è·¯å¾„ / Path to GloVe file
                   æ ¼å¼: æ¯è¡Œä¸€ä¸ªè¯ï¼Œç©ºæ ¼åˆ†éš”ï¼Œç¬¬ä¸€ä¸ªæ˜¯è¯ï¼Œåé¢æ˜¯å‘é‡å€¼
                   Format: Each line contains a word followed by vector values

    è¿”å› / Returns:
        word_to_vec: è¯åˆ°å‘é‡çš„å­—å…¸ / Dictionary mapping words to vectors
        words: è¯åˆ—è¡¨ / List of words
        vectors: å‘é‡çŸ©é˜µ / Matrix of vectors
    &quot;&quot;&quot;</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;æ­£åœ¨åŠ è½½ GloVe å‘é‡... / Loading GloVe vectors from <span class="hljs-subst">{glove_file}</span>&quot;</span>)

    word_to_vec = {}
    words = []
    vectors = []

    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(glove_file, <span class="hljs-string">&#x27;r&#x27;</span>, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>) <span class="hljs-keyword">as</span> f:
        <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> f:
            values = line.strip().split()
            word = values[<span class="hljs-number">0</span>]
            vector = np.array(values[<span class="hljs-number">1</span>:], dtype=np.float32)

            word_to_vec[word] = vector
            words.append(word)
            vectors.append(vector)

    vectors = np.array(vectors)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;åŠ è½½å®Œæˆï¼è¯è¡¨å¤§å° / Loaded! Vocabulary size: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(words)}</span>&quot;</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;å‘é‡ç»´åº¦ / Vector dimension: <span class="hljs-subst">{vectors.shape[<span class="hljs-number">1</span>]}</span>&quot;</span>)

    <span class="hljs-keyword">return</span> word_to_vec, words, vectors


<span class="hljs-comment"># ç¤ºä¾‹: åŠ è½½ GloVe æ–‡ä»¶</span>
<span class="hljs-comment"># Example: Loading GloVe file</span>
<span class="hljs-comment"># glove_path = &quot;glove.6B.100d.txt&quot;  # 100ç»´ç‰ˆæœ¬ / 100-dimension version</span>
<span class="hljs-comment"># word_to_vec, words, vectors = load_glove_vectors(glove_path)</span>

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 2. ä½¿ç”¨ Gensim åŠ è½½ GloVe (æ¨èæ–¹å¼) / Using Gensim to Load GloVe (Recommended)</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">import</span> gensim.downloader <span class="hljs-keyword">as</span> api
<span class="hljs-keyword">from</span> gensim.models <span class="hljs-keyword">import</span> KeyedVectors

<span class="hljs-comment"># Gensim æä¾›äº†é¢„åŠ è½½çš„ GloVe æ¨¡å‹</span>
<span class="hljs-comment"># Gensim provides pre-loaded GloVe models</span>
<span class="hljs-comment"># å¯ç”¨æ¨¡å‹ / Available models:</span>
<span class="hljs-comment">#   - &#x27;glove-wiki-gigaword-50&#x27;: 50ç»´ / 50 dimensions (65MB)</span>
<span class="hljs-comment">#   - &#x27;glove-wiki-gigaword-100&#x27;: 100ç»´ / 100 dimensions (128MB)</span>
<span class="hljs-comment">#   - &#x27;glove-wiki-gigaword-200&#x27;: 200ç»´ / 200 dimensions (252MB)</span>
<span class="hljs-comment">#   - &#x27;glove-wiki-gigaword-300&#x27;: 300ç»´ / 300 dimensions (376MB)</span>
<span class="hljs-comment">#   - &#x27;glove-twitter-25&#x27;: 25ç»´ï¼ŒTwitter æ•°æ® / 25 dimensions, Twitter data</span>
<span class="hljs-comment">#   - &#x27;glove-twitter-50&#x27;: 50ç»´ï¼ŒTwitter æ•°æ® / 50 dimensions, Twitter data</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;æ­£åœ¨åŠ è½½ GloVe æ¨¡å‹... / Loading GloVe model...&quot;</span>)
model = api.load(<span class="hljs-string">&quot;glove-wiki-gigaword-100&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;æ¨¡å‹åŠ è½½å®Œæˆï¼è¯è¡¨å¤§å° / Model loaded! Vocabulary size: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(model)}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 3. è·å–è¯å‘é‡ / Getting Word Vectors</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-comment"># è·å–å•ä¸ªè¯çš„å‘é‡</span>
<span class="hljs-comment"># Get vector for a single word</span>
word = <span class="hljs-string">&quot;computer&quot;</span>
vector = model[word]

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nè¯ / Word: &#x27;<span class="hljs-subst">{word}</span>&#x27;&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;å‘é‡ç»´åº¦ / Vector dimension: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(vector)}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;å‘é‡å‰10ç»´ / First 10 dimensions: <span class="hljs-subst">{vector[:<span class="hljs-number">10</span>]}</span>&quot;</span>)

<span class="hljs-comment"># è·å–å¤šä¸ªè¯çš„å‘é‡ï¼ˆç”¨äºæ‰¹é‡å¤„ç†ï¼‰</span>
<span class="hljs-comment"># Get vectors for multiple words (for batch processing)</span>
words = [<span class="hljs-string">&quot;computer&quot;</span>, <span class="hljs-string">&quot;software&quot;</span>, <span class="hljs-string">&quot;hardware&quot;</span>, <span class="hljs-string">&quot;programming&quot;</span>]
vectors = [model[w] <span class="hljs-keyword">for</span> w <span class="hljs-keyword">in</span> words]
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\næ‰¹é‡è·å–å‘é‡ / Batch vector retrieval: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(vectors)}</span> ä¸ªè¯ / words&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 4. è¯­ä¹‰ç›¸ä¼¼åº¦è®¡ç®— / Semantic Similarity Computation</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">cosine_similarity</span>(<span class="hljs-params">v1, v2</span>):
    <span class="hljs-string">&quot;&quot;&quot;
    è®¡ç®—ä¸¤ä¸ªå‘é‡çš„ä½™å¼¦ç›¸ä¼¼åº¦
    Compute cosine similarity between two vectors

    å…¬å¼ / Formula: cos(Î¸) = (A Â· B) / (||A|| * ||B||)

    å‚æ•° / Args:
        v1, v2: å‘é‡ / Vectors

    è¿”å› / Returns:
        ä½™å¼¦ç›¸ä¼¼åº¦ï¼ŒèŒƒå›´ [-1, 1] / Cosine similarity, range [-1, 1]
    &quot;&quot;&quot;</span>
    dot_product = np.dot(v1, v2)
    norm_v1 = np.linalg.norm(v1)
    norm_v2 = np.linalg.norm(v2)

    <span class="hljs-keyword">if</span> norm_v1 == <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> norm_v2 == <span class="hljs-number">0</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-number">0.0</span>

    <span class="hljs-keyword">return</span> dot_product / (norm_v1 * norm_v2)


<span class="hljs-keyword">def</span> <span class="hljs-title function_">euclidean_distance</span>(<span class="hljs-params">v1, v2</span>):
    <span class="hljs-string">&quot;&quot;&quot;
    è®¡ç®—ä¸¤ä¸ªå‘é‡çš„æ¬§å‡ é‡Œå¾—è·ç¦»
    Compute Euclidean distance between two vectors

    å‚æ•° / Args:
        v1, v2: å‘é‡ / Vectors

    è¿”å› / Returns:
        æ¬§å‡ é‡Œå¾—è·ç¦» / Euclidean distance
    &quot;&quot;&quot;</span>
    <span class="hljs-keyword">return</span> np.linalg.norm(v1 - v2)


<span class="hljs-comment"># è®¡ç®—ä¸åŒæ¦‚å¿µä¹‹é—´çš„ç›¸ä¼¼åº¦</span>
<span class="hljs-comment"># Compute similarity between different concepts</span>
word_pairs = [
    (<span class="hljs-string">&quot;computer&quot;</span>, <span class="hljs-string">&quot;software&quot;</span>),    <span class="hljs-comment"># ç›¸å…³ / Related</span>
    (<span class="hljs-string">&quot;computer&quot;</span>, <span class="hljs-string">&quot;hardware&quot;</span>),    <span class="hljs-comment"># ç›¸å…³ / Related</span>
    (<span class="hljs-string">&quot;computer&quot;</span>, <span class="hljs-string">&quot;banana&quot;</span>),      <span class="hljs-comment"># ä¸ç›¸å…³ / Unrelated</span>
    (<span class="hljs-string">&quot;king&quot;</span>, <span class="hljs-string">&quot;queen&quot;</span>),           <span class="hljs-comment"># è¯­ä¹‰ç›¸å…³ / Semantically related</span>
    (<span class="hljs-string">&quot;good&quot;</span>, <span class="hljs-string">&quot;bad&quot;</span>),             <span class="hljs-comment"># åä¹‰è¯ä½†ç›¸å…³ / Antonyms but related</span>
]

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\nè¯å¯¹ç›¸ä¼¼åº¦ / Word Pair Similarities:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-keyword">for</span> w1, w2 <span class="hljs-keyword">in</span> word_pairs:
    cos_sim = model.similarity(w1, w2)  <span class="hljs-comment"># Gensim å†…ç½®æ–¹æ³• / Gensim built-in method</span>
    euc_dist = euclidean_distance(model[w1], model[w2])
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  <span class="hljs-subst">{w1:<span class="hljs-number">15</span>}</span> vs <span class="hljs-subst">{w2:<span class="hljs-number">15</span>}</span>: cos=<span class="hljs-subst">{cos_sim:<span class="hljs-number">.4</span>f}</span>, euclidean=<span class="hljs-subst">{euc_dist:<span class="hljs-number">.4</span>f}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 5. è¯­ä¹‰æœç´¢ / Semantic Search</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">semantic_search</span>(<span class="hljs-params">query, model, top_k=<span class="hljs-number">5</span></span>):
    <span class="hljs-string">&quot;&quot;&quot;
    è¯­ä¹‰æœç´¢ï¼šæ‰¾å‡ºä¸æŸ¥è¯¢è¯æœ€ç›¸ä¼¼çš„è¯
    Semantic search: Find words most similar to the query

    å‚æ•° / Args:
        query: æŸ¥è¯¢è¯ / Query word
        model: è¯å‘é‡æ¨¡å‹ / Word vector model
        top_k: è¿”å›çš„æœ€ç›¸ä¼¼è¯æ•°é‡ / Number of similar words to return

    è¿”å› / Returns:
        ç›¸ä¼¼è¯åˆ—è¡¨ï¼Œæ¯é¡¹ä¸º (è¯, ç›¸ä¼¼åº¦) å…ƒç»„
        List of similar words as (word, similarity) tuples
    &quot;&quot;&quot;</span>
    <span class="hljs-keyword">if</span> query <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> model:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;è¯ &#x27;<span class="hljs-subst">{query}</span>&#x27; ä¸åœ¨è¯è¡¨ä¸­ / Word &#x27;<span class="hljs-subst">{query}</span>&#x27; not in vocabulary&quot;</span>)
        <span class="hljs-keyword">return</span> []

    <span class="hljs-keyword">return</span> model.most_similar(query, topn=top_k)


<span class="hljs-comment"># æœç´¢ä¸ &quot;computer&quot; è¯­ä¹‰ç›¸å…³çš„è¯</span>
<span class="hljs-comment"># Search for words semantically related to &quot;computer&quot;</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\nè¯­ä¹‰æœç´¢ç»“æœ / Semantic Search Results:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">60</span>)
query_word = <span class="hljs-string">&quot;computer&quot;</span>
similar = semantic_search(query_word, model, top_k=<span class="hljs-number">10</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;ä¸ &#x27;<span class="hljs-subst">{query_word}</span>&#x27; æœ€ç›¸ä¼¼çš„è¯ / Words most similar to &#x27;<span class="hljs-subst">{query_word}</span>&#x27;:&quot;</span>)
<span class="hljs-keyword">for</span> word, score <span class="hljs-keyword">in</span> similar:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  <span class="hljs-subst">{word:<span class="hljs-number">20</span>}</span>: <span class="hljs-subst">{score:<span class="hljs-number">.4</span>f}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 6. è¯ç±»æ¯” (Word Analogy)</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">word_analogy</span>(<span class="hljs-params">model, a, b, c, top_k=<span class="hljs-number">3</span></span>):
    <span class="hljs-string">&quot;&quot;&quot;
    è¯ç±»æ¯”ä»»åŠ¡ï¼ša ä¹‹äº b å°±åƒ ? ä¹‹äº c
    Word analogy task: a is to b as ? is to c

    æ•°å­¦å½¢å¼ / Mathematical form: result = b - a + c
    ä¾‹å¦‚ / Example: king - man + woman = queen

    å‚æ•° / Args:
        model: è¯å‘é‡æ¨¡å‹ / Word vector model
        a, b, c: ç±»æ¯”è¯ / Analogy words
        top_k: è¿”å›çš„ç»“æœæ•°é‡ / Number of results to return

    è¿”å› / Returns:
        ç±»æ¯”ç»“æœåˆ—è¡¨ / List of analogy results
    &quot;&quot;&quot;</span>
    <span class="hljs-comment"># ä½¿ç”¨å‘é‡è¿ç®—</span>
    <span class="hljs-comment"># Use vector arithmetic</span>
    result = model.most_similar(
        positive=[b, c],
        negative=[a],
        topn=top_k
    )
    <span class="hljs-keyword">return</span> result


<span class="hljs-comment"># ç»å…¸è¯ç±»æ¯”ç¤ºä¾‹</span>
<span class="hljs-comment"># Classic word analogy examples</span>
analogies = [
    (<span class="hljs-string">&quot;man&quot;</span>, <span class="hljs-string">&quot;king&quot;</span>, <span class="hljs-string">&quot;woman&quot;</span>),        <span class="hljs-comment"># king - man + woman = queen</span>
    (<span class="hljs-string">&quot;france&quot;</span>, <span class="hljs-string">&quot;paris&quot;</span>, <span class="hljs-string">&quot;germany&quot;</span>),  <span class="hljs-comment"># paris - france + germany = berlin</span>
    (<span class="hljs-string">&quot;good&quot;</span>, <span class="hljs-string">&quot;better&quot;</span>, <span class="hljs-string">&quot;bad&quot;</span>),       <span class="hljs-comment"># better - good + bad = worse</span>
    (<span class="hljs-string">&quot;walk&quot;</span>, <span class="hljs-string">&quot;walked&quot;</span>, <span class="hljs-string">&quot;run&quot;</span>),       <span class="hljs-comment"># walked - walk + run = ran</span>
]

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\nè¯ç±»æ¯”ç»“æœ / Word Analogy Results:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-keyword">for</span> a, b, c <span class="hljs-keyword">in</span> analogies:
    results = word_analogy(model, a, b, c)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  <span class="hljs-subst">{a}</span> : <span class="hljs-subst">{b}</span> :: <span class="hljs-subst">{c}</span> : ?&quot;</span>)
    <span class="hljs-keyword">for</span> word, score <span class="hljs-keyword">in</span> results:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;    â†’ <span class="hljs-subst">{word}</span> (ç›¸ä¼¼åº¦ / similarity: <span class="hljs-subst">{score:<span class="hljs-number">.4</span>f}</span>)&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 7. å¥å­/æ–‡æ¡£åµŒå…¥ / Sentence/Document Embedding</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">sentence_embedding_glove</span>(<span class="hljs-params">model, sentence, method=<span class="hljs-string">&#x27;mean&#x27;</span></span>):
    <span class="hljs-string">&quot;&quot;&quot;
    ä½¿ç”¨ GloVe ç”Ÿæˆå¥å­åµŒå…¥
    Generate sentence embedding using GloVe

    å‚æ•° / Args:
        model: GloVe æ¨¡å‹ / GloVe model
        sentence: è¾“å…¥å¥å­ / Input sentence
        method: èšåˆæ–¹æ³• (&#x27;mean&#x27;, &#x27;max&#x27;, &#x27;weighted&#x27;)
                Aggregation method (&#x27;mean&#x27;, &#x27;max&#x27;, &#x27;weighted&#x27;)

    è¿”å› / Returns:
        å¥å­åµŒå…¥å‘é‡ / Sentence embedding vector
    &quot;&quot;&quot;</span>
    <span class="hljs-comment"># ç®€å•åˆ†è¯ï¼ˆå®é™…åº”ç”¨ä½¿ç”¨æ›´å¤æ‚çš„åˆ†è¯å™¨ï¼‰</span>
    <span class="hljs-comment"># Simple tokenization (use sophisticated tokenizer in practice)</span>
    words = sentence.lower().split()

    <span class="hljs-comment"># è¿‡æ»¤ä¸åœ¨è¯è¡¨ä¸­çš„è¯</span>
    <span class="hljs-comment"># Filter words not in vocabulary</span>
    valid_words = [w <span class="hljs-keyword">for</span> w <span class="hljs-keyword">in</span> words <span class="hljs-keyword">if</span> w <span class="hljs-keyword">in</span> model]

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> valid_words:
        <span class="hljs-keyword">return</span> np.zeros(model.vector_size)

    <span class="hljs-comment"># è·å–è¯å‘é‡</span>
    <span class="hljs-comment"># Get word vectors</span>
    vectors = np.array([model[w] <span class="hljs-keyword">for</span> w <span class="hljs-keyword">in</span> valid_words])

    <span class="hljs-keyword">if</span> method == <span class="hljs-string">&#x27;mean&#x27;</span>:
        <span class="hljs-comment"># å¹³å‡æ± åŒ– / Mean pooling</span>
        <span class="hljs-keyword">return</span> np.mean(vectors, axis=<span class="hljs-number">0</span>)
    <span class="hljs-keyword">elif</span> method == <span class="hljs-string">&#x27;max&#x27;</span>:
        <span class="hljs-comment"># æœ€å¤§æ± åŒ– / Max pooling</span>
        <span class="hljs-keyword">return</span> np.<span class="hljs-built_in">max</span>(vectors, axis=<span class="hljs-number">0</span>)
    <span class="hljs-keyword">elif</span> method == <span class="hljs-string">&#x27;weighted&#x27;</span>:
        <span class="hljs-comment"># TF-IDF åŠ æƒï¼ˆç®€åŒ–ç‰ˆï¼Œå®é™…éœ€è¦ IDF å€¼ï¼‰</span>
        <span class="hljs-comment"># TF-IDF weighted (simplified, needs IDF values in practice)</span>
        weights = np.ones(<span class="hljs-built_in">len</span>(vectors)) / <span class="hljs-built_in">len</span>(vectors)
        <span class="hljs-keyword">return</span> np.average(vectors, axis=<span class="hljs-number">0</span>, weights=weights)

    <span class="hljs-keyword">return</span> np.mean(vectors, axis=<span class="hljs-number">0</span>)


<span class="hljs-comment"># å¥å­ç›¸ä¼¼åº¦ç¤ºä¾‹</span>
<span class="hljs-comment"># Sentence similarity example</span>
sentences = [
    <span class="hljs-string">&quot;the king sat on the throne&quot;</span>,
    <span class="hljs-string">&quot;the queen ruled the kingdom&quot;</span>,
    <span class="hljs-string">&quot;the computer runs software programs&quot;</span>,
    <span class="hljs-string">&quot;i like to eat pizza for dinner&quot;</span>
]

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\nå¥å­åµŒå…¥ä¸ç›¸ä¼¼åº¦ / Sentence Embeddings and Similarity:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-comment"># è®¡ç®—å¥å­åµŒå…¥</span>
<span class="hljs-comment"># Compute sentence embeddings</span>
sentence_vectors = [sentence_embedding_glove(model, s) <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> sentences]

<span class="hljs-comment"># è®¡ç®—å¥å­å¯¹ç›¸ä¼¼åº¦</span>
<span class="hljs-comment"># Compute pairwise sentence similarity</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(sentences)):
    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(i + <span class="hljs-number">1</span>, <span class="hljs-built_in">len</span>(sentences)):
        sim = cosine_similarity(sentence_vectors[i], sentence_vectors[j])
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  å¥å­ <span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span> vs å¥å­ <span class="hljs-subst">{j+<span class="hljs-number">1</span>}</span>: <span class="hljs-subst">{sim:<span class="hljs-number">.4</span>f}</span>&quot;</span>)
        <span class="hljs-keyword">if</span> i &lt; <span class="hljs-number">2</span>:  <span class="hljs-comment"># åªæ˜¾ç¤ºç¬¬ä¸€ç»„æ¯”è¾ƒçš„å¥å­ / Only show first comparison group</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;    &#x27;<span class="hljs-subst">{sentences[i]}</span>&#x27;&quot;</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;    &#x27;<span class="hljs-subst">{sentences[j]}</span>&#x27;&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 8. æœ€è¿‘é‚»æœç´¢ / Nearest Neighbor Search</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">find_nearest_neighbors</span>(<span class="hljs-params">query_vector, model, k=<span class="hljs-number">5</span>, exclude_words=<span class="hljs-literal">None</span></span>):
    <span class="hljs-string">&quot;&quot;&quot;
    åœ¨è¯å‘é‡ç©ºé—´ä¸­æ‰¾æœ€è¿‘é‚»
    Find nearest neighbors in word vector space

    å‚æ•° / Args:
        query_vector: æŸ¥è¯¢å‘é‡ / Query vector
        model: è¯å‘é‡æ¨¡å‹ / Word vector model
        k: è¿”å›çš„é‚»å±…æ•°é‡ / Number of neighbors to return
        exclude_words: è¦æ’é™¤çš„è¯åˆ—è¡¨ / Words to exclude

    è¿”å› / Returns:
        æœ€è¿‘é‚»è¯å’Œè·ç¦»åˆ—è¡¨ / List of nearest neighbor words and distances
    &quot;&quot;&quot;</span>
    exclude_words = exclude_words <span class="hljs-keyword">or</span> []
    similarities = []

    <span class="hljs-keyword">for</span> word <span class="hljs-keyword">in</span> model.index_to_key:
        <span class="hljs-keyword">if</span> word <span class="hljs-keyword">in</span> exclude_words:
            <span class="hljs-keyword">continue</span>
        sim = cosine_similarity(query_vector, model[word])
        similarities.append((word, sim))

    <span class="hljs-comment"># æŒ‰ç›¸ä¼¼åº¦é™åºæ’åº</span>
    <span class="hljs-comment"># Sort by similarity in descending order</span>
    similarities.sort(key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-number">1</span>], reverse=<span class="hljs-literal">True</span>)

    <span class="hljs-keyword">return</span> similarities[:k]


<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 9. è¯å‘é‡å¯è§†åŒ–å‡†å¤‡ / Word Vector Visualization Preparation</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">prepare_for_visualization</span>(<span class="hljs-params">model, words</span>):
    <span class="hljs-string">&quot;&quot;&quot;
    å‡†å¤‡è¯å‘é‡çš„ 2D å¯è§†åŒ–æ•°æ®ï¼ˆPCA é™ç»´ï¼‰
    Prepare word vectors for 2D visualization (PCA dimensionality reduction)

    å‚æ•° / Args:
        model: è¯å‘é‡æ¨¡å‹ / Word vector model
        words: è¦å¯è§†åŒ–çš„è¯åˆ—è¡¨ / Words to visualize

    è¿”å› / Returns:
        2D åæ ‡æ•°ç»„ / Array of 2D coordinates
    &quot;&quot;&quot;</span>
    <span class="hljs-keyword">from</span> sklearn.decomposition <span class="hljs-keyword">import</span> PCA

    <span class="hljs-comment"># è·å–è¯å‘é‡</span>
    <span class="hljs-comment"># Get word vectors</span>
    vectors = np.array([model[w] <span class="hljs-keyword">for</span> w <span class="hljs-keyword">in</span> words <span class="hljs-keyword">if</span> w <span class="hljs-keyword">in</span> model])

    <span class="hljs-comment"># PCA é™ç»´åˆ° 2D</span>
    <span class="hljs-comment"># PCA reduction to 2D</span>
    pca = PCA(n_components=<span class="hljs-number">2</span>)
    coordinates_2d = pca.fit_transform(vectors)

    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;PCA è§£é‡Šæ–¹å·®æ¯” / PCA explained variance ratio: <span class="hljs-subst">{pca.explained_variance_ratio_}</span>&quot;</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;æ€»è§£é‡Šæ–¹å·® / Total explained variance: <span class="hljs-subst">{<span class="hljs-built_in">sum</span>(pca.explained_variance_ratio_):<span class="hljs-number">.4</span>f}</span>&quot;</span>)

    <span class="hljs-keyword">return</span> coordinates_2d


<span class="hljs-comment"># å¯è§†åŒ–ç¤ºä¾‹è¯</span>
<span class="hljs-comment"># Example words for visualization</span>
visualization_words = [
    <span class="hljs-string">&quot;king&quot;</span>, <span class="hljs-string">&quot;queen&quot;</span>, <span class="hljs-string">&quot;prince&quot;</span>, <span class="hljs-string">&quot;princess&quot;</span>,  <span class="hljs-comment"># çš‡å®¤ / Royalty</span>
    <span class="hljs-string">&quot;computer&quot;</span>, <span class="hljs-string">&quot;software&quot;</span>, <span class="hljs-string">&quot;hardware&quot;</span>, <span class="hljs-string">&quot;program&quot;</span>,  <span class="hljs-comment"># ç§‘æŠ€ / Technology</span>
    <span class="hljs-string">&quot;apple&quot;</span>, <span class="hljs-string">&quot;banana&quot;</span>, <span class="hljs-string">&quot;orange&quot;</span>, <span class="hljs-string">&quot;fruit&quot;</span>,  <span class="hljs-comment"># æ°´æœ / Fruits</span>
]

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\nå¯è§†åŒ–å‡†å¤‡ / Visualization Preparation:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-comment"># coords = prepare_for_visualization(model, visualization_words)</span>
<span class="hljs-comment"># ç„¶åä½¿ç”¨ matplotlib ç»˜åˆ¶ / Then plot with matplotlib</span>

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># æ€»ç»“ / Summary</span>
<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-string">&quot;&quot;&quot;
æœ¬ç¤ºä¾‹å±•ç¤ºäº† GloVe çš„å¸¸ç”¨æ“ä½œ:
This example demonstrates common GloVe operations:

1. åŠ è½½ GloVe å‘é‡ï¼ˆæ–‡ä»¶æ–¹å¼ &amp; Gensimï¼‰/ Loading GloVe vectors (file &amp; Gensim)
2. è·å–è¯å‘é‡ / Getting word vectors
3. è¯­ä¹‰ç›¸ä¼¼åº¦è®¡ç®— / Semantic similarity computation
4. è¯­ä¹‰æœç´¢ / Semantic search
5. è¯ç±»æ¯”ä»»åŠ¡ / Word analogy tasks
6. å¥å­åµŒå…¥ / Sentence embeddings
7. æœ€è¿‘é‚»æœç´¢ / Nearest neighbor search
8. å¯è§†åŒ–å‡†å¤‡ / Visualization preparation

GloVe vs Word2Vec ä¸»è¦åŒºåˆ« / Main differences between GloVe and Word2Vec:

| ç‰¹æ€§ | GloVe | Word2Vec |
|------|-------|----------|
| è®­ç»ƒæ–¹æ³• | å…¨å±€å…±ç°çŸ©é˜µ | å±€éƒ¨ä¸Šä¸‹æ–‡çª—å£ |
| è®¡ç®—å¤æ‚åº¦ | è¾ƒé«˜ | è¾ƒä½ |
| è¯­ä¹‰æ•æ‰ | å…¨å±€ç»Ÿè®¡ | å±€éƒ¨æ¨¡å¼ |
| ç±»æ¯”æ€§èƒ½ | ç•¥ä¼˜ | ä¼˜ç§€ |

åœ¨ LLM åº”ç”¨ä¸­çš„ä½¿ç”¨åœºæ™¯ / Use cases in LLM applications:
- æ–‡æœ¬ç›¸ä¼¼åº¦è®¡ç®— / Text similarity computation
- è¯­ä¹‰æœç´¢ / Semantic search
- æ¨èç³»ç»Ÿ / Recommendation systems
- æ–‡æœ¬åˆ†ç±»ç‰¹å¾ / Text classification features
- çŸ¥è¯†å›¾è°±æ„å»º / Knowledge graph construction
&quot;&quot;&quot;</span>
</code></pre></div><div class="code-file"><h3>word2vec_example.py</h3><pre class="hljs"><code><span class="hljs-string">&quot;&quot;&quot;
Word2Vec ç¤ºä¾‹ä»£ç  / Word2Vec Example Code
==========================================

æœ¬ç¤ºä¾‹å±•ç¤ºå¦‚ä½•ä½¿ç”¨ Gensim åº“åŠ è½½å’Œä½¿ç”¨é¢„è®­ç»ƒçš„ Word2Vec æ¨¡å‹ã€‚
This example demonstrates how to load and use pre-trained Word2Vec models with Gensim.

Word2Vec æ˜¯ Google æå‡ºçš„è¯åµŒå…¥æ–¹æ³•ï¼Œé€šè¿‡é¢„æµ‹ä¸Šä¸‹æ–‡æ¥å­¦ä¹ è¯çš„å‘é‡è¡¨ç¤ºã€‚
Word2Vec is a word embedding method proposed by Google, learning vector representations
by predicting context words.

ä¾èµ–å®‰è£… / Dependencies:
    pip install gensim
&quot;&quot;&quot;</span>

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 1. åŠ è½½é¢„è®­ç»ƒæ¨¡å‹ / Loading Pre-trained Model</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">from</span> gensim.models <span class="hljs-keyword">import</span> KeyedVectors
<span class="hljs-keyword">from</span> gensim.test.utils <span class="hljs-keyword">import</span> datapath

<span class="hljs-comment"># åŠ è½½ Google News é¢„è®­ç»ƒæ¨¡å‹ (çº¦ 3.4GB)</span>
<span class="hljs-comment"># Load Google News pre-trained model (~3.4GB)</span>
<span class="hljs-comment"># æ³¨æ„: éœ€è¦å…ˆä¸‹è½½ GoogleNews-vectors-negative300.bin</span>
<span class="hljs-comment"># Note: Need to download GoogleNews-vectors-negative300.bin first</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># model = KeyedVectors.load_word2vec_format(</span>
<span class="hljs-comment">#     datapath(&#x27;/path/to/GoogleNews-vectors-negative300.bin&#x27;),</span>
<span class="hljs-comment">#     binary=True</span>
<span class="hljs-comment"># )</span>

<span class="hljs-comment"># ä¸ºäº†æ¼”ç¤ºï¼Œæˆ‘ä»¬ä½¿ç”¨ Gensim å†…ç½®çš„å°å‹æµ‹è¯•æ¨¡å‹</span>
<span class="hljs-comment"># For demonstration, we use Gensim&#x27;s built-in small test model</span>
<span class="hljs-keyword">import</span> gensim.downloader <span class="hljs-keyword">as</span> api

<span class="hljs-comment"># åŠ è½½å°å‹é¢„è®­ç»ƒæ¨¡å‹ (GloVe æ ¼å¼ï¼ŒGensim å¯ä»¥å…¼å®¹)</span>
<span class="hljs-comment"># Load small pre-trained model (GloVe format, compatible with Gensim)</span>
<span class="hljs-comment"># å¯ç”¨æ¨¡å‹åˆ—è¡¨ / Available models:</span>
<span class="hljs-comment">#   - &#x27;word2vec-ruscorpora-300&#x27;: ä¿„è¯­è¯­æ–™åº“ / Russian corpus</span>
<span class="hljs-comment">#   - &#x27;word2vec-google-news-300&#x27;: Google News (1.5GB)</span>
<span class="hljs-comment">#   - &#x27;glove-wiki-gigaword-100&#x27;: ç»´åŸºç™¾ç§‘ + Gigaword (128MB)</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;æ­£åœ¨åŠ è½½æ¨¡å‹... / Loading model...&quot;</span>)
model = api.load(<span class="hljs-string">&quot;glove-wiki-gigaword-100&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;æ¨¡å‹åŠ è½½å®Œæˆï¼è¯è¡¨å¤§å° / Model loaded! Vocabulary size: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(model)}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 2. è·å–è¯å‘é‡ / Getting Word Vectors</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-comment"># è·å–å•ä¸ªè¯çš„å‘é‡è¡¨ç¤º</span>
<span class="hljs-comment"># Get the vector representation of a single word</span>
word = <span class="hljs-string">&quot;king&quot;</span>
vector = model[word]

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nè¯ / Word: &#x27;<span class="hljs-subst">{word}</span>&#x27;&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;å‘é‡ç»´åº¦ / Vector dimension: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(vector)}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;å‘é‡å‰10ç»´ / First 10 dimensions: <span class="hljs-subst">{vector[:<span class="hljs-number">10</span>]}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 3. è®¡ç®—è¯ç›¸ä¼¼åº¦ / Computing Word Similarity</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-comment"># è®¡ç®—ä¸¤ä¸ªè¯ä¹‹é—´çš„ä½™å¼¦ç›¸ä¼¼åº¦</span>
<span class="hljs-comment"># Compute cosine similarity between two words</span>
similarity = model.similarity(<span class="hljs-string">&quot;king&quot;</span>, <span class="hljs-string">&quot;queen&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n&#x27;king&#x27; å’Œ &#x27;queen&#x27; çš„ç›¸ä¼¼åº¦ / Similarity: <span class="hljs-subst">{similarity:<span class="hljs-number">.4</span>f}</span>&quot;</span>)

similarity = model.similarity(<span class="hljs-string">&quot;king&quot;</span>, <span class="hljs-string">&quot;car&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;&#x27;king&#x27; å’Œ &#x27;car&#x27; çš„ç›¸ä¼¼åº¦ / Similarity: <span class="hljs-subst">{similarity:<span class="hljs-number">.4</span>f}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 4. æŸ¥æ‰¾ç›¸ä¼¼è¯ / Finding Similar Words</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-comment"># æ‰¾å‡ºä¸ç»™å®šè¯æœ€ç›¸ä¼¼çš„è¯</span>
<span class="hljs-comment"># Find the most similar words to a given word</span>
similar_words = model.most_similar(<span class="hljs-string">&quot;king&quot;</span>, topn=<span class="hljs-number">5</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nä¸ &#x27;king&#x27; æœ€ç›¸ä¼¼çš„è¯ / Words most similar to &#x27;king&#x27;:&quot;</span>)
<span class="hljs-keyword">for</span> word, score <span class="hljs-keyword">in</span> similar_words:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  <span class="hljs-subst">{word}</span>: <span class="hljs-subst">{score:<span class="hljs-number">.4</span>f}</span>&quot;</span>)

<span class="hljs-comment"># å¤šä¸ªè¯çš„ç›¸ä¼¼è¯ï¼ˆå–å¹³å‡ï¼‰</span>
<span class="hljs-comment"># Similar words to multiple words (averaged)</span>
similar_words = model.most_similar(
    positive=[<span class="hljs-string">&quot;king&quot;</span>, <span class="hljs-string">&quot;woman&quot;</span>],  <span class="hljs-comment"># æ­£å‘è¯ / Positive words</span>
    topn=<span class="hljs-number">5</span>
)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nä¸ &#x27;king&#x27; + &#x27;woman&#x27; æœ€ç›¸ä¼¼çš„è¯ / Words similar to &#x27;king&#x27; + &#x27;woman&#x27;:&quot;</span>)
<span class="hljs-keyword">for</span> word, score <span class="hljs-keyword">in</span> similar_words:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  <span class="hljs-subst">{word}</span>: <span class="hljs-subst">{score:<span class="hljs-number">.4</span>f}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 5. è¯ç±»æ¯”ä»»åŠ¡ / Word Analogy Task</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-comment"># ç»å…¸çš„è¯ç±»æ¯”: king - man + woman = queen</span>
<span class="hljs-comment"># Classic word analogy: king - man + woman = queen</span>
<span class="hljs-comment"># è¯­ä¹‰: &quot;å›½ç‹&quot;ä¹‹äº&quot;ç”·äºº&quot;å°±åƒ&quot;ï¼Ÿ&quot;ä¹‹äº&quot;å¥³äºº&quot;</span>
<span class="hljs-comment"># Semantics: &quot;king&quot; is to &quot;man&quot; as &quot;?&quot; is to &quot;woman&quot;</span>

result = model.most_similar(
    positive=[<span class="hljs-string">&quot;king&quot;</span>, <span class="hljs-string">&quot;woman&quot;</span>],  <span class="hljs-comment"># æ­£å‘è¯ / Positive words</span>
    negative=[<span class="hljs-string">&quot;man&quot;</span>],            <span class="hljs-comment"># è´Ÿå‘è¯ / Negative words</span>
    topn=<span class="hljs-number">3</span>
)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nè¯ç±»æ¯”: king - man + woman = ?&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Word analogy: king - man + woman = ?&quot;</span>)
<span class="hljs-keyword">for</span> word, score <span class="hljs-keyword">in</span> result:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  <span class="hljs-subst">{word}</span>: <span class="hljs-subst">{score:<span class="hljs-number">.4</span>f}</span>&quot;</span>)

<span class="hljs-comment"># å¦ä¸€ä¸ªä¾‹å­: å·´é»ä¹‹äºæ³•å›½ï¼Œå°±åƒæŸæ—ä¹‹äºï¼Ÿ</span>
<span class="hljs-comment"># Another example: Paris is to France as Berlin is to ?</span>
result = model.most_similar(
    positive=[<span class="hljs-string">&quot;berlin&quot;</span>, <span class="hljs-string">&quot;france&quot;</span>],
    negative=[<span class="hljs-string">&quot;paris&quot;</span>],
    topn=<span class="hljs-number">3</span>
)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nè¯ç±»æ¯”: berlin - paris + france = ?&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Word analogy: berlin - paris + france = ?&quot;</span>)
<span class="hljs-keyword">for</span> word, score <span class="hljs-keyword">in</span> result:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  <span class="hljs-subst">{word}</span>: <span class="hljs-subst">{score:<span class="hljs-number">.4</span>f}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 6. æ‰¾å‡ºä¸åŒ¹é…çš„è¯ / Finding the Odd One Out</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-comment"># ä»ä¸€ç»„è¯ä¸­æ‰¾å‡ºè¯­ä¹‰ä¸Šä¸ç›¸å…³çš„è¯</span>
<span class="hljs-comment"># Find the semantically unrelated word from a group</span>
odd_one = model.doesnt_match([<span class="hljs-string">&quot;breakfast&quot;</span>, <span class="hljs-string">&quot;lunch&quot;</span>, <span class="hljs-string">&quot;dinner&quot;</span>, <span class="hljs-string">&quot;car&quot;</span>])
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nä¸åŒ¹é…çš„è¯ / Odd one out in [breakfast, lunch, dinner, car]: <span class="hljs-subst">{odd_one}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 7. å¥å­ç›¸ä¼¼åº¦ï¼ˆç®€å•å¹³å‡æ³•ï¼‰/ Sentence Similarity (Simple Averaging)</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np

<span class="hljs-keyword">def</span> <span class="hljs-title function_">sentence_vector</span>(<span class="hljs-params">model, sentence</span>):
    <span class="hljs-string">&quot;&quot;&quot;
    è®¡ç®—å¥å­çš„å‘é‡è¡¨ç¤ºï¼ˆè¯å‘é‡å¹³å‡ï¼‰
    Compute sentence vector representation (average of word vectors)

    å‚æ•° / Args:
        model: Word2Vec æ¨¡å‹ / Word2Vec model
        sentence: å¥å­å­—ç¬¦ä¸² / Sentence string

    è¿”å› / Returns:
        å¥å­çš„å‘é‡è¡¨ç¤º / Vector representation of the sentence
    &quot;&quot;&quot;</span>
    <span class="hljs-comment"># ç®€å•åˆ†è¯ï¼ˆå®é™…åº”ç”¨ä¸­åº”ä½¿ç”¨æ›´å¤æ‚çš„åˆ†è¯å™¨ï¼‰</span>
    <span class="hljs-comment"># Simple tokenization (use more sophisticated tokenizer in practice)</span>
    words = sentence.lower().split()

    <span class="hljs-comment"># è·å–æ‰€æœ‰è¯çš„å‘é‡ï¼ˆå¿½ç•¥ä¸åœ¨è¯è¡¨ä¸­çš„è¯ï¼‰</span>
    <span class="hljs-comment"># Get vectors for all words (ignore words not in vocabulary)</span>
    vectors = [model[word] <span class="hljs-keyword">for</span> word <span class="hljs-keyword">in</span> words <span class="hljs-keyword">if</span> word <span class="hljs-keyword">in</span> model]

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> vectors:
        <span class="hljs-keyword">return</span> np.zeros(model.vector_size)

    <span class="hljs-comment"># è¿”å›å¹³å‡å‘é‡ / Return averaged vector</span>
    <span class="hljs-keyword">return</span> np.mean(vectors, axis=<span class="hljs-number">0</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">cosine_similarity</span>(<span class="hljs-params">v1, v2</span>):
    <span class="hljs-string">&quot;&quot;&quot;
    è®¡ç®—ä¸¤ä¸ªå‘é‡çš„ä½™å¼¦ç›¸ä¼¼åº¦
    Compute cosine similarity between two vectors
    &quot;&quot;&quot;</span>
    <span class="hljs-keyword">return</span> np.dot(v1, v2) / (np.linalg.norm(v1) * np.linalg.norm(v2))

<span class="hljs-comment"># è®¡ç®—ä¸¤ä¸ªå¥å­çš„ç›¸ä¼¼åº¦</span>
<span class="hljs-comment"># Compute similarity between two sentences</span>
sent1 = <span class="hljs-string">&quot;the king sits on the throne&quot;</span>
sent2 = <span class="hljs-string">&quot;the queen sits on the throne&quot;</span>
sent3 = <span class="hljs-string">&quot;the car drives on the road&quot;</span>

vec1 = sentence_vector(model, sent1)
vec2 = sentence_vector(model, sent2)
vec3 = sentence_vector(model, sent3)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nå¥å­ç›¸ä¼¼åº¦ / Sentence Similarity:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  &#x27;<span class="hljs-subst">{sent1}</span>&#x27; vs &#x27;<span class="hljs-subst">{sent2}</span>&#x27;: <span class="hljs-subst">{cosine_similarity(vec1, vec2):<span class="hljs-number">.4</span>f}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  &#x27;<span class="hljs-subst">{sent1}</span>&#x27; vs &#x27;<span class="hljs-subst">{sent3}</span>&#x27;: <span class="hljs-subst">{cosine_similarity(vec1, vec3):<span class="hljs-number">.4</span>f}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 8. è®­ç»ƒè‡ªå·±çš„ Word2Vec æ¨¡å‹ / Training Your Own Word2Vec Model</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">from</span> gensim.models <span class="hljs-keyword">import</span> Word2Vec

<span class="hljs-comment"># ç¤ºä¾‹è¯­æ–™ï¼ˆå®é™…åº”ç”¨ä¸­éœ€è¦å¤§é‡æ–‡æœ¬ï¼‰</span>
<span class="hljs-comment"># Sample corpus (need large amount of text in practice)</span>
corpus = [
    [<span class="hljs-string">&quot;the&quot;</span>, <span class="hljs-string">&quot;king&quot;</span>, <span class="hljs-string">&quot;sat&quot;</span>, <span class="hljs-string">&quot;on&quot;</span>, <span class="hljs-string">&quot;the&quot;</span>, <span class="hljs-string">&quot;throne&quot;</span>],
    [<span class="hljs-string">&quot;the&quot;</span>, <span class="hljs-string">&quot;queen&quot;</span>, <span class="hljs-string">&quot;sat&quot;</span>, <span class="hljs-string">&quot;next&quot;</span>, <span class="hljs-string">&quot;to&quot;</span>, <span class="hljs-string">&quot;the&quot;</span>, <span class="hljs-string">&quot;king&quot;</span>],
    [<span class="hljs-string">&quot;the&quot;</span>, <span class="hljs-string">&quot;prince&quot;</span>, <span class="hljs-string">&quot;is&quot;</span>, <span class="hljs-string">&quot;the&quot;</span>, <span class="hljs-string">&quot;son&quot;</span>, <span class="hljs-string">&quot;of&quot;</span>, <span class="hljs-string">&quot;the&quot;</span>, <span class="hljs-string">&quot;king&quot;</span>],
    [<span class="hljs-string">&quot;the&quot;</span>, <span class="hljs-string">&quot;princess&quot;</span>, <span class="hljs-string">&quot;is&quot;</span>, <span class="hljs-string">&quot;the&quot;</span>, <span class="hljs-string">&quot;daughter&quot;</span>, <span class="hljs-string">&quot;of&quot;</span>, <span class="hljs-string">&quot;the&quot;</span>, <span class="hljs-string">&quot;queen&quot;</span>],
]

<span class="hljs-comment"># è®­ç»ƒ Word2Vec æ¨¡å‹</span>
<span class="hljs-comment"># Train Word2Vec model</span>
<span class="hljs-comment"># å‚æ•°è¯´æ˜ / Parameter explanation:</span>
<span class="hljs-comment">#   vector_size: å‘é‡ç»´åº¦ / Vector dimension</span>
<span class="hljs-comment">#   window: ä¸Šä¸‹æ–‡çª—å£å¤§å° / Context window size</span>
<span class="hljs-comment">#   min_count: å¿½ç•¥å‡ºç°æ¬¡æ•°å°‘äºæ­¤å€¼çš„è¯ / Ignore words with frequency less than this</span>
<span class="hljs-comment">#   workers: å¹¶è¡Œçº¿ç¨‹æ•° / Number of parallel threads</span>
custom_model = Word2Vec(
    sentences=corpus,
    vector_size=<span class="hljs-number">100</span>,  <span class="hljs-comment"># å‘é‡ç»´åº¦ / Vector dimension</span>
    window=<span class="hljs-number">5</span>,         <span class="hljs-comment"># ä¸Šä¸‹æ–‡çª—å£ / Context window</span>
    min_count=<span class="hljs-number">1</span>,      <span class="hljs-comment"># æœ€å°è¯é¢‘ / Minimum word frequency</span>
    workers=<span class="hljs-number">4</span>,        <span class="hljs-comment"># å¹¶è¡Œçº¿ç¨‹ / Parallel threads</span>
    sg=<span class="hljs-number">0</span>              <span class="hljs-comment"># 0=CBOW, 1=Skip-gram</span>
)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nè‡ªå®šä¹‰æ¨¡å‹è¯è¡¨å¤§å° / Custom model vocabulary size: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(custom_model.wv)}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;ä¸ &#x27;king&#x27; æœ€ç›¸ä¼¼çš„è¯ / Words similar to &#x27;king&#x27;:&quot;</span>)
<span class="hljs-keyword">for</span> word, score <span class="hljs-keyword">in</span> custom_model.wv.most_similar(<span class="hljs-string">&quot;king&quot;</span>, topn=<span class="hljs-number">3</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  <span class="hljs-subst">{word}</span>: <span class="hljs-subst">{score:<span class="hljs-number">.4</span>f}</span>&quot;</span>)

<span class="hljs-comment"># ä¿å­˜å’ŒåŠ è½½æ¨¡å‹</span>
<span class="hljs-comment"># Save and load model</span>
<span class="hljs-comment"># custom_model.save(&quot;my_word2vec.model&quot;)</span>
<span class="hljs-comment"># loaded_model = Word2Vec.load(&quot;my_word2vec.model&quot;)</span>

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># æ€»ç»“ / Summary</span>
<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-string">&quot;&quot;&quot;
æœ¬ç¤ºä¾‹å±•ç¤ºäº† Word2Vec çš„å¸¸ç”¨æ“ä½œ:
This example demonstrates common Word2Vec operations:

1. åŠ è½½é¢„è®­ç»ƒæ¨¡å‹ / Loading pre-trained models
2. è·å–è¯å‘é‡ / Getting word vectors
3. è®¡ç®—è¯ç›¸ä¼¼åº¦ / Computing word similarity
4. æŸ¥æ‰¾ç›¸ä¼¼è¯ / Finding similar words
5. è¯ç±»æ¯”ä»»åŠ¡ / Word analogy tasks
6. æ‰¾å‡ºä¸åŒ¹é…è¯ / Finding odd one out
7. å¥å­ç›¸ä¼¼åº¦ï¼ˆè¯å‘é‡å¹³å‡ï¼‰/ Sentence similarity (averaging)
8. è®­ç»ƒè‡ªå®šä¹‰æ¨¡å‹ / Training custom models

åœ¨ LLM åº”ç”¨ä¸­ï¼ŒWord2Vec å¸¸ç”¨äº:
In LLM applications, Word2Vec is commonly used for:
- æ–‡æœ¬æ£€ç´¢ / Text retrieval
- æ¨èç³»ç»Ÿ / Recommendation systems
- æ–‡æœ¬åˆ†ç±»ç‰¹å¾ / Text classification features
- è¯­ä¹‰æœç´¢ / Semantic search
&quot;&quot;&quot;</span>
</code></pre></div></div><h2 class="subtopic-title">2.2 ä½ç½®åµŒå…¥ (Position Embedding)</h2><h1>Position Embedding ç§‘æ™®ç‰ˆ</h1>
<blockquote>
<p>é¢å‘é›¶åŸºç¡€è¯»è€…çš„ä½ç½®åµŒå…¥å…¥é—¨æŒ‡å—</p>
</blockquote>
<h2>ä¸€å¥è¯æ¦‚æ‹¬</h2>
<p><strong>ä½ç½®åµŒå…¥å°±æ˜¯ç»™æ¯ä¸ªä½ç½®ä¸€ä¸ª&quot;èº«ä»½è¯&quot;ï¼Œè®©æ¨¡å‹çŸ¥é“&quot;ä½ æ˜¯ç¬¬å‡ ä¸ªè¯&quot;ã€‚</strong></p>
<h2>ä»ä¸€ä¸ªé—®é¢˜å¼€å§‹</h2>
<p>çœ‹è¿™ä¸¤ä¸ªå¥å­ï¼š</p>
<ul>
<li>â€œçŒ«æŠ“è€é¼ â€</li>
<li>â€œè€é¼ æŠ“çŒ«â€</li>
</ul>
<p>è¯è¯­å®Œå…¨ä¸€æ ·ï¼Œä½†æ„æ€å®Œå…¨ç›¸åï¼åŒºåˆ«åªåœ¨äº<strong>é¡ºåº</strong>ã€‚</p>
<p>å¯¹äºè®¡ç®—æœºæ¥è¯´ï¼Œå¦‚æœåªçœ‹&quot;æœ‰å“ªäº›è¯&quot;è€Œä¸çœ‹&quot;é¡ºåº&quot;ï¼Œè¿™ä¸¤ä¸ªå¥å­å°±æ˜¯ä¸€æ ·çš„ã€‚</p>
<p><strong>ä½ç½®åµŒå…¥å°±æ˜¯è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼šè®©æ¨¡å‹çŸ¥é“æ¯ä¸ªè¯åœ¨å¥å­ä¸­çš„ä½ç½®ã€‚</strong></p>
<h2>ä¸ºä»€ä¹ˆéœ€è¦ä½ç½®ä¿¡æ¯ï¼Ÿ</h2>
<h3>RNN çš„æ–¹å¼</h3>
<p>æ—©æœŸçš„æ¨¡å‹ï¼ˆå¦‚ RNNï¼‰æ˜¯<strong>æŒ‰é¡ºåº</strong>å¤„ç†å¥å­çš„ï¼š</p>
<ul>
<li>å…ˆçœ‹&quot;çŒ«&quot;ï¼Œè®°ä½å®ƒ</li>
<li>å†çœ‹&quot;æŠ“&quot;ï¼Œç»“åˆä¹‹å‰çš„ä¿¡æ¯</li>
<li>æœ€åçœ‹&quot;è€é¼ &quot;</li>
</ul>
<p>å› ä¸ºæ˜¯ä¸€æ­¥æ­¥æ¥çš„ï¼Œæ‰€ä»¥å¤©ç„¶çŸ¥é“é¡ºåºã€‚</p>
<h3>Transformer çš„æ–¹å¼</h3>
<p>Transformer ä¸æŒ‰é¡ºåºæ¥ï¼Œè€Œæ˜¯<strong>åŒæ—¶çœ‹æ‰€æœ‰è¯</strong>ï¼</p>
<p>è¿™å°±åƒæŠŠå¥å­é‡Œçš„è¯å…¨éƒ½æ‘Šåœ¨æ¡Œå­ä¸Šï¼Œä¸€èµ·çœ‹ã€‚å¥½å¤„æ˜¯é€Ÿåº¦å¿«ï¼Œåå¤„æ˜¯ä¸çŸ¥é“è°åœ¨å‰è°åœ¨åã€‚</p>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦<strong>é¢å¤–å‘Šè¯‰æ¨¡å‹æ¯ä¸ªè¯çš„ä½ç½®</strong>ã€‚</p>
<h2>æ ¸å¿ƒæ€æƒ³ï¼šç»™ä½ç½®ç¼–ç </h2>
<p>å°±åƒè¯åµŒå…¥æŠŠè¯å˜æˆæ•°å­—ï¼Œä½ç½®åµŒå…¥æŠŠ&quot;ç¬¬1ä¸ªä½ç½®&quot;ã€&quot;ç¬¬2ä¸ªä½ç½®&quot;å˜æˆæ•°å­—ã€‚</p>
<p>æœ€ç®€å•çš„æ–¹æ³•ï¼š</p>
<table>
<thead>
<tr>
<th>ä½ç½®</th>
<th>ç¼–ç </th>
</tr>
</thead>
<tbody>
<tr>
<td>ç¬¬1ä¸ª</td>
<td>[1, 0, 0, 0]</td>
</tr>
<tr>
<td>ç¬¬2ä¸ª</td>
<td>[0, 1, 0, 0]</td>
</tr>
<tr>
<td>ç¬¬3ä¸ª</td>
<td>[0, 0, 1, 0]</td>
</tr>
<tr>
<td>ç¬¬4ä¸ª</td>
<td>[0, 0, 0, 1]</td>
</tr>
</tbody>
</table>
<p><strong>é—®é¢˜</strong>ï¼šè¿™ç§ç¼–ç å¤ª&quot;ç¡¬&quot;äº†ï¼Œç¬¬1ä¸ªä½ç½®å’Œç¬¬2ä¸ªä½ç½®çœ‹èµ·æ¥æ¯«æ— å…³ç³»ã€‚</p>
<h2>æ›´å¥½çš„æ–¹æ³•ï¼šæ­£å¼¦æ³¢ç¼–ç </h2>
<p>Transformer çš„ä½œè€…å‘æ˜äº†ä¸€ç§å·§å¦™çš„æ–¹æ³•ï¼šç”¨<strong>æ³¢æµª</strong>æ¥ç¼–ç ä½ç½®ï¼</p>
<p>æƒ³è±¡ä¸åŒé¢‘ç‡çš„æ­£å¼¦æ³¢ï¼š</p>
<pre class="hljs"><code>ä½ç½®1: ğŸŒŠ~~~~~~ (ä½é¢‘æ³¢)
ä½ç½®1: ~ğŸŒŠ~~~~~ (ä¸­é¢‘æ³¢)
ä½ç½®1: ~~ğŸŒŠ~~~~ (é«˜é¢‘æ³¢)

ä½ç½®2: ğŸŒŠ~~~~~~ (ä½é¢‘æ³¢ï¼Œç¨å¾®ç§»åŠ¨)
ä½ç½®2: ~ğŸŒŠ~~~~~ (ä¸­é¢‘æ³¢ï¼Œç§»åŠ¨æ›´å¤š)
ä½ç½®2: ~~ğŸŒŠ~~~~ (é«˜é¢‘æ³¢ï¼Œç§»åŠ¨æœ€å¤š)
</code></pre>
<p>æ¯ä¸ªä½ç½®éƒ½æœ‰ä¸€ç»„ç‹¬ç‰¹çš„æ³¢æµªå€¼ï¼Œè€Œä¸”ç›¸é‚»ä½ç½®çš„æ³¢æµªå€¼ä¹Ÿç›¸è¿‘ï¼</p>
<h2>ä¸€ä¸ªå½¢è±¡çš„æ¯”å–»</h2>
<p>æƒ³è±¡ä½ åœ¨ç»™ä¸€æ’åº§ä½ç¼–å·ï¼š</p>
<ul>
<li><strong>ç®€å•ç¼–å·</strong>ï¼š1å·åº§ã€2å·åº§ã€3å·åº§â€¦ ï¼ˆä½ç½®ç¼–ç ï¼‰</li>
<li><strong>æ­£å¼¦æ³¢ç¼–ç </strong>ï¼šç”¨å¤šç§é¢œè‰²çš„ç¯å…‰ç»„åˆï¼Œæ¯ä¸ªåº§ä½çš„å…‰çº¿ç»„åˆéƒ½ä¸åŒ</li>
</ul>
<p>æ­£å¼¦æ³¢çš„å¥½å¤„æ˜¯ï¼š</p>
<ol>
<li>æ¯ä¸ªä½ç½®éƒ½æœ‰ç‹¬ç‰¹çš„&quot;å…‰çº¿æŒ‡çº¹&quot;</li>
<li>ç›¸é‚»åº§ä½çš„å…‰çº¿ç›¸è¿‘</li>
<li>å¯ä»¥æ¨ç®—å‡ºä»»æ„ä½ç½®çš„&quot;å…‰çº¿&quot;ï¼ˆå³ä½¿è®­ç»ƒæ—¶æ²¡è§è¿‡ï¼‰</li>
</ol>
<h2>æ€ä¹ˆä½¿ç”¨ä½ç½®åµŒå…¥ï¼Ÿ</h2>
<pre class="hljs"><code>æœ€ç»ˆè¾“å…¥ = è¯åµŒå…¥ + ä½ç½®åµŒå…¥
</code></pre>
<p>å°±åƒç»™æ¯ä¸ªè¯è´´ä¸Šäº†ä¸€ä¸ª&quot;ä½ç½®æ ‡ç­¾&quot;ï¼š</p>
<ul>
<li>â€œçŒ«â€ï¼ˆç¬¬1ä¸ªï¼‰= [&quot;çŒ«&quot;çš„å«ä¹‰] + [&quot;ç¬¬1ä¸ªä½ç½®&quot;çš„æ ‡ç­¾]</li>
<li>â€œæŠ“â€ï¼ˆç¬¬2ä¸ªï¼‰= [&quot;æŠ“&quot;çš„å«ä¹‰] + [&quot;ç¬¬2ä¸ªä½ç½®&quot;çš„æ ‡ç­¾]</li>
<li>â€œè€é¼ â€ï¼ˆç¬¬3ä¸ªï¼‰= [&quot;è€é¼ &quot;çš„å«ä¹‰] + [&quot;ç¬¬3ä¸ªä½ç½®&quot;çš„æ ‡ç­¾]</li>
</ul>
<h2>ä¸¤ç§ä½ç½®åµŒå…¥</h2>
<table>
<thead>
<tr>
<th>ç±»å‹</th>
<th>ç‰¹ç‚¹</th>
<th>ä»£è¡¨æ¨¡å‹</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ­£å¼¦æ³¢ç¼–ç </td>
<td>å›ºå®šå…¬å¼ï¼Œä¸å¯å­¦ä¹ </td>
<td>åŸå§‹ Transformer</td>
</tr>
<tr>
<td>å¯å­¦ä¹ ä½ç½®åµŒå…¥</td>
<td>åƒè¯åµŒå…¥ä¸€æ ·å­¦ä¹ </td>
<td>BERTã€GPT</td>
</tr>
</tbody>
</table>
<h2>æ€»ç»“</h2>
<table>
<thead>
<tr>
<th>æ¦‚å¿µ</th>
<th>é€šä¿—ç†è§£</th>
</tr>
</thead>
<tbody>
<tr>
<td>ä½ç½®åµŒå…¥</td>
<td>ç»™ä½ç½®è´´æ ‡ç­¾</td>
</tr>
<tr>
<td>æ­£å¼¦æ³¢ç¼–ç </td>
<td>ç”¨æ³¢æµªç»™ä½ç½®ç¼–ç </td>
</tr>
<tr>
<td>æœ€ç»ˆè¾“å…¥</td>
<td>è¯çš„å«ä¹‰ + ä½ç½®æ ‡ç­¾</td>
</tr>
</tbody>
</table>
<h2>ä¸‹ä¸€æ­¥</h2>
<ul>
<li>æƒ³äº†è§£æ•°å­¦åŸç†ï¼Ÿé˜…è¯» <a href="advanced-guide.md">æ·±å…¥ç‰ˆ</a></li>
<li>æƒ³çœ‹ä»£ç å®ç°ï¼ŸæŸ¥çœ‹ <code>examples/</code> ç›®å½•</li>
</ul>
<h1>Position Embedding æ·±å…¥ç‰ˆ</h1>
<blockquote>
<p>é¢å‘æœ‰æœºå™¨å­¦ä¹ åŸºç¡€è¯»è€…çš„æŠ€æœ¯è¯¦è§£</p>
</blockquote>
<h2>æ¦‚è¿°</h2>
<p>ä½ç½®åµŒå…¥ï¼ˆPosition Embedding/Encodingï¼‰æ˜¯ä¸ºåºåˆ—ä¸­æ¯ä¸ªä½ç½®ç”Ÿæˆå”¯ä¸€è¡¨ç¤ºçš„æŠ€æœ¯ï¼Œä½¿ä¸å…·å¤‡é€’å½’ç»“æ„çš„æ¨¡å‹ï¼ˆå¦‚ Transformerï¼‰èƒ½å¤Ÿæ•æ‰åºåˆ—é¡ºåºä¿¡æ¯ã€‚</p>
<h2>ä¸ºä»€ä¹ˆéœ€è¦ä½ç½®ä¿¡æ¯ï¼Ÿ</h2>
<p>Transformer çš„è‡ªæ³¨æ„åŠ›æœºåˆ¶æ˜¯<strong>ç½®æ¢ä¸å˜çš„</strong>ï¼ˆpermutation invariantï¼‰ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Attention</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4684em;vertical-align:-0.95em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.2528em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span></p>
<p><a id="formula-position-embedding-1"></a>
<a href="#formula-position-embedding-1-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šæ³¨æ„åŠ›çš„è¾“å‡ºåªä¾èµ– Qã€Kã€V çš„å€¼ï¼Œä¸åºåˆ—é¡ºåºæ— å…³ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span> ä¸ºæŸ¥è¯¢ã€é”®ã€å€¼çŸ©é˜µï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºé”®ç»´åº¦ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šæ‰“ä¹±è¾“å…¥é¡ºåºåªæ”¹å˜è¾“å‡ºé¡ºåºï¼Œä¸æ”¹å˜å†…å®¹ï¼›å› æ­¤éœ€è¦é¢å¤–æ³¨å…¥ä½ç½®ä¿¡æ¯ã€‚</li>
</ul>
<p>å¯¹äºè¾“å…¥åºåˆ—çš„ä»»æ„æ’åˆ—ï¼Œæ³¨æ„åŠ›æœºï¿½ï¿½çš„è¾“å‡ºåªæ˜¯å¯¹åº”æ’åˆ—ï¼Œæ— æ³•åŒºåˆ†é¡ºåºã€‚å› æ­¤éœ€è¦æ˜¾å¼æ³¨å…¥ä½ç½®ä¿¡æ¯ã€‚</p>
<h2>Sinusoidal Position Encoding</h2>
<p>åŸå§‹ Transformer è®ºæ–‡æå‡ºçš„æ­£å¼¦ä½ç½®ç¼–ç ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0385em;vertical-align:-0.3552em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">os</span><span class="mpunct mtight">,</span><span class="mord mtight">2</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.854em;vertical-align:-0.704em;"></span><span class="mop">sin</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size2">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em;"><span style="top:-2.296em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1000</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.814em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight">i</span><span class="mord mtight">/</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="mord mathnormal">os</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.704em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size2">)</span></span></span></span></span></span></span></p>
<p><a id="formula-position-embedding-2"></a>
<a href="#formula-position-embedding-2-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0385em;vertical-align:-0.3552em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">os</span><span class="mpunct mtight">,</span><span class="mord mtight">2</span><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.854em;vertical-align:-0.704em;"></span><span class="mop">cos</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size2">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em;"><span style="top:-2.296em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1000</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.814em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight">i</span><span class="mord mtight">/</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="mord mathnormal">os</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.704em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size2">)</span></span></span></span></span></span></span></p>
<p><a id="formula-position-embedding-3"></a>
<a href="#formula-position-embedding-3-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šå¶æ•°ç»´åº¦ç”¨æ­£å¼¦ã€å¥‡æ•°ç»´åº¦ç”¨ä½™å¼¦ç¼–ç ä½ç½®ä¿¡æ¯ï¼Œä¸åŒç»´åº¦ä½¿ç”¨ä¸åŒé¢‘ç‡ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">os</span></span></span></span> ä¸ºä½ç½®ç´¢å¼•ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> ä¸ºç»´åº¦ç´¢å¼•ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºåµŒå…¥ç»´åº¦ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">10000</span></span></span></span> ä¸ºåº•æ•°æ§åˆ¶é¢‘ç‡èŒƒå›´ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šæ¯ä¸ªä½ç½®æœ‰å”¯ä¸€ç¼–ç ï¼›ä½ç»´æ•æ‰å±€éƒ¨ä½ç½®ï¼Œé«˜ç»´æ•æ‰å…¨å±€ä½ç½®ï¼›å¯å¤–æ¨åˆ°è®­ç»ƒæœªè§é•¿åº¦ã€‚</li>
</ul>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">os</span></span></span></span> æ˜¯ä½ç½®ç´¢å¼•</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> æ˜¯ç»´åº¦ç´¢å¼•</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> æ˜¯åµŒå…¥ç»´åº¦</li>
</ul>
<h3>è®¾è®¡åŠ¨æœº</h3>
<h4>1. å”¯ä¸€æ€§</h4>
<p>æ¯ä¸ªä½ç½®éƒ½æœ‰å”¯ä¸€çš„ç¼–ç è¡¨ç¤ºã€‚</p>
<h4>2. æœ‰ç•Œæ€§</h4>
<p>æ‰€æœ‰å€¼éƒ½åœ¨ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">âˆ’</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span> èŒƒå›´å†…ã€‚</p>
<h4>3. ç›¸å¯¹ä½ç½®å…³ç³»</h4>
<p>å¯¹äºä»»æ„å›ºå®šåç§» <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span>ï¼Œ<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">os</span><span class="mbin mtight">+</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> å¯ä»¥è¡¨ç¤ºä¸º <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">os</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> çš„çº¿æ€§å‡½æ•°ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">sin</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">sin</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">cos</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">cos</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">sin</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span></span></span></span></span></p>
<p><a id="formula-position-embedding-4"></a>
<a href="#formula-position-embedding-4-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šæ­£å¼¦å‡½æ•°çš„åŠ æ³•å…¬å¼è¡¨æ˜ä½ç½® <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">os</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> çš„ç¼–ç å¯ç”±ä½ç½® <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">os</span></span></span></span> çš„ç¼–ç çº¿æ€§å˜æ¢å¾—åˆ°ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> ä¸ºå½“å‰ä½ç½®ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> ä¸ºåç§»é‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">cos</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">sin</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span></span></span></span> ä¸ºå›ºå®šå¸¸æ•°ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šæ¨¡å‹å¯é€šè¿‡å­¦ä¹ çº¿æ€§å˜æ¢æ¥&quot;è®¡ç®—&quot;ç›¸å¯¹ä½ç½®å…³ç³»ï¼Œæ— éœ€æ˜¾å¼ç¼–ç æ‰€æœ‰ä½ç½®å¯¹ã€‚</li>
</ul>
<p>è¿™å…è®¸æ¨¡å‹é€šè¿‡çº¿æ€§å˜æ¢å­¦ä¹ ç›¸å¯¹ä½ç½®å…³ç³»ã€‚</p>
<h4>4. å¤–æ¨èƒ½åŠ›</h4>
<p>ç†è®ºä¸Šå¯ä»¥å¤„ç†ä»»æ„é•¿åº¦çš„åºåˆ—ï¼ˆè™½ç„¶å®è·µä¸­æ•ˆæœä¼šä¸‹é™ï¼‰ã€‚</p>
<h3>é¢‘ç‡åˆ†æ</h3>
<p>æ³¢é•¿éšç»´åº¦å˜åŒ–ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">Î»</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.03588em;">Ï€</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.938em;"></span><span class="mord">1000</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight">i</span><span class="mord mtight">/</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><a id="formula-position-embedding-5"></a>
<a href="#formula-position-embedding-5-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li>
<p><strong>å…¬å¼å«ä¹‰</strong>ï¼šä¸åŒç»´åº¦çš„æ­£å¼¦æ³¢æœ‰ä¸åŒçš„å‘¨æœŸ/æ³¢é•¿ã€‚</p>
</li>
<li>
<p><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">Î»</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºç¬¬ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> ç»´çš„æ³¢é•¿ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.03588em;">Ï€</span></span></span></span> ä¸ºæ­£å¼¦å‘¨æœŸç³»æ•°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.888em;"></span><span class="mord">1000</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight">i</span><span class="mord mtight">/</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> æ§åˆ¶æ³¢é•¿å¢é•¿é€Ÿåº¦ã€‚</p>
</li>
<li>
<p><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šä½ç»´åº¦æ³¢é•¿çŸ­ï¼ˆæ•æ„Ÿäºä½ç½®å˜åŒ–ï¼‰ï¼Œé«˜ç»´åº¦æ³¢é•¿å¤§ï¼ˆæ•æ‰è¿œè·ç¦»å…³ç³»ï¼‰ã€‚</p>
</li>
<li>
<p>ä½ç»´åº¦ï¼šçŸ­æ³¢é•¿ï¼Œæ•æ‰å±€éƒ¨ä½ç½®å·®å¼‚</p>
</li>
<li>
<p>é«˜ç»´åº¦ï¼šé•¿æ³¢é•¿ï¼Œæ•æ‰å…¨å±€ä½ç½®æ¨¡å¼</p>
</li>
</ul>
<h2>Learnable Position Embedding</h2>
<p>BERTã€GPT ç­‰æ¨¡å‹ä½¿ç”¨å¯å­¦ä¹ çš„ä½ç½®åµŒå…¥ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">ina</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">or</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">os</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p><a id="formula-position-embedding-6"></a>
<a href="#formula-position-embedding-6-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šå°†è¯åµŒå…¥ä¸ä½ç½®åµŒå…¥ç›¸åŠ å¾—åˆ°æœ€ç»ˆè¾“å…¥è¡¨ç¤ºã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">or</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºè¯åµŒå…¥ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">os</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºå¯å­¦ä¹ çš„ä½ç½®åµŒå…¥ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">L</span></span></span></span> ä¸ºæœ€å¤§åºåˆ—é•¿åº¦ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span> ä¸ºç»´åº¦ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šï¿½ï¿½ç½®åµŒå…¥ä½œä¸ºå‚æ•°å­¦ä¹ ï¼Œèƒ½è‡ªé€‚åº”æ•°æ®åˆ†å¸ƒï¼Œä½†é•¿åº¦å—é™äºè®­ç»ƒæ—¶çš„æœ€å¤§é•¿åº¦ã€‚</li>
</ul>
<p>å…¶ä¸­ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">os</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="mbin mtight">Ã—</span><span class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span></span></span></span></span> æ˜¯å¯å­¦ä¹ çš„å‚æ•°çŸ©é˜µã€‚</p>
<h3>ä¼˜ç¼ºç‚¹</h3>
<table>
<thead>
<tr>
<th>æ–¹é¢</th>
<th>Sinusoidal</th>
<th>Learnable</th>
</tr>
</thead>
<tbody>
<tr>
<td>çµæ´»æ€§</td>
<td>å›ºå®š</td>
<td>å¯é€‚åº”æ•°æ®</td>
</tr>
<tr>
<td>å¤–æ¨èƒ½åŠ›</td>
<td>ç†è®ºæ— é™</td>
<td>å—é™äºè®­ç»ƒé•¿åº¦</td>
</tr>
<tr>
<td>å‚æ•°é‡</td>
<td>0</td>
<td><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span></td>
</tr>
</tbody>
</table>
<h2>ç›¸å¯¹ä½ç½®ç¼–ç </h2>
<p>ç»å¯¹ä½ç½®ç¼–ç æœ‰ä¸€äº›é—®é¢˜ï¼š</p>
<ul>
<li>é•¿åº¦æ³›åŒ–èƒ½åŠ›å·®</li>
<li>æ— æ³•å¾ˆå¥½åœ°æ•æ‰ç›¸å¯¹è·ç¦»</li>
</ul>
<h3>Shawâ€™s Relative Position Encoding</h3>
<p>åœ¨æ³¨æ„åŠ›è®¡ç®—ä¸­å¼•å…¥ç›¸å¯¹ä½ç½®ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.5561em;vertical-align:-0.93em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6261em;"><span style="top:-2.2528em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.7848em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3948em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><a id="formula-position-embedding-7"></a>
<a href="#formula-position-embedding-7-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šåœ¨é”®å‘é‡ä¸ŠåŠ ä¸Šç›¸å¯¹ä½ç½®ç¼–ç  <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2361em;vertical-align:-0.3948em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3948em;"><span></span></span></span></span></span></span></span></span></span>ï¼Œè®©æ³¨æ„åŠ›è€ƒè™‘ä½ç½®å…³ç³»ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºä½ç½® <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span> çš„è¾“å…¥ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0358em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span></span></span></span></span></span></span> ä¸ºæŠ•å½±çŸ©é˜µï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2361em;vertical-align:-0.3948em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3948em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºç›¸å¯¹ä½ç½® <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7429em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span> çš„ç¼–ç ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šæ³¨æ„åŠ›åˆ†æ•°ä¸ä»…ä¾èµ–å†…å®¹ç›¸ä¼¼åº¦ï¼Œè¿˜ä¾èµ–ç›¸å¯¹ä½ç½®å…³ç³»ã€‚</li>
</ul>
<p>å…¶ä¸­ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2361em;vertical-align:-0.3948em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3948em;"><span></span></span></span></span></span></span></span></span></span> æ˜¯ä½ç½® <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> å’Œ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span> ä¹‹é—´çš„ç›¸å¯¹ä½ç½®ç¼–ç ã€‚</p>
<h3>T5 Bias</h3>
<p>T5 æ¨¡å‹ç›´æ¥åœ¨æ³¨æ„åŠ›åˆ†æ•°ä¸Šæ·»åŠ å¯å­¦ä¹ çš„ç›¸å¯¹ä½ç½®åç½®ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Attention</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4684em;vertical-align:-0.95em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.2528em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span></p>
<p><a id="formula-position-embedding-8"></a>
<a href="#formula-position-embedding-8-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šåœ¨æ³¨æ„åŠ›åˆ†æ•°ä¸ŠåŠ ä¸€ä¸ªç›¸å¯¹ä½ç½®åç½®çŸ©é˜µ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span>ï¼Œå† softmaxã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1072em;vertical-align:-0.25em;"></span><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mord">/</span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span></span></span></span></span></span></span></span></span> ä¸ºå†…å®¹åˆ†æ•°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> ä¸ºç›¸å¯¹ä½ç½®åç½®çŸ©é˜µï¼ˆ<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> ä¾èµ– <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7429em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span>ï¼‰ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šç®€å•ç›´æ¥åœ°è®©æ¨¡å‹å­¦ä¹ &quot;è·ç¦»è¶Šè¿œ/è¿‘&quot;åº”è¯¥å¦‚ä½•å½±å“æ³¨æ„åŠ›ã€‚</li>
</ul>
<p>å…¶ä¸­ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> æ˜¯ç›¸å¯¹ä½ç½®åç½®çŸ©é˜µã€‚</p>
<h3>RoPE (Rotary Position Embedding)</h3>
<p>RoPE é€šè¿‡æ—‹è½¬çŸ©é˜µå°†ä½ç½®ä¿¡æ¯æ³¨å…¥æ³¨æ„åŠ›ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">RoPE</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">m</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">(</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6548em;"><span style="top:-3.6548em;"><span class="pstrut" style="height:3.0448em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.5834em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1166em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.0448em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.5834em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">2</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1166em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.1548em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size4">)</span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âŠ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop">cos</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="mclose">)</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop">sin</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="mclose">)</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span></span></span></span></span></p>
<p><a id="formula-position-embedding-9"></a>
<a href="#formula-position-embedding-9-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šå¯¹å‘é‡æ¯ä¸¤ç»´ä¸€ç»„ï¼Œä¹˜ä»¥ä½ç½® <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span> å¯¹åº”çš„æ—‹è½¬è§’åº¦çš„æ­£å¼¦ä½™å¼¦ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2392em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.5834em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1166em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.5834em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">2</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1166em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºç¬¬ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span> ä¸ªä½ç½®çš„å‘é‡åˆ†é‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">m</span><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span></span></span></span> ä¸ºæ—‹è½¬è§’åº¦ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord">âŠ—</span></span></span></span> ä¸ºé€å…ƒç´ ä¹˜ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šä½ç½®ä¿¡æ¯é€šè¿‡æ—‹è½¬è§’åº¦æ³¨å…¥ï¼Œç›¸å¯¹ä½ç½®ç›¸åŒåˆ™å†…ç§¯ä¹Ÿç›¸åŒã€‚</li>
</ul>
<p>æ ¸å¿ƒæ€§è´¨ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">âŸ¨</span><span class="mord text"><span class="mord">RoPE</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">m</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord">RoPE</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">n</span><span class="mclose">)âŸ©</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Re</span></span><span class="mopen">[âŸ¨</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">âŸ©</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">m</span><span class="mbin mtight">âˆ’</span><span class="mord mathnormal mtight">n</span><span class="mclose mtight">)</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">Î¸</span></span></span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span></span></p>
<p><a id="formula-position-embedding-10"></a>
<a href="#formula-position-embedding-10-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šä¸¤ä¸ªä½ç½®çš„ RoPE ç¼–ç çš„å†…ç§¯åªä¾èµ–å®ƒä»¬çš„ç›¸å¯¹ä½ç½® <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span>ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">âŸ¨</span><span class="mord">â‹…</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">â‹…</span><span class="mclose">âŸ©</span></span></span></span> ä¸ºå†…ç§¯ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.888em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">m</span><span class="mbin mtight">âˆ’</span><span class="mord mathnormal mtight">n</span><span class="mclose mtight">)</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">Î¸</span></span></span></span></span></span></span></span></span></span></span></span> ä¸ºå¤æŒ‡æ•°å½¢å¼è¡¨ç¤ºç›¸å¯¹ä½ç½®æ—‹è½¬ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šæ— è®ºç»å¯¹ä½ç½®åœ¨å“ªï¼Œåªè¦ç›¸å¯¹è·ç¦»ç›¸åŒï¼Œæ³¨æ„åŠ›åˆ†æ•°çš„ç»“æ„å°±ç›¸åŒã€‚</li>
</ul>
<p>æ³¨æ„åŠ›åˆ†æ•°åªä¾èµ–äºç›¸å¯¹ä½ç½® <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span>ã€‚</p>
<h3>ALiBi (Attention with Linear Biases)</h3>
<p>ALiBi åœ¨æ³¨æ„åŠ›åˆ†æ•°ä¸Šæ·»åŠ çº¿æ€§é€’å‡çš„åç½®ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord text"><span class="mord">score</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.4445em;"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">âˆ£</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mord">âˆ£</span></span></span></span></span></p>
<p><a id="formula-position-embedding-11"></a>
<a href="#formula-position-embedding-11-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šåœ¨å†…å®¹åˆ†æ•°ä¸Šå‡å»ä¸è·ç¦»æˆæ­£æ¯”çš„æƒ©ç½šé¡¹ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºå†…å®¹åˆ†æ•°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span> ä¸ºæ¯ä¸ªå¤´çš„æ–œç‡ï¼ˆæ§åˆ¶è·ç¦»è¡°å‡é€Ÿåº¦ï¼‰ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">âˆ£</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mord">âˆ£</span></span></span></span> ä¸ºç»å¯¹è·ç¦»ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šè·ç¦»è¶Šè¿œæƒ©ç½šè¶Šå¤§ï¼Œæ¨¡å‹è‡ªç„¶åå¥½å…³æ³¨è¿‘å¤„ï¼›æ— å‚æ•°ä¸”å¤–æ¨èƒ½åŠ›å¼ºã€‚</li>
</ul>
<p>å…¶ä¸­ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span> æ˜¯æ¯ä¸ªæ³¨æ„åŠ›å¤´ç‰¹å®šçš„æ–œç‡å‚æ•°ã€‚</p>
<h2>ä½ç½®ç¼–ç çš„é€‰æ‹©</h2>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>ä»£è¡¨æ¨¡å‹</th>
<th>ä¼˜ç‚¹</th>
<th>ç¼ºç‚¹</th>
</tr>
</thead>
<tbody>
<tr>
<td>Sinusoidal</td>
<td>åŸå§‹ Transformer</td>
<td>æ— å‚æ•°ï¼Œå¯å¤–æ¨</td>
<td>çµæ´»æ€§å·®</td>
</tr>
<tr>
<td>Learnable</td>
<td>BERT, GPT</td>
<td>ç®€å•æœ‰æ•ˆ</td>
<td>é•¿åº¦å—é™</td>
</tr>
<tr>
<td>RoPE</td>
<td>LLaMA, PaLM</td>
<td>ç›¸å¯¹ä½ç½®ï¼Œé•¿åº¦æ³›åŒ–</td>
<td>å®ç°å¤æ‚</td>
</tr>
<tr>
<td>ALiBi</td>
<td>BLOOM</td>
<td>ç®€å•ï¼Œé•¿åº¦æ³›åŒ–å¥½</td>
<td>ç»å¯¹ä½ç½®ä¿¡æ¯å¼±</td>
</tr>
</tbody>
</table>
<h2>ä»£ç ç¤ºä¾‹</h2>
<p>å‚è§ <code>examples/</code> ç›®å½•ã€‚</p>
<h2>å‚è€ƒæ–‡çŒ®</h2>
<ol>
<li>Vaswani et al. (2017). <em>Attention Is All You Need</em></li>
<li>Shaw et al. (2018). <em>Self-Attention with Relative Position Representations</em></li>
<li>Raffel et al. (2020). <em>Exploring the Limits of Transfer Learning with a Unified Text-to-Text Transformer</em></li>
<li>Su et al. (2021). <em>RoFormer: Enhanced Transformer with Rotary Position Embedding</em></li>
<li>Press et al. (2021). <em>Train Short, Test Long: Attention with Linear Biases Enables Input Length Extrapolation</em></li>
</ol>
<div class="code-appendix page-break"><h2>é™„å½•ï¼šä»£ç ç¤ºä¾‹</h2><div class="code-file"><h3>rope_example.py</h3><pre class="hljs"><code><span class="hljs-string">&quot;&quot;&quot;
RoPE (Rotary Position Embedding) ç¤ºä¾‹ä»£ç 
==========================================

æœ¬ç¤ºä¾‹å±•ç¤ºæ—‹è½¬ä½ç½®ç¼–ç  (RoPE) çš„å®ç°ï¼Œè¿™æ˜¯ç°ä»£ LLM (å¦‚ LLaMA, PaLM) ä¸­å¹¿æ³›ä½¿ç”¨ï¿½ï¿½ä½ç½®ç¼–ç æ–¹æ³•ã€‚
This example demonstrates the implementation of Rotary Position Embedding (RoPE),
widely used in modern LLMs like LLaMA and PaLM.

è®ºæ–‡ / Paper: RoFormer: Enhanced Transformer with Rotary Position Embedding (Su et al., 2021)

RoPE çš„æ ¸å¿ƒæ€æƒ³æ˜¯é€šè¿‡æ—‹è½¬çŸ©é˜µå°†ä½ç½®ä¿¡æ¯æ³¨å…¥æ³¨æ„åŠ›è®¡ç®—ä¸­ã€‚
The core idea of RoPE is to inject positional information into attention computation
through rotation matrices.

å…³é”®ä¼˜åŠ¿ / Key Advantages:
1. ç›¸å¯¹ä½ç½®ç¼–ç ï¼šæ³¨æ„åŠ›åªä¾èµ–äºç›¸å¯¹ä½ç½® / Relative position encoding
2. é•¿åº¦å¤–æ¨ï¼šå¯ä»¥å¤„ç†æ¯”è®­ç»ƒæ—¶æ›´é•¿çš„åºåˆ— / Length extrapolation
3. æ— é¢å¤–å‚æ•°ï¼šä¸éœ€è¦å¯å­¦ä¹ çš„ä½ç½®åµŒå…¥ / No additional parameters

ä¾èµ–å®‰è£… / Dependencies:
    pip install torch numpy
&quot;&quot;&quot;</span>

<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn
<span class="hljs-keyword">import</span> math
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Optional</span>, <span class="hljs-type">Tuple</span>

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 1. RoPE åŸºç¡€å®ç° / Basic RoPE Implementation</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">precompute_freqs_cis</span>(<span class="hljs-params">dim: <span class="hljs-built_in">int</span>, max_seq_len: <span class="hljs-built_in">int</span>, theta: <span class="hljs-built_in">float</span> = <span class="hljs-number">10000.0</span></span>) -&gt; torch.Tensor:
    <span class="hljs-string">&quot;&quot;&quot;
    é¢„è®¡ç®— RoPE çš„å¤æ•°é¢‘ç‡ / Precompute complex frequencies for RoPE

    RoPE ä½¿ç”¨å¤æ•°åŸŸä¸­çš„æ—‹è½¬æ¥ç¼–ç ä½ç½®:
    RoPE encodes position through rotation in the complex domain:

        f(Î¸) = e^(iÎ¸) = cos(Î¸) + i*sin(Î¸)

    å‚æ•° / Args:
        dim: åµŒå…¥ç»´åº¦ï¼ˆå¿…é¡»æ˜¯å¶æ•°ï¼‰/ Embedding dimension (must be even)
        max_seq_len: æœ€å¤§åºåˆ—é•¿åº¦ / Maximum sequence length
        theta: åŸºç¡€é¢‘ç‡ï¼ˆé»˜è®¤ 10000ï¼‰/ Base frequency (default 10000)

    è¿”å› / Returns:
        å¤æ•°é¢‘ç‡å¼ é‡ (max_seq_len, dim//2) / Complex frequency tensor
    &quot;&quot;&quot;</span>
    <span class="hljs-comment"># è®¡ç®—æ¯ä¸ªç»´åº¦çš„é¢‘ç‡ / Compute frequency for each dimension</span>
    <span class="hljs-comment"># freqs = 1 / (theta^(2i/d)) for i in [0, d/2)</span>
    freqs = <span class="hljs-number">1.0</span> / (theta ** (torch.arange(<span class="hljs-number">0</span>, dim, <span class="hljs-number">2</span>).<span class="hljs-built_in">float</span>() / dim))

    <span class="hljs-comment"># åˆ›å»ºä½ç½®ç´¢å¼• / Create position indices</span>
    t = torch.arange(max_seq_len)

    <span class="hljs-comment"># å¤–ç§¯å¾—åˆ°æ¯ä¸ªä½ç½®æ¯ä¸ªç»´åº¦çš„è§’åº¦ / Outer product to get angle for each position and dimension</span>
    freqs = torch.outer(t, freqs)

    <span class="hljs-comment"># è½¬æ¢ä¸ºå¤æ•°å½¢å¼ e^(i*Î¸) = cos(Î¸) + i*sin(Î¸)</span>
    <span class="hljs-comment"># Convert to complex form e^(i*Î¸) = cos(Î¸) + i*sin(Î¸)</span>
    freqs_cis = torch.polar(torch.ones_like(freqs), freqs)

    <span class="hljs-keyword">return</span> freqs_cis


<span class="hljs-keyword">def</span> <span class="hljs-title function_">apply_rotary_emb</span>(<span class="hljs-params">
    xq: torch.Tensor,
    xk: torch.Tensor,
    freqs_cis: torch.Tensor
</span>) -&gt; <span class="hljs-type">Tuple</span>[torch.Tensor, torch.Tensor]:
    <span class="hljs-string">&quot;&quot;&quot;
    å¯¹ Query å’Œ Key åº”ç”¨æ—‹è½¬ä½ç½®ç¼–ç  / Apply rotary positional encoding to Query and Key

    è¿™æ˜¯ RoPE çš„æ ¸å¿ƒæ“ä½œã€‚å°† Query å’Œ Key å‘é‡è§†ä¸ºå¤æ•°ï¼Œä¹˜ä»¥ä½ç½®ç›¸å…³çš„æ—‹è½¬çŸ©é˜µã€‚
    This is the core operation of RoPE. Treat Query and Key vectors as complex numbers
    and multiply by position-dependent rotation matrices.

    å‚æ•° / Args:
        xq: Query å¼ é‡ (batch, seq_len, n_heads, head_dim)
        xk: Key å¼ é‡ (batch, seq_len, n_heads, head_dim)
        freqs_cis: é¢„è®¡ç®—çš„å¤æ•°é¢‘ç‡ (seq_len, head_dim//2)

    è¿”å› / Returns:
        æ—‹è½¬åçš„ Query å’Œ Key / Rotated Query and Key
    &quot;&quot;&quot;</span>
    <span class="hljs-comment"># å°†å®æ•°å‘é‡é‡å¡‘ä¸ºå¤æ•°å½¢å¼ / Reshape real vectors to complex form</span>
    <span class="hljs-comment"># (batch, seq_len, n_heads, head_dim) -&gt; (batch, seq_len, n_heads, head_dim//2, 2)</span>
    xq_ = torch.view_as_complex(xq.<span class="hljs-built_in">float</span>().reshape(*xq.shape[:-<span class="hljs-number">1</span>], -<span class="hljs-number">1</span>, <span class="hljs-number">2</span>))
    xk_ = torch.view_as_complex(xk.<span class="hljs-built_in">float</span>().reshape(*xk.shape[:-<span class="hljs-number">1</span>], -<span class="hljs-number">1</span>, <span class="hljs-number">2</span>))

    <span class="hljs-comment"># è·å–å½“å‰åºåˆ—é•¿åº¦çš„é¢‘ç‡ / Get frequencies for current sequence length</span>
    freqs_cis = freqs_cis[:xq.shape[<span class="hljs-number">1</span>]]

    <span class="hljs-comment"># å¤æ•°ä¹˜æ³•å®ç°æ—‹è½¬ / Complex multiplication implements rotation</span>
    <span class="hljs-comment"># freqs_cis éœ€è¦ broadcast åˆ° (batch, seq_len, n_heads, head_dim//2)</span>
    freqs_cis = freqs_cis.unsqueeze(<span class="hljs-number">0</span>).unsqueeze(<span class="hljs-number">2</span>)  <span class="hljs-comment"># (1, seq_len, 1, head_dim//2)</span>

    xq_out = torch.view_as_real(xq_ * freqs_cis).flatten(-<span class="hljs-number">2</span>)
    xk_out = torch.view_as_real(xk_ * freqs_cis).flatten(-<span class="hljs-number">2</span>)

    <span class="hljs-keyword">return</span> xq_out.type_as(xq), xk_out.type_as(xk)


<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 2. RoPE æ¨¡å—å°è£… / RoPE Module Wrapper</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">RotaryPositionalEmbedding</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;
    RoPE æ¨¡å— / RoPE Module

    å°è£…äº†é¢„è®¡ç®—é¢‘ç‡å’Œåº”ç”¨æ—‹è½¬ç¼–ç çš„åŠŸèƒ½
    Wraps precomputed frequencies and rotary encoding application
    &quot;&quot;&quot;</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, dim: <span class="hljs-built_in">int</span>, max_seq_len: <span class="hljs-built_in">int</span> = <span class="hljs-number">2048</span>, theta: <span class="hljs-built_in">float</span> = <span class="hljs-number">10000.0</span></span>):
        <span class="hljs-string">&quot;&quot;&quot;
        å‚æ•° / Args:
            dim: æ¯ä¸ªæ³¨æ„åŠ›å¤´çš„ç»´åº¦ / Dimension per attention head
            max_seq_len: æœ€å¤§åºåˆ—é•¿åº¦ / Maximum sequence length
            theta: åŸºç¡€é¢‘ç‡ / Base frequency
        &quot;&quot;&quot;</span>
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-variable language_">self</span>.dim = dim
        <span class="hljs-variable language_">self</span>.max_seq_len = max_seq_len
        <span class="hljs-variable language_">self</span>.theta = theta

        <span class="hljs-comment"># é¢„è®¡ç®—é¢‘ç‡å¹¶æ³¨å†Œä¸º buffer / Precompute frequencies and register as buffer</span>
        freqs_cis = precompute_freqs_cis(dim, max_seq_len, theta)
        <span class="hljs-variable language_">self</span>.register_buffer(<span class="hljs-string">&quot;freqs_cis&quot;</span>, freqs_cis)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, xq: torch.Tensor, xk: torch.Tensor</span>) -&gt; <span class="hljs-type">Tuple</span>[torch.Tensor, torch.Tensor]:
        <span class="hljs-string">&quot;&quot;&quot;
        åº”ç”¨æ—‹è½¬ä½ç½®ç¼–ç  / Apply rotary positional encoding

        å‚æ•° / Args:
            xq: Query å¼ é‡ / Query tensor
            xk: Key å¼ é‡ / Key tensor

        è¿”å› / Returns:
            æ—‹è½¬åçš„ Query å’Œ Key / Rotated Query and Key
        &quot;&quot;&quot;</span>
        <span class="hljs-keyword">return</span> apply_rotary_emb(xq, xk, <span class="hljs-variable language_">self</span>.freqs_cis)


<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 3. åŸºæœ¬ä½¿ç”¨ç¤ºä¾‹ / Basic Usage Example</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-comment"># æ¨¡å‹å‚æ•° / Model parameters</span>
batch_size = <span class="hljs-number">2</span>
seq_len = <span class="hljs-number">16</span>
n_heads = <span class="hljs-number">8</span>
head_dim = <span class="hljs-number">64</span>
d_model = n_heads * head_dim  <span class="hljs-comment"># 512</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;RoPE åŸºæœ¬ä½¿ç”¨ç¤ºä¾‹ / Basic RoPE Usage Example&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">60</span>)

<span class="hljs-comment"># åˆ›å»º RoPE æ¨¡å— / Create RoPE module</span>
rope = RotaryPositionalEmbedding(dim=head_dim, max_seq_len=<span class="hljs-number">2048</span>)

<span class="hljs-comment"># æ¨¡æ‹Ÿ Query å’Œ Key / Simulated Query and Key</span>
xq = torch.randn(batch_size, seq_len, n_heads, head_dim)
xk = torch.randn(batch_size, seq_len, n_heads, head_dim)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nè¾“å…¥å½¢çŠ¶ / Input shapes:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  Query: <span class="hljs-subst">{xq.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  Key: <span class="hljs-subst">{xk.shape}</span>&quot;</span>)

<span class="hljs-comment"># åº”ç”¨ RoPE / Apply RoPE</span>
xq_rotated, xk_rotated = rope(xq, xk)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nè¾“å‡ºå½¢çŠ¶ / Output shapes:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  Rotated Query: <span class="hljs-subst">{xq_rotated.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  Rotated Key: <span class="hljs-subst">{xk_rotated.shape}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 4. RoPE çš„æ•°å­¦åŸç† / Mathematical Principles of RoPE</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">explain_rope_math</span>():
    <span class="hljs-string">&quot;&quot;&quot;
    è§£é‡Š RoPE çš„æ•°å­¦åŸç† / Explain mathematical principles of RoPE
    &quot;&quot;&quot;</span>
    explanation = <span class="hljs-string">&quot;&quot;&quot;
    RoPE æ•°å­¦åŸç† / Mathematical Principles of RoPE
    ================================================

    1. å¤æ•°æ—‹è½¬ / Complex Rotation:
       å¯¹äº 2D å‘é‡ (x, y)ï¼Œå¯ä»¥è¡¨ç¤ºä¸ºå¤æ•° x + iy
       For a 2D vector (x, y), it can be represented as complex number x + iy

       æ—‹è½¬ Î¸ è§’åº¦åçš„å‘é‡:
       Vector after rotating by angle Î¸:
           (x&#x27;, y&#x27;) = (x*cos(Î¸) - y*sin(Î¸), x*sin(Î¸) + y*cos(Î¸))

       å¤æ•°å½¢å¼:
       Complex form:
           (x&#x27; + iy&#x27;) = (x + iy) * e^(iÎ¸) = (x + iy) * (cos(Î¸) + i*sin(Î¸))

    2. RoPE çš„ä½ç½®ç¼–ç  / Positional Encoding in RoPE:
       å¯¹äºä½ç½® m çš„ tokenï¼Œå…¶ Query/Key å‘é‡ x_m çš„ç¬¬ i ä¸ªç»´åº¦å¯¹ (2i, 2i+1):
       For token at position m, the i-th dimension pair (2i, 2i+1) of its Q/K vector x_m:

           Î¸_i = m / (base^(2i/d))

       æ—‹è½¬å:
       After rotation:
           x_m[2i]   = x_m[2i] * cos(Î¸_i) - x_m[2i+1] * sin(Î¸_i)
           x_m[2i+1] = x_m[2i] * sin(Î¸_i) + x_m[2i+1] * cos(Î¸_i)

    3. ç›¸å¯¹ä½ç½®ç‰¹æ€§ / Relative Position Property:
       ä¸¤ä¸ªä½ç½® m å’Œ n çš„ç‚¹ç§¯:
       Dot product between positions m and n:

           &lt;R_m * q, R_n * k&gt; = f(m - n, q, k)

       åªä¾èµ–äºç›¸å¯¹ä½ç½® (m - n)ï¼Œä¸ä¾èµ–äºç»å¯¹ä½ç½®
       Only depends on relative position (m - n), not absolute positions
    &quot;&quot;&quot;</span>
    <span class="hljs-built_in">print</span>(explanation)


explain_rope_math()

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 5. éªŒè¯ç›¸å¯¹ä½ç½®ç‰¹æ€§ / Verify Relative Position Property</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">verify_relative_position</span>():
    <span class="hljs-string">&quot;&quot;&quot;
    éªŒè¯ RoPE çš„ç›¸å¯¹ä½ç½®ç‰¹æ€§ / Verify relative position property of RoPE
    &quot;&quot;&quot;</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">60</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;éªŒè¯ç›¸å¯¹ä½ç½®ç‰¹æ€§ / Verifying Relative Position Property&quot;</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">60</span>)

    head_dim = <span class="hljs-number">64</span>
    max_len = <span class="hljs-number">100</span>
    rope = RotaryPositionalEmbedding(dim=head_dim, max_seq_len=max_len)

    <span class="hljs-comment"># åˆ›å»ºå›ºå®šçš„ Query å’Œ Key å‘é‡ / Create fixed Query and Key vectors</span>
    q = torch.randn(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, head_dim)  <span class="hljs-comment"># å•ä¸ª query</span>
    k = torch.randn(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, head_dim)  <span class="hljs-comment"># å•ä¸ª key</span>

    <span class="hljs-comment"># æµ‹è¯•ä¸åŒä½ç½®å¯¹çš„æ³¨æ„åŠ›åˆ†æ•° / Test attention scores for different position pairs</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\nä¸åŒä½ç½®å¯¹çš„æ³¨æ„åŠ›åˆ†æ•° / Attention scores for different position pairs:&quot;</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;(ç†è®ºä¸Šï¼Œç›¸åŒç›¸å¯¹è·ç¦»çš„ä½ç½®å¯¹åº”è¯¥æœ‰ç›¸ä¼¼çš„æ³¨æ„åŠ›åˆ†æ•°)&quot;</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;(Theoretically, position pairs with same relative distance should have similar scores)&quot;</span>)

    relative_distances = [<span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">10</span>, <span class="hljs-number">20</span>]

    <span class="hljs-keyword">for</span> dist <span class="hljs-keyword">in</span> relative_distances:
        scores = []
        <span class="hljs-keyword">for</span> pos1 <span class="hljs-keyword">in</span> [<span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">30</span>, <span class="hljs-number">40</span>]:
            pos2 = pos1 + dist
            <span class="hljs-keyword">if</span> pos2 &lt; max_len:
                <span class="hljs-comment"># ä¸ºä½ç½® pos1 åˆ›å»º Queryï¼Œä½ç½® pos2 åˆ›å»º Key</span>
                q_pos = q.expand(<span class="hljs-number">1</span>, max_len, <span class="hljs-number">1</span>, head_dim).clone()
                k_pos = k.expand(<span class="hljs-number">1</span>, max_len, <span class="hljs-number">1</span>, head_dim).clone()

                <span class="hljs-comment"># åº”ç”¨ RoPE</span>
                q_rot, k_rot = rope(q_pos, k_pos)

                <span class="hljs-comment"># è®¡ç®—æ³¨æ„åŠ›åˆ†æ•° (ç‚¹ç§¯)</span>
                score = (q_rot[<span class="hljs-number">0</span>, pos1] * k_rot[<span class="hljs-number">0</span>, pos2]).<span class="hljs-built_in">sum</span>().item()
                scores.append(score)

        <span class="hljs-keyword">if</span> scores:
            avg_score = <span class="hljs-built_in">sum</span>(scores) / <span class="hljs-built_in">len</span>(scores)
            variance = <span class="hljs-built_in">sum</span>((s - avg_score)**<span class="hljs-number">2</span> <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> scores) / <span class="hljs-built_in">len</span>(scores)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  ç›¸å¯¹è·ç¦» <span class="hljs-subst">{dist:2d}</span>: å¹³å‡åˆ†æ•°=<span class="hljs-subst">{avg_score:<span class="hljs-number">8.4</span>f}</span>, æ–¹å·®=<span class="hljs-subst">{variance:<span class="hljs-number">.6</span>f}</span>&quot;</span>)


verify_relative_position()

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 6. å®Œæ•´çš„æ³¨æ„åŠ›å±‚ç¤ºä¾‹ / Complete Attention Layer Example</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">RoPEAttention</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;
    ä½¿ç”¨ RoPE çš„å¤šå¤´æ³¨æ„åŠ›å±‚ / Multi-head Attention Layer with RoPE

    è¿™æ˜¯ LLaMA ç­‰æ¨¡å‹ä¸­æ³¨æ„åŠ›å±‚çš„ç®€åŒ–å®ç°
    Simplified implementation of attention layer in models like LLaMA
    &quot;&quot;&quot;</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">
        self,
        d_model: <span class="hljs-built_in">int</span>,
        n_heads: <span class="hljs-built_in">int</span>,
        max_seq_len: <span class="hljs-built_in">int</span> = <span class="hljs-number">2048</span>,
        dropout: <span class="hljs-built_in">float</span> = <span class="hljs-number">0.0</span>
    </span>):
        <span class="hljs-string">&quot;&quot;&quot;
        å‚æ•° / Args:
            d_model: æ¨¡å‹ç»´åº¦ / Model dimension
            n_heads: æ³¨æ„åŠ›å¤´æ•°é‡ / Number of attention heads
            max_seq_len: æœ€å¤§åºåˆ—é•¿åº¦ / Maximum sequence length
            dropout: Dropout æ¦‚ç‡ / Dropout probability
        &quot;&quot;&quot;</span>
        <span class="hljs-built_in">super</span>().__init__()

        <span class="hljs-variable language_">self</span>.d_model = d_model
        <span class="hljs-variable language_">self</span>.n_heads = n_heads
        <span class="hljs-variable language_">self</span>.head_dim = d_model // n_heads

        <span class="hljs-keyword">assert</span> d_model % n_heads == <span class="hljs-number">0</span>, <span class="hljs-string">&quot;d_model must be divisible by n_heads&quot;</span>

        <span class="hljs-comment"># Query, Key, Value æŠ•å½±å±‚ / Q, K, V projection layers</span>
        <span class="hljs-variable language_">self</span>.wq = nn.Linear(d_model, d_model, bias=<span class="hljs-literal">False</span>)
        <span class="hljs-variable language_">self</span>.wk = nn.Linear(d_model, d_model, bias=<span class="hljs-literal">False</span>)
        <span class="hljs-variable language_">self</span>.wv = nn.Linear(d_model, d_model, bias=<span class="hljs-literal">False</span>)

        <span class="hljs-comment"># è¾“å‡ºæŠ•å½± / Output projection</span>
        <span class="hljs-variable language_">self</span>.wo = nn.Linear(d_model, d_model, bias=<span class="hljs-literal">False</span>)

        <span class="hljs-comment"># RoPE</span>
        <span class="hljs-variable language_">self</span>.rope = RotaryPositionalEmbedding(<span class="hljs-variable language_">self</span>.head_dim, max_seq_len)

        <span class="hljs-comment"># Dropout</span>
        <span class="hljs-variable language_">self</span>.dropout = nn.Dropout(dropout)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">
        self,
        x: torch.Tensor,
        mask: <span class="hljs-type">Optional</span>[torch.Tensor] = <span class="hljs-literal">None</span>
    </span>) -&gt; torch.Tensor:
        <span class="hljs-string">&quot;&quot;&quot;
        å‰å‘ä¼ æ’­ / Forward pass

        å‚æ•° / Args:
            x: è¾“å…¥å¼ é‡ (batch, seq_len, d_model) / Input tensor
            mask: æ³¨æ„åŠ›æ©ç  (å¯é€‰) / Attention mask (optional)

        è¿”å› / Returns:
            è¾“å‡ºå¼ é‡ (batch, seq_len, d_model) / Output tensor
        &quot;&quot;&quot;</span>
        batch_size, seq_len, _ = x.shape

        <span class="hljs-comment"># è®¡ç®— Q, K, V / Compute Q, K, V</span>
        q = <span class="hljs-variable language_">self</span>.wq(x)
        k = <span class="hljs-variable language_">self</span>.wk(x)
        v = <span class="hljs-variable language_">self</span>.wv(x)

        <span class="hljs-comment"># é‡å¡‘ä¸ºå¤šå¤´å½¢å¼ / Reshape to multi-head form</span>
        <span class="hljs-comment"># (batch, seq_len, d_model) -&gt; (batch, seq_len, n_heads, head_dim)</span>
        q = q.view(batch_size, seq_len, <span class="hljs-variable language_">self</span>.n_heads, <span class="hljs-variable language_">self</span>.head_dim)
        k = k.view(batch_size, seq_len, <span class="hljs-variable language_">self</span>.n_heads, <span class="hljs-variable language_">self</span>.head_dim)
        v = v.view(batch_size, seq_len, <span class="hljs-variable language_">self</span>.n_heads, <span class="hljs-variable language_">self</span>.head_dim)

        <span class="hljs-comment"># åº”ç”¨ RoPE / Apply RoPE</span>
        q, k = <span class="hljs-variable language_">self</span>.rope(q, k)

        <span class="hljs-comment"># è½¬ç½®ç”¨äºæ³¨æ„åŠ›è®¡ç®— / Transpose for attention computation</span>
        <span class="hljs-comment"># (batch, seq_len, n_heads, head_dim) -&gt; (batch, n_heads, seq_len, head_dim)</span>
        q = q.transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)
        k = k.transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)
        v = v.transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)

        <span class="hljs-comment"># è®¡ç®—æ³¨æ„åŠ›åˆ†æ•° / Compute attention scores</span>
        <span class="hljs-comment"># scores: (batch, n_heads, seq_len, seq_len)</span>
        scores = torch.matmul(q, k.transpose(-<span class="hljs-number">2</span>, -<span class="hljs-number">1</span>)) / math.sqrt(<span class="hljs-variable language_">self</span>.head_dim)

        <span class="hljs-comment"># åº”ç”¨æ©ç ï¼ˆå¦‚æœæœ‰ï¼‰/ Apply mask if provided</span>
        <span class="hljs-keyword">if</span> mask <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            scores = scores + mask

        <span class="hljs-comment"># Softmax</span>
        attn_weights = torch.softmax(scores, dim=-<span class="hljs-number">1</span>)
        attn_weights = <span class="hljs-variable language_">self</span>.dropout(attn_weights)

        <span class="hljs-comment"># åŠ æƒæ±‚å’Œ / Weighted sum</span>
        <span class="hljs-comment"># (batch, n_heads, seq_len, head_dim)</span>
        attn_output = torch.matmul(attn_weights, v)

        <span class="hljs-comment"># è½¬ç½®å›æ¥ / Transpose back</span>
        <span class="hljs-comment"># (batch, seq_len, n_heads, head_dim)</span>
        attn_output = attn_output.transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>).contiguous()

        <span class="hljs-comment"># åˆå¹¶å¤šå¤´ / Merge heads</span>
        attn_output = attn_output.view(batch_size, seq_len, <span class="hljs-variable language_">self</span>.d_model)

        <span class="hljs-comment"># è¾“å‡ºæŠ•å½± / Output projection</span>
        output = <span class="hljs-variable language_">self</span>.wo(attn_output)

        <span class="hljs-keyword">return</span> output


<span class="hljs-comment"># ä½¿ç”¨ç¤ºä¾‹ / Usage example</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;RoPE æ³¨æ„åŠ›å±‚ç¤ºä¾‹ / RoPE Attention Layer Example&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">60</span>)

attention = RoPEAttention(d_model=<span class="hljs-number">512</span>, n_heads=<span class="hljs-number">8</span>, max_seq_len=<span class="hljs-number">2048</span>)
x = torch.randn(<span class="hljs-number">2</span>, <span class="hljs-number">32</span>, <span class="hljs-number">512</span>)
output = attention(x)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nè¾“å…¥å½¢çŠ¶ / Input shape: <span class="hljs-subst">{x.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;è¾“å‡ºå½¢çŠ¶ / Output shape: <span class="hljs-subst">{output.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;å‚æ•°é‡ / Parameters: <span class="hljs-subst">{<span class="hljs-built_in">sum</span>(p.numel() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> attention.parameters()):,}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 7. ä¸æ­£å¼¦ä½ç½®ç¼–ç çš„æ¯”è¾ƒ / Comparison with Sinusoidal PE</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">compare_rope_vs_sinusoidal</span>():
    <span class="hljs-string">&quot;&quot;&quot;
    æ¯”è¾ƒ RoPE å’Œæ­£å¼¦ä½ç½®ç¼–ç  / Compare RoPE and Sinusoidal PE
    &quot;&quot;&quot;</span>
    comparison = <span class="hljs-string">&quot;&quot;&quot;
    RoPE vs æ­£å¼¦ä½ç½®ç¼–ç  / RoPE vs Sinusoidal Positional Encoding
    =============================================================

    | ç‰¹æ€§ | RoPE | æ­£å¼¦ç¼–ç  |
    |------|------|----------|
    | åº”ç”¨ä½ç½® | ä»… Q, K | æ‰€æœ‰åµŒå…¥ |
    | ç›¸å¯¹ä½ç½® | âœ“ ç²¾ç¡® | â–³ è¿‘ä¼¼ |
    | é•¿åº¦å¤–æ¨ | âœ“ å¼º | â–³ ä¸­ç­‰ |
    | è®¡ç®—å¤æ‚åº¦ | è¾ƒé«˜ï¼ˆå¤æ•°è¿ç®—ï¼‰| è¾ƒä½ï¼ˆåŠ æ³•ï¼‰|
    | å‚æ•°é‡ | 0 | 0 |
    | ä½¿ç”¨æ¨¡å‹ | LLaMA, PaLM, GPT-NeoX | åŸå§‹ Transformer |

    RoPE çš„ä¼˜åŠ¿ / Advantages of RoPE:
    1. ç›¸å¯¹ä½ç½®ç¼–ç æ›´ç²¾ç¡® / More precise relative position encoding
    2. æ›´å¥½çš„é•¿åº¦å¤–æ¨èƒ½åŠ› / Better length extrapolation
    3. åœ¨é•¿åºåˆ—ä¸Šè¡¨ç°æ›´å¥½ / Better performance on long sequences

    æ­£å¼¦ç¼–ç çš„ä¼˜åŠ¿ / Advantages of Sinusoidal:
    1. å®ç°æ›´ç®€å• / Simpler implementation
    2. è®¡ç®—æ•ˆç‡æ›´é«˜ / Higher computational efficiency
    3. å¯¹æ‰€æœ‰åµŒå…¥ç»Ÿä¸€å¤„ç† / Uniform treatment for all embeddings
    &quot;&quot;&quot;</span>
    <span class="hljs-built_in">print</span>(comparison)


compare_rope_vs_sinusoidal()

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 8. ä¸åŒ theta å€¼çš„å½±å“ / Effect of Different Theta Values</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_theta_effect</span>():
    <span class="hljs-string">&quot;&quot;&quot;
    åˆ†æä¸åŒ theta å€¼å¯¹ä½ç½®ç¼–ç çš„å½±å“
    Analyze effect of different theta values on positional encoding
    &quot;&quot;&quot;</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">60</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Theta å‚æ•°åˆ†æ / Theta Parameter Analysis&quot;</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">60</span>)

    thetas = [<span class="hljs-number">100.0</span>, <span class="hljs-number">1000.0</span>, <span class="hljs-number">10000.0</span>, <span class="hljs-number">100000.0</span>]
    head_dim = <span class="hljs-number">64</span>
    seq_len = <span class="hljs-number">100</span>

    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\nä¸åŒ theta å€¼çš„é¢‘ç‡èŒƒå›´ / Frequency ranges for different theta values:&quot;</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;(theta è¶Šå¤§ï¼Œä½é¢‘åˆ†é‡è¶Šå¤šï¼Œèƒ½ç¼–ç æ›´é•¿çš„è·ç¦»å…³ç³»)&quot;</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;(Larger theta means more low-frequency components, encoding longer distance relationships)&quot;</span>)

    <span class="hljs-keyword">for</span> theta <span class="hljs-keyword">in</span> thetas:
        <span class="hljs-comment"># è®¡ç®—é¢‘ç‡ / Compute frequencies</span>
        freqs = <span class="hljs-number">1.0</span> / (theta ** (torch.arange(<span class="hljs-number">0</span>, head_dim, <span class="hljs-number">2</span>).<span class="hljs-built_in">float</span>() / head_dim))

        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n  theta = <span class="hljs-subst">{theta:<span class="hljs-number">.0</span>f}</span>:&quot;</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;    æœ€é«˜é¢‘ç‡ / Highest freq: <span class="hljs-subst">{freqs[<span class="hljs-number">0</span>].item():<span class="hljs-number">.6</span>f}</span>&quot;</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;    æœ€ä½é¢‘ç‡ / Lowest freq:  <span class="hljs-subst">{freqs[-<span class="hljs-number">1</span>].item():<span class="hljs-number">.10</span>f}</span>&quot;</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;    å‘¨æœŸèŒƒå›´ / Period range: <span class="hljs-subst">{<span class="hljs-number">1</span>/freqs[<span class="hljs-number">0</span>].item():<span class="hljs-number">.1</span>f}</span> ~ <span class="hljs-subst">{<span class="hljs-number">1</span>/freqs[-<span class="hljs-number">1</span>].item():<span class="hljs-number">.1</span>f}</span> ä½ç½®&quot;</span>)


analyze_theta_effect()

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 9. å®é™…åº”ç”¨å»ºè®® / Practical Application Tips</span>
<span class="hljs-comment"># =============================================================================</span>

PRACTICAL_TIPS = <span class="hljs-string">&quot;&quot;&quot;
å®é™…åº”ç”¨å»ºè®® / Practical Application Tips
==========================================

1. Theta å€¼é€‰æ‹© / Choosing Theta Value:
   - æ ‡å‡†å€¼: 10000 (å¤§å¤šæ•°æ¨¡å‹ä½¿ç”¨)
   - é•¿åºåˆ—: å¯å¢å¤§åˆ° 100000 æˆ–æ›´å¤š
   - çŸ­åºåˆ—: å¯å‡å°åˆ° 1000

2. ä¸å…¶ä»–ä½ç½®ç¼–ç ç»“åˆ / Combining with Other PE:
   - RoPE é€šå¸¸å•ç‹¬ä½¿ç”¨ï¼Œä¸éœ€è¦é¢å¤–çš„ä½ç½®ç¼–ç 
   - åœ¨æŸäº›åœºæ™¯ä¸‹å¯ä¸ ALiBi ç»“åˆä½¿ç”¨

3. å®ç°ä¼˜åŒ– / Implementation Optimizations:
   - é¢„è®¡ç®—é¢‘ç‡å¹¶ç¼“å­˜ / Precompute and cache frequencies
   - ä½¿ç”¨åŠç²¾åº¦ (fp16/bf16) åŠ é€Ÿè®¡ç®— / Use half precision for faster computation
   - è€ƒè™‘ä½¿ç”¨ Flash Attention è¿›ä¸€æ­¥ä¼˜åŒ–

4. å¸¸è§é—®é¢˜ / Common Issues:
   - ç»´åº¦å¿…é¡»æ˜¯å¶æ•° / Dimension must be even
   - åºåˆ—é•¿åº¦ä¸èƒ½è¶…è¿‡ max_seq_len / Sequence length cannot exceed max_seq_len
   - æ³¨æ„ dtype ä¸€è‡´æ€§ / Pay attention to dtype consistency

5. è°ƒè¯•æŠ€å·§ / Debugging Tips:
   - æ£€æŸ¥æ—‹è½¬åçš„å‘é‡èŒƒæ•°æ˜¯å¦ä¿æŒä¸å˜ / Check if rotated vector norm is preserved
   - éªŒè¯ç›¸å¯¹ä½ç½®ç‰¹æ€§ / Verify relative position property
   - å¯è§†åŒ–æ³¨æ„åŠ›çŸ©é˜µ / Visualize attention matrix
&quot;&quot;&quot;</span>

<span class="hljs-built_in">print</span>(PRACTICAL_TIPS)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># æ€»ç»“ / Summary</span>
<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-string">&quot;&quot;&quot;
æœ¬ç¤ºä¾‹å±•ç¤ºäº† RoPE çš„å®Œæ•´å®ç°å’Œä½¿ç”¨:
This example demonstrates complete implementation and usage of RoPE:

1. åŸºæœ¬åŸç† / Basic Principles
   - ä½¿ç”¨å¤æ•°æ—‹è½¬ç¼–ç ä½ç½® / Encode position using complex rotation
   - ä¸åŒç»´åº¦ä½¿ç”¨ä¸åŒé¢‘ç‡ / Different dimensions use different frequencies

2. æ ¸å¿ƒä¼˜åŠ¿ / Key Advantages
   - ç›¸å¯¹ä½ç½®ç¼–ç  / Relative position encoding
   - æ— é¢å¤–å‚æ•° / No additional parameters
   - è‰¯å¥½çš„é•¿åº¦å¤–æ¨ / Good length extrapolation

3. å®ç°è¦ç‚¹ / Implementation Points
   - é¢„è®¡ç®—é¢‘ç‡ / Precompute frequencies
   - å¤æ•°ä¹˜æ³•å®ç°æ—‹è½¬ / Complex multiplication for rotation
   - ä»…åº”ç”¨äº Q å’Œ K / Only apply to Q and K

4. åº”ç”¨åœºæ™¯ / Use Cases
   - LLaMA, PaLM, GPT-NeoX ç­‰ç°ä»£ LLM
   - éœ€è¦å¤„ç†é•¿åºåˆ—çš„åœºæ™¯
   - éœ€è¦ç›¸å¯¹ä½ç½®ä¿¡æ¯çš„ä»»åŠ¡

å‚è€ƒèµ„æº / References:
- RoFormer Paper: https://arxiv.org/abs/2104.09864
- LLaMA Implementation: https://github.com/facebookresearch/llama
&quot;&quot;&quot;</span>
</code></pre></div><div class="code-file"><h3>sinusoidal_pe_example.py</h3><pre class="hljs"><code><span class="hljs-string">&quot;&quot;&quot;
æ­£å¼¦ä½ç½®ç¼–ç ç¤ºä¾‹ / Sinusoidal Position Encoding Example
======================================================

æœ¬ç¤ºä¾‹å±•ç¤º Transformer åŸå§‹è®ºæ–‡ä¸­æå‡ºçš„æ­£å¼¦ä½ç½®ç¼–ç å®ç°ã€‚
This example demonstrates the Sinusoidal Position Encoding proposed in the
original Transformer paper.

ï¿½ï¿½æ–‡ / Paper: Attention Is All You Need (Vaswani et al., 2017)

æ­£å¼¦ä½ç½®ç¼–ç ä½¿ç”¨ä¸åŒé¢‘ç‡çš„æ­£å¼¦å’Œä½™å¼¦å‡½æ•°æ¥è¡¨ç¤ºä½ç½®ä¿¡æ¯ã€‚
Sinusoidal position encoding uses sine and cosine functions of different
frequencies to represent positional information.

ä¾èµ–å®‰è£… / Dependencies:
    pip install torch numpy matplotlib
&quot;&quot;&quot;</span>

<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> math

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 1. æ­£å¼¦ä½ç½®ç¼–ç å®ç° / Sinusoidal Position Encoding Implementation</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SinusoidalPositionalEncoding</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;
    æ­£å¼¦ä½ç½®ç¼–ç æ¨¡å— / Sinusoidal Positional Encoding Module

    ä½¿ç”¨æ­£å¼¦å’Œä½™å¼¦ï¿½ï¿½ï¿½æ•°ç”Ÿæˆä½ç½®ç¼–ç ï¼Œå…¬å¼å¦‚ä¸‹ï¼š
    Uses sine and cosine functions to generate position encodings:

        PE(pos, 2i)   = sin(pos / 10000^(2i/d_model))
        PE(pos, 2i+1) = cos(pos / 10000^(2i/d_model))

    å…¶ä¸­ / Where:
        pos: ä½ç½®ç´¢å¼• / Position index
        i: ç»´åº¦ç´¢å¼• / Dimension index
        d_model: æ¨¡å‹ç»´åº¦ / Model dimension

    è¿™ç§ç¼–ç æ–¹å¼çš„å…³é”®ç‰¹æ€§ / Key properties of this encoding:
    1. æ¯ä¸ªä½ç½®éƒ½æœ‰å”¯ä¸€çš„ç¼–ç è¡¨ç¤º / Each position has a unique encoding
    2. ç¼–ç å€¼æœ‰ç•Œ [-1, 1] / Bounded values in [-1, 1]
    3. å¯ä»¥å¤„ç†ä»»æ„é•¿åº¦çš„åºåˆ— / Can handle sequences of any length
    4. ç›¸é‚»ä½ç½®çš„ç¼–ç ç›¸ä¼¼ / Similar encodings for adjacent positions
    5. ç›¸å¯¹ä½ç½®å¯ä»¥é€šè¿‡çº¿æ€§å˜æ¢è·å¾— / Relative position can be obtained via linear transformation
    &quot;&quot;&quot;</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, d_model, max_len=<span class="hljs-number">5000</span>, dropout=<span class="hljs-number">0.1</span></span>):
        <span class="hljs-string">&quot;&quot;&quot;
        åˆå§‹åŒ–ä½ç½®ç¼–ç  / Initialize Positional Encoding

        å‚æ•° / Args:
            d_model: æ¨¡å‹çš„åµŒå…¥ç»´åº¦ / Embedding dimension of the model
            max_len: æœ€å¤§åºåˆ—é•¿åº¦ / Maximum sequence length
            dropout: Dropout æ¦‚ç‡ / Dropout probability
        &quot;&quot;&quot;</span>
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-variable language_">self</span>.dropout = nn.Dropout(p=dropout)

        <span class="hljs-comment"># åˆ›å»ºä½ç½®ç¼–ç çŸ©é˜µ / Create positional encoding matrix</span>
        <span class="hljs-comment"># å½¢çŠ¶: (max_len, d_model) / Shape: (max_len, d_model)</span>
        pe = torch.zeros(max_len, d_model)

        <span class="hljs-comment"># ä½ç½®ç´¢å¼• / Position indices: [0, 1, 2, ..., max_len-1]</span>
        position = torch.arange(<span class="hljs-number">0</span>, max_len, dtype=torch.<span class="hljs-built_in">float</span>).unsqueeze(<span class="hljs-number">1</span>)

        <span class="hljs-comment"># è®¡ç®—åˆ†æ¯ä¸­çš„æŒ‡æ•°é¡¹ / Compute the exponential term in denominator</span>
        <span class="hljs-comment"># div_term = 10000^(2i/d_model) for i in [0, d_model/2)</span>
        <span class="hljs-comment"># ä½¿ç”¨æŒ‡æ•°å‡½æ•°è®¡ç®—æ›´ç¨³å®š / Using exp function for numerical stability</span>
        div_term = torch.exp(
            torch.arange(<span class="hljs-number">0</span>, d_model, <span class="hljs-number">2</span>).<span class="hljs-built_in">float</span>() * (-math.log(<span class="hljs-number">10000.0</span>) / d_model)
        )

        <span class="hljs-comment"># å¶æ•°ç»´åº¦ä½¿ç”¨ sinï¼Œå¥‡æ•°ç»´åº¦ä½¿ç”¨ cos</span>
        <span class="hljs-comment"># Even dimensions use sin, odd dimensions use cos</span>
        pe[:, <span class="hljs-number">0</span>::<span class="hljs-number">2</span>] = torch.sin(position * div_term)  <span class="hljs-comment"># å¶æ•°ç»´åº¦ / Even dimensions</span>
        pe[:, <span class="hljs-number">1</span>::<span class="hljs-number">2</span>] = torch.cos(position * div_term)  <span class="hljs-comment"># å¥‡æ•°ç»´åº¦ / Odd dimensions</span>

        <span class="hljs-comment"># æ·»åŠ  batch ç»´åº¦ / Add batch dimension</span>
        <span class="hljs-comment"># å½¢çŠ¶: (1, max_len, d_model) / Shape: (1, max_len, d_model)</span>
        pe = pe.unsqueeze(<span class="hljs-number">0</span>)

        <span class="hljs-comment"># æ³¨å†Œä¸º bufferï¼ˆä¸å‚ä¸è®­ç»ƒï¼‰/ Register as buffer (not trained)</span>
        <span class="hljs-variable language_">self</span>.register_buffer(<span class="hljs-string">&#x27;pe&#x27;</span>, pe)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-string">&quot;&quot;&quot;
        å‰å‘ä¼ æ’­ / Forward pass

        å‚æ•° / Args:
            x: è¾“å…¥åµŒå…¥å¼ é‡ï¼Œå½¢çŠ¶ (batch_size, seq_len, d_model)
               Input embedding tensor, shape (batch_size, seq_len, d_model)

        è¿”å› / Returns:
            æ·»åŠ ä½ç½®ç¼–ç åçš„å¼ é‡ / Tensor with positional encoding added
        &quot;&quot;&quot;</span>
        seq_len = x.size(<span class="hljs-number">1</span>)
        <span class="hljs-comment"># å°†ä½ç½®ç¼–ç åŠ åˆ°è¾“å…¥ä¸Š / Add positional encoding to input</span>
        x = x + <span class="hljs-variable language_">self</span>.pe[:, :seq_len, :]
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.dropout(x)


<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 2. åŸºæœ¬ä½¿ç”¨ç¤ºä¾‹ / Basic Usage Example</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-comment"># æ¨¡å‹å‚æ•° / Model parameters</span>
d_model = <span class="hljs-number">512</span>      <span class="hljs-comment"># åµŒå…¥ç»´åº¦ / Embedding dimension</span>
max_len = <span class="hljs-number">100</span>      <span class="hljs-comment"># æœ€å¤§åºåˆ—é•¿åº¦ / Maximum sequence length</span>
batch_size = <span class="hljs-number">2</span>     <span class="hljs-comment"># æ‰¹æ¬¡å¤§å° / Batch size</span>
seq_len = <span class="hljs-number">10</span>       <span class="hljs-comment"># åºåˆ—é•¿åº¦ / Sequence length</span>

<span class="hljs-comment"># åˆ›å»ºä½ç½®ç¼–ç æ¨¡å— / Create positional encoding module</span>
pos_encoder = SinusoidalPositionalEncoding(d_model=d_model, max_len=max_len)

<span class="hljs-comment"># æ¨¡æ‹Ÿè¾“å…¥åµŒå…¥ / Simulated input embeddings</span>
<span class="hljs-comment"># åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™æ˜¯è¯åµŒå…¥å±‚çš„è¾“å‡º</span>
<span class="hljs-comment"># In practice, this is the output of the word embedding layer</span>
x = torch.randn(batch_size, seq_len, d_model)

<span class="hljs-comment"># æ·»åŠ ä½ç½®ç¼–ç  / Add positional encoding</span>
output = pos_encoder(x)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;è¾“å…¥å½¢çŠ¶ / Input shape: <span class="hljs-subst">{x.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;è¾“å‡ºå½¢çŠ¶ / Output shape: <span class="hljs-subst">{output.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;ä½ç½®ç¼–ç çŸ©é˜µå½¢çŠ¶ / PE matrix shape: <span class="hljs-subst">{pos_encoder.pe.shape}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 3. å¯è§†åŒ–ä½ç½®ç¼–ç  / Visualizing Positional Encoding</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">visualize_positional_encoding</span>(<span class="hljs-params">pe_matrix, num_positions=<span class="hljs-number">50</span>, num_dimensions=<span class="hljs-number">100</span></span>):
    <span class="hljs-string">&quot;&quot;&quot;
    å¯è§†åŒ–ä½ç½®ç¼–ç çŸ©é˜µ / Visualize positional encoding matrix

    å‚æ•° / Args:
        pe_matrix: ä½ç½®ç¼–ç çŸ©é˜µ (1, max_len, d_model) / PE matrix
        num_positions: è¦å¯è§†åŒ–çš„ä½ç½®æ•°é‡ / Number of positions to visualize
        num_dimensions: è¦å¯è§†åŒ–çš„ç»´åº¦æ•°é‡ / Number of dimensions to visualize
    &quot;&quot;&quot;</span>
    <span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt

    <span class="hljs-comment"># æå–ç¼–ç çŸ©é˜µ / Extract encoding matrix</span>
    pe = pe_matrix[<span class="hljs-number">0</span>, :num_positions, :num_dimensions].numpy()

    plt.figure(figsize=(<span class="hljs-number">12</span>, <span class="hljs-number">6</span>))
    plt.imshow(pe, aspect=<span class="hljs-string">&#x27;auto&#x27;</span>, cmap=<span class="hljs-string">&#x27;RdBu&#x27;</span>)
    plt.colorbar(label=<span class="hljs-string">&#x27;Encoding Value / ç¼–ç å€¼&#x27;</span>)
    plt.xlabel(<span class="hljs-string">&#x27;Dimension / ç»´åº¦&#x27;</span>)
    plt.ylabel(<span class="hljs-string">&#x27;Position / ä½ç½®&#x27;</span>)
    plt.title(<span class="hljs-string">&#x27;Sinusoidal Positional Encoding / æ­£å¼¦ä½ç½®ç¼–ç &#x27;</span>)
    plt.tight_layout()
    plt.savefig(<span class="hljs-string">&#x27;positional_encoding.png&#x27;</span>, dpi=<span class="hljs-number">150</span>)
    plt.close()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;å¯è§†åŒ–å·²ä¿å­˜åˆ° / Visualization saved to: positional_encoding.png&quot;</span>)


<span class="hljs-comment"># å¯è§†åŒ–ï¼ˆå–æ¶ˆæ³¨é‡Šä»¥è¿è¡Œï¼‰/ Visualize (uncomment to run)</span>
<span class="hljs-comment"># visualize_positional_encoding(pos_encoder.pe)</span>

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 4. åˆ†æä½ç½®ç¼–ç çš„ç‰¹æ€§ / Analyzing Properties of Positional Encoding</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_pe_properties</span>(<span class="hljs-params">pe_matrix</span>):
    <span class="hljs-string">&quot;&quot;&quot;
    åˆ†æä½ç½®ç¼–ç çš„æ•°å­¦ç‰¹æ€§ / Analyze mathematical properties of positional encoding

    å‚æ•° / Args:
        pe_matrix: ä½ç½®ç¼–ç çŸ©é˜µ (1, max_len, d_model) / PE matrix
    &quot;&quot;&quot;</span>
    pe = pe_matrix[<span class="hljs-number">0</span>]  <span class="hljs-comment"># ç§»é™¤ batch ç»´åº¦ / Remove batch dimension</span>

    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">60</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ä½ç½®ç¼–ç ç‰¹æ€§åˆ†æ / Positional Encoding Properties Analysis&quot;</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">60</span>)

    <span class="hljs-comment"># 1. ç¼–ç èŒƒå›´ / Encoding range</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n1. ç¼–ç å€¼èŒƒå›´ / Encoding value range:&quot;</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   æœ€å°å€¼ / Min: <span class="hljs-subst">{pe.<span class="hljs-built_in">min</span>().item():<span class="hljs-number">.6</span>f}</span>&quot;</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   æœ€å¤§å€¼ / Max: <span class="hljs-subst">{pe.<span class="hljs-built_in">max</span>().item():<span class="hljs-number">.6</span>f}</span>&quot;</span>)

    <span class="hljs-comment"># 2. ç›¸é‚»ä½ç½®çš„ç›¸ä¼¼åº¦ / Similarity between adjacent positions</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n2. ç›¸é‚»ä½ç½®çš„ä½™å¼¦ç›¸ä¼¼åº¦ / Cosine similarity of adjacent positions:&quot;</span>)
    <span class="hljs-keyword">for</span> pos <span class="hljs-keyword">in</span> [<span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">50</span>, <span class="hljs-number">100</span>]:
        <span class="hljs-keyword">if</span> pos + <span class="hljs-number">1</span> &lt; pe.size(<span class="hljs-number">0</span>):
            v1, v2 = pe[pos], pe[pos+<span class="hljs-number">1</span>]
            sim = torch.cosine_similarity(v1.unsqueeze(<span class="hljs-number">0</span>), v2.unsqueeze(<span class="hljs-number">0</span>))
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   ä½ç½® <span class="hljs-subst">{pos}</span> vs <span class="hljs-subst">{pos+<span class="hljs-number">1</span>}</span>: <span class="hljs-subst">{sim.item():<span class="hljs-number">.6</span>f}</span>&quot;</span>)

    <span class="hljs-comment"># 3. ä¸åŒä½ç½®ä¹‹é—´çš„ç›¸ä¼¼åº¦ / Similarity between different positions</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n3. ä¸åŒä½ç½®ä¹‹é—´çš„ä½™å¼¦ç›¸ä¼¼åº¦ / Cosine similarity between different positions:&quot;</span>)
    pos_pairs = [(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>), (<span class="hljs-number">0</span>, <span class="hljs-number">10</span>), (<span class="hljs-number">0</span>, <span class="hljs-number">50</span>), (<span class="hljs-number">10</span>, <span class="hljs-number">20</span>), (<span class="hljs-number">10</span>, <span class="hljs-number">100</span>)]
    <span class="hljs-keyword">for</span> p1, p2 <span class="hljs-keyword">in</span> pos_pairs:
        <span class="hljs-keyword">if</span> p2 &lt; pe.size(<span class="hljs-number">0</span>):
            v1, v2 = pe[p1], pe[p2]
            sim = torch.cosine_similarity(v1.unsqueeze(<span class="hljs-number">0</span>), v2.unsqueeze(<span class="hljs-number">0</span>))
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   ä½ç½® <span class="hljs-subst">{p1}</span> vs <span class="hljs-subst">{p2}</span>: <span class="hljs-subst">{sim.item():<span class="hljs-number">.6</span>f}</span>&quot;</span>)

    <span class="hljs-comment"># 4. ç‰¹å®šç»´åº¦çš„æ³¢å½¢ / Wave patterns in specific dimensions</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n4. ä¸åŒç»´åº¦çš„æ³¢å½¢åˆ†æ / Wave pattern analysis for different dimensions:&quot;</span>)
    dims_to_check = [<span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">100</span>, <span class="hljs-number">256</span>, <span class="hljs-number">511</span>]
    <span class="hljs-keyword">for</span> dim <span class="hljs-keyword">in</span> dims_to_check:
        <span class="hljs-keyword">if</span> dim &lt; pe.size(<span class="hljs-number">1</span>):
            values = pe[:<span class="hljs-number">20</span>, dim]
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   ç»´åº¦ <span class="hljs-subst">{dim}</span>: å‰5ä¸ªå€¼ = <span class="hljs-subst">{values[:<span class="hljs-number">5</span>].tolist()}</span>&quot;</span>)


analyze_pe_properties(pos_encoder.pe)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 5. ç›¸å¯¹ä½ç½®å…³ç³» / Relative Position Relationships</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">demonstrate_relative_position</span>(<span class="hljs-params">pe_matrix</span>):
    <span class="hljs-string">&quot;&quot;&quot;
    æ¼”ç¤ºæ­£å¼¦ç¼–ç çš„ç›¸å¯¹ä½ç½®ç‰¹æ€§ / Demonstrate relative position property

    æ­£å¼¦ç¼–ç çš„ä¸€ä¸ªé‡è¦ç‰¹æ€§æ˜¯ï¼š
    An important property of sinusoidal encoding:
    PE(pos+k) å¯ä»¥è¡¨ç¤ºä¸º PE(pos) çš„çº¿æ€§å‡½æ•°
    PE(pos+k) can be expressed as a linear function of PE(pos)

    è¿™æ˜¯å› ä¸º:
    This is because:
    sin(x+k) = sin(x)cos(k) + cos(x)sin(k)
    cos(x+k) = cos(x)cos(k) - sin(x)sin(k)
    &quot;&quot;&quot;</span>
    pe = pe_matrix[<span class="hljs-number">0</span>]

    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">60</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ç›¸å¯¹ä½ç½®å…³ç³»æ¼”ç¤º / Relative Position Relationship Demo&quot;</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">60</span>)

    <span class="hljs-comment"># é€‰æ‹©ä¸¤ä¸ªä½ç½®ï¼Œæ£€æŸ¥å®ƒä»¬çš„ç›¸å¯¹å…³ç³»</span>
    <span class="hljs-comment"># Choose two positions and check their relative relationship</span>
    pos1, pos2 = <span class="hljs-number">10</span>, <span class="hljs-number">20</span>
    k = pos2 - pos1  <span class="hljs-comment"># ç›¸å¯¹ä½ç§» / Relative offset</span>

    v1 = pe[pos1]
    v2 = pe[pos2]

    <span class="hljs-comment"># è®¡ç®—ç›¸ä¼¼åº¦ / Compute similarity</span>
    sim = torch.cosine_similarity(v1.unsqueeze(<span class="hljs-number">0</span>), v2.unsqueeze(<span class="hljs-number">0</span>))
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nä½ç½® <span class="hljs-subst">{pos1}</span> å’Œ <span class="hljs-subst">{pos2}</span> (åç§» k=<span class="hljs-subst">{k}</span>) çš„ä½™å¼¦ç›¸ä¼¼åº¦: <span class="hljs-subst">{sim.item():<span class="hljs-number">.6</span>f}</span>&quot;</span>)

    <span class="hljs-comment"># æ£€æŸ¥å…¶ä»–å…·æœ‰ç›¸åŒç›¸å¯¹åç§»çš„ä½ç½®å¯¹</span>
    <span class="hljs-comment"># Check other position pairs with same relative offset</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nå…¶ä»–åç§» k=<span class="hljs-subst">{k}</span> çš„ä½ç½®å¯¹ç›¸ä¼¼åº¦:&quot;</span>)
    <span class="hljs-keyword">for</span> start <span class="hljs-keyword">in</span> [<span class="hljs-number">0</span>, <span class="hljs-number">30</span>, <span class="hljs-number">50</span>, <span class="hljs-number">100</span>]:
        <span class="hljs-keyword">if</span> start + k &lt; pe.size(<span class="hljs-number">0</span>):
            v_start = pe[start]
            v_end = pe[start + k]
            sim = torch.cosine_similarity(v_start.unsqueeze(<span class="hljs-number">0</span>), v_end.unsqueeze(<span class="hljs-number">0</span>))
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   ä½ç½® <span class="hljs-subst">{start}</span> vs <span class="hljs-subst">{start+k}</span>: <span class="hljs-subst">{sim.item():<span class="hljs-number">.6</span>f}</span>&quot;</span>)


demonstrate_relative_position(pos_encoder.pe)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 6. ä¸è¯åµŒå…¥ç»“åˆ / Combining with Word Embeddings</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">EmbeddingWithPositionalEncoding</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;
    è¯åµŒå…¥ + ä½ç½®ç¼–ç çš„ç»„åˆæ¨¡å— / Word Embedding + Positional Encoding Module

    è¿™æ˜¯ Transformer ç¼–ç å™¨è¾“å…¥å±‚çš„å…¸å‹å®ç°
    This is a typical implementation of Transformer encoder input layer
    &quot;&quot;&quot;</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, vocab_size, d_model, max_len=<span class="hljs-number">5000</span>, dropout=<span class="hljs-number">0.1</span></span>):
        <span class="hljs-string">&quot;&quot;&quot;
        å‚æ•° / Args:
            vocab_size: è¯è¡¨å¤§å° / Vocabulary size
            d_model: æ¨¡å‹ç»´åº¦ / Model dimension
            max_len: æœ€å¤§åºåˆ—é•¿åº¦ / Maximum sequence length
            dropout: Dropout æ¦‚ç‡ / Dropout probability
        &quot;&quot;&quot;</span>
        <span class="hljs-built_in">super</span>().__init__()

        <span class="hljs-comment"># è¯åµŒå…¥å±‚ / Word embedding layer</span>
        <span class="hljs-comment"># padding_idx=0 è¡¨ç¤º padding token çš„åµŒå…¥å›ºå®šä¸º 0</span>
        <span class="hljs-comment"># padding_idx=0 means padding token embedding is fixed to 0</span>
        <span class="hljs-variable language_">self</span>.word_embedding = nn.Embedding(vocab_size, d_model, padding_idx=<span class="hljs-number">0</span>)

        <span class="hljs-comment"># ä½ç½®ç¼–ç  / Positional encoding</span>
        <span class="hljs-variable language_">self</span>.pos_encoding = SinusoidalPositionalEncoding(d_model, max_len, dropout)

        <span class="hljs-comment"># ç¼©æ”¾å› å­ / Scaling factor</span>
        <span class="hljs-comment"># åŸå§‹è®ºæ–‡å»ºè®®å¯¹è¯åµŒå…¥ä¹˜ä»¥ sqrt(d_model)</span>
        <span class="hljs-comment"># Original paper suggests scaling word embeddings by sqrt(d_model)</span>
        <span class="hljs-variable language_">self</span>.scale = math.sqrt(d_model)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-string">&quot;&quot;&quot;
        å‰å‘ä¼ æ’­ / Forward pass

        å‚æ•° / Args:
            x: token ID å¼ é‡ (batch_size, seq_len)
               Token ID tensor

        è¿”å› / Returns:
            å¸¦ä½ç½®ç¼–ç çš„åµŒå…¥ / Embeddings with positional encoding
        &quot;&quot;&quot;</span>
        seq_len = x.size(<span class="hljs-number">1</span>)

        <span class="hljs-comment"># è·å–è¯åµŒå…¥å¹¶ç¼©æ”¾ / Get word embeddings and scale</span>
        word_emb = <span class="hljs-variable language_">self</span>.word_embedding(x) * <span class="hljs-variable language_">self</span>.scale

        <span class="hljs-comment"># æ·»åŠ ä½ç½®ç¼–ç  / Add positional encoding</span>
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.pos_encoding(word_emb)


<span class="hljs-comment"># ç¤ºä¾‹ä½¿ç”¨ / Example usage</span>
vocab_size = <span class="hljs-number">10000</span>
d_model = <span class="hljs-number">512</span>

model = EmbeddingWithPositionalEncoding(vocab_size, d_model)

<span class="hljs-comment"># æ¨¡æ‹Ÿè¾“å…¥ token IDs / Simulated input token IDs</span>
<span class="hljs-comment"># å½¢çŠ¶: (batch_size, seq_len) / Shape: (batch_size, seq_len)</span>
input_ids = torch.randint(<span class="hljs-number">0</span>, vocab_size, (<span class="hljs-number">2</span>, <span class="hljs-number">20</span>))

<span class="hljs-comment"># è·å–å¸¦ä½ç½®ç¼–ç çš„åµŒå…¥ / Get embeddings with positional encoding</span>
embeddings = model(input_ids)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nç»„åˆæ¨¡å‹è¾“å‡º / Combined Model Output:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;è¾“å…¥ IDs å½¢çŠ¶ / Input IDs shape: <span class="hljs-subst">{input_ids.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;è¾“å‡ºåµŒå…¥å½¢çŠ¶ / Output embeddings shape: <span class="hljs-subst">{embeddings.shape}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 7. NumPy å®ç°ï¼ˆç”¨äºç†è§£ï¼‰/ NumPy Implementation (for Understanding)</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_positional_encoding_numpy</span>(<span class="hljs-params">seq_len, d_model</span>):
    <span class="hljs-string">&quot;&quot;&quot;
    ä½¿ç”¨ NumPy å®ç°æ­£å¼¦ä½ç½®ç¼–ç  / Sinusoidal PE using NumPy

    è¿™ä¸ªå®ç°æ›´æ¸…æ™°åœ°å±•ç¤ºäº†è®¡ç®—è¿‡ç¨‹
    This implementation more clearly shows the computation process

    å‚æ•° / Args:
        seq_len: åºåˆ—é•¿åº¦ / Sequence length
        d_model: æ¨¡å‹ç»´åº¦ / Model dimension

    è¿”å› / Returns:
        ä½ç½®ç¼–ç çŸ©é˜µ (seq_len, d_model) / Positional encoding matrix
    &quot;&quot;&quot;</span>
    <span class="hljs-comment"># åˆå§‹åŒ–ç¼–ç çŸ©é˜µ / Initialize encoding matrix</span>
    pe = np.zeros((seq_len, d_model))

    <span class="hljs-comment"># å¯¹æ¯ä¸ªä½ç½® / For each position</span>
    <span class="hljs-keyword">for</span> pos <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(seq_len):
        <span class="hljs-comment"># å¯¹æ¯ä¸ªç»´åº¦ / For each dimension</span>
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(d_model // <span class="hljs-number">2</span>):
            <span class="hljs-comment"># è®¡ç®—é¢‘ç‡é¡¹ / Compute frequency term</span>
            <span class="hljs-comment"># freq = 1 / (10000^(2i/d_model))</span>
            freq = <span class="hljs-number">1.0</span> / (<span class="hljs-number">10000</span> ** (<span class="hljs-number">2</span> * i / d_model))

            <span class="hljs-comment"># å¶æ•°ç»´åº¦ä½¿ç”¨ sin / Even dimensions use sin</span>
            pe[pos, <span class="hljs-number">2</span>*i] = np.sin(pos * freq)

            <span class="hljs-comment"># å¥‡æ•°ç»´åº¦ä½¿ç”¨ cos / Odd dimensions use cos</span>
            pe[pos, <span class="hljs-number">2</span>*i + <span class="hljs-number">1</span>] = np.cos(pos * freq)

    <span class="hljs-keyword">return</span> pe


<span class="hljs-comment"># ä½¿ç”¨ NumPy å®ç° / Using NumPy implementation</span>
pe_numpy = get_positional_encoding_numpy(<span class="hljs-number">10</span>, <span class="hljs-number">512</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nNumPy å®ç°çš„ç¼–ç çŸ©é˜µå½¢çŠ¶ / NumPy PE matrix shape: <span class="hljs-subst">{pe_numpy.shape}</span>&quot;</span>)

<span class="hljs-comment"># éªŒè¯ NumPy å’Œ PyTorch å®ç°çš„ä¸€è‡´æ€§</span>
<span class="hljs-comment"># Verify consistency between NumPy and PyTorch implementations</span>
pe_torch = pos_encoder.pe[<span class="hljs-number">0</span>, :<span class="hljs-number">10</span>, :].numpy()
difference = np.<span class="hljs-built_in">abs</span>(pe_numpy - pe_torch).<span class="hljs-built_in">max</span>()
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;NumPy å’Œ PyTorch å®ç°çš„æœ€å¤§å·®å¼‚ / Max difference: <span class="hljs-subst">{difference:<span class="hljs-number">.10</span>f}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 8. é•¿åº¦å¤–æ¨èƒ½åŠ› / Length Extrapolation Capability</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">test_extrapolation</span>(<span class="hljs-params">d_model=<span class="hljs-number">512</span>, train_len=<span class="hljs-number">100</span>, test_lengths=[<span class="hljs-number">150</span>, <span class="hljs-number">200</span>, <span class="hljs-number">500</span>]</span>):
    <span class="hljs-string">&quot;&quot;&quot;
    æµ‹è¯•æ­£å¼¦ç¼–ç çš„é•¿åº¦å¤–æ¨èƒ½åŠ› / Test extrapolation capability

    æ­£å¼¦ç¼–ç ç†è®ºä¸Šå¯ä»¥å¤„ç†ä»»æ„é•¿åº¦çš„åºåˆ—
    Sinusoidal encoding can theoretically handle sequences of any length

    å‚æ•° / Args:
        d_model: æ¨¡å‹ç»´åº¦ / Model dimension
        train_len: è®­ç»ƒæ—¶çš„æœ€å¤§é•¿åº¦ / Maximum length during training
        test_lengths: æµ‹è¯•é•¿åº¦åˆ—è¡¨ / List of test lengths
    &quot;&quot;&quot;</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">60</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;é•¿åº¦å¤–æ¨æµ‹è¯• / Length Extrapolation Test&quot;</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">60</span>)

    <span class="hljs-comment"># åˆ›å»ºä¸€ä¸ªæ”¯æŒé•¿åºåˆ—çš„ç¼–ç å™¨ / Create encoder supporting long sequences</span>
    pe = SinusoidalPositionalEncoding(d_model, max_len=<span class="hljs-built_in">max</span>(test_lengths) + <span class="hljs-number">100</span>)

    <span class="hljs-comment"># æµ‹è¯•ä¸åŒé•¿åº¦ / Test different lengths</span>
    <span class="hljs-keyword">for</span> length <span class="hljs-keyword">in</span> [train_len] + test_lengths:
        x = torch.randn(<span class="hljs-number">1</span>, length, d_model)
        output = pe(x)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  é•¿åº¦ <span class="hljs-subst">{length}</span>: ç¼–ç æˆåŠŸ / Encoding successful, è¾“å‡ºå½¢çŠ¶ / output shape: <span class="hljs-subst">{output.shape}</span>&quot;</span>)


test_extrapolation()

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># æ€»ç»“ / Summary</span>
<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-string">&quot;&quot;&quot;
æœ¬ç¤ºä¾‹å±•ç¤ºäº†æ­£å¼¦ä½ç½®ç¼–ç çš„å®Œæ•´å®ç°å’Œåˆ†æ:
This example demonstrates complete implementation and analysis of sinusoidal PE:

1. åŸºæœ¬å®ç° / Basic Implementation
   - ä½¿ç”¨ sin/cos å‡½æ•°ç”Ÿæˆç¼–ç  / Generate encoding using sin/cos functions
   - ä¸åŒç»´åº¦ä½¿ç”¨ä¸åŒé¢‘ç‡ / Different dimensions use different frequencies

2. å…³é”®ç‰¹æ€§ / Key Properties
   - å”¯ä¸€æ€§: æ¯ä¸ªä½ç½®ç¼–ç å”¯ä¸€ / Uniqueness: each position has unique encoding
   - æœ‰ç•Œæ€§: å€¼åœ¨ [-1, 1] èŒƒå›´å†… / Bounded: values in [-1, 1]
   - è¿ç»­æ€§: ç›¸é‚»ä½ç½®ç¼–ç ç›¸ä¼¼ / Continuity: adjacent positions have similar encodings
   - å¤–æ¨æ€§: å¯å¤„ç†ä»»æ„é•¿åº¦åºåˆ— / Extrapolation: can handle any sequence length

3. ä¸è¯åµŒå…¥ç»“åˆ / Combining with Word Embeddings
   - è¾“å…¥ = è¯åµŒå…¥ * sqrt(d_model) + ä½ç½®ç¼–ç 
   - Input = Word Embedding * sqrt(d_model) + Positional Encoding

4. åº”ç”¨åœºæ™¯ / Use Cases
   - Transformer ç¼–ç å™¨è¾“å…¥ / Transformer encoder input
   - ä»»ä½•éœ€è¦ä½ç½®ä¿¡æ¯çš„åºåˆ—æ¨¡å‹ / Any sequence model needing position info

ä¸å¯å­¦ä¹ ä½ç½®ç¼–ç çš„æ¯”è¾ƒ / Comparison with Learnable Positional Encoding:
| ç‰¹æ€§ | æ­£å¼¦ç¼–ç  | å¯å­¦ä¹ ç¼–ç  |
|------|----------|------------|
| å‚æ•°é‡ | 0 | max_len * d_model |
| å¤–æ¨èƒ½åŠ› | å¼º | å¼±ï¼ˆå—é™äºè®­ç»ƒé•¿åº¦ï¼‰|
| çµæ´»æ€§ | å›ºå®š | å¯é€‚åº”æ•°æ® |
&quot;&quot;&quot;</span>
</code></pre></div></div></div><div class="chapter"><h1>ç¬¬3ç«  Normalization å½’ä¸€åŒ–</h1><h1>å½’ä¸€åŒ–ï¼ˆNormalizationï¼‰ï¿½ï¿½ï¿½æ™®ç‰ˆ</h1>
<blockquote>
<p>é¢å‘é›¶åŸºç¡€è¯»è€…çš„å½’ä¸€åŒ–å…¥é—¨æŒ‡å—</p>
</blockquote>
<h2>ä¸€å¥è¯æ¦‚æ‹¬</h2>
<p><strong>å½’ä¸€åŒ–å°±æ˜¯æŠŠæ•°æ®&quot;æ ‡å‡†åŒ–&quot;ï¼Œè®©æ•°å€¼ä¿æŒåœ¨åˆç†èŒƒå›´å†…ï¼Œå¸®åŠ©æ¨¡å‹æ›´å¥½åœ°å­¦ä¹ ã€‚</strong></p>
<h2>ä»ä¸€ä¸ªé—®é¢˜å¼€å§‹</h2>
<p>æƒ³è±¡ä½ åœ¨è€ƒè¯•ï¼š</p>
<ul>
<li>è¯­æ–‡è€ƒäº† 80 åˆ†ï¼ˆæ»¡åˆ† 100ï¼‰</li>
<li>æ•°å­¦è€ƒäº† 8 åˆ†ï¼ˆæ»¡åˆ† 10ï¼‰</li>
</ul>
<p>å“ªä¸ªæˆç»©æ›´å¥½ï¼Ÿ</p>
<p>å®é™…ä¸Šéƒ½æ˜¯ 80%ï¼Œä½†ç›´æ¥çœ‹åˆ†æ•°ï¼Œ8 å’Œ 80 å·®è·å¾ˆå¤§ã€‚å¦‚æœè®©è®¡ç®—æœºå¤„ç†ï¼Œå®ƒå¯èƒ½ä¼šè®¤ä¸ºè¯­æ–‡æˆç»©&quot;è¿œå¥½äº&quot;æ•°å­¦æˆç»©ã€‚</p>
<p><strong>å½’ä¸€åŒ–å°±æ˜¯è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼šæŠŠä¸åŒèŒƒå›´çš„æ•°æ®æ”¾åˆ°åŒä¸€ä¸ª&quot;å°ºåº¦&quot;ä¸Šæ¯”è¾ƒã€‚</strong></p>
<h2>æ ¸å¿ƒæ€æƒ³ï¼šç»Ÿä¸€æ ‡å‡†</h2>
<h3>ç”Ÿæ´»ä¸­çš„å½’ä¸€åŒ–</h3>
<p>æˆ‘ä»¬æ—¥å¸¸ç”Ÿæ´»ï¿½ï¿½å…¶å®ç»å¸¸åšå½’ä¸€åŒ–ï¼š</p>
<ul>
<li><strong>ç™¾åˆ†åˆ¶</strong>ï¼šæŠŠä¸åŒæ»¡åˆ†çš„è€ƒè¯•éƒ½æ¢ç®—æˆ 100 åˆ†</li>
<li><strong>æ±‡ç‡æ¢ç®—</strong>ï¼šæŠŠä¸åŒè´§å¸æ¢ç®—æˆåŒä¸€ç§è´§å¸æ¯”è¾ƒ</li>
<li><strong>æ¸©åº¦æ¢ç®—</strong>ï¼šæŠŠæ‘„æ°åº¦å’Œåæ°åº¦æ¢ç®—æˆç»Ÿä¸€æ ‡å‡†</li>
</ul>
<h3>ç¥ç»ç½‘ç»œä¸­çš„å½’ä¸€åŒ–</h3>
<p>åœ¨ç¥ç»ç½‘ç»œä¸­ï¼Œæ¯ä¸€å±‚çš„è¾“å…¥æ•°å€¼èŒƒå›´å¯èƒ½å·®å¼‚å¾ˆå¤§ï¼š</p>
<ul>
<li>æœ‰çš„ç‰¹å¾åœ¨ 0 åˆ° 1 ä¹‹é—´</li>
<li>æœ‰çš„ç‰¹å¾åœ¨ -1000 åˆ° 1000 ä¹‹é—´</li>
</ul>
<p>è¿™ä¼šå¯¼è‡´ï¼š</p>
<ol>
<li><strong>å­¦ä¹ å›°éš¾</strong>ï¼šæ¨¡å‹ä¸çŸ¥é“è¯¥&quot;å…³æ³¨&quot;å“ªä¸ªç‰¹å¾</li>
<li><strong>æ¢¯åº¦é—®é¢˜</strong>ï¼šæ•°å€¼å¤ªå¤§æˆ–å¤ªå°ï¼Œå¯¼è‡´è®­ç»ƒä¸ç¨³å®š</li>
</ol>
<p>å½’ä¸€åŒ–çš„åšæ³•æ˜¯ï¼š<strong>æŠŠæ•°æ®è°ƒæ•´åˆ°ç›¸ä¼¼çš„èŒƒå›´å†…</strong>ï¼Œè®©æ¨¡å‹æ›´å®¹æ˜“å­¦ä¹ ã€‚</p>
<h2>å¸¸è§çš„å½’ä¸€åŒ–æ–¹æ³•</h2>
<h3>1. Batch Normalizationï¼ˆæ‰¹å½’ä¸€åŒ–ï¼‰</h3>
<p>æƒ³è±¡ä¸€ä¸ªç­çº§è€ƒè¯•ï¼š</p>
<ul>
<li>æŠŠå…¨ç­çš„æˆç»©ï¼Œè°ƒæ•´æˆå¹³å‡åˆ† 0ï¼Œæ ‡å‡†å·® 1</li>
<li>è¿™æ ·æ¯ä¸ªäººçš„æˆç»©å°±æ˜¯&quot;æ¯”å¹³å‡é«˜å¤šå°‘&quot;æˆ–&quot;æ¯”å¹³å‡ä½å¤šå°‘&quot;</li>
</ul>
<p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šå›¾åƒè¯†åˆ«ç­‰è®¡ç®—æœºè§†è§‰ä»»åŠ¡</p>
<h3>2. Layer Normalizationï¼ˆå±‚å½’ä¸€åŒ–ï¼‰</h3>
<p>æƒ³è±¡ä¸€ä¸ªäººçš„å„ç§‘æˆç»©ï¼š</p>
<ul>
<li>æŠŠè¿™ä¸ªäººçš„è¯­æ–‡ã€æ•°å­¦ã€è‹±è¯­æˆç»©ï¼Œè°ƒæ•´æˆå¹³å‡åˆ† 0ï¼Œæ ‡å‡†å·® 1</li>
<li>ä¸çœ‹åˆ«äººçš„æˆç»©ï¼Œåªçœ‹è‡ªå·±çš„å„ç§‘æˆç»©</li>
</ul>
<p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šè‡ªç„¶è¯­è¨€å¤„ç†ã€Transformerã€LLM</p>
<h3>3. RMS Normalizationï¼ˆå‡æ–¹æ ¹å½’ä¸€åŒ–ï¼‰</h3>
<p>LayerNorm çš„ç®€åŒ–ç‰ˆæœ¬ï¼š</p>
<ul>
<li>ä¸è®¡ç®—å¹³å‡å€¼ï¼Œåªçœ‹æ•°æ®çš„&quot;æ³¢åŠ¨ç¨‹åº¦&quot;</li>
<li>è®¡ç®—æ›´ç®€å•ï¼Œæ•ˆæœç›¸è¿‘</li>
</ul>
<p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šç°ä»£ LLMï¼ˆå¦‚ LLaMAã€GPT-NeoXï¼‰</p>
<h2>ä¸ºä»€ä¹ˆ Transformer ç”¨ LayerNormï¼Ÿ</h2>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>å½’ä¸€åŒ–ç»´åº¦</th>
<th>é€‚åˆåœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td>BatchNorm</td>
<td>è·¨æ ·æœ¬</td>
<td>å›¾åƒï¼ˆå›ºå®šå°ºå¯¸ï¼‰</td>
</tr>
<tr>
<td>LayerNorm</td>
<td>å•æ ·æœ¬å†…</td>
<td>æ–‡æœ¬ï¼ˆå˜é•¿åºåˆ—ï¼‰</td>
</tr>
</tbody>
</table>
<p>æ–‡æœ¬åºåˆ—é•¿åº¦ä¸å›ºå®šï¼ŒBatchNorm å¤„ç†èµ·æ¥å¾ˆéº»çƒ¦ã€‚LayerNorm å¯¹æ¯ä¸ªæ ·æœ¬ç‹¬ç«‹å¤„ç†ï¼Œå®Œç¾é€‚é… NLP ä»»åŠ¡ã€‚</p>
<h2>ä¸€ä¸ªç›´è§‚çš„ä¾‹å­</h2>
<p>å‡è®¾æœ‰ä¸€ä¸ªå¥å­ â€œæˆ‘ çˆ± ç¼–ç¨‹â€ï¼Œæ¯ä¸ªè¯ç”¨ 3 ç»´å‘é‡è¡¨ç¤ºï¼š</p>
<pre class="hljs"><code>åŸå§‹å‘é‡:
æˆ‘: [10, 0.1, -5]
çˆ±: [0.5, 8, 0.2]
ç¼–ç¨‹: [-3, 0.01, 12]
</code></pre>
<p>æ•°å€¼èŒƒå›´å·®å¼‚å¾ˆå¤§ï¼ˆ0.01 åˆ° 12ï¼‰ï¼ŒLayerNorm å¤„ç†åï¼š</p>
<pre class="hljs"><code>å½’ä¸€åŒ–å:
æˆ‘: [1.2, -0.5, -0.7]
çˆ±: [-0.6, 1.1, -0.5]
ç¼–ç¨‹: [-0.8, -0.6, 1.4]
</code></pre>
<p>ç°åœ¨æ•°å€¼éƒ½åœ¨ -1.5 åˆ° 1.5 ä¹‹é—´ï¼Œæ¨¡å‹æ›´å®¹æ˜“å­¦ä¹ ã€‚</p>
<h2>æ€»ç»“</h2>
<table>
<thead>
<tr>
<th>æ¦‚å¿µ</th>
<th>é€šä¿—ç†è§£</th>
</tr>
</thead>
<tbody>
<tr>
<td>å½’ä¸€åŒ–</td>
<td>ç»Ÿä¸€æ•°æ®çš„æ ‡å‡†</td>
</tr>
<tr>
<td>BatchNorm</td>
<td>çœ‹å…¨ç­æˆç»©è°ƒæ•´</td>
</tr>
<tr>
<td>LayerNorm</td>
<td>çœ‹è‡ªå·±å„ç§‘æˆç»©è°ƒæ•´</td>
</tr>
<tr>
<td>RMSNorm</td>
<td>ç®€åŒ–ç‰ˆçš„ LayerNorm</td>
</tr>
</tbody>
</table>
<h2>ä¸‹ä¸€æ­¥</h2>
<ul>
<li>æƒ³äº†è§£æ•°å­¦åŸç†ï¼Ÿé˜…è¯» <a href="advanced-guide.md">æ·±å…¥ç‰ˆ</a></li>
<li>æƒ³çœ‹ä»£ç å®ç°ï¼ŸæŸ¥çœ‹ <code>examples/</code> ç›®å½•</li>
</ul>
<h1>å½’ä¸€åŒ–ï¼ˆNormalizationï¼‰æ·±å…¥ç‰ˆ</h1>
<blockquote>
<p>é¢å‘æœ‰æœºå™¨å­¦ä¹ åŸºç¡€è¯»è€…çš„æŠ€æœ¯è¯¦è§£</p>
</blockquote>
<h2>æ¦‚è¿°</h2>
<p>å½’ä¸€åŒ–æŠ€æœ¯æ˜¯æ·±åº¦å­¦ä¹ ä¸­ç¨³å®šè®­ç»ƒã€åŠ é€Ÿæ”¶æ•›çš„å…³é”®ç»„ä»¶ã€‚æœ¬æ–‡æ·±å…¥åˆ†æ BatchNormã€LayerNorm å’Œ RMSNorm çš„æ•°å­¦åŸç†åŠå…¶åœ¨ LLM ä¸­çš„åº”ç”¨ã€‚</p>
<h2>ä¸ºä»€ä¹ˆéœ€è¦å½’ä¸€åŒ–ï¼Ÿ</h2>
<h3>å†…éƒ¨åå˜é‡åç§» (Internal Covariate Shift)</h3>
<p>æ·±å±‚ç½‘ç»œä¸­ï¼Œæ¯å±‚è¾“å…¥çš„åˆ†å¸ƒåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ä¸æ–­å˜åŒ–ï¼Œå¯¼è‡´ï¼š</p>
<ol>
<li>åå±‚éœ€è¦ä¸æ–­é€‚åº”æ–°çš„è¾“å…¥åˆ†å¸ƒ</li>
<li>å­¦ä¹ ç‡éœ€è¦è®¾ç½®å¾—å¾ˆå°</li>
<li>è®­ç»ƒæ”¶æ•›æ…¢ï¼Œå®¹æ˜“é™·å…¥é¥±å’ŒåŒº</li>
</ol>
<p>å½’ä¸€åŒ–é€šè¿‡ç¨³å®šæ¯å±‚è¾“å…¥çš„åˆ†å¸ƒæ¥ç¼“è§£è¿™ä¸ªé—®é¢˜ã€‚</p>
<h2>Batch Normalization</h2>
<h3>æ•°å­¦å®šä¹‰</h3>
<p>å¯¹äº mini-batch ä¸­çš„ç¬¬ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> ä¸ªæ ·æœ¬çš„ç¬¬ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> ç»´ç‰¹å¾ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">x</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.3903em;vertical-align:-1.13em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.2603em;"><span style="top:-2.1777em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9323em;"><span class="svg-align" style="top:-3.2em;"><span class="pstrut" style="height:3.2em;"></span><span class="mord" style="padding-left:1em;"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7959em;"><span style="top:-2.3987em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.0448em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3013em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">Ïµ</span></span></span><span style="top:-2.8923em;"><span class="pstrut" style="height:3.2em;"></span><span class="hide-tail" style="min-width:1.02em;height:1.28em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.28em" viewBox="0 0 400000 1296" preserveAspectRatio="xMinYMin slice"><path d="M263,681c0.7,0,18,39.7,52,119
c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120
c340,-704.7,510.7,-1060.3,512,-1067
l0 -0
c4.7,-7.3,11,-11,19,-11
H40000v40H1012.3
s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232
c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1
s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26
c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z
M1001 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3077em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">Î¼</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.13em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><a id="formula-normalization-1"></a>
<a href="#formula-normalization-1-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05556em;">Î³</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0556em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">x</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">Î²</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p><a id="formula-normalization-2"></a>
<a href="#formula-normalization-2-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šå¯¹æ¯ä¸ªç‰¹å¾ç»´åº¦ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span>ï¼Œå‡å» batch å†…å‡å€¼ã€é™¤ä»¥æ ‡å‡†å·®ï¼Œå†ç¼©æ”¾å¹³ç§»ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0972em;vertical-align:-0.2831em;"></span><span class="mord"><span class="mord mathnormal">Î¼</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4169em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2831em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºç¬¬ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> ç»´åœ¨ batch å†…çš„å‡å€¼å’Œæ–¹å·®ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05556em;">Î³</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0556em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">Î²</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºå¯å­¦ä¹ çš„ç¼©æ”¾å’Œåç§»å‚æ•°ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šå°†æ¯ç»´ç‰¹å¾å½’ä¸€åŒ–åˆ°æ ‡å‡†åˆ†å¸ƒï¼Œå†é€šè¿‡ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">Î³</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.05278em;">Î²</span></span></span></span> æ¢å¤è¡¨è¾¾èƒ½åŠ›ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">Ïµ</span></span></span></span> é˜²æ­¢é™¤é›¶ã€‚</li>
</ul>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">Î¼</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1901em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">âˆ‘</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>ï¼ˆbatch å†…ç¬¬ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> ç»´çš„å‡å€¼ï¼‰</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0972em;vertical-align:-0.2831em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4169em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2831em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1901em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">âˆ‘</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">Î¼</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span>ï¼ˆbatch å†…ç¬¬ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> ç»´çš„æ–¹å·®ï¼‰</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05556em;">Î³</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0556em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">Î²</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> æ˜¯å¯å­¦ä¹ å‚æ•°</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">Ïµ</span></span></span></span> æ˜¯æ•°å€¼ç¨³å®šæ€§å¸¸æ•°ï¼ˆå¦‚ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">âˆ’</span><span class="mord mtight">5</span></span></span></span></span></span></span></span></span></span></span></span>ï¼‰</li>
</ul>
<h3>ç‰¹ç‚¹</h3>
<ul>
<li><strong>å½’ä¸€åŒ–æ–¹å‘</strong>ï¼šæ²¿ batch ç»´åº¦</li>
<li><strong>è®­ç»ƒ/æ¨ç†å·®å¼‚</strong>ï¼šæ¨ç†æ—¶ä½¿ç”¨è®­ç»ƒæ—¶ç´¯ç§¯çš„ running mean/var</li>
<li><strong>ä¾èµ– batch size</strong>ï¼šå° batch æ•ˆæœå·®</li>
</ul>
<h3>æ¢¯åº¦è®¡ç®—</h3>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.2074em;vertical-align:-0.836em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="mord mathnormal">L</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.1638em;vertical-align:-1.4138em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em;"><span style="top:-2.1966em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9134em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">Ïµ</span></span></span><span style="top:-2.8734em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1266em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05556em;">Î³</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="mord mathnormal">L</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.8804em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">m</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.4138em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="mord mathnormal">L</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.9721em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">m</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">x</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.4138em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="mord mathnormal">L</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.9721em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">x</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size4">)</span></span></span></span></span></span></span></p>
<p><a id="formula-normalization-3"></a>
<a href="#formula-normalization-3-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šBatchNorm åå‘ä¼ æ’­æ—¶ï¼Œæ¢¯åº¦ä¸ä»…ä¾èµ–è‡ªèº«è¾“å‡ºï¼Œè¿˜ä¸ batch å†…æ‰€æœ‰æ ·æœ¬ç›¸å…³ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span> ä¸º batch å¤§å°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">x</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºå½’ä¸€åŒ–åçš„å€¼ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="mord mathnormal">L</span><span class="mord">/</span><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºä¸Šæ¸¸æ¢¯åº¦ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šå½’ä¸€åŒ–æ“ä½œçš„æ¢¯åº¦ä¼š&quot;åˆ†æ•£&quot;åˆ°æ•´ä¸ª batchï¼Œå¢åŠ è®­ç»ƒçš„æ­£è§„åŒ–æ•ˆæœã€‚</li>
</ul>
<h2>Layer Normalization</h2>
<h3>æ•°å­¦å®šä¹‰</h3>
<p>å¯¹å•ä¸ªæ ·æœ¬çš„æ‰€æœ‰ç‰¹å¾è¿›è¡Œå½’ä¸€åŒ–ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Î¼</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.106em;vertical-align:-1.2777em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.08125em;">H</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p><a id="formula-normalization-4"></a>
<a href="#formula-normalization-4-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8641em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.106em;vertical-align:-1.2777em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.08125em;">H</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.1141em;vertical-align:-0.25em;"></span><span class="mord mathnormal">Î¼</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><a id="formula-normalization-5"></a>
<a href="#formula-normalization-5-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0376em;vertical-align:-0.93em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em;"><span style="top:-2.1966em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9134em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">Ïµ</span></span></span><span style="top:-2.8734em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1266em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05556em;">Î³</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âŠ™</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">Î¼</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05278em;">Î²</span></span></span></span></span></p>
<p><a id="formula-normalization-6"></a>
<a href="#formula-normalization-6-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šå¯¹å•ä¸ªæ ·æœ¬çš„æ‰€æœ‰ç‰¹å¾ç»´è®¡ç®—å‡å€¼å’Œæ–¹å·®ï¼Œç„¶åå½’ä¸€åŒ–ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span></span></span></span> ä¸ºç‰¹å¾ç»´åº¦æ•°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0085em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Î¼</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span> ä¸ºå•æ ·æœ¬å†…çš„ç»Ÿè®¡é‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">Î³</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.05278em;">Î²</span></span></span></span> ä¸ºå¯å­¦ä¹ å‚æ•°ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šä¸ BatchNorm ä¸åŒï¼Œä¸ä¾èµ– batch å¤§å°ï¼Œé€‚åˆåºåˆ—æ¨¡å‹å’Œ NLP ä»»åŠ¡ã€‚</li>
</ul>
<p>å…¶ä¸­ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span></span></span></span> æ˜¯ç‰¹å¾ç»´åº¦æ•°ã€‚</p>
<h3>ä¸ BatchNorm çš„åŒºåˆ«</h3>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>BatchNorm</th>
<th>LayerNorm</th>
</tr>
</thead>
<tbody>
<tr>
<td>å½’ä¸€åŒ–ç»´åº¦</td>
<td>batch ç»´</td>
<td>feature ç»´</td>
</tr>
<tr>
<td>å¯¹ batch size ä¾èµ–</td>
<td>å¼º</td>
<td>æ— </td>
</tr>
<tr>
<td>è®­ç»ƒ/æ¨ç†å·®å¼‚</td>
<td>æœ‰</td>
<td>æ— </td>
</tr>
<tr>
<td>é€‚ç”¨åœºæ™¯</td>
<td>CV</td>
<td>NLP/Transformer</td>
</tr>
</tbody>
</table>
<h3>Transformer ä¸­çš„åº”ç”¨</h3>
<p>åœ¨ Transformer ä¸­ï¼ŒLayerNorm é€šå¸¸æœ‰ä¸¤ç§ä½ç½®ï¼š</p>
<ol>
<li>
<p><strong>Post-LN</strong>ï¼ˆåŸå§‹ Transformerï¼‰ï¼š</p>
<pre class="hljs"><code>x = LayerNorm(x + Sublayer(x))
</code></pre>
</li>
<li>
<p><strong>Pre-LN</strong>ï¼ˆç°ä»£ Transformerï¼‰ï¼š</p>
<pre class="hljs"><code>x = x + Sublayer(LayerNorm(x))
</code></pre>
</li>
</ol>
<p>Pre-LN è®­ç»ƒæ›´ç¨³å®šï¼Œæ¢¯åº¦æ›´å¹³æ»‘ã€‚</p>
<h2>RMS Normalization</h2>
<h3>æ•°å­¦å®šä¹‰</h3>
<p>RMSNorm ç®€åŒ–äº† LayerNormï¼Œå»æ‰äº†å‡å€¼ä¸­å¿ƒåŒ–ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">RMS</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.3338em;vertical-align:-1.2777em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.0561em;"><span class="svg-align" style="top:-5.2938em;"><span class="pstrut" style="height:5.2938em;"></span><span class="mord" style="padding-left:1.056em;"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.08125em;">H</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7959em;"><span style="top:-2.4231em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.0448em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2769em;"><span></span></span></span></span></span></span></span></span><span style="top:-4.0161em;"><span class="pstrut" style="height:5.2938em;"></span><span class="hide-tail" style="min-width:0.742em;height:3.3738em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="3.3738em" viewBox="0 0 400000 3373" preserveAspectRatio="xMinYMin slice"><path d="M702 80H40000040
H742v3239l-4 4-4 4c-.667.7 -2 1.5-4 2.5s-4.167 1.833-6.5 2.5-5.5 1-9.5 1
h-12l-28-84c-16.667-52-96.667 -294.333-240-727l-212 -643 -85 170
c-4-3.333-8.333-7.667-13 -13l-13-13l77-155 77-156c66 199.333 139 419.667
219 661 l218 661zM702 80H400000v40H742z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span></span></span></span></span></p>
<p><a id="formula-normalization-7"></a>
<a href="#formula-normalization-7-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0436em;vertical-align:-0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord text"><span class="mord">RMS</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">x</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">Î³</span></span></span></span></span></p>
<p><a id="formula-normalization-8"></a>
<a href="#formula-normalization-8-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šåªç”¨å‡æ–¹ï¿½ï¿½å½’ä¸€åŒ–ï¼Œçœå»å‡å€¼è®¡ç®—ï¼Œå†ä¹˜ä»¥å¯å­¦ä¹ ç¼©æ”¾å› å­ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">RMS</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> ä¸ºå‡æ–¹æ ¹å€¼ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">Î³</span></span></span></span> ä¸ºç¼©æ”¾å‚æ•°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span></span></span></span> ä¸ºç‰¹å¾ç»´åº¦æ•°ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šç®€åŒ–è®¡ç®—ä½†ä¿æŒå½’ä¸€åŒ–æ•ˆæœï¼ŒLLaMA ç­‰ç°ä»£ LLM å¹¿æ³›ä½¿ç”¨ã€‚</li>
</ul>
<p>æˆ–ç­‰ä»·åœ°ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.8376em;vertical-align:-1.73em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em;"><span style="top:-2.11em;"><span class="pstrut" style="height:3.3031em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3031em;"><span class="svg-align" style="top:-3.8em;"><span class="pstrut" style="height:3.8em;"></span><span class="mord" style="padding-left:1em;"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.08125em;">H</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">âˆ‘</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.08125em;">H</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7959em;"><span style="top:-2.4231em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.0448em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2769em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">Ïµ</span></span></span><span style="top:-3.2631em;"><span class="pstrut" style="height:3.8em;"></span><span class="hide-tail" style="min-width:1.02em;height:1.88em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.88em" viewBox="0 0 400000 1944" preserveAspectRatio="xMinYMin slice"><path d="M983 90
l0 -0
c4,-6.7,10,-10,18,-10 H400000v40
H1013.1s-83.4,268,-264.1,840c-180.7,572,-277,876.3,-289,913c-4.7,4.7,-12.7,7,-24,7
s-12,0,-12,0c-1.3,-3.3,-3.7,-11.7,-7,-25c-35.3,-125.3,-106.7,-373.3,-214,-744
c-10,12,-21,25,-33,39s-32,39,-32,39c-6,-5.3,-15,-14,-27,-26s25,-30,25,-30
c26.7,-32.7,52,-63,76,-91s52,-60,52,-60s208,722,208,722
c56,-175.3,126.3,-397.3,211,-666c84.7,-268.7,153.8,-488.2,207.5,-658.5
c53.7,-170.3,84.5,-266.8,92.5,-289.5z
M1001 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.5369em;"><span></span></span></span></span></span></span></span><span style="top:-3.5331em;"><span class="pstrut" style="height:3.3031em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.9801em;"><span class="pstrut" style="height:3.3031em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05556em;">Î³</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.73em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span></span></p>
<p><a id="formula-normalization-9"></a>
<a href="#formula-normalization-9-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šå°† RMSNorm å†™æˆä¸ LayerNorm ç±»ä¼¼çš„å½¢å¼ï¼Œæ–¹ä¾¿å¯¹æ¯”ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼šåˆ†æ¯æ˜¯å‡æ–¹æ ¹åŠ  <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">Ïµ</span></span></span></span>ï¼Œåˆ†å­æ˜¯ç¼©æ”¾å‚æ•° <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">Î³</span></span></span></span>ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šä¸ LayerNorm çš„åŒºåˆ«åœ¨äºæ²¡æœ‰ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">Î¼</span><span class="mclose">)</span></span></span></span>ï¼Œå³ä¸åšä¸­å¿ƒåŒ–ã€‚</li>
</ul>
<h3>ä¸ºä»€ä¹ˆ RMSNorm æœ‰æ•ˆï¼Ÿ</h3>
<ol>
<li><strong>ç†è®ºåˆ†æ</strong>ï¼šä¸­å¿ƒåŒ–æ“ä½œå¯¹äºå†ç¼©æ”¾ï¼ˆre-scalingï¼‰ä¸å˜æ€§å¹¶éå¿…éœ€</li>
<li><strong>è®¡ç®—æ•ˆç‡</strong>ï¼šçœå»å‡å€¼è®¡ç®—ï¼Œå‡å°‘çº¦ 25% è®¡ç®—é‡</li>
<li><strong>å®è·µæ•ˆæœ</strong>ï¼šåœ¨ LLM ä¸­æ•ˆæœä¸ LayerNorm ç›¸å½“æˆ–æ›´å¥½</li>
</ol>
<h3>LLaMA ä¸­çš„ RMSNorm å®ç°</h3>
<pre class="hljs"><code><span class="hljs-keyword">class</span> <span class="hljs-title class_">RMSNorm</span>(nn.Module):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, dim, eps=<span class="hljs-number">1e-6</span></span>):
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-variable language_">self</span>.eps = eps
        <span class="hljs-variable language_">self</span>.weight = nn.Parameter(torch.ones(dim))

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-comment"># x: [batch, seq_len, dim]</span>
        rms = torch.sqrt(torch.mean(x ** <span class="hljs-number">2</span>, dim=-<span class="hljs-number">1</span>, keepdim=<span class="hljs-literal">True</span>) + <span class="hljs-variable language_">self</span>.eps)
        <span class="hljs-keyword">return</span> x / rms * <span class="hljs-variable language_">self</span>.weight
</code></pre>
<h2>æ•°å€¼ç¨³å®šæ€§</h2>
<h3>Epsilon çš„é‡è¦æ€§</h3>
<p><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">Ïµ</span></span></span></span> çš„ä½œç”¨æ˜¯é˜²æ­¢é™¤é›¶é”™è¯¯ï¼Œä½†ä¹Ÿå½±å“æ•°å€¼ç²¾åº¦ï¼š</p>
<ul>
<li>å¤ªå¤§ï¼šå½’ä¸€åŒ–æ•ˆæœè¢«å‰Šå¼±</li>
<li>å¤ªå°ï¼šå¯èƒ½å‡ºç°æ•°å€¼ä¸ç¨³å®š</li>
</ul>
<p>å¸¸ç”¨å€¼ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">Ïµ</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">âˆ’</span><span class="mord mtight">5</span></span></span></span></span></span></span></span></span></span></span></span> æˆ– <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">âˆ’</span><span class="mord mtight">6</span></span></span></span></span></span></span></span></span></span></span></span></p>
<h3>æ··åˆç²¾åº¦è®­ç»ƒä¸­çš„å½’ä¸€åŒ–</h3>
<p>åœ¨ FP16 è®­ç»ƒä¸­ï¼Œå½’ä¸€åŒ–å±‚é€šå¸¸ä¿æŒ FP32 ç²¾åº¦ï¼š</p>
<ul>
<li>æ–¹å·®è®¡ç®—æ¶‰åŠå¹³æ–¹ï¼Œå®¹æ˜“æº¢å‡º</li>
<li>é™¤æ³•æ“ä½œéœ€è¦é«˜ç²¾åº¦</li>
</ul>
<h2>ä¸åŒå½’ä¸€åŒ–æ–¹æ³•çš„å¯¹æ¯”</h2>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>å…¬å¼å¤æ‚åº¦</th>
<th>è®¡ç®—é‡</th>
<th>å‚æ•°é‡</th>
<th>LLM ä½¿ç”¨ç‡</th>
</tr>
</thead>
<tbody>
<tr>
<td>BatchNorm</td>
<td>é«˜</td>
<td>ä¸­</td>
<td>2H</td>
<td>ä½</td>
</tr>
<tr>
<td>LayerNorm</td>
<td>ä¸­</td>
<td>ä¸­</td>
<td>2H</td>
<td>ä¸­</td>
</tr>
<tr>
<td>RMSNorm</td>
<td>ä½</td>
<td>ä½</td>
<td>H</td>
<td>é«˜</td>
</tr>
</tbody>
</table>
<h2>å‚è€ƒæ–‡çŒ®</h2>
<ol>
<li>Ioffe &amp; Szegedy (2015). <em>Batch Normalization: Accelerating Deep Network Training by Reducing Internal Covariate Shift</em></li>
<li>Ba et al. (2016). <em>Layer Normalization</em></li>
<li>Zhang &amp; Sennrich (2019). <em>Root Mean Square Layer Normalization</em></li>
<li>Xiong et al. (2020). <em>On Layer Normalization in the Transformer Architecture</em></li>
</ol>
<h1>Normalization æµç¨‹å›¾è§£</h1>
<blockquote>
<p>é€šè¿‡å¯è§†åŒ–å›¾è¡¨ç†è§£å½’ä¸€åŒ–çš„å·¥ä½œæµç¨‹</p>
</blockquote>
<h2>å½’ä¸€åŒ–ä½ç½®</h2>
<p><div class="mermaid">flowchart LR
    subgraph Transformerå±‚
        A["è¾“å…¥"] --&gt; B["Layer Norm"]
        B --&gt; C["Self-Attention"]
        C --&gt; D["æ®‹å·®è¿æ¥"]
        D --&gt; E["Layer Norm"]
        E --&gt; F["FFN"]
        F --&gt; G["æ®‹å·®è¿æ¥"]
        G --&gt; H["è¾“å‡º"]
    end

    style B fill:#fff9c4
    style E fill:#fff9c4</div></p>
<h2>Layer Normalization æµç¨‹</h2>
<p><div class="mermaid">flowchart TB
    A["è¾“å…¥å‘é‡ x&lt;br/&gt;[x1, x2, ..., xd]"] --&gt; B["è®¡ç®—å‡å€¼&lt;br/&gt;Î¼ = mean(x)"]
    A --&gt; C["è®¡ç®—æ–¹å·®&lt;br/&gt;ÏƒÂ² = var(x)"]

    B --&gt; D["æ ‡å‡†åŒ–&lt;br/&gt;(x - Î¼) / âˆš(ÏƒÂ² + Îµ)"]
    C --&gt; D

    D --&gt; E["ç¼©æ”¾å’Œå¹³ç§»&lt;br/&gt;Î³ * x + Î²"]
    E --&gt; F["è¾“å‡º&lt;br/&gt;å½’ä¸€åŒ–åçš„å‘é‡"]

    style F fill:#c8e6c9</div></p>
<h2>Batch Norm vs Layer Norm</h2>
<p><div class="mermaid">flowchart TB
    subgraph BatchNorm
        BN1["æ²¿æ‰¹æ¬¡ç»´åº¦å½’ä¸€åŒ–"]
        BN2["æ¯ç‰¹å¾ä¸€ä¸ªç»Ÿè®¡é‡"]
        BN3["é€‚åˆ CV ä»»åŠ¡"]
        BN1 --&gt; BN2 --&gt; BN3
    end

    subgraph LayerNorm
        LN1["æ²¿ç‰¹å¾ç»´åº¦å½’ä¸€åŒ–"]
        LN2["æ¯æ ·æœ¬ç‹¬ç«‹è®¡ç®—"]
        LN3["é€‚åˆ NLP ä»»åŠ¡"]
        LN1 --&gt; LN2 --&gt; LN3
    end

    style BN3 fill:#bbdefb
    style LN3 fill:#c8e6c9</div></p>
<h2>RMS Norm ç®€åŒ–æµç¨‹</h2>
<p><div class="mermaid">flowchart LR
    A["è¾“å…¥ x"] --&gt; B["è®¡ç®— RMS&lt;br/&gt;âˆš(mean(xÂ²))"]
    B --&gt; C["å½’ä¸€åŒ–&lt;br/&gt;x / RMS"]
    C --&gt; D["ç¼©æ”¾&lt;br/&gt;Î³ * x"]

    style D fill:#c8e6c9</div></p>
<h2>å½’ä¸€åŒ–å¯¹æ¯”</h2>
<p><div class="mermaid">flowchart TB
    subgraph LayerNorm
        L1["è®¡ç®—å‡å€¼å’Œæ–¹å·®"]
        L2["å‡å‡å€¼é™¤æ ‡å‡†å·®"]
        L3["å¯å­¦ä¹ çš„ Î³, Î²"]
    end

    subgraph RMSNorm
        R1["åªè®¡ç®— RMS"]
        R2["é™¤ä»¥ RMS"]
        R3["åªæœ‰ Î³ï¼Œæ—  Î²"]
    end

    subgraph æ•ˆç‡å¯¹æ¯”
        E1["RMSNorm æ›´å¿«&lt;br/&gt;å‡å°‘çº¦ 25% è®¡ç®—"]
    end

    style E1 fill:#c8e6c9</div></p>
<h2>è®­ç»ƒç¨³å®šæ€§</h2>
<p><div class="mermaid">flowchart LR
    subgraph æ— å½’ä¸€åŒ–
        A1["æ¢¯åº¦çˆ†ç‚¸/æ¶ˆå¤±"]
        A2["è®­ç»ƒä¸ç¨³å®š"]
    end

    subgraph æœ‰å½’ä¸€åŒ–
        B1["æ¢¯åº¦ç¨³å®š"]
        B2["æ”¶æ•›æ›´å¿«"]
        B3["æ€§èƒ½æ›´å¥½"]
    end

    style A2 fill:#ffcdd2
    style B3 fill:#c8e6c9</div></p>
<h2>å›¾è§£è¯´æ˜</h2>
<h3>å…³é”®æ¦‚å¿µ</h3>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>å…¬å¼</th>
<th>ç‰¹ç‚¹</th>
</tr>
</thead>
<tbody>
<tr>
<td>Layer Norm</td>
<td>(x-Î¼)/Ïƒ * Î³ + Î²</td>
<td>NLP å¸¸ç”¨</td>
</tr>
<tr>
<td>RMS Norm</td>
<td>x/RMS * Î³</td>
<td>LLaMA ä½¿ç”¨</td>
</tr>
<tr>
<td>Batch Norm</td>
<td>æ²¿æ‰¹æ¬¡å½’ä¸€åŒ–</td>
<td>CV å¸¸ç”¨</td>
</tr>
</tbody>
</table>
<h3>é€‰æ‹©å»ºè®®</h3>
<ul>
<li><strong>Transformer NLP</strong>: Layer Norm æˆ– RMS Norm</li>
<li><strong>LLaMA ç±»æ¨¡å‹</strong>: RMS Normï¼ˆæ›´å¿«ï¼‰</li>
<li><strong>CNN è§†è§‰</strong>: Batch Norm</li>
</ul>
<div class="code-appendix page-break"><h2>é™„å½•ï¼šä»£ç ç¤ºä¾‹</h2><div class="code-file"><h3>layernorm_example.py</h3><pre class="hljs"><code><span class="hljs-string">&quot;&quot;&quot;
Layer Normalization ç¤ºä¾‹ä»£ç  / Layer Normalization Example Code
==============================================================

æœ¬ç¤ºä¾‹å±•ç¤º Layer Normalization çš„åŸç†å’Œå®ç°ã€‚
This example demonstrates the principle and implementation of Layer Normalization.

LayerNorm æ˜¯ Transformer å’Œ LLM ä¸­æœ€å¸¸ç”¨çš„å½’ä¸€åŒ–æ–¹æ³•ã€‚
LayerNorm is the most commonly used normalization method in Transformer and LLM.

ä¾èµ–å®‰è£… / Dependencies:
    pip install torch matplotlib
&quot;&quot;&quot;</span>

<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 1. LayerNorm æ‰‹åŠ¨å®ç° / Manual Implementation of LayerNorm</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">LayerNormManual</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;
    æ‰‹åŠ¨å®ç°çš„ Layer Normalization / Manual implementation of Layer Normalization

    æ•°å­¦å…¬å¼ / Mathematical formula:
        y = (x - mean) / sqrt(var + eps) * gamma + beta
    &quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, normalized_shape, eps=<span class="hljs-number">1e-5</span></span>):
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-variable language_">self</span>.eps = eps
        <span class="hljs-comment"># å¯å­¦ä¹ å‚æ•° / Learnable parameters</span>
        <span class="hljs-variable language_">self</span>.gamma = nn.Parameter(torch.ones(normalized_shape))
        <span class="hljs-variable language_">self</span>.beta = nn.Parameter(torch.zeros(normalized_shape))

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-comment"># x shape: [batch, seq_len, hidden_dim]</span>
        <span class="hljs-comment"># è®¡ç®—æœ€åä¸€ä¸ªç»´åº¦çš„å‡å€¼å’Œæ–¹å·® / Compute mean and variance along last dimension</span>
        mean = x.mean(dim=-<span class="hljs-number">1</span>, keepdim=<span class="hljs-literal">True</span>)
        var = x.var(dim=-<span class="hljs-number">1</span>, unbiased=<span class="hljs-literal">False</span>, keepdim=<span class="hljs-literal">True</span>)

        <span class="hljs-comment"># å½’ä¸€åŒ– / Normalize</span>
        x_norm = (x - mean) / torch.sqrt(var + <span class="hljs-variable language_">self</span>.eps)

        <span class="hljs-comment"># ç¼©æ”¾å’Œå¹³ç§» / Scale and shift</span>
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.gamma * x_norm + <span class="hljs-variable language_">self</span>.beta

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 2. å¯¹æ¯”æ‰‹åŠ¨å®ç°ä¸ PyTorch å®˜æ–¹å®ç° / Compare Manual vs PyTorch Implementation</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;LayerNorm å®ç°å¯¹æ¯” / LayerNorm Implementation Comparison&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-comment"># è®¾ç½®éšæœºç§å­ / Set random seed</span>
torch.manual_seed(<span class="hljs-number">42</span>)

<span class="hljs-comment"># åˆ›å»ºæµ‹è¯•æ•°æ® / Create test data</span>
batch_size, seq_len, hidden_dim = <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">8</span>
x = torch.randn(batch_size, seq_len, hidden_dim)

<span class="hljs-comment"># æ‰‹åŠ¨å®ç° / Manual implementation</span>
ln_manual = LayerNormManual(hidden_dim)
output_manual = ln_manual(x)

<span class="hljs-comment"># PyTorch å®˜æ–¹å®ç° / PyTorch official implementation</span>
ln_pytorch = nn.LayerNorm(hidden_dim)
<span class="hljs-comment"># å¤åˆ¶å‚æ•° / Copy parameters</span>
ln_pytorch.weight.data = ln_manual.gamma.data.clone()
ln_pytorch.bias.data = ln_manual.beta.data.clone()
output_pytorch = ln_pytorch(x)

<span class="hljs-comment"># æ¯”è¾ƒç»“æœ / Compare results</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nè¾“å…¥å½¢çŠ¶ / Input shape: <span class="hljs-subst">{x.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;è¾“å‡ºå½¢çŠ¶ / Output shape: <span class="hljs-subst">{output_manual.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;æœ€å¤§å·®å¼‚ / Max difference: <span class="hljs-subst">{(output_manual - output_pytorch).<span class="hljs-built_in">abs</span>().<span class="hljs-built_in">max</span>().item():<span class="hljs-number">.2</span>e}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 3. å¯è§†åŒ–å½’ä¸€åŒ–æ•ˆæœ / Visualize Normalization Effect</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;å½’ä¸€åŒ–æ•ˆæœå¯è§†åŒ– / Normalization Effect Visualization&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-comment"># åˆ›å»ºä¸€ä¸ªæœ‰åç§»çš„æ•°æ® / Create biased data</span>
x_biased = torch.tensor([[
    [<span class="hljs-number">10.0</span>, <span class="hljs-number">0.1</span>, -<span class="hljs-number">5.0</span>, <span class="hljs-number">3.0</span>, <span class="hljs-number">8.0</span>],   <span class="hljs-comment"># ç¬¬ä¸€ä¸ªè¯ / First token</span>
    [<span class="hljs-number">0.5</span>, <span class="hljs-number">8.0</span>, <span class="hljs-number">0.2</span>, -<span class="hljs-number">2.0</span>, <span class="hljs-number">1.0</span>],     <span class="hljs-comment"># ç¬¬äºŒä¸ªè¯ / Second token</span>
    [-<span class="hljs-number">3.0</span>, <span class="hljs-number">0.01</span>, <span class="hljs-number">12.0</span>, <span class="hljs-number">6.0</span>, -<span class="hljs-number">1.0</span>],  <span class="hljs-comment"># ç¬¬ä¸‰ä¸ªè¯ / Third token</span>
]])

ln = nn.LayerNorm(<span class="hljs-number">5</span>)
x_normalized = ln(x_biased)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nåŸå§‹æ•°æ® (ç¬¬ä¸€ä¸ªè¯) / Original data (first token):&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  <span class="hljs-subst">{x_biased[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>].tolist()}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  å‡å€¼ / Mean: <span class="hljs-subst">{x_biased[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>].mean().item():<span class="hljs-number">.4</span>f}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  æ ‡å‡†å·® / Std: <span class="hljs-subst">{x_biased[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>].std().item():<span class="hljs-number">.4</span>f}</span>&quot;</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nå½’ä¸€åŒ–å (ç¬¬ä¸€ä¸ªè¯) / After normalization (first token):&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  <span class="hljs-subst">{x_normalized[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>].tolist()}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  å‡å€¼ / Mean: <span class="hljs-subst">{x_normalized[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>].mean().item():<span class="hljs-number">.4</span>f}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  æ ‡å‡†å·® / Std: <span class="hljs-subst">{x_normalized[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>].std().item():<span class="hljs-number">.4</span>f}</span>&quot;</span>)

<span class="hljs-comment"># ç»˜å›¾ / Plot</span>
fig, axes = plt.subplots(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, figsize=(<span class="hljs-number">12</span>, <span class="hljs-number">4</span>))

<span class="hljs-comment"># åŸå§‹æ•°æ®çƒ­åŠ›å›¾ / Original data heatmap</span>
ax1 = axes[<span class="hljs-number">0</span>]
im1 = ax1.imshow(x_biased[<span class="hljs-number">0</span>].numpy(), cmap=<span class="hljs-string">&#x27;RdBu_r&#x27;</span>, aspect=<span class="hljs-string">&#x27;auto&#x27;</span>)
ax1.set_title(<span class="hljs-string">&#x27;Before LayerNorm / å½’ä¸€åŒ–å‰&#x27;</span>, fontsize=<span class="hljs-number">12</span>)
ax1.set_xlabel(<span class="hljs-string">&#x27;Hidden Dimension / éšè—ç»´åº¦&#x27;</span>)
ax1.set_ylabel(<span class="hljs-string">&#x27;Token Position / Token ä½ç½®&#x27;</span>)
plt.colorbar(im1, ax=ax1)

<span class="hljs-comment"># å½’ä¸€åŒ–åçƒ­åŠ›å›¾ / Normalized data heatmap</span>
ax2 = axes[<span class="hljs-number">1</span>]
im2 = ax2.imshow(x_normalized.detach().numpy()[<span class="hljs-number">0</span>], cmap=<span class="hljs-string">&#x27;RdBu_r&#x27;</span>, aspect=<span class="hljs-string">&#x27;auto&#x27;</span>)
ax2.set_title(<span class="hljs-string">&#x27;After LayerNorm / å½’ä¸€åŒ–å&#x27;</span>, fontsize=<span class="hljs-number">12</span>)
ax2.set_xlabel(<span class="hljs-string">&#x27;Hidden Dimension / éšè—ç»´åº¦&#x27;</span>)
ax2.set_ylabel(<span class="hljs-string">&#x27;Token Position / Token ä½ç½®&#x27;</span>)
plt.colorbar(im2, ax=ax2)

plt.tight_layout()
plt.savefig(<span class="hljs-string">&#x27;/tmp/layernorm_comparison.png&#x27;</span>, dpi=<span class="hljs-number">150</span>, bbox_inches=<span class="hljs-string">&#x27;tight&#x27;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nå›¾åƒå·²ä¿å­˜è‡³ / Image saved to: /tmp/layernorm_comparison.png&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 4. Pre-LN vs Post-LN / Pre-LN vs Post-LN</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Pre-LN vs Post-LN&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">PostLNSublayer</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;
    Post-LN: LayerNorm åœ¨æ®‹å·®è¿æ¥ä¹‹å / LayerNorm after residual connection
    åŸå§‹ Transformer ä½¿ç”¨çš„æ–¹å¼ / Used in original Transformer
    &quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, hidden_dim</span>):
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-variable language_">self</span>.norm = nn.LayerNorm(hidden_dim)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x, sublayer_output</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.norm(x + sublayer_output)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">PreLNSublayer</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;
    Pre-LN: LayerNorm åœ¨å­å±‚ä¹‹å‰ / LayerNorm before sublayer
    ç°ä»£ Transformer å¸¸ç”¨æ–¹å¼ / Commonly used in modern Transformers
    &quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, hidden_dim</span>):
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-variable language_">self</span>.norm = nn.LayerNorm(hidden_dim)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x, sublayer_fn</span>):
        <span class="hljs-keyword">return</span> x + sublayer_fn(<span class="hljs-variable language_">self</span>.norm(x))

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&quot;&quot;
Pre-LN ä¼˜åŠ¿ / Advantages of Pre-LN:
1. è®­ç»ƒæ›´ç¨³å®š / More stable training
2. æ¢¯åº¦æµåŠ¨æ›´å¹³æ»‘ / Smoother gradient flow
3. ä¸éœ€è¦ warmup / No warmup needed
4. ç°ä»£å¤§æ¨¡å‹æ™®éé‡‡ç”¨ / Widely adopted in modern LLMs
&quot;&quot;&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 5. åœ¨ Transformer ä¸­çš„ä½¿ç”¨ / Usage in Transformer</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Transformer ä¸­çš„ LayerNorm / LayerNorm in Transformer&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">TransformerBlock</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;
    ç®€åŒ–çš„ Transformer Blockï¼ˆä½¿ç”¨ Pre-LNï¼‰
    Simplified Transformer Block (using Pre-LN)
    &quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, hidden_dim, num_heads, ff_dim</span>):
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-variable language_">self</span>.norm1 = nn.LayerNorm(hidden_dim)
        <span class="hljs-variable language_">self</span>.norm2 = nn.LayerNorm(hidden_dim)
        <span class="hljs-variable language_">self</span>.attention = nn.MultiheadAttention(hidden_dim, num_heads, batch_first=<span class="hljs-literal">True</span>)
        <span class="hljs-variable language_">self</span>.ffn = nn.Sequential(
            nn.Linear(hidden_dim, ff_dim),
            nn.GELU(),
            nn.Linear(ff_dim, hidden_dim)
        )

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-comment"># Pre-LN Attention</span>
        x = x + <span class="hljs-variable language_">self</span>.attention(<span class="hljs-variable language_">self</span>.norm1(x), <span class="hljs-variable language_">self</span>.norm1(x), <span class="hljs-variable language_">self</span>.norm1(x))[<span class="hljs-number">0</span>]
        <span class="hljs-comment"># Pre-LN FFN</span>
        x = x + <span class="hljs-variable language_">self</span>.ffn(<span class="hljs-variable language_">self</span>.norm2(x))
        <span class="hljs-keyword">return</span> x

<span class="hljs-comment"># åˆ›å»ºå¹¶æµ‹è¯• / Create and test</span>
block = TransformerBlock(hidden_dim=<span class="hljs-number">64</span>, num_heads=<span class="hljs-number">4</span>, ff_dim=<span class="hljs-number">256</span>)
x = torch.randn(<span class="hljs-number">2</span>, <span class="hljs-number">10</span>, <span class="hljs-number">64</span>)  <span class="hljs-comment"># [batch, seq_len, hidden_dim]</span>
output = block(x)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nTransformer Block:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  è¾“å…¥å½¢çŠ¶ / Input shape: <span class="hljs-subst">{x.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  è¾“å‡ºå½¢çŠ¶ / Output shape: <span class="hljs-subst">{output.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  å‚æ•°é‡ / Parameters: <span class="hljs-subst">{<span class="hljs-built_in">sum</span>(p.numel() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> block.parameters()):,}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># æ€»ç»“ / Summary</span>
<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;æ€»ç»“ / Summary&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-string">&quot;&quot;&quot;
æœ¬ç¤ºä¾‹å±•ç¤ºäº† LayerNorm çš„æ ¸å¿ƒæ¦‚å¿µ:
This example demonstrates core concepts of LayerNorm:

1. æ•°å­¦åŸç†: y = (x - mean) / sqrt(var + eps) * gamma + beta
   Mathematical principle

2. æ²¿ç‰¹å¾ç»´åº¦å½’ä¸€åŒ–ï¼Œè€Œé batch ç»´åº¦
   Normalize along feature dimension, not batch dimension

3. é€‚åˆå˜é•¿åºåˆ—ï¼ˆNLP ä»»åŠ¡ï¼‰
   Suitable for variable-length sequences (NLP tasks)

4. Pre-LN æ¯” Post-LN è®­ç»ƒæ›´ç¨³å®š
   Pre-LN is more stable than Post-LN for training

5. æ˜¯ Transformer å’Œ LLM çš„æ ¸å¿ƒç»„ä»¶
   Core component of Transformer and LLM
&quot;&quot;&quot;</span>
</code></pre></div><div class="code-file"><h3>rmsnorm_example.py</h3><pre class="hljs"><code><span class="hljs-string">&quot;&quot;&quot;
RMS Normalization ç¤ºä¾‹ä»£ç  / RMS Normalization Example Code
===========================================================

æœ¬ç¤ºä¾‹å±•ç¤º RMS Normalization çš„åŸç†å’Œå®ç°ã€‚
This example demonstrates the principle and implementation of RMS Normalization.

RMSNorm æ˜¯ LayerNorm çš„ç®€åŒ–ç‰ˆæœ¬ï¼Œè¢« LLaMA ç­‰ç°ä»£ LLM å¹¿æ³›é‡‡ç”¨ã€‚
RMSNorm is a simplified version of LayerNorm, widely adopted in modern LLMs like LLaMA.

ä¾èµ–å®‰è£… / Dependencies:
    pip install torch matplotlib
&quot;&quot;&quot;</span>

<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn
<span class="hljs-keyword">import</span> time

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 1. RMSNorm æ‰‹åŠ¨å®ç° / Manual Implementation of RMSNorm</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">RMSNormManual</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;
    æ‰‹åŠ¨å®ç°çš„ RMS Normalization / Manual implementation of RMS Normalization

    æ•°å­¦å…¬å¼ / Mathematical formula:
        y = x / sqrt(mean(x^2) + eps) * gamma

    ä¸ LayerNorm çš„åŒºåˆ« / Difference from LayerNorm:
        - ä¸å‡å»å‡å€¼ / No mean subtraction
        - åªæœ‰ä¸€ä¸ªå¯å­¦ä¹ å‚æ•° gamma / Only one learnable parameter (gamma)
    &quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, dim, eps=<span class="hljs-number">1e-6</span></span>):
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-variable language_">self</span>.eps = eps
        <span class="hljs-variable language_">self</span>.gamma = nn.Parameter(torch.ones(dim))

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-comment"># è®¡ç®— RMS / Compute RMS</span>
        <span class="hljs-comment"># x: [batch, seq_len, dim]</span>
        rms = torch.sqrt(torch.mean(x ** <span class="hljs-number">2</span>, dim=-<span class="hljs-number">1</span>, keepdim=<span class="hljs-literal">True</span>) + <span class="hljs-variable language_">self</span>.eps)
        <span class="hljs-comment"># å½’ä¸€åŒ–å¹¶ç¼©æ”¾ / Normalize and scale</span>
        <span class="hljs-keyword">return</span> x / rms * <span class="hljs-variable language_">self</span>.gamma

<span class="hljs-comment"># PyTorch 2.0+ æä¾›å®˜æ–¹å®ç° / PyTorch 2.0+ provides official implementation</span>
<span class="hljs-comment"># nn.RMSNorm(dim, eps=1e-6)</span>

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 2. RMSNorm vs LayerNorm å¯¹æ¯” / Compare RMSNorm vs LayerNorm</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;RMSNorm vs LayerNorm å¯¹æ¯” / Comparison&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

torch.manual_seed(<span class="hljs-number">42</span>)

dim = <span class="hljs-number">64</span>
batch_size, seq_len = <span class="hljs-number">4</span>, <span class="hljs-number">128</span>

<span class="hljs-comment"># åˆ›å»ºæµ‹è¯•æ•°æ® / Create test data</span>
x = torch.randn(batch_size, seq_len, dim) * <span class="hljs-number">10</span> + <span class="hljs-number">5</span>  <span class="hljs-comment"># å¸¦åç§»çš„æ•°æ® / Biased data</span>

<span class="hljs-comment"># RMSNorm</span>
rms_norm = RMSNormManual(dim)
output_rms = rms_norm(x)

<span class="hljs-comment"># LayerNorm</span>
layer_norm = nn.LayerNorm(dim)
output_ln = layer_norm(x)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nè¾“å…¥ç»Ÿè®¡ / Input statistics:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  å‡å€¼ / Mean: <span class="hljs-subst">{x.mean().item():<span class="hljs-number">.4</span>f}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  æ ‡å‡†å·® / Std: <span class="hljs-subst">{x.std().item():<span class="hljs-number">.4</span>f}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  RMS: <span class="hljs-subst">{torch.sqrt(torch.mean(x ** <span class="hljs-number">2</span>)).item():<span class="hljs-number">.4</span>f}</span>&quot;</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nRMSNorm è¾“å‡ºç»Ÿè®¡ / RMSNorm output statistics:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  å‡å€¼ / Mean: <span class="hljs-subst">{output_rms.mean().item():<span class="hljs-number">.4</span>f}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  æ ‡å‡†å·® / Std: <span class="hljs-subst">{output_rms.std().item():<span class="hljs-number">.4</span>f}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  RMS: <span class="hljs-subst">{torch.sqrt(torch.mean(output_rms ** <span class="hljs-number">2</span>)).item():<span class="hljs-number">.4</span>f}</span>&quot;</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nLayerNorm è¾“å‡ºç»Ÿè®¡ / LayerNorm output statistics:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  å‡å€¼ / Mean: <span class="hljs-subst">{output_ln.mean().item():<span class="hljs-number">.4</span>f}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  æ ‡å‡†å·® / Std: <span class="hljs-subst">{output_ln.std().item():<span class="hljs-number">.4</span>f}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  RMS: <span class="hljs-subst">{torch.sqrt(torch.mean(output_ln ** <span class="hljs-number">2</span>)).item():<span class="hljs-number">.4</span>f}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 3. æ€§èƒ½å¯¹æ¯” / Performance Comparison</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;æ€§èƒ½å¯¹æ¯” / Performance Comparison&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-comment"># å¤§è§„æ¨¡æµ‹è¯• / Large-scale test</span>
dim = <span class="hljs-number">4096</span>  <span class="hljs-comment"># LLaMA-style dimension</span>
batch_size, seq_len = <span class="hljs-number">8</span>, <span class="hljs-number">2048</span>
x_large = torch.randn(batch_size, seq_len, dim)

<span class="hljs-comment"># ä½¿ç”¨ GPU å¦‚æœå¯ç”¨ / Use GPU if available</span>
device = torch.device(<span class="hljs-string">&#x27;cuda&#x27;</span> <span class="hljs-keyword">if</span> torch.cuda.is_available() <span class="hljs-keyword">else</span> <span class="hljs-string">&#x27;cpu&#x27;</span>)
x_large = x_large.to(device)

rms_norm_gpu = RMSNormManual(dim).to(device)
layer_norm_gpu = nn.LayerNorm(dim).to(device)

<span class="hljs-comment"># é¢„çƒ­ / Warmup</span>
<span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):
    _ = rms_norm_gpu(x_large)
    _ = layer_norm_gpu(x_large)

<span class="hljs-comment"># è®¡æ—¶ / Timing</span>
torch.cuda.synchronize() <span class="hljs-keyword">if</span> torch.cuda.is_available() <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>

start = time.time()
<span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">100</span>):
    _ = rms_norm_gpu(x_large)
torch.cuda.synchronize() <span class="hljs-keyword">if</span> torch.cuda.is_available() <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>
rms_time = time.time() - start

start = time.time()
<span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">100</span>):
    _ = layer_norm_gpu(x_large)
torch.cuda.synchronize() <span class="hljs-keyword">if</span> torch.cuda.is_available() <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>
ln_time = time.time() - start

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nè®¾å¤‡ / Device: <span class="hljs-subst">{device}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;è¾“å…¥å½¢çŠ¶ / Input shape: <span class="hljs-subst">{x_large.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;RMSNorm æ—¶é—´ / Time: <span class="hljs-subst">{rms_time*<span class="hljs-number">1000</span>:<span class="hljs-number">.2</span>f}</span> ms (100 æ¬¡è¿­ä»£)&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;LayerNorm æ—¶é—´ / Time: <span class="hljs-subst">{ln_time*<span class="hljs-number">1000</span>:<span class="hljs-number">.2</span>f}</span> ms (100 æ¬¡è¿­ä»£)&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;åŠ é€Ÿæ¯” / Speedup: <span class="hljs-subst">{ln_time/rms_time:<span class="hljs-number">.2</span>f}</span>x&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 4. å‚æ•°é‡å¯¹æ¯” / Parameter Comparison</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;å‚æ•°é‡å¯¹æ¯” / Parameter Comparison&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

dim = <span class="hljs-number">4096</span>
rms = RMSNormManual(dim)
ln = nn.LayerNorm(dim)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\néšè—ç»´åº¦ / Hidden dimension: <span class="hljs-subst">{dim}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;RMSNorm å‚æ•°é‡ / Parameters: <span class="hljs-subst">{<span class="hljs-built_in">sum</span>(p.numel() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> rms.parameters()):,}</span> (ä»… gamma)&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;LayerNorm å‚æ•°é‡ / Parameters: <span class="hljs-subst">{<span class="hljs-built_in">sum</span>(p.numel() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> ln.parameters()):,}</span> (gamma + beta)&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 5. LLaMA é£æ ¼çš„ RMSNorm å®ç° / LLaMA-style RMSNorm Implementation</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;LLaMA é£æ ¼ RMSNorm / LLaMA-style RMSNorm&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">LLaMARMSNorm</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;
    LLaMA é£æ ¼çš„ RMSNorm å®ç° / LLaMA-style RMSNorm implementation

    ç‰¹ç‚¹ / Features:
    1. ä½¿ç”¨ weight è€Œé gamma å‘½å / Uses &#x27;weight&#x27; instead of &#x27;gamma&#x27;
    2. ç²¾ç¡®çš„æ•°å€¼å®ç° / Precise numerical implementation
    3. æ”¯æŒ FP32 å½’ä¸€åŒ–è®¡ç®— / Supports FP32 normalization computation
    &quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, dim, eps=<span class="hljs-number">1e-6</span></span>):
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-variable language_">self</span>.eps = eps
        <span class="hljs-variable language_">self</span>.weight = nn.Parameter(torch.ones(dim))

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_norm</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-string">&quot;&quot;&quot;
        å½’ä¸€åŒ–å‡½æ•° / Normalization function
        åœ¨ FP32 ä¸­è®¡ç®—ä»¥ä¿è¯æ•°å€¼ç¨³å®šæ€§
        Compute in FP32 for numerical stability
        &quot;&quot;&quot;</span>
        <span class="hljs-keyword">return</span> x * torch.rsqrt(x.<span class="hljs-built_in">pow</span>(<span class="hljs-number">2</span>).mean(-<span class="hljs-number">1</span>, keepdim=<span class="hljs-literal">True</span>) + <span class="hljs-variable language_">self</span>.eps)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-comment"># è½¬æ¢ä¸º FP32 è®¡ç®—ï¼Œç„¶åè½¬å›åŸç²¾åº¦</span>
        <span class="hljs-comment"># Convert to FP32 for computation, then back to original dtype</span>
        output = <span class="hljs-variable language_">self</span>._norm(x.<span class="hljs-built_in">float</span>()).type_as(x)
        <span class="hljs-keyword">return</span> output * <span class="hljs-variable language_">self</span>.weight

<span class="hljs-comment"># æµ‹è¯• LLaMA é£æ ¼å®ç° / Test LLaMA-style implementation</span>
llama_norm = LLaMARMSNorm(dim=<span class="hljs-number">4096</span>)
x_test = torch.randn(<span class="hljs-number">1</span>, <span class="hljs-number">100</span>, <span class="hljs-number">4096</span>)
output = llama_norm(x_test)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nLLaMA RMSNorm:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  è¾“å…¥å½¢çŠ¶ / Input shape: <span class="hljs-subst">{x_test.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  è¾“å‡ºå½¢çŠ¶ / Output shape: <span class="hljs-subst">{output.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  è¾“å‡º RMS: <span class="hljs-subst">{torch.sqrt(torch.mean(output ** <span class="hljs-number">2</span>)).item():<span class="hljs-number">.4</span>f}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 6. æ¢¯åº¦æµåˆ†æ / Gradient Flow Analysis</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;æ¢¯åº¦æµåˆ†æ / Gradient Flow Analysis&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

dim = <span class="hljs-number">8</span>
x = torch.randn(<span class="hljs-number">2</span>, <span class="hljs-number">4</span>, dim, requires_grad=<span class="hljs-literal">True</span>)

<span class="hljs-comment"># RMSNorm æ¢¯åº¦</span>
rms = RMSNormManual(dim)
y_rms = rms(x)
loss_rms = y_rms.<span class="hljs-built_in">sum</span>()
loss_rms.backward()

rms_grad = x.grad.clone()
x.grad = <span class="hljs-literal">None</span>

<span class="hljs-comment"># LayerNorm æ¢¯åº¦</span>
ln = nn.LayerNorm(dim)
y_ln = ln(x)
loss_ln = y_ln.<span class="hljs-built_in">sum</span>()
loss_ln.backward()

ln_grad = x.grad.clone()

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nRMSNorm è¾“å…¥æ¢¯åº¦èŒƒæ•° / Input gradient norm: <span class="hljs-subst">{rms_grad.norm().item():<span class="hljs-number">.4</span>f}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;LayerNorm è¾“å…¥æ¢¯åº¦èŒƒæ•° / Input gradient norm: <span class="hljs-subst">{ln_grad.norm().item():<span class="hljs-number">.4</span>f}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># æ€»ç»“ / Summary</span>
<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;æ€»ç»“ / Summary&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-string">&quot;&quot;&quot;
æœ¬ç¤ºä¾‹å±•ç¤ºäº† RMSNorm çš„æ ¸å¿ƒæ¦‚å¿µ:
This example demonstrates core concepts of RMSNorm:

1. ç®€åŒ–å…¬å¼: y = x / sqrt(mean(x^2) + eps) * gamma
   Simplified formula

2. ç›¸æ¯” LayerNorm:
   Compared to LayerNorm:
   - çœå»å‡å€¼è®¡ç®— / No mean calculation
   - å‡å°‘ 25% è®¡ç®—é‡ / ~25% less computation
   - å‚æ•°é‡å‡åŠ / Half the parameters

3. è¢«ç°ä»£ LLM å¹¿æ³›é‡‡ç”¨:
   Widely adopted in modern LLMs:
   - LLaMA
   - GPT-NeoX
   - PaLM
   - Chinchilla

4. å®è·µæ•ˆæœä¸ LayerNorm ç›¸å½“æˆ–æ›´å¥½
   Practical performance equal to or better than LayerNorm

5. é€‚åˆå¤§è§„æ¨¡æ¨¡å‹è®­ç»ƒ
   Suitable for large-scale model training
&quot;&quot;&quot;</span>
</code></pre></div></div></div><div class="chapter"><h1>ç¬¬4ç«  Activation æ¿€æ´»å‡½æ•°</h1><h1>æ¿€æ´»å‡½æ•°ï¼ˆActivation Functionï¼‰ç§‘æ™®ç‰ˆ</h1>
<blockquote>
<p>é¢å‘é›¶åŸºç¡€è¯»è€…çš„æ¿€æ´»å‡½æ•°å…¥é—¨æŒ‡å—</p>
</blockquote>
<h2>ä¸€å¥è¯æ¦‚æ‹¬</h2>
<p><strong>æ¿€æ´»å‡½æ•°ç»™ç¥ç»ç½‘ç»œ&quot;æ³¨å…¥çµé­‚&quot;ï¼Œè®©å®ƒèƒ½å¤Ÿå­¦ä¹ å¤æ‚çš„éçº¿æ€§å…³ç³»ã€‚</strong></p>
<h2>ä»ä¸€ä¸ªé—®é¢˜å¼€å§‹</h2>
<p>æƒ³è±¡ä½ åœ¨ç©ä¸€ä¸ªæ¸¸æˆï¼š</p>
<ul>
<li>è¾“å…¥ï¼šæŒ‰ä¸‹æŸä¸ªæŒ‰é’®</li>
<li>è¾“å‡ºï¼šè§’è‰²è·³è·ƒ</li>
</ul>
<p>è¿™æ˜¯ä¸€ä¸ªç®€å•çš„&quot;æ˜¯/å¦&quot;å…³ç³»ã€‚ä½†å¦‚æœè§„åˆ™å˜æˆï¼š</p>
<ul>
<li>æŒ‰æŒ‰é’®æ—¶é—´è¶Šé•¿ï¼Œè·³å¾—è¶Šé«˜</li>
<li>ä½†è¶…è¿‡ 3 ç§’åï¼Œé«˜åº¦ä¸å†å¢åŠ </li>
</ul>
<p>è¿™å°±å˜æˆäº†ä¸€ä¸ª<strong>éçº¿æ€§å…³ç³»</strong>ã€‚</p>
<p><strong>æ¿€æ´»å‡½æ•°çš„ä½œç”¨å°±æ˜¯è®©ç¥ç»ç½‘ç»œèƒ½å¤Ÿå­¦ä¹ è¿™ç§å¤æ‚å…³ç³»ã€‚</strong></p>
<h2>ä¸ºä»€ä¹ˆéœ€è¦éçº¿æ€§ï¼Ÿ</h2>
<h3>çº¿æ€§çš„å±€é™</h3>
<p>å¦‚æœç¥ç»ç½‘ç»œåªæœ‰çº¿æ€§è¿ç®—ï¼ˆåŠ æ³•ã€ä¹˜æ³•ï¼‰ï¼š</p>
<pre class="hljs"><code>y = W2 Ã— (W1 Ã— x) = (W2 Ã— W1) Ã— x = W&#39; Ã— x
</code></pre>
<p>æ— è®ºå åŠ å¤šå°‘å±‚ï¼Œæœ€ç»ˆè¿˜æ˜¯ä¸€ä¸ªçº¿æ€§å˜æ¢ï¼è¿™æ„å‘³ç€ï¼š</p>
<ul>
<li>æ— æ³•å­¦ä¹ æ›²çº¿å…³ç³»</li>
<li>æ— æ³•å¤„ç†å¤æ‚æ¨¡å¼</li>
<li>æœ¬è´¨ä¸Šåªæ˜¯ä¸€ä¸ª&quot;å¤§å·çš„çº¿æ€§å›å½’&quot;</li>
</ul>
<h3>éçº¿æ€§çš„é­”åŠ›</h3>
<p>åŠ å…¥æ¿€æ´»å‡½æ•°åï¼š</p>
<pre class="hljs"><code>y = W2 Ã— f(W1 Ã— x)
</code></pre>
<p>å…¶ä¸­ <code>f</code> æ˜¯éçº¿æ€§å‡½æ•°ã€‚ç°åœ¨ç½‘ç»œå¯ä»¥ï¼š</p>
<ul>
<li>å­¦ä¹ ä»»æ„å¤æ‚çš„å‡½æ•°</li>
<li>æ‹Ÿåˆå„ç§æ›²çº¿</li>
<li>ç†è§£å¤æ‚çš„æ•°æ®æ¨¡å¼</li>
</ul>
<h2>å¸¸è§çš„æ¿€æ´»å‡½æ•°</h2>
<h3>1. ReLUï¼ˆæœ€å¸¸ç”¨ï¼‰</h3>
<p><strong>è§„åˆ™</strong>ï¼šæ­£æ•°ä¿æŒä¸å˜ï¼Œè´Ÿæ•°å˜æˆ 0</p>
<pre class="hljs"><code>è¾“å…¥: -3, -1, 0, 2, 5
è¾“å‡º:  0,  0, 0, 2, 5
</code></pre>
<p><strong>ä¼˜ç‚¹</strong>ï¼š</p>
<ul>
<li>è®¡ç®—è¶…çº§å¿«ï¼ˆåªéœ€è¦åˆ¤æ–­æ­£è´Ÿï¼‰</li>
<li>ç¼“è§£æ¢¯åº¦æ¶ˆå¤±é—®é¢˜</li>
<li>æ˜¯ç°ä»£æ·±åº¦å­¦ä¹ çš„é»˜è®¤é€‰æ‹©</li>
</ul>
<p><strong>å½¢è±¡ç†è§£</strong>ï¼šå°±åƒä¸€ä¸ª&quot;å•å‘é˜€&quot;ï¼Œåªè®©æ­£å‘ä¿¡æ¯é€šè¿‡ã€‚</p>
<h3>2. Sigmoid</h3>
<p><strong>è§„åˆ™</strong>ï¼šæŠŠä»»æ„æ•°å€¼å‹ç¼©åˆ° 0 åˆ° 1 ä¹‹é—´</p>
<pre class="hljs"><code>è¾“å…¥: -10, -1, 0, 1, 10
è¾“å‡º:  ~0, 0.27, 0.5, 0.73, ~1
</code></pre>
<p><strong>ä¼˜ç‚¹</strong>ï¼šè¾“å‡ºæœ‰ç•Œï¼Œé€‚åˆæ¦‚ç‡é¢„æµ‹</p>
<p><strong>ç¼ºç‚¹</strong>ï¼š</p>
<ul>
<li>ä¸¤ç«¯&quot;é¥±å’Œ&quot;ï¼Œæ¢¯åº¦æ¶ˆå¤±</li>
<li>è¾“å‡ºä¸æ˜¯ä»¥ 0 ä¸ºä¸­å¿ƒ</li>
</ul>
<p><strong>å½¢è±¡ç†è§£</strong>ï¼šæŠŠæ‰€æœ‰æ•°å€¼&quot;æŒ¤å‹&quot;åˆ° 0-1 çš„å°åŒºé—´å†…ã€‚</p>
<h3>3. Tanh</h3>
<p><strong>è§„åˆ™</strong>ï¼šæŠŠä»»æ„æ•°å€¼å‹ç¼©åˆ° -1 åˆ° 1 ä¹‹é—´</p>
<pre class="hljs"><code>è¾“å…¥: -10, -1, 0, 1, 10
è¾“å‡º: ~-1, -0.76, 0, 0.76, ~1
</code></pre>
<p><strong>ä¼˜ç‚¹</strong>ï¼šè¾“å‡ºä»¥ 0 ä¸ºä¸­å¿ƒ</p>
<p><strong>å½¢è±¡ç†è§£</strong>ï¼šç±»ä¼¼ Sigmoidï¼Œä½†èŒƒå›´æ˜¯å¯¹ç§°çš„ã€‚</p>
<h3>4. GELUï¼ˆTransformer é¦–é€‰ï¼‰</h3>
<p><strong>è§„åˆ™</strong>ï¼šReLU çš„&quot;å¹³æ»‘ç‰ˆ&quot;</p>
<pre class="hljs"><code>è¾“å…¥: -2, -1, 0, 1, 2
è¾“å‡º: ~0, ~0.16, 0, ~0.84, 2
</code></pre>
<p><strong>ç‰¹ç‚¹</strong>ï¼š</p>
<ul>
<li>åœ¨ 0 é™„è¿‘æ˜¯å¹³æ»‘è¿‡æ¸¡ï¼Œä¸æ˜¯ç¡¬åˆ‡æ¢</li>
<li>BERTã€GPT ç­‰æ¨¡å‹çš„é¦–é€‰</li>
<li>æ€§èƒ½ç•¥ä¼˜äº ReLU</li>
</ul>
<p><strong>å½¢è±¡ç†è§£</strong>ï¼šåƒä¸€ä¸ª&quot;æ¸©å’Œçš„å•å‘é˜€&quot;ï¼Œè¿‡æ¸¡æ›´è‡ªç„¶ã€‚</p>
<h3>5. Softmaxï¼ˆå¤šåˆ†ç±»ä¸“ç”¨ï¼‰</h3>
<p><strong>è§„åˆ™</strong>ï¼šæŠŠä¸€ç»„æ•°å€¼è½¬æ¢æˆæ¦‚ç‡åˆ†å¸ƒ</p>
<pre class="hljs"><code>è¾“å…¥: [2, 1, 0.1]
è¾“å‡º: [0.659, 0.242, 0.099]  # å’Œä¸º 1
</code></pre>
<p><strong>ç”¨é€”</strong>ï¼šå¤šåˆ†ç±»ä»»åŠ¡çš„è¾“å‡ºå±‚</p>
<p><strong>å½¢è±¡ç†è§£</strong>ï¼šæŠŠä»»æ„æ•°å€¼å˜æˆ&quot;æŠ•ç¥¨ç»“æœ&quot;ï¼Œæ€»ç¥¨æ•°å›ºå®šä¸º 1ã€‚</p>
<h2>æ¿€æ´»å‡½æ•°é€‰æ‹©æŒ‡å—</h2>
<table>
<thead>
<tr>
<th>åœºæ™¯</th>
<th>æ¨èæ¿€æ´»å‡½æ•°</th>
</tr>
</thead>
<tbody>
<tr>
<td>éšè—å±‚ï¼ˆé€šç”¨ï¼‰</td>
<td>ReLU</td>
</tr>
<tr>
<td>Transformer/LLM</td>
<td>GELU</td>
</tr>
<tr>
<td>äºŒåˆ†ç±»è¾“å‡º</td>
<td>Sigmoid</td>
</tr>
<tr>
<td>å¤šåˆ†ç±»è¾“å‡º</td>
<td>Softmax</td>
</tr>
<tr>
<td>RNN/LSTM</td>
<td>Tanh</td>
</tr>
</tbody>
</table>
<h2>ä¸€ä¸ªç›´è§‚çš„ä¾‹å­</h2>
<p>æƒ³è±¡ä½ è¦åŒºåˆ†&quot;çŒ«&quot;å’Œ&quot;ç‹—&quot;ï¼š</p>
<ol>
<li><strong>çº¿æ€§æ¨¡å‹</strong>ï¼šåªèƒ½ç”»ä¸€æ¡ç›´çº¿åˆ†å¼€å®ƒä»¬</li>
<li><strong>å¸¦æ¿€æ´»å‡½æ•°çš„ç½‘ç»œ</strong>ï¼šå¯ä»¥ç”»ä»»æ„å¤æ‚çš„æ›²çº¿è¾¹ç•Œ</li>
</ol>
<p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ·±åº¦å­¦ä¹ èƒ½å¤Ÿå¤„ç†å›¾åƒã€è¯­éŸ³ç­‰å¤æ‚æ•°æ®â€”â€”æ¿€æ´»å‡½æ•°ç»™äº†å®ƒ&quot;å¼¯æ›²ç©ºé—´&quot;çš„èƒ½åŠ›ã€‚</p>
<h2>æ€»ç»“</h2>
<table>
<thead>
<tr>
<th>æ¦‚å¿µ</th>
<th>é€šä¿—ç†è§£</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ¿€æ´»å‡½æ•°</td>
<td>ç»™ç½‘ç»œå¼•å…¥éçº¿æ€§</td>
</tr>
<tr>
<td>ReLU</td>
<td>å•å‘é˜€ï¼Œåªè®©æ­£æ•°é€šè¿‡</td>
</tr>
<tr>
<td>Sigmoid</td>
<td>æŒ¤å‹åˆ° 0-1 ä¹‹é—´</td>
</tr>
<tr>
<td>GELU</td>
<td>å¹³æ»‘ç‰ˆçš„ ReLU</td>
</tr>
<tr>
<td>Softmax</td>
<td>å˜æˆæ¦‚ç‡åˆ†å¸ƒ</td>
</tr>
</tbody>
</table>
<h2>ä¸‹ä¸€æ­¥</h2>
<ul>
<li>æƒ³äº†è§£æ•°å­¦åŸç†ï¼Ÿé˜…è¯» <a href="advanced-guide.md">æ·±å…¥ç‰ˆ</a></li>
<li>æƒ³çœ‹ä»£ç å®ç°ï¼ŸæŸ¥çœ‹ <code>examples/</code> ç›®å½•</li>
</ul>
<h1>æ¿€æ´»å‡½æ•°ï¼ˆActivation Functionï¼‰æ·±å…¥ç‰ˆ</h1>
<blockquote>
<p>é¢å‘æœ‰æœºå™¨å­¦ä¹ åŸºç¡€è¯»è€…çš„æŠ€æœ¯è¯¦è§£</p>
</blockquote>
<h2>æ¦‚è¿°</h2>
<p>æ¿€æ´»å‡½æ•°æ˜¯ç¥ç»ç½‘ç»œçš„çµé­‚ï¼Œä¸ºç½‘ç»œå¼•å…¥éçº¿æ€§å˜æ¢èƒ½åŠ›ã€‚æœ¬æ–‡æ·±å…¥åˆ†æä¸»æµæ¿€æ´»å‡½æ•°çš„æ•°å­¦åŸç†ã€æ¢¯åº¦ç‰¹æ€§åŠå…¶åœ¨æ·±åº¦å­¦ä¹ ä¸­çš„åº”ç”¨ã€‚</p>
<h2>ä¸ºä»€ä¹ˆéœ€è¦æ¿€æ´»å‡½æ•°ï¼Ÿ</h2>
<h3>ä¸‡èƒ½è¿‘ä¼¼å®šç†</h3>
<p>å…·æœ‰éçº¿æ€§æ¿€æ´»å‡½æ•°çš„å‰é¦ˆç½‘ç»œï¼Œåªè¦æœ‰è¶³å¤Ÿçš„éšè—å•å…ƒï¼Œå°±å¯ä»¥ä»¥ä»»æ„ç²¾åº¦è¿‘ä¼¼ä»»ä½•è¿ç»­å‡½æ•°ã€‚</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p><a id="formula-activation-1"></a>
<a href="#formula-activation-1-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p>æ²¡æœ‰ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span></span></span></span> çš„éçº¿æ€§ï¼Œç½‘ç»œåªèƒ½è¡¨ç¤ºçº¿æ€§å˜æ¢ã€‚</p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šä¸€ä¸ªä¸¤å±‚å‰é¦ˆç½‘ç»œçš„è®¡ç®—è¿‡ç¨‹ï¼šå…ˆåšçº¿æ€§å˜æ¢ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>ï¼Œå†ç»è¿‡æ¿€æ´»å‡½æ•° <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span></span></span></span>ï¼Œæœ€åå†çº¿æ€§å˜æ¢å¾—åˆ°è¾“å‡ºã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> ä¸ºè¾“å…¥å‘é‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºæƒé‡çŸ©é˜µï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºåç½®ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span></span></span></span> ä¸ºæ¿€æ´»å‡½æ•°ï¼ˆé€å…ƒç´ ä½œç”¨ï¼‰ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span></span></span></span> æä¾›éçº¿æ€§ï¼Œä½¿æ¨¡å‹å¯ä»¥è¡¨è¾¾å¤æ‚å‡½æ•°ï¼›è‹¥æ²¡æœ‰ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span></span></span></span>ï¼Œå¤šå±‚çº¿æ€§å˜æ¢ä»ç­‰ä»·äºä¸€æ¬¡çº¿æ€§å˜æ¢ã€‚</li>
</ul>
<h2>ReLU (Rectified Linear Unit)</h2>
<h3>æ•°å­¦å®šä¹‰</h3>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">ReLU</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">max</span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord mathnormal">x</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">ifÂ </span></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">0</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">ifÂ </span></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â‰¤</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><a id="formula-activation-2"></a>
<a href="#formula-activation-2-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šReLU æŠŠæ‰€æœ‰è´Ÿå€¼æˆªæ–­ä¸º 0ï¼Œæ­£å€¼ä¿æŒä¸å˜ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> æ˜¯è¾“å…¥æ ‡é‡æˆ–å‘é‡ï¼ˆé€å…ƒç´ åº”ç”¨ï¼‰ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šåƒä¸€ä¸ªâ€œé—¸é—¨â€ï¼Œåªè®©æ­£ä¿¡å·é€šè¿‡ï¼Œä½¿æ¿€æ´»ç¨€ç–ä¸”è®¡ç®—ç®€å•ã€‚</li>
</ul>
<h3>å¯¼æ•°</h3>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0751em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord text"><span class="mord">ReLU</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8251em;"><span style="top:-3.1362em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">ifÂ </span></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">0</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">ifÂ </span></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â‰¤</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><a id="formula-activation-3"></a>
<a href="#formula-activation-3-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šReLU åœ¨æ­£åŒºé—´å¯¼æ•°ä¸º 1ï¼Œè´ŸåŒºé—´å¯¼æ•°ä¸º 0ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0751em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord text"><span class="mord">ReLU</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8251em;"><span style="top:-3.1362em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> è¡¨ç¤ºè¾“å‡ºå¯¹è¾“å…¥çš„å˜åŒ–ç‡ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šæ­£åŒºé—´æ¢¯åº¦ç¨³å®šã€æ˜“è®­ç»ƒï¼›è´ŸåŒºé—´æ¢¯åº¦ä¸º 0ï¼Œå¯èƒ½å¯¼è‡´ç¥ç»å…ƒâ€œæ­»äº¡â€ã€‚</li>
</ul>
<h3>ä¼˜ç‚¹</h3>
<ol>
<li><strong>è®¡ç®—é«˜æ•ˆ</strong>ï¼šåªéœ€è¦æ¯”è¾ƒå’Œèµ‹å€¼</li>
<li><strong>ç¼“è§£æ¢¯åº¦æ¶ˆå¤±</strong>ï¼šæ­£åŒºé—´çš„æ¢¯åº¦æ’ä¸º 1</li>
<li><strong>ç¨€ç–æ¿€æ´»</strong>ï¼šè´ŸåŒºé—´è¾“å‡ºä¸º 0ï¼Œäº§ç”Ÿç¨€ç–æ€§</li>
</ol>
<h3>é—®é¢˜ï¼šDead ReLU</h3>
<p>å½“è¾“å…¥å§‹ç»ˆä¸ºè´Ÿæ—¶ï¼Œç¥ç»å…ƒ&quot;æ­»äº¡&quot;ï¼Œæ¢¯åº¦æ°¸è¿œä¸º 0ã€‚</p>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p>
<ul>
<li>Leaky ReLU: <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">max</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span>ï¼Œå…¶ä¸­ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4831em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â‰ˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.01</span></span></span></span></li>
<li>Parametric ReLU: <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span></span></span></span> å¯å­¦ä¹ </li>
</ul>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>Leaky ReLU</strong>ï¼šå½“ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span> æ—¶ä»ä¿ç•™ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="mord mathnormal">x</span></span></span></span> çš„å°æ–œç‡ï¼Œé¿å…å®Œå…¨â€œå…³æ­»â€ã€‚</li>
<li><strong>Parametric ReLU</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span></span></span></span> ç”±è®­ç»ƒæ•°æ®è‡ªåŠ¨å­¦ä¹ ï¼Œé€‚é…ä¸åŒå±‚çš„æœ€ä½³è´ŸåŒºé—´æ–œç‡ã€‚</li>
</ul>
<h2>Sigmoid</h2>
<h3>æ•°å­¦å®šä¹‰</h3>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0908em;vertical-align:-0.7693em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6973em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">âˆ’</span><span class="mord mathnormal mtight">x</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><a id="formula-activation-4"></a>
<a href="#formula-activation-4-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šå°†ä»»æ„å®æ•°æ˜ å°„åˆ° <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span> çš„æ¦‚ç‡å¼è¾“å‡ºã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> ä¸ºè¾“å…¥ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">e</span></span></span></span> ä¸ºè‡ªç„¶å¸¸æ•°ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šåƒä¸€ä¸ªâ€œæ¦‚ç‡å¼€å…³â€ï¼Œå¸¸ç”¨äºäºŒåˆ†ç±»è¾“å‡ºã€‚</li>
</ul>
<h3>å¯¼æ•°</h3>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0519em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8019em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">))</span></span></span></span></span></p>
<p><a id="formula-activation-5"></a>
<a href="#formula-activation-5-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šSigmoid çš„æ¢¯åº¦ä¸å…¶è¾“å‡ºæˆæ­£ç›¸å…³ï¼Œåœ¨ 0 é™„è¿‘æœ€å¤§ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0019em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> è¡¨ç¤ºè¾“å‡ºå¯¹è¾“å…¥çš„æ•æ„Ÿåº¦ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šå½“ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> æ¥è¿‘ 0 æˆ– 1 æ—¶ï¼Œæ¢¯åº¦è¶‹è¿‘ 0ï¼Œå®¹æ˜“å¯¼è‡´æ¢¯åº¦æ¶ˆå¤±ã€‚</li>
</ul>
<h3>é—®é¢˜</h3>
<ol>
<li><strong>æ¢¯åº¦æ¶ˆå¤±</strong>ï¼šå½“ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">âˆ£</span><span class="mord mathnormal">x</span><span class="mord">âˆ£</span></span></span></span> è¾ƒå¤§æ—¶ï¼Œ<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0019em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â‰ˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span></li>
<li><strong>éé›¶ä¸­å¿ƒ</strong>ï¼šè¾“å‡ºæ’ä¸ºæ­£ï¼Œå¯¼è‡´æƒé‡æ¢¯åº¦ç¬¦å·ä¸€è‡´</li>
<li><strong>æŒ‡æ•°è®¡ç®—</strong>ï¼šè®¡ç®—æˆæœ¬è¾ƒé«˜</li>
</ol>
<h3>å˜ä½“ï¼šHard Sigmoid</h3>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">HardSigmoid</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0074em;vertical-align:-0.686em;"></span><span class="mop">max</span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">min</span><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">))</span></span></span></span></span></p>
<p><a id="formula-activation-6"></a>
<a href="#formula-activation-6-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šç”¨åˆ†æ®µçº¿æ€§å‡½æ•°è¿‘ä¼¼ Sigmoidï¼ŒæŠŠè¾“å‡ºé™åˆ¶åœ¨ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span>ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼šå½“ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7719em;vertical-align:-0.136em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â‰¤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">âˆ’</span><span class="mord">1</span></span></span></span> è¾“å‡º 0ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7719em;vertical-align:-0.136em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â‰¥</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> è¾“å‡º 1ï¼›ä¸­é—´çº¿æ€§å˜åŒ–ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šç‰ºç‰²ç²¾åº¦æ¢å–æ›´å¿«è®¡ç®—å’Œæ›´ç¨³å®šçš„æ¢¯åº¦ã€‚</li>
</ul>
<p>ç”¨åˆ†æ®µçº¿æ€§è¿‘ä¼¼ sigmoidï¼Œè®¡ç®—æ›´å¿«ã€‚</p>
<h2>Tanh (Hyperbolic Tangent)</h2>
<h3>æ•°å­¦å®šä¹‰</h3>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">tanh</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.2177em;vertical-align:-0.7693em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.4483em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5904em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6973em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">âˆ’</span><span class="mord mathnormal mtight">x</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7713em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">âˆ’</span><span class="mord mathnormal mtight">x</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="mopen">(</span><span class="mord">2</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span></span></p>
<p><a id="formula-activation-7"></a>
<a href="#formula-activation-7-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šåŒæ›²æ­£åˆ‡æŠŠè¾“å…¥æ˜ å°„åˆ° <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">âˆ’</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span>ï¼Œæ˜¯â€œé›¶ä¸­å¿ƒâ€çš„ Sigmoid å˜ä½“ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> ä¸ºè¾“å…¥ï¼›ç­‰å¼å³ä¾§è¯´æ˜å®ƒä¸ Sigmoid çš„å…³ç³»ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šè¾“å‡ºå‡å€¼æ›´æ¥è¿‘ 0ï¼Œæœ‰åˆ©äºä¼˜åŒ–ï¼Œä½†ä»å¯èƒ½æ¢¯åº¦æ¶ˆå¤±ã€‚</li>
</ul>
<h3>å¯¼æ•°</h3>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0862em;vertical-align:-0.25em;"></span><span class="mop"><span class="mop">tanh</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8362em;"><span style="top:-3.1473em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.1484em;vertical-align:-0.25em;"></span><span class="mop"><span class="mop">tanh</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8984em;"><span style="top:-3.1473em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></p>
<p><a id="formula-activation-8"></a>
<a href="#formula-activation-8-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼štanh çš„æ¢¯åº¦ç”±è¾“å‡ºå€¼å†³å®šï¼Œè¾“å‡ºè¶Šæ¥è¿‘ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">Â±</span><span class="mord">1</span></span></span></span>ï¼Œæ¢¯åº¦è¶Šå°ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0862em;vertical-align:-0.25em;"></span><span class="mop"><span class="mop">tanh</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8362em;"><span style="top:-3.1473em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> æ˜¯å¯¼æ•°ï¼Œè¡¡é‡è¾“å‡ºå¯¹è¾“å…¥çš„å˜åŒ–ç‡ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šå½“æ¿€æ´»é¥±å’Œæ—¶ï¼ˆæ¥è¿‘ -1 æˆ– 1ï¼‰ï¼Œå­¦ä¹ é€Ÿåº¦å˜æ…¢ã€‚</li>
</ul>
<h3>ç‰¹ç‚¹</h3>
<ul>
<li>è¾“å‡ºèŒƒå›´ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">âˆ’</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span>ï¼Œé›¶ä¸­å¿ƒ</li>
<li>æ¢¯åº¦æ¯” sigmoid æ›´å¤§ï¼ˆåœ¨ 0 é™„è¿‘ï¼‰</li>
<li>ä»å­˜åœ¨æ¢¯åº¦æ¶ˆå¤±é—®é¢˜</li>
</ul>
<h2>GELU (Gaussian Error Linear Unit)</h2>
<h3>æ•°å­¦å®šä¹‰</h3>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">GELU</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4445em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">Î¦</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4445em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â‰¤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></p>
<p><a id="formula-activation-9"></a>
<a href="#formula-activation-9-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šGELU å°†è¾“å…¥ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> ä¸å…¶è¢«â€œä¿ç•™â€çš„æ¦‚ç‡ç›¸ä¹˜ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆ¼</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.14736em;">N</span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span>ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">Î¦</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> æ˜¯æ ‡å‡†æ­£æ€åˆ†å¸ƒ CDFã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šè¾“å…¥è¶Šå¤§ï¼Œä¿ç•™æ¦‚ç‡è¶Šé«˜ï¼›è¾“å…¥ä¸ºè´Ÿæ—¶ä»å¯èƒ½ä¿ç•™ä¸€éƒ¨åˆ†ã€‚</li>
</ul>
<p>å…¶ä¸­ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">Î¦</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> æ˜¯æ ‡å‡†æ­£æ€åˆ†å¸ƒçš„ CDFï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">Î¦</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord text"><span class="mord">erf</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em;"><span style="top:-2.2028em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9072em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord">2</span></span></span><span style="top:-2.8672em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1328em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">x</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></p>
<p><a id="formula-activation-10"></a>
<a href="#formula-activation-10-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šæ ‡å‡†æ­£æ€åˆ†å¸ƒçš„ç´¯è®¡æ¦‚ç‡å‡½æ•°ï¼ˆCDFï¼‰ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">erf</span></span><span class="mopen">(</span><span class="mord">â‹…</span><span class="mclose">)</span></span></span></span> æ˜¯è¯¯å·®å‡½æ•°ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šç»™å‡º <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8193em;vertical-align:-0.136em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â‰¤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> çš„æ¦‚ç‡ï¼Œç”¨äºå¹³æ»‘åœ°â€œç­›é€‰â€è¾“å…¥ã€‚</li>
</ul>
<h3>è¿‘ä¼¼å…¬å¼</h3>
<p>ç²¾ç¡®çš„ GELU è®¡ç®— expensiveï¼Œå¸¸ç”¨è¿‘ä¼¼ï¼š</p>
<p><strong>Tanh è¿‘ä¼¼</strong>ï¼š
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">GELU</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â‰ˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.5</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.4445em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">(</span></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mop">tanh</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">[</span></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6516em;"><span class="svg-align" style="top:-4.4em;"><span class="pstrut" style="height:4.4em;"></span><span class="mord" style="padding-left:1em;"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">Ï€</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-3.6116em;"><span class="pstrut" style="height:4.4em;"></span><span class="hide-tail" style="min-width:1.02em;height:2.48em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="2.48em" viewBox="0 0 400000 2592" preserveAspectRatio="xMinYMin slice"><path d="M424,2478
c-1.3,-0.7,-38.5,-172,-111.5,-514c-73,-342,-109.8,-513.3,-110.5,-514
c0,-2,-10.7,14.3,-32,49c-4.7,7.3,-9.8,15.7,-15.5,25c-5.7,9.3,-9.8,16,-12.5,20
s-5,7,-5,7c-4,-3.3,-8.3,-7.7,-13,-13s-13,-13,-13,-13s76,-122,76,-122s77,-121,77,-121
s209,968,209,968c0,-2,84.7,-361.7,254,-1079c169.3,-717.3,254.7,-1077.7,256,-1081
l0 -0c4,-6.7,10,-10,18,-10 H400000
v40H1014.6
s-87.3,378.7,-272.6,1166c-185.3,787.3,-279.3,1182.3,-282,1185
c-2,6,-10,9,-24,9
c-8,0,-12,-0.7,-12,-2z M1001 80
h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.7884em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">0.044715</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size4">]</span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size4">)</span></span></span></span></span></span></span></p>
<p><a id="formula-activation-11"></a>
<a href="#formula-activation-11-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šç”¨ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mop">tanh</span></span></span></span> è¿‘ä¼¼ GELUï¼Œé¿å…è®¡ç®—è¯¯å·®å‡½æ•°å¸¦æ¥çš„å¼€é”€ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.044715</span></span></span></span> ä¸ºç»éªŒå¸¸æ•°ï¼Œ<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span></span></span></span> æä¾›éçº¿æ€§è°ƒèŠ‚ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šåœ¨ä¿è¯å½¢çŠ¶æ¥è¿‘ GELU çš„åŒæ—¶æå‡è®¡ç®—æ•ˆç‡ã€‚</li>
</ul>
<p><strong>Sigmoid è¿‘ä¼¼</strong>ï¼ˆSiLU/Swishï¼‰ï¼š
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">SiLU</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4445em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></p>
<p><a id="formula-activation-12"></a>
<a href="#formula-activation-12-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šè¾“å…¥ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> ä¸ Sigmoid é—¨æ§åçš„ç»“æœç›¸ä¹˜ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> ä¸º Sigmoidã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šæ—¢ä¿ç•™æ­£å€¼ï¼Œåˆåœ¨è´Ÿå€¼åŒºä¿ç•™å°å“åº”ï¼Œå¹³æ»‘ä¸”éå•è°ƒã€‚</li>
</ul>
<h3>å¯¼æ•°</h3>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0751em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord text"><span class="mord">GELU</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8251em;"><span style="top:-3.1362em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">Î¦</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.4445em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">Ï•</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></p>
<p><a id="formula-activation-13"></a>
<a href="#formula-activation-13-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šGELU çš„æ¢¯åº¦ç”± CDF å’Œ PDF ä¸¤éƒ¨åˆ†ç»„æˆã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">Ï•</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> æ˜¯æ ‡å‡†æ­£æ€åˆ†å¸ƒçš„æ¦‚ç‡å¯†åº¦å‡½æ•°ï¼ˆPDFï¼‰ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šæ¢¯åº¦éš <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> å¹³æ»‘å˜åŒ–ï¼Œè®­ç»ƒæ›´ç¨³å®šã€‚</li>
</ul>
<p>å…¶ä¸­ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">Ï•</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> æ˜¯æ ‡å‡†æ­£æ€åˆ†å¸ƒçš„ PDFã€‚</p>
<h3>ä¸ºä»€ä¹ˆ GELU æ›´é€‚åˆ Transformerï¼Ÿ</h3>
<ol>
<li><strong>å¹³æ»‘æ€§</strong>ï¼šåœ¨ 0 å¤„å¯å¯¼ï¼Œæ¢¯åº¦æ›´ç¨³å®š</li>
<li><strong>éå•è°ƒæ€§</strong>ï¼šå¯¹è´Ÿè¾“å…¥æœ‰éé›¶å“åº”</li>
<li><strong>éšæœºæ­£åˆ™åŒ–è§£é‡Š</strong>ï¼šå¯è§£é‡Šä¸ºéšæœº dropout çš„ç¡®å®šæ€§ç‰ˆæœ¬</li>
</ol>
<h2>Swish</h2>
<h3>æ•°å­¦å®šä¹‰</h3>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Swish</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4445em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05278em;">Î²</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></p>
<p><a id="formula-activation-14"></a>
<a href="#formula-activation-14-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šåœ¨ Sigmoid é—¨æ§åå†ä¹˜ä»¥è¾“å…¥ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span>ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05278em;">Î²</span></span></span></span> æ§åˆ¶é—¨æ§çš„â€œé™¡å³­åº¦â€ï¼Œå¯ä¸ºå¸¸æ•°æˆ–å¯å­¦ä¹ ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05278em;">Î²</span></span></span></span> è¶Šå¤§ï¼Œå‡½æ•°è¶Šæ¥è¿‘ ReLUï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05278em;">Î²</span></span></span></span> è¶Šå°ï¼Œè¶Šå¹³æ»‘ã€‚</li>
</ul>
<p>å½“ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05278em;">Î²</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> æ—¶ï¼ŒSwish ç­‰ä»·äº SiLUã€‚</p>
<h3>ç‰¹ç‚¹</h3>
<ul>
<li>å¹³æ»‘ã€éå•è°ƒ</li>
<li>æ— ä¸Šç•Œã€æœ‰ä¸‹ç•Œ</li>
<li>åœ¨æ·±å±‚ç½‘ç»œä¸­è¡¨ç°ä¼˜äº ReLU</li>
</ul>
<h2>Softmax</h2>
<h3>æ•°å­¦å®šä¹‰</h3>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Softmax</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.6484em;vertical-align:-1.307em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3414em;"><span style="top:-2.1288em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">âˆ‘</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.4358em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6065em;"><span style="top:-3.0051em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.307em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><a id="formula-activation-15"></a>
<a href="#formula-activation-15-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šæŠŠä¸€ç»„å®æ•° <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> å˜æˆæ¦‚ç‡åˆ†å¸ƒï¼ˆå’Œä¸º 1ï¼‰ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span> ä¸ºç±»åˆ«æ•°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºç¬¬ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> ç±»çš„æ‰“åˆ†ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šåˆ†æ•°è¶Šå¤§ï¼ŒæŒ‡æ•°æ”¾å¤§æ•ˆåº”è¶Šå¼ºï¼Œæ¦‚ç‡è¶Šé«˜ã€‚</li>
</ul>
<h3>å¯¼æ•°</h3>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.3991em;vertical-align:-0.9721em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="mord text"><span class="mord">Softmax</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.9721em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord text"><span class="mord">Softmax</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03785em;">Î´</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0379em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord text"><span class="mord">Softmax</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">))</span></span></span></span></span></p>
<p><a id="formula-activation-16"></a>
<a href="#formula-activation-16-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p>å…¶ä¸­ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03785em;">Î´</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0379em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> æ˜¯ Kronecker deltaã€‚</p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šSoftmax çš„æ¢¯åº¦ä¸ä»…ä¸è‡ªèº«æœ‰å…³ï¼Œä¹Ÿä¸å…¶ä»–ç±»åˆ«çš„æ¦‚ç‡ç›¸å…³ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03785em;">Î´</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0379em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> å½“ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span>ï¼Œå¦åˆ™ä¸º 0ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šæå‡æŸä¸€ç±»æ¦‚ç‡ä¼šæŒ¤å‹å…¶ä»–ç±»æ¦‚ç‡ï¼Œä½“ç°â€œç«äº‰å…³ç³»â€ã€‚</li>
</ul>
<h3>æ•°å€¼ç¨³å®šæ€§</h3>
<p>ä¸ºé˜²æ­¢æŒ‡æ•°æº¢å‡ºï¼Œé€šå¸¸å‡å»æœ€å¤§å€¼ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Softmax</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.872em;vertical-align:-1.307em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.565em;"><span style="top:-2.1288em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">âˆ‘</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.4358em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8301em;"><span style="top:-3.0051em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span></span></span></span></span></span></span><span class="mbin mtight">âˆ’</span><span class="mop mtight"><span class="mtight">m</span><span class="mtight">a</span><span class="mtight">x</span></span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">x</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mbin mtight">âˆ’</span><span class="mop mtight"><span class="mtight">m</span><span class="mtight">a</span><span class="mtight">x</span></span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">x</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.307em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><a id="formula-activation-17"></a>
<a href="#formula-activation-17-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šåœ¨æ‰€æœ‰ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸Šå‡å»æœ€å¤§å€¼ä¸æ”¹å˜ç»“æœï¼Œä½†é¿å…æŒ‡æ•°æº¢å‡ºã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">max</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> ä¸ºæ‰€æœ‰è¾“å…¥ä¸­çš„æœ€å¤§å€¼ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šæ•°å€¼ç¨³å®šæ€§æŠ€å·§ï¼Œè¾“å‡ºæ¦‚ç‡ä¸å˜ã€‚</li>
</ul>
<h3>æ¸©åº¦å‚æ•° (Temperature)</h3>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Softmax</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.872em;vertical-align:-1.307em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.565em;"><span style="top:-2.1288em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">âˆ‘</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.4358em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8301em;"><span style="top:-3.0051em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span></span></span></span></span></span></span><span class="mord mtight">/</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mord mtight">/</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.307em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><a id="formula-activation-18"></a>
<a href="#formula-activation-18-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li>
<p><strong>å…¬å¼å«ä¹‰</strong>ï¼šåŠ å…¥æ¸©åº¦å‚æ•° <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span> æ¥æ§åˆ¶åˆ†å¸ƒçš„â€œå°–é”ç¨‹åº¦â€ã€‚</p>
</li>
<li>
<p><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span> è¶Šå¤§ï¼Œåˆ†å¸ƒè¶Šå¹³æ»‘ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span> è¶Šå°ï¼Œåˆ†å¸ƒè¶Šå°–é”ã€‚</p>
</li>
<li>
<p><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šå¯ç”¨äºé‡‡æ ·æ—¶æ§åˆ¶éšæœºæ€§ã€‚</p>
</li>
<li>
<p><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>ï¼šåˆ†å¸ƒæ›´å¹³æ»‘ï¼ˆæ›´éšæœºï¼‰</p>
</li>
<li>
<p><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>ï¼šåˆ†å¸ƒæ›´å°–é”ï¼ˆæ›´ç¡®å®šï¼‰</p>
</li>
<li>
<p><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â†’</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span>ï¼šè¶‹è¿‘äº argmax</p>
</li>
<li>
<p><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â†’</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord">âˆ</span></span></span></span>ï¼šè¶‹è¿‘äºå‡åŒ€åˆ†å¸ƒ</p>
</li>
</ul>
<h2>æ¿€æ´»å‡½æ•°å¯¹æ¯”</h2>
<table>
<thead>
<tr>
<th>æ¿€æ´»å‡½æ•°</th>
<th>å…¬å¼å¤æ‚åº¦</th>
<th>æ¢¯åº¦é—®é¢˜</th>
<th>è®¡ç®—æ•ˆç‡</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td>ReLU</td>
<td>ä½</td>
<td>Dead ReLU</td>
<td>é«˜</td>
<td>é€šç”¨</td>
</tr>
<tr>
<td>LeakyReLU</td>
<td>ä½</td>
<td>è¾ƒå°‘</td>
<td>é«˜</td>
<td>æ›¿ä»£ ReLU</td>
</tr>
<tr>
<td>Sigmoid</td>
<td>é«˜</td>
<td>æ¢¯åº¦æ¶ˆå¤±</td>
<td>ä¸­</td>
<td>äºŒåˆ†ç±»è¾“å‡º</td>
</tr>
<tr>
<td>Tanh</td>
<td>é«˜</td>
<td>æ¢¯åº¦æ¶ˆå¤±</td>
<td>ä¸­</td>
<td>RNN/LSTM</td>
</tr>
<tr>
<td>GELU</td>
<td>é«˜</td>
<td>è¾ƒå°‘</td>
<td>ä¸­</td>
<td>Transformer</td>
</tr>
<tr>
<td>Swish</td>
<td>é«˜</td>
<td>è¾ƒå°‘</td>
<td>ä¸­</td>
<td>æ·±å±‚ç½‘ç»œ</td>
</tr>
</tbody>
</table>
<h2>é€‰æ‹©å»ºè®®</h2>
<ol>
<li><strong>éšè—å±‚é»˜è®¤é€‰æ‹©</strong>ï¼šReLU</li>
<li><strong>Transformer æ¶æ„</strong>ï¼šGELU</li>
<li><strong>äºŒåˆ†ç±»è¾“å‡º</strong>ï¼šSigmoid</li>
<li><strong>å¤šåˆ†ç±»è¾“å‡º</strong>ï¼šSoftmax</li>
<li><strong>RNN/GRU/LSTM</strong>ï¼šTanh</li>
</ol>
<h2>å‚è€ƒæ–‡çŒ®</h2>
<ol>
<li>Nair &amp; Hinton (2010). <em>Rectified Linear Units Improve Restricted Boltzmann Machines</em></li>
<li>Hendrycks &amp; Gimpel (2016). <em>Gaussian Error Linear Units (GELUs)</em></li>
<li>Ramachandran et al. (2017). <em>Searching for Activation Functions</em></li>
<li>Maas et al. (2013). <em>Rectifier Nonlinearities Improve Neural Network Acoustic Models</em></li>
</ol>
<h1>Activation Function æµç¨‹å›¾è§£</h1>
<blockquote>
<p>é€šè¿‡å¯è§†åŒ–å›¾è¡¨ç†è§£æ¿€æ´»å‡½æ•°çš„å·¥ä½œåŸç†</p>
</blockquote>
<h2>æ¿€æ´»å‡½æ•°åœ¨ç¥ç»ç½‘ç»œä¸­çš„ä½ç½®</h2>
<p><div class="mermaid">flowchart LR
    A["çº¿æ€§å˜æ¢&lt;br/&gt;z = Wx + b"] --&gt; B["æ¿€æ´»å‡½æ•°&lt;br/&gt;a = f(z)"]
    B --&gt; C["è¾“å‡º&lt;br/&gt;ä¼ é€’åˆ°ä¸‹ä¸€å±‚"]

    style B fill:#fff9c4</div></p>
<h2>å¸¸è§æ¿€æ´»å‡½æ•°å¯¹æ¯”</h2>
<p><div class="mermaid">flowchart TB
    subgraph ReLU
        R1["f(x) = max(0, x)"]
        R2["ç®€å•å¿«é€Ÿ"]
        R3["å¯èƒ½æœ‰æ­»äº¡ç¥ç»å…ƒ"]
    end

    subgraph GELU
        G1["f(x) = x * Î¦(x)"]
        G2["å¹³æ»‘å¯å¾®"]
        G3["Transformer å¸¸ç”¨"]
    end

    subgraph Softmax
        S1["f(x) = exp(x) / Î£exp"]
        S2["è¾“å‡ºä¸ºæ¦‚ç‡åˆ†å¸ƒ"]
        S3["ç”¨äºè¾“å‡ºå±‚"]
    end

    style R1 fill:#bbdefb
    style G1 fill:#c8e6c9
    style S1 fill:#fff9c4</div></p>
<h2>ReLU å·¥ä½œæµç¨‹</h2>
<p><div class="mermaid">flowchart TB
    A["è¾“å…¥ z"] --&gt; B{"z &gt; 0?"}
    B --&gt;|"æ˜¯"| C["è¾“å‡º = z"]
    B --&gt;|"å¦"| D["è¾“å‡º = 0"]

    C --&gt; E["ç¥ç»å…ƒæ¿€æ´»"]
    D --&gt; F["ç¥ç»å…ƒé™æ¯"]

    style E fill:#c8e6c9
    style F fill:#ffcdd2</div></p>
<h2>GELU vs ReLU</h2>
<p><div class="mermaid">flowchart LR
    subgraph ReLU
        R["ç¡¬åˆ‡æ¢&lt;br/&gt;åœ¨ 0 å¤„ä¸å¯å¾®"]
    end

    subgraph GELU
        G["å¹³æ»‘è¿‡æ¸¡&lt;br/&gt;å¤„å¤„å¯å¾®"]
    end

    G --&gt; A["æ›´é€‚åˆæ·±åº¦ç½‘ç»œ"]
    R --&gt; B["è®¡ç®—æ›´å¿«"]

    style A fill:#c8e6c9</div></p>
<h2>Softmax è®¡ç®—æµç¨‹</h2>
<p><div class="mermaid">flowchart TB
    A["logits&lt;br/&gt;[2.0, 1.0, 0.1]"] --&gt; B["exp&lt;br/&gt;[7.39, 2.72, 1.11]"]
    B --&gt; C["æ±‚å’Œ&lt;br/&gt;11.22"]
    C --&gt; D["å½’ä¸€åŒ–&lt;br/&gt;[0.66, 0.24, 0.10]"]

    D --&gt; E["æ¦‚ç‡åˆ†å¸ƒ&lt;br/&gt;å’Œä¸º 1"]

    style E fill:#c8e6c9</div></p>
<h2>FFN ä¸­çš„æ¿€æ´»å‡½æ•°</h2>
<p><div class="mermaid">flowchart LR
    A["è¾“å…¥ x"] --&gt; B["çº¿æ€§å±‚ Up&lt;br/&gt;W1 * x"]
    B --&gt; C["æ¿€æ´»å‡½æ•°&lt;br/&gt;GELU/ReLU"]
    C --&gt; D["çº¿æ€§å±‚ Down&lt;br/&gt;W2 * x"]
    D --&gt; E["è¾“å‡º"]

    style C fill:#fff9c4</div></p>
<h2>SwiGLU ç»“æ„</h2>
<p><div class="mermaid">flowchart TB
    A["è¾“å…¥ x"] --&gt; B["W_gate * x"]
    A --&gt; C["W_up * x"]

    B --&gt; D["SiLU æ¿€æ´»"]
    D --&gt; E["é€å…ƒç´ ç›¸ä¹˜"]
    C --&gt; E

    E --&gt; F["W_down"]
    F --&gt; G["è¾“å‡º"]

    style G fill:#c8e6c9</div></p>
<h2>å›¾è§£è¯´æ˜</h2>
<h3>æ¿€æ´»å‡½æ•°é€‰æ‹©</h3>
<table>
<thead>
<tr>
<th>åœºæ™¯</th>
<th>æ¨è</th>
<th>åŸå› </th>
</tr>
</thead>
<tbody>
<tr>
<td>FFN (ç»å…¸)</td>
<td>ReLU</td>
<td>ç®€å•å¿«é€Ÿ</td>
</tr>
<tr>
<td>FFN (ç°ä»£)</td>
<td>GELU</td>
<td>æ›´å¹³æ»‘</td>
</tr>
<tr>
<td>FFN (LLaMA)</td>
<td>SwiGLU</td>
<td>æ€§èƒ½æœ€å¥½</td>
</tr>
<tr>
<td>è¾“å‡ºå±‚</td>
<td>Softmax</td>
<td>æ¦‚ç‡åˆ†å¸ƒ</td>
</tr>
</tbody>
</table>
<h3>å…³é”®ç‰¹æ€§</h3>
<ul>
<li><strong>éçº¿æ€§</strong>ï¼šä½¿ç½‘ç»œèƒ½å­¦ä¹ å¤æ‚æ¨¡å¼</li>
<li><strong>æ¢¯åº¦æµ</strong>ï¼šå½±å“è®­ç»ƒç¨³å®šæ€§</li>
<li><strong>è®¡ç®—æ•ˆç‡</strong>ï¼šå½±å“æ¨ç†é€Ÿåº¦</li>
</ul>
<div class="code-appendix page-break"><h2>é™„å½•ï¼šä»£ç ç¤ºä¾‹</h2><div class="code-file"><h3>activation_comparison.py</h3><pre class="hljs"><code><span class="hljs-string">&quot;&quot;&quot;
æ¿€æ´»å‡½æ•°å¯¹æ¯”ç¤ºä¾‹ / Activation Functions Comparison Example
=========================================================

æœ¬ç¤ºä¾‹å±•ç¤ºå„ç§æ¿€æ´»å‡½æ•°çš„ç‰¹æ€§å’Œå¯¹æ¯”ã€‚
This example demonstrates the properties and comparison of various activation functions.

ä¾èµ–å®‰è£… / Dependencies:
    pip install torch matplotlib numpy
&quot;&quot;&quot;</span>

<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn
<span class="hljs-keyword">import</span> torch.nn.functional <span class="hljs-keyword">as</span> F
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 1. å®šä¹‰å„ç§æ¿€æ´»å‡½æ•° / Define Various Activation Functions</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">relu</span>(<span class="hljs-params">x</span>):
    <span class="hljs-string">&quot;&quot;&quot;ReLU: max(0, x)&quot;&quot;&quot;</span>
    <span class="hljs-keyword">return</span> np.maximum(<span class="hljs-number">0</span>, x)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">leaky_relu</span>(<span class="hljs-params">x, alpha=<span class="hljs-number">0.01</span></span>):
    <span class="hljs-string">&quot;&quot;&quot;Leaky ReLU: max(alpha*x, x)&quot;&quot;&quot;</span>
    <span class="hljs-keyword">return</span> np.where(x &gt; <span class="hljs-number">0</span>, x, alpha * x)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">sigmoid</span>(<span class="hljs-params">x</span>):
    <span class="hljs-string">&quot;&quot;&quot;Sigmoid: 1 / (1 + exp(-x))&quot;&quot;&quot;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span> / (<span class="hljs-number">1</span> + np.exp(-np.clip(x, -<span class="hljs-number">500</span>, <span class="hljs-number">500</span>)))

<span class="hljs-keyword">def</span> <span class="hljs-title function_">tanh_func</span>(<span class="hljs-params">x</span>):
    <span class="hljs-string">&quot;&quot;&quot;Tanh: (exp(x) - exp(-x)) / (exp(x) + exp(-x))&quot;&quot;&quot;</span>
    <span class="hljs-keyword">return</span> np.tanh(x)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">gelu</span>(<span class="hljs-params">x</span>):
    <span class="hljs-string">&quot;&quot;&quot;GELU: x * Phi(x) (ä½¿ç”¨ tanh è¿‘ä¼¼)&quot;&quot;&quot;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0.5</span> * x * (<span class="hljs-number">1</span> + np.tanh(np.sqrt(<span class="hljs-number">2</span> / np.pi) * (x + <span class="hljs-number">0.044715</span> * x**<span class="hljs-number">3</span>)))

<span class="hljs-keyword">def</span> <span class="hljs-title function_">swish</span>(<span class="hljs-params">x, beta=<span class="hljs-number">1.0</span></span>):
    <span class="hljs-string">&quot;&quot;&quot;Swish: x * sigmoid(beta * x)&quot;&quot;&quot;</span>
    <span class="hljs-keyword">return</span> x * sigmoid(beta * x)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">elu</span>(<span class="hljs-params">x, alpha=<span class="hljs-number">1.0</span></span>):
    <span class="hljs-string">&quot;&quot;&quot;ELU: x if x &gt; 0 else alpha * (exp(x) - 1)&quot;&quot;&quot;</span>
    <span class="hljs-keyword">return</span> np.where(x &gt; <span class="hljs-number">0</span>, x, alpha * (np.exp(np.clip(x, -<span class="hljs-number">500</span>, <span class="hljs-number">500</span>)) - <span class="hljs-number">1</span>))

<span class="hljs-keyword">def</span> <span class="hljs-title function_">softplus</span>(<span class="hljs-params">x</span>):
    <span class="hljs-string">&quot;&quot;&quot;Softplus: log(1 + exp(x))&quot;&quot;&quot;</span>
    <span class="hljs-keyword">return</span> np.log1p(np.exp(np.clip(x, -<span class="hljs-number">500</span>, <span class="hljs-number">500</span>)))

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 2. å¯è§†åŒ–æ¿€æ´»å‡½æ•° / Visualize Activation Functions</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;æ¿€æ´»å‡½æ•°å¯è§†åŒ– / Activation Functions Visualization&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-comment"># åˆ›å»ºè¾“å…¥èŒƒå›´ / Create input range</span>
x = np.linspace(-<span class="hljs-number">5</span>, <span class="hljs-number">5</span>, <span class="hljs-number">1000</span>)

<span class="hljs-comment"># è®¡ç®—å„æ¿€æ´»å‡½æ•°è¾“å‡º / Compute outputs for each activation</span>
activations = {
    <span class="hljs-string">&#x27;ReLU&#x27;</span>: relu(x),
    <span class="hljs-string">&#x27;Leaky ReLU&#x27;</span>: leaky_relu(x),
    <span class="hljs-string">&#x27;Sigmoid&#x27;</span>: sigmoid(x),
    <span class="hljs-string">&#x27;Tanh&#x27;</span>: tanh_func(x),
    <span class="hljs-string">&#x27;GELU&#x27;</span>: gelu(x),
    <span class="hljs-string">&#x27;Swish&#x27;</span>: swish(x),
    <span class="hljs-string">&#x27;ELU&#x27;</span>: elu(x),
    <span class="hljs-string">&#x27;Softplus&#x27;</span>: softplus(x),
}

<span class="hljs-comment"># ç»˜åˆ¶æ¿€æ´»å‡½æ•° / Plot activation functions</span>
fig, axes = plt.subplots(<span class="hljs-number">2</span>, <span class="hljs-number">4</span>, figsize=(<span class="hljs-number">16</span>, <span class="hljs-number">8</span>))
axes = axes.flatten()

<span class="hljs-keyword">for</span> idx, (name, y) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(activations.items()):
    ax = axes[idx]
    ax.plot(x, y, linewidth=<span class="hljs-number">2</span>, label=name)
    ax.axhline(y=<span class="hljs-number">0</span>, color=<span class="hljs-string">&#x27;k&#x27;</span>, linestyle=<span class="hljs-string">&#x27;--&#x27;</span>, alpha=<span class="hljs-number">0.3</span>)
    ax.axvline(x=<span class="hljs-number">0</span>, color=<span class="hljs-string">&#x27;k&#x27;</span>, linestyle=<span class="hljs-string">&#x27;--&#x27;</span>, alpha=<span class="hljs-number">0.3</span>)
    ax.set_title(name, fontsize=<span class="hljs-number">14</span>)
    ax.set_xlabel(<span class="hljs-string">&#x27;x&#x27;</span>)
    ax.set_ylabel(<span class="hljs-string">&#x27;f(x)&#x27;</span>)
    ax.grid(<span class="hljs-literal">True</span>, alpha=<span class="hljs-number">0.3</span>)
    ax.set_xlim(-<span class="hljs-number">5</span>, <span class="hljs-number">5</span>)
    ax.legend()

plt.tight_layout()
plt.savefig(<span class="hljs-string">&#x27;/tmp/activation_functions.png&#x27;</span>, dpi=<span class="hljs-number">150</span>, bbox_inches=<span class="hljs-string">&#x27;tight&#x27;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\næ¿€æ´»å‡½æ•°å›¾åƒå·²ä¿å­˜è‡³ / Image saved to: /tmp/activation_functions.png&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 3. å¯è§†åŒ–å¯¼æ•° / Visualize Derivatives</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;æ¿€æ´»å‡½æ•°å¯¼æ•° / Activation Function Derivatives&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-comment"># è®¡ç®—å¯¼æ•°ï¼ˆä½¿ç”¨æ•°å€¼å¾®åˆ†ï¼‰/ Compute derivatives (numerical)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">numerical_derivative</span>(<span class="hljs-params">f, x, h=<span class="hljs-number">1e-5</span></span>):
    <span class="hljs-keyword">return</span> (f(x + h) - f(x - h)) / (<span class="hljs-number">2</span> * h)

derivatives = {
    <span class="hljs-string">&#x27;ReLU&#x27;</span>: numerical_derivative(relu, x),
    <span class="hljs-string">&#x27;Leaky ReLU&#x27;</span>: numerical_derivative(leaky_relu, x),
    <span class="hljs-string">&#x27;Sigmoid&#x27;</span>: numerical_derivative(sigmoid, x),
    <span class="hljs-string">&#x27;Tanh&#x27;</span>: numerical_derivative(tanh_func, x),
    <span class="hljs-string">&#x27;GELU&#x27;</span>: numerical_derivative(gelu, x),
    <span class="hljs-string">&#x27;Swish&#x27;</span>: numerical_derivative(swish, x),
}

fig, axes = plt.subplots(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, figsize=(<span class="hljs-number">14</span>, <span class="hljs-number">8</span>))
axes = axes.flatten()

<span class="hljs-keyword">for</span> idx, (name, dy) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(derivatives.items()):
    ax = axes[idx]
    ax.plot(x, dy, linewidth=<span class="hljs-number">2</span>, color=<span class="hljs-string">&#x27;orange&#x27;</span>, label=<span class="hljs-string">f&quot;<span class="hljs-subst">{name}</span>&#x27;&quot;</span>)
    ax.axhline(y=<span class="hljs-number">0</span>, color=<span class="hljs-string">&#x27;k&#x27;</span>, linestyle=<span class="hljs-string">&#x27;--&#x27;</span>, alpha=<span class="hljs-number">0.3</span>)
    ax.axvline(x=<span class="hljs-number">0</span>, color=<span class="hljs-string">&#x27;k&#x27;</span>, linestyle=<span class="hljs-string">&#x27;--&#x27;</span>, alpha=<span class="hljs-number">0.3</span>)
    ax.set_title(<span class="hljs-string">f&quot;<span class="hljs-subst">{name}</span> Derivative&quot;</span>, fontsize=<span class="hljs-number">14</span>)
    ax.set_xlabel(<span class="hljs-string">&#x27;x&#x27;</span>)
    ax.set_ylabel(<span class="hljs-string">&quot;f&#x27;(x)&quot;</span>)
    ax.grid(<span class="hljs-literal">True</span>, alpha=<span class="hljs-number">0.3</span>)
    ax.set_xlim(-<span class="hljs-number">5</span>, <span class="hljs-number">5</span>)
    ax.legend()

plt.tight_layout()
plt.savefig(<span class="hljs-string">&#x27;/tmp/activation_derivatives.png&#x27;</span>, dpi=<span class="hljs-number">150</span>, bbox_inches=<span class="hljs-string">&#x27;tight&#x27;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;å¯¼æ•°å›¾åƒå·²ä¿å­˜è‡³ / Derivative image saved to: /tmp/activation_derivatives.png&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 4. æ¢¯åº¦æ¶ˆå¤±é—®é¢˜æ¼”ç¤º / Vanishing Gradient Demonstration</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;æ¢¯åº¦æ¶ˆå¤±é—®é¢˜æ¼”ç¤º / Vanishing Gradient Demonstration&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-comment"># æ¨¡æ‹Ÿæ·±å±‚ç½‘ç»œçš„æ¢¯åº¦ä¼ æ’­ / Simulate gradient propagation in deep networks</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">simulate_gradient_flow</span>(<span class="hljs-params">activation_fn, num_layers=<span class="hljs-number">20</span>, initial_grad=<span class="hljs-number">1.0</span></span>):
    <span class="hljs-string">&quot;&quot;&quot;
    æ¨¡æ‹Ÿæ¢¯åº¦åœ¨æ·±å±‚ç½‘ç»œä¸­çš„ä¼ æ’­
    Simulate gradient propagation through deep layers
    &quot;&quot;&quot;</span>
    gradients = [initial_grad]
    grad = initial_grad

    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_layers):
        <span class="hljs-comment"># å‡è®¾æ¯å±‚çš„æ¿€æ´»å¯¼æ•°åœ¨ [-1, 1] èŒƒå›´å†…çš„æŸä¸ªå€¼</span>
        <span class="hljs-comment"># Sigmoid å’Œ Tanh åœ¨é¥±å’ŒåŒºçš„å¯¼æ•°å¾ˆå°</span>
        <span class="hljs-keyword">if</span> activation_fn == <span class="hljs-string">&#x27;sigmoid&#x27;</span>:
            <span class="hljs-comment"># Sigmoid æœ€å¤§å¯¼æ•°ä¸º 0.25</span>
            grad *= <span class="hljs-number">0.25</span>
        <span class="hljs-keyword">elif</span> activation_fn == <span class="hljs-string">&#x27;tanh&#x27;</span>:
            <span class="hljs-comment"># Tanh æœ€å¤§å¯¼æ•°ä¸º 1ï¼Œä½†åœ¨é¥±å’ŒåŒºå¾ˆå°</span>
            grad *= <span class="hljs-number">0.5</span>
        <span class="hljs-keyword">elif</span> activation_fn == <span class="hljs-string">&#x27;relu&#x27;</span>:
            <span class="hljs-comment"># ReLU å¯¼æ•°ä¸º 0 æˆ– 1</span>
            grad *= <span class="hljs-number">1.0</span>  <span class="hljs-comment"># å‡è®¾ä¸è¿›å…¥è´ŸåŒº</span>
        <span class="hljs-keyword">elif</span> activation_fn == <span class="hljs-string">&#x27;gelu&#x27;</span>:
            <span class="hljs-comment"># GELU å¯¼æ•°åœ¨æ­£åŒºæ¥è¿‘ 1</span>
            grad *= <span class="hljs-number">0.95</span>
        gradients.append(grad)

    <span class="hljs-keyword">return</span> gradients

plt.figure(figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">6</span>))

<span class="hljs-keyword">for</span> act_name <span class="hljs-keyword">in</span> [<span class="hljs-string">&#x27;sigmoid&#x27;</span>, <span class="hljs-string">&#x27;tanh&#x27;</span>, <span class="hljs-string">&#x27;relu&#x27;</span>, <span class="hljs-string">&#x27;gelu&#x27;</span>]:
    grads = simulate_gradient_flow(act_name)
    plt.plot(<span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(grads)), grads, linewidth=<span class="hljs-number">2</span>, marker=<span class="hljs-string">&#x27;o&#x27;</span>, label=act_name.upper())

plt.xlabel(<span class="hljs-string">&#x27;Layer / å±‚&#x27;</span>, fontsize=<span class="hljs-number">12</span>)
plt.ylabel(<span class="hljs-string">&#x27;Gradient Magnitude / æ¢¯åº¦å¤§å°&#x27;</span>, fontsize=<span class="hljs-number">12</span>)
plt.title(<span class="hljs-string">&#x27;Gradient Flow Through Deep Layers / æ·±å±‚ç½‘ç»œä¸­çš„æ¢¯åº¦æµ&#x27;</span>, fontsize=<span class="hljs-number">14</span>)
plt.yscale(<span class="hljs-string">&#x27;log&#x27;</span>)
plt.legend()
plt.grid(<span class="hljs-literal">True</span>, alpha=<span class="hljs-number">0.3</span>)

plt.tight_layout()
plt.savefig(<span class="hljs-string">&#x27;/tmp/gradient_flow.png&#x27;</span>, dpi=<span class="hljs-number">150</span>, bbox_inches=<span class="hljs-string">&#x27;tight&#x27;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;æ¢¯åº¦æµå›¾åƒå·²ä¿å­˜è‡³ / Gradient flow image saved to: /tmp/gradient_flow.png&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 5. PyTorch å®ç°å¯¹æ¯” / PyTorch Implementation Comparison</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;PyTorch å®ç°å¯¹æ¯” / PyTorch Implementation Comparison&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

x_torch = torch.linspace(-<span class="hljs-number">5</span>, <span class="hljs-number">5</span>, <span class="hljs-number">1000</span>)

<span class="hljs-comment"># PyTorch å†…ç½®æ¿€æ´»å‡½æ•° / PyTorch built-in activation functions</span>
pytorch_activations = {
    <span class="hljs-string">&#x27;ReLU&#x27;</span>: F.relu(x_torch),
    <span class="hljs-string">&#x27;Leaky ReLU&#x27;</span>: F.leaky_relu(x_torch, <span class="hljs-number">0.01</span>),
    <span class="hljs-string">&#x27;Sigmoid&#x27;</span>: torch.sigmoid(x_torch),
    <span class="hljs-string">&#x27;Tanh&#x27;</span>: torch.tanh(x_torch),
    <span class="hljs-string">&#x27;GELU&#x27;</span>: F.gelu(x_torch),
    <span class="hljs-string">&#x27;SiLU (Swish)&#x27;</span>: F.silu(x_torch),
    <span class="hljs-string">&#x27;ELU&#x27;</span>: F.elu(x_torch),
    <span class="hljs-string">&#x27;Softplus&#x27;</span>: F.softplus(x_torch),
}

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\nå„æ¿€æ´»å‡½æ•°åœ¨ x=0 å¤„çš„å€¼ / Values at x=0:&quot;</span>)
<span class="hljs-keyword">for</span> name, y <span class="hljs-keyword">in</span> pytorch_activations.items():
    idx = <span class="hljs-built_in">len</span>(x_torch) // <span class="hljs-number">2</span>  <span class="hljs-comment"># x=0 çš„ç´¢å¼•</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  <span class="hljs-subst">{name}</span>: <span class="hljs-subst">{y[idx].item():<span class="hljs-number">.4</span>f}</span>&quot;</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\nå„æ¿€æ´»å‡½æ•°åœ¨ x=2 å¤„çš„å€¼ / Values at x=2:&quot;</span>)
<span class="hljs-keyword">for</span> name, y <span class="hljs-keyword">in</span> pytorch_activations.items():
    idx = <span class="hljs-built_in">int</span>(<span class="hljs-number">0.7</span> * <span class="hljs-built_in">len</span>(x_torch))  <span class="hljs-comment"># xâ‰ˆ2 çš„ç´¢å¼•</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  <span class="hljs-subst">{name}</span>: <span class="hljs-subst">{y[idx].item():<span class="hljs-number">.4</span>f}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 6. Softmax è¯¦è§£ / Softmax Detailed Explanation</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Softmax è¯¦è§£ / Softmax Detailed Explanation&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">softmax</span>(<span class="hljs-params">x, temperature=<span class="hljs-number">1.0</span></span>):
    <span class="hljs-string">&quot;&quot;&quot;
    Softmax å‡½æ•°ï¼ˆå¸¦æ¸©åº¦å‚æ•°ï¼‰
    Softmax function with temperature parameter
    &quot;&quot;&quot;</span>
    x_scaled = x / temperature
    e_x = np.exp(x_scaled - np.<span class="hljs-built_in">max</span>(x_scaled))  <span class="hljs-comment"># æ•°å€¼ç¨³å®šæ€§</span>
    <span class="hljs-keyword">return</span> e_x / e_x.<span class="hljs-built_in">sum</span>()

<span class="hljs-comment"># æ¼”ç¤ºæ¸©åº¦å‚æ•°æ•ˆæœ / Demonstrate temperature parameter effect</span>
logits = np.array([<span class="hljs-number">2.0</span>, <span class="hljs-number">1.0</span>, <span class="hljs-number">0.1</span>])

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\nåŸå§‹ logits / Original logits:&quot;</span>, logits)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\nä¸åŒæ¸©åº¦ä¸‹çš„ Softmax è¾“å‡º / Softmax outputs with different temperatures:&quot;</span>)

temperatures = [<span class="hljs-number">0.1</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">1.0</span>, <span class="hljs-number">2.0</span>, <span class="hljs-number">5.0</span>, <span class="hljs-number">10.0</span>]
<span class="hljs-keyword">for</span> T <span class="hljs-keyword">in</span> temperatures:
    probs = softmax(logits, T)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  T=<span class="hljs-subst">{T:<span class="hljs-number">4.1</span>f}</span>: <span class="hljs-subst">{probs}</span>&quot;</span>)

<span class="hljs-comment"># å¯è§†åŒ–æ¸©åº¦æ•ˆæœ / Visualize temperature effect</span>
fig, ax = plt.subplots(figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">6</span>))

x_bar = np.arange(<span class="hljs-built_in">len</span>(logits))
width = <span class="hljs-number">0.12</span>

<span class="hljs-keyword">for</span> i, T <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(temperatures):
    probs = softmax(logits, T)
    ax.bar(x_bar + i * width, probs, width, label=<span class="hljs-string">f&#x27;T=<span class="hljs-subst">{T}</span>&#x27;</span>)

ax.set_xlabel(<span class="hljs-string">&#x27;Class / ç±»åˆ«&#x27;</span>, fontsize=<span class="hljs-number">12</span>)
ax.set_ylabel(<span class="hljs-string">&#x27;Probability / æ¦‚ç‡&#x27;</span>, fontsize=<span class="hljs-number">12</span>)
ax.set_title(<span class="hljs-string">&#x27;Softmax Temperature Effect / Softmax æ¸©åº¦å‚æ•°æ•ˆæœ&#x27;</span>, fontsize=<span class="hljs-number">14</span>)
ax.set_xticks(x_bar + width * <span class="hljs-number">2.5</span>)
ax.set_xticklabels([<span class="hljs-string">&#x27;Class 0 (logit=2.0)&#x27;</span>, <span class="hljs-string">&#x27;Class 1 (logit=1.0)&#x27;</span>, <span class="hljs-string">&#x27;Class 2 (logit=0.1)&#x27;</span>])
ax.legend()
ax.grid(<span class="hljs-literal">True</span>, alpha=<span class="hljs-number">0.3</span>, axis=<span class="hljs-string">&#x27;y&#x27;</span>)

plt.tight_layout()
plt.savefig(<span class="hljs-string">&#x27;/tmp/softmax_temperature.png&#x27;</span>, dpi=<span class="hljs-number">150</span>, bbox_inches=<span class="hljs-string">&#x27;tight&#x27;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nSoftmax æ¸©åº¦å›¾åƒå·²ä¿å­˜è‡³ / Softmax temperature image saved to: /tmp/softmax_temperature.png&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># æ€»ç»“ / Summary</span>
<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;æ€»ç»“ / Summary&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-string">&quot;&quot;&quot;
æœ¬ç¤ºä¾‹å±•ç¤ºäº†å„ç§æ¿€æ´»å‡½æ•°çš„ç‰¹æ€§:
This example demonstrates the characteristics of various activation functions:

1. ReLU: ç®€å•é«˜æ•ˆï¼Œä½†æœ‰ Dead ReLU é—®é¢˜
   Simple and efficient, but has Dead ReLU problem

2. Leaky ReLU: è§£å†³ Dead ReLUï¼Œå…è®¸å°æ¢¯åº¦æµè¿‡è´ŸåŒº
   Solves Dead ReLU, allows small gradient flow in negative region

3. Sigmoid: è¾“å‡º [0,1]ï¼Œé€‚åˆäºŒåˆ†ç±»ï¼Œä½†æœ‰æ¢¯åº¦æ¶ˆå¤±é—®é¢˜
   Output [0,1], suitable for binary classification, but has vanishing gradient

4. Tanh: è¾“å‡º [-1,1]ï¼Œé›¶ä¸­å¿ƒï¼Œä½†ä»æœ‰æ¢¯åº¦æ¶ˆå¤±
   Output [-1,1], zero-centered, but still has vanishing gradient

5. GELU: å¹³æ»‘ã€éå•è°ƒï¼ŒTransformer é¦–é€‰
   Smooth, non-monotonic, preferred in Transformers

6. Swish: è‡ªé—¨æ§ï¼Œåœ¨æ·±å±‚ç½‘ç»œè¡¨ç°ä¼˜ç§€
   Self-gated, performs well in deep networks

7. Softmax: å¤šåˆ†ç±»è¾“å‡ºï¼Œæ¸©åº¦å‚æ•°æ§åˆ¶åˆ†å¸ƒå¹³æ»‘åº¦
   Multi-class output, temperature controls distribution smoothness
&quot;&quot;&quot;</span>
</code></pre></div><div class="code-file"><h3>gelu_example.py</h3><pre class="hljs"><code><span class="hljs-string">&quot;&quot;&quot;
GELU æ¿€æ´»å‡½æ•°ç¤ºä¾‹ / GELU Activation Function Example
====================================================

æœ¬ç¤ºä¾‹æ·±å…¥å±•ç¤º GELU (Gaussian Error Linear Unit) çš„åŸç†å’Œå®ç°ã€‚
This example demonstrates the principle and implementation of GELU.

GELU æ˜¯ Transformer å’Œç°ä»£ LLM ä¸­æœ€å¸¸ç”¨çš„æ¿€æ´»å‡½æ•°ã€‚
GELU is the most commonly used activation function in Transformers and modern LLMs.

ä¾èµ–å®‰è£… / Dependencies:
    pip install torch matplotlib numpy scipy
&quot;&quot;&quot;</span>

<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn
<span class="hljs-keyword">import</span> torch.nn.functional <span class="hljs-keyword">as</span> F
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">from</span> scipy.stats <span class="hljs-keyword">import</span> norm
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 1. GELU æ•°å­¦å®šä¹‰ / Mathematical Definition of GELU</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;GELU æ•°å­¦å®šä¹‰ / GELU Mathematical Definition&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&quot;&quot;
GELU (Gaussian Error Linear Unit) çš„æ•°å­¦å®šä¹‰:

    GELU(x) = x * P(X â‰¤ x) = x * Î¦(x)

å…¶ä¸­ Î¦(x) æ˜¯æ ‡å‡†æ­£æ€åˆ†å¸ƒçš„ç´¯ç§¯åˆ†å¸ƒå‡½æ•° (CDF):
    Î¦(x) = (1/2) * [1 + erf(x / âˆš2)]

erf æ˜¯è¯¯å·®å‡½æ•° (Error Function)
&quot;&quot;&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 2. GELU çš„ä¸åŒå®ç°æ–¹å¼ / Different Implementations of GELU</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">GELUExact</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;
    ç²¾ç¡®çš„ GELU å®ç°ï¼ˆä½¿ç”¨ erfï¼‰
    Exact GELU implementation (using erf)
    &quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-keyword">return</span> x * <span class="hljs-number">0.5</span> * (<span class="hljs-number">1.0</span> + torch.erf(x / np.sqrt(<span class="hljs-number">2.0</span>)))

<span class="hljs-keyword">class</span> <span class="hljs-title class_">GELUTanh</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;
    Tanh è¿‘ä¼¼çš„ GELU å®ç°ï¼ˆPyTorch é»˜è®¤ä½¿ç”¨æ­¤è¿‘ä¼¼ï¼‰
    Tanh approximation of GELU (PyTorch uses this by default)
    &quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-number">0.5</span> * x * (<span class="hljs-number">1.0</span> + torch.tanh(
            np.sqrt(<span class="hljs-number">2.0</span> / np.pi) * (x + <span class="hljs-number">0.044715</span> * torch.<span class="hljs-built_in">pow</span>(x, <span class="hljs-number">3</span>))
        ))

<span class="hljs-keyword">class</span> <span class="hljs-title class_">GELUSigmoid</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;
    Sigmoid è¿‘ä¼¼çš„ GELUï¼ˆä¹Ÿç§°ä¸º SiLU æˆ– Swishï¼‰
    Sigmoid approximation of GELU (also known as SiLU or Swish)
    &quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-keyword">return</span> x * torch.sigmoid(x)

<span class="hljs-comment"># å¯¹æ¯”ä¸åŒå®ç° / Compare different implementations</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ä¸åŒ GELU å®ç°å¯¹æ¯” / Comparing Different GELU Implementations&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

x = torch.linspace(-<span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1000</span>)

gelu_exact = GELUExact()
gelu_tanh = GELUTanh()
gelu_sigmoid = GELUSigmoid()

y_exact = gelu_exact(x)
y_tanh = gelu_tanh(x)
y_sigmoid = gelu_sigmoid(x)
y_pytorch = F.gelu(x)  <span class="hljs-comment"># PyTorch å†…ç½®</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nå„å®ç°åœ¨å…³é”®ç‚¹çš„å€¼ / Values at key points:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">{<span class="hljs-string">&#x27;x&#x27;</span>:&gt;<span class="hljs-number">6</span>}</span> | <span class="hljs-subst">{<span class="hljs-string">&#x27;Exact&#x27;</span>:&gt;<span class="hljs-number">10</span>}</span> | <span class="hljs-subst">{<span class="hljs-string">&#x27;Tanh Approx&#x27;</span>:&gt;<span class="hljs-number">12</span>}</span> | <span class="hljs-subst">{<span class="hljs-string">&#x27;Sigmoid&#x27;</span>:&gt;<span class="hljs-number">10</span>}</span> | <span class="hljs-subst">{<span class="hljs-string">&#x27;PyTorch&#x27;</span>:&gt;<span class="hljs-number">10</span>}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">60</span>)

test_points = [-<span class="hljs-number">3</span>, -<span class="hljs-number">2</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">0.5</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]
<span class="hljs-keyword">for</span> val <span class="hljs-keyword">in</span> test_points:
    x_test = torch.tensor(val)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">{val:&gt;<span class="hljs-number">6.1</span>f}</span> | <span class="hljs-subst">{gelu_exact(x_test).item():&gt;<span class="hljs-number">10.6</span>f}</span> | &quot;</span>
          <span class="hljs-string">f&quot;<span class="hljs-subst">{gelu_tanh(x_test).item():&gt;<span class="hljs-number">12.6</span>f}</span> | &quot;</span>
          <span class="hljs-string">f&quot;<span class="hljs-subst">{gelu_sigmoid(x_test).item():&gt;<span class="hljs-number">10.6</span>f}</span> | &quot;</span>
          <span class="hljs-string">f&quot;<span class="hljs-subst">{F.gelU(x_test).item():&gt;<span class="hljs-number">10.6</span>f}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 3. GELU vs ReLU å¯¹æ¯” / GELU vs ReLU Comparison</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;GELU vs ReLU å¯¹æ¯” / GELU vs ReLU Comparison&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">relu</span>(<span class="hljs-params">x</span>):
    <span class="hljs-keyword">return</span> np.maximum(<span class="hljs-number">0</span>, x)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">gelu_numpy</span>(<span class="hljs-params">x</span>):
    <span class="hljs-keyword">return</span> x * norm.cdf(x)

x_np = np.linspace(-<span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1000</span>)
y_relu = relu(x_np)
y_gelu = gelu_numpy(x_np)

<span class="hljs-comment"># è®¡ç®—å·®å¼‚ / Compute differences</span>
diff = np.<span class="hljs-built_in">abs</span>(y_gelu - y_relu)
max_diff = np.<span class="hljs-built_in">max</span>(diff)
max_diff_idx = np.argmax(diff)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\næœ€å¤§å·®å¼‚ / Maximum difference: <span class="hljs-subst">{max_diff:<span class="hljs-number">.6</span>f}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;æœ€å¤§å·®å¼‚ä½ç½® / Location of max difference: x = <span class="hljs-subst">{x_np[max_diff_idx]:<span class="hljs-number">.4</span>f}</span>&quot;</span>)

<span class="hljs-comment"># å…³é”®åŒºåˆ« / Key differences</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&quot;&quot;
å…³é”®åŒºåˆ« / Key Differences:

1. GELU åœ¨è´ŸåŒºé—´æœ‰éé›¶è¾“å‡ºï¼ˆæ›²çº¿å¹³æ»‘è¿‡æ¸¡ï¼‰
   GELU has non-zero output in negative region (smooth transition)

2. ReLU åœ¨ x=0 å¤„ä¸å¯å¯¼ï¼ŒGELU å¤„å¤„å¯å¯¼
   ReLU is not differentiable at x=0, GELU is differentiable everywhere

3. GELU æ˜¯éå•è°ƒçš„ï¼ˆåœ¨è´ŸåŒºé—´ç•¥æœ‰ä¸‹é™ï¼‰
   GELU is non-monotonic (slightly decreases in negative region)

4. GELU å¯ä»¥è§£é‡Šä¸ºéšæœºæ­£åˆ™åŒ–çš„æœŸæœ›
   GELU can be interpreted as the expectation of stochastic regularization
&quot;&quot;&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 4. å¯è§†åŒ– / Visualization</span>
<span class="hljs-comment"># =============================================================================</span>

fig, axes = plt.subplots(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, figsize=(<span class="hljs-number">12</span>, <span class="hljs-number">10</span>))

<span class="hljs-comment"># 4.1 æ¿€æ´»å‡½æ•°å¯¹æ¯” / Activation function comparison</span>
ax1 = axes[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>]
ax1.plot(x_np, y_relu, <span class="hljs-string">&#x27;b-&#x27;</span>, linewidth=<span class="hljs-number">2</span>, label=<span class="hljs-string">&#x27;ReLU&#x27;</span>)
ax1.plot(x_np, y_gelu, <span class="hljs-string">&#x27;r-&#x27;</span>, linewidth=<span class="hljs-number">2</span>, label=<span class="hljs-string">&#x27;GELU&#x27;</span>)
ax1.axhline(y=<span class="hljs-number">0</span>, color=<span class="hljs-string">&#x27;k&#x27;</span>, linestyle=<span class="hljs-string">&#x27;--&#x27;</span>, alpha=<span class="hljs-number">0.3</span>)
ax1.axvline(x=<span class="hljs-number">0</span>, color=<span class="hljs-string">&#x27;k&#x27;</span>, linestyle=<span class="hljs-string">&#x27;--&#x27;</span>, alpha=<span class="hljs-number">0.3</span>)
ax1.set_xlabel(<span class="hljs-string">&#x27;x&#x27;</span>, fontsize=<span class="hljs-number">12</span>)
ax1.set_ylabel(<span class="hljs-string">&#x27;f(x)&#x27;</span>, fontsize=<span class="hljs-number">12</span>)
ax1.set_title(<span class="hljs-string">&#x27;GELU vs ReLU&#x27;</span>, fontsize=<span class="hljs-number">14</span>)
ax1.legend()
ax1.grid(<span class="hljs-literal">True</span>, alpha=<span class="hljs-number">0.3</span>)

<span class="hljs-comment"># 4.2 å¯¼æ•°å¯¹æ¯” / Derivative comparison</span>
ax2 = axes[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>]
<span class="hljs-comment"># ReLU å¯¼æ•°</span>
relu_deriv = np.where(x_np &gt; <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>)
<span class="hljs-comment"># GELU å¯¼æ•°: Î¦(x) + x * Ï†(x)</span>
gelu_deriv = norm.cdf(x_np) + x_np * norm.pdf(x_np)

ax2.plot(x_np, relu_deriv, <span class="hljs-string">&#x27;b-&#x27;</span>, linewidth=<span class="hljs-number">2</span>, label=<span class="hljs-string">&quot;ReLU&#x27;&quot;</span>)
ax2.plot(x_np, gelu_deriv, <span class="hljs-string">&#x27;r-&#x27;</span>, linewidth=<span class="hljs-number">2</span>, label=<span class="hljs-string">&quot;GELU&#x27;&quot;</span>)
ax2.axhline(y=<span class="hljs-number">0</span>, color=<span class="hljs-string">&#x27;k&#x27;</span>, linestyle=<span class="hljs-string">&#x27;--&#x27;</span>, alpha=<span class="hljs-number">0.3</span>)
ax2.axvline(x=<span class="hljs-number">0</span>, color=<span class="hljs-string">&#x27;k&#x27;</span>, linestyle=<span class="hljs-string">&#x27;--&#x27;</span>, alpha=<span class="hljs-number">0.3</span>)
ax2.set_xlabel(<span class="hljs-string">&#x27;x&#x27;</span>, fontsize=<span class="hljs-number">12</span>)
ax2.set_ylabel(<span class="hljs-string">&quot;f&#x27;(x)&quot;</span>, fontsize=<span class="hljs-number">12</span>)
ax2.set_title(<span class="hljs-string">&#x27;Derivatives: GELU vs ReLU&#x27;</span>, fontsize=<span class="hljs-number">14</span>)
ax2.legend()
ax2.grid(<span class="hljs-literal">True</span>, alpha=<span class="hljs-number">0.3</span>)

<span class="hljs-comment"># 4.3 GELU è¿‘ä¼¼å¯¹æ¯” / GELU approximations comparison</span>
ax3 = axes[<span class="hljs-number">1</span>, <span class="hljs-number">0</span>]
ax3.plot(x.numpy(), y_exact.numpy(), <span class="hljs-string">&#x27;k-&#x27;</span>, linewidth=<span class="hljs-number">2</span>, label=<span class="hljs-string">&#x27;Exact (erf)&#x27;</span>)
ax3.plot(x.numpy(), y_tanh.numpy(), <span class="hljs-string">&#x27;r--&#x27;</span>, linewidth=<span class="hljs-number">2</span>, label=<span class="hljs-string">&#x27;Tanh Approx&#x27;</span>)
ax3.plot(x.numpy(), y_sigmoid.numpy(), <span class="hljs-string">&#x27;g:&#x27;</span>, linewidth=<span class="hljs-number">2</span>, label=<span class="hljs-string">&#x27;Sigmoid (SiLU)&#x27;</span>)
ax3.set_xlabel(<span class="hljs-string">&#x27;x&#x27;</span>, fontsize=<span class="hljs-number">12</span>)
ax3.set_ylabel(<span class="hljs-string">&#x27;GELU(x)&#x27;</span>, fontsize=<span class="hljs-number">12</span>)
ax3.set_title(<span class="hljs-string">&#x27;GELU Approximations&#x27;</span>, fontsize=<span class="hljs-number">14</span>)
ax3.legend()
ax3.grid(<span class="hljs-literal">True</span>, alpha=<span class="hljs-number">0.3</span>)

<span class="hljs-comment"># 4.4 è¿‘ä¼¼è¯¯å·® / Approximation errors</span>
ax4 = axes[<span class="hljs-number">1</span>, <span class="hljs-number">1</span>]
error_tanh = torch.<span class="hljs-built_in">abs</span>(y_exact - y_tanh).numpy()
error_sigmoid = torch.<span class="hljs-built_in">abs</span>(y_exact - y_sigmoid).numpy()

ax4.plot(x.numpy(), error_tanh, <span class="hljs-string">&#x27;r-&#x27;</span>, linewidth=<span class="hljs-number">2</span>, label=<span class="hljs-string">&#x27;Tanh Approx Error&#x27;</span>)
ax4.plot(x.numpy(), error_sigmoid, <span class="hljs-string">&#x27;g-&#x27;</span>, linewidth=<span class="hljs-number">2</span>, label=<span class="hljs-string">&#x27;Sigmoid Approx Error&#x27;</span>)
ax4.set_xlabel(<span class="hljs-string">&#x27;x&#x27;</span>, fontsize=<span class="hljs-number">12</span>)
ax4.set_ylabel(<span class="hljs-string">&#x27;Absolute Error&#x27;</span>, fontsize=<span class="hljs-number">12</span>)
ax4.set_title(<span class="hljs-string">&#x27;Approximation Errors&#x27;</span>, fontsize=<span class="hljs-number">14</span>)
ax4.legend()
ax4.grid(<span class="hljs-literal">True</span>, alpha=<span class="hljs-number">0.3</span>)

plt.tight_layout()
plt.savefig(<span class="hljs-string">&#x27;/tmp/gelu_analysis.png&#x27;</span>, dpi=<span class="hljs-number">150</span>, bbox_inches=<span class="hljs-string">&#x27;tight&#x27;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nå›¾åƒå·²ä¿å­˜è‡³ / Image saved to: /tmp/gelu_analysis.png&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 5. åœ¨ Transformer ä¸­çš„åº”ç”¨ / Application in Transformer</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Transformer ä¸­çš„ GELU / GELU in Transformer&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">TransformerFFN</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;
    Transformer çš„å‰é¦ˆç½‘ç»œï¼ˆä½¿ç”¨ GELU æ¿€æ´»ï¼‰
    Transformer Feed-Forward Network (using GELU activation)
    &quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, d_model, d_ff, dropout=<span class="hljs-number">0.1</span></span>):
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-variable language_">self</span>.linear1 = nn.Linear(d_model, d_ff)
        <span class="hljs-variable language_">self</span>.linear2 = nn.Linear(d_ff, d_model)
        <span class="hljs-variable language_">self</span>.dropout = nn.Dropout(dropout)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-comment"># FFN(x) = max(0, xW1 + b1)W2 + b2  (åŸå§‹è®ºæ–‡ä½¿ç”¨ ReLU)</span>
        <span class="hljs-comment"># FFN(x) = GELU(xW1 + b1)W2 + b2   (ç°ä»£å®ç°ä½¿ç”¨ GELU)</span>
        x = <span class="hljs-variable language_">self</span>.linear1(x)
        x = F.gelu(x)  <span class="hljs-comment"># ä½¿ç”¨ GELU</span>
        x = <span class="hljs-variable language_">self</span>.dropout(x)
        x = <span class="hljs-variable language_">self</span>.linear2(x)
        <span class="hljs-keyword">return</span> x

<span class="hljs-comment"># æµ‹è¯• / Test</span>
d_model, d_ff = <span class="hljs-number">512</span>, <span class="hljs-number">2048</span>
ffn = TransformerFFN(d_model, d_ff)

batch_size, seq_len = <span class="hljs-number">4</span>, <span class="hljs-number">128</span>
x = torch.randn(batch_size, seq_len, d_model)
output = ffn(x)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nTransformer FFN with GELU:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  è¾“å…¥å½¢çŠ¶ / Input shape: <span class="hljs-subst">{x.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  è¾“å‡ºå½¢çŠ¶ / Output shape: <span class="hljs-subst">{output.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  å‚æ•°é‡ / Parameters: <span class="hljs-subst">{<span class="hljs-built_in">sum</span>(p.numel() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> ffn.parameters()):,}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 6. GELU çš„æ¦‚ç‡è§£é‡Š / Probabilistic Interpretation of GELU</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;GELU çš„æ¦‚ç‡è§£é‡Š / Probabilistic Interpretation of GELU&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&quot;&quot;
GELU å¯ä»¥ä»ä¸¤ä¸ªè§’åº¦ç†è§£:

1. **éšæœºæ­£åˆ™åŒ–è§†è§’** / Stochastic Regularization View:
   - ä»¥æ¦‚ç‡ Î¦(x) = P(X â‰¤ x) ä¿ç•™è¾“å…¥ x
   - ä»¥æ¦‚ç‡ 1 - Î¦(x) å°†è¾“å…¥ç½®é›¶
   - GELU(x) = E[ä¿ç•™åçš„x] = x * Î¦(x)

2. **ç¡®å®šæ€§è¿‘ä¼¼è§†è§’** / Deterministic Approximation View:
   - ç±»ä¼¼äº Dropoutï¼Œä½†è¾“å…¥ç›¸å…³çš„
   - å¯¹å¤§æ­£æ•°å‡ ä¹æ€»æ˜¯ä¿ç•™ (Î¦(x) â‰ˆ 1)
   - å¯¹å¤§è´Ÿæ•°å‡ ä¹æ€»æ˜¯ä¸¢å¼ƒ (Î¦(x) â‰ˆ 0)
   - åœ¨ 0 é™„è¿‘å¹³æ»‘è¿‡æ¸¡

è¿™ä½¿å¾— GELU å…·æœ‰&quot;è‡ªé€‚åº”é—¨æ§&quot;çš„ç‰¹æ€§ã€‚
&quot;&quot;&quot;</span>)

<span class="hljs-comment"># æ¼”ç¤ºæ¦‚ç‡è§£é‡Š / Demonstrate probabilistic interpretation</span>
x_demo = torch.tensor([-<span class="hljs-number">3.0</span>, -<span class="hljs-number">1.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>, <span class="hljs-number">3.0</span>])
prob_keep = torch.tensor([norm.cdf(val) <span class="hljs-keyword">for</span> val <span class="hljs-keyword">in</span> x_demo])
gelu_vals = x_demo * prob_keep

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;x å€¼ / Value | ä¿ç•™æ¦‚ç‡ / Keep Prob | GELU(x)&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">50</span>)
<span class="hljs-keyword">for</span> i, val <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(x_demo):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">{val:&gt;<span class="hljs-number">11.1</span>f}</span> | <span class="hljs-subst">{prob_keep[i]:&gt;<span class="hljs-number">18.4</span>f}</span> | <span class="hljs-subst">{gelu_vals[i]:&gt;<span class="hljs-number">7.4</span>f}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># æ€»ç»“ / Summary</span>
<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;æ€»ç»“ / Summary&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-string">&quot;&quot;&quot;
æœ¬ç¤ºä¾‹å±•ç¤ºäº† GELU çš„æ ¸å¿ƒæ¦‚å¿µ:
This example demonstrates core concepts of GELU:

1. æ•°å­¦å®šä¹‰: GELU(x) = x * Î¦(x)ï¼Œå…¶ä¸­ Î¦ æ˜¯æ ‡å‡†æ­£æ€ CDF
   Mathematical definition

2. ç‰¹ç‚¹:
   - å¤„å¤„å¯å¯¼
   - éå•è°ƒ
   - è´ŸåŒºé—´æœ‰éé›¶è¾“å‡º

3. å®ç°:
   - ç²¾ç¡®å®ç°ä½¿ç”¨ erf å‡½æ•°
   - å¸¸ç”¨ tanh è¿‘ä¼¼ï¼ˆPyTorch é»˜è®¤ï¼‰
   - sigmoid è¿‘ä¼¼ç­‰ä»·äº SiLU/Swish

4. ä¸ºä»€ä¹ˆ Transformer ä½¿ç”¨ GELU:
   - å¹³æ»‘æ€§å¸¦æ¥æ›´ç¨³å®šçš„è®­ç»ƒ
   - åœ¨ NLP ä»»åŠ¡ä¸­è¡¨ç°æ›´å¥½
   - BERTã€GPTã€LLaMA ç­‰éƒ½ä½¿ç”¨ GELU

5. æ¦‚ç‡è§£é‡Š:
   - å¯ä»¥ç†è§£ä¸ºéšæœºæ­£åˆ™åŒ–çš„æœŸæœ›
   - è¾“å…¥ç›¸å…³çš„&quot;é—¨æ§&quot;æœºåˆ¶
&quot;&quot;&quot;</span>
</code></pre></div></div></div><div class="chapter"><h1>ç¬¬5ç«  Attention æ³¨æ„åŠ›æœºåˆ¶</h1><h1>æ³¨æ„åŠ›æœºåˆ¶ï¼ˆAttentionï¼‰ï¿½ï¿½æ™®ç‰ˆ</h1>
<blockquote>
<p>é¢å‘é›¶åŸºç¡€è¯»è€…çš„æ³¨æ„åŠ›æœºåˆ¶å…¥é—¨æŒ‡å—</p>
</blockquote>
<h2>ä¸€å¥è¯æ¦‚æ‹¬</h2>
<p><strong>æ³¨æ„åŠ›æœºåˆ¶è®©æ¨¡å‹&quot;å­¦ä¼šå…³æ³¨é‡ç‚¹&quot;ï¼Œå°±åƒäººé˜…è¯»æ—¶ä¼šé‡ç‚¹å…³æ³¨é‡è¦è¯è¯­ä¸€æ ·ã€‚</strong></p>
<h2>ä»ä¸€ä¸ªé—®é¢˜å¼€å§‹</h2>
<p>æƒ³è±¡ä½ åœ¨è¯»ä¸€ç¯‡é•¿æ–‡ç« ï¼Œç„¶åæœ‰äººé—®ä½ ï¼šâ€œè¿™ç¯‡æ–‡ç« çš„æ ¸å¿ƒè§‚ç‚¹æ˜¯ä»€ï¿½ï¿½ï¼Ÿâ€</p>
<p>ä½ ä¸ä¼šé€å­—é€å¥åœ°å¹³å‡å¯¹å¾…ï¼Œè€Œæ˜¯ä¼šï¼š</p>
<ul>
<li>å…³æ³¨æ ‡é¢˜å’ŒåŠ ç²—çš„æ–‡å­—</li>
<li>æ³¨æ„åå¤å‡ºç°çš„å…³é”®è¯</li>
<li>å¿½ç•¥&quot;çš„&quot;ã€&quot;æ˜¯&quot;ç­‰æ— å…³ç´§è¦çš„è¯</li>
</ul>
<p><strong>è¿™å°±æ˜¯æ³¨æ„åŠ›æœºåˆ¶ï¼šè®©æ¨¡å‹çŸ¥é“å“ªäº›éƒ¨åˆ†æ›´é‡è¦ã€‚</strong></p>
<h2>æ ¸å¿ƒæ¦‚å¿µï¼šQueryã€Keyã€Value</h2>
<p>æ³¨æ„åŠ›æœºåˆ¶ç”¨äº†ä¸‰ä¸ªé‡è¦æ¦‚å¿µï¼Œæˆ‘ä»¬ç”¨ä¸€ä¸ªå›¾ä¹¦é¦†çš„ç±»æ¯”æ¥ç†è§£ï¼š</p>
<h3>å›¾ä¹¦é¦†ç±»æ¯”</h3>
<p>å‡è®¾ä½ è¦åœ¨å›¾ä¹¦é¦†æ‰¾ä¸€æœ¬å…³äº&quot;äººå·¥æ™ºèƒ½&quot;çš„ä¹¦ï¼š</p>
<ol>
<li><strong>Queryï¼ˆæŸ¥è¯¢ï¼‰</strong>ï¼šä½ çš„éœ€æ±‚ - â€œäººå·¥æ™ºèƒ½ç›¸å…³çš„ä¹¦â€</li>
<li><strong>Keyï¼ˆé”®ï¼‰</strong>ï¼šæ¯æœ¬ä¹¦çš„æ ‡ç­¾/åˆ†ç±»å· - å¸®ä½ åˆ¤æ–­è¿™æœ¬ä¹¦æ˜¯å¦ç›¸å…³</li>
<li><strong>Valueï¼ˆå€¼ï¼‰</strong>ï¼šä¹¦çš„å®é™…å†…å®¹ - ä½ æœ€ç»ˆè¦è·å–çš„ä¿¡æ¯</li>
</ol>
<h3>æ³¨æ„åŠ›è®¡ç®—è¿‡ç¨‹</h3>
<ol>
<li><strong>æ¯”è¾ƒ Query å’Œæ‰€æœ‰ Key</strong>ï¼šæ‰¾å‡ºå“ªäº›ä¹¦å’Œä½ æƒ³è¦çš„ç›¸å…³</li>
<li><strong>è®¡ç®—ç›¸å…³æ€§åˆ†æ•°</strong>ï¼šè¶Šç›¸å…³çš„ä¹¦åˆ†æ•°è¶Šé«˜</li>
<li><strong>åŠ æƒæ±‚å’Œ Value</strong>ï¼šæ ¹æ®ç›¸å…³æ€§åˆ†æ•°ï¼Œç»¼åˆæ‰€æœ‰ä¹¦çš„å†…å®¹</li>
</ol>
<p>ç»“æœï¼šä½ å¾—åˆ°äº†ä¸€ä¸ª&quot;é‡ç‚¹å…³æ³¨ç›¸å…³ä¹¦ç±&quot;çš„ç»¼åˆä¿¡æ¯ã€‚</p>
<h2>Self-Attentionï¼ˆè‡ªæ³¨æ„åŠ›ï¼‰</h2>
<p>å½“ Queryã€Keyã€Value éƒ½æ¥è‡ªåŒä¸€ä¸ªåœ°æ–¹æ—¶ï¼Œå°±æ˜¯&quot;è‡ªæ³¨æ„åŠ›&quot;ã€‚</p>
<h3>å¥å­ç†è§£ç¤ºä¾‹</h3>
<p>å¥å­ï¼šâ€œæˆ‘ çˆ± åŒ—äº¬ å¤©å®‰é—¨â€</p>
<p>å¤„ç†&quot;çˆ±&quot;è¿™ä¸ªè¯æ—¶ï¼š</p>
<ul>
<li>Query = &quot;çˆ±&quot;çš„è¡¨ç¤º</li>
<li>Key = æ‰€æœ‰è¯ï¼ˆâ€œæˆ‘â€ã€â€œçˆ±â€ã€â€œåŒ—äº¬â€ã€â€œå¤©å®‰é—¨â€ï¼‰çš„è¡¨ç¤º</li>
<li>Value = æ‰€æœ‰è¯çš„å†…å®¹</li>
</ul>
<p>æ¨¡å‹ä¼šè®¡ç®—ï¼š</p>
<ul>
<li>&quot;çˆ±&quot;å’Œ&quot;æˆ‘&quot;çš„ç›¸å…³æ€§ï¼šé«˜ï¼ˆè°çˆ±ï¼Ÿï¼‰</li>
<li>&quot;çˆ±&quot;å’Œ&quot;åŒ—äº¬&quot;çš„ç›¸å…³æ€§ï¼šé«˜ï¼ˆçˆ±ä»€ä¹ˆï¼Ÿï¼‰</li>
<li>&quot;çˆ±&quot;å’Œ&quot;å¤©å®‰é—¨&quot;çš„ç›¸å…³æ€§ï¼šä¸­ï¼ˆåŒ—äº¬çš„ä»€ä¹ˆï¼Ÿï¼‰</li>
</ul>
<p>æœ€ç»ˆ&quot;çˆ±&quot;çš„è¡¨ç¤ºä¼šèåˆæ‰€æœ‰ç›¸å…³ä¿¡æ¯ï¼Œç†è§£å®Œæ•´çš„&quot;æˆ‘çˆ±åŒ—äº¬å¤©å®‰é—¨&quot;ã€‚</p>
<h2>Multi-Head Attentionï¼ˆå¤šå¤´æ³¨æ„åŠ›ï¼‰</h2>
<h3>ï¿½ï¿½ä»€ä¹ˆè¦&quot;å¤šå¤´&quot;ï¼Ÿ</h3>
<p>æƒ³è±¡ä½ åœ¨åˆ†æä¸€ä¸ªå¥å­ï¼Œä½ æƒ³åŒæ—¶å…³æ³¨ï¼š</p>
<ol>
<li>è¯­æ³•å…³ç³»ï¼ˆä¸»è¯­-è°“è¯­-å®¾è¯­ï¼‰</li>
<li>è¯­ä¹‰å…³ç³»ï¼ˆåŒä¹‰è¯ã€åä¹‰è¯ï¼‰</li>
<li>æŒ‡ä»£å…³ç³»ï¼ˆ&quot;ä»–&quot;æŒ‡ä»£è°ï¼Ÿï¼‰</li>
</ol>
<p>ä¸€ä¸ª&quot;å¤´&quot;å¯èƒ½åªæ“…é•¿ä¸€ç§å…³ç³»ï¼Œå¤šä¸ªå¤´å¯ä»¥åŒæ—¶ä»ä¸åŒè§’åº¦ç†è§£ã€‚</p>
<h3>ç±»æ¯”</h3>
<p>å°±åƒä¸€ä¸ªå›¢é˜Ÿè®¨è®ºï¼š</p>
<ul>
<li>æœ‰äººå…³æ³¨æŠ€æœ¯ç»†èŠ‚</li>
<li>æœ‰äººå…³æ³¨å•†ä¸šä»·å€¼</li>
<li>æœ‰äººå…³æ³¨ç”¨æˆ·ä½“éªŒ</li>
</ul>
<p>æœ€åç»¼åˆæ‰€æœ‰äººçš„æ„è§ï¼Œå¾—åˆ°æ›´å…¨é¢çš„ç†è§£ã€‚</p>
<h2>æ³¨æ„åŠ›çš„ç›´è§‚ç†è§£</h2>
<h3>å¯è§†åŒ–ç¤ºä¾‹</h3>
<p>å¤„ç†å¥å­ â€œThe animal didnâ€™t cross the street because it was too tiredâ€ æ—¶ï¼š</p>
<table>
<thead>
<tr>
<th></th>
<th>The</th>
<th>animal</th>
<th>didnâ€™t</th>
<th>cross</th>
<th>the</th>
<th>street</th>
<th>because</th>
<th>it</th>
<th>was</th>
<th>too</th>
<th>tired</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>it</strong></td>
<td>.01</td>
<td><strong>.72</strong></td>
<td>.01</td>
<td>.02</td>
<td>.01</td>
<td>.03</td>
<td>.02</td>
<td>.05</td>
<td>.01</td>
<td>.01</td>
<td><strong>.11</strong></td>
</tr>
</tbody>
</table>
<p>â€œitâ€ å¯¹ â€œanimalâ€ çš„æ³¨æ„åŠ›åˆ†æ•°æœ€é«˜ï¼ˆ0.72ï¼‰ï¼Œæ‰€ä»¥æ¨¡å‹ç†è§£&quot;it&quot;æŒ‡çš„æ˜¯&quot;animal&quot;è€Œä¸æ˜¯&quot;street&quot;ã€‚</p>
<h2>ä¸ºä»€ä¹ˆæ³¨æ„åŠ›è¿™ä¹ˆå¼ºå¤§ï¼Ÿ</h2>
<h3>1. å¹¶è¡Œè®¡ç®—</h3>
<p>ä¼ ç»Ÿ RNN å¿…é¡»é€è¯å¤„ç†ï¼Œæ³¨æ„åŠ›å¯ä»¥åŒæ—¶å¤„ç†æ‰€æœ‰è¯ã€‚</p>
<h3>2. é•¿è·ç¦»ä¾èµ–</h3>
<p>æ— è®ºä¸¤ä¸ªè¯ç›¸è·å¤šè¿œï¼Œæ³¨æ„åŠ›éƒ½èƒ½ç›´æ¥å»ºç«‹è”ç³»ã€‚</p>
<h3>3. å¯è§£é‡Šæ€§</h3>
<p>æ³¨æ„åŠ›æƒé‡å±•ç¤ºäº†æ¨¡å‹&quot;å…³æ³¨&quot;äº†ä»€ä¹ˆï¼Œä¾¿äºç†è§£æ¨¡å‹è¡Œä¸ºã€‚</p>
<h2>æ€»ç»“</h2>
<table>
<thead>
<tr>
<th>æ¦‚å¿µ</th>
<th>é€šä¿—ç†è§£</th>
</tr>
</thead>
<tbody>
<tr>
<td>Query</td>
<td>æˆ‘æƒ³è¦ä»€ä¹ˆ</td>
</tr>
<tr>
<td>Key</td>
<td>æ¯ä¸ªä¸œè¥¿çš„æ ‡ç­¾</td>
</tr>
<tr>
<td>Value</td>
<td>æ¯ä¸ªä¸œè¥¿çš„å†…å®¹</td>
</tr>
<tr>
<td>æ³¨æ„åŠ›åˆ†æ•°</td>
<td>ç›¸å…³æ€§ç¨‹åº¦</td>
</tr>
<tr>
<td>Self-Attention</td>
<td>è‡ªå·±å’Œè‡ªå·±çš„æ¯ä¸ªéƒ¨åˆ†æ¯”è¾ƒ</td>
</tr>
<tr>
<td>Multi-Head</td>
<td>å¤šä¸ªè§’åº¦åŒæ—¶è§‚å¯Ÿ</td>
</tr>
</tbody>
</table>
<h2>ä¸‹ä¸€æ­¥</h2>
<ul>
<li>æƒ³äº†è§£æ•°å­¦åŸç†ï¼Ÿé˜…è¯» <a href="advanced-guide.md">æ·±å…¥ç‰ˆ</a></li>
<li>æƒ³çœ‹ä»£ç å®ç°ï¼ŸæŸ¥çœ‹ <code>examples/</code> ç›®å½•</li>
</ul>
<h1>æ³¨æ„åŠ›æœºåˆ¶ï¼ˆAttentionï¼‰æ·±å…¥ç‰ˆ</h1>
<blockquote>
<p>é¢å‘æœ‰æœºå™¨å­¦ä¹ åŸºç¡€è¯»è€…çš„æŠ€æœ¯è¯¦è§£</p>
</blockquote>
<h2>æ¦‚è¿°</h2>
<p>æ³¨æ„åŠ›æœºåˆ¶æ˜¯ Transformer æ¶æ„çš„æ ¸å¿ƒï¼Œå½»åº•æ”¹å˜äº† NLP å’Œæ·±åº¦å­¦ä¹ é¢†åŸŸã€‚æœ¬æ–‡æ·±å…¥åˆ†æ Self-Attentionã€Multi-Head Attention å’Œ Flash Attention çš„æ•°å­¦åŸç†ã€‚</p>
<h2>Scaled Dot-Product Attention</h2>
<h3>æ•°å­¦å®šä¹‰</h3>
<p>ç»™å®šæŸ¥è¯¢çŸ©é˜µ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span></span></span></span>ã€é”®çŸ©é˜µ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span>ã€å€¼çŸ©é˜µ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span>ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Attention</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4684em;vertical-align:-0.95em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.2528em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span></p>
<p><a id="formula-attention-1"></a>
<a href="#formula-attention-1-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">Ã—</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>ï¼ˆæŸ¥è¯¢ï¼‰</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mbin mtight">Ã—</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>ï¼ˆé”®ï¼‰</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mbin mtight">Ã—</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>ï¼ˆå€¼ï¼‰</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> æ˜¯é”®çš„ç»´åº¦</li>
</ul>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šå…ˆè®¡ç®—æŸ¥è¯¢ä¸é”®çš„ç›¸ä¼¼åº¦ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0358em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span>ï¼Œç¼©æ”¾ååš softmax å¾—åˆ°æ³¨æ„åŠ›æƒé‡ï¼Œå†ä¸ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span> åŠ æƒæ±‚å’Œå¾—åˆ°è¾“å‡ºã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> ä¸ºæŸ¥è¯¢åºåˆ—é•¿åº¦ï¼Œ<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span> ä¸ºé”®/å€¼åºåˆ—é•¿åº¦ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºé”®ç»´åº¦ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºå€¼ç»´åº¦ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šæ¯ä¸ªæŸ¥è¯¢ä½ç½®éƒ½ä¼šâ€œçœ‹â€æ‰€æœ‰é”®ä½ç½®ï¼Œæƒé‡è¶Šå¤§è¡¨ç¤ºè¶Šç›¸å…³ã€‚</li>
</ul>
<h3>ä¸ºä»€ä¹ˆé™¤ä»¥ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.04em;vertical-align:-0.1828em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice">&lt;path d=&quot;M95,702</h3>
<p>c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z&quot;/&gt;</svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span></span></span></span></span></span></span></span></span>ï¼Ÿ</p>
<p>å‡è®¾ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span></span></span></span> å’Œ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> çš„å…ƒç´ æ˜¯ç‹¬ç«‹çš„éšæœºå˜é‡ï¼Œå‡å€¼ä¸º 0ï¼Œæ–¹å·®ä¸º 1ã€‚</p>
<p>ç‚¹ç§¯ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2887em;vertical-align:-0.2997em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">âˆ‘</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.989em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> çš„å‡å€¼ä¸º 0ï¼Œæ–¹å·®ä¸º <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>ã€‚</p>
<p>å½“ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> å¾ˆå¤§æ—¶ï¼Œç‚¹ç§¯çš„ç»å¯¹å€¼ä¼šå¾ˆå¤§ï¼Œå¯¼è‡´ softmax è¿›å…¥é¥±å’ŒåŒºï¼Œæ¢¯åº¦æå°ã€‚</p>
<p>é™¤ä»¥ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.04em;vertical-align:-0.1828em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span></span></span></span></span></span></span></span></span> ä½¿æ–¹å·®å½’ä¸€åŒ–ä¸º 1ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="mord text"><span class="mord">Var</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.2528em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.2074em;vertical-align:-0.836em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span></span></p>
<p><a id="formula-attention-2"></a>
<a href="#formula-attention-2-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šç¼©æ”¾åçš„ç‚¹ç§¯æ–¹å·®è¢«å½’ä¸€åˆ° 1ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> æ˜¯ç‚¹ç§¯ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Var</span></span><span class="mopen">(</span><span class="mord">â‹…</span><span class="mclose">)</span></span></span></span> æ˜¯æ–¹å·®ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šé¿å… softmax è¾“å…¥è¿‡å¤§å¯¼è‡´æ¢¯åº¦é¥±å’Œã€‚</li>
</ul>
<h3>é€æ­¥è®¡ç®—</h3>
<ol>
<li>
<p><strong>è®¡ç®—æ³¨æ„åŠ›åˆ†æ•°</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0358em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7713em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7713em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">Ã—</span><span class="mord mathnormal mtight">m</span></span></span></span></span></span></span></span></span></span></span></span></p>
</li>
<li>
<p><strong>ç¼©æ”¾</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1072em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord">/</span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span></span></span></span></span></span></span></span></span></p>
</li>
<li>
<p><strong>Softmax</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mclose">)</span></span></span></span>ï¼Œå…¶ä¸­ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.6926em;vertical-align:-0.6269em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0657em;"><span style="top:-2.5981em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mop op-symbol small-op mtight" style="position:relative;top:0em;">âˆ‘</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1746em;"><span style="top:-2.1786em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3214em;"><span></span></span></span></span></span></span><span class="mspace mtight" style="margin-right:0.1952em;"></span><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8456em;"><span style="top:-2.8575em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3448em;margin-left:-0.0576em;margin-right:0.1em;"><span class="pstrut" style="height:2.6944em;"></span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">ik</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3496em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9595em;"><span style="top:-2.9714em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3448em;margin-left:-0.0576em;margin-right:0.1em;"><span class="pstrut" style="height:2.6595em;"></span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.5092em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.6269em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></p>
</li>
<li>
<p><strong>åŠ æƒæ±‚å’Œ</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">Ã—</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p>
</li>
</ol>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0358em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></strong>ï¼šå¾—åˆ°æ¯ä¸ªæŸ¥è¯¢ä¸æ¯ä¸ªé”®çš„ç›¸ä¼¼åº¦çŸ©é˜µã€‚</li>
<li><strong><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1072em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord">/</span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span></span></span></span></span></span></span></span></span></strong>ï¼šç¼©æ”¾ç›¸ä¼¼åº¦ï¼Œæ§åˆ¶æ•°å€¼èŒƒå›´ã€‚</li>
<li><strong><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mclose">)</span></span></span></span></strong>ï¼šå°†æ¯ä¸€è¡Œå½’ä¸€åŒ–ä¸ºæƒé‡åˆ†å¸ƒï¼Œ<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> è¡¨ç¤ºæŸ¥è¯¢ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> å…³æ³¨é”® <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span> çš„ç¨‹åº¦ã€‚</li>
<li><strong><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></strong>ï¼šç”¨æƒé‡å¯¹å€¼å‘é‡åŠ æƒæ±‚å’Œå¾—åˆ°è¾“å‡ºã€‚</li>
</ul>
<h3>è®¡ç®—å¤æ‚åº¦</h3>
<ul>
<li>æ—¶é—´å¤æ‚åº¦ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mclose">)</span></span></span></span>ï¼ˆ<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> æ˜¯åºåˆ—é•¿åº¦ï¼‰</li>
<li>ç©ºé—´å¤æ‚åº¦ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>ï¼ˆå­˜å‚¨æ³¨æ„åŠ›çŸ©é˜µï¼‰</li>
</ul>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mclose">)</span></span></span></span></strong>ï¼šåºåˆ—é•¿åº¦ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> å¢é•¿æ—¶ï¼Œè®¡ç®—é‡è¿‘ä¼¼æŒ‰å¹³æ–¹å¢é•¿ã€‚</li>
<li><strong><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></strong>ï¼šéœ€è¦å­˜å‚¨ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> çš„æ³¨æ„åŠ›çŸ©é˜µï¼Œå› æ­¤å†…å­˜éš <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span> å¢é•¿ã€‚</li>
</ul>
<h2>Self-Attention</h2>
<p>å½“ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span></span></span></span>ã€<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span>ã€<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span> éƒ½æ¥è‡ªåŒä¸€ä¸ªè¾“å…¥ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span> æ—¶ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0858em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0858em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8913em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><a id="formula-attention-3"></a>
<a href="#formula-attention-3-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p>å…¶ä¸­ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0358em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span></span></span></span></span></span></span></span> æ˜¯å¯å­¦ä¹ çš„æŠ•å½±çŸ©é˜µã€‚</p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šå°†åŒä¸€è¾“å…¥ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span> é€šè¿‡ä¸‰ç»„ä¸åŒçš„çº¿æ€§å˜æ¢å¾—åˆ°æŸ¥è¯¢ã€é”®å’Œå€¼ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span> ä¸ºè¾“å…¥åºåˆ—è¡¨ç¤ºï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0358em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span></span></span></span></span></span></span></span> ä¸ºå‚æ•°çŸ©é˜µã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šåŒä¸€è¾“å…¥åœ¨ä¸åŒâ€œè§†è§’â€ä¸‹è¢«æŠ•å½±ï¼Œä»¥è®¡ç®—å…³è”æ€§ã€‚</li>
</ul>
<h3>ç‰¹ç‚¹</h3>
<ol>
<li><strong>å…¨å±€æ„Ÿå—é‡</strong>ï¼šæ¯ä¸ªä½ç½®å¯ä»¥ç›´æ¥å…³æ³¨åºåˆ—ä¸­çš„ä»»ä½•ä½ç½®</li>
<li><strong>åŠ¨æ€æƒé‡</strong>ï¼šæ³¨æ„åŠ›æƒé‡æ ¹æ®è¾“å…¥å†…å®¹åŠ¨æ€è®¡ç®—</li>
<li><strong>å¹¶è¡Œè®¡ç®—</strong>ï¼šæ‰€æœ‰ä½ç½®çš„è®¡ç®—å¯ä»¥å¹¶è¡Œ</li>
</ol>
<h2>Multi-Head Attention</h2>
<h3>æ•°å­¦å®šä¹‰</h3>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">MultiHead</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1413em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Concat</span></span><span class="mopen">(</span><span class="mord"><span class="mord text"><span class="mord">head</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">â€¦</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord text"><span class="mord">head</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">h</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">O</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><a id="formula-attention-4"></a>
<a href="#formula-attention-4-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p>å…¶ä¸­ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord text"><span class="mord">head</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2361em;vertical-align:-0.2769em;"></span><span class="mord text"><span class="mord">Attention</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9592em;"><span style="top:-2.4231em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.1809em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2769em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><a id="formula-attention-5"></a>
<a href="#formula-attention-5-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šå°†æ³¨æ„åŠ›åˆ†æˆ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">h</span></span></span></span> ä¸ªå­ç©ºé—´å¹¶è¡Œè®¡ç®—ï¼Œæœ€åæ‹¼æ¥å¹¶çº¿æ€§æ˜ å°„ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">h</span></span></span></span> ä¸ºå¤´æ•°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2361em;vertical-align:-0.2769em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9592em;"><span style="top:-2.4231em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.1809em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2769em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4413em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4413em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºæ¯ä¸ªå¤´çš„æŠ•å½±çŸ©é˜µï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">O</span></span></span></span></span></span></span></span></span></span></span> ä¸ºè¾“å‡ºæ˜ å°„ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šä¸åŒå¤´å…³æ³¨ä¸åŒå…³ç³»ï¼Œæå‡è¡¨è¾¾èƒ½åŠ›ã€‚</li>
</ul>
<h3>å‚æ•°è®¾ç½®</h3>
<ul>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">h</span></span></span></span>ï¼šå¤´æ•°ï¼ˆå¦‚ 8ã€12ã€16ï¼‰</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">/</span><span class="mord mathnormal">h</span></span></span></span>ï¼šæ¯ä¸ªå¤´çš„ç»´åº¦</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2361em;vertical-align:-0.2769em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9592em;"><span style="top:-2.4231em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.1809em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2769em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span><span class="mbin mtight">Ã—</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1em;vertical-align:-0.2587em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4413em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span><span class="mbin mtight">Ã—</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1em;vertical-align:-0.2587em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4413em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span><span class="mbin mtight">Ã—</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8804em;vertical-align:-0.0391em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">O</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mbin mtight">Ã—</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></li>
</ul>
<h3>ä¸ºä»€ä¹ˆå¤šå¤´æœ‰æ•ˆï¼Ÿ</h3>
<ol>
<li><strong>å¤šè¡¨ç¤ºç©ºé—´</strong>ï¼šæ¯ä¸ªå¤´å­¦ä¹ ä¸åŒçš„è¡¨ç¤ºå­ç©ºé—´</li>
<li><strong>å¹¶è¡Œå…³æ³¨</strong>ï¼šåŒæ—¶å…³æ³¨ä¸åŒä½ç½®çš„ä¸åŒä¿¡æ¯</li>
<li><strong>å¢å¼ºè¡¨è¾¾èƒ½åŠ›</strong>ï¼šç­‰ä»·äºå¢åŠ ç½‘ç»œå®¹é‡</li>
</ol>
<h3>å¤æ‚åº¦åˆ†æ</h3>
<p>æ€»å‚æ•°é‡ä¸å˜ï¼ˆä¸å•å¤´ç›¸æ¯”ï¼‰ï¼Œä½†è¡¨è¾¾èƒ½åŠ›æ›´å¼ºã€‚</p>
<h2>Masked Attention</h2>
<h3>Padding Mask</h3>
<p>å¤„ç†å˜é•¿åºåˆ—æ—¶ï¼Œå¡«å……ä½ç½®ä¸åº”è¯¥å‚ä¸è®¡ç®—ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord">âˆ’</span><span class="mord">âˆ</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">ifÂ </span></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mord text"><span class="mord">Â isÂ valid</span></span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">ifÂ </span></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mord text"><span class="mord">Â isÂ padding</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><a id="formula-attention-6"></a>
<a href="#formula-attention-6-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šå¯¹ padding ä½ç½®æ–½åŠ  <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord">âˆ’</span><span class="mord">âˆ</span></span></span></span>ï¼Œä½¿ softmax åæƒé‡å˜ä¸º 0ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºæ³¨æ„åŠ›åˆ†æ•°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span> ä¸ºè¢«å…³æ³¨ä½ç½®ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šè®©æ¨¡å‹å¿½ç•¥æ— æ•ˆå¡«å……ä½ç½®ã€‚</li>
</ul>
<h3>Causal Mask (Look-ahead Mask)</h3>
<p>åœ¨è§£ç å™¨ä¸­ï¼Œä½ç½® <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> åªèƒ½çœ‹åˆ°ä½ç½® <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> åˆ° <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span>ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord">âˆ’</span><span class="mord">âˆ</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">ifÂ </span></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â‰¤</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal">i</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">ifÂ </span></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><a id="formula-attention-7"></a>
<a href="#formula-attention-7-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Attention</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4684em;vertical-align:-0.95em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.2528em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span></p>
<p><a id="formula-attention-8"></a>
<a href="#formula-attention-8-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šç”¨æ©ç  <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span></span> æŠŠæœªæ¥ä½ç½®çš„æ³¨æ„åŠ›åˆ†æ•°ç½®ä¸º <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord">âˆ’</span><span class="mord">âˆ</span></span></span></span>ï¼Œä¿è¯å› æœæ€§ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> è¡¨ç¤ºä½ç½® <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> æ˜¯å¦å…è®¸çœ‹ä½ç½® <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span>ï¼›å…è®¸ä¸º 0ï¼Œä¸å…è®¸ä¸º <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord">âˆ’</span><span class="mord">âˆ</span></span></span></span>ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šè§£ç å™¨ç”Ÿæˆæ—¶åªèƒ½çœ‹â€œè¿‡å»â€ï¼Œé¿å…ä¿¡æ¯æ³„éœ²ã€‚</li>
</ul>
<h2>Cross-Attention</h2>
<p>ç¼–ç å™¨-è§£ç å™¨æ³¨æ„åŠ›ä¸­ï¼ŒQuery æ¥è‡ªè§£ç å™¨ï¼ŒKey å’Œ Value æ¥è‡ªç¼–ç å™¨ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0858em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">ec</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0858em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0413em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><a id="formula-attention-9"></a>
<a href="#formula-attention-9-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p>è¿™è®©è§£ç å™¨å¯ä»¥&quot;æŸ¥çœ‹&quot;ç¼–ç å™¨çš„è¾“å‡ºã€‚</p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šæŸ¥è¯¢æ¥è‡ªè§£ç å™¨ï¼Œé”®å’Œå€¼æ¥è‡ªç¼–ç å™¨ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">ec</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºè§£ç å™¨è¾“å…¥è¡¨ç¤ºï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºç¼–ç å™¨è¾“å‡ºè¡¨ç¤ºã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šè§£ç å™¨åœ¨ç”Ÿæˆæ—¶èƒ½å¯¹é½å¹¶åˆ©ç”¨æºåºåˆ—ä¿¡æ¯ã€‚</li>
</ul>
<h2>Flash Attention</h2>
<h3>é—®é¢˜ï¼šå†…å­˜ç“¶é¢ˆ</h3>
<p>æ ‡å‡†æ³¨æ„åŠ›çš„ç©ºé—´å¤æ‚åº¦æ˜¯ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>ï¼Œé•¿åºåˆ—ä¼šå ç”¨å¤§é‡å†…å­˜ã€‚</p>
<h3>Flash Attention çš„æ€æƒ³</h3>
<ol>
<li><strong>åˆ†å—è®¡ç®—</strong>ï¼šå°† Qã€Kã€V åˆ†æˆå°å—</li>
<li><strong>åœ¨çº¿ Softmax</strong>ï¼šé€å—è®¡ç®— softmaxï¼Œä¸éœ€è¦å­˜å‚¨å®Œæ•´çš„æ³¨æ„åŠ›çŸ©é˜µ</li>
<li><strong>å†…å­˜é‡ç”¨</strong>ï¼šåˆ©ç”¨ GPU çš„é«˜å¸¦å®½å†…å­˜ (HBM) å’Œ SRAM</li>
</ol>
<h3>ç®—æ³•è¦ç‚¹</h3>
<pre class="hljs"><code>for each block of Q:
    for each block of K, V:
        compute local attention
        update output incrementally
</code></pre>
<h3>æ•ˆæœ</h3>
<ul>
<li>å†…å­˜å¤æ‚åº¦ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span>ï¼ˆçº¿æ€§ï¼‰</li>
<li>é€Ÿåº¦æå‡ï¼š2-4 å€</li>
<li>æ•°å€¼ç­‰ä»·ï¼šè¾“å‡ºä¸æ ‡å‡†æ³¨æ„åŠ›å®Œå…¨ç›¸åŒ</li>
</ul>
<h2>æ³¨æ„åŠ›å˜ä½“</h2>
<table>
<thead>
<tr>
<th>å˜ä½“</th>
<th>ç‰¹ç‚¹</th>
<th>å¤æ‚åº¦</th>
</tr>
</thead>
<tbody>
<tr>
<td>Standard Attention</td>
<td>å…¨åºåˆ—æ³¨æ„åŠ›</td>
<td><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></td>
</tr>
<tr>
<td>Flash Attention</td>
<td>å†…å­˜ä¼˜åŒ–ï¼Œåˆ†å—è®¡ç®—</td>
<td><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> å†…å­˜</td>
</tr>
<tr>
<td>Sparse Attention</td>
<td>ç¨€ç–æ³¨æ„åŠ›æ¨¡å¼</td>
<td><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0503em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8003em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord mathnormal">n</span></span></span><span style="top:-2.7603em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice">&lt;path d=&quot;M95,702</td>
</tr>
<tr>
<td>c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14</td>
<td></td>
<td></td>
</tr>
<tr>
<td>c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54</td>
<td></td>
<td></td>
</tr>
<tr>
<td>c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10</td>
<td></td>
<td></td>
</tr>
<tr>
<td>s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429</td>
<td></td>
<td></td>
</tr>
<tr>
<td>c69,-144,104.5,-217.7,106.5,-221</td>
<td></td>
<td></td>
</tr>
<tr>
<td>l0 -0</td>
<td></td>
<td></td>
</tr>
<tr>
<td>c5.3,-9.3,12,-14,20,-14</td>
<td></td>
<td></td>
</tr>
<tr>
<td>H400000v40H845.2724</td>
<td></td>
<td></td>
</tr>
<tr>
<td>s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7</td>
<td></td>
<td></td>
</tr>
<tr>
<td>c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z</td>
<td></td>
<td></td>
</tr>
<tr>
<td>M834 80h400000v40h-400000z&quot;/&gt;</svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2397em;"><span></span></span></span></span></span><span class="mclose">)</span></span></span></span></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Linear Attention</td>
<td>çº¿æ€§è¿‘ä¼¼</td>
<td><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></td>
</tr>
<tr>
<td>Multi-Query Attention</td>
<td>å…±äº« Key å’Œ Value</td>
<td>å‡å°‘å‚æ•°</td>
</tr>
</tbody>
</table>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li>è¡¨ä¸­çš„ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>ã€<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> æ˜¯æ—¶é—´/ç©ºé—´å¤æ‚åº¦é‡çº§ï¼Œç”¨æ¥æè¿°åºåˆ—é•¿åº¦å¢å¤§æ—¶çš„å¢é•¿é€Ÿåº¦ã€‚</li>
</ul>
<h2>å®ç°ç»†èŠ‚</h2>
<h3>æ•°å€¼ç¨³å®šæ€§</h3>
<pre class="hljs"><code><span class="hljs-comment"># Bad: å¯èƒ½æº¢å‡º</span>
scores = Q @ K.T / sqrt(d_k)

<span class="hljs-comment"># Good: å‡å»æœ€å¤§å€¼</span>
scores = Q @ K.T / sqrt(d_k)
scores = scores - scores.<span class="hljs-built_in">max</span>(dim=-<span class="hljs-number">1</span>, keepdim=<span class="hljs-literal">True</span>)
attn = F.softmax(scores, dim=-<span class="hljs-number">1</span>)
</code></pre>
<h3>æ··åˆç²¾åº¦è®­ç»ƒ</h3>
<pre class="hljs"><code><span class="hljs-comment"># æ³¨æ„åŠ›è®¡ç®—é€šå¸¸ä½¿ç”¨ FP32</span>
<span class="hljs-keyword">with</span> torch.cuda.amp.autocast(enabled=<span class="hljs-literal">False</span>):
    scores = Q.<span class="hljs-built_in">float</span>() @ K.<span class="hljs-built_in">float</span>().T / sqrt(d_k)
</code></pre>
<h2>å‚è€ƒæ–‡çŒ®</h2>
<ol>
<li>Vaswani et al. (2017). <em>Attention Is All You Need</em></li>
<li>Dao et al. (2022). <em>FlashAttention: Fast and Memory-Efficient Exact Attention</em></li>
<li>Child et al. (2019). <em>Generating Long Sequences with Sparse Transformers</em></li>
<li>Shazeer (2019). <em>Fast Transformer Decoding: One Write-Head is All You Need</em></li>
</ol>
<h1>Attention æµç¨‹å›¾è§£</h1>
<blockquote>
<p>é€šè¿‡å¯è§†åŒ–å›¾è¡¨ç†è§£æ³¨æ„åŠ›æœºåˆ¶çš„å·¥ä½œæµç¨‹</p>
</blockquote>
<h2>è‡ªæ³¨æ„åŠ›æ ¸å¿ƒæµç¨‹</h2>
<p><div class="mermaid">flowchart TB
    A["è¾“å…¥ X"] --&gt; B["çº¿æ€§æŠ•å½±"]
    B --&gt; C["Q (Query)"]
    B --&gt; D["K (Key)"]
    B --&gt; E["V (Value)"]

    C --&gt; F["Q Ã— K^T&lt;br/&gt;æ³¨æ„åŠ›åˆ†æ•°"]
    D --&gt; F

    F --&gt; G["Scale&lt;br/&gt;é™¤ä»¥ âˆšd"]
    G --&gt; H["Softmax&lt;br/&gt;å½’ä¸€åŒ–"]
    H --&gt; I["Ã— V&lt;br/&gt;åŠ æƒæ±‚å’Œ"]
    E --&gt; I

    I --&gt; J["è¾“å‡º"]

    style J fill:#c8e6c9</div></p>
<h2>æ³¨æ„åŠ›åˆ†æ•°è®¡ç®—</h2>
<p><div class="mermaid">flowchart LR
    subgraph QKçŸ©é˜µä¹˜æ³•
        A["Q: [seq, d]"] --&gt; C["åˆ†æ•°: [seq, seq]"]
        B["K: [seq, d]"] --&gt; C
    end

    C --&gt; D["Softmax"]
    D --&gt; E["æ³¨æ„åŠ›æƒé‡"]

    style E fill:#c8e6c9</div></p>
<h2>å¤šå¤´æ³¨æ„åŠ›</h2>
<p><div class="mermaid">flowchart TB
    A["è¾“å…¥"] --&gt; B["åˆ†å‰²ä¸º h ä¸ªå¤´"]

    B --&gt; C1["å¤´ 1&lt;br/&gt;Attention(Q1,K1,V1)"]
    B --&gt; C2["å¤´ 2&lt;br/&gt;Attention(Q2,K2,V2)"]
    B --&gt; C3["..."]
    B --&gt; C4["å¤´ h&lt;br/&gt;Attention(Qh,Kh,Vh)"]

    C1 --&gt; D["Concat"]
    C2 --&gt; D
    C3 --&gt; D
    C4 --&gt; D

    D --&gt; E["çº¿æ€§æŠ•å½±"]
    E --&gt; F["è¾“å‡º"]

    style F fill:#c8e6c9</div></p>
<h2>å› æœæ©ç </h2>
<p><div class="mermaid">flowchart TB
    subgraph æ©ç çŸ©é˜µ
        A["ä½ç½® 1"] --&gt; B["âœ“ âœ— âœ— âœ—"]
        C["ä½ç½® 2"] --&gt; D["âœ“ âœ“ âœ— âœ—"]
        E["ä½ç½® 3"] --&gt; F["âœ“ âœ“ âœ“ âœ—"]
        G["ä½ç½® 4"] --&gt; H["âœ“ âœ“ âœ“ âœ“"]
    end

    I["åªèƒ½çœ‹åˆ°ä¹‹å‰çš„ä½ç½®"]

    style B fill:#c8e6c9
    style D fill:#c8e6c9
    style F fill:#c8e6c9
    style H fill:#c8e6c9</div></p>
<h2>æ³¨æ„åŠ›å¯è§†åŒ–</h2>
<p><div class="mermaid">flowchart LR
    subgraph "The cat sat on mat"
        A["The"] --&gt;|"0.1"| B["cat"]
        B --&gt;|"0.8"| C["sat"]
        C --&gt;|"0.3"| D["on"]
        D --&gt;|"0.5"| E["mat"]
    end

    F["çº¿è¶Šç²— = æ³¨æ„åŠ›è¶Šé«˜"]

    style B fill:#fff9c4</div></p>
<h2>Flash Attention ä¼˜åŒ–</h2>
<p><div class="mermaid">flowchart TB
    subgraph æ ‡å‡†å®ç°
        S1["è®¡ç®—å®Œæ•´æ³¨æ„åŠ›çŸ©é˜µ&lt;br/&gt;O(NÂ²) å†…å­˜"]
        S2["å­˜å‚¨åˆ° HBM"]
        S3["åº”ç”¨ Softmax"]
    end

    subgraph Flash Attention
        F1["åˆ†å—è®¡ç®—&lt;br/&gt;O(N) å†…å­˜"]
        F2["åœ¨ SRAM ä¸­å®Œæˆ"]
        F3["åªå†™æœ€ç»ˆç»“æœ"]
    end

    style S1 fill:#ffcdd2
    style F1 fill:#c8e6c9</div></p>
<h2>å›¾è§£è¯´æ˜</h2>
<h3>æ³¨æ„åŠ›å…¬å¼</h3>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Attention</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4684em;vertical-align:-0.95em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.2528em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span></p>
<h3>å…³é”®æ¦‚å¿µ</h3>
<table>
<thead>
<tr>
<th>æ¦‚å¿µ</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>Query</td>
<td>æŸ¥è¯¢å‘é‡ï¼Œâ€œæˆ‘åœ¨æ‰¾ä»€ä¹ˆâ€</td>
</tr>
<tr>
<td>Key</td>
<td>é”®å‘é‡ï¼Œâ€œæˆ‘æ˜¯ä»€ä¹ˆâ€</td>
</tr>
<tr>
<td>Value</td>
<td>å€¼å‘é‡ï¼Œâ€œæˆ‘çš„å†…å®¹â€</td>
</tr>
<tr>
<td>å¤´æ•°</td>
<td>å¹¶è¡Œæ³¨æ„åŠ›çš„æ•°é‡</td>
</tr>
</tbody>
</table>
<h3>è®¡ç®—å¤æ‚åº¦</h3>
<ul>
<li>æ—¶é—´: O(NÂ² Ã— d)</li>
<li>ç©ºé—´: O(NÂ²) (æ ‡å‡†) / O(N) (Flash)</li>
</ul>
<div class="code-appendix page-break"><h2>é™„å½•ï¼šä»£ç ç¤ºä¾‹</h2><div class="code-file"><h3>mha_example.py</h3><pre class="hljs"><code><span class="hljs-string">&quot;&quot;&quot;
Multi-Head Attention ç¤ºä¾‹ä»£ç  / Multi-Head Attention Example Code
=================================================================

æœ¬ç¤ºä¾‹å±•ç¤º Multi-Head Attention çš„åŸç†å’Œå®ç°ã€‚
This example demonstrates the principle and implementation of Multi-Head Attention.

ä¾èµ–å®‰è£… / Dependencies:
    pip install torch matplotlib numpy
&quot;&quot;&quot;</span>

<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn
<span class="hljs-keyword">import</span> torch.nn.functional <span class="hljs-keyword">as</span> F
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 1. Multi-Head Attention æ‰‹åŠ¨å®ç° / Manual Implementation of MHA</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiHeadAttention</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;
    æ‰‹åŠ¨å®ç°çš„ Multi-Head Attention / Manual implementation of Multi-Head Attention

    æ•°å­¦å…¬å¼ / Mathematical formula:
        MultiHead(Q, K, V) = Concat(head_1, ..., head_h) @ W_o
        where head_i = Attention(Q @ W_q_i, K @ W_k_i, V @ W_v_i)
    &quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, d_model, num_heads, dropout=<span class="hljs-number">0.1</span></span>):
        <span class="hljs-built_in">super</span>().__init__()

        <span class="hljs-keyword">assert</span> d_model % num_heads == <span class="hljs-number">0</span>, <span class="hljs-string">&quot;d_model å¿…é¡»èƒ½è¢« num_heads æ•´é™¤&quot;</span>

        <span class="hljs-variable language_">self</span>.d_model = d_model
        <span class="hljs-variable language_">self</span>.num_heads = num_heads
        <span class="hljs-variable language_">self</span>.d_k = d_model // num_heads  <span class="hljs-comment"># æ¯ä¸ªå¤´çš„ç»´åº¦</span>

        <span class="hljs-comment"># çº¿æ€§æŠ•å½±å±‚ï¼ˆåˆå¹¶æ‰€æœ‰å¤´ï¼‰/ Linear projections (combined for all heads)</span>
        <span class="hljs-variable language_">self</span>.W_q = nn.Linear(d_model, d_model, bias=<span class="hljs-literal">False</span>)
        <span class="hljs-variable language_">self</span>.W_k = nn.Linear(d_model, d_model, bias=<span class="hljs-literal">False</span>)
        <span class="hljs-variable language_">self</span>.W_v = nn.Linear(d_model, d_model, bias=<span class="hljs-literal">False</span>)
        <span class="hljs-variable language_">self</span>.W_o = nn.Linear(d_model, d_model, bias=<span class="hljs-literal">False</span>)

        <span class="hljs-variable language_">self</span>.dropout = nn.Dropout(dropout)
        <span class="hljs-variable language_">self</span>.scale = <span class="hljs-variable language_">self</span>.d_k ** -<span class="hljs-number">0.5</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, query, key, value, mask=<span class="hljs-literal">None</span></span>):
        <span class="hljs-string">&quot;&quot;&quot;
        å‚æ•° / Args:
            query: [batch, seq_len_q, d_model]
            key: [batch, seq_len_k, d_model]
            value: [batch, seq_len_v, d_model] (seq_len_k == seq_len_v)
            mask: [batch, seq_len_q, seq_len_k] æˆ– [seq_len_q, seq_len_k]

        è¿”å› / Returns:
            output: [batch, seq_len_q, d_model]
            attn_weights: [batch, num_heads, seq_len_q, seq_len_k]
        &quot;&quot;&quot;</span>
        batch_size = query.size(<span class="hljs-number">0</span>)

        <span class="hljs-comment"># 1. çº¿æ€§æŠ•å½± / Linear projections</span>
        Q = <span class="hljs-variable language_">self</span>.W_q(query)  <span class="hljs-comment"># [batch, seq_len_q, d_model]</span>
        K = <span class="hljs-variable language_">self</span>.W_k(key)    <span class="hljs-comment"># [batch, seq_len_k, d_model]</span>
        V = <span class="hljs-variable language_">self</span>.W_v(value)  <span class="hljs-comment"># [batch, seq_len_v, d_model]</span>

        <span class="hljs-comment"># 2. åˆ†å‰²æˆå¤šä¸ªå¤´ / Split into multiple heads</span>
        <span class="hljs-comment"># [batch, seq_len, d_model] -&gt; [batch, num_heads, seq_len, d_k]</span>
        Q = Q.view(batch_size, -<span class="hljs-number">1</span>, <span class="hljs-variable language_">self</span>.num_heads, <span class="hljs-variable language_">self</span>.d_k).transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)
        K = K.view(batch_size, -<span class="hljs-number">1</span>, <span class="hljs-variable language_">self</span>.num_heads, <span class="hljs-variable language_">self</span>.d_k).transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)
        V = V.view(batch_size, -<span class="hljs-number">1</span>, <span class="hljs-variable language_">self</span>.num_heads, <span class="hljs-variable language_">self</span>.d_k).transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)

        <span class="hljs-comment"># 3. è®¡ç®—æ³¨æ„åŠ›åˆ†æ•° / Compute attention scores</span>
        <span class="hljs-comment"># [batch, num_heads, seq_len_q, d_k] @ [batch, num_heads, d_k, seq_len_k]</span>
        <span class="hljs-comment"># = [batch, num_heads, seq_len_q, seq_len_k]</span>
        scores = torch.matmul(Q, K.transpose(-<span class="hljs-number">2</span>, -<span class="hljs-number">1</span>)) * <span class="hljs-variable language_">self</span>.scale

        <span class="hljs-comment"># 4. åº”ç”¨ mask / Apply mask</span>
        <span class="hljs-keyword">if</span> mask <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            <span class="hljs-comment"># æ‰©å±• mask ä»¥åŒ¹é…å¤šå¤´ç»´åº¦ / Expand mask to match multi-head dimensions</span>
            <span class="hljs-keyword">if</span> mask.dim() == <span class="hljs-number">2</span>:
                mask = mask.unsqueeze(<span class="hljs-number">0</span>)  <span class="hljs-comment"># [1, seq_len_q, seq_len_k]</span>
            <span class="hljs-keyword">elif</span> mask.dim() == <span class="hljs-number">3</span>:
                <span class="hljs-keyword">pass</span>  <span class="hljs-comment"># [batch, seq_len_q, seq_len_k]</span>
            <span class="hljs-comment"># æ‰©å±•åˆ°å¤´ç»´åº¦ / Expand to head dimension</span>
            mask = mask.unsqueeze(<span class="hljs-number">1</span>)  <span class="hljs-comment"># [batch, 1, seq_len_q, seq_len_k]</span>
            scores = scores.masked_fill(mask == <span class="hljs-number">1</span>, <span class="hljs-built_in">float</span>(<span class="hljs-string">&#x27;-inf&#x27;</span>))

        <span class="hljs-comment"># 5. Softmax å’Œ Dropout</span>
        attn_weights = F.softmax(scores, dim=-<span class="hljs-number">1</span>)
        attn_weights = <span class="hljs-variable language_">self</span>.dropout(attn_weights)

        <span class="hljs-comment"># 6. åŠ æƒæ±‚å’Œ / Weighted sum</span>
        <span class="hljs-comment"># [batch, num_heads, seq_len_q, seq_len_k] @ [batch, num_heads, seq_len_v, d_k]</span>
        <span class="hljs-comment"># = [batch, num_heads, seq_len_q, d_k]</span>
        output = torch.matmul(attn_weights, V)

        <span class="hljs-comment"># 7. åˆå¹¶å¤šå¤´ / Concatenate heads</span>
        <span class="hljs-comment"># [batch, num_heads, seq_len_q, d_k] -&gt; [batch, seq_len_q, num_heads, d_k]</span>
        <span class="hljs-comment"># -&gt; [batch, seq_len_q, d_model]</span>
        output = output.transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>).contiguous().view(batch_size, -<span class="hljs-number">1</span>, <span class="hljs-variable language_">self</span>.d_model)

        <span class="hljs-comment"># 8. æœ€ç»ˆçº¿æ€§æŠ•å½± / Final linear projection</span>
        output = <span class="hljs-variable language_">self</span>.W_o(output)

        <span class="hljs-keyword">return</span> output, attn_weights

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 2. æµ‹è¯• Multi-Head Attention / Test MHA</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Multi-Head Attention æµ‹è¯• / MHA Test&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

torch.manual_seed(<span class="hljs-number">42</span>)

d_model = <span class="hljs-number">512</span>
num_heads = <span class="hljs-number">8</span>
seq_len = <span class="hljs-number">10</span>
batch_size = <span class="hljs-number">2</span>

<span class="hljs-comment"># åˆ›å»ºè¾“å…¥ / Create input</span>
x = torch.randn(batch_size, seq_len, d_model)

<span class="hljs-comment"># åˆ›å»º MHA å±‚ / Create MHA layer</span>
mha = MultiHeadAttention(d_model, num_heads)

<span class="hljs-comment"># å‰å‘ä¼ æ’­ / Forward pass</span>
output, attn_weights = mha(x, x, x)  <span class="hljs-comment"># Self-Attention</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\né…ç½® / Configuration:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  d_model: <span class="hljs-subst">{d_model}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  num_heads: <span class="hljs-subst">{num_heads}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  d_k (per head): <span class="hljs-subst">{d_model // num_heads}</span>&quot;</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nè¾“å…¥å½¢çŠ¶ / Input shape: <span class="hljs-subst">{x.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;è¾“å‡ºå½¢çŠ¶ / Output shape: <span class="hljs-subst">{output.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;æ³¨æ„åŠ›æƒé‡å½¢çŠ¶ / Attention weights shape: <span class="hljs-subst">{attn_weights.shape}</span>&quot;</span>)

<span class="hljs-comment"># å‚æ•°ç»Ÿè®¡ / Parameter statistics</span>
total_params = <span class="hljs-built_in">sum</span>(p.numel() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> mha.parameters())
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nå‚æ•°é‡ / Total parameters: <span class="hljs-subst">{total_params:,}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 3. å¯è§†åŒ–å¤šå¤´æ³¨æ„åŠ› / Visualize Multi-Head Attention</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;å¤šå¤´æ³¨æ„åŠ›å¯è§†åŒ– / Multi-Head Attention Visualization&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-comment"># åˆ›å»ºä¸€ä¸ªå°å‹ç¤ºä¾‹ç”¨äºå¯è§†åŒ– / Create a small example for visualization</span>
d_model_small = <span class="hljs-number">64</span>
num_heads_small = <span class="hljs-number">4</span>
seq_len_small = <span class="hljs-number">6</span>

mha_small = MultiHeadAttention(d_model_small, num_heads_small)
x_small = torch.randn(<span class="hljs-number">1</span>, seq_len_small, d_model_small)

<span class="hljs-comment"># è·å–æ³¨æ„åŠ›æƒé‡ / Get attention weights</span>
<span class="hljs-keyword">with</span> torch.no_grad():
    _, attn_small = mha_small(x_small, x_small, x_small)

<span class="hljs-comment"># å¯è§†åŒ–æ¯ä¸ªå¤´çš„æ³¨æ„åŠ› / Visualize attention from each head</span>
fig, axes = plt.subplots(<span class="hljs-number">1</span>, num_heads_small, figsize=(<span class="hljs-number">16</span>, <span class="hljs-number">4</span>))

tokens = [<span class="hljs-string">f&quot;T<span class="hljs-subst">{i}</span>&quot;</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(seq_len_small)]

<span class="hljs-keyword">for</span> head <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_heads_small):
    ax = axes[head]
    attn_matrix = attn_small[<span class="hljs-number">0</span>, head].numpy()
    im = ax.imshow(attn_matrix, cmap=<span class="hljs-string">&#x27;Blues&#x27;</span>, vmin=<span class="hljs-number">0</span>, vmax=<span class="hljs-number">1</span>)
    ax.set_title(<span class="hljs-string">f&#x27;Head <span class="hljs-subst">{head + <span class="hljs-number">1</span>}</span>&#x27;</span>, fontsize=<span class="hljs-number">12</span>)
    ax.set_xticks(<span class="hljs-built_in">range</span>(seq_len_small))
    ax.set_yticks(<span class="hljs-built_in">range</span>(seq_len_small))
    ax.set_xticklabels(tokens)
    ax.set_yticklabels(tokens)
    ax.set_xlabel(<span class="hljs-string">&#x27;Key&#x27;</span>)
    ax.set_ylabel(<span class="hljs-string">&#x27;Query&#x27;</span>)
    plt.colorbar(im, ax=ax)

plt.suptitle(<span class="hljs-string">&#x27;Multi-Head Attention Weights&#x27;</span>, fontsize=<span class="hljs-number">14</span>)
plt.tight_layout()
plt.savefig(<span class="hljs-string">&#x27;/tmp/mha_heads.png&#x27;</span>, dpi=<span class="hljs-number">150</span>, bbox_inches=<span class="hljs-string">&#x27;tight&#x27;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nå¤šå¤´æ³¨æ„åŠ›å›¾åƒå·²ä¿å­˜è‡³ / MHA image saved to: /tmp/mha_heads.png&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 4. å¹³å‡æ³¨æ„åŠ› vs å„å¤´æ³¨æ„åŠ› / Average vs Individual Heads</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;æ³¨æ„åŠ›æ¨¡å¼åˆ†æ / Attention Pattern Analysis&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-comment"># è®¡ç®—å¹³å‡æ³¨æ„åŠ› / Compute average attention</span>
avg_attn = attn_small[<span class="hljs-number">0</span>].mean(dim=<span class="hljs-number">0</span>).numpy()

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nå„å¤´æ³¨æ„åŠ›æ¨¡å¼çš„ç‰¹ç‚¹ / Characteristics of each head&#x27;s attention pattern:&quot;</span>)

<span class="hljs-keyword">for</span> head <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_heads_small):
    attn_head = attn_small[<span class="hljs-number">0</span>, head].numpy()
    <span class="hljs-comment"># æ‰¾åˆ°æ¯ä¸ª query æœ€å…³æ³¨çš„ key / Find most attended key for each query</span>
    max_attended = attn_head.argmax(axis=<span class="hljs-number">1</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n  Head <span class="hljs-subst">{head + <span class="hljs-number">1</span>}</span>:&quot;</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;    æ¯ä¸ª query æœ€å…³æ³¨çš„ä½ç½® / Most attended position for each query:&quot;</span>)
    <span class="hljs-keyword">for</span> q, k <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(max_attended):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;      Query <span class="hljs-subst">{q}</span> -&gt; Key <span class="hljs-subst">{k}</span> (æƒé‡ <span class="hljs-subst">{attn_head[q, k]:<span class="hljs-number">.3</span>f}</span>)&quot;</span>)

<span class="hljs-comment"># å¯è§†åŒ–å¹³å‡æ³¨æ„åŠ› / Visualize average attention</span>
plt.figure(figsize=(<span class="hljs-number">6</span>, <span class="hljs-number">5</span>))
plt.imshow(avg_attn, cmap=<span class="hljs-string">&#x27;Blues&#x27;</span>)
plt.colorbar(label=<span class="hljs-string">&#x27;Attention Weight&#x27;</span>)
plt.xticks(<span class="hljs-built_in">range</span>(seq_len_small), tokens)
plt.yticks(<span class="hljs-built_in">range</span>(seq_len_small), tokens)
plt.xlabel(<span class="hljs-string">&#x27;Key&#x27;</span>)
plt.ylabel(<span class="hljs-string">&#x27;Query&#x27;</span>)
plt.title(<span class="hljs-string">&#x27;Average Attention Across All Heads&#x27;</span>)

<span class="hljs-comment"># æ·»åŠ æ•°å€¼ / Add values</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(seq_len_small):
    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(seq_len_small):
        color = <span class="hljs-string">&#x27;white&#x27;</span> <span class="hljs-keyword">if</span> avg_attn[i, j] &gt; <span class="hljs-number">0.3</span> <span class="hljs-keyword">else</span> <span class="hljs-string">&#x27;black&#x27;</span>
        plt.text(j, i, <span class="hljs-string">f&#x27;<span class="hljs-subst">{avg_attn[i, j]:<span class="hljs-number">.2</span>f}</span>&#x27;</span>, ha=<span class="hljs-string">&#x27;center&#x27;</span>, va=<span class="hljs-string">&#x27;center&#x27;</span>, color=color, fontsize=<span class="hljs-number">8</span>)

plt.tight_layout()
plt.savefig(<span class="hljs-string">&#x27;/tmp/mha_average.png&#x27;</span>, dpi=<span class="hljs-number">150</span>, bbox_inches=<span class="hljs-string">&#x27;tight&#x27;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nå¹³å‡æ³¨æ„åŠ›å›¾åƒå·²ä¿å­˜è‡³ / Average attention image saved to: /tmp/mha_average.png&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 5. ä¸ PyTorch å†…ç½®å®ç°å¯¹æ¯” / Compare with PyTorch Implementation</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ä¸ PyTorch å†…ç½® MHA å¯¹æ¯” / Compare with PyTorch MHA&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-comment"># PyTorch å†…ç½® MHA</span>
mha_pytorch = nn.MultiheadAttention(d_model, num_heads, batch_first=<span class="hljs-literal">True</span>)

<span class="hljs-comment"># æµ‹è¯•æ•°æ®</span>
x_test = torch.randn(batch_size, seq_len, d_model)

<span class="hljs-comment"># æˆ‘ä»¬çš„å®ç°</span>
<span class="hljs-keyword">with</span> torch.no_grad():
    output_custom, attn_custom = mha(x_test, x_test, x_test)

<span class="hljs-comment"># PyTorch å®ç°</span>
<span class="hljs-keyword">with</span> torch.no_grad():
    output_pytorch, attn_pytorch = mha_pytorch(x_test, x_test, x_test)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nè¾“å‡ºå½¢çŠ¶å¯¹æ¯” / Output shape comparison:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  è‡ªå®šä¹‰å®ç° / Custom: <span class="hljs-subst">{output_custom.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  PyTorch å®ç° / PyTorch: <span class="hljs-subst">{output_pytorch.shape}</span>&quot;</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\næ³¨æ„åŠ›å½¢çŠ¶å¯¹æ¯” / Attention shape comparison:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  è‡ªå®šä¹‰å®ç° / Custom: <span class="hljs-subst">{attn_custom.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  PyTorch å®ç° / PyTorch: <span class="hljs-subst">{attn_pytorch.shape}</span>&quot;</span>)

<span class="hljs-comment"># å‚æ•°é‡å¯¹æ¯”</span>
params_custom = <span class="hljs-built_in">sum</span>(p.numel() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> mha.parameters())
params_pytorch = <span class="hljs-built_in">sum</span>(p.numel() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> mha_pytorch.parameters())

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nå‚æ•°é‡å¯¹æ¯” / Parameter comparison:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  è‡ªå®šä¹‰å®ç° / Custom: <span class="hljs-subst">{params_custom:,}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  PyTorch å®ç° / PyTorch: <span class="hljs-subst">{params_pytorch:,}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 6. Cross-Attention ç¤ºä¾‹ / Cross-Attention Example</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Cross-Attention ç¤ºä¾‹ / Cross-Attention Example&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-comment"># Cross-Attention: Query æ¥è‡ªè§£ç å™¨ï¼ŒKey/Value æ¥è‡ªç¼–ç å™¨</span>
<span class="hljs-comment"># Cross-Attention: Query from decoder, Key/Value from encoder</span>

encoder_output = torch.randn(batch_size, <span class="hljs-number">8</span>, d_model)  <span class="hljs-comment"># ç¼–ç å™¨è¾“å‡º (8 ä¸ª token)</span>
decoder_input = torch.randn(batch_size, <span class="hljs-number">5</span>, d_model)   <span class="hljs-comment"># è§£ç å™¨è¾“å…¥ (5 ä¸ª token)</span>

<span class="hljs-comment"># Cross-Attention</span>
cross_attn_output, cross_attn_weights = mha(
    query=decoder_input,    <span class="hljs-comment"># è§£ç å™¨ä½œä¸º Query</span>
    key=encoder_output,     <span class="hljs-comment"># ç¼–ç å™¨ä½œä¸º Key</span>
    value=encoder_output    <span class="hljs-comment"># ç¼–ç å™¨ä½œä¸º Value</span>
)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nCross-Attention:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  ç¼–ç å™¨è¾“å‡ºå½¢çŠ¶ / Encoder output shape: <span class="hljs-subst">{encoder_output.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  è§£ç å™¨è¾“å…¥å½¢çŠ¶ / Decoder input shape: <span class="hljs-subst">{decoder_input.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  Cross-Attention è¾“å‡ºå½¢çŠ¶ / Output shape: <span class="hljs-subst">{cross_attn_output.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  æ³¨æ„åŠ›æƒé‡å½¢çŠ¶ / Attention weights shape: <span class="hljs-subst">{cross_attn_weights.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  (5 ä¸ªè§£ç å™¨ä½ç½®å„å…³æ³¨ 8 ä¸ªç¼–ç å™¨ä½ç½®)&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 7. æ€§èƒ½æµ‹è¯• / Performance Test</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;æ€§èƒ½æµ‹è¯• / Performance Test&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-keyword">import</span> time

<span class="hljs-keyword">def</span> <span class="hljs-title function_">benchmark_attention</span>(<span class="hljs-params">mha, seq_len, batch_size, num_iterations=<span class="hljs-number">100</span>, device=<span class="hljs-string">&#x27;cpu&#x27;</span></span>):
    <span class="hljs-string">&quot;&quot;&quot;åŸºå‡†æµ‹è¯•æ³¨æ„åŠ›è®¡ç®— / Benchmark attention computation&quot;&quot;&quot;</span>
    x = torch.randn(batch_size, seq_len, mha.d_model, device=device)
    mha = mha.to(device)

    <span class="hljs-comment"># é¢„çƒ­ / Warmup</span>
    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):
        _ = mha(x, x, x)

    <span class="hljs-comment"># è®¡æ—¶ / Timing</span>
    torch.cuda.synchronize() <span class="hljs-keyword">if</span> device == <span class="hljs-string">&#x27;cuda&#x27;</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>
    start = time.time()
    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_iterations):
        _ = mha(x, x, x)
    torch.cuda.synchronize() <span class="hljs-keyword">if</span> device == <span class="hljs-string">&#x27;cuda&#x27;</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>
    elapsed = time.time() - start

    <span class="hljs-keyword">return</span> elapsed / num_iterations * <span class="hljs-number">1000</span>  <span class="hljs-comment"># ms per iteration</span>

device = <span class="hljs-string">&#x27;cuda&#x27;</span> <span class="hljs-keyword">if</span> torch.cuda.is_available() <span class="hljs-keyword">else</span> <span class="hljs-string">&#x27;cpu&#x27;</span>
mha_perf = MultiHeadAttention(d_model=<span class="hljs-number">512</span>, num_heads=<span class="hljs-number">8</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nè®¾å¤‡ / Device: <span class="hljs-subst">{device}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;d_model=512, num_heads=8&quot;</span>)

<span class="hljs-keyword">for</span> seq_len <span class="hljs-keyword">in</span> [<span class="hljs-number">64</span>, <span class="hljs-number">128</span>, <span class="hljs-number">256</span>, <span class="hljs-number">512</span>]:
    avg_time = benchmark_attention(mha_perf, seq_len, batch_size=<span class="hljs-number">4</span>, device=device)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  seq_len=<span class="hljs-subst">{seq_len:4d}</span>: <span class="hljs-subst">{avg_time:<span class="hljs-number">.2</span>f}</span> ms per forward pass&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># æ€»ç»“ / Summary</span>
<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;æ€»ç»“ / Summary&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-string">&quot;&quot;&quot;
æœ¬ç¤ºä¾‹å±•ç¤ºäº† Multi-Head Attention çš„æ ¸å¿ƒæ¦‚å¿µ:
This example demonstrates core concepts of Multi-Head Attention:

1. å¤šå¤´çš„ä½œç”¨ / Role of multiple heads:
   - æ¯ä¸ªå¤´å­¦ä¹ ä¸åŒçš„è¡¨ç¤ºå­ç©ºé—´
   - å¯ä»¥åŒæ—¶å…³æ³¨ä¸åŒä½ç½®çš„ä¸åŒä¿¡æ¯

2. å®ç°è¦ç‚¹ / Implementation details:
   - å°† Q, K, V åˆ†å‰²æˆ num_heads ä¸ªå¤´
   - æ¯ä¸ªå¤´ç‹¬ç«‹è®¡ç®—æ³¨æ„åŠ›
   - æœ€ååˆå¹¶æ‰€æœ‰å¤´çš„è¾“å‡º

3. å‚æ•°æ•ˆç‡ / Parameter efficiency:
   - å‚æ•°é‡ä¸å•å¤´ç›¸åŒï¼ˆå› ä¸ºæ¯ä¸ªå¤´çš„ç»´åº¦å‡å°ï¼‰
   - ä½†è¡¨è¾¾èƒ½åŠ›æ›´å¼º

4. Cross-Attention:
   - Query æ¥è‡ªä¸€ä¸ªåºåˆ—
   - Key/Value æ¥è‡ªå¦ä¸€ä¸ªåºåˆ—
   - ç”¨äºç¼–ç å™¨-è§£ç å™¨ç»“æ„

5. å¤æ‚åº¦ / Complexity:
   - æ—¶é—´: O(n^2 * d)
   - ç©ºé—´: O(n^2 * h) ç”¨äºå­˜å‚¨æ¯å¤´çš„æ³¨æ„åŠ›æƒé‡
&quot;&quot;&quot;</span>
</code></pre></div><div class="code-file"><h3>self_attention_example.py</h3><pre class="hljs"><code><span class="hljs-string">&quot;&quot;&quot;
Self-Attention ç¤ºä¾‹ä»£ç  / Self-Attention Example Code
=====================================================

æœ¬ç¤ºä¾‹å±•ç¤º Self-Attention çš„åŸç†å’Œå®ç°ã€‚
This example demonstrates the principle and implementation of Self-Attention.

ä¾èµ–å®‰è£… / Dependencies:
    pip install torch matplotlib numpy
&quot;&quot;&quot;</span>

<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn
<span class="hljs-keyword">import</span> torch.nn.functional <span class="hljs-keyword">as</span> F
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 1. Self-Attention æ‰‹åŠ¨å®ç° / Manual Implementation of Self-Attention</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SelfAttentionManual</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;
    æ‰‹åŠ¨å®ç°çš„ Self-Attention / Manual implementation of Self-Attention

    æ•°å­¦å…¬å¼ / Mathematical formula:
        Attention(Q, K, V) = softmax(QK^T / sqrt(d_k)) * V
    &quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, d_model, d_k=<span class="hljs-literal">None</span>, d_v=<span class="hljs-literal">None</span></span>):
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-variable language_">self</span>.d_model = d_model
        <span class="hljs-variable language_">self</span>.d_k = d_k <span class="hljs-keyword">or</span> d_model
        <span class="hljs-variable language_">self</span>.d_v = d_v <span class="hljs-keyword">or</span> d_model

        <span class="hljs-comment"># çº¿æ€§æŠ•å½±å±‚ / Linear projection layers</span>
        <span class="hljs-variable language_">self</span>.W_q = nn.Linear(d_model, <span class="hljs-variable language_">self</span>.d_k, bias=<span class="hljs-literal">False</span>)
        <span class="hljs-variable language_">self</span>.W_k = nn.Linear(d_model, <span class="hljs-variable language_">self</span>.d_k, bias=<span class="hljs-literal">False</span>)
        <span class="hljs-variable language_">self</span>.W_v = nn.Linear(d_model, <span class="hljs-variable language_">self</span>.d_v, bias=<span class="hljs-literal">False</span>)

        <span class="hljs-variable language_">self</span>.scale = <span class="hljs-variable language_">self</span>.d_k ** -<span class="hljs-number">0.5</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x, mask=<span class="hljs-literal">None</span></span>):
        <span class="hljs-string">&quot;&quot;&quot;
        å‚æ•° / Args:
            x: [batch, seq_len, d_model]
            mask: [batch, seq_len, seq_len] æˆ– [seq_len, seq_len]
                  True/1 è¡¨ç¤ºè¦ mask çš„ä½ç½®

        è¿”å› / Returns:
            output: [batch, seq_len, d_v]
            attn_weights: [batch, seq_len, seq_len]
        &quot;&quot;&quot;</span>
        batch_size, seq_len, _ = x.shape

        <span class="hljs-comment"># è®¡ç®— Q, K, V / Compute Q, K, V</span>
        Q = <span class="hljs-variable language_">self</span>.W_q(x)  <span class="hljs-comment"># [batch, seq_len, d_k]</span>
        K = <span class="hljs-variable language_">self</span>.W_k(x)  <span class="hljs-comment"># [batch, seq_len, d_k]</span>
        V = <span class="hljs-variable language_">self</span>.W_v(x)  <span class="hljs-comment"># [batch, seq_len, d_v]</span>

        <span class="hljs-comment"># è®¡ç®—æ³¨æ„åŠ›åˆ†æ•° / Compute attention scores</span>
        <span class="hljs-comment"># [batch, seq_len, d_k] @ [batch, d_k, seq_len] = [batch, seq_len, seq_len]</span>
        scores = torch.matmul(Q, K.transpose(-<span class="hljs-number">2</span>, -<span class="hljs-number">1</span>)) * <span class="hljs-variable language_">self</span>.scale

        <span class="hljs-comment"># åº”ç”¨ mask / Apply mask</span>
        <span class="hljs-keyword">if</span> mask <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            scores = scores.masked_fill(mask == <span class="hljs-number">1</span>, <span class="hljs-built_in">float</span>(<span class="hljs-string">&#x27;-inf&#x27;</span>))

        <span class="hljs-comment"># Softmax / Softmax</span>
        attn_weights = F.softmax(scores, dim=-<span class="hljs-number">1</span>)

        <span class="hljs-comment"># åŠ æƒæ±‚å’Œ / Weighted sum</span>
        <span class="hljs-comment"># [batch, seq_len, seq_len] @ [batch, seq_len, d_v] = [batch, seq_len, d_v]</span>
        output = torch.matmul(attn_weights, V)

        <span class="hljs-keyword">return</span> output, attn_weights

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 2. æµ‹è¯• Self-Attention / Test Self-Attention</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Self-Attention æµ‹è¯• / Self-Attention Test&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

torch.manual_seed(<span class="hljs-number">42</span>)

d_model = <span class="hljs-number">8</span>
seq_len = <span class="hljs-number">5</span>
batch_size = <span class="hljs-number">2</span>

<span class="hljs-comment"># åˆ›å»ºè¾“å…¥ / Create input</span>
x = torch.randn(batch_size, seq_len, d_model)

<span class="hljs-comment"># åˆ›å»º Self-Attention å±‚ / Create Self-Attention layer</span>
self_attn = SelfAttentionManual(d_model)

<span class="hljs-comment"># å‰å‘ä¼ æ’­ / Forward pass</span>
output, attn_weights = self_attn(x)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nè¾“å…¥å½¢çŠ¶ / Input shape: <span class="hljs-subst">{x.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;è¾“å‡ºå½¢çŠ¶ / Output shape: <span class="hljs-subst">{output.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;æ³¨æ„åŠ›æƒé‡å½¢çŠ¶ / Attention weights shape: <span class="hljs-subst">{attn_weights.shape}</span>&quot;</span>)

<span class="hljs-comment"># éªŒè¯æ³¨æ„åŠ›æƒé‡å’Œä¸º 1 / Verify attention weights sum to 1</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\næ³¨æ„åŠ›æƒé‡å’Œ / Attention weights sum (åº”ä¸º 1):&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  <span class="hljs-subst">{attn_weights[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>].<span class="hljs-built_in">sum</span>().item():<span class="hljs-number">.6</span>f}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 3. å¯è§†åŒ–æ³¨æ„åŠ›æƒé‡ / Visualize Attention Weights</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;æ³¨æ„åŠ›æƒé‡å¯è§†åŒ– / Attention Weights Visualization&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-comment"># åˆ›å»ºä¸€ä¸ªæ›´æœ‰æ„ä¹‰çš„ç¤ºä¾‹ / Create a more meaningful example</span>
<span class="hljs-comment"># æ¨¡æ‹Ÿå¥å­ &quot;The cat sat on the mat&quot;</span>
sentence = [<span class="hljs-string">&quot;The&quot;</span>, <span class="hljs-string">&quot;cat&quot;</span>, <span class="hljs-string">&quot;sat&quot;</span>, <span class="hljs-string">&quot;on&quot;</span>, <span class="hljs-string">&quot;the&quot;</span>, <span class="hljs-string">&quot;mat&quot;</span>]
seq_len = <span class="hljs-built_in">len</span>(sentence)

<span class="hljs-comment"># åˆ›å»ºè¯åµŒå…¥ï¼ˆéšæœºï¼‰/ Create word embeddings (random)</span>
embedding = nn.Embedding(seq_len, d_model)
indices = torch.arange(seq_len).unsqueeze(<span class="hljs-number">0</span>)  <span class="hljs-comment"># [1, seq_len]</span>
x_sentence = embedding(indices)  <span class="hljs-comment"># [1, seq_len, d_model]</span>

<span class="hljs-comment"># è®¡ç®—æ³¨æ„åŠ› / Compute attention</span>
_, attn = self_attn(x_sentence)

<span class="hljs-comment"># å¯è§†åŒ– / Visualize</span>
plt.figure(figsize=(<span class="hljs-number">8</span>, <span class="hljs-number">6</span>))
plt.imshow(attn[<span class="hljs-number">0</span>].detach().numpy(), cmap=<span class="hljs-string">&#x27;Blues&#x27;</span>)
plt.colorbar(label=<span class="hljs-string">&#x27;Attention Weight&#x27;</span>)
plt.xticks(<span class="hljs-built_in">range</span>(seq_len), sentence, rotation=<span class="hljs-number">45</span>)
plt.yticks(<span class="hljs-built_in">range</span>(seq_len), sentence)
plt.xlabel(<span class="hljs-string">&#x27;Key Position&#x27;</span>)
plt.ylabel(<span class="hljs-string">&#x27;Query Position&#x27;</span>)
plt.title(<span class="hljs-string">&#x27;Self-Attention Weights&#x27;</span>)

<span class="hljs-comment"># æ·»åŠ æ•°å€¼æ ‡æ³¨ / Add value annotations</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(seq_len):
    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(seq_len):
        value = attn[<span class="hljs-number">0</span>, i, j].item()
        color = <span class="hljs-string">&#x27;white&#x27;</span> <span class="hljs-keyword">if</span> value &gt; <span class="hljs-number">0.3</span> <span class="hljs-keyword">else</span> <span class="hljs-string">&#x27;black&#x27;</span>
        plt.text(j, i, <span class="hljs-string">f&#x27;<span class="hljs-subst">{value:<span class="hljs-number">.2</span>f}</span>&#x27;</span>, ha=<span class="hljs-string">&#x27;center&#x27;</span>, va=<span class="hljs-string">&#x27;center&#x27;</span>, color=color, fontsize=<span class="hljs-number">8</span>)

plt.tight_layout()
plt.savefig(<span class="hljs-string">&#x27;/tmp/self_attention_weights.png&#x27;</span>, dpi=<span class="hljs-number">150</span>, bbox_inches=<span class="hljs-string">&#x27;tight&#x27;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\næ³¨æ„åŠ›æƒé‡å›¾åƒå·²ä¿å­˜è‡³ / Attention weights image saved to: /tmp/self_attention_weights.png&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 4. Causal Mask ç¤ºä¾‹ / Causal Mask Example</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Causal Mask ç¤ºä¾‹ / Causal Mask Example&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_causal_mask</span>(<span class="hljs-params">seq_len</span>):
    <span class="hljs-string">&quot;&quot;&quot;
    åˆ›å»ºå› æœæ©ç ï¼ˆä¸Šä¸‰è§’çŸ©é˜µï¼‰
    Create causal mask (upper triangular matrix)

    ä½ç½® i åªèƒ½çœ‹åˆ°ä½ç½® 0 åˆ° i
    Position i can only see positions 0 to i
    &quot;&quot;&quot;</span>
    mask = torch.triu(torch.ones(seq_len, seq_len), diagonal=<span class="hljs-number">1</span>)
    <span class="hljs-keyword">return</span> mask

causal_mask = create_causal_mask(<span class="hljs-number">6</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nå› æœæ©ç  / Causal mask (1 è¡¨ç¤ºè¦é®è”½):&quot;</span>)
<span class="hljs-built_in">print</span>(causal_mask.numpy())

<span class="hljs-comment"># åº”ç”¨å› æœæ©ç çš„æ³¨æ„åŠ› / Attention with causal mask</span>
output_masked, attn_masked = self_attn(x_sentence, mask=causal_mask)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nå¸¦å› æœæ©ç çš„æ³¨æ„åŠ›æƒé‡ / Masked attention weights:&quot;</span>)
<span class="hljs-built_in">print</span>(attn_masked[<span class="hljs-number">0</span>].detach().numpy().<span class="hljs-built_in">round</span>(<span class="hljs-number">3</span>))

<span class="hljs-comment"># å¯è§†åŒ–å› æœæ³¨æ„åŠ› / Visualize causal attention</span>
plt.figure(figsize=(<span class="hljs-number">8</span>, <span class="hljs-number">6</span>))
plt.imshow(attn_masked[<span class="hljs-number">0</span>].detach().numpy(), cmap=<span class="hljs-string">&#x27;Blues&#x27;</span>)
plt.colorbar(label=<span class="hljs-string">&#x27;Attention Weight&#x27;</span>)
plt.xticks(<span class="hljs-built_in">range</span>(seq_len), sentence, rotation=<span class="hljs-number">45</span>)
plt.yticks(<span class="hljs-built_in">range</span>(seq_len), sentence)
plt.xlabel(<span class="hljs-string">&#x27;Key Position (can attend to)&#x27;</span>)
plt.ylabel(<span class="hljs-string">&#x27;Query Position&#x27;</span>)
plt.title(<span class="hljs-string">&#x27;Causal Self-Attention Weights&#x27;</span>)

plt.tight_layout()
plt.savefig(<span class="hljs-string">&#x27;/tmp/causal_attention_weights.png&#x27;</span>, dpi=<span class="hljs-number">150</span>, bbox_inches=<span class="hljs-string">&#x27;tight&#x27;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nå› æœæ³¨æ„åŠ›å›¾åƒå·²ä¿å­˜è‡³ / Causal attention image saved to: /tmp/causal_attention_weights.png&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 5. PyTorch å†…ç½® MultiheadAttention å¯¹æ¯” / Compare with PyTorch MHA</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ä¸ PyTorch å†…ç½® MHA å¯¹æ¯” / Compare with PyTorch MHA&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-comment"># PyTorch çš„ MultiheadAttention</span>
mha = nn.MultiheadAttention(d_model, num_heads=<span class="hljs-number">1</span>, batch_first=<span class="hljs-literal">True</span>)

<span class="hljs-comment"># å¤åˆ¶æƒé‡ / Copy weights</span>
<span class="hljs-keyword">with</span> torch.no_grad():
    <span class="hljs-comment"># PyTorch MHA çš„æƒé‡ç»„ç»‡æ–¹å¼ä¸åŒ</span>
    <span class="hljs-comment"># è¿™é‡Œåªæ˜¯æ¼”ç¤ºä½¿ç”¨æ–¹æ³•</span>
    <span class="hljs-keyword">pass</span>

<span class="hljs-comment"># ä½¿ç”¨ PyTorch MHA / Use PyTorch MHA</span>
x_test = torch.randn(<span class="hljs-number">2</span>, <span class="hljs-number">5</span>, d_model)
output_pytorch, attn_pytorch = mha(x_test, x_test, x_test)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nPyTorch MHA è¾“å‡ºå½¢çŠ¶ / Output shape: <span class="hljs-subst">{output_pytorch.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;PyTorch MHA æ³¨æ„åŠ›å½¢çŠ¶ / Attention shape: <span class="hljs-subst">{attn_pytorch.shape}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 6. æ³¨æ„åŠ›åˆ†æ•°åˆ†æ / Attention Score Analysis</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;æ³¨æ„åŠ›åˆ†æ•°åˆ†æ / Attention Score Analysis&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-comment"># åˆ†æç¼©æ”¾å› å­çš„å½±å“ / Analyze the effect of scaling factor</span>
d_k = <span class="hljs-number">64</span>
q = torch.randn(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>, d_k)
k = torch.randn(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>, d_k)

<span class="hljs-comment"># ä¸ç¼©æ”¾çš„ç‚¹ç§¯ / Unscaled dot product</span>
scores_unscaled = torch.matmul(q, k.transpose(-<span class="hljs-number">2</span>, -<span class="hljs-number">1</span>))
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nä¸ç¼©æ”¾çš„åˆ†æ•° / Unscaled scores:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  å‡å€¼ / Mean: <span class="hljs-subst">{scores_unscaled.mean().item():<span class="hljs-number">.4</span>f}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  æ ‡å‡†å·® / Std: <span class="hljs-subst">{scores_unscaled.std().item():<span class="hljs-number">.4</span>f}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  æœ€å¤§å€¼ / Max: <span class="hljs-subst">{scores_unscaled.<span class="hljs-built_in">max</span>().item():<span class="hljs-number">.4</span>f}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  æœ€å°å€¼ / Min: <span class="hljs-subst">{scores_unscaled.<span class="hljs-built_in">min</span>().item():<span class="hljs-number">.4</span>f}</span>&quot;</span>)

<span class="hljs-comment"># ç¼©æ”¾åçš„ç‚¹ç§¯ / Scaled dot product</span>
scores_scaled = scores_unscaled / (d_k ** <span class="hljs-number">0.5</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nç¼©æ”¾åçš„åˆ†æ•° / Scaled scores:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  å‡å€¼ / Mean: <span class="hljs-subst">{scores_scaled.mean().item():<span class="hljs-number">.4</span>f}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  æ ‡å‡†å·® / Std: <span class="hljs-subst">{scores_scaled.std().item():<span class="hljs-number">.4</span>f}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  æœ€å¤§å€¼ / Max: <span class="hljs-subst">{scores_scaled.<span class="hljs-built_in">max</span>().item():<span class="hljs-number">.4</span>f}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  æœ€å°å€¼ / Min: <span class="hljs-subst">{scores_scaled.<span class="hljs-built_in">min</span>().item():<span class="hljs-number">.4</span>f}</span>&quot;</span>)

<span class="hljs-comment"># Softmax åçš„åˆ†å¸ƒå¯¹æ¯” / Compare softmax distributions</span>
softmax_unscaled = F.softmax(scores_unscaled, dim=-<span class="hljs-number">1</span>)
softmax_scaled = F.softmax(scores_scaled, dim=-<span class="hljs-number">1</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nSoftmax åˆ†å¸ƒç†µ / Softmax distribution entropy:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  ä¸ç¼©æ”¾ / Unscaled: <span class="hljs-subst">{-(softmax_unscaled * torch.log(softmax_unscaled + <span class="hljs-number">1e-9</span>)).<span class="hljs-built_in">sum</span>().item():<span class="hljs-number">.4</span>f}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  ç¼©æ”¾å / Scaled: <span class="hljs-subst">{-(softmax_scaled * torch.log(softmax_scaled + <span class="hljs-number">1e-9</span>)).<span class="hljs-built_in">sum</span>().item():<span class="hljs-number">.4</span>f}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># æ€»ç»“ / Summary</span>
<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;æ€»ç»“ / Summary&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-string">&quot;&quot;&quot;
æœ¬ç¤ºä¾‹å±•ç¤ºäº† Self-Attention çš„æ ¸å¿ƒæ¦‚å¿µ:
This example demonstrates core concepts of Self-Attention:

1. è®¡ç®—æ­¥éª¤ / Computation steps:
   - Q = X @ W_q (æŸ¥è¯¢æŠ•å½±)
   - K = X @ W_k (é”®æŠ•å½±)
   - V = X @ W_v (å€¼æŠ•å½±)
   - Scores = Q @ K^T / sqrt(d_k) (ç¼©æ”¾ç‚¹ç§¯)
   - Attention = softmax(Scores) @ V (åŠ æƒæ±‚å’Œ)

2. ç¼©æ”¾å› å­ / Scaling factor:
   - é™¤ä»¥ sqrt(d_k) é˜²æ­¢ç‚¹ç§¯è¿‡å¤§
   - ä½¿ softmax æ¢¯åº¦æ›´ç¨³å®š

3. Causal Mask:
   - è§£ç å™¨ä¸­é˜²æ­¢çœ‹åˆ°æœªæ¥ä¿¡æ¯
   - ä¸Šä¸‰è§’çŸ©é˜µå®ç°

4. å¤æ‚åº¦ / Complexity:
   - æ—¶é—´: O(n^2 * d)
   - ç©ºé—´: O(n^2)
&quot;&quot;&quot;</span>
</code></pre></div></div></div><div class="chapter"><h1>ç¬¬6ç«  FFN å‰é¦ˆç½‘ç»œå±‚</h1><h1>å‰é¦ˆç½‘ç»œå±‚ï¼ˆFFNï¼‰ç§‘æ™®ç‰ˆ</h1>
<blockquote>
<p>é¢å‘é›¶åŸºç¡€è¯»è€… çš„å‰é¦ˆç½‘ç»œå±‚å…¥é—¨æŒ‡å—</p>
</blockquote>
<h2>ä¸€å¥è¯æ¦‚æ‹¬</h2>
<p><strong>å‰é¦ˆç½‘ç»œå±‚å°±åƒä¸€ä¸ª&quot;ä¿¡æ¯åŠ å·¥å‚&quot;ï¼ŒæŠŠè¾“å…¥çš„ä¿¡æ¯è¿›è¡Œæ·±åº¦åŠ å·¥ï¼Œæå–æ›´å¤æ‚çš„ç‰¹å¾ã€‚</strong></p>
<h2>ä»ä¸€ä¸ªé—®é¢˜å¼€å§‹</h2>
<p>æƒ³è±¡ä½ åœ¨é˜…è¯»ç†è§£è€ƒè¯•ä¸­ï¼š</p>
<ol>
<li>é¦–å…ˆä½ ç†è§£æ¯ä¸ªè¯å’Œå®ƒä»¬çš„å…³ç³»ï¼ˆè¿™æ˜¯æ³¨æ„åŠ›çš„å·¥ä½œï¼‰</li>
<li>ç„¶åä½ éœ€è¦&quot;æ¶ˆåŒ–&quot;è¿™äº›ä¿¡æ¯ï¼Œæå–æ·±å±‚å«ä¹‰ï¼ˆè¿™æ˜¯å‰é¦ˆç½‘ç»œçš„å·¥ä½œï¼‰</li>
</ol>
<p><strong>å‰é¦ˆç½‘ç»œå±‚å°±æ˜¯åœ¨åšè¿™ä¸ª&quot;æ¶ˆåŒ–&quot;çš„å·¥ä½œã€‚</strong></p>
<h2>æ ¸å¿ƒæ¦‚å¿µ</h2>
<h3>ä»€ä¹ˆæ˜¯å‰é¦ˆç½‘ç»œï¼Ÿ</h3>
<p>å‰é¦ˆç½‘ç»œæ˜¯æœ€åŸºç¡€çš„ç¥ç»ç½‘ç»œç»“æ„ï¼š</p>
<ul>
<li>è¾“å…¥ â†’ å¤„ç† â†’ è¾“å‡º</li>
<li>æ²¡æœ‰å¾ªç¯ï¼Œä¿¡æ¯å•å‘æµåŠ¨</li>
</ul>
<p>åœ¨ Transformer ä¸­ï¼Œæ¯ä¸ª FFN å±‚åŒ…å«ï¼š</p>
<ol>
<li><strong>å‡ç»´</strong>ï¼šæŠŠè¾“å…¥æ‰©å±•åˆ°æ›´å¤§çš„ç©ºé—´</li>
<li><strong>æ¿€æ´»</strong>ï¼šå¼•å…¥éçº¿æ€§</li>
<li><strong>é™ç»´</strong>ï¼šå‹ç¼©å›åŸæ¥çš„ç»´åº¦</li>
</ol>
<h3>&quot;å‡ç»´-æ¿€æ´»-é™ç»´&quot;çš„è¿‡ç¨‹</h3>
<pre class="hljs"><code>è¾“å…¥ [768ç»´]
    â†“
å‡ç»´åˆ° [3072ç»´]  â† æ‰©å±• 4 å€
    â†“
æ¿€æ´»å‡½æ•° (GELU)  â† å¼•å…¥éçº¿æ€§
    â†“
é™ç»´åˆ° [768ç»´]   â† å‹ç¼©å›æ¥
    â†“
è¾“å‡º [768ç»´]
</code></pre>
<h3>ä¸ºä»€ä¹ˆè¦è¿™æ ·è®¾è®¡ï¼Ÿ</h3>
<ol>
<li><strong>å‡ç»´</strong>ï¼šåœ¨æ›´å¤§çš„ç©ºé—´ä¸­ï¼Œæ›´å®¹æ˜“æ‰¾åˆ°æœ‰æ„ä¹‰çš„ç‰¹å¾</li>
<li><strong>æ¿€æ´»</strong>ï¼šæ²¡æœ‰å®ƒï¼Œå†å¤šå±‚ä¹Ÿåªæ˜¯çº¿æ€§å˜æ¢</li>
<li><strong>é™ç»´</strong>ï¼šä¿æŒç»´åº¦ä¸€è‡´ï¼Œæ–¹ä¾¿æ®‹å·®è¿æ¥</li>
</ol>
<h2>ç±»æ¯”ç†è§£</h2>
<h3>ç±»æ¯”1ï¼šå¨æˆ¿</h3>
<ul>
<li><strong>è¾“å…¥</strong>ï¼šåŸææ–™ï¼ˆè”¬èœã€è‚‰ç±»ï¼‰</li>
<li><strong>å‡ç»´</strong>ï¼šæŠŠææ–™åˆ‡ç¢ã€åˆ†ç±»ï¼ˆæ›´å¤šçš„å°éƒ¨ä»¶ï¼‰</li>
<li><strong>æ¿€æ´»</strong>ï¼šçƒ¹é¥ªï¼ˆäº§ç”Ÿå˜åŒ–ï¼‰</li>
<li><strong>é™ç»´</strong>ï¼šè£…ç›˜ï¼ˆé‡æ–°ç»„åˆï¼‰</li>
<li><strong>è¾“å‡º</strong>ï¼šæˆå“èœè‚´</li>
</ul>
<h3>ç±»æ¯”2ï¼šå›¾ä¹¦é¦†</h3>
<ul>
<li><strong>è¾“å…¥</strong>ï¼šä¹¦ç±</li>
<li><strong>å‡ç»´</strong>ï¼šæŠŠä¹¦çš„å†…å®¹å±•å¼€æˆç« èŠ‚</li>
<li><strong>æ¿€æ´»</strong>ï¼šç†è§£å’Œåˆ†æ</li>
<li><strong>é™ç»´</strong>ï¼šæ€»ç»“æˆæ‘˜è¦</li>
<li><strong>è¾“å‡º</strong>ï¼šçŸ¥è¯†ç²¾å</li>
</ul>
<h2>Transformer ä¸­çš„ FFN</h2>
<h3>ä½ç½®</h3>
<p>åœ¨æ¯ä¸ª Transformer å±‚ä¸­ï¼š</p>
<pre class="hljs"><code>è¾“å…¥ â†’ è‡ªæ³¨æ„åŠ› â†’ Add &amp; Norm â†’ FFN â†’ Add &amp; Norm â†’ è¾“å‡º
</code></pre>
<p>FFN ç´§è·Ÿåœ¨æ³¨æ„åŠ›å±‚ä¹‹åï¼Œå¯¹æ³¨æ„åŠ›æå–çš„ä¿¡æ¯è¿›è¡Œè¿›ä¸€æ­¥å¤„ç†ã€‚</p>
<h3>å‚æ•°å æ¯”</h3>
<p>FFN å äº† Transformer çº¦ 2/3 çš„å‚æ•°é‡ï¼</p>
<ul>
<li>æ³¨æ„åŠ›å±‚ï¼š~1/3 å‚æ•°</li>
<li>FFN å±‚ï¼š~2/3 å‚æ•°</li>
</ul>
<p>å› ä¸º FFN çš„ä¸¤ä¸ªçº¿æ€§å±‚æ‰¿æ‹…äº†å¤§éƒ¨åˆ†å‚æ•°ã€‚</p>
<h2>FFN çš„å˜ä½“</h2>
<h3>æ ‡å‡† FFN</h3>
<p>æœ€åŸºæœ¬çš„å½¢å¼ï¼š</p>
<ul>
<li>å‡ç»´ + ReLU/GELU + é™ç»´</li>
</ul>
<h3>SwiGLU</h3>
<p>ç°ä»£ LLMï¼ˆå¦‚ LLaMAï¼‰ä½¿ç”¨çš„å˜ä½“ï¼š</p>
<ul>
<li>ä½¿ç”¨é—¨æ§æœºåˆ¶</li>
<li>æ€§èƒ½æ›´å¥½</li>
<li>è®¡ç®—ç•¥å¤æ‚</li>
</ul>
<h3>MoE FFN</h3>
<p>æ··åˆä¸“å®¶æ¨¡å‹çš„ FFNï¼š</p>
<ul>
<li>å¤šä¸ª&quot;ä¸“å®¶&quot;ç½‘ç»œ</li>
<li>è·¯ç”±å™¨é€‰æ‹©ä½¿ç”¨å“ªäº›ä¸“å®¶</li>
<li>å‚æ•°é‡å¤§ä½†è®¡ç®—é‡å°</li>
</ul>
<h2>æ€»ç»“</h2>
<table>
<thead>
<tr>
<th>æ¦‚å¿µ</th>
<th>é€šä¿—ç†è§£</th>
</tr>
</thead>
<tbody>
<tr>
<td>FFN</td>
<td>ä¿¡æ¯åŠ å·¥å‚</td>
</tr>
<tr>
<td>å‡ç»´</td>
<td>æŠŠä¿¡æ¯å±•å¼€</td>
</tr>
<tr>
<td>æ¿€æ´»</td>
<td>äº§ç”Ÿå˜åŒ–</td>
</tr>
<tr>
<td>é™ç»´</td>
<td>é‡æ–°å‹ç¼©</td>
</tr>
<tr>
<td>SwiGLU</td>
<td>å¸¦é—¨æ§çš„é«˜çº§ç‰ˆæœ¬</td>
</tr>
</tbody>
</table>
<h2>ä¸‹ä¸€æ­¥</h2>
<ul>
<li>æƒ³äº†è§£æ•°å­¦åŸç†ï¼Ÿé˜…è¯» <a href="advanced-guide.md">æ·±å…¥ç‰ˆ</a></li>
<li>æƒ³çœ‹ä»£ç å®ç°ï¼ŸæŸ¥çœ‹ <code>examples/</code> ç›®å½•</li>
</ul>
<h1>å‰é¦ˆç½‘ç»œå±‚ï¼ˆFFNï¼‰æ·±å…¥ç‰ˆ</h1>
<blockquote>
<p>é¢å‘æœ‰æœºå™¨å­¦ä¹ åŸºç¡€è¯»è€…çš„æŠ€æœ¯è¯¦è§£</p>
</blockquote>
<h2>æ¦‚è¿°</h2>
<p>Position-wise Feed-Forward Network æ˜¯ Transformer ä¸­çš„å…³é”®ç»„ä»¶ï¼Œè´Ÿè´£å¯¹æ¯ä¸ªä½ç½®çš„ç‰¹å¾è¿›è¡Œéçº¿æ€§å˜æ¢ã€‚æœ¬æ–‡æ·±å…¥åˆ†æ FFN çš„æ•°å­¦åŸç†ã€å˜ä½“è®¾è®¡åŠå…¶åœ¨ LLM ä¸­çš„åº”ç”¨ã€‚</p>
<h2>æ ‡å‡† FFN</h2>
<h3>æ•°å­¦å®šä¹‰</h3>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">FFN</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">GELU</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p><a id="formula-ffn-1"></a>
<a href="#formula-ffn-1-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šå…ˆå‡ç»´åˆ° <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>ï¼Œç» GELU æ¿€æ´»åå†é™ç»´å› <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> ä¸ºè¾“å…¥å‘é‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºæƒé‡çŸ©é˜µï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºåç½®ï¼›GELU ä¸ºæ¿€æ´»å‡½æ•°ã€‚</li>
<li><strong>ï¿½ï¿½è§‰/ä½œç”¨</strong>ï¼šæ‰©å±•ä¸­é—´ç»´åº¦å¢åŠ éçº¿æ€§è¡¨è¾¾èƒ½åŠ›ï¼Œæ˜¯ Transformer ä¸­æ¯ä¸ªä½ç½®çš„æ ¸å¿ƒå˜æ¢ã€‚</li>
</ul>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span><span class="mbin mtight">Ã—</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2901em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2901em;"><span></span></span></span></span></span></span><span class="mbin mtight">Ã—</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></li>
<li>é€šå¸¸ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></li>
</ul>
<h3>Position-wise å«ä¹‰</h3>
<p>å¯¹åºåˆ—ä¸­çš„æ¯ä¸ªä½ç½®ç‹¬ç«‹åº”ç”¨ç›¸åŒçš„å˜æ¢ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord text"><span class="mord">FFN</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mrel mtight">:</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord text"><span class="mord">FFN</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mrel mtight">:</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><a id="formula-ffn-2"></a>
<a href="#formula-ffn-2-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šåºåˆ—ä¸­æ¯ä¸ªä½ç½®çš„å‘é‡ç‹¬ç«‹é€šè¿‡åŒä¸€ä¸ª FFN å˜æ¢ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mrel mtight">:</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºç¬¬ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> ä¸ªä½ç½®çš„å‘é‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord text"><span class="mord">FFN</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mrel mtight">:</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºå…¶å˜æ¢åè¾“å‡ºã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šå„ä½ç½®å…±äº«å‚æ•°ä½†ç‹¬ç«‹å¤„ç†ï¼Œä¿è¯ä½ç½®é—´ä¿¡æ¯ä¸ä¸²æ‰°ã€‚</li>
</ul>
<p>ä¸åŒä½ç½®å…±äº«å‚æ•°ï¼Œä½†è®¡ç®—æ˜¯ç‹¬ç«‹çš„ã€‚</p>
<h3>å‚æ•°é‡åˆ†æ</h3>
<p>å•ä¸ª FFN å±‚çš„å‚æ•°é‡ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">F</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">F</span><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p><a id="formula-ffn-3"></a>
<a href="#formula-ffn-3-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šFFN å‚æ•°é‡ = ä¸¤ä¸ªæƒé‡çŸ©é˜µ + ä¸¤ä¸ªåç½®å‘é‡ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºè¾“å…¥/è¾“å‡ºç»´åº¦ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºä¸­é—´éšè—ç»´åº¦ï¼ˆé€šå¸¸ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord">4</span><span class="mord mathnormal">d</span></span></span></span>ï¼‰ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šå‚æ•°é‡ä¸ç»´åº¦å¹³æ–¹æˆæ­£æ¯”ï¼ŒFFN çº¦å  Transformer æ€»å‚æ•°çš„ 2/3ã€‚</li>
</ul>
<p>å¯¹äº <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">768</span></span></span></span>ï¼Œ<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3072</span></span></span></span>ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">F</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">F</span><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">768</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">3072</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">768</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3072</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em;"></span><span class="mord">4</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">722</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">432</span></span></span></span></span></p>
<p><a id="formula-ffn-4"></a>
<a href="#formula-ffn-4-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šä»£å…¥å…·ä½“æ•°å€¼è®¡ç®— BERT-Base æ¯å±‚ FFN çš„å‚æ•°é‡ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">768</span></span></span></span> ä¸ºéšè—ç»´åº¦ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3072</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">768</span></span></span></span> ä¸ºä¸­é—´ç»´åº¦ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šçº¦ 470 ä¸‡å‚æ•°ï¼Œæ˜¯ BERT-Base å‚æ•°é‡çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚</li>
</ul>
<h2>æ¿€æ´»å‡½æ•°é€‰æ‹©</h2>
<h3>ReLU</h3>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord text"><span class="mord">FFN</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.00773em;">R</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.10903em;">LU</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">max</span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">x</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p><a id="formula-ffn-5"></a>
<a href="#formula-ffn-5-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li>
<p><strong>å…¬å¼å«ä¹‰</strong>ï¼šç”¨ ReLU æ¿€æ´»ï¼Œå°†è´Ÿå€¼æˆªæ–­ä¸º 0ã€‚</p>
</li>
<li>
<p><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal">x</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºå‡ç»´åçš„ç»“æœï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">max</span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">â‹…</span><span class="mclose">)</span></span></span></span> ä¸ºé€å…ƒç´  ReLUã€‚</p>
</li>
<li>
<p><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šè®¡ç®—ç®€å•ï¼Œæ­£åŒºé—´æ¢¯åº¦ç¨³å®šï¼Œæ˜¯åŸå§‹ Transformer çš„é€‰æ‹©ã€‚</p>
</li>
<li>
<p>ç®€å•é«˜æ•ˆ</p>
</li>
<li>
<p>åŸå§‹ Transformer ä½¿ç”¨</p>
</li>
</ul>
<h3>GELU</h3>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord text"><span class="mord">FFN</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">GE</span><span class="mord mathnormal mtight" style="margin-right:0.10903em;">LU</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">GELU</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p><a id="formula-ffn-6"></a>
<a href="#formula-ffn-6-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li>
<p><strong>å…¬å¼å«ä¹‰</strong>ï¼šç”¨ GELU æ›¿ä»£ ReLUï¼Œåœ¨ 0 é™„è¿‘æ›´å¹³æ»‘ã€‚</p>
</li>
<li>
<p><strong>å˜é‡è¯´æ˜</strong>ï¼šGELU ä¸ºé«˜æ–¯è¯¯å·®çº¿æ€§å•å…ƒï¼Œä¸æ­£æ€åˆ†å¸ƒ CDF ç›¸å…³ã€‚</p>
</li>
<li>
<p><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šå¹³æ»‘è¿‡æ¸¡é¿å…ç¡¬æˆªæ–­ï¼Œè®­ç»ƒæ›´ç¨³å®šï¼ŒBERT/GPT ä½¿ç”¨ã€‚</p>
</li>
<li>
<p>å¹³æ»‘çš„ ReLU æ›¿ä»£</p>
</li>
<li>
<p>BERTã€GPT ä½¿ç”¨</p>
</li>
<li>
<p>æ€§èƒ½ç•¥å¥½</p>
</li>
</ul>
<h3>Swish/SiLU</h3>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord text"><span class="mord">FFN</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">h</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âŠ™</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">))</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p><a id="formula-ffn-7"></a>
<a href="#formula-ffn-7-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li>
<p><strong>å…¬å¼å«ä¹‰</strong>ï¼šç”¨ Swish æ¿€æ´»ï¼Œè¾“å…¥ä¸ sigmoid é—¨æ§çš„ä¹˜ç§¯ã€‚</p>
</li>
<li>
<p><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord">âŠ™</span></span></span></span> ä¸ºé€å…ƒç´ ä¹˜æ³•ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span></span></span></span> ä¸º Sigmoid å‡½æ•°ã€‚</p>
</li>
<li>
<p><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šéå•è°ƒã€æœ‰ä¸‹ç•Œæ— ä¸Šç•Œï¼Œæ·±å±‚ç½‘ç»œæ•ˆæœæ›´å¥½ã€‚</p>
</li>
<li>
<p>è‡ªé—¨æ§æ¿€æ´»</p>
</li>
<li>
<p>æŸäº›æ¨¡å‹ä½¿ç”¨</p>
</li>
</ul>
<h2>GLU å˜ä½“</h2>
<h3>GLU (Gated Linear Unit)</h3>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">GLU</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âŠ™</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span></span></span></span></span></p>
<p><a id="formula-ffn-8"></a>
<a href="#formula-ffn-8-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šä¸¤ä¸ªå¹¶è¡Œçº¿æ€§å˜æ¢ï¼Œä¸€ä¸ªä½œä¸ºé—¨æ§ä¿¡å·æ§åˆ¶å¦ä¸€ä¸ªã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span> ä¸ºä¸¤ç»„æƒé‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span></span></span></span> ä¸ºé—¨æ§å€¼ï¼ˆ0-1ï¼‰ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord">âŠ™</span></span></span></span> ä¸ºé€å…ƒç´ ä¹˜ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šé—¨æ§æœºåˆ¶è®©æ¨¡å‹è‡ªé€‚åº”é€‰æ‹©å“ªäº›ä¿¡æ¯é€šè¿‡ã€‚</li>
</ul>
<p>åŒ…å«ä¸¤ä¸ªçº¿æ€§å˜æ¢ï¼Œä¸€ä¸ªä½œä¸ºé—¨æ§ã€‚</p>
<h3>SwiGLU</h3>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">SwiGLU</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Swish</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âŠ™</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span></span></span></span></span></p>
<p><a id="formula-ffn-9"></a>
<a href="#formula-ffn-9-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šç”¨ Swish æ›¿ä»£ Sigmoid ä½œä¸ºé—¨æ§æ¿€æ´»ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Swish</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4445em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span>ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span> ä¸ºä¸¤ç»„æƒé‡ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šSwish æ¯” Sigmoid æ›´å¹³æ»‘ï¼ŒLLaMA ç­‰ç°ä»£ LLM é‡‡ç”¨ã€‚</li>
</ul>
<p>æˆ–ç­‰ä»·åœ°ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">SwiGLU</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âŠ™</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mclose">))</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âŠ™</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span></span></span></span></span></p>
<p><a id="formula-ffn-10"></a>
<a href="#formula-ffn-10-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p>LLaMA ç­‰ç°ä»£ LLM ä½¿ç”¨ã€‚</p>
<h3>GeGLU</h3>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">GeGLU</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">GELU</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âŠ™</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span></span></span></span></span></p>
<p><a id="formula-ffn-11"></a>
<a href="#formula-ffn-11-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šç”¨ GELU æ›¿ä»£ Sigmoid ä½œä¸ºé—¨æ§æ¿€æ´»ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼šGELU ä¸ºé«˜æ–¯è¯¯å·®çº¿æ€§å•å…ƒï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span> ä¸ºä¸¤ç»„æƒé‡ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šGELU çš„å¹³æ»‘æ€§å¸¦æ¥æ›´å¥½çš„è®­ç»ƒç¨³å®šæ€§ã€‚</li>
</ul>
<h3>å‚æ•°é‡å¯¹æ¯”</h3>
<table>
<thead>
<tr>
<th>å˜ä½“</th>
<th>å‚æ•°é‡</th>
<th>ç›¸æ¯”æ ‡å‡† FFN</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ ‡å‡† FFN</td>
<td><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord">4</span><span class="mord mathnormal">d</span></span></span></span></td>
<td>1x</td>
</tr>
<tr>
<td>SwiGLU</td>
<td><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.1901em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">8</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathnormal">d</span></span></span></span></td>
<td>1x</td>
</tr>
<tr>
<td>GeGLU</td>
<td><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.1901em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">8</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathnormal">d</span></span></span></span></td>
<td>1x</td>
</tr>
</tbody>
</table>
<p>ä¸ºäº†ä¿æŒç›¸åŒå‚æ•°é‡ï¼ŒGLU å˜ä½“é€šå¸¸ç¼©å°éšè—ç»´åº¦ã€‚</p>
<h2>å®ç°</h2>
<h3>æ ‡å‡† FFN (PyTorch)</h3>
<pre class="hljs"><code><span class="hljs-keyword">class</span> <span class="hljs-title class_">FFN</span>(nn.Module):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, d_model, d_ff, dropout=<span class="hljs-number">0.1</span></span>):
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-variable language_">self</span>.w1 = nn.Linear(d_model, d_ff)
        <span class="hljs-variable language_">self</span>.w2 = nn.Linear(d_ff, d_model)
        <span class="hljs-variable language_">self</span>.dropout = nn.Dropout(dropout)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.w2(<span class="hljs-variable language_">self</span>.dropout(F.gelu(<span class="hljs-variable language_">self</span>.w1(x))))
</code></pre>
<h3>SwiGLU (PyTorch)</h3>
<pre class="hljs"><code><span class="hljs-keyword">class</span> <span class="hljs-title class_">SwiGLU</span>(nn.Module):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, d_model, d_ff, dropout=<span class="hljs-number">0.1</span></span>):
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-comment"># d_ff é€šå¸¸è®¾ä¸º 2/3 * 4 * d_model â‰ˆ 2.67 * d_model</span>
        <span class="hljs-variable language_">self</span>.w1 = nn.Linear(d_model, d_ff, bias=<span class="hljs-literal">False</span>)
        <span class="hljs-variable language_">self</span>.w2 = nn.Linear(d_ff, d_model, bias=<span class="hljs-literal">False</span>)
        <span class="hljs-variable language_">self</span>.w3 = nn.Linear(d_model, d_ff, bias=<span class="hljs-literal">False</span>)  <span class="hljs-comment"># é—¨æ§åˆ†æ”¯</span>
        <span class="hljs-variable language_">self</span>.dropout = nn.Dropout(dropout)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-comment"># SwiGLU(x) = Swish(xW1) âŠ™ (xW3) * W2</span>
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.dropout(<span class="hljs-variable language_">self</span>.w2(
            F.silu(<span class="hljs-variable language_">self</span>.w1(x)) * <span class="hljs-variable language_">self</span>.w3(x)
        ))
</code></pre>
<h2>FFN çš„ä½œç”¨</h2>
<h3>1. éçº¿æ€§å˜æ¢</h3>
<p>Attention ä¸»è¦æ˜¯çº¿æ€§æ“ä½œï¼ˆåŠ æƒæ±‚å’Œï¼‰ï¼ŒFFN æä¾›éçº¿æ€§ã€‚</p>
<h3>2. çŸ¥è¯†å­˜å‚¨</h3>
<p>ç ”ç©¶è¡¨æ˜ï¼ŒFFN å±‚å­˜å‚¨äº†å¤§é‡çš„&quot;äº‹å®çŸ¥è¯†&quot;ï¼š</p>
<ul>
<li>å‰å±‚å­˜å‚¨è¯­æ³•çŸ¥è¯†</li>
<li>åå±‚å­˜å‚¨è¯­ä¹‰çŸ¥è¯†</li>
</ul>
<h3>3. ç‰¹å¾æå–</h3>
<p>åœ¨æ¯ä¸ªä½ç½®ç‹¬ç«‹æå–é«˜å±‚ç‰¹å¾ã€‚</p>
<h2>ä¸ Attention çš„å¯¹æ¯”</h2>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>Attention</th>
<th>FFN</th>
</tr>
</thead>
<tbody>
<tr>
<td>ä¿¡æ¯äº¤äº’</td>
<td>è·¨ä½ç½®</td>
<td>å•ä½ç½®</td>
</tr>
<tr>
<td>ä¸»è¦åŠŸèƒ½</td>
<td>ä¿¡æ¯èšåˆ</td>
<td>ç‰¹å¾å˜æ¢</td>
</tr>
<tr>
<td>éçº¿æ€§</td>
<td>Softmax</td>
<td>æ¿€æ´»å‡½æ•°</td>
</tr>
<tr>
<td>å‚æ•°å æ¯”</td>
<td>~1/3</td>
<td>~2/3</td>
</tr>
</tbody>
</table>
<h2>ä¼˜åŒ–ç­–ç•¥</h2>
<h3>1. å‚æ•°å…±äº«</h3>
<p>è·¨å±‚å…±äº« FFN å‚æ•°ï¼Œå‡å°‘æ¨¡å‹å¤§å°ã€‚</p>
<h3>2. åˆ†ç»„ FFN</h3>
<p>å°† FFN åˆ†æˆå¤šç»„ï¼Œå‡å°‘è®¡ç®—é‡ã€‚</p>
<h3>3. ç¨€ç– FFN</h3>
<p>åªæ¿€æ´»éƒ¨åˆ†ç¥ç»å…ƒï¼Œç±»ä¼¼ MoEã€‚</p>
<h2>å‚è€ƒæ–‡çŒ®</h2>
<ol>
<li>Vaswani et al. (2017). <em>Attention Is All You Need</em></li>
<li>Shazeer (2020). <em>GLU Variants Improve Transformer</em></li>
<li>Geva et al. (2021). <em>Transformer Feed-Forward Layers Are Key-Value Memories</em></li>
<li>Tolstikhin et al. (2021). <em>MLP-Mixer: An all-MLP Architecture for Vision</em></li>
</ol>
<h1>FFN (Feed-Forward Network) æµç¨‹å›¾è§£</h1>
<blockquote>
<p>é€šè¿‡å¯è§†åŒ–å›¾è¡¨ç†è§£å‰é¦ˆç½‘ç»œçš„å·¥ä½œæµç¨‹</p>
</blockquote>
<h2>FFN åŸºæœ¬ç»“æ„</h2>
<p><div class="mermaid">flowchart LR
    A["è¾“å…¥&lt;br/&gt;[batch, seq, d]"] --&gt; B["çº¿æ€§å±‚ Up&lt;br/&gt;W1: [d, 4d]"]
    B --&gt; C["æ¿€æ´»å‡½æ•°&lt;br/&gt;GELU/ReLU"]
    C --&gt; D["çº¿æ€§å±‚ Down&lt;br/&gt;W2: [4d, d]"]
    D --&gt; E["è¾“å‡º&lt;br/&gt;[batch, seq, d]"]

    style E fill:#c8e6c9</div></p>
<h2>FFN åœ¨ Transformer ä¸­çš„ä½ç½®</h2>
<p><div class="mermaid">flowchart TB
    A["Attention è¾“å‡º"] --&gt; B["æ®‹å·®è¿æ¥"]
    B --&gt; C["Layer Norm"]
    C --&gt; D["FFN"]
    D --&gt; E["æ®‹å·®è¿æ¥"]
    E --&gt; F["Layer Norm"]
    F --&gt; G["è¾“å‡ºåˆ°ä¸‹ä¸€å±‚"]

    style D fill:#fff9c4</div></p>
<h2>ç»´åº¦å˜åŒ–</h2>
<p><div class="mermaid">flowchart TB
    A["è¾“å…¥: 768"] --&gt; B["UpæŠ•å½±: 3072&lt;br/&gt;(4x expansion)"]
    B --&gt; C["æ¿€æ´»: 3072"]
    C --&gt; D["DownæŠ•å½±: 768"]

    E["ä¸­é—´å±‚é€šå¸¸æ˜¯è¾“å…¥çš„ 4 å€"]

    style D fill:#c8e6c9</div></p>
<h2>GELU vs ReLU</h2>
<p><div class="mermaid">flowchart TB
    subgraph ReLU
        R1["x &gt; 0 â†’ x"]
        R2["x â‰¤ 0 â†’ 0"]
        R3["ç¡¬è¾¹ç•Œ"]
    end

    subgraph GELU
        G1["å¹³æ»‘è¿‡æ¸¡"]
        G2["å¤„å¤„å¯å¾®"]
        G3["Transformer å¸¸ç”¨"]
    end

    style G3 fill:#c8e6c9</div></p>
<h2>SwiGLU ç»“æ„</h2>
<p><div class="mermaid">flowchart TB
    A["è¾“å…¥ x"] --&gt; B["W_gate * x"]
    A --&gt; C["W_up * x"]

    B --&gt; D["SiLU æ¿€æ´»&lt;br/&gt;x * sigmoid(x)"]
    D --&gt; E["é€å…ƒç´ ç›¸ä¹˜ âŠ™"]
    C --&gt; E

    E --&gt; F["W_down"]
    F --&gt; G["è¾“å‡º"]

    style G fill:#c8e6c9</div></p>
<h2>æ ‡å‡† FFN vs SwiGLU FFN</h2>
<p><div class="mermaid">flowchart TB
    subgraph æ ‡å‡†FFN
        S1["x â†’ W1 â†’ GELU â†’ W2 â†’ out"]
        S2["2 ä¸ªæƒé‡çŸ©é˜µ"]
    end

    subgraph SwiGLU
        G1["x â†’ W_g â†’ SiLU"] --&gt; G2["âŠ™ W_u(x)"]
        G2 --&gt; G3["â†’ W_d â†’ out"]
        G4["3 ä¸ªæƒé‡çŸ©é˜µ"]
    end

    style S2 fill:#bbdefb
    style G4 fill:#c8e6c9</div></p>
<h2>FFN çš„ä½œç”¨</h2>
<p><div class="mermaid">flowchart LR
    A["Attention"] --&gt; B["èšåˆä¿¡æ¯"]
    C["FFN"] --&gt; D["éçº¿æ€§å˜æ¢&lt;br/&gt;è®°å¿†/çŸ¥è¯†å­˜å‚¨"]

    B --&gt; E["Transformer å±‚"]
    D --&gt; E

    style D fill:#fff9c4</div></p>
<h2>å›¾è§£è¯´æ˜</h2>
<h3>å…³é”®å‚æ•°</h3>
<table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>è¯´æ˜</th>
<th>å…¸å‹å€¼</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ‰©å±•æ¯”</td>
<td>ä¸­é—´å±‚/è¾“å…¥ç»´åº¦</td>
<td>4x</td>
</tr>
<tr>
<td>æ¿€æ´»å‡½æ•°</td>
<td>éçº¿æ€§</td>
<td>GELU/SwiGLU</td>
</tr>
<tr>
<td>Dropout</td>
<td>æ­£åˆ™åŒ–</td>
<td>0.1</td>
</tr>
</tbody>
</table>
<h3>å‚æ•°é‡ä¼°ç®—</h3>
<p>å¯¹äºéšè—ç»´åº¦ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span>ï¼š</p>
<ul>
<li>æ ‡å‡† FFN: <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord">4</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">8</span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></li>
<li>SwiGLU: <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.2251em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">8</span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></li>
</ul>
<h3>æ¿€æ´»å‡½æ•°é€‰æ‹©</h3>
<table>
<thead>
<tr>
<th>æ¿€æ´»å‡½æ•°</th>
<th>æ¨¡å‹</th>
<th>ç‰¹ç‚¹</th>
</tr>
</thead>
<tbody>
<tr>
<td>ReLU</td>
<td>æ—©æœŸ</td>
<td>ç®€å•</td>
</tr>
<tr>
<td>GELU</td>
<td>BERT, GPT</td>
<td>å¹³æ»‘</td>
</tr>
<tr>
<td>SwiGLU</td>
<td>LLaMA</td>
<td>æ€§èƒ½æœ€å¥½</td>
</tr>
</tbody>
</table>
<div class="code-appendix page-break"><h2>é™„å½•ï¼šä»£ç ç¤ºä¾‹</h2><div class="code-file"><h3>ffn_example.py</h3><pre class="hljs"><code><span class="hljs-string">&quot;&quot;&quot;
å‰é¦ˆç½‘ç»œå±‚ç¤ºä¾‹ä»£ç  / Feed-Forward Network Layer Example Code
=============================================================

æœ¬ç¤ºä¾‹å±•ç¤º Transformer ä¸­å‰é¦ˆç½‘ç»œå±‚çš„åŸç†å’Œå®ç°ã€‚
This example demonstrates the principle and implementation of FFN in Transformer.

ä¾èµ–å®‰è£… / Dependencies:
    pip install torch matplotlib numpy
&quot;&quot;&quot;</span>

<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn
<span class="hljs-keyword">import</span> torch.nn.functional <span class="hljs-keyword">as</span> F
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 1. æ ‡å‡† FFN å®ç° / Standard FFN Implementation</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">StandardFFN</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;
    æ ‡å‡†çš„ Transformer FFN å±‚ / Standard Transformer FFN Layer

    ç»“æ„: Linear(d_model, d_ff) -&gt; Activation -&gt; Linear(d_ff, d_model)
    &quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, d_model, d_ff, activation=<span class="hljs-string">&#x27;gelu&#x27;</span>, dropout=<span class="hljs-number">0.1</span></span>):
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-variable language_">self</span>.w1 = nn.Linear(d_model, d_ff)
        <span class="hljs-variable language_">self</span>.w2 = nn.Linear(d_ff, d_model)
        <span class="hljs-variable language_">self</span>.dropout = nn.Dropout(dropout)

        <span class="hljs-comment"># é€‰æ‹©æ¿€æ´»å‡½æ•°</span>
        <span class="hljs-keyword">if</span> activation == <span class="hljs-string">&#x27;relu&#x27;</span>:
            <span class="hljs-variable language_">self</span>.activation = F.relu
        <span class="hljs-keyword">elif</span> activation == <span class="hljs-string">&#x27;gelu&#x27;</span>:
            <span class="hljs-variable language_">self</span>.activation = F.gelu
        <span class="hljs-keyword">elif</span> activation == <span class="hljs-string">&#x27;silu&#x27;</span>:
            <span class="hljs-variable language_">self</span>.activation = F.silu
        <span class="hljs-keyword">else</span>:
            <span class="hljs-variable language_">self</span>.activation = F.gelu

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-string">&quot;&quot;&quot;
        å‚æ•° / Args:
            x: [batch, seq_len, d_model]

        è¿”å› / Returns:
            output: [batch, seq_len, d_model]
        &quot;&quot;&quot;</span>
        <span class="hljs-comment"># å‡ç»´ + æ¿€æ´»</span>
        x = <span class="hljs-variable language_">self</span>.activation(<span class="hljs-variable language_">self</span>.w1(x))
        <span class="hljs-comment"># Dropout</span>
        x = <span class="hljs-variable language_">self</span>.dropout(x)
        <span class="hljs-comment"># é™ç»´</span>
        x = <span class="hljs-variable language_">self</span>.w2(x)
        <span class="hljs-keyword">return</span> x

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 2. æµ‹è¯•æ ‡å‡† FFN / Test Standard FFN</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;æ ‡å‡† FFN æµ‹è¯• / Standard FFN Test&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

torch.manual_seed(<span class="hljs-number">42</span>)

d_model = <span class="hljs-number">768</span>
d_ff = <span class="hljs-number">3072</span>  <span class="hljs-comment"># é€šå¸¸æ˜¯ d_model çš„ 4 å€</span>
batch_size, seq_len = <span class="hljs-number">2</span>, <span class="hljs-number">128</span>

<span class="hljs-comment"># åˆ›å»º FFN</span>
ffn = StandardFFN(d_model, d_ff, activation=<span class="hljs-string">&#x27;gelu&#x27;</span>)

<span class="hljs-comment"># åˆ›å»ºè¾“å…¥</span>
x = torch.randn(batch_size, seq_len, d_model)

<span class="hljs-comment"># å‰å‘ä¼ æ’­</span>
output = ffn(x)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\né…ç½® / Configuration:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  d_model: <span class="hljs-subst">{d_model}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  d_ff: <span class="hljs-subst">{d_ff}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  æ‰©å±•æ¯”ä¾‹ / Expansion ratio: <span class="hljs-subst">{d_ff / d_model}</span>x&quot;</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nè¾“å…¥å½¢çŠ¶ / Input shape: <span class="hljs-subst">{x.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;è¾“å‡ºå½¢çŠ¶ / Output shape: <span class="hljs-subst">{output.shape}</span>&quot;</span>)

<span class="hljs-comment"># å‚æ•°ç»Ÿè®¡</span>
params = <span class="hljs-built_in">sum</span>(p.numel() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> ffn.parameters())
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nå‚æ•°é‡ / Parameters: <span class="hljs-subst">{params:,}</span>&quot;</span>)

<span class="hljs-comment"># ç†è®ºå‚æ•°é‡</span>
theoretical_params = d_model * d_ff + d_ff + d_ff * d_model + d_model
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;ç†è®ºå‚æ•°é‡ / Theoretical parameters: <span class="hljs-subst">{theoretical_params:,}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 3. ä¸åŒæ¿€æ´»å‡½æ•°å¯¹æ¯” / Compare Different Activations</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ä¸åŒæ¿€æ´»å‡½æ•°å¯¹æ¯” / Activation Function Comparison&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

activations = [<span class="hljs-string">&#x27;relu&#x27;</span>, <span class="hljs-string">&#x27;gelu&#x27;</span>, <span class="hljs-string">&#x27;silu&#x27;</span>]
ffn_layers = {act: StandardFFN(d_model, d_ff, act) <span class="hljs-keyword">for</span> act <span class="hljs-keyword">in</span> activations}

<span class="hljs-comment"># å¯¹æ¯”è¾“å‡º</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nç›¸åŒè¾“å…¥ä¸‹ä¸åŒæ¿€æ´»å‡½æ•°çš„è¾“å‡ºç»Ÿè®¡:&quot;</span>)
<span class="hljs-keyword">for</span> act, layer <span class="hljs-keyword">in</span> ffn_layers.items():
    <span class="hljs-keyword">with</span> torch.no_grad():
        out = layer(x)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  <span class="hljs-subst">{act.upper()}</span>: mean=<span class="hljs-subst">{out.mean().item():<span class="hljs-number">.4</span>f}</span>, std=<span class="hljs-subst">{out.std().item():<span class="hljs-number">.4</span>f}</span>&quot;</span>)

<span class="hljs-comment"># å¯è§†åŒ–æ¿€æ´»å‡½æ•°</span>
fig, axes = plt.subplots(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, figsize=(<span class="hljs-number">15</span>, <span class="hljs-number">4</span>))

x_vis = torch.linspace(-<span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">100</span>)

<span class="hljs-keyword">for</span> ax, (act_name, act_fn) <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(axes, [
    (<span class="hljs-string">&#x27;ReLU&#x27;</span>, F.relu),
    (<span class="hljs-string">&#x27;GELU&#x27;</span>, F.gelu),
    (<span class="hljs-string">&#x27;SiLU/Swish&#x27;</span>, F.silu)
]):
    y = act_fn(x_vis).numpy()
    ax.plot(x_vis.numpy(), y, linewidth=<span class="hljs-number">2</span>)
    ax.set_title(act_name, fontsize=<span class="hljs-number">14</span>)
    ax.set_xlabel(<span class="hljs-string">&#x27;x&#x27;</span>)
    ax.set_ylabel(<span class="hljs-string">&#x27;f(x)&#x27;</span>)
    ax.grid(<span class="hljs-literal">True</span>, alpha=<span class="hljs-number">0.3</span>)
    ax.axhline(y=<span class="hljs-number">0</span>, color=<span class="hljs-string">&#x27;k&#x27;</span>, linestyle=<span class="hljs-string">&#x27;--&#x27;</span>, alpha=<span class="hljs-number">0.3</span>)
    ax.axvline(x=<span class="hljs-number">0</span>, color=<span class="hljs-string">&#x27;k&#x27;</span>, linestyle=<span class="hljs-string">&#x27;--&#x27;</span>, alpha=<span class="hljs-number">0.3</span>)

plt.tight_layout()
plt.savefig(<span class="hljs-string">&#x27;/tmp/ffn_activations.png&#x27;</span>, dpi=<span class="hljs-number">150</span>, bbox_inches=<span class="hljs-string">&#x27;tight&#x27;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\næ¿€æ´»å‡½æ•°å›¾åƒå·²ä¿å­˜è‡³ / Image saved to: /tmp/ffn_activations.png&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 4. FFN ä¸­çš„ä¿¡æ¯æµåˆ†æ / Information Flow Analysis in FFN</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;FFN ä¿¡æ¯æµåˆ†æ / FFN Information Flow Analysis&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">FFNWithAnalysis</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;å¸¦ä¸­é—´å±‚åˆ†æçš„ FFN / FFN with intermediate analysis&quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, d_model, d_ff</span>):
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-variable language_">self</span>.w1 = nn.Linear(d_model, d_ff)
        <span class="hljs-variable language_">self</span>.w2 = nn.Linear(d_ff, d_model)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-comment"># ä¿å­˜ä¸­é—´ç»“æœ</span>
        <span class="hljs-variable language_">self</span>.<span class="hljs-built_in">input</span> = x
        <span class="hljs-variable language_">self</span>.hidden = F.gelu(<span class="hljs-variable language_">self</span>.w1(x))
        <span class="hljs-variable language_">self</span>.output = <span class="hljs-variable language_">self</span>.w2(<span class="hljs-variable language_">self</span>.hidden)
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.output

ffn_analysis = FFNWithAnalysis(d_model, d_ff)
ffn_analysis.<span class="hljs-built_in">eval</span>()

<span class="hljs-keyword">with</span> torch.no_grad():
    out = ffn_analysis(x)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nå„å±‚å¼ é‡ç»Ÿè®¡:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  è¾“å…¥: shape=<span class="hljs-subst">{ffn_analysis.<span class="hljs-built_in">input</span>.shape}</span>, &quot;</span>
      <span class="hljs-string">f&quot;mean=<span class="hljs-subst">{ffn_analysis.<span class="hljs-built_in">input</span>.mean().item():<span class="hljs-number">.4</span>f}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  éšè—å±‚: shape=<span class="hljs-subst">{ffn_analysis.hidden.shape}</span>, &quot;</span>
      <span class="hljs-string">f&quot;mean=<span class="hljs-subst">{ffn_analysis.hidden.mean().item():<span class="hljs-number">.4</span>f}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  è¾“å‡º: shape=<span class="hljs-subst">{ffn_analysis.output.shape}</span>, &quot;</span>
      <span class="hljs-string">f&quot;mean=<span class="hljs-subst">{ffn_analysis.output.mean().item():<span class="hljs-number">.4</span>f}</span>&quot;</span>)

<span class="hljs-comment"># åˆ†æéšè—å±‚æ¿€æ´»åˆ†å¸ƒ</span>
hidden_flat = ffn_analysis.hidden.flatten().numpy()
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\néšè—å±‚æ¿€æ´»åˆ†å¸ƒ:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  é›¶å€¼æ¯”ä¾‹ / Zero ratio: <span class="hljs-subst">{(hidden_flat == <span class="hljs-number">0</span>).mean():<span class="hljs-number">.2</span>%}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  å°äº0.1çš„æ¯”ä¾‹ / &lt;0.1 ratio: <span class="hljs-subst">{(np.<span class="hljs-built_in">abs</span>(hidden_flat) &lt; <span class="hljs-number">0.1</span>).mean():<span class="hljs-number">.2</span>%}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 5. FFN åœ¨ Transformer ä¸­çš„ä½ç½® / FFN Position in Transformer</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;FFN åœ¨ Transformer ä¸­ / FFN in Transformer&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">TransformerBlockWithFFN</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;å±•ç¤º FFN åœ¨ Transformer ä¸­çš„ä½ç½®&quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, d_model, num_heads, d_ff, dropout=<span class="hljs-number">0.1</span></span>):
        <span class="hljs-built_in">super</span>().__init__()

        <span class="hljs-comment"># Attention éƒ¨åˆ†</span>
        <span class="hljs-variable language_">self</span>.norm1 = nn.LayerNorm(d_model)
        <span class="hljs-variable language_">self</span>.attention = nn.MultiheadAttention(d_model, num_heads, batch_first=<span class="hljs-literal">True</span>)

        <span class="hljs-comment"># FFN éƒ¨åˆ†</span>
        <span class="hljs-variable language_">self</span>.norm2 = nn.LayerNorm(d_model)
        <span class="hljs-variable language_">self</span>.ffn = StandardFFN(d_model, d_ff, dropout=dropout)

        <span class="hljs-variable language_">self</span>.dropout = nn.Dropout(dropout)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-comment"># Attention with Pre-LN</span>
        residual = x
        x = <span class="hljs-variable language_">self</span>.norm1(x)
        x, _ = <span class="hljs-variable language_">self</span>.attention(x, x, x)
        x = residual + <span class="hljs-variable language_">self</span>.dropout(x)

        <span class="hljs-comment"># FFN with Pre-LN</span>
        residual = x
        x = <span class="hljs-variable language_">self</span>.norm2(x)
        x = <span class="hljs-variable language_">self</span>.ffn(x)
        x = residual + <span class="hljs-variable language_">self</span>.dropout(x)

        <span class="hljs-keyword">return</span> x

<span class="hljs-comment"># åˆ›å»ºå¹¶æµ‹è¯•</span>
block = TransformerBlockWithFFN(d_model=<span class="hljs-number">256</span>, num_heads=<span class="hljs-number">8</span>, d_ff=<span class="hljs-number">1024</span>)
x_test = torch.randn(<span class="hljs-number">2</span>, <span class="hljs-number">64</span>, <span class="hljs-number">256</span>)
out = block(x_test)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nTransformer Block:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  è¾“å…¥å½¢çŠ¶: <span class="hljs-subst">{x_test.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  è¾“å‡ºå½¢çŠ¶: <span class="hljs-subst">{out.shape}</span>&quot;</span>)

<span class="hljs-comment"># å‚æ•°åˆ†å¸ƒ</span>
attn_params = <span class="hljs-built_in">sum</span>(p.numel() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> block.attention.parameters())
ffn_params = <span class="hljs-built_in">sum</span>(p.numel() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> block.ffn.parameters())
total_params = attn_params + ffn_params

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nå‚æ•°åˆ†å¸ƒ:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  Attention: <span class="hljs-subst">{attn_params:,}</span> (<span class="hljs-subst">{attn_params/total_params:<span class="hljs-number">.1</span>%}</span>)&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  FFN: <span class="hljs-subst">{ffn_params:,}</span> (<span class="hljs-subst">{ffn_params/total_params:<span class="hljs-number">.1</span>%}</span>)&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 6. åç½®é¡¹çš„å½±å“ / Effect of Bias Terms</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;åç½®é¡¹å½±å“åˆ†æ / Bias Term Analysis&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">FFNWithBias</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;å¸¦åç½®çš„ FFN / FFN with bias&quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, d_model, d_ff, use_bias=<span class="hljs-literal">True</span></span>):
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-variable language_">self</span>.w1 = nn.Linear(d_model, d_ff, bias=use_bias)
        <span class="hljs-variable language_">self</span>.w2 = nn.Linear(d_ff, d_model, bias=use_bias)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.w2(F.gelu(<span class="hljs-variable language_">self</span>.w1(x)))

<span class="hljs-keyword">class</span> <span class="hljs-title class_">FFNWithoutBias</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;ä¸å¸¦åç½®çš„ FFN / FFN without bias&quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, d_model, d_ff</span>):
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-variable language_">self</span>.w1 = nn.Linear(d_model, d_ff, bias=<span class="hljs-literal">False</span>)
        <span class="hljs-variable language_">self</span>.w2 = nn.Linear(d_ff, d_model, bias=<span class="hljs-literal">False</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.w2(F.gelu(<span class="hljs-variable language_">self</span>.w1(x)))

ffn_with_bias = FFNWithBias(<span class="hljs-number">256</span>, <span class="hljs-number">1024</span>)
ffn_no_bias = FFNWithoutBias(<span class="hljs-number">256</span>, <span class="hljs-number">1024</span>)

params_with_bias = <span class="hljs-built_in">sum</span>(p.numel() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> ffn_with_bias.parameters())
params_no_bias = <span class="hljs-built_in">sum</span>(p.numel() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> ffn_no_bias.parameters())

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nå‚æ•°é‡å¯¹æ¯”:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  æœ‰åç½®: <span class="hljs-subst">{params_with_bias:,}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  æ— åç½®: <span class="hljs-subst">{params_no_bias:,}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  å·®å¼‚: <span class="hljs-subst">{params_with_bias - params_no_bias:,}</span> (åç½®å‚æ•°)&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># æ€»ç»“ / Summary</span>
<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;æ€»ç»“ / Summary&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-string">&quot;&quot;&quot;
æœ¬ç¤ºä¾‹å±•ç¤ºäº† FFN çš„æ ¸å¿ƒæ¦‚å¿µ:
This example demonstrates core concepts of FFN:

1. ç»“æ„ / Structure:
   - å‡ç»´: d_model -&gt; d_ff (é€šå¸¸æ˜¯ 4 å€)
   - æ¿€æ´»: GELU/ReLU/SiLU
   - é™ç»´: d_ff -&gt; d_model

2. å‚æ•°é‡ / Parameters:
   - P â‰ˆ 2 * d_model * d_ff
   - çº¦å  Transformer å‚æ•°çš„ 2/3

3. ä½œç”¨ / Function:
   - æä¾›éçº¿æ€§å˜æ¢
   - å­˜å‚¨çŸ¥è¯†
   - ç‰¹å¾æå–

4. å˜ä½“ / Variants:
   - æ ‡å‡† FFN: Linear -&gt; Activation -&gt; Linear
   - SwiGLU: é—¨æ§æœºåˆ¶
   - GeGLU: GELU é—¨æ§

5. ä¼˜åŒ– / Optimization:
   - å¯ä»¥ç§»é™¤åç½®å‡å°‘å‚æ•°
   - åˆ†ç»„è®¡ç®—å‡å°‘è®¡ç®—é‡
&quot;&quot;&quot;</span>
</code></pre></div><div class="code-file"><h3>swiglu_example.py</h3><pre class="hljs"><code><span class="hljs-string">&quot;&quot;&quot;
SwiGLU ç¤ºä¾‹ä»£ç  / SwiGLU Example Code
=====================================

æœ¬ç¤ºä¾‹å±•ç¤º SwiGLU æ¿€æ´»å‡½æ•°åŠå…¶åœ¨å‰é¦ˆç½‘ç»œä¸­çš„åº”ç”¨ã€‚
This example demonstrates SwiGLU activation and its application in FFN.

SwiGLU æ˜¯ LLaMA ç­‰ç°ä»£ LLM ä½¿ç”¨çš„ FFN æ¿€æ´»å‡½æ•°ã€‚
SwiGLU is the FFN activation used in modern LLMs like LLaMA.

ä¾èµ–å®‰è£… / Dependencies:
    pip install torch matplotlib numpy
&quot;&quot;&quot;</span>

<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn
<span class="hljs-keyword">import</span> torch.nn.functional <span class="hljs-keyword">as</span> F
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 1. GLU (Gated Linear Unit) åŸºç¡€ / GLU Basics</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;GLU (Gated Linear Unit) åŸºç¡€ / GLU Basics&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&quot;&quot;
GLU çš„æ•°å­¦å®šä¹‰:
GLU(x) = (xW) âŠ™ Ïƒ(xV)

å…¶ä¸­:
- W å’Œ V æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„çº¿æ€§å˜æ¢
- Ïƒ æ˜¯ sigmoid å‡½æ•°
- âŠ™ æ˜¯é€å…ƒç´ ä¹˜æ³•

é—¨æ§æœºåˆ¶å…è®¸æ¨¡å‹é€‰æ‹©æ€§åœ°ä¼ é€’ä¿¡æ¯ã€‚
&quot;&quot;&quot;</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">GLU</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;åŸºç¡€ GLU å®ç°&quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, d_model, d_ff</span>):
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-variable language_">self</span>.W = nn.Linear(d_model, d_ff, bias=<span class="hljs-literal">False</span>)
        <span class="hljs-variable language_">self</span>.V = nn.Linear(d_model, d_ff, bias=<span class="hljs-literal">False</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.W(x) * torch.sigmoid(<span class="hljs-variable language_">self</span>.V(x))

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 2. SwiGLU å®šä¹‰ / SwiGLU Definition</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;SwiGLU å®šä¹‰ / SwiGLU Definition&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&quot;&quot;
SwiGLU çš„æ•°å­¦å®šä¹‰:
SwiGLU(x) = Swish(xW) âŠ™ (xV)
          = (xW âŠ™ Ïƒ(Î²xW)) âŠ™ (xV)  (å½“ Î²=1 æ—¶)

å…¶ä¸­:
- Swish(x) = x âŠ™ Ïƒ(x) = x * sigmoid(x)
- ä¹Ÿç§°ä¸º SiLU (Sigmoid Linear Unit)

SwiGLU çš„ç‰¹ç‚¹:
1. ç»“åˆäº† Swish çš„å¹³æ»‘æ€§å’Œ GLU çš„é—¨æ§æœºåˆ¶
2. åœ¨ LLM ä¸­è¡¨ç°ä¼˜äºæ ‡å‡† FFN
3. è¢« LLaMAã€PaLM ç­‰æ¨¡å‹é‡‡ç”¨
&quot;&quot;&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 3. SwiGLU å®ç° / SwiGLU Implementation</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SwiGLUFFN</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;
    ä½¿ç”¨ SwiGLU çš„ FFN å±‚ / FFN Layer with SwiGLU

    å‚æ•°è®¾ç½®ï¼ˆä¸ºä¿æŒä¸æ ‡å‡† FFN ç›¸åŒå‚æ•°é‡ï¼‰:
    d_ff = 2/3 * 4 * d_model â‰ˆ 2.67 * d_model

    æˆ–ç®€åŒ–ä¸º: d_ff = 8/3 * d_model
    &quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, d_model, d_ff=<span class="hljs-literal">None</span>, dropout=<span class="hljs-number">0.1</span></span>):
        <span class="hljs-built_in">super</span>().__init__()

        <span class="hljs-comment"># å¦‚æœæœªæŒ‡å®š d_ffï¼Œä½¿ç”¨ 8/3 * d_model ä¿æŒå‚æ•°é‡ç›¸è¿‘</span>
        <span class="hljs-keyword">if</span> d_ff <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            d_ff = <span class="hljs-built_in">int</span>(<span class="hljs-number">8</span> / <span class="hljs-number">3</span> * d_model)

        <span class="hljs-variable language_">self</span>.d_model = d_model
        <span class="hljs-variable language_">self</span>.d_ff = d_ff

        <span class="hljs-comment"># ä¸‰ä¸ªçº¿æ€§å±‚ï¼ˆç›¸æ¯”æ ‡å‡† FFN å¤šä¸€ä¸ªï¼‰</span>
        <span class="hljs-variable language_">self</span>.w1 = nn.Linear(d_model, d_ff, bias=<span class="hljs-literal">False</span>)  <span class="hljs-comment"># ä¸»å˜æ¢</span>
        <span class="hljs-variable language_">self</span>.w2 = nn.Linear(d_ff, d_model, bias=<span class="hljs-literal">False</span>)  <span class="hljs-comment"># è¾“å‡ºæŠ•å½±</span>
        <span class="hljs-variable language_">self</span>.w3 = nn.Linear(d_model, d_ff, bias=<span class="hljs-literal">False</span>)  <span class="hljs-comment"># é—¨æ§åˆ†æ”¯</span>

        <span class="hljs-variable language_">self</span>.dropout = nn.Dropout(dropout)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-string">&quot;&quot;&quot;
        SwiGLU(x) = Swish(xW1) âŠ™ (xW3) @ W2
                  = (silu(xW1) * xW3) @ W2
        &quot;&quot;&quot;</span>
        <span class="hljs-comment"># é—¨æ§æœºåˆ¶: Swish(xW1) * xW3</span>
        hidden = F.silu(<span class="hljs-variable language_">self</span>.w1(x)) * <span class="hljs-variable language_">self</span>.w3(x)
        <span class="hljs-comment"># Dropout</span>
        hidden = <span class="hljs-variable language_">self</span>.dropout(hidden)
        <span class="hljs-comment"># è¾“å‡ºæŠ•å½±</span>
        output = <span class="hljs-variable language_">self</span>.w2(hidden)
        <span class="hljs-keyword">return</span> output

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 4. æµ‹è¯• SwiGLU / Test SwiGLU</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;SwiGLU æµ‹è¯• / SwiGLU Test&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

torch.manual_seed(<span class="hljs-number">42</span>)

d_model = <span class="hljs-number">768</span>
d_ff_standard = <span class="hljs-number">3072</span>  <span class="hljs-comment"># æ ‡å‡† FFN çš„ d_ff</span>

<span class="hljs-comment"># åˆ›å»ºæ¨¡å‹</span>
standard_ffn = nn.Sequential(
    nn.Linear(d_model, d_ff_standard),
    nn.GELU(),
    nn.Linear(d_ff_standard, d_model)
)

swiglu_ffn = SwiGLUFFN(d_model)  <span class="hljs-comment"># è‡ªåŠ¨è®¡ç®— d_ff</span>

<span class="hljs-comment"># åˆ›å»ºè¾“å…¥</span>
x = torch.randn(<span class="hljs-number">2</span>, <span class="hljs-number">128</span>, d_model)

<span class="hljs-comment"># å‰å‘ä¼ æ’­</span>
output_standard = standard_ffn(x)
output_swiglu = swiglu_ffn(x)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nè¾“å…¥å½¢çŠ¶ / Input shape: <span class="hljs-subst">{x.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;æ ‡å‡† FFN è¾“å‡ºå½¢çŠ¶ / Standard FFN output shape: <span class="hljs-subst">{output_standard.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;SwiGLU FFN è¾“å‡ºå½¢çŠ¶ / SwiGLU FFN output shape: <span class="hljs-subst">{output_swiglu.shape}</span>&quot;</span>)

<span class="hljs-comment"># å‚æ•°é‡å¯¹æ¯”</span>
params_standard = <span class="hljs-built_in">sum</span>(p.numel() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> standard_ffn.parameters())
params_swiglu = <span class="hljs-built_in">sum</span>(p.numel() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> swiglu_ffn.parameters())

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nå‚æ•°é‡å¯¹æ¯” / Parameter Comparison:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  æ ‡å‡† FFN (d_ff=3072): <span class="hljs-subst">{params_standard:,}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  SwiGLU FFN (d_ff=<span class="hljs-subst">{swiglu_ffn.d_ff}</span>): <span class="hljs-subst">{params_swiglu:,}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  æ¯”ä¾‹ / Ratio: <span class="hljs-subst">{params_swiglu/params_standard:<span class="hljs-number">.2</span>f}</span>x&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 5. ä¸åŒ GLU å˜ä½“å¯¹æ¯” / Compare Different GLU Variants</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;GLU å˜ä½“å¯¹æ¯” / GLU Variants Comparison&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ReGLUFFN</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;ReGLU: ReLU + GLU&quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, d_model, d_ff</span>):
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-variable language_">self</span>.w1 = nn.Linear(d_model, d_ff, bias=<span class="hljs-literal">False</span>)
        <span class="hljs-variable language_">self</span>.w2 = nn.Linear(d_ff, d_model, bias=<span class="hljs-literal">False</span>)
        <span class="hljs-variable language_">self</span>.w3 = nn.Linear(d_model, d_ff, bias=<span class="hljs-literal">False</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.w2(F.relu(<span class="hljs-variable language_">self</span>.w1(x)) * <span class="hljs-variable language_">self</span>.w3(x))

<span class="hljs-keyword">class</span> <span class="hljs-title class_">GeGLUFFN</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;GeGLU: GELU + GLU&quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, d_model, d_ff</span>):
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-variable language_">self</span>.w1 = nn.Linear(d_model, d_ff, bias=<span class="hljs-literal">False</span>)
        <span class="hljs-variable language_">self</span>.w2 = nn.Linear(d_ff, d_model, bias=<span class="hljs-literal">False</span>)
        <span class="hljs-variable language_">self</span>.w3 = nn.Linear(d_model, d_ff, bias=<span class="hljs-literal">False</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.w2(F.gelu(<span class="hljs-variable language_">self</span>.w1(x)) * <span class="hljs-variable language_">self</span>.w3(x))

<span class="hljs-comment"># åˆ›å»ºä¸åŒå˜ä½“</span>
d_ff_variants = <span class="hljs-built_in">int</span>(<span class="hljs-number">8</span>/<span class="hljs-number">3</span> * d_model)
variants = {
    <span class="hljs-string">&#x27;ReGLU&#x27;</span>: ReGLUFFN(d_model, d_ff_variants),
    <span class="hljs-string">&#x27;GeGLU&#x27;</span>: GeGLUFFN(d_model, d_ff_variants),
    <span class="hljs-string">&#x27;SwiGLU&#x27;</span>: SwiGLUFFN(d_model)
}

<span class="hljs-comment"># å¯¹æ¯”è¾“å‡º</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nå„å˜ä½“è¾“å‡ºç»Ÿè®¡ (ç›¸åŒè¾“å…¥):&quot;</span>)
<span class="hljs-keyword">for</span> name, model <span class="hljs-keyword">in</span> variants.items():
    <span class="hljs-keyword">with</span> torch.no_grad():
        out = model(x)
    params = <span class="hljs-built_in">sum</span>(p.numel() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> model.parameters())
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  <span class="hljs-subst">{name}</span>: mean=<span class="hljs-subst">{out.mean().item():<span class="hljs-number">.4</span>f}</span>, std=<span class="hljs-subst">{out.std().item():<span class="hljs-number">.4</span>f}</span>, params=<span class="hljs-subst">{params:,}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 6. å¯è§†åŒ–é—¨æ§æœºåˆ¶ / Visualize Gating Mechanism</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;é—¨æ§æœºåˆ¶å¯è§†åŒ– / Gating Mechanism Visualization&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-comment"># å¯è§†åŒ– Swish å’Œ Sigmoid å‡½æ•°</span>
fig, axes = plt.subplots(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, figsize=(<span class="hljs-number">15</span>, <span class="hljs-number">4</span>))

x_vis = torch.linspace(-<span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">100</span>)

<span class="hljs-comment"># 6.1 Sigmoid</span>
ax1 = axes[<span class="hljs-number">0</span>]
ax1.plot(x_vis.numpy(), torch.sigmoid(x_vis).numpy(), <span class="hljs-string">&#x27;b-&#x27;</span>, linewidth=<span class="hljs-number">2</span>, label=<span class="hljs-string">&#x27;Sigmoid&#x27;</span>)
ax1.set_title(<span class="hljs-string">&#x27;Sigmoid Function&#x27;</span>, fontsize=<span class="hljs-number">12</span>)
ax1.set_xlabel(<span class="hljs-string">&#x27;x&#x27;</span>)
ax1.set_ylabel(<span class="hljs-string">&#x27;Ïƒ(x)&#x27;</span>)
ax1.grid(<span class="hljs-literal">True</span>, alpha=<span class="hljs-number">0.3</span>)
ax1.legend()

<span class="hljs-comment"># 6.2 Swish/SiLU</span>
ax2 = axes[<span class="hljs-number">1</span>]
ax2.plot(x_vis.numpy(), F.silu(x_vis).numpy(), <span class="hljs-string">&#x27;r-&#x27;</span>, linewidth=<span class="hljs-number">2</span>, label=<span class="hljs-string">&#x27;Swish/SiLU&#x27;</span>)
ax2.set_title(<span class="hljs-string">&#x27;Swish/SiLU Function&#x27;</span>, fontsize=<span class="hljs-number">12</span>)
ax2.set_xlabel(<span class="hljs-string">&#x27;x&#x27;</span>)
ax2.set_ylabel(<span class="hljs-string">&#x27;xÂ·Ïƒ(x)&#x27;</span>)
ax2.grid(<span class="hljs-literal">True</span>, alpha=<span class="hljs-number">0.3</span>)
ax2.legend()

<span class="hljs-comment"># 6.3 é—¨æ§æ•ˆæœ</span>
ax3 = axes[<span class="hljs-number">2</span>]
<span class="hljs-comment"># æ¨¡æ‹Ÿé—¨æ§: value * gate</span>
value = torch.sin(x_vis * <span class="hljs-number">2</span>)  <span class="hljs-comment"># å€¼å‡½æ•°</span>
gate = torch.sigmoid(x_vis)   <span class="hljs-comment"># é—¨æ§å‡½æ•°</span>
gated = value * gate          <span class="hljs-comment"># é—¨æ§å</span>

ax3.plot(x_vis.numpy(), value.numpy(), <span class="hljs-string">&#x27;g--&#x27;</span>, linewidth=<span class="hljs-number">1.5</span>, label=<span class="hljs-string">&#x27;Value&#x27;</span>, alpha=<span class="hljs-number">0.7</span>)
ax3.plot(x_vis.numpy(), gate.numpy(), <span class="hljs-string">&#x27;b--&#x27;</span>, linewidth=<span class="hljs-number">1.5</span>, label=<span class="hljs-string">&#x27;Gate&#x27;</span>, alpha=<span class="hljs-number">0.7</span>)
ax3.plot(x_vis.numpy(), gated.numpy(), <span class="hljs-string">&#x27;r-&#x27;</span>, linewidth=<span class="hljs-number">2</span>, label=<span class="hljs-string">&#x27;Gated Output&#x27;</span>)
ax3.set_title(<span class="hljs-string">&#x27;Gating Effect&#x27;</span>, fontsize=<span class="hljs-number">12</span>)
ax3.set_xlabel(<span class="hljs-string">&#x27;x&#x27;</span>)
ax3.set_ylabel(<span class="hljs-string">&#x27;Output&#x27;</span>)
ax3.grid(<span class="hljs-literal">True</span>, alpha=<span class="hljs-number">0.3</span>)
ax3.legend()

plt.tight_layout()
plt.savefig(<span class="hljs-string">&#x27;/tmp/swiglu_gating.png&#x27;</span>, dpi=<span class="hljs-number">150</span>, bbox_inches=<span class="hljs-string">&#x27;tight&#x27;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\né—¨æ§æœºåˆ¶å›¾åƒå·²ä¿å­˜è‡³ / Image saved to: /tmp/swiglu_gating.png&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 7. LLaMA é£æ ¼çš„ FFN / LLaMA-style FFN</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;LLaMA é£æ ¼ FFN / LLaMA-style FFN&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">LLaMAFFN</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;
    LLaMA çš„ FFN å®ç° / LLaMA&#x27;s FFN Implementation

    ç‰¹ç‚¹:
    1. ä½¿ç”¨ SwiGLU æ¿€æ´»
    2. æ— åç½®é¡¹
    3. d_ff = 2/3 * 4 * d_model (çº¦åŒ–ä»¥ä¿æŒå‚æ•°é‡)
    &quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, dim, hidden_dim=<span class="hljs-literal">None</span>, multiple_of=<span class="hljs-number">256</span>, dropout=<span class="hljs-number">0.0</span></span>):
        <span class="hljs-built_in">super</span>().__init__()

        <span class="hljs-comment"># LLaMA çš„ hidden_dim è®¡ç®—æ–¹å¼</span>
        <span class="hljs-keyword">if</span> hidden_dim <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            hidden_dim = <span class="hljs-built_in">int</span>(<span class="hljs-number">2</span> * <span class="hljs-number">4</span> * dim / <span class="hljs-number">3</span>)
            <span class="hljs-comment"># å‘ä¸Šå–æ•´åˆ° multiple_of çš„å€æ•°</span>
            hidden_dim = multiple_of * ((hidden_dim + multiple_of - <span class="hljs-number">1</span>) // multiple_of)

        <span class="hljs-variable language_">self</span>.w1 = nn.Linear(dim, hidden_dim, bias=<span class="hljs-literal">False</span>)
        <span class="hljs-variable language_">self</span>.w2 = nn.Linear(hidden_dim, dim, bias=<span class="hljs-literal">False</span>)
        <span class="hljs-variable language_">self</span>.w3 = nn.Linear(dim, hidden_dim, bias=<span class="hljs-literal">False</span>)
        <span class="hljs-variable language_">self</span>.dropout = nn.Dropout(dropout)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.dropout(<span class="hljs-variable language_">self</span>.w2(F.silu(<span class="hljs-variable language_">self</span>.w1(x)) * <span class="hljs-variable language_">self</span>.w3(x)))

<span class="hljs-comment"># LLaMA-7B çš„é…ç½®</span>
llama_ffn = LLaMAFFN(dim=<span class="hljs-number">4096</span>)  <span class="hljs-comment"># LLaMA-7B çš„ d_model</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nLLaMA-7B FFN é…ç½®:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  d_model: 4096&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  hidden_dim: <span class="hljs-subst">{llama_ffn.w1.out_features}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  å‚æ•°é‡: <span class="hljs-subst">{<span class="hljs-built_in">sum</span>(p.numel() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> llama_ffn.parameters()):,}</span>&quot;</span>)

<span class="hljs-comment"># æµ‹è¯•</span>
x_llama = torch.randn(<span class="hljs-number">1</span>, <span class="hljs-number">100</span>, <span class="hljs-number">4096</span>)
out_llama = llama_ffn(x_llama)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  è¾“å…¥å½¢çŠ¶: <span class="hljs-subst">{x_llama.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  è¾“å‡ºå½¢çŠ¶: <span class="hljs-subst">{out_llama.shape}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># æ€»ç»“ / Summary</span>
<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;æ€»ç»“ / Summary&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-string">&quot;&quot;&quot;
æœ¬ç¤ºä¾‹å±•ç¤ºäº† SwiGLU çš„æ ¸å¿ƒæ¦‚å¿µ:
This example demonstrates core concepts of SwiGLU:

1. GLU åŸºç¡€ / GLU Basics:
   GLU(x) = (xW) âŠ™ Ïƒ(xV)
   é—¨æ§æœºåˆ¶é€‰æ‹©æ€§ä¼ é€’ä¿¡æ¯

2. SwiGLU å…¬å¼ / SwiGLU Formula:
   SwiGLU(x) = Swish(xW1) âŠ™ (xW3) @ W2
             = (silu(xW1) * xW3) @ W2

3. ç›¸æ¯”æ ‡å‡† FFN:
   - å¤šä¸€ä¸ªçº¿æ€§å˜æ¢ï¼ˆ3ä¸ª vs 2ä¸ªï¼‰
   - ä½¿ç”¨é—¨æ§æœºåˆ¶
   - è°ƒæ•´ d_ff ä¿æŒå‚æ•°é‡ç›¸è¿‘

4. GLU å˜ä½“ / GLU Variants:
   - ReGLU: ReLU + GLU
   - GeGLU: GELU + GLU
   - SwiGLU: Swish + GLU (LLaMA ä½¿ç”¨)

5. å®é™…åº”ç”¨:
   - LLaMA
   - PaLM
   - å…¶ä»–ç°ä»£ LLM
&quot;&quot;&quot;</span>
</code></pre></div></div></div><div class="chapter"><h1>ç¬¬7ç«  Encoder ç¼–ç å™¨</h1><h1>ç¼–ç å™¨ï¼ˆEncoderï¼‰ç§‘æ™®ç‰ˆ</h1>
<blockquote>
<p>é¢å‘é›¶åŸºç¡€è¯»è€…çš„ç¼–ç å™¨å…¥é—¨æŒ‡å—</p>
</blockquote>
<h2>ä¸€å¥è¯æ¦‚æ‹¬</h2>
<p><strong>ç¼–ç å™¨å°±åƒä¸€ä¸ª&quot;é˜…è¯»ç†è§£ä¸“å®¶&quot;ï¼ŒæŠŠä¸€æ®µæ–‡å­—&quot;è¯»æ‡‚&quot;å¹¶è½¬åŒ–ä¸ºè®¡ç®—æœºèƒ½ç†è§£çš„æ·±å±‚è¡¨ç¤ºã€‚</strong></p>
<h2>ä»ä¸€ä¸ªé—®é¢˜å¼€å§‹</h2>
<p>æƒ³è±¡ä½ è¦å‘ä¸€ä¸ªä¸æ‡‚è‹±è¯­çš„æœ‹å‹è§£é‡Šä¸€ç¯‡æ–‡ç« çš„å†…å®¹ï¼š</p>
<ol>
<li>ä½ éœ€è¦å…ˆ<strong>è¯»æ‡‚</strong>è¿™ç¯‡æ–‡ç« </li>
<li>ç†è§£æ¯ä¸ªè¯ã€æ¯å¥è¯çš„å«ä¹‰</li>
<li>æŠŠç†è§£åˆ°çš„å†…å®¹&quot;ç¼–ç &quot;æˆæœ‹å‹èƒ½ç†è§£çš„å½¢å¼</li>
</ol>
<p>è¿™å°±æ˜¯<strong>ç¼–ç å™¨</strong>åšçš„äº‹æƒ…ï¼šæŠŠåŸå§‹è¾“å…¥ï¼ˆæ–‡å­—ã€å›¾åƒç­‰ï¼‰è½¬åŒ–ä¸ºæœºå™¨èƒ½ç†è§£çš„&quot;æ·±å±‚è¡¨ç¤º&quot;ã€‚</p>
<h2>æ ¸å¿ƒæ¦‚å¿µ</h2>
<h3>ä»€ä¹ˆæ˜¯&quot;ç¼–ç &quot;ï¼Ÿ</h3>
<p>ç¼–ç å°±æ˜¯æŠŠä¿¡æ¯ä»ä¸€ç§å½¢å¼è½¬æ¢ä¸ºå¦ä¸€ç§å½¢å¼ã€‚</p>
<p>ä¾‹å­ï¼š</p>
<ul>
<li>æ‘©æ–¯å¯†ç ï¼šæŠŠå­—æ¯è½¬æ¢æˆç‚¹å’Œåˆ’</li>
<li>æ¡å½¢ç ï¼šæŠŠå•†å“ä¿¡æ¯è½¬æ¢æˆé»‘ç™½æ¡çº¹</li>
<li>ç¼–ç å™¨ï¼šæŠŠæ–‡å­—è½¬æ¢æˆæ•°å€¼å‘é‡</li>
</ul>
<h3>ç¼–ç å™¨çš„ç‰¹ç‚¹</h3>
<ol>
<li><strong>åŒå‘ç†è§£</strong>ï¼šèƒ½çœ‹åˆ°æ•´ä¸ªå¥å­ï¼Œç†è§£ä¸Šä¸‹æ–‡</li>
<li><strong>é€å±‚æŠ½è±¡</strong>ï¼šä»è¯åˆ°çŸ­è¯­åˆ°å¥å­ï¼Œå±‚å±‚æ·±å…¥</li>
<li><strong>ä½ç½®æ„ŸçŸ¥</strong>ï¼šçŸ¥é“æ¯ä¸ªè¯åœ¨å¥å­ä¸­çš„ä½ç½®</li>
</ol>
<h2>Transformer ç¼–ç å™¨</h2>
<h3>ç»“æ„</h3>
<p>ä¸€ä¸ª Transformer ç¼–ç å™¨ç”±å¤šä¸ªç›¸åŒçš„å±‚å †å è€Œæˆï¼Œæ¯å±‚åŒ…å«ï¼š</p>
<pre class="hljs"><code>è¾“å…¥ â†’ [Self-Attention] â†’ [Add &amp; Norm] â†’ [FFN] â†’ [Add &amp; Norm] â†’ è¾“å‡º
</code></pre>
<h3>å„éƒ¨åˆ†ä½œç”¨</h3>
<table>
<thead>
<tr>
<th>ç»„ä»¶</th>
<th>ä½œç”¨</th>
<th>é€šä¿—ç†è§£</th>
</tr>
</thead>
<tbody>
<tr>
<td>Self-Attention</td>
<td>ç†è§£è¯ä¸è¯ä¹‹é—´çš„å…³ç³»</td>
<td>&quot;ä»–&quot;æŒ‡çš„æ˜¯è°ï¼Ÿ</td>
</tr>
<tr>
<td>LayerNorm</td>
<td>ç¨³å®šæ•°å€¼</td>
<td>ä¿æŒæ•°æ®åœ¨åˆç†èŒƒå›´</td>
</tr>
<tr>
<td>FFN</td>
<td>éçº¿æ€§å˜æ¢</td>
<td>æå–æ›´æ·±å±‚çš„ç‰¹å¾</td>
</tr>
<tr>
<td>æ®‹å·®è¿æ¥</td>
<td>å¸®åŠ©æ¢¯åº¦æµåŠ¨</td>
<td>ä¿ç•™åŸå§‹ä¿¡æ¯</td>
</tr>
</tbody>
</table>
<h2>ç¼–ç å™¨çš„åº”ç”¨</h2>
<h3>BERT</h3>
<p>æœ€è‘—åçš„ç¼–ç å™¨æ¨¡å‹ï¼Œç”¨äºï¼š</p>
<ul>
<li>æ–‡æœ¬åˆ†ç±»ï¼šåˆ¤æ–­ä¸€æ®µè¯çš„æƒ…æ„Ÿ</li>
<li>å‘½åå®ä½“è¯†åˆ«ï¼šæ‰¾å‡ºå¥å­ä¸­çš„äººåã€åœ°å</li>
<li>é—®ç­”ç³»ç»Ÿï¼šä»æ–‡ç« ä¸­æ‰¾ç­”æ¡ˆ</li>
</ul>
<h3>ä¸ºä»€ä¹ˆç”¨ç¼–ç å™¨ï¼Ÿ</h3>
<p>ç¼–ç å™¨èƒ½çœ‹åˆ°æ•´ä¸ªè¾“å…¥ï¼Œæ‰€ä»¥ç‰¹åˆ«é€‚åˆï¼š</p>
<ul>
<li><strong>ç†è§£ä»»åŠ¡</strong>ï¼šéœ€è¦&quot;è¯»æ‡‚&quot;æ•´ä¸ªå†…å®¹</li>
<li><strong>åˆ†ç±»ä»»åŠ¡</strong>ï¼šåˆ¤æ–­è¾“å…¥å±äºå“ªä¸€ç±»</li>
<li><strong>æ ‡æ³¨ä»»åŠ¡</strong>ï¼šç»™æ¯ä¸ªè¯æ‰“æ ‡ç­¾</li>
</ul>
<h2>ç¼–ç å™¨ vs è§£ç å™¨</h2>
<table>
<thead>
<tr>
<th>ç‰¹ç‚¹</th>
<th>ç¼–ç å™¨</th>
<th>è§£ç å™¨</th>
</tr>
</thead>
<tbody>
<tr>
<td>çœ‹çš„æ–¹å‘</td>
<td>åŒå‘ï¼ˆå‰åéƒ½çœ‹ï¼‰</td>
<td>å•å‘ï¼ˆåªçœ‹å‰é¢ï¼‰</td>
</tr>
<tr>
<td>å…¸å‹ä»»åŠ¡</td>
<td>ç†è§£ã€åˆ†ç±»</td>
<td>ç”Ÿæˆã€ç¿»è¯‘</td>
</tr>
<tr>
<td>ä»£è¡¨æ¨¡å‹</td>
<td>BERT</td>
<td>GPT</td>
</tr>
</tbody>
</table>
<h2>ä¸€ä¸ªç›´è§‚çš„ä¾‹å­</h2>
<p>è¾“å…¥å¥å­ï¼šâ€œè‹¹æœå…¬å¸å‘å¸ƒäº†æ–°æ‰‹æœºâ€</p>
<p>ç¼–ç å™¨çš„å¤„ç†è¿‡ç¨‹ï¼š</p>
<ol>
<li>
<p><strong>ç¬¬1å±‚</strong>ï¼šç†è§£åŸºæœ¬è¯ä¹‰</p>
<ul>
<li>è‹¹æœ â†’ å…¬å¸ï¼ˆè€Œä¸æ˜¯æ°´æœï¼‰</li>
<li>å‘å¸ƒ â†’ åŠ¨ä½œ</li>
</ul>
</li>
<li>
<p><strong>ç¬¬2å±‚</strong>ï¼šç†è§£è¯é—´å…³ç³»</p>
<ul>
<li>&quot;è‹¹æœå…¬å¸&quot;æ˜¯å‘å¸ƒè€…</li>
<li>&quot;æ–°æ‰‹æœº&quot;æ˜¯è¢«å‘å¸ƒçš„</li>
</ul>
</li>
<li>
<p><strong>ç¬¬3å±‚</strong>ï¼šç†è§£æ•´ä½“å«ä¹‰</p>
<ul>
<li>è¿™æ˜¯ä¸€æ¡ç§‘æŠ€æ–°é—»</li>
<li>å…³äºäº§å“å‘å¸ƒ</li>
</ul>
</li>
</ol>
<p>æœ€ç»ˆè¾“å‡ºï¼šæ¯ä¸ªè¯éƒ½æœ‰ä¸€ä¸ª&quot;æ·±å±‚è¡¨ç¤º&quot;ï¼ŒåŒ…å«äº†ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</p>
<h2>æ€»ç»“</h2>
<table>
<thead>
<tr>
<th>æ¦‚å¿µ</th>
<th>é€šä¿—ç†è§£</th>
</tr>
</thead>
<tbody>
<tr>
<td>ç¼–ç å™¨</td>
<td>æŠŠè¾“å…¥&quot;è¯»æ‡‚&quot;å¹¶è½¬åŒ–æˆæ·±å±‚è¡¨ç¤º</td>
</tr>
<tr>
<td>åŒå‘ç†è§£</td>
<td>å‰åæ–‡éƒ½èƒ½çœ‹åˆ°</td>
</tr>
<tr>
<td>Self-Attention</td>
<td>ç†è§£è¯ä¸è¯çš„å…³ç³»</td>
</tr>
<tr>
<td>å †å å±‚</td>
<td>é€å±‚åŠ æ·±ç†è§£</td>
</tr>
</tbody>
</table>
<h2>ä¸‹ä¸€æ­¥</h2>
<ul>
<li>æƒ³äº†è§£æ•°å­¦åŸç†ï¼Ÿé˜…è¯» <a href="advanced-guide.md">æ·±å…¥ç‰ˆ</a></li>
<li>æƒ³çœ‹ä»£ç å®ç°ï¼ŸæŸ¥çœ‹ <code>examples/</code> ç›®å½•</li>
</ul>
<h1>ç¼–ç å™¨ï¼ˆEncoderï¼‰æ·±å…¥ç‰ˆ</h1>
<blockquote>
<p>é¢å‘æœ‰æœºå™¨å­¦ä¹ åŸºç¡€è¯»è€…çš„æŠ€æœ¯è¯¦è§£</p>
</blockquote>
<h2>æ¦‚è¿°</h2>
<p>Transformer ç¼–ç å™¨æ˜¯ä¸€ç§åŒå‘åºåˆ—å»ºæ¨¡æ¶æ„ï¼Œé€šè¿‡è‡ªæ³¨æ„åŠ›æœºåˆ¶æ•è·åºåˆ—ä¸­æ‰€æœ‰ä½ç½®ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚æœ¬æ–‡æ·±å…¥åˆ†æç¼–ç å™¨çš„ç»“æ„ã€æ•°å­¦åŸç†åŠå…¶åœ¨ BERT ç­‰æ¨¡å‹ä¸­çš„åº”ç”¨ã€‚</p>
<h2>Transformer Encoder ç»“æ„</h2>
<h3>å•å±‚ç»“æ„</h3>
<p>æ¯å±‚ç¼–ç å™¨åŒ…å«ä¸¤ä¸ªå­å±‚ï¼š</p>
<ol>
<li><strong>Multi-Head Self-Attention</strong></li>
<li><strong>Position-wise Feed-Forward Network</strong></li>
</ol>
<p>æ¯ä¸ªå­å±‚åéƒ½æœ‰æ®‹å·®è¿æ¥å’Œå±‚å½’ä¸€åŒ–ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">Output</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">LayerNorm</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Sublayer</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">))</span></span></span></span></span></p>
<p><a id="formula-encoder-1"></a>
<a href="#formula-encoder-1-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šæ®‹å·®è¿æ¥å°†è¾“å…¥ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> ä¸å­å±‚è¾“å‡ºç›¸åŠ ï¼Œå†é€šè¿‡å±‚å½’ä¸€åŒ–å¾—åˆ°æœ€ç»ˆè¾“å‡ºã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> ä¸ºå­å±‚è¾“å…¥ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Sublayer</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> ä¸ºæ³¨æ„åŠ›æˆ–å‰é¦ˆç½‘ç»œçš„è¾“å‡ºï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">LayerNorm</span></span></span></span></span> ä¸ºå±‚å½’ä¸€åŒ–æ“ä½œã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šæ®‹å·®è¿æ¥è®©æ¢¯åº¦å¯ä»¥ç›´æ¥æµè¿‡ï¼Œç¼“è§£æ·±å±‚ç½‘ç»œçš„æ¢¯åº¦æ¶ˆå¤±ï¼›å±‚å½’ä¸€åŒ–ç¨³å®šæ¯å±‚çš„è¾“å…¥åˆ†å¸ƒã€‚</li>
</ul>
<h3>å®Œæ•´å…¬å¼</h3>
<p>å¯¹äºè¾“å…¥åºåˆ— <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">Ã—</span><span class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span></span></span></span></span>ï¼š</p>
<p><strong>å­å±‚ 1ï¼šMulti-Head Self-Attention</strong>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">LayerNorm</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">MultiHead</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mclose">))</span></span></span></span></span></p>
<p><a id="formula-encoder-2"></a>
<a href="#formula-encoder-2-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šå¯¹è¾“å…¥ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span> åšå¤šå¤´è‡ªæ³¨æ„åŠ›ï¼ŒåŠ æ®‹å·®åå†åšå±‚å½’ä¸€åŒ–ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span> ä¸ºè¾“å…¥åºåˆ—ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord">MultiHead</span></span></span></span></span> ä¸ºå¤šå¤´æ³¨æ„åŠ›ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span></span></span></span> ä¸ºå­å±‚è¾“å‡ºã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šè®©æ¯ä¸ªä½ç½®éƒ½èƒ½&quot;çœ‹åˆ°&quot;å…¨åºåˆ—ä¿¡æ¯ï¼Œæ®‹å·®å’Œå½’ä¸€åŒ–ä¿è¯è®­ç»ƒç¨³å®šã€‚</li>
</ul>
<p><strong>å­å±‚ 2ï¼šFeed-Forward Network</strong>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">LayerNorm</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">FFN</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mclose">))</span></span></span></span></span></p>
<p><a id="formula-encoder-3"></a>
<a href="#formula-encoder-3-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šå¯¹æ³¨æ„åŠ›è¾“å‡º <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span></span></span></span> åšå‰é¦ˆç½‘ç»œå˜æ¢ï¼ŒåŠ æ®‹å·®åå†å±‚å½’ä¸€åŒ–ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span></span></span></span> ä¸ºä¸Šä¸€å±‚è¾“å‡ºï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord text"><span class="mord">FFN</span></span></span></span></span> ä¸ºé€ä½ç½®å‰é¦ˆç½‘ç»œï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span></span></span></span> ä¸ºæœ€ç»ˆå±‚è¾“å‡ºã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šFFN å¯¹æ¯ä¸ªä½ç½®ç‹¬ç«‹åšéçº¿æ€§ç‰¹å¾æå–ï¼Œå¢å¼ºè¡¨è¾¾èƒ½åŠ›ã€‚</li>
</ul>
<p>å…¶ä¸­ FFN å®šä¹‰ä¸ºï¼š
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">FFN</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">GELU</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p><a id="formula-encoder-4"></a>
<a href="#formula-encoder-4-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šå…ˆå‡ç»´å†åš GELU æ¿€æ´»ï¼Œæœ€åé™ç»´å›åŸç»´åº¦ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> å‡ç»´åˆ° <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord">4</span><span class="mord mathnormal">d</span></span></span></span>ï¼Œ<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> é™å› <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span>ï¼›GELU ä¸ºå¹³æ»‘æ¿€æ´»å‡½æ•°ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šæ‰©å±•ä¸­é—´ç»´åº¦å¢åŠ éçº¿æ€§è¡¨è¾¾èƒ½åŠ›ï¼Œæ˜¯ Transformer çš„æ ¸å¿ƒè®¡ç®—æ¨¡å—ä¹‹ä¸€ã€‚</li>
</ul>
<h2>Pre-LN vs Post-LN</h2>
<h3>Post-LNï¼ˆåŸå§‹ Transformerï¼‰</h3>
<pre class="hljs"><code>x = LayerNorm(x + Sublayer(x))
</code></pre>
<ul>
<li>æ¢¯åº¦åœ¨æ·±å±‚ç½‘ç»œä¸­å¯èƒ½æ¶ˆå¤±</li>
<li>éœ€è¦ warmup</li>
<li>è®­ç»ƒä¸å¤Ÿç¨³å®š</li>
</ul>
<h3>Pre-LNï¼ˆç°ä»£å®ç°ï¼‰</h3>
<pre class="hljs"><code>x = x + Sublayer(LayerNorm(x))
</code></pre>
<ul>
<li>æ¢¯åº¦æµåŠ¨æ›´å¹³æ»‘</li>
<li>ä¸éœ€è¦ warmup</li>
<li>è®­ç»ƒæ›´ç¨³å®š</li>
</ul>
<h3>æ¢¯åº¦åˆ†æ</h3>
<p>Pre-LN çš„æ¢¯åº¦å¯ä»¥ç›´æ¥é€šè¿‡æ®‹å·®è·¯å¾„æµå‘ä»»ä½•å±‚ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.2074em;vertical-align:-0.836em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="mord mathnormal">L</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.2074em;vertical-align:-0.836em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">L</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="mord mathnormal">L</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:3.1304em;vertical-align:-1.3021em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8479em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.3021em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="mord mathnormal">L</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.8804em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><a id="formula-encoder-5"></a>
<a href="#formula-encoder-5-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šç¬¬ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span></span></span> å±‚çš„æ¢¯åº¦ç­‰äºæœ€åä¸€å±‚ç›´æ¥ä¼ å›çš„æ¢¯åº¦åŠ ä¸Šä¸­é—´å„å­å±‚çš„æ¢¯åº¦è´¡çŒ®ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºç¬¬ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span></span></span> å±‚è¾“å…¥ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">L</span></span></span></span> ä¸ºæ€»å±‚æ•°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºç¬¬ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> ä¸ªå­å±‚å˜æ¢ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šç¬¬ä¸€é¡¹ï¼ˆç›´è¿æ¢¯åº¦ï¼‰ä¿è¯å³ä½¿ç½‘ç»œå¾ˆæ·±ï¼Œæ¢¯åº¦ä¹Ÿèƒ½æ— æŸä¼ å›ï¼Œé˜²æ­¢æ¢¯åº¦æ¶ˆå¤±ã€‚</li>
</ul>
<p>ç¬¬ä¸€é¡¹ä¿è¯æ¢¯åº¦ä¸ä¼šæ¶ˆå¤±ã€‚</p>
<h2>ä½ç½®ç¼–ç </h2>
<p>ç”±äºè‡ªæ³¨æ„åŠ›æ²¡æœ‰é¡ºåºæ¦‚å¿µï¼Œéœ€è¦ä½ç½®ç¼–ç ï¼š</p>
<h3>Sinusoidalï¼ˆåŸå§‹ï¼‰</h3>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0385em;vertical-align:-0.3552em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">os</span><span class="mpunct mtight">,</span><span class="mord mtight">2</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em;"></span><span class="mop">sin</span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mord mathnormal">os</span><span class="mord">/1000</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight">i</span><span class="mord mtight">/</span><span class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><a id="formula-encoder-6"></a>
<a href="#formula-encoder-6-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0385em;vertical-align:-0.3552em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">os</span><span class="mpunct mtight">,</span><span class="mord mtight">2</span><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em;"></span><span class="mop">cos</span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mord mathnormal">os</span><span class="mord">/1000</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight">i</span><span class="mord mtight">/</span><span class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><a id="formula-encoder-7"></a>
<a href="#formula-encoder-7-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šå¶æ•°ç»´åº¦ç”¨æ­£å¼¦ã€å¥‡æ•°ç»´åº¦ç”¨ä½™å¼¦ç¼–ç ä½ç½®ä¿¡æ¯ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">os</span></span></span></span> ä¸ºä½ç½®ç´¢å¼•ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> ä¸ºç»´åº¦ç´¢å¼•ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span> ä¸ºåµŒå…¥ç»´åº¦ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šä¸åŒé¢‘ç‡çš„æ­£å¼¦æ³¢ç»„åˆï¼Œè®©æ¨¡å‹èƒ½åŒºåˆ†ç›¸å¯¹ä½ç½®å…³ç³»ï¼›æ— å‚æ•°ä¸”å¯å¤–æ¨åˆ°ä»»æ„é•¿åº¦ã€‚</li>
</ul>
<h3>Learnableï¼ˆBERTï¼‰</h3>
<p>ç›´æ¥å­¦ä¹ ä½ç½®åµŒå…¥ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span><span class="mord mtight" style="margin-right:0.02778em;">_</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">n</span><span class="mbin mtight">Ã—</span><span class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span></span></span></span></span></p>
<h3>RoPEï¼ˆç°ä»£ LLMï¼‰</h3>
<p>æ—‹è½¬ä½ç½®åµŒå…¥ï¼Œç»“åˆäº†ç›¸å¯¹ä½ç½®ä¿¡æ¯ã€‚</p>
<h2>BERT æ¶æ„</h2>
<h3>æ¨¡å‹ç»“æ„</h3>
<p>BERT æ˜¯ä¸€ä¸ªå¤šå±‚çš„ Transformer ç¼–ç å™¨ï¼š</p>
<ul>
<li><strong>BERT-Base</strong>ï¼š12 å±‚ï¼Œ768 ç»´ï¼Œ12 å¤´ï¼Œ110M å‚æ•°</li>
<li><strong>BERT-Large</strong>ï¼š24 å±‚ï¼Œ1024 ç»´ï¼Œ16 å¤´ï¼Œ340M å‚æ•°</li>
</ul>
<h3>è¾“å…¥è¡¨ç¤º</h3>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">Input</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">TokenÂ Embedding</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">SegmentÂ Embedding</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">PositionÂ Embedding</span></span></span></span></span></span></p>
<p><a id="formula-encoder-8"></a>
<a href="#formula-encoder-8-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li>
<p><strong>å…¬å¼å«ä¹‰</strong>ï¼šBERT è¾“å…¥ç”±ä¸‰ç§åµŒå…¥ç›¸åŠ å¾—åˆ°ï¼šè¯åµŒå…¥ã€å¥å­åµŒå…¥ã€ä½ç½®åµŒå…¥ã€‚</p>
</li>
<li>
<p><strong>å˜é‡è¯´æ˜</strong>ï¼šToken Embedding è¡¨ç¤ºè¯æœ¬èº«ï¼›Segment Embedding åŒºåˆ†å¥å­å¯¹ï¼›Position Embedding ç¼–ç ä½ç½®ã€‚</p>
</li>
<li>
<p><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šå°†è¯è¯­ä¹‰ã€å¥å­å½’å±ã€ä½ç½®ä¿¡æ¯ç»Ÿä¸€ç¼–ç åˆ°åŒä¸€å‘é‡ç©ºé—´ã€‚</p>
</li>
<li>
<p><strong>Token Embedding</strong>ï¼šè¯/å­è¯åµŒå…¥</p>
</li>
<li>
<p><strong>Segment Embedding</strong>ï¼šå¥å­æ ‡è¯†ï¼ˆç”¨äºå¥å­å¯¹ä»»åŠ¡ï¼‰</p>
</li>
<li>
<p><strong>Position Embedding</strong>ï¼šä½ç½®ä¿¡æ¯</p>
</li>
</ul>
<h3>ç‰¹æ®Š Token</h3>
<ul>
<li><code>[CLS]</code>ï¼šåºåˆ—å¼€å¤´ï¼Œç”¨äºåˆ†ç±»ä»»åŠ¡</li>
<li><code>[SEP]</code>ï¼šå¥å­åˆ†éš”ç¬¦</li>
<li><code>[MASK]</code>ï¼šé¢„è®­ç»ƒæ—¶é®ç›–çš„ token</li>
</ul>
<h3>é¢„è®­ç»ƒä»»åŠ¡</h3>
<h4>Masked Language Model (MLM)</h4>
<p>éšæœºé®ç›– 15% çš„ tokenï¼Œé¢„æµ‹è¢«é®ç›–çš„è¯ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal">ma</span><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord">âˆ£</span><span class="mord mathnormal">co</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mord mathnormal">t</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mopen">(</span><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.1413em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><a id="formula-encoder-9"></a>
<a href="#formula-encoder-9-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šç”¨ <code>[MASK]</code> ä½ç½®çš„éšè—çŠ¶æ€ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">h</span></span></span></span> ä¸è¯åµŒå…¥çŸ©é˜µ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span></span> è®¡ç®—ç›¸ä¼¼åº¦ï¼Œå†ç”¨ softmax å¾—åˆ°è¯æ¦‚ç‡åˆ†å¸ƒã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">h</span></span></span></span> ä¸º <code>[MASK]</code> ä½ç½®çš„è¡¨ç¤ºå‘é‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span></span> ä¸ºè¯åµŒå…¥çŸ©é˜µï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span> ä¸ºå…¶è½¬ç½®ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šå°†éšè—çŠ¶æ€æ˜ å°„å›è¯è¡¨ç©ºé—´ï¼Œé¢„æµ‹è¢«é®ç›–çš„åŸå§‹è¯ã€‚</li>
</ul>
<p>å…¶ä¸­ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">h</span></span></span></span> æ˜¯ <code>[MASK]</code> ä½ç½®çš„éšè—çŠ¶æ€ï¼Œ<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span></span> æ˜¯è¯åµŒå…¥çŸ©é˜µã€‚</p>
<h4>Next Sentence Prediction (NSP)</h4>
<p>åˆ¤æ–­ä¸¤ä¸ªå¥å­æ˜¯å¦è¿ç»­ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mord mathnormal">t</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1052em;vertical-align:-0.3552em;"></span><span class="mord text"><span class="mord">sigmoid</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">[</span><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span><span class="mord mathnormal mtight">L</span><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mclose">)</span></span></span></span></span></p>
<p><a id="formula-encoder-10"></a>
<a href="#formula-encoder-10-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šç”¨ <code>[CLS]</code> ä½ç½®çš„éšè—çŠ¶æ€åšäºŒåˆ†ç±»ï¼Œåˆ¤æ–­ä¸¤å¥å­æ˜¯å¦è¿ç»­ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0496em;vertical-align:-0.3552em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">[</span><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span><span class="mord mathnormal mtight">L</span><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span></span></span></span></span></span></span> ä¸º <code>[CLS]</code> token çš„è¡¨ç¤ºï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span></span></span></span> ä¸ºåˆ†ç±»æƒé‡å‘é‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">sigmoid</span></span></span></span></span> å°†è¾“å‡ºå‹ç¼©åˆ° <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span>ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼š<code>[CLS]</code> èšåˆäº†å…¨å¥ä¿¡æ¯ï¼Œç”¨äºå¥å­çº§åˆ«çš„é¢„æµ‹ä»»åŠ¡ã€‚</li>
</ul>
<h3>å¾®è°ƒèŒƒå¼</h3>
<p>åœ¨ä¸åŒä»»åŠ¡ä¸Šçš„å¾®è°ƒæ–¹å¼ï¼š</p>
<table>
<thead>
<tr>
<th>ä»»åŠ¡</th>
<th>è¾“å‡º</th>
<th>æŸå¤±</th>
</tr>
</thead>
<tbody>
<tr>
<td>åˆ†ç±»</td>
<td><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0496em;vertical-align:-0.3552em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">[</span><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span><span class="mord mathnormal mtight">L</span><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span></span></span></span></span></span></span> â†’ åˆ†ç±»å¤´</td>
<td>Cross-Entropy</td>
</tr>
<tr>
<td>NER</td>
<td>æ¯ä¸ª token â†’ åˆ†ç±»å¤´</td>
<td>Cross-Entropy</td>
</tr>
<tr>
<td>QA</td>
<td><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> â†’ span é¢„æµ‹</td>
<td>Cross-Entropy</td>
</tr>
</tbody>
</table>
<h2>ç¼–ç å™¨çš„ä¼˜åŠ¿</h2>
<h3>1. åŒå‘ä¸Šä¸‹æ–‡</h3>
<p>æ¯ä¸ªä½ç½®éƒ½èƒ½çœ‹åˆ°æ•´ä¸ªåºåˆ—ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">â€¦</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><a id="formula-encoder-11"></a>
<a href="#formula-encoder-11-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šç¼–ç å™¨ä¸­æ¯ä¸ªä½ç½®çš„è¡¨ç¤ºéƒ½ä¾èµ–å…¨åºåˆ—ä¿¡æ¯ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºä½ç½® <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> çš„è¾“å‡ºè¡¨ç¤ºï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">â€¦</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºåºåˆ—æ‰€æœ‰ä½ç½®çš„è¾“å…¥ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šåŒå‘å»ºæ¨¡è®©æ¯ä¸ªè¯éƒ½èƒ½&quot;çœ‹åˆ°&quot;å‰åæ–‡ï¼Œæ›´é€‚åˆç†è§£ä»»åŠ¡ã€‚</li>
</ul>
<p>å¯¹æ¯” RNN/LSTM åªèƒ½çœ‹åˆ°å·¦ä¾§ä¸Šä¸‹æ–‡ã€‚</p>
<h3>2. å¹¶è¡Œè®¡ç®—</h3>
<p>æ‰€æœ‰ä½ç½®å¯ä»¥åŒæ—¶è®¡ç®—ï¼Œä¸åƒ RNN éœ€è¦é¡ºåºå¤„ç†ã€‚</p>
<h3>3. é•¿è·ç¦»ä¾èµ–</h3>
<p>ä»»æ„ä¸¤ä¸ªä½ç½®ä¹‹é—´çš„è·¯å¾„é•¿åº¦ä¸º O(1)ï¼Œä¸åƒ RNN æ˜¯ O(n)ã€‚</p>
<h2>å®ç°ç»†èŠ‚</h2>
<h3>å‚æ•°å…±äº«</h3>
<p>åœ¨ BERT ä¸­ï¼Œè¯åµŒå…¥çŸ©é˜µå’Œè¾“å‡ºåˆ†ç±»å™¨å…±äº«ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em;"></span><span class="mord text"><span class="mord">MLM_logits</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9747em;vertical-align:-0.0833em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">b</span></span></span></span></span></p>
<p><a id="formula-encoder-12"></a>
<a href="#formula-encoder-12-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šé¢„æµ‹è¢«é®ç›–è¯æ—¶ï¼Œç›´æ¥å¤ç”¨è¾“å…¥è¯åµŒå…¥çŸ©é˜µä½œä¸ºè¾“å‡ºæŠ•å½±ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">h</span></span></span></span> ä¸ºéšè—çŠ¶æ€ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span> ä¸ºè¯åµŒå…¥çŸ©é˜µè½¬ç½®ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">b</span></span></span></span> ä¸ºåç½®ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šå…±äº«çŸ©é˜µå‡å°‘å‚æ•°é‡ï¼ŒåŒæ—¶è¾“å…¥å’Œè¾“å‡ºè¯­ä¹‰å¯¹é½æ›´ä¸€è‡´ã€‚</li>
</ul>
<p>è¿™å‡å°‘äº†å‚æ•°é‡ï¼Œå¹¶æ”¹å–„äº†è®­ç»ƒç¨³å®šæ€§ã€‚</p>
<h3>Dropout</h3>
<p>é€šå¸¸åº”ç”¨äºï¼š</p>
<ul>
<li>Attention weights</li>
<li>FFN è¾“å‡º</li>
<li>Embedding sum</li>
</ul>
<p>Dropout ç‡é€šå¸¸ä¸º 0.1ã€‚</p>
<h2>å˜ä½“ä¸æ”¹è¿›</h2>
<h3>RoBERTa</h3>
<ul>
<li>ç§»é™¤ NSP ä»»åŠ¡</li>
<li>æ›´å¤§çš„ batch size</li>
<li>æ›´å¤šæ•°æ®</li>
<li>åŠ¨æ€ masking</li>
</ul>
<h3>ALBERT</h3>
<ul>
<li>è·¨å±‚å‚æ•°å…±äº«</li>
<li>å› å¼åˆ†è§£çš„åµŒå…¥</li>
<li>å‡å°‘å‚æ•°é‡</li>
</ul>
<h3>DeBERTa</h3>
<ul>
<li>è§£è€¦æ³¨æ„åŠ›</li>
<li>å¢å¼ºçš„æ©ç è§£ç å™¨</li>
<li>æ›´å¥½çš„æ€§èƒ½</li>
</ul>
<h2>å‚è€ƒæ–‡çŒ®</h2>
<ol>
<li>Vaswani et al. (2017). <em>Attention Is All You Need</em></li>
<li>Devlin et al. (2018). <em>BERT: Pre-training of Deep Bidirectional Transformers</em></li>
<li>Liu et al. (2019). <em>RoBERTa: A Robustly Optimized BERT Pretraining Approach</em></li>
<li>Lan et al. (2019). <em>ALBERT: A Lite BERT for Self-supervised Learning</em></li>
<li>He et al. (2020). <em>DeBERTa: Decoding-enhanced BERT with Disentangled Attention</em></li>
</ol>
<h1>Encoder æµç¨‹å›¾è§£</h1>
<blockquote>
<p>é€šè¿‡å¯è§†åŒ–å›¾è¡¨ç†è§£ Transformer Encoder çš„å·¥ä½œæµç¨‹</p>
</blockquote>
<h2>Encoder æ•´ä½“æ¶æ„</h2>
<p><div class="mermaid">flowchart TB
    A["è¾“å…¥ Embedding"] --&gt; B["ä½ç½®ç¼–ç "]
    B --&gt; C["Multi-Head Attention"]
    C --&gt; D["Add &amp; Norm"]
    D --&gt; E["Feed Forward"]
    E --&gt; F["Add &amp; Norm"]
    F --&gt; G["è¾“å‡º"]

    subgraph å †å Næ¬¡
        C
        D
        E
        F
    end

    style G fill:#c8e6c9</div></p>
<h2>å•å±‚ Encoder è¯¦ç»†æµç¨‹</h2>
<p><div class="mermaid">flowchart TB
    A["è¾“å…¥ x"] --&gt; B["Layer Norm"]
    B --&gt; C["Multi-Head Self-Attention"]
    C --&gt; D["æ®‹å·®è¿æ¥&lt;br/&gt;x + Attention(x)"]

    D --&gt; E["Layer Norm"]
    E --&gt; F["FFN"]
    F --&gt; G["æ®‹å·®è¿æ¥&lt;br/&gt;x + FFN(x)"]

    G --&gt; H["è¾“å‡º"]

    style H fill:#c8e6c9</div></p>
<h2>BERT Encoder ç»“æ„</h2>
<p><div class="mermaid">flowchart TB
    A["[CLS] Token 1 Token 2 ... Token N [SEP]"] --&gt; B["Token Embedding"]
    A --&gt; C["Segment Embedding"]
    A --&gt; D["Position Embedding"]

    B --&gt; E["ç›¸åŠ "]
    C --&gt; E
    D --&gt; E

    E --&gt; F["Encoder x 12"]

    F --&gt; G["[CLS] è¾“å‡º&lt;br/&gt;å¥å­è¡¨ç¤º"]
    F --&gt; H["Token è¾“å‡º&lt;br/&gt;ç”¨äºåˆ†ç±»/NER"]

    style G fill:#c8e6c9
    style H fill:#c8e6c9</div></p>
<h2>Self-Attention åœ¨ Encoder ä¸­</h2>
<p><div class="mermaid">flowchart LR
    subgraph åŒå‘æ³¨æ„åŠ›
        A["Token 1"] --&gt; B["å¯ä»¥çœ‹åˆ°"]
        C["Token 2"] --&gt; B
        D["Token 3"] --&gt; B
        E["Token 4"] --&gt; B
    end

    F["æ¯ä¸ª token å¯ä»¥&lt;br/&gt;çœ‹åˆ°æ‰€æœ‰å…¶ä»– token"]

    style B fill:#c8e6c9</div></p>
<h2>Encoder å †å </h2>
<p><div class="mermaid">flowchart TB
    A["è¾“å…¥"] --&gt; L1["Layer 1"]
    L1 --&gt; L2["Layer 2"]
    L2 --&gt; L3["Layer 3"]
    L3 --&gt; L4["..."]
    L4 --&gt; L5["Layer N"]
    L5 --&gt; B["è¾“å‡º"]

    C["æ¯å±‚æå–ä¸åŒçº§åˆ«çš„ç‰¹å¾"]

    style B fill:#c8e6c9</div></p>
<h2>BERT é¢„è®­ç»ƒä»»åŠ¡</h2>
<p><div class="mermaid">flowchart TB
    subgraph MLM
        A["The [MASK] sat on mat"] --&gt; B["é¢„æµ‹: cat"]
    end

    subgraph NSP
        C["å¥å­ A: æˆ‘çˆ±ç¼–ç¨‹"] --&gt; D{"æ˜¯ä¸‹ä¸€å¥?"}
        E["å¥å­ B: Pythonå¾ˆå¥½"] --&gt; D
    end

    style B fill:#c8e6c9
    style D fill:#c8e6c9</div></p>
<h2>å›¾è§£è¯´æ˜</h2>
<h3>å…³é”®ç‰¹æ€§</h3>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>åŒå‘æ³¨æ„åŠ›</td>
<td>å¯ä»¥çœ‹åˆ°æ‰€æœ‰ä½ç½®</td>
</tr>
<tr>
<td>å¹¶è¡Œå¤„ç†</td>
<td>æ‰€æœ‰ token åŒæ—¶å¤„ç†</td>
</tr>
<tr>
<td>ä½ç½®ç¼–ç </td>
<td>æ³¨å…¥ä½ç½®ä¿¡æ¯</td>
</tr>
</tbody>
</table>
<h3>å…¸å‹é…ç½®</h3>
<table>
<thead>
<tr>
<th>æ¨¡å‹</th>
<th>å±‚æ•°</th>
<th>éšè—ç»´åº¦</th>
<th>æ³¨æ„åŠ›å¤´</th>
</tr>
</thead>
<tbody>
<tr>
<td>BERT-Base</td>
<td>12</td>
<td>768</td>
<td>12</td>
</tr>
<tr>
<td>BERT-Large</td>
<td>24</td>
<td>1024</td>
<td>16</td>
</tr>
</tbody>
</table>
<h3>åº”ç”¨åœºæ™¯</h3>
<ul>
<li>æ–‡æœ¬åˆ†ç±»</li>
<li>å‘½åå®ä½“è¯†åˆ«</li>
<li>é—®ç­”ç³»ç»Ÿ</li>
<li>è¯­ä¹‰ç›¸ä¼¼åº¦</li>
</ul>
<div class="code-appendix page-break"><h2>é™„å½•ï¼šä»£ç ç¤ºä¾‹</h2><div class="code-file"><h3>bert_layer_example.py</h3><pre class="hljs"><code><span class="hljs-string">&quot;&quot;&quot;
BERT é£æ ¼ç¼–ç å±‚ç¤ºä¾‹ / BERT-Style Encoder Layer Example
======================================================

æœ¬ç¤ºä¾‹å±•ç¤º BERT é£æ ¼çš„ç¼–ç å™¨å®ç°ã€‚
This example demonstrates BERT-style encoder implementation.

ä¾èµ–å®‰è£… / Dependencies:
    pip install torch transformers matplotlib
&quot;&quot;&quot;</span>

<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn
<span class="hljs-keyword">import</span> torch.nn.functional <span class="hljs-keyword">as</span> F
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 1. BERT Embeddings</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">BertEmbeddings</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;
    BERT çš„è¾“å…¥åµŒå…¥å±‚ / BERT Input Embedding Layer

    åŒ…å«ä¸‰éƒ¨åˆ† / Contains three parts:
    1. Token Embeddings
    2. Segment (Token Type) Embeddings
    3. Position Embeddings
    &quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, vocab_size, hidden_size, max_position_embeddings, type_vocab_size, dropout=<span class="hljs-number">0.1</span></span>):
        <span class="hljs-built_in">super</span>().__init__()

        <span class="hljs-variable language_">self</span>.token_embeddings = nn.Embedding(vocab_size, hidden_size)
        <span class="hljs-variable language_">self</span>.position_embeddings = nn.Embedding(max_position_embeddings, hidden_size)
        <span class="hljs-variable language_">self</span>.token_type_embeddings = nn.Embedding(type_vocab_size, hidden_size)

        <span class="hljs-variable language_">self</span>.layer_norm = nn.LayerNorm(hidden_size, eps=<span class="hljs-number">1e-12</span>)
        <span class="hljs-variable language_">self</span>.dropout = nn.Dropout(dropout)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, input_ids, token_type_ids=<span class="hljs-literal">None</span></span>):
        <span class="hljs-string">&quot;&quot;&quot;
        å‚æ•° / Args:
            input_ids: [batch, seq_len] - token indices
            token_type_ids: [batch, seq_len] - segment indices (0 or 1)

        è¿”å› / Returns:
            embeddings: [batch, seq_len, hidden_size]
        &quot;&quot;&quot;</span>
        batch_size, seq_len = input_ids.shape

        <span class="hljs-comment"># Token embeddings</span>
        token_embeds = <span class="hljs-variable language_">self</span>.token_embeddings(input_ids)

        <span class="hljs-comment"># Position embeddings</span>
        position_ids = torch.arange(seq_len, device=input_ids.device).unsqueeze(<span class="hljs-number">0</span>)
        position_embeds = <span class="hljs-variable language_">self</span>.position_embeddings(position_ids)

        <span class="hljs-comment"># Token type (segment) embeddings</span>
        <span class="hljs-keyword">if</span> token_type_ids <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            token_type_ids = torch.zeros_like(input_ids)
        token_type_embeds = <span class="hljs-variable language_">self</span>.token_type_embeddings(token_type_ids)

        <span class="hljs-comment"># åˆå¹¶æ‰€æœ‰ embeddings</span>
        embeddings = token_embeds + position_embeds + token_type_embeds
        embeddings = <span class="hljs-variable language_">self</span>.layer_norm(embeddings)
        embeddings = <span class="hljs-variable language_">self</span>.dropout(embeddings)

        <span class="hljs-keyword">return</span> embeddings

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 2. BERT Self-Attention</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">BertSelfAttention</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;BERT çš„è‡ªæ³¨æ„åŠ›å±‚ / BERT Self-Attention Layer&quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, hidden_size, num_attention_heads, dropout=<span class="hljs-number">0.1</span></span>):
        <span class="hljs-built_in">super</span>().__init__()

        <span class="hljs-variable language_">self</span>.num_heads = num_attention_heads
        <span class="hljs-variable language_">self</span>.head_dim = hidden_size // num_attention_heads

        <span class="hljs-variable language_">self</span>.query = nn.Linear(hidden_size, hidden_size)
        <span class="hljs-variable language_">self</span>.key = nn.Linear(hidden_size, hidden_size)
        <span class="hljs-variable language_">self</span>.value = nn.Linear(hidden_size, hidden_size)

        <span class="hljs-variable language_">self</span>.dropout = nn.Dropout(dropout)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, hidden_states, attention_mask=<span class="hljs-literal">None</span></span>):
        batch_size, seq_len, _ = hidden_states.shape

        <span class="hljs-comment"># è®¡ç®— Q, K, V</span>
        Q = <span class="hljs-variable language_">self</span>.query(hidden_states).view(batch_size, seq_len, <span class="hljs-variable language_">self</span>.num_heads, <span class="hljs-variable language_">self</span>.head_dim).transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)
        K = <span class="hljs-variable language_">self</span>.key(hidden_states).view(batch_size, seq_len, <span class="hljs-variable language_">self</span>.num_heads, <span class="hljs-variable language_">self</span>.head_dim).transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)
        V = <span class="hljs-variable language_">self</span>.value(hidden_states).view(batch_size, seq_len, <span class="hljs-variable language_">self</span>.num_heads, <span class="hljs-variable language_">self</span>.head_dim).transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)

        <span class="hljs-comment"># æ³¨æ„åŠ›åˆ†æ•°</span>
        scores = torch.matmul(Q, K.transpose(-<span class="hljs-number">2</span>, -<span class="hljs-number">1</span>)) / (<span class="hljs-variable language_">self</span>.head_dim ** <span class="hljs-number">0.5</span>)

        <span class="hljs-comment"># åº”ç”¨ attention mask</span>
        <span class="hljs-keyword">if</span> attention_mask <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            <span class="hljs-comment"># attention_mask: [batch, 1, 1, seq_len] (æ‰©å±•ç»´åº¦ä»¥åŒ¹é… scores)</span>
            scores = scores + attention_mask

        <span class="hljs-comment"># Softmax</span>
        attn_weights = F.softmax(scores, dim=-<span class="hljs-number">1</span>)
        attn_weights = <span class="hljs-variable language_">self</span>.dropout(attn_weights)

        <span class="hljs-comment"># åŠ æƒæ±‚å’Œ</span>
        output = torch.matmul(attn_weights, V)
        output = output.transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>).contiguous().view(batch_size, seq_len, -<span class="hljs-number">1</span>)

        <span class="hljs-keyword">return</span> output, attn_weights

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 3. BERT Layer</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">BertLayer</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;
    å®Œæ•´çš„ BERT å±‚ / Complete BERT Layer

    åŒ…å« / Contains:
    - Self-Attention
    - Intermediate (FFN ç¬¬ä¸€å±‚)
    - Output (FFN ç¬¬äºŒå±‚)
    &quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, hidden_size, num_attention_heads, intermediate_size, dropout=<span class="hljs-number">0.1</span></span>):
        <span class="hljs-built_in">super</span>().__init__()

        <span class="hljs-comment"># Self-Attention</span>
        <span class="hljs-variable language_">self</span>.attention = BertSelfAttention(hidden_size, num_attention_heads, dropout)
        <span class="hljs-variable language_">self</span>.attention_output = nn.Linear(hidden_size, hidden_size)
        <span class="hljs-variable language_">self</span>.attention_norm = nn.LayerNorm(hidden_size, eps=<span class="hljs-number">1e-12</span>)
        <span class="hljs-variable language_">self</span>.attention_dropout = nn.Dropout(dropout)

        <span class="hljs-comment"># FFN (Intermediate + Output)</span>
        <span class="hljs-variable language_">self</span>.intermediate = nn.Linear(hidden_size, intermediate_size)
        <span class="hljs-variable language_">self</span>.output = nn.Linear(intermediate_size, hidden_size)
        <span class="hljs-variable language_">self</span>.output_norm = nn.LayerNorm(hidden_size, eps=<span class="hljs-number">1e-12</span>)
        <span class="hljs-variable language_">self</span>.output_dropout = nn.Dropout(dropout)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, hidden_states, attention_mask=<span class="hljs-literal">None</span></span>):
        <span class="hljs-comment"># Self-Attention</span>
        attention_output, attn_weights = <span class="hljs-variable language_">self</span>.attention(hidden_states, attention_mask)
        attention_output = <span class="hljs-variable language_">self</span>.attention_output(attention_output)
        attention_output = <span class="hljs-variable language_">self</span>.attention_dropout(attention_output)

        <span class="hljs-comment"># Add &amp; Norm (Post-LN style)</span>
        hidden_states = <span class="hljs-variable language_">self</span>.attention_norm(hidden_states + attention_output)

        <span class="hljs-comment"># FFN</span>
        intermediate_output = F.gelu(<span class="hljs-variable language_">self</span>.intermediate(hidden_states))
        layer_output = <span class="hljs-variable language_">self</span>.output(intermediate_output)
        layer_output = <span class="hljs-variable language_">self</span>.output_dropout(layer_output)

        <span class="hljs-comment"># Add &amp; Norm</span>
        layer_output = <span class="hljs-variable language_">self</span>.output_norm(hidden_states + layer_output)

        <span class="hljs-keyword">return</span> layer_output, attn_weights

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 4. ç®€åŒ–çš„ BERT æ¨¡å‹ / Simplified BERT Model</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleBERT</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;
    ç®€åŒ–çš„ BERT æ¨¡å‹ / Simplified BERT Model

    ç”¨äºç†è§£ BERT çš„æ ¸å¿ƒæ¶æ„
    For understanding BERT&#x27;s core architecture
    &quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, vocab_size=<span class="hljs-number">30522</span>, hidden_size=<span class="hljs-number">768</span>, num_attention_heads=<span class="hljs-number">12</span>,
                 intermediate_size=<span class="hljs-number">3072</span>, num_hidden_layers=<span class="hljs-number">12</span>,
                 max_position_embeddings=<span class="hljs-number">512</span>, type_vocab_size=<span class="hljs-number">2</span>, dropout=<span class="hljs-number">0.1</span></span>):
        <span class="hljs-built_in">super</span>().__init__()

        <span class="hljs-variable language_">self</span>.embeddings = BertEmbeddings(
            vocab_size, hidden_size, max_position_embeddings, type_vocab_size, dropout
        )

        <span class="hljs-variable language_">self</span>.layers = nn.ModuleList([
            BertLayer(hidden_size, num_attention_heads, intermediate_size, dropout)
            <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_hidden_layers)
        ])

        <span class="hljs-variable language_">self</span>.pooler = nn.Linear(hidden_size, hidden_size)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, input_ids, token_type_ids=<span class="hljs-literal">None</span>, attention_mask=<span class="hljs-literal">None</span></span>):
        <span class="hljs-string">&quot;&quot;&quot;
        å‚æ•° / Args:
            input_ids: [batch, seq_len]
            token_type_ids: [batch, seq_len]
            attention_mask: [batch, seq_len] (1 for actual tokens, 0 for padding)

        è¿”å› / Returns:
            sequence_output: [batch, seq_len, hidden_size]
            pooled_output: [batch, hidden_size] - [CLS] token çš„æ± åŒ–è¡¨ç¤º
        &quot;&quot;&quot;</span>
        <span class="hljs-comment"># Embeddings</span>
        hidden_states = <span class="hljs-variable language_">self</span>.embeddings(input_ids, token_type_ids)

        <span class="hljs-comment"># å‡†å¤‡ attention mask</span>
        <span class="hljs-keyword">if</span> attention_mask <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            <span class="hljs-comment"># è½¬æ¢ä¸º additive mask: 0 -&gt; 0, 1 -&gt; -inf</span>
            extended_attention_mask = attention_mask.unsqueeze(<span class="hljs-number">1</span>).unsqueeze(<span class="hljs-number">2</span>)
            extended_attention_mask = (<span class="hljs-number">1.0</span> - extended_attention_mask) * -<span class="hljs-number">10000.0</span>
        <span class="hljs-keyword">else</span>:
            extended_attention_mask = <span class="hljs-literal">None</span>

        <span class="hljs-comment"># é€šè¿‡æ‰€æœ‰å±‚</span>
        all_attentions = []
        <span class="hljs-keyword">for</span> layer <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.layers:
            hidden_states, attn_weights = layer(hidden_states, extended_attention_mask)
            all_attentions.append(attn_weights)

        <span class="hljs-comment"># Pooler ([CLS] token)</span>
        pooled_output = torch.tanh(<span class="hljs-variable language_">self</span>.pooler(hidden_states[:, <span class="hljs-number">0</span>]))

        <span class="hljs-keyword">return</span> hidden_states, pooled_output, all_attentions

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 5. æµ‹è¯• BERT æ¨¡å‹ / Test BERT Model</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;BERT æ¨¡å‹æµ‹è¯• / BERT Model Test&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

torch.manual_seed(<span class="hljs-number">42</span>)

<span class="hljs-comment"># åˆ›å»ºå°è§„æ¨¡ BERT ç”¨äºæµ‹è¯• / Create small BERT for testing</span>
bert = SimpleBERT(
    vocab_size=<span class="hljs-number">1000</span>,
    hidden_size=<span class="hljs-number">256</span>,
    num_attention_heads=<span class="hljs-number">8</span>,
    intermediate_size=<span class="hljs-number">1024</span>,
    num_hidden_layers=<span class="hljs-number">4</span>,
    max_position_embeddings=<span class="hljs-number">128</span>
)

<span class="hljs-comment"># åˆ›å»ºè¾“å…¥ / Create input</span>
batch_size, seq_len = <span class="hljs-number">2</span>, <span class="hljs-number">32</span>
input_ids = torch.randint(<span class="hljs-number">0</span>, <span class="hljs-number">1000</span>, (batch_size, seq_len))
token_type_ids = torch.zeros_like(input_ids)
attention_mask = torch.ones_like(input_ids)

<span class="hljs-comment"># å‰å‘ä¼ æ’­ / Forward pass</span>
sequence_output, pooled_output, attentions = bert(input_ids, token_type_ids, attention_mask)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nè¾“å…¥å½¢çŠ¶ / Input shape: <span class="hljs-subst">{input_ids.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;åºåˆ—è¾“å‡ºå½¢çŠ¶ / Sequence output shape: <span class="hljs-subst">{sequence_output.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;æ± åŒ–è¾“å‡ºå½¢çŠ¶ / Pooled output shape: <span class="hljs-subst">{pooled_output.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;æ³¨æ„åŠ›å±‚æ•° / Number of attention layers: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(attentions)}</span>&quot;</span>)

<span class="hljs-comment"># å‚æ•°ç»Ÿè®¡ / Parameter statistics</span>
total_params = <span class="hljs-built_in">sum</span>(p.numel() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> bert.parameters())
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\næ€»å‚æ•°é‡ / Total parameters: <span class="hljs-subst">{total_params:,}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 6. MLM ä»»åŠ¡æ¼”ç¤º / MLM Task Demonstration</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;MLM (Masked Language Model) ä»»åŠ¡æ¼”ç¤º / MLM Task Demo&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">BertMLMHead</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;BERT çš„ MLM é¢„æµ‹å¤´ / BERT MLM Prediction Head&quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, hidden_size, vocab_size</span>):
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-variable language_">self</span>.transform = nn.Linear(hidden_size, hidden_size)
        <span class="hljs-variable language_">self</span>.layer_norm = nn.LayerNorm(hidden_size)
        <span class="hljs-variable language_">self</span>.decoder = nn.Linear(hidden_size, vocab_size)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, hidden_states</span>):
        <span class="hljs-comment"># Transform</span>
        hidden_states = F.gelu(<span class="hljs-variable language_">self</span>.transform(hidden_states))
        hidden_states = <span class="hljs-variable language_">self</span>.layer_norm(hidden_states)
        <span class="hljs-comment"># Decode to vocab</span>
        logits = <span class="hljs-variable language_">self</span>.decoder(hidden_states)
        <span class="hljs-keyword">return</span> logits

<span class="hljs-comment"># åˆ›å»º MLM å¤´ / Create MLM head</span>
mlm_head = BertMLMHead(<span class="hljs-number">256</span>, <span class="hljs-number">1000</span>)

<span class="hljs-comment"># è·å– MLM é¢„æµ‹ / Get MLM predictions</span>
mlm_logits = mlm_head(sequence_output)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nMLM logits å½¢çŠ¶ / MLM logits shape: <span class="hljs-subst">{mlm_logits.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  [batch, seq_len, vocab_size]&quot;</span>)

<span class="hljs-comment"># å¯¹ [MASK] ä½ç½®è¿›è¡Œé¢„æµ‹ / Predict at [MASK] position</span>
<span class="hljs-comment"># å‡è®¾ä½ç½® 5 æ˜¯ [MASK]</span>
mask_position = <span class="hljs-number">5</span>
mask_logits = mlm_logits[<span class="hljs-number">0</span>, mask_position]
predicted_token = mask_logits.argmax().item()

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nä½ç½® <span class="hljs-subst">{mask_position}</span> çš„é¢„æµ‹ token ID / Predicted token at position <span class="hljs-subst">{mask_position}</span>: <span class="hljs-subst">{predicted_token}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Top-5 é¢„æµ‹ / Top-5 predictions:&quot;</span>)
top5 = torch.topk(mask_logits, <span class="hljs-number">5</span>)
<span class="hljs-keyword">for</span> i, (score, idx) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(<span class="hljs-built_in">zip</span>(top5.values, top5.indices)):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  <span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>. Token <span class="hljs-subst">{idx.item()}</span>: <span class="hljs-subst">{score.item():<span class="hljs-number">.4</span>f}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 7. åˆ†ç±»ä»»åŠ¡æ¼”ç¤º / Classification Task Demonstration</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;åˆ†ç±»ä»»åŠ¡æ¼”ç¤º / Classification Task Demo&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">BertClassificationHead</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;BERT çš„åˆ†ç±»å¤´ / BERT Classification Head&quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, hidden_size, num_classes, dropout=<span class="hljs-number">0.1</span></span>):
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-variable language_">self</span>.dropout = nn.Dropout(dropout)
        <span class="hljs-variable language_">self</span>.classifier = nn.Linear(hidden_size, num_classes)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, pooled_output</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.classifier(<span class="hljs-variable language_">self</span>.dropout(pooled_output))

<span class="hljs-comment"># åˆ›å»ºåˆ†ç±»å¤´ / Create classification head</span>
num_classes = <span class="hljs-number">3</span>  <span class="hljs-comment"># ä¾‹å¦‚ï¼šè´Ÿé¢ã€ä¸­æ€§ã€æ­£é¢</span>
classification_head = BertClassificationHead(<span class="hljs-number">256</span>, num_classes)

<span class="hljs-comment"># è·å–åˆ†ç±»é¢„æµ‹ / Get classification predictions</span>
class_logits = classification_head(pooled_output)
predicted_class = class_logits.argmax(dim=-<span class="hljs-number">1</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nåˆ†ç±» logits å½¢çŠ¶ / Classification logits shape: <span class="hljs-subst">{class_logits.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;é¢„æµ‹ç±»åˆ« / Predicted classes: <span class="hljs-subst">{predicted_class.tolist()}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># æ€»ç»“ / Summary</span>
<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;æ€»ç»“ / Summary&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-string">&quot;&quot;&quot;
æœ¬ç¤ºä¾‹å±•ç¤ºäº† BERT çš„æ ¸å¿ƒæ¶æ„:
This example demonstrates BERT&#x27;s core architecture:

1. Embeddings:
   - Token + Position + Segment (Token Type)
   - LayerNorm + Dropout

2. Encoder Layer (Post-LN):
   - Multi-Head Self-Attention
   - Feed-Forward Network (GELU activation)

3. ç‰¹æ®Šè®¾è®¡:
   - [CLS] token ç”¨äºåˆ†ç±»ä»»åŠ¡
   - [SEP] token åˆ†éš”å¥å­
   - [MASK] token ç”¨äº MLM é¢„è®­ç»ƒ

4. ä¸‹æ¸¸ä»»åŠ¡:
   - MLM: Masked Language Model
   - Classification: ä½¿ç”¨ [CLS] çš„æ± åŒ–è¾“å‡º
   - NER: æ¯ä¸ªä½ç½®çš„åˆ†ç±»
   - QA: Span é¢„æµ‹

5. BERT-Base é…ç½®:
   - 12 layers, 768 hidden, 12 heads, 110M params
&quot;&quot;&quot;</span>
</code></pre></div><div class="code-file"><h3>encoder_example.py</h3><pre class="hljs"><code><span class="hljs-string">&quot;&quot;&quot;
Transformer Encoder ç¤ºä¾‹ä»£ç  / Transformer Encoder Example Code
===============================================================

æœ¬ç¤ºä¾‹å±•ç¤º Transformer Encoder çš„åŸç†å’Œå®ç°ã€‚
This example demonstrates the principle and implementation of Transformer Encoder.

ä¾èµ–å®‰è£… / Dependencies:
    pip install torch matplotlib numpy
&quot;&quot;&quot;</span>

<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn
<span class="hljs-keyword">import</span> torch.nn.functional <span class="hljs-keyword">as</span> F
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 1. åŸºç¡€ç»„ä»¶ / Basic Components</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiHeadAttention</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;å¤šå¤´è‡ªæ³¨æ„åŠ› / Multi-Head Self-Attention&quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, d_model, num_heads, dropout=<span class="hljs-number">0.1</span></span>):
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-keyword">assert</span> d_model % num_heads == <span class="hljs-number">0</span>

        <span class="hljs-variable language_">self</span>.d_k = d_model // num_heads
        <span class="hljs-variable language_">self</span>.num_heads = num_heads

        <span class="hljs-variable language_">self</span>.W_q = nn.Linear(d_model, d_model)
        <span class="hljs-variable language_">self</span>.W_k = nn.Linear(d_model, d_model)
        <span class="hljs-variable language_">self</span>.W_v = nn.Linear(d_model, d_model)
        <span class="hljs-variable language_">self</span>.W_o = nn.Linear(d_model, d_model)

        <span class="hljs-variable language_">self</span>.dropout = nn.Dropout(dropout)
        <span class="hljs-variable language_">self</span>.scale = <span class="hljs-variable language_">self</span>.d_k ** -<span class="hljs-number">0.5</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x, mask=<span class="hljs-literal">None</span></span>):
        batch_size, seq_len, _ = x.shape

        <span class="hljs-comment"># è®¡ç®— Q, K, V</span>
        Q = <span class="hljs-variable language_">self</span>.W_q(x).view(batch_size, seq_len, <span class="hljs-variable language_">self</span>.num_heads, <span class="hljs-variable language_">self</span>.d_k).transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)
        K = <span class="hljs-variable language_">self</span>.W_k(x).view(batch_size, seq_len, <span class="hljs-variable language_">self</span>.num_heads, <span class="hljs-variable language_">self</span>.d_k).transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)
        V = <span class="hljs-variable language_">self</span>.W_v(x).view(batch_size, seq_len, <span class="hljs-variable language_">self</span>.num_heads, <span class="hljs-variable language_">self</span>.d_k).transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)

        <span class="hljs-comment"># æ³¨æ„åŠ›åˆ†æ•°</span>
        scores = torch.matmul(Q, K.transpose(-<span class="hljs-number">2</span>, -<span class="hljs-number">1</span>)) * <span class="hljs-variable language_">self</span>.scale

        <span class="hljs-keyword">if</span> mask <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            scores = scores.masked_fill(mask == <span class="hljs-number">1</span>, <span class="hljs-built_in">float</span>(<span class="hljs-string">&#x27;-inf&#x27;</span>))

        attn = F.softmax(scores, dim=-<span class="hljs-number">1</span>)
        attn = <span class="hljs-variable language_">self</span>.dropout(attn)

        <span class="hljs-comment"># åŠ æƒæ±‚å’Œ</span>
        output = torch.matmul(attn, V)
        output = output.transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>).contiguous().view(batch_size, seq_len, -<span class="hljs-number">1</span>)
        output = <span class="hljs-variable language_">self</span>.W_o(output)

        <span class="hljs-keyword">return</span> output, attn


<span class="hljs-keyword">class</span> <span class="hljs-title class_">FeedForward</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;å‰é¦ˆç½‘ç»œ / Feed-Forward Network&quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, d_model, d_ff, dropout=<span class="hljs-number">0.1</span></span>):
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-variable language_">self</span>.w1 = nn.Linear(d_model, d_ff)
        <span class="hljs-variable language_">self</span>.w2 = nn.Linear(d_ff, d_model)
        <span class="hljs-variable language_">self</span>.dropout = nn.Dropout(dropout)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.w2(<span class="hljs-variable language_">self</span>.dropout(F.gelu(<span class="hljs-variable language_">self</span>.w1(x))))

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 2. Encoder Layer å®ç° / Encoder Layer Implementation</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">EncoderLayer</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;
    Transformer Encoder Layerï¼ˆä½¿ç”¨ Pre-LNï¼‰
    Transformer Encoder Layer (using Pre-LN)
    &quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, d_model, num_heads, d_ff, dropout=<span class="hljs-number">0.1</span></span>):
        <span class="hljs-built_in">super</span>().__init__()

        <span class="hljs-comment"># Pre-LN</span>
        <span class="hljs-variable language_">self</span>.norm1 = nn.LayerNorm(d_model)
        <span class="hljs-variable language_">self</span>.norm2 = nn.LayerNorm(d_model)

        <span class="hljs-comment"># Sub-layers</span>
        <span class="hljs-variable language_">self</span>.attention = MultiHeadAttention(d_model, num_heads, dropout)
        <span class="hljs-variable language_">self</span>.ffn = FeedForward(d_model, d_ff, dropout)

        <span class="hljs-variable language_">self</span>.dropout = nn.Dropout(dropout)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x, mask=<span class="hljs-literal">None</span></span>):
        <span class="hljs-comment"># Self-Attention with Pre-LN</span>
        residual = x
        x = <span class="hljs-variable language_">self</span>.norm1(x)
        x, attn = <span class="hljs-variable language_">self</span>.attention(x, mask)
        x = residual + <span class="hljs-variable language_">self</span>.dropout(x)

        <span class="hljs-comment"># FFN with Pre-LN</span>
        residual = x
        x = <span class="hljs-variable language_">self</span>.norm2(x)
        x = <span class="hljs-variable language_">self</span>.ffn(x)
        x = residual + <span class="hljs-variable language_">self</span>.dropout(x)

        <span class="hljs-keyword">return</span> x, attn

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 3. å®Œæ•´çš„ Transformer Encoder / Complete Transformer Encoder</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">TransformerEncoder</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;
    å®Œæ•´çš„ Transformer Encoder
    Complete Transformer Encoder
    &quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, vocab_size, d_model, num_heads, d_ff, num_layers,
                 max_seq_len=<span class="hljs-number">512</span>, dropout=<span class="hljs-number">0.1</span></span>):
        <span class="hljs-built_in">super</span>().__init__()

        <span class="hljs-variable language_">self</span>.d_model = d_model

        <span class="hljs-comment"># Embeddings</span>
        <span class="hljs-variable language_">self</span>.token_embedding = nn.Embedding(vocab_size, d_model)
        <span class="hljs-variable language_">self</span>.position_embedding = nn.Embedding(max_seq_len, d_model)
        <span class="hljs-variable language_">self</span>.dropout = nn.Dropout(dropout)

        <span class="hljs-comment"># Encoder Layers</span>
        <span class="hljs-variable language_">self</span>.layers = nn.ModuleList([
            EncoderLayer(d_model, num_heads, d_ff, dropout)
            <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_layers)
        ])

        <span class="hljs-comment"># Final LayerNorm</span>
        <span class="hljs-variable language_">self</span>.norm = nn.LayerNorm(d_model)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x, mask=<span class="hljs-literal">None</span></span>):
        <span class="hljs-string">&quot;&quot;&quot;
        å‚æ•° / Args:
            x: [batch, seq_len] - token indices
            mask: [batch, seq_len, seq_len] - attention mask

        è¿”å› / Returns:
            output: [batch, seq_len, d_model]
            attentions: list of attention weights from each layer
        &quot;&quot;&quot;</span>
        batch_size, seq_len = x.shape

        <span class="hljs-comment"># Token + Position Embeddings</span>
        positions = torch.arange(seq_len, device=x.device).unsqueeze(<span class="hljs-number">0</span>)
        x = <span class="hljs-variable language_">self</span>.token_embedding(x) + <span class="hljs-variable language_">self</span>.position_embedding(positions)
        x = <span class="hljs-variable language_">self</span>.dropout(x)

        <span class="hljs-comment"># é€šè¿‡æ‰€æœ‰ Encoder å±‚</span>
        attentions = []
        <span class="hljs-keyword">for</span> layer <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.layers:
            x, attn = layer(x, mask)
            attentions.append(attn)

        <span class="hljs-comment"># æœ€ç»ˆ LayerNorm</span>
        x = <span class="hljs-variable language_">self</span>.norm(x)

        <span class="hljs-keyword">return</span> x, attentions

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 4. æµ‹è¯• Encoder / Test Encoder</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Transformer Encoder æµ‹è¯• / Transformer Encoder Test&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

torch.manual_seed(<span class="hljs-number">42</span>)

<span class="hljs-comment"># é…ç½® / Configuration</span>
vocab_size = <span class="hljs-number">10000</span>
d_model = <span class="hljs-number">256</span>
num_heads = <span class="hljs-number">8</span>
d_ff = <span class="hljs-number">1024</span>
num_layers = <span class="hljs-number">6</span>
max_seq_len = <span class="hljs-number">128</span>
batch_size = <span class="hljs-number">4</span>
seq_len = <span class="hljs-number">32</span>

<span class="hljs-comment"># åˆ›å»º Encoder / Create Encoder</span>
encoder = TransformerEncoder(
    vocab_size=vocab_size,
    d_model=d_model,
    num_heads=num_heads,
    d_ff=d_ff,
    num_layers=num_layers,
    max_seq_len=max_seq_len
)

<span class="hljs-comment"># åˆ›å»ºéšæœºè¾“å…¥ / Create random input</span>
x = torch.randint(<span class="hljs-number">0</span>, vocab_size, (batch_size, seq_len))

<span class="hljs-comment"># å‰å‘ä¼ æ’­ / Forward pass</span>
output, attentions = encoder(x)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\né…ç½® / Configuration:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  vocab_size: <span class="hljs-subst">{vocab_size}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  d_model: <span class="hljs-subst">{d_model}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  num_heads: <span class="hljs-subst">{num_heads}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  d_ff: <span class="hljs-subst">{d_ff}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  num_layers: <span class="hljs-subst">{num_layers}</span>&quot;</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nè¾“å…¥å½¢çŠ¶ / Input shape: <span class="hljs-subst">{x.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;è¾“å‡ºå½¢çŠ¶ / Output shape: <span class="hljs-subst">{output.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;æ³¨æ„åŠ›å±‚æ•° / Number of attention layers: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(attentions)}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;æ¯å±‚æ³¨æ„åŠ›å½¢çŠ¶ / Attention shape per layer: <span class="hljs-subst">{attentions[<span class="hljs-number">0</span>].shape}</span>&quot;</span>)

<span class="hljs-comment"># å‚æ•°ç»Ÿè®¡ / Parameter statistics</span>
total_params = <span class="hljs-built_in">sum</span>(p.numel() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> encoder.parameters())
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\næ€»å‚æ•°é‡ / Total parameters: <span class="hljs-subst">{total_params:,}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 5. å¯è§†åŒ–å„å±‚æ³¨æ„åŠ› / Visualize Attention from Each Layer</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;æ³¨æ„åŠ›å¯è§†åŒ– / Attention Visualization&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-comment"># å¯è§†åŒ–ä¸åŒå±‚çš„æ³¨æ„åŠ›æ¨¡å¼ / Visualize attention patterns from different layers</span>
fig, axes = plt.subplots(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, figsize=(<span class="hljs-number">15</span>, <span class="hljs-number">10</span>))
axes = axes.flatten()

<span class="hljs-keyword">for</span> i, (ax, attn) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(<span class="hljs-built_in">zip</span>(axes, attentions)):
    <span class="hljs-comment"># å–ç¬¬ä¸€ä¸ªæ ·æœ¬çš„ç¬¬ä¸€ä¸ªå¤´</span>
    attn_map = attn[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>].detach().numpy()
    im = ax.imshow(attn_map, cmap=<span class="hljs-string">&#x27;Blues&#x27;</span>)
    ax.set_title(<span class="hljs-string">f&#x27;Layer <span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span> (Head 1)&#x27;</span>)
    ax.set_xlabel(<span class="hljs-string">&#x27;Key Position&#x27;</span>)
    ax.set_ylabel(<span class="hljs-string">&#x27;Query Position&#x27;</span>)
    plt.colorbar(im, ax=ax)

plt.suptitle(<span class="hljs-string">&#x27;Self-Attention Patterns Across Layers&#x27;</span>, fontsize=<span class="hljs-number">14</span>)
plt.tight_layout()
plt.savefig(<span class="hljs-string">&#x27;/tmp/encoder_attention_layers.png&#x27;</span>, dpi=<span class="hljs-number">150</span>, bbox_inches=<span class="hljs-string">&#x27;tight&#x27;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\næ³¨æ„åŠ›å›¾åƒå·²ä¿å­˜è‡³ / Attention image saved to: /tmp/encoder_attention_layers.png&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 6. ç¼–ç å™¨è¾“å‡ºåˆ†æ / Encoder Output Analysis</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ç¼–ç å™¨è¾“å‡ºåˆ†æ / Encoder Output Analysis&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-comment"># åˆ†æè¾“å‡ºè¡¨ç¤º / Analyze output representations</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nè¾“å‡ºç»Ÿè®¡ / Output statistics:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  å‡å€¼ / Mean: <span class="hljs-subst">{output.mean().item():<span class="hljs-number">.4</span>f}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  æ ‡å‡†å·® / Std: <span class="hljs-subst">{output.std().item():<span class="hljs-number">.4</span>f}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  æœ€å°å€¼ / Min: <span class="hljs-subst">{output.<span class="hljs-built_in">min</span>().item():<span class="hljs-number">.4</span>f}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  æœ€å¤§å€¼ / Max: <span class="hljs-subst">{output.<span class="hljs-built_in">max</span>().item():<span class="hljs-number">.4</span>f}</span>&quot;</span>)

<span class="hljs-comment"># åˆ†æä¸åŒä½ç½®çš„è¡¨ç¤º / Analyze representations at different positions</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nä¸åŒä½ç½®çš„è¡¨ç¤ºèŒƒæ•° / Norm of representations at different positions:&quot;</span>)
<span class="hljs-keyword">for</span> pos <span class="hljs-keyword">in</span> [<span class="hljs-number">0</span>, seq_len//<span class="hljs-number">4</span>, seq_len//<span class="hljs-number">2</span>, seq_len-<span class="hljs-number">1</span>]:
    norm = output[<span class="hljs-number">0</span>, pos].norm().item()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  ä½ç½® <span class="hljs-subst">{pos}</span>: <span class="hljs-subst">{norm:<span class="hljs-number">.4</span>f}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 7. ä¸ PyTorch å†…ç½®å®ç°å¯¹æ¯” / Compare with PyTorch Implementation</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ä¸ PyTorch å†…ç½®å®ç°å¯¹æ¯” / Compare with PyTorch Implementation&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-comment"># PyTorch å†…ç½®çš„ Transformer Encoder</span>
pytorch_encoder_layer = nn.TransformerEncoderLayer(
    d_model=d_model,
    nhead=num_heads,
    dim_feedforward=d_ff,
    dropout=<span class="hljs-number">0.1</span>,
    batch_first=<span class="hljs-literal">True</span>
)
pytorch_encoder = nn.TransformerEncoder(pytorch_encoder_layer, num_layers=num_layers)

<span class="hljs-comment"># åˆ›å»ºåµŒå…¥åçš„è¾“å…¥ / Create embedded input</span>
x_embedded = encoder.token_embedding(x) + encoder.position_embedding(
    torch.arange(seq_len).unsqueeze(<span class="hljs-number">0</span>)
)

<span class="hljs-comment"># å‰å‘ä¼ æ’­ / Forward pass</span>
output_pytorch = pytorch_encoder(x_embedded)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nPyTorch Encoder è¾“å‡ºå½¢çŠ¶ / Output shape: <span class="hljs-subst">{output_pytorch.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;PyTorch Encoder å‚æ•°é‡ / Parameters: <span class="hljs-subst">{<span class="hljs-built_in">sum</span>(p.numel() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> pytorch_encoder.parameters()):,}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># æ€»ç»“ / Summary</span>
<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;æ€»ç»“ / Summary&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-string">&quot;&quot;&quot;
æœ¬ç¤ºä¾‹å±•ç¤ºäº† Transformer Encoder çš„æ ¸å¿ƒæ¦‚å¿µ:
This example demonstrates core concepts of Transformer Encoder:

1. ç»“æ„ / Structure:
   - Multi-Head Self-Attention
   - Feed-Forward Network
   - Layer Normalization
   - Residual Connections

2. Pre-LN vs Post-LN:
   - Pre-LN è®­ç»ƒæ›´ç¨³å®š
   - æ¢¯åº¦æµåŠ¨æ›´å¹³æ»‘

3. ç‰¹ç‚¹ / Features:
   - åŒå‘ä¸Šä¸‹æ–‡ç†è§£
   - å¹¶è¡Œè®¡ç®—
   - é•¿è·ç¦»ä¾èµ–

4. åº”ç”¨ / Applications:
   - BERT
   - æ–‡æœ¬åˆ†ç±»
   - å‘½åå®ä½“è¯†åˆ«
   - é—®ç­”ç³»ç»Ÿ
&quot;&quot;&quot;</span>
</code></pre></div></div></div><div class="chapter"><h1>ç¬¬8ç«  Decoder è§£ç å™¨</h1><h1>è§£ç å™¨ï¼ˆDecoderï¼‰ç§‘æ™®ç‰ˆ</h1>
<blockquote>
<p>é¢å‘é›¶åŸºç¡€è¯»è€…çš„è§£ç å™¨å…¥é—¨æŒ‡å—</p>
</blockquote>
<h2>ä¸€å¥è¯æ¦‚æ‹¬</h2>
<p><strong>è§£ç å™¨å°±åƒä¸€ä¸ª&quot;æ¥é¾™é«˜æ‰‹&quot;ï¼Œæ ¹æ®å‰é¢çš„å†…å®¹ï¼Œä¸€ä¸ªå­—ä¸€ä¸ªå­—åœ°ç”Ÿæˆåç»­çš„æ–‡å­—ã€‚</strong></p>
<h2>ä»ä¸€ä¸ªé—®é¢˜å¼€å§‹</h2>
<p>ä½ æœ‰æ²¡æœ‰ç©è¿‡&quot;æˆè¯­æ¥é¾™&quot;æ¸¸æˆï¼Ÿ</p>
<ul>
<li>ä½ è¯´ï¼šâ€œä¸€å¿ƒä¸€æ„â€</li>
<li>ä¸‹ä¸€ä¸ªäººè¯´ï¼šâ€œæ„æ°”é£å‘â€</li>
<li>å†ä¸‹ä¸€ä¸ªè¯´ï¼šâ€œå‘æ‰¬å…‰å¤§â€</li>
</ul>
<p><strong>è§£ç å™¨å°±åœ¨åšç±»ä¼¼çš„äº‹æƒ…</strong>ï¼šæ ¹æ®å·²ç»ç”Ÿæˆçš„å†…å®¹ï¼Œé¢„æµ‹ä¸‹ä¸€ä¸ªå­—åº”è¯¥æ˜¯ä»€ä¹ˆã€‚</p>
<h2>æ ¸å¿ƒæ¦‚å¿µ</h2>
<h3>è‡ªå›å½’ç”Ÿæˆ</h3>
<p>è§£ç å™¨æ˜¯&quot;è‡ªå›å½’&quot;çš„ï¼Œæ„æ€æ˜¯ï¼š</p>
<ul>
<li>ç”¨å·²ç»ç”Ÿæˆçš„è¯ï¼Œå»é¢„æµ‹ä¸‹ä¸€ä¸ªè¯</li>
<li>ç„¶åæŠŠæ–°è¯åŠ è¿›å»ï¼Œå†é¢„æµ‹å†ä¸‹ä¸€ä¸ªè¯</li>
<li>å¦‚æ­¤å¾ªç¯ï¼Œç›´åˆ°ç”Ÿæˆå®Œæ•´å†…å®¹</li>
</ul>
<pre class="hljs"><code>è¾“å…¥: &quot;ä»Šå¤©å¤©æ°”&quot;
é¢„æµ‹: &quot;å¾ˆ&quot; â†’ &quot;ä»Šå¤©å¤©æ°”å¾ˆ&quot;
é¢„æµ‹: &quot;å¥½&quot; â†’ &quot;ä»Šå¤©å¤©æ°”å¾ˆå¥½&quot;
é¢„æµ‹: &quot;ã€‚&quot; â†’ &quot;ä»Šå¤©å¤©æ°”å¾ˆå¥½ã€‚&quot;
</code></pre>
<h3>å› æœæ€§</h3>
<p>è§£ç å™¨åªèƒ½çœ‹åˆ°&quot;è¿‡å»&quot;çš„å†…å®¹ï¼Œä¸èƒ½&quot;å·çœ‹&quot;æœªæ¥ã€‚</p>
<p>å°±åƒä½ çœ‹ä¹¦æ—¶ï¼š</p>
<ul>
<li>åªèƒ½ä»å·¦åˆ°å³è¯»</li>
<li>ä¸çŸ¥é“åé¢ä¼šå‘ç”Ÿä»€ä¹ˆ</li>
</ul>
<p>è¿™å«<strong>å› æœæ©ç ï¼ˆCausal Maskï¼‰</strong>ï¼šåé¢çš„å†…å®¹è¢«&quot;é®ä½&quot;äº†ã€‚</p>
<h2>è§£ç å™¨çš„ç»“æ„</h2>
<p>ä¸€ä¸ª Transformer è§£ç å™¨å±‚åŒ…å«ï¼š</p>
<ol>
<li><strong>æ©ç è‡ªæ³¨æ„åŠ›</strong>ï¼šåªèƒ½çœ‹å‰é¢çš„è¯</li>
<li><strong>äº¤å‰æ³¨æ„åŠ›</strong>ï¼šçœ‹ç¼–ç å™¨çš„è¾“å‡ºï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰</li>
<li><strong>å‰é¦ˆç½‘ç»œ</strong>ï¼šè¿›ä¸€æ­¥å¤„ç†</li>
</ol>
<h3>æ©ç è‡ªæ³¨æ„åŠ› vs æ™®é€šè‡ªæ³¨æ„åŠ›</h3>
<table>
<thead>
<tr>
<th>ç±»å‹</th>
<th>èƒ½çœ‹åˆ°ä»€ä¹ˆ</th>
<th>ç”¨é€”</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ™®é€šè‡ªæ³¨æ„åŠ›</td>
<td>æ•´ä¸ªåºåˆ—</td>
<td>ç¼–ç å™¨</td>
</tr>
<tr>
<td>æ©ç è‡ªæ³¨æ„åŠ›</td>
<td>åªèƒ½çœ‹åˆ°å½“å‰ä½ç½®ä¹‹å‰</td>
<td>è§£ç å™¨</td>
</tr>
</tbody>
</table>
<h2>GPTï¼šç»å…¸çš„è§£ç å™¨æ¨¡å‹</h2>
<p>GPTï¼ˆGenerative Pre-trained Transformerï¼‰æ˜¯æœ€è‘—åçš„è§£ç å™¨æ¨¡å‹ã€‚</p>
<h3>å·¥ä½œæ–¹å¼</h3>
<pre class="hljs"><code>è¾“å…¥: &quot;ä»å‰æœ‰ä¸€åº§&quot;
â†“
GPT è§£ç å™¨å¤„ç†
â†“
é¢„æµ‹ä¸‹ä¸€ä¸ªè¯çš„æ¦‚ç‡åˆ†å¸ƒ
â†“
é€‰æ‹©æ¦‚ç‡æœ€é«˜çš„è¯ï¼ˆæˆ–é‡‡æ ·ï¼‰
â†“
è¾“å‡º: &quot;å±±&quot;
</code></pre>
<h3>ä¸ºä»€ä¹ˆå¼ºå¤§ï¼Ÿ</h3>
<ol>
<li><strong>æµ·é‡é¢„è®­ç»ƒ</strong>ï¼šè¯»è¿‡å¤§é‡æ–‡æœ¬</li>
<li><strong>è‡ªç›‘ç£å­¦ä¹ </strong>ï¼šä¸éœ€è¦äººå·¥æ ‡æ³¨</li>
<li><strong>è§„æ¨¡æ•ˆåº”</strong>ï¼šæ¨¡å‹è¶Šå¤§ï¼Œèƒ½åŠ›è¶Šå¼º</li>
</ol>
<h2>è‡ªå›å½’ç”Ÿæˆè¿‡ç¨‹</h2>
<pre class="hljs"><code>æ­¥éª¤ 1: è¾“å…¥ &quot;ä»Šå¤©&quot; â†’ é¢„æµ‹ &quot;å¤©æ°”&quot;
æ­¥éª¤ 2: è¾“å…¥ &quot;ä»Šå¤©å¤©æ°”&quot; â†’ é¢„æµ‹ &quot;å¾ˆ&quot;
æ­¥éª¤ 3: è¾“å…¥ &quot;ä»Šå¤©å¤©æ°”å¾ˆ&quot; â†’ é¢„æµ‹ &quot;å¥½&quot;
æ­¥éª¤ 4: è¾“å…¥ &quot;ä»Šå¤©å¤©æ°”å¾ˆå¥½&quot; â†’ é¢„æµ‹ &quot;ã€‚&quot;
æ­¥éª¤ 5: é‡åˆ°ç»“æŸç¬¦ï¼Œç”Ÿæˆå®Œæˆ
</code></pre>
<p>è¿™å°±æ˜¯ ChatGPT å›ç­”ä½ é—®é¢˜çš„æ–¹å¼ï¼</p>
<h2>è§£ç å™¨ vs ç¼–ç å™¨</h2>
<table>
<thead>
<tr>
<th>ç‰¹ç‚¹</th>
<th>ç¼–ç å™¨</th>
<th>è§£ç å™¨</th>
</tr>
</thead>
<tbody>
<tr>
<td>çœ‹çš„æ–¹å‘</td>
<td>åŒå‘</td>
<td>å•å‘ï¼ˆåªçœ‹å·¦è¾¹ï¼‰</td>
</tr>
<tr>
<td>è¾“å‡ºæ–¹å¼</td>
<td>ä¸€æ¬¡å…¨éƒ¨è¾“å‡º</td>
<td>é€ä¸ªç”Ÿæˆ</td>
</tr>
<tr>
<td>å…¸å‹ä»»åŠ¡</td>
<td>ç†è§£ã€åˆ†ç±»</td>
<td>ç”Ÿæˆã€å¯¹è¯</td>
</tr>
<tr>
<td>ä»£è¡¨æ¨¡å‹</td>
<td>BERT</td>
<td>GPT</td>
</tr>
</tbody>
</table>
<h2>KV Cacheï¼šåŠ é€Ÿç”Ÿæˆ</h2>
<p>ç”Ÿæˆæ¯ä¸ªæ–°è¯æ—¶ï¼Œä¸éœ€è¦é‡æ–°è®¡ç®—ä¹‹å‰æ‰€æœ‰è¯çš„è¡¨ç¤ºï¼Œåªéœ€&quot;ç¼“å­˜&quot;ä¹‹å‰çš„ K å’Œ Vï¼Œåªè®¡ç®—æ–°è¯çš„ã€‚</p>
<p>è¿™å°±åƒï¼š</p>
<ul>
<li>è€ƒè¯•æ—¶æŠŠä¹‹å‰çš„ç­”æ¡ˆè®°ä¸‹æ¥</li>
<li>æ¯æ¬¡åªè§£æ–°é¢˜ç›®</li>
<li>ä¸ç”¨ä»å¤´åšæ‰€æœ‰é¢˜ç›®</li>
</ul>
<h2>æ€»ç»“</h2>
<table>
<thead>
<tr>
<th>æ¦‚å¿µ</th>
<th>é€šä¿—ç†è§£</th>
</tr>
</thead>
<tbody>
<tr>
<td>è§£ç å™¨</td>
<td>ä¸€ä¸ªå­—ä¸€ä¸ªå­—ç”Ÿæˆå†…å®¹</td>
</tr>
<tr>
<td>è‡ªå›å½’</td>
<td>ç”¨å‰é¢çš„å†…å®¹é¢„æµ‹åé¢</td>
</tr>
<tr>
<td>å› æœæ©ç </td>
<td>ä¸èƒ½çœ‹æœªæ¥çš„å†…å®¹</td>
</tr>
<tr>
<td>KV Cache</td>
<td>ç¼“å­˜ä¹‹å‰çš„è®¡ç®—ç»“æœ</td>
</tr>
</tbody>
</table>
<h2>ä¸‹ä¸€æ­¥</h2>
<ul>
<li>æƒ³äº†è§£æ•°å­¦åŸç†ï¼Ÿé˜…è¯» <a href="advanced-guide.md">æ·±å…¥ç‰ˆ</a></li>
<li>æƒ³çœ‹ä»£ç å®ç°ï¼ŸæŸ¥çœ‹ <code>examples/</code> ç›®å½•</li>
</ul>
<h1>è§£ç å™¨ï¼ˆDecoderï¼‰æ·±å…¥ç‰ˆ</h1>
<blockquote>
<p>é¢å‘æœ‰æœºå™¨å­¦ä¹ åŸºç¡€è¯»è€…çš„æŠ€æœ¯è¯¦è§£</p>
</blockquote>
<h2>æ¦‚è¿°</h2>
<p>Transformer è§£ç å™¨æ˜¯è‡ªå›å½’ç”Ÿæˆæ¨¡å‹çš„æ ¸å¿ƒï¼Œé€šè¿‡å› æœæ³¨æ„åŠ›æœºåˆ¶å®ç°é€ token ç”Ÿæˆã€‚æœ¬æ–‡æ·±å…¥åˆ†æè§£ç å™¨ç»“æ„ã€è‡ªå›å½’ç”Ÿæˆã€KV Cache ç­‰å…³é”®æŠ€æœ¯ã€‚</p>
<h2>Transformer Decoder ç»“æ„</h2>
<h3>å•å±‚ç»“æ„</h3>
<p>æ¯å±‚è§£ç å™¨åŒ…å«ä¸‰ä¸ªå­å±‚ï¼š</p>
<ol>
<li><strong>Masked Multi-Head Self-Attention</strong></li>
<li><strong>Cross-Attention (Encoder-Decoder Attention)</strong></li>
<li><strong>Position-wise Feed-Forward Network</strong></li>
</ol>
<h3>æ•°å­¦å…¬å¼</h3>
<p>å¯¹äºç¬¬ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span></span></span> å±‚ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0489em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8019em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">LayerNorm</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">MaskedMHSA</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mclose">))</span></span></span></span></span></p>
<p><a id="formula-decoder-1"></a>
<a href="#formula-decoder-1-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0489em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8019em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²â€²</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0519em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">LayerNorm</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8019em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0519em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">CrossAttention</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8019em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">c</span><span class="mclose">))</span></span></span></span></span></p>
<p><a id="formula-decoder-2"></a>
<a href="#formula-decoder-2-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0519em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">LayerNorm</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8019em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²â€²</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0519em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">FFN</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8019em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²â€²</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose">))</span></span></span></span></span></p>
<p><a id="formula-decoder-3"></a>
<a href="#formula-decoder-3-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p>å…¶ä¸­ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">c</span></span></span></span> æ˜¯ç¼–ç å™¨çš„è¾“å‡ºã€‚</p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šæ¯å±‚ä¾æ¬¡åšâ€œå› æœè‡ªæ³¨æ„åŠ› â†’ ç¼–ç å™¨äº¤å‰æ³¨æ„åŠ› â†’ å‰é¦ˆç½‘ç»œâ€ï¼Œæ¯æ­¥éƒ½åŠ æ®‹å·®å¹¶åšå±‚å½’ä¸€åŒ–ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9028em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºä¸Šä¸€å±‚è¾“å‡ºï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.035em;vertical-align:-0.2831em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-2.4169em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2831em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-2.4169em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²â€²</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2831em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºä¸­é—´ç»“æœï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">c</span></span></span></span> ä¸ºç¼–ç å™¨è¾“å‡ºã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šæ®‹å·®è¿æ¥ä¿è¯ä¿¡æ¯ä¸ä¸¢å¤±ï¼ŒLayerNorm ç¨³å®šè®­ç»ƒã€‚</li>
</ul>
<h2>Masked Self-Attention</h2>
<h3>å› æœæ©ç </h3>
<p>ç¡®ä¿ä½ç½® <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> åªèƒ½å…³æ³¨ä½ç½® <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> åˆ° <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span>ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord">âˆ’</span><span class="mord">âˆ</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">ifÂ </span></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â‰¤</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal">i</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">ifÂ </span></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><a id="formula-decoder-4"></a>
<a href="#formula-decoder-4-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p>æ³¨æ„åŠ›è®¡ç®—ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Attention</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4684em;vertical-align:-0.95em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.2528em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span></p>
<p><a id="formula-decoder-5"></a>
<a href="#formula-decoder-5-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šç”¨æ©ç  <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span></span> æŠŠæœªæ¥ä½ç½®çš„æ³¨æ„åŠ›åˆ†æ•°è®¾ä¸º <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord">âˆ’</span><span class="mord">âˆ</span></span></span></span>ï¼Œsoftmax åæƒé‡ä¸º 0ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> è¡¨ç¤ºä½ç½® <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> æ˜¯å¦èƒ½çœ‹ä½ç½® <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span>ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºé”®ç»´åº¦ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šç¡®ä¿è§£ç æ—¶åªä½¿ç”¨å†å²ä¿¡æ¯ï¼Œç¬¦åˆè‡ªå›å½’ç”Ÿæˆã€‚</li>
</ul>
<h3>æ³¨æ„åŠ›çŸ©é˜µå½¢çŠ¶</h3>
<p>å¯¹äºä¸€ä¸ªé•¿åº¦ä¸º 4 çš„åºåˆ—ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:4.8em;vertical-align:-2.15em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.65em;"><span class="pstrut" style="height:6.8em;"></span><span style="width:0.667em;height:4.800em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.800em" viewBox="0 0 667 4800"><path d="M403 1759 V84 H666 V0 H319 V1759 v1200 v1759 h347 v-84
H403z M403 1759 V0 H319 V1759 v1200 v1759 h84z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">âˆ’</span><span class="mord">âˆ</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">âˆ’</span><span class="mord">âˆ</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">âˆ’</span><span class="mord">âˆ</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">âˆ’</span><span class="mord">âˆ</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">âˆ’</span><span class="mord">âˆ</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">âˆ’</span><span class="mord">âˆ</span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.65em;"><span class="pstrut" style="height:6.8em;"></span><span style="width:0.667em;height:4.800em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.800em" viewBox="0 0 667 4800"><path d="M347 1759 V0 H0 V84 H263 V1759 v1200 v1759 H0 v84 H347z
M347 1759 V0 H263 V1759 v1200 v1759 h84z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><a id="formula-decoder-6"></a>
<a href="#formula-decoder-6-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p>ç»è¿‡ softmax åï¼Œ<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord">âˆ’</span><span class="mord">âˆ</span></span></span></span> ä½ç½®å˜ä¸º 0ã€‚</p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šçŸ©é˜µä¸Šä¸‰è§’ä¸º <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord">âˆ’</span><span class="mord">âˆ</span></span></span></span>ï¼Œè¡¨ç¤ºç¦æ­¢å…³æ³¨æœªæ¥ä½ç½®ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼šä»¥é•¿åº¦ä¸º 4 çš„åºåˆ—ä¸ºä¾‹ï¼Œè¡Œè¡¨ç¤ºå½“å‰æ­¥ï¼Œåˆ—è¡¨ç¤ºå¯å…³æ³¨çš„å†å²ä½ç½®ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šè®©æ³¨æ„åŠ›æƒé‡åªåˆ†é…ç»™è¿‡å»å’Œå½“å‰ã€‚</li>
</ul>
<h2>è‡ªå›å½’ç”Ÿæˆ</h2>
<h3>ç”Ÿæˆè¿‡ç¨‹</h3>
<p>ç»™å®šè¾“å…¥åºåˆ— <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>ï¼Œé¢„æµ‹ä¸‹ä¸€ä¸ª tokenï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mord">âˆ£</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><a id="formula-decoder-7"></a>
<a href="#formula-decoder-7-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p>å…¶ä¸­ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> æ˜¯ä½ç½® <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span> çš„éšè—çŠ¶æ€ã€‚</p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šç”¨çº¿æ€§å±‚ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span></span></span> æŠŠéšè—çŠ¶æ€æ˜ å°„åˆ°è¯è¡¨åˆ†æ•°ï¼Œå†ç”¨ softmax å¾—åˆ°ä¸‹ä¸€ä¸ª token çš„æ¦‚ç‡åˆ†å¸ƒã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºå½“å‰æ­¥è¡¨ç¤ºï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span></span></span> ä¸ºè¾“å‡ºæŠ•å½±çŸ©é˜µã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šæŠŠæ¨¡å‹å†…éƒ¨è¡¨ç¤ºè½¬æˆå¯é‡‡æ ·çš„è¯æ¦‚ç‡ã€‚</li>
</ul>
<h3>å®Œæ•´åºåˆ—æ¦‚ç‡</h3>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">â€¦</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.0954em;vertical-align:-1.2671em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8829em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.2671em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">âˆ£</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight">t</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><a id="formula-decoder-8"></a>
<a href="#formula-decoder-8-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šæ•´å¥æ¦‚ç‡ç­‰äºæ¯ä¸€æ­¥æ¡ä»¶æ¦‚ç‡çš„è¿ä¹˜ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span> ä¸ºåºåˆ—é•¿åº¦ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight">t</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºå†å²ä¸Šä¸‹æ–‡ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šä½“ç°è‡ªå›å½’åˆ†è§£å‡è®¾ï¼Œé€æ­¥ç”Ÿæˆæ•´å¥ã€‚</li>
</ul>
<h3>è§£ç ç­–ç•¥</h3>
<h4>Greedy Decoding</h4>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.45em;vertical-align:-0.7em;"></span><span class="mop">ar<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4306em;"><span style="top:-2.4em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">max</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.7em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord">âˆ£</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><a id="formula-decoder-9"></a>
<a href="#formula-decoder-9-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šæ¯ä¸€æ­¥éƒ½é€‰å–æ¦‚ç‡æœ€é«˜çš„ tokenã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mop">ar<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">max</span></span></span></span> è¡¨ç¤ºå–å¾—ä½¿æ¦‚ç‡æœ€å¤§çš„ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span>ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šç¡®å®šæ€§è¾“å‡ºï¼Œä½†å¯èƒ½ç¼ºä¹å¤šæ ·æ€§ã€‚</li>
</ul>
<h4>Beam Search</h4>
<p>ç»´æŠ¤ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> ä¸ªå€™é€‰åºåˆ—ï¼Œæ¯æ­¥æ‰©å±•å¹¶ä¿ç•™ top-kã€‚</p>
<h4>Sampling</h4>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆ¼</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord">âˆ£</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><a id="formula-decoder-10"></a>
<a href="#formula-decoder-10-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šæŒ‰ç…§æ¦‚ç‡åˆ†å¸ƒéšæœºé‡‡æ ·ä¸‹ä¸€ä¸ª tokenã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"></span><span class="mrel">âˆ¼</span></span></span></span> è¡¨ç¤ºâ€œæœä»è¯¥åˆ†å¸ƒé‡‡æ ·â€ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šæé«˜å¤šæ ·æ€§ï¼Œä½†å¯èƒ½å¼•å…¥å™ªå£°ã€‚</li>
</ul>
<h4>Temperature Sampling</h4>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">p</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord">âˆ£</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4127em;vertical-align:-0.9857em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">âˆ‘</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1783em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6828em;"><span style="top:-2.786em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">exp</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6779em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop">exp</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mclose">)</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.9857em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><a id="formula-decoder-11"></a>
<a href="#formula-decoder-11-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<ul>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>ï¼šæ›´éšæœº</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>ï¼šæ›´ç¡®å®š</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â†’</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span>ï¼šè¶‹è¿‘ greedy</li>
</ul>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šç”¨æ¸©åº¦ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span> è°ƒæ•´åˆ†å¸ƒçš„å°–é”ç¨‹åº¦ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span> è¶Šå¤§ï¼Œåˆ†å¸ƒè¶Šå¹³æ»‘ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span> è¶Šå°ï¼Œåˆ†å¸ƒè¶Šå°–é”ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šæ§åˆ¶ç”Ÿæˆçš„éšæœºæ€§ä¸ç¡®å®šæ€§ä¹‹é—´çš„å¹³è¡¡ã€‚</li>
</ul>
<h2>KV Cache</h2>
<h3>é—®é¢˜</h3>
<p>ç”Ÿæˆç¬¬ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span> ä¸ª token æ—¶ï¼Œéœ€è¦é‡æ–°è®¡ç®—æ‰€æœ‰ä¹‹å‰ token çš„ K å’Œ Vã€‚</p>
<h3>è§£å†³æ–¹æ¡ˆ</h3>
<p>ç¼“å­˜ä¹‹å‰è®¡ç®—è¿‡çš„ K å’Œ Vï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">â€¦</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span></span></p>
<p><a id="formula-decoder-12"></a>
<a href="#formula-decoder-12-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">â€¦</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span></span></p>
<p><a id="formula-decoder-13"></a>
<a href="#formula-decoder-13-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p>æ¯æ¬¡åªéœ€è®¡ç®—æ–° token çš„ Q, K, Vï¼Œç„¶åæ›´æ–°ç¼“å­˜ã€‚</p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šæŠŠå†å²æ‰€æœ‰æ­¥çš„é”®å’Œå€¼æ‹¼æ¥æˆç¼“å­˜ï¼Œé¿å…é‡å¤è®¡ç®—ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºç¬¬ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> æ­¥è®¡ç®—å¾—åˆ°çš„é”®å’Œå€¼ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šæ—¶é—´æ¢ç©ºé—´ï¼Œå°†é‡å¤è®¡ç®—å˜æˆç¼“å­˜è¯»å–ã€‚</li>
</ul>
<h3>å®ç°ç»†èŠ‚</h3>
<pre class="hljs"><code><span class="hljs-comment"># åˆå§‹åŒ–ç¼“å­˜</span>
past_key_values = <span class="hljs-literal">None</span>

<span class="hljs-keyword">for</span> step <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(max_length):
    <span class="hljs-comment"># åªå¤„ç†æœ€åä¸€ä¸ª token</span>
    <span class="hljs-keyword">if</span> past_key_values <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
        input_ids = input_ids[:, -<span class="hljs-number">1</span>:]

    <span class="hljs-comment"># å‰å‘ä¼ æ’­ï¼Œä½¿ç”¨å’Œæ›´æ–°ç¼“å­˜</span>
    outputs = model(input_ids, past_key_values=past_key_values)
    past_key_values = outputs.past_key_values

    <span class="hljs-comment"># é‡‡æ ·ä¸‹ä¸€ä¸ª token</span>
    next_token = sample(outputs.logits)
    input_ids = torch.cat([input_ids, next_token], dim=-<span class="hljs-number">1</span>)
</code></pre>
<h3>å†…å­˜åˆ†æ</h3>
<p>KV Cache çš„å†…å­˜å ç”¨ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">s</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><a id="formula-decoder-14"></a>
<a href="#formula-decoder-14-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p>å…¶ä¸­ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">L</span></span></span></span> æ˜¯å±‚æ•°ï¼Œ<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> æ˜¯ batch sizeã€‚</p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šKV Cache çš„å†…å­˜å¤§å°ä¸å±‚æ•°ã€æ‰¹å¤§å°ã€å¤´æ•°ã€æ¯å¤´ç»´åº¦åŠåºåˆ—é•¿åº¦æˆæ­£æ¯”ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºä¸Šä¸‹æ–‡é•¿åº¦ï¼Œ<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºç”Ÿæˆé•¿åº¦ï¼›å‰é¢çš„ 2 è¡¨ç¤º K å’Œ V ä¸¤ä»½ç¼“å­˜ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šåºåˆ—è¶Šé•¿æˆ–æ¨¡å‹è¶Šå¤§ï¼Œç¼“å­˜å ç”¨è¶Šé«˜ã€‚</li>
</ul>
<h2>GPT æ¶æ„</h2>
<h3>æ¨¡å‹é…ç½®</h3>
<table>
<thead>
<tr>
<th>æ¨¡å‹</th>
<th>å±‚æ•°</th>
<th>éšè—ç»´åº¦</th>
<th>æ³¨æ„åŠ›å¤´</th>
<th>å‚æ•°é‡</th>
</tr>
</thead>
<tbody>
<tr>
<td>GPT-2 Small</td>
<td>12</td>
<td>768</td>
<td>12</td>
<td>124M</td>
</tr>
<tr>
<td>GPT-2 Medium</td>
<td>24</td>
<td>1024</td>
<td>16</td>
<td>355M</td>
</tr>
<tr>
<td>GPT-2 Large</td>
<td>36</td>
<td>1280</td>
<td>20</td>
<td>774M</td>
</tr>
<tr>
<td>GPT-2 XL</td>
<td>48</td>
<td>1600</td>
<td>25</td>
<td>1.5B</td>
</tr>
<tr>
<td>GPT-3</td>
<td>96</td>
<td>12288</td>
<td>96</td>
<td>175B</td>
</tr>
</tbody>
</table>
<h3>è®­ç»ƒç›®æ ‡</h3>
<p>è¯­è¨€å»ºæ¨¡æŸå¤±ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathcal">L</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.0954em;vertical-align:-1.2671em;"></span><span class="mord">âˆ’</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8829em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.2671em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">âˆ£</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight">t</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><a id="formula-decoder-15"></a>
<a href="#formula-decoder-15-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šå¯¹æ¯ä¸€æ­¥çš„æ­£ç¡® token æ¦‚ç‡å–å¯¹æ•°å¹¶æ±‚å’Œï¼Œå–è´Ÿå·å¾—åˆ°æŸå¤±ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">âˆ£</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight">t</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> ä¸ºæ¨¡å‹åœ¨ç¬¬ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span> æ­¥å¯¹çœŸå® token çš„æ¦‚ç‡ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šæ¦‚ç‡è¶Šå¤§ï¼ŒæŸå¤±è¶Šå°ï¼›è®­ç»ƒç›®æ ‡æ˜¯æœ€å¤§åŒ–çœŸå®åºåˆ—æ¦‚ç‡ã€‚</li>
</ul>
<h2>Cross-Attentionï¼ˆç”¨äº Encoder-Decoderï¼‰</h2>
<p>å½“è§£ç å™¨ä¸ç¼–ç å™¨é…åˆæ—¶ï¼ˆå¦‚æœºå™¨ç¿»è¯‘ï¼‰ï¼š</p>
<ul>
<li><strong>Query</strong> æ¥è‡ªè§£ç å™¨</li>
<li><strong>Key, Value</strong> æ¥è‡ªç¼–ç å™¨</li>
</ul>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">CrossAttention</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">e</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">e</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4684em;vertical-align:-0.95em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.2528em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.453em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">e</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">e</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p><a id="formula-decoder-16"></a>
<a href="#formula-decoder-16-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p>è¿™å…è®¸è§£ç å™¨&quot;æŸ¥çœ‹&quot;ç¼–ç å™¨çš„è¡¨ç¤ºã€‚</p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šè§£ç å™¨æŸ¥è¯¢ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ç¼–ç å™¨é”® <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">e</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> è®¡ç®—ç›¸ä¼¼åº¦ï¼Œå¹¶å¯¹ç¼–ç å™¨å€¼ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">e</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> åŠ æƒæ±‚å’Œã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> æ¥è‡ªè§£ç å™¨ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">e</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">e</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> æ¥è‡ªç¼–ç å™¨ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºé”®ç»´åº¦ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šåœ¨ç”Ÿæˆæ—¶åŠ¨æ€å¯¹é½æºåºåˆ—ä¿¡æ¯ã€‚</li>
</ul>
<h2>æ¨ç†ä¼˜åŒ–</h2>
<h3>1. æ‰¹å¤„ç†</h3>
<p>åŒæ—¶å¤„ç†å¤šä¸ªè¯·æ±‚ï¼Œæé«˜ GPU åˆ©ç”¨ç‡ã€‚</p>
<h3>2. è¿ç»­æ‰¹å¤„ç†</h3>
<p>åŠ¨æ€è°ƒæ•´æ‰¹å¤§å°ï¼Œä¸ç­‰å¾…æ‰€æœ‰åºåˆ—å®Œæˆã€‚</p>
<h3>3. æŠ•æœºè§£ç </h3>
<p>ç”¨å°æ¨¡å‹å¿«é€Ÿç”Ÿæˆå€™é€‰ï¼Œå¤§æ¨¡å‹éªŒè¯ã€‚</p>
<h3>4. é‡åŒ–</h3>
<p>INT8/INT4 é‡åŒ–å‡å°‘å†…å­˜å’ŒåŠ é€Ÿæ¨ç†ã€‚</p>
<h2>å‚è€ƒæ–‡çŒ®</h2>
<ol>
<li>Vaswani et al. (2017). <em>Attention Is All You Need</em></li>
<li>Radford et al. (2018). <em>Improving Language Understanding by Generative Pre-Training</em></li>
<li>Radford et al. (2019). <em>Language Models are Unsupervised Multitask Learners</em></li>
<li>Brown et al. (2020). <em>Language Models are Few-Shot Learners</em></li>
<li>Leviathan et al. (2023). <em>Fast Inference from Transformers via Speculative Decoding</em></li>
</ol>
<h1>Decoder æµç¨‹å›¾è§£</h1>
<blockquote>
<p>é€šè¿‡å¯è§†åŒ–å›¾è¡¨ç†è§£ Transformer Decoder çš„å·¥ä½œæµç¨‹</p>
</blockquote>
<h2>Decoder æ•´ä½“æ¶æ„</h2>
<p><div class="mermaid">flowchart TB
    A["è¾“å…¥ Embedding"] --&gt; B["ä½ç½®ç¼–ç "]
    B --&gt; C["Masked Self-Attention"]
    C --&gt; D["Add &amp; Norm"]
    D --&gt; E["Cross-Attention&lt;br/&gt;(å¯é€‰)"]
    E --&gt; F["Add &amp; Norm"]
    F --&gt; G["Feed Forward"]
    G --&gt; H["Add &amp; Norm"]
    H --&gt; I["è¾“å‡º"]

    style I fill:#c8e6c9</div></p>
<h2>å› æœæ©ç æœºåˆ¶</h2>
<p><div class="mermaid">flowchart TB
    subgraph æ©ç å‰
        A1["ä½ç½®1"] --&gt; B1["ä½ç½®2"] --&gt; C1["ä½ç½®3"] --&gt; D1["ä½ç½®4"]
    end

    subgraph æ©ç å
        A2["ä½ç½®1: âœ“ âœ“ âœ— âœ—"]
        B2["ä½ç½®2: âœ“ âœ“ âœ“ âœ—"]
        C2["ä½ç½®3: âœ“ âœ“ âœ“ âœ“"]
    end

    D["åªèƒ½çœ‹åˆ°å½“å‰ä½ç½®å’Œä¹‹å‰çš„å†…å®¹"]

    style A2 fill:#c8e6c9
    style B2 fill:#c8e6c9
    style C2 fill:#c8e6c9</div></p>
<h2>è‡ªå›å½’ç”Ÿæˆæµç¨‹</h2>
<p><div class="mermaid">flowchart LR
    A["è¾“å…¥: &lt;s&gt;"] --&gt; B["ç”Ÿæˆ: ä½ "]
    B --&gt; C["è¾“å…¥: &lt;s&gt; ä½ "]
    C --&gt; D["ç”Ÿæˆ: å¥½"]
    D --&gt; E["è¾“å…¥: &lt;s&gt; ä½  å¥½"]
    E --&gt; F["ç”Ÿæˆ: !"]

    G["é€æ­¥ç”Ÿæˆï¼Œæ¯æ¬¡ä¸€ä¸ª token"]

    style F fill:#c8e6c9</div></p>
<h2>KV Cache å·¥ä½œåŸç†</h2>
<p><div class="mermaid">flowchart TB
    subgraph ç¬¬1æ­¥
        A1["è¾“å…¥: ä½ "] --&gt; B1["è®¡ç®— K1, V1&lt;br/&gt;ç¼“å­˜"]
    end

    subgraph ç¬¬2æ­¥
        A2["è¾“å…¥: å¥½"] --&gt; B2["å¤ç”¨ K1,V1&lt;br/&gt;åªè®¡ç®— K2,V2"]
    end

    subgraph ç¬¬3æ­¥
        A3["è¾“å…¥: !"] --&gt; B3["å¤ç”¨ K1-K2,V1-V2&lt;br/&gt;åªè®¡ç®— K3,V3"]
    end

    style B3 fill:#c8e6c9</div></p>
<h2>GPT Decoder ç»“æ„</h2>
<p><div class="mermaid">flowchart TB
    A["Token IDs"] --&gt; B["Token Embedding"]
    A --&gt; C["Position Embedding"]

    B --&gt; D["ç›¸åŠ "]
    C --&gt; D

    D --&gt; E["Transformer Block x N"]
    E --&gt; F["Layer Norm"]
    F --&gt; G["çº¿æ€§å±‚ â†’ è¯è¡¨"]

    G --&gt; H["Softmax â†’ æ¦‚ç‡"]
    H --&gt; I["é‡‡æ ·ä¸‹ä¸€ä¸ª token"]

    style I fill:#c8e6c9</div></p>
<h2>Cross-Attention (Encoder-Decoder)</h2>
<p><div class="mermaid">flowchart TB
    subgraph Decoder
        A["Decoder è¾“å…¥"] --&gt; B["Masked Self-Attention"]
        B --&gt; C["Cross-Attention"]
    end

    subgraph Encoder
        E["Encoder è¾“å‡º&lt;br/&gt;K, V"]
    end

    C --&gt; D["Q æ¥è‡ª Decoder&lt;br/&gt;K,V æ¥è‡ª Encoder"]

    D --&gt; F["èåˆç¼–ç å™¨ä¿¡æ¯"]

    style F fill:#c8e6c9</div></p>
<h2>å›¾è§£è¯´æ˜</h2>
<h3>å…³é”®ç‰¹æ€§</h3>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>å› æœæ©ç </td>
<td>åªèƒ½çœ‹åˆ°ä¹‹å‰çš„å†…å®¹</td>
</tr>
<tr>
<td>è‡ªå›å½’</td>
<td>é€æ­¥ç”Ÿæˆ</td>
</tr>
<tr>
<td>KV Cache</td>
<td>ç¼“å­˜é¿å…é‡å¤è®¡ç®—</td>
</tr>
</tbody>
</table>
<h3>å…¸å‹é…ç½®</h3>
<table>
<thead>
<tr>
<th>æ¨¡å‹</th>
<th>å±‚æ•°</th>
<th>éšè—ç»´åº¦</th>
<th>æ³¨æ„åŠ›å¤´</th>
</tr>
</thead>
<tbody>
<tr>
<td>GPT-2 Small</td>
<td>12</td>
<td>768</td>
<td>12</td>
</tr>
<tr>
<td>GPT-2 Medium</td>
<td>24</td>
<td>1024</td>
<td>16</td>
</tr>
<tr>
<td>GPT-3</td>
<td>96</td>
<td>12288</td>
<td>96</td>
</tr>
</tbody>
</table>
<h3>åº”ç”¨åœºæ™¯</h3>
<ul>
<li>æ–‡æœ¬ç”Ÿæˆ</li>
<li>ä»£ç è¡¥å…¨</li>
<li>å¯¹è¯ç³»ç»Ÿ</li>
<li>ç¿»è¯‘ (Encoder-Decoder)</li>
</ul>
<div class="code-appendix page-break"><h2>é™„å½•ï¼šä»£ç ç¤ºä¾‹</h2><div class="code-file"><h3>decoder_example.py</h3><pre class="hljs"><code><span class="hljs-string">&quot;&quot;&quot;
Transformer Decoder ç¤ºä¾‹ä»£ç  / Transformer Decoder Example Code
===============================================================

æœ¬ç¤ºä¾‹å±•ç¤º Transformer Decoder çš„åŸç†å’Œå®ç°ã€‚
This example demonstrates the principle and implementation of Transformer Decoder.

ä¾èµ–å®‰è£… / Dependencies:
    pip install torch matplotlib numpy
&quot;&quot;&quot;</span>

<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn
<span class="hljs-keyword">import</span> torch.nn.functional <span class="hljs-keyword">as</span> F
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 1. å› æœæ©ç  / Causal Mask</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_causal_mask</span>(<span class="hljs-params">seq_len</span>):
    <span class="hljs-string">&quot;&quot;&quot;
    åˆ›å»ºå› æœæ©ç ï¼ˆä¸Šä¸‰è§’çŸ©é˜µï¼‰
    Create causal mask (upper triangular matrix)

    ä½ç½® i åªèƒ½çœ‹åˆ°ä½ç½® 0 åˆ° i-1
    Position i can only see positions 0 to i-1
    &quot;&quot;&quot;</span>
    <span class="hljs-comment"># åˆ›å»ºä¸‹ä¸‰è§’çŸ©é˜µï¼ˆåŒ…å«å¯¹è§’çº¿ï¼‰</span>
    mask = torch.tril(torch.ones(seq_len, seq_len))
    <span class="hljs-comment"># è½¬æ¢ä¸º attention mask æ ¼å¼: 0 è¡¨ç¤ºè¦ mask</span>
    mask = mask == <span class="hljs-number">0</span>  <span class="hljs-comment"># True è¡¨ç¤ºè¦ mask çš„ä½ç½®</span>
    <span class="hljs-keyword">return</span> mask

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 2. Masked Multi-Head Self-Attention</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MaskedMultiHeadAttention</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;å¸¦å› æœæ©ç çš„å¤šå¤´è‡ªæ³¨æ„åŠ› / Masked Multi-Head Self-Attention&quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, d_model, num_heads, dropout=<span class="hljs-number">0.1</span></span>):
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-keyword">assert</span> d_model % num_heads == <span class="hljs-number">0</span>

        <span class="hljs-variable language_">self</span>.d_k = d_model // num_heads
        <span class="hljs-variable language_">self</span>.num_heads = num_heads

        <span class="hljs-variable language_">self</span>.W_q = nn.Linear(d_model, d_model)
        <span class="hljs-variable language_">self</span>.W_k = nn.Linear(d_model, d_model)
        <span class="hljs-variable language_">self</span>.W_v = nn.Linear(d_model, d_model)
        <span class="hljs-variable language_">self</span>.W_o = nn.Linear(d_model, d_model)

        <span class="hljs-variable language_">self</span>.dropout = nn.Dropout(dropout)
        <span class="hljs-variable language_">self</span>.scale = <span class="hljs-variable language_">self</span>.d_k ** -<span class="hljs-number">0.5</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x, mask=<span class="hljs-literal">None</span></span>):
        batch_size, seq_len, _ = x.shape

        <span class="hljs-comment"># è®¡ç®— Q, K, V</span>
        Q = <span class="hljs-variable language_">self</span>.W_q(x).view(batch_size, seq_len, <span class="hljs-variable language_">self</span>.num_heads, <span class="hljs-variable language_">self</span>.d_k).transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)
        K = <span class="hljs-variable language_">self</span>.W_k(x).view(batch_size, seq_len, <span class="hljs-variable language_">self</span>.num_heads, <span class="hljs-variable language_">self</span>.d_k).transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)
        V = <span class="hljs-variable language_">self</span>.W_v(x).view(batch_size, seq_len, <span class="hljs-variable language_">self</span>.num_heads, <span class="hljs-variable language_">self</span>.d_k).transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)

        <span class="hljs-comment"># æ³¨æ„åŠ›åˆ†æ•°</span>
        scores = torch.matmul(Q, K.transpose(-<span class="hljs-number">2</span>, -<span class="hljs-number">1</span>)) * <span class="hljs-variable language_">self</span>.scale

        <span class="hljs-comment"># åº”ç”¨å› æœæ©ç </span>
        <span class="hljs-keyword">if</span> mask <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            <span class="hljs-comment"># mask: [seq_len, seq_len] -&gt; æ‰©å±•åˆ° [batch, num_heads, seq_len, seq_len]</span>
            scores = scores.masked_fill(mask.unsqueeze(<span class="hljs-number">0</span>).unsqueeze(<span class="hljs-number">0</span>), <span class="hljs-built_in">float</span>(<span class="hljs-string">&#x27;-inf&#x27;</span>))

        <span class="hljs-comment"># Softmax</span>
        attn = F.softmax(scores, dim=-<span class="hljs-number">1</span>)
        attn = <span class="hljs-variable language_">self</span>.dropout(attn)

        <span class="hljs-comment"># åŠ æƒæ±‚å’Œ</span>
        output = torch.matmul(attn, V)
        output = output.transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>).contiguous().view(batch_size, seq_len, -<span class="hljs-number">1</span>)
        output = <span class="hljs-variable language_">self</span>.W_o(output)

        <span class="hljs-keyword">return</span> output, attn

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 3. Decoder Layer</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DecoderLayer</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;
    Transformer Decoder Layer
    åŒ…å« Masked Self-Attention å’Œ FFN
    &quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, d_model, num_heads, d_ff, dropout=<span class="hljs-number">0.1</span></span>):
        <span class="hljs-built_in">super</span>().__init__()

        <span class="hljs-comment"># Pre-LN</span>
        <span class="hljs-variable language_">self</span>.norm1 = nn.LayerNorm(d_model)
        <span class="hljs-variable language_">self</span>.norm2 = nn.LayerNorm(d_model)

        <span class="hljs-comment"># Sub-layers</span>
        <span class="hljs-variable language_">self</span>.attention = MaskedMultiHeadAttention(d_model, num_heads, dropout)
        <span class="hljs-variable language_">self</span>.ffn = nn.Sequential(
            nn.Linear(d_model, d_ff),
            nn.GELU(),
            nn.Linear(d_ff, d_model),
            nn.Dropout(dropout)
        )

        <span class="hljs-variable language_">self</span>.dropout = nn.Dropout(dropout)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x, mask=<span class="hljs-literal">None</span></span>):
        <span class="hljs-comment"># Masked Self-Attention</span>
        residual = x
        x = <span class="hljs-variable language_">self</span>.norm1(x)
        x, attn = <span class="hljs-variable language_">self</span>.attention(x, mask)
        x = residual + <span class="hljs-variable language_">self</span>.dropout(x)

        <span class="hljs-comment"># FFN</span>
        residual = x
        x = <span class="hljs-variable language_">self</span>.norm2(x)
        x = <span class="hljs-variable language_">self</span>.ffn(x)
        x = residual + x

        <span class="hljs-keyword">return</span> x, attn

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 4. å®Œæ•´çš„ Transformer Decoder</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">TransformerDecoder</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;
    å®Œæ•´çš„ Transformer Decoder
    ç”¨äºè‡ªå›å½’ç”Ÿæˆ
    &quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, vocab_size, d_model, num_heads, d_ff, num_layers,
                 max_seq_len=<span class="hljs-number">512</span>, dropout=<span class="hljs-number">0.1</span></span>):
        <span class="hljs-built_in">super</span>().__init__()

        <span class="hljs-variable language_">self</span>.d_model = d_model

        <span class="hljs-comment"># Embeddings</span>
        <span class="hljs-variable language_">self</span>.token_embedding = nn.Embedding(vocab_size, d_model)
        <span class="hljs-variable language_">self</span>.position_embedding = nn.Embedding(max_seq_len, d_model)
        <span class="hljs-variable language_">self</span>.dropout = nn.Dropout(dropout)

        <span class="hljs-comment"># Decoder Layers</span>
        <span class="hljs-variable language_">self</span>.layers = nn.ModuleList([
            DecoderLayer(d_model, num_heads, d_ff, dropout)
            <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_layers)
        ])

        <span class="hljs-comment"># Final LayerNorm</span>
        <span class="hljs-variable language_">self</span>.norm = nn.LayerNorm(d_model)

        <span class="hljs-comment"># Output projection (è¯­è¨€æ¨¡å‹å¤´)</span>
        <span class="hljs-variable language_">self</span>.lm_head = nn.Linear(d_model, vocab_size, bias=<span class="hljs-literal">False</span>)

        <span class="hljs-comment"># Weight tying (å…±äº«è¯åµŒå…¥å’Œè¾“å‡ºå±‚æƒé‡)</span>
        <span class="hljs-variable language_">self</span>.lm_head.weight = <span class="hljs-variable language_">self</span>.token_embedding.weight

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-string">&quot;&quot;&quot;
        å‚æ•° / Args:
            x: [batch, seq_len] - token indices

        è¿”å› / Returns:
            logits: [batch, seq_len, vocab_size]
            attentions: list of attention weights
        &quot;&quot;&quot;</span>
        batch_size, seq_len = x.shape

        <span class="hljs-comment"># Token + Position Embeddings</span>
        positions = torch.arange(seq_len, device=x.device).unsqueeze(<span class="hljs-number">0</span>)
        x = <span class="hljs-variable language_">self</span>.token_embedding(x) + <span class="hljs-variable language_">self</span>.position_embedding(positions)
        x = <span class="hljs-variable language_">self</span>.dropout(x)

        <span class="hljs-comment"># åˆ›å»ºå› æœæ©ç </span>
        causal_mask = create_causal_mask(seq_len).to(x.device)

        <span class="hljs-comment"># é€šè¿‡æ‰€æœ‰ Decoder å±‚</span>
        attentions = []
        <span class="hljs-keyword">for</span> layer <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.layers:
            x, attn = layer(x, causal_mask)
            attentions.append(attn)

        <span class="hljs-comment"># æœ€ç»ˆ LayerNorm</span>
        x = <span class="hljs-variable language_">self</span>.norm(x)

        <span class="hljs-comment"># è¾“å‡º logits</span>
        logits = <span class="hljs-variable language_">self</span>.lm_head(x)

        <span class="hljs-keyword">return</span> logits, attentions

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 5. æµ‹è¯• Decoder / Test Decoder</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Transformer Decoder æµ‹è¯• / Transformer Decoder Test&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

torch.manual_seed(<span class="hljs-number">42</span>)

<span class="hljs-comment"># é…ç½®</span>
vocab_size = <span class="hljs-number">1000</span>
d_model = <span class="hljs-number">256</span>
num_heads = <span class="hljs-number">8</span>
d_ff = <span class="hljs-number">1024</span>
num_layers = <span class="hljs-number">6</span>
max_seq_len = <span class="hljs-number">128</span>
batch_size = <span class="hljs-number">2</span>
seq_len = <span class="hljs-number">16</span>

<span class="hljs-comment"># åˆ›å»º Decoder</span>
decoder = TransformerDecoder(
    vocab_size=vocab_size,
    d_model=d_model,
    num_heads=num_heads,
    d_ff=d_ff,
    num_layers=num_layers,
    max_seq_len=max_seq_len
)

<span class="hljs-comment"># åˆ›å»ºè¾“å…¥</span>
x = torch.randint(<span class="hljs-number">0</span>, vocab_size, (batch_size, seq_len))

<span class="hljs-comment"># å‰å‘ä¼ æ’­</span>
logits, attentions = decoder(x)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\né…ç½® / Configuration:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  vocab_size: <span class="hljs-subst">{vocab_size}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  d_model: <span class="hljs-subst">{d_model}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  num_heads: <span class="hljs-subst">{num_heads}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  num_layers: <span class="hljs-subst">{num_layers}</span>&quot;</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nè¾“å…¥å½¢çŠ¶ / Input shape: <span class="hljs-subst">{x.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;è¾“å‡º logits å½¢çŠ¶ / Output logits shape: <span class="hljs-subst">{logits.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;æ³¨æ„åŠ›å±‚æ•° / Number of attention layers: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(attentions)}</span>&quot;</span>)

<span class="hljs-comment"># å‚æ•°ç»Ÿè®¡</span>
total_params = <span class="hljs-built_in">sum</span>(p.numel() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> decoder.parameters())
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\næ€»å‚æ•°é‡ / Total parameters: <span class="hljs-subst">{total_params:,}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 6. å¯è§†åŒ–å› æœæ©ç å’Œæ³¨æ„åŠ› / Visualize Causal Mask and Attention</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;å› æœæ©ç å¯è§†åŒ– / Causal Mask Visualization&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-comment"># å¯è§†åŒ–å› æœæ©ç </span>
causal_mask = create_causal_mask(<span class="hljs-number">8</span>)

plt.figure(figsize=(<span class="hljs-number">12</span>, <span class="hljs-number">4</span>))

plt.subplot(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>)
plt.imshow(causal_mask.numpy(), cmap=<span class="hljs-string">&#x27;RdBu&#x27;</span>)
plt.title(<span class="hljs-string">&#x27;Causal Mask\n(True = masked)&#x27;</span>)
plt.xlabel(<span class="hljs-string">&#x27;Key Position&#x27;</span>)
plt.ylabel(<span class="hljs-string">&#x27;Query Position&#x27;</span>)

<span class="hljs-comment"># å¯è§†åŒ–æ³¨æ„åŠ›çŸ©é˜µï¼ˆåº”ç”¨æ©ç åï¼‰</span>
plt.subplot(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>)
attn_example = attentions[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>, <span class="hljs-number">0</span>].detach().numpy()  <span class="hljs-comment"># ç¬¬ä¸€ä¸ªæ ·æœ¬ç¬¬ä¸€ä¸ªå¤´</span>
plt.imshow(attn_example[:<span class="hljs-number">8</span>, :<span class="hljs-number">8</span>], cmap=<span class="hljs-string">&#x27;Blues&#x27;</span>)
plt.title(<span class="hljs-string">&#x27;Attention Weights\n(with Causal Mask)&#x27;</span>)
plt.xlabel(<span class="hljs-string">&#x27;Key Position&#x27;</span>)
plt.ylabel(<span class="hljs-string">&#x27;Query Position&#x27;</span>)

<span class="hljs-comment"># æ£€æŸ¥æ³¨æ„åŠ›æ˜¯å¦æ˜¯å› æœçš„</span>
plt.subplot(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>)
<span class="hljs-comment"># æ£€æŸ¥ä¸Šä¸‰è§’æ˜¯å¦å…¨ä¸º0</span>
is_causal = (attn_example[:<span class="hljs-number">8</span>, :<span class="hljs-number">8</span>] &lt; <span class="hljs-number">1e-6</span>)
plt.imshow(is_causal, cmap=<span class="hljs-string">&#x27;Greens&#x27;</span>)
plt.title(<span class="hljs-string">&#x27;Causal Check\n(Green = ~0)&#x27;</span>)
plt.xlabel(<span class="hljs-string">&#x27;Key Position&#x27;</span>)
plt.ylabel(<span class="hljs-string">&#x27;Query Position&#x27;</span>)

plt.tight_layout()
plt.savefig(<span class="hljs-string">&#x27;/tmp/decoder_causal_attention.png&#x27;</span>, dpi=<span class="hljs-number">150</span>, bbox_inches=<span class="hljs-string">&#x27;tight&#x27;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nå› æœæ³¨æ„åŠ›å›¾åƒå·²ä¿å­˜è‡³ / Image saved to: /tmp/decoder_causal_attention.png&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 7. è‡ªå›å½’ç”Ÿæˆ / Autoregressive Generation</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;è‡ªå›å½’ç”Ÿæˆæ¼”ç¤º / Autoregressive Generation Demo&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate</span>(<span class="hljs-params">model, start_tokens, max_new_tokens=<span class="hljs-number">20</span>, temperature=<span class="hljs-number">1.0</span></span>):
    <span class="hljs-string">&quot;&quot;&quot;
    è‡ªå›å½’ç”Ÿæˆæ–‡æœ¬ / Autoregressive text generation

    å‚æ•° / Args:
        model: è¯­è¨€æ¨¡å‹
        start_tokens: èµ·å§‹ token [batch, seq_len]
        max_new_tokens: æœ€å¤§ç”Ÿæˆ token æ•°
        temperature: é‡‡æ ·æ¸©åº¦

    è¿”å› / Returns:
        generated: ç”Ÿæˆçš„ token åºåˆ—
    &quot;&quot;&quot;</span>
    model.<span class="hljs-built_in">eval</span>()
    generated = start_tokens.clone()

    <span class="hljs-keyword">with</span> torch.no_grad():
        <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(max_new_tokens):
            <span class="hljs-comment"># è·å–æœ€åä¸€ä¸ªä½ç½®çš„ logits</span>
            logits, _ = model(generated)
            next_token_logits = logits[:, -<span class="hljs-number">1</span>, :] / temperature

            <span class="hljs-comment"># é‡‡æ ·ä¸‹ä¸€ä¸ª token</span>
            probs = F.softmax(next_token_logits, dim=-<span class="hljs-number">1</span>)
            next_token = torch.multinomial(probs, num_samples=<span class="hljs-number">1</span>)

            <span class="hljs-comment"># æ·»åŠ åˆ°åºåˆ—</span>
            generated = torch.cat([generated, next_token], dim=<span class="hljs-number">1</span>)

    <span class="hljs-keyword">return</span> generated

<span class="hljs-comment"># ä»å•ä¸ª token å¼€å§‹ç”Ÿæˆ</span>
start_token = torch.tensor([[<span class="hljs-number">1</span>]])  <span class="hljs-comment"># å‡è®¾ token 1 æ˜¯å¼€å§‹ç¬¦</span>

generated = generate(decoder, start_token, max_new_tokens=<span class="hljs-number">10</span>, temperature=<span class="hljs-number">0.8</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nç”Ÿæˆè¿‡ç¨‹ / Generation process:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  èµ·å§‹ token: <span class="hljs-subst">{start_token[<span class="hljs-number">0</span>].tolist()}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  ç”Ÿæˆçš„ tokens: <span class="hljs-subst">{generated[<span class="hljs-number">0</span>].tolist()}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 8. ç”Ÿæˆç­–ç•¥å¯¹æ¯” / Generation Strategy Comparison</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ç”Ÿæˆç­–ç•¥å¯¹æ¯” / Generation Strategy Comparison&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">greedy_decode</span>(<span class="hljs-params">model, start_tokens, max_new_tokens</span>):
    <span class="hljs-string">&quot;&quot;&quot;è´ªå©ªè§£ç  / Greedy decoding&quot;&quot;&quot;</span>
    model.<span class="hljs-built_in">eval</span>()
    generated = start_tokens.clone()

    <span class="hljs-keyword">with</span> torch.no_grad():
        <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(max_new_tokens):
            logits, _ = model(generated)
            next_token = logits[:, -<span class="hljs-number">1</span>, :].argmax(dim=-<span class="hljs-number">1</span>, keepdim=<span class="hljs-literal">True</span>)
            generated = torch.cat([generated, next_token], dim=<span class="hljs-number">1</span>)

    <span class="hljs-keyword">return</span> generated

<span class="hljs-keyword">def</span> <span class="hljs-title function_">top_k_sample</span>(<span class="hljs-params">model, start_tokens, max_new_tokens, k=<span class="hljs-number">50</span>, temperature=<span class="hljs-number">1.0</span></span>):
    <span class="hljs-string">&quot;&quot;&quot;Top-K é‡‡æ · / Top-K sampling&quot;&quot;&quot;</span>
    model.<span class="hljs-built_in">eval</span>()
    generated = start_tokens.clone()

    <span class="hljs-keyword">with</span> torch.no_grad():
        <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(max_new_tokens):
            logits, _ = model(generated)
            next_token_logits = logits[:, -<span class="hljs-number">1</span>, :] / temperature

            <span class="hljs-comment"># Top-K è¿‡æ»¤</span>
            top_k_logits, top_k_indices = torch.topk(next_token_logits, k)
            probs = F.softmax(top_k_logits, dim=-<span class="hljs-number">1</span>)

            <span class="hljs-comment"># ä» Top-K ä¸­é‡‡æ ·</span>
            idx = torch.multinomial(probs, num_samples=<span class="hljs-number">1</span>)
            next_token = top_k_indices.gather(<span class="hljs-number">1</span>, idx)

            generated = torch.cat([generated, next_token], dim=<span class="hljs-number">1</span>)

    <span class="hljs-keyword">return</span> generated

<span class="hljs-comment"># æµ‹è¯•ä¸åŒç­–ç•¥</span>
start = torch.tensor([[<span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">10</span>]])

greedy_result = greedy_decode(decoder, start, max_new_tokens=<span class="hljs-number">5</span>)
top_k_result = top_k_sample(decoder, start, max_new_tokens=<span class="hljs-number">5</span>, k=<span class="hljs-number">10</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nèµ·å§‹åºåˆ—: <span class="hljs-subst">{start[<span class="hljs-number">0</span>].tolist()}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;è´ªå©ªè§£ç : <span class="hljs-subst">{greedy_result[<span class="hljs-number">0</span>].tolist()}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Top-K é‡‡æ · (k=10): <span class="hljs-subst">{top_k_result[<span class="hljs-number">0</span>].tolist()}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># æ€»ç»“ / Summary</span>
<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;æ€»ç»“ / Summary&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-string">&quot;&quot;&quot;
æœ¬ç¤ºä¾‹å±•ç¤ºäº† Transformer Decoder çš„æ ¸å¿ƒæ¦‚å¿µ:
This example demonstrates core concepts of Transformer Decoder:

1. å› æœæ©ç  / Causal Mask:
   - ç¡®ä¿æ¯ä¸ªä½ç½®åªèƒ½çœ‹åˆ°ä¹‹å‰çš„ä½ç½®
   - å®ç°æ–¹å¼ï¼šä¸Šä¸‰è§’çŸ©é˜µè®¾ä¸º -inf

2. è‡ªå›å½’ç”Ÿæˆ / Autoregressive Generation:
   - é€ token ç”Ÿæˆ
   - ç”¨å·²ç”Ÿæˆçš„å†…å®¹é¢„æµ‹ä¸‹ä¸€ä¸ª

3. ç”Ÿæˆç­–ç•¥ / Generation Strategies:
   - Greedy: é€‰æ‹©æ¦‚ç‡æœ€é«˜çš„
   - Sampling: æŒ‰æ¦‚ç‡é‡‡æ ·
   - Top-K: ä»å‰ K ä¸ªä¸­é‡‡æ ·
   - Temperature: æ§åˆ¶éšæœºæ€§

4. GPT æ¶æ„:
   - çº¯è§£ç å™¨ç»“æ„
   - è‡ªç›‘ç£è¯­è¨€å»ºæ¨¡
   - ç”Ÿæˆèƒ½åŠ›å¼º
&quot;&quot;&quot;</span>
</code></pre></div><div class="code-file"><h3>kv_cache_example.py</h3><pre class="hljs"><code><span class="hljs-string">&quot;&quot;&quot;
KV Cache ç¤ºä¾‹ä»£ç  / KV Cache Example Code
=========================================

æœ¬ç¤ºä¾‹å±•ç¤º KV Cache çš„åŸç†å’Œå®ç°ã€‚
This example demonstrates the principle and implementation of KV Cache.

KV Cache æ˜¯åŠ é€Ÿ Transformer æ¨ç†çš„å…³é”®æŠ€æœ¯ã€‚
KV Cache is a key technique for accelerating Transformer inference.

ä¾èµ–å®‰è£… / Dependencies:
    pip install torch matplotlib numpy
&quot;&quot;&quot;</span>

<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn
<span class="hljs-keyword">import</span> torch.nn.functional <span class="hljs-keyword">as</span> F
<span class="hljs-keyword">import</span> time

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 1. é—®é¢˜ï¼šä¸ºä»€ä¹ˆéœ€è¦ KV Cacheï¼Ÿ</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ä¸ºä»€ä¹ˆéœ€è¦ KV Cacheï¼Ÿ / Why KV Cache?&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&quot;&quot;
åœ¨è‡ªå›å½’ç”Ÿæˆä¸­ï¼Œæ¯æ¬¡ç”Ÿæˆä¸€ä¸ªæ–° token æ—¶:

æ— ç¼“å­˜ / Without Cache:
- éœ€è¦é‡æ–°è®¡ç®—æ‰€æœ‰ä¹‹å‰ token çš„ K å’Œ V
- è®¡ç®—é‡éšåºåˆ—é•¿åº¦çº¿æ€§å¢é•¿
- å¤§é‡é‡å¤è®¡ç®—

æœ‰ç¼“å­˜ / With Cache:
- ç¼“å­˜ä¹‹å‰è®¡ç®—è¿‡çš„ K å’Œ V
- åªéœ€è®¡ç®—æ–° token çš„ K å’Œ V
- è®¡ç®—é‡æ’å®š

ç¤ºä¾‹: ç”Ÿæˆç¬¬ 10 ä¸ª token æ—¶
- æ— ç¼“å­˜: å¤„ç† 10 ä¸ª token
- æœ‰ç¼“å­˜: åªå¤„ç† 1 ä¸ª token
&quot;&quot;&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 2. ç®€å•çš„ Attention å±‚ï¼ˆæ— ç¼“å­˜ï¼‰/ Simple Attention Layer (No Cache)</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleAttention</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;ä¸å¸¦ KV Cache çš„æ³¨æ„åŠ›å±‚ / Attention without KV Cache&quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, d_model, num_heads</span>):
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-variable language_">self</span>.num_heads = num_heads
        <span class="hljs-variable language_">self</span>.d_k = d_model // num_heads

        <span class="hljs-variable language_">self</span>.W_q = nn.Linear(d_model, d_model, bias=<span class="hljs-literal">False</span>)
        <span class="hljs-variable language_">self</span>.W_k = nn.Linear(d_model, d_model, bias=<span class="hljs-literal">False</span>)
        <span class="hljs-variable language_">self</span>.W_v = nn.Linear(d_model, d_model, bias=<span class="hljs-literal">False</span>)
        <span class="hljs-variable language_">self</span>.W_o = nn.Linear(d_model, d_model, bias=<span class="hljs-literal">False</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-string">&quot;&quot;&quot;x: [batch, seq_len, d_model]&quot;&quot;&quot;</span>
        batch_size, seq_len, _ = x.shape

        Q = <span class="hljs-variable language_">self</span>.W_q(x).view(batch_size, seq_len, <span class="hljs-variable language_">self</span>.num_heads, <span class="hljs-variable language_">self</span>.d_k).transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)
        K = <span class="hljs-variable language_">self</span>.W_k(x).view(batch_size, seq_len, <span class="hljs-variable language_">self</span>.num_heads, <span class="hljs-variable language_">self</span>.d_k).transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)
        V = <span class="hljs-variable language_">self</span>.W_v(x).view(batch_size, seq_len, <span class="hljs-variable language_">self</span>.num_heads, <span class="hljs-variable language_">self</span>.d_k).transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)

        scores = torch.matmul(Q, K.transpose(-<span class="hljs-number">2</span>, -<span class="hljs-number">1</span>)) / (<span class="hljs-variable language_">self</span>.d_k ** <span class="hljs-number">0.5</span>)
        attn = F.softmax(scores, dim=-<span class="hljs-number">1</span>)
        output = torch.matmul(attn, V)

        output = output.transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>).contiguous().view(batch_size, seq_len, -<span class="hljs-number">1</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.W_o(output)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 3. å¸¦ KV Cache çš„ Attention å±‚ / Attention Layer with KV Cache</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CachedAttention</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;å¸¦ KV Cache çš„æ³¨æ„åŠ›å±‚ / Attention with KV Cache&quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, d_model, num_heads</span>):
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-variable language_">self</span>.num_heads = num_heads
        <span class="hljs-variable language_">self</span>.d_k = d_model // num_heads

        <span class="hljs-variable language_">self</span>.W_q = nn.Linear(d_model, d_model, bias=<span class="hljs-literal">False</span>)
        <span class="hljs-variable language_">self</span>.W_k = nn.Linear(d_model, d_model, bias=<span class="hljs-literal">False</span>)
        <span class="hljs-variable language_">self</span>.W_v = nn.Linear(d_model, d_model, bias=<span class="hljs-literal">False</span>)
        <span class="hljs-variable language_">self</span>.W_o = nn.Linear(d_model, d_model, bias=<span class="hljs-literal">False</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x, past_kv=<span class="hljs-literal">None</span>, use_cache=<span class="hljs-literal">False</span></span>):
        <span class="hljs-string">&quot;&quot;&quot;
        å‚æ•° / Args:
            x: [batch, seq_len, d_model]
            past_kv: ä¹‹å‰ç¼“å­˜çš„ (K, V) tuple
            use_cache: æ˜¯å¦è¿”å› KV Cache

        è¿”å› / Returns:
            output: [batch, seq_len, d_model]
            present_kv: å½“å‰çš„ (K, V) ç”¨äºåç»­ç¼“å­˜
        &quot;&quot;&quot;</span>
        batch_size, seq_len, _ = x.shape

        <span class="hljs-comment"># è®¡ç®—å½“å‰è¾“å…¥çš„ Q, K, V</span>
        Q = <span class="hljs-variable language_">self</span>.W_q(x).view(batch_size, seq_len, <span class="hljs-variable language_">self</span>.num_heads, <span class="hljs-variable language_">self</span>.d_k).transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)
        K = <span class="hljs-variable language_">self</span>.W_k(x).view(batch_size, seq_len, <span class="hljs-variable language_">self</span>.num_heads, <span class="hljs-variable language_">self</span>.d_k).transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)
        V = <span class="hljs-variable language_">self</span>.W_v(x).view(batch_size, seq_len, <span class="hljs-variable language_">self</span>.num_heads, <span class="hljs-variable language_">self</span>.d_k).transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)

        <span class="hljs-comment"># å¦‚æœæœ‰è¿‡å»çš„ KVï¼Œæ‹¼æ¥</span>
        <span class="hljs-keyword">if</span> past_kv <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            past_k, past_v = past_kv
            K = torch.cat([past_k, K], dim=<span class="hljs-number">2</span>)
            V = torch.cat([past_v, V], dim=<span class="hljs-number">2</span>)

        <span class="hljs-comment"># è®¡ç®—æ³¨æ„åŠ›</span>
        scores = torch.matmul(Q, K.transpose(-<span class="hljs-number">2</span>, -<span class="hljs-number">1</span>)) / (<span class="hljs-variable language_">self</span>.d_k ** <span class="hljs-number">0.5</span>)

        <span class="hljs-comment"># åº”ç”¨å› æœæ©ç ï¼ˆå¦‚æœæœ‰è¿‡å» KVï¼Œåªå¯¹æ–°éƒ¨åˆ†æ©ç ï¼‰</span>
        <span class="hljs-keyword">if</span> past_kv <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            <span class="hljs-comment"># æ–° token å¯ä»¥çœ‹åˆ°æ‰€æœ‰ä¹‹å‰çš„ tokenï¼Œæ‰€ä»¥ä¸éœ€è¦æ©ç </span>
            <span class="hljs-keyword">pass</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-comment"># å®Œæ•´çš„å› æœæ©ç </span>
            causal_mask = torch.triu(torch.ones(seq_len, seq_len, device=x.device), diagonal=<span class="hljs-number">1</span>).<span class="hljs-built_in">bool</span>()
            scores = scores.masked_fill(causal_mask.unsqueeze(<span class="hljs-number">0</span>).unsqueeze(<span class="hljs-number">0</span>), <span class="hljs-built_in">float</span>(<span class="hljs-string">&#x27;-inf&#x27;</span>))

        attn = F.softmax(scores, dim=-<span class="hljs-number">1</span>)
        output = torch.matmul(attn, V)

        output = output.transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>).contiguous().view(batch_size, seq_len, -<span class="hljs-number">1</span>)
        output = <span class="hljs-variable language_">self</span>.W_o(output)

        <span class="hljs-comment"># è¿”å›ç¼“å­˜</span>
        present_kv = (K, V) <span class="hljs-keyword">if</span> use_cache <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>

        <span class="hljs-keyword">return</span> output, present_kv

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 4. å®Œæ•´çš„ Decoder å±‚ï¼ˆå¸¦ KV Cacheï¼‰/ Complete Decoder Layer with KV Cache</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CachedDecoderLayer</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;å¸¦ KV Cache çš„ Decoder å±‚&quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, d_model, num_heads, d_ff</span>):
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-variable language_">self</span>.attention = CachedAttention(d_model, num_heads)
        <span class="hljs-variable language_">self</span>.norm1 = nn.LayerNorm(d_model)
        <span class="hljs-variable language_">self</span>.norm2 = nn.LayerNorm(d_model)
        <span class="hljs-variable language_">self</span>.ffn = nn.Sequential(
            nn.Linear(d_model, d_ff),
            nn.GELU(),
            nn.Linear(d_ffn, d_model)
        )

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x, past_kv=<span class="hljs-literal">None</span>, use_cache=<span class="hljs-literal">False</span></span>):
        <span class="hljs-comment"># Attention</span>
        residual = x
        x = <span class="hljs-variable language_">self</span>.norm1(x)
        x, present_kv = <span class="hljs-variable language_">self</span>.attention(x, past_kv, use_cache)
        x = residual + x

        <span class="hljs-comment"># FFN</span>
        residual = x
        x = <span class="hljs-variable language_">self</span>.norm2(x)
        x = <span class="hljs-variable language_">self</span>.ffn(x)
        x = residual + x

        <span class="hljs-keyword">return</span> x, present_kv

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 5. æ€§èƒ½å¯¹æ¯” / Performance Comparison</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;æ€§èƒ½å¯¹æ¯” / Performance Comparison&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-comment"># åˆ›å»ºæ¨¡å‹</span>
d_model = <span class="hljs-number">256</span>
num_heads = <span class="hljs-number">8</span>
num_layers = <span class="hljs-number">4</span>
vocab_size = <span class="hljs-number">1000</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleDecoder</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;ä¸å¸¦ KV Cache çš„ç®€å• Decoder&quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-variable language_">self</span>.embed = nn.Embedding(vocab_size, d_model)
        <span class="hljs-variable language_">self</span>.layers = nn.ModuleList([
            SimpleAttention(d_model, num_heads) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_layers)
        ])
        <span class="hljs-variable language_">self</span>.norm = nn.LayerNorm(d_model)
        <span class="hljs-variable language_">self</span>.head = nn.Linear(d_model, vocab_size)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        x = <span class="hljs-variable language_">self</span>.embed(x)
        <span class="hljs-keyword">for</span> layer <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.layers:
            x = layer(x)
        x = <span class="hljs-variable language_">self</span>.norm(x)
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.head(x)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CachedDecoder</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;å¸¦ KV Cache çš„ Decoder&quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-variable language_">self</span>.embed = nn.Embedding(vocab_size, d_model)
        <span class="hljs-variable language_">self</span>.layers = nn.ModuleList([
            CachedAttention(d_model, num_heads) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_layers)
        ])
        <span class="hljs-variable language_">self</span>.norm = nn.LayerNorm(d_model)
        <span class="hljs-variable language_">self</span>.head = nn.Linear(d_model, vocab_size)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x, past_kvs=<span class="hljs-literal">None</span>, use_cache=<span class="hljs-literal">False</span></span>):
        x = <span class="hljs-variable language_">self</span>.embed(x)

        present_kvs = []
        <span class="hljs-keyword">for</span> i, layer <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(<span class="hljs-variable language_">self</span>.layers):
            past_kv = past_kvs[i] <span class="hljs-keyword">if</span> past_kvs <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>
            x, present_kv = layer(x, past_kv, use_cache)
            present_kvs.append(present_kv)

        x = <span class="hljs-variable language_">self</span>.norm(x)
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.head(x), present_kvs <span class="hljs-keyword">if</span> use_cache <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>

simple_decoder = SimpleDecoder()
cached_decoder = CachedDecoder()

<span class="hljs-comment"># æµ‹è¯•ç”Ÿæˆé€Ÿåº¦</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_without_cache</span>(<span class="hljs-params">model, start_tokens, num_tokens</span>):
    <span class="hljs-string">&quot;&quot;&quot;æ— ç¼“å­˜çš„ç”Ÿæˆ&quot;&quot;&quot;</span>
    tokens = start_tokens.clone()
    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_tokens):
        logits = model(tokens)
        next_token = logits[:, -<span class="hljs-number">1</span>, :].argmax(dim=-<span class="hljs-number">1</span>, keepdim=<span class="hljs-literal">True</span>)
        tokens = torch.cat([tokens, next_token], dim=<span class="hljs-number">1</span>)
    <span class="hljs-keyword">return</span> tokens

<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_with_cache</span>(<span class="hljs-params">model, start_tokens, num_tokens</span>):
    <span class="hljs-string">&quot;&quot;&quot;å¸¦ç¼“å­˜çš„ç”Ÿæˆ&quot;&quot;&quot;</span>
    tokens = start_tokens.clone()

    <span class="hljs-comment"># ç¬¬ä¸€æ¬¡å¤„ç†æ‰€æœ‰ token</span>
    logits, past_kvs = model(tokens, use_cache=<span class="hljs-literal">True</span>)
    next_token = logits[:, -<span class="hljs-number">1</span>, :].argmax(dim=-<span class="hljs-number">1</span>, keepdim=<span class="hljs-literal">True</span>)
    tokens = torch.cat([tokens, next_token], dim=<span class="hljs-number">1</span>)

    <span class="hljs-comment"># åç»­åªå¤„ç†æ–° token</span>
    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_tokens - <span class="hljs-number">1</span>):
        logits, past_kvs = model(next_token, past_kvs, use_cache=<span class="hljs-literal">True</span>)
        next_token = logits[:, -<span class="hljs-number">1</span>, :].argmax(dim=-<span class="hljs-number">1</span>, keepdim=<span class="hljs-literal">True</span>)
        tokens = torch.cat([tokens, next_token], dim=<span class="hljs-number">1</span>)

    <span class="hljs-keyword">return</span> tokens

<span class="hljs-comment"># æ€§èƒ½æµ‹è¯•</span>
start_tokens = torch.randint(<span class="hljs-number">0</span>, vocab_size, (<span class="hljs-number">1</span>, <span class="hljs-number">10</span>))
num_new_tokens = <span class="hljs-number">20</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nç”Ÿæˆ <span class="hljs-subst">{num_new_tokens}</span> ä¸ªæ–° token:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;èµ·å§‹åºåˆ—é•¿åº¦: <span class="hljs-subst">{start_tokens.shape[<span class="hljs-number">1</span>]}</span>&quot;</span>)

<span class="hljs-comment"># æ— ç¼“å­˜</span>
start_time = time.time()
result_no_cache = generate_without_cache(simple_decoder, start_tokens, num_new_tokens)
time_no_cache = time.time() - start_time

<span class="hljs-comment"># æœ‰ç¼“å­˜</span>
start_time = time.time()
result_with_cache = generate_with_cache(cached_decoder, start_tokens, num_new_tokens)
time_with_cache = time.time() - start_time

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\næ— ç¼“å­˜è€—æ—¶ / Without cache: <span class="hljs-subst">{time_no_cache*<span class="hljs-number">1000</span>:<span class="hljs-number">.2</span>f}</span> ms&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;æœ‰ç¼“å­˜è€—æ—¶ / With cache: <span class="hljs-subst">{time_with_cache*<span class="hljs-number">1000</span>:<span class="hljs-number">.2</span>f}</span> ms&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;åŠ é€Ÿæ¯” / Speedup: <span class="hljs-subst">{time_no_cache/time_with_cache:<span class="hljs-number">.2</span>f}</span>x&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 6. KV Cache å†…å­˜åˆ†æ / KV Cache Memory Analysis</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;KV Cache å†…å­˜åˆ†æ / KV Cache Memory Analysis&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">compute_kv_cache_size</span>(<span class="hljs-params">batch_size, num_layers, num_heads, head_dim, seq_len, dtype_bytes=<span class="hljs-number">2</span></span>):
    <span class="hljs-string">&quot;&quot;&quot;
    è®¡ç®— KV Cache çš„å†…å­˜å¤§å°

    å‚æ•°:
        batch_size: æ‰¹å¤§å°
        num_layers: å±‚æ•°
        num_heads: æ³¨æ„åŠ›å¤´æ•°
        head_dim: æ¯ä¸ªå¤´çš„ç»´åº¦
        seq_len: åºåˆ—é•¿åº¦
        dtype_bytes: æ•°æ®ç±»å‹å­—èŠ‚æ•° (FP16 = 2, FP32 = 4)

    è¿”å›:
        å†…å­˜å¤§å° (MB)
    &quot;&quot;&quot;</span>
    <span class="hljs-comment"># æ¯å±‚æœ‰ K å’Œ V ä¸¤ä¸ªç¼“å­˜</span>
    <span class="hljs-comment"># å½¢çŠ¶: [batch, num_heads, seq_len, head_dim]</span>
    cache_per_layer = <span class="hljs-number">2</span> * batch_size * num_heads * seq_len * head_dim * dtype_bytes
    total_cache = cache_per_layer * num_layers
    <span class="hljs-keyword">return</span> total_cache / (<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>)  <span class="hljs-comment"># è½¬æ¢ä¸º MB</span>

<span class="hljs-comment"># å…¸å‹é…ç½®ä¸‹çš„ KV Cache å¤§å°</span>
configs = [
    {<span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;GPT-2 Small&quot;</span>, <span class="hljs-string">&quot;layers&quot;</span>: <span class="hljs-number">12</span>, <span class="hljs-string">&quot;heads&quot;</span>: <span class="hljs-number">12</span>, <span class="hljs-string">&quot;head_dim&quot;</span>: <span class="hljs-number">64</span>},
    {<span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;GPT-2 Medium&quot;</span>, <span class="hljs-string">&quot;layers&quot;</span>: <span class="hljs-number">24</span>, <span class="hljs-string">&quot;heads&quot;</span>: <span class="hljs-number">16</span>, <span class="hljs-string">&quot;head_dim&quot;</span>: <span class="hljs-number">64</span>},
    {<span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;GPT-3&quot;</span>, <span class="hljs-string">&quot;layers&quot;</span>: <span class="hljs-number">96</span>, <span class="hljs-string">&quot;heads&quot;</span>: <span class="hljs-number">96</span>, <span class="hljs-string">&quot;head_dim&quot;</span>: <span class="hljs-number">128</span>},
]

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\nKV Cache å¤§å° (batch_size=1, dtype=FP16):&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">{<span class="hljs-string">&#x27;æ¨¡å‹&#x27;</span>:&lt;<span class="hljs-number">15</span>}</span> <span class="hljs-subst">{<span class="hljs-string">&#x27;åºåˆ—é•¿åº¦&#x27;</span>:&lt;<span class="hljs-number">10</span>}</span> <span class="hljs-subst">{<span class="hljs-string">&#x27;KV Cache (MB)&#x27;</span>:&lt;<span class="hljs-number">15</span>}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">45</span>)

<span class="hljs-keyword">for</span> config <span class="hljs-keyword">in</span> configs:
    <span class="hljs-keyword">for</span> seq_len <span class="hljs-keyword">in</span> [<span class="hljs-number">512</span>, <span class="hljs-number">1024</span>, <span class="hljs-number">2048</span>, <span class="hljs-number">4096</span>]:
        size_mb = compute_kv_cache_size(
            batch_size=<span class="hljs-number">1</span>,
            num_layers=config[<span class="hljs-string">&quot;layers&quot;</span>],
            num_heads=config[<span class="hljs-string">&quot;heads&quot;</span>],
            head_dim=config[<span class="hljs-string">&quot;head_dim&quot;</span>],
            seq_len=seq_len,
            dtype_bytes=<span class="hljs-number">2</span>
        )
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">{config[<span class="hljs-string">&#x27;name&#x27;</span>]:&lt;<span class="hljs-number">15</span>}</span> <span class="hljs-subst">{seq_len:&lt;<span class="hljs-number">10</span>}</span> <span class="hljs-subst">{size_mb:&lt;<span class="hljs-number">15.2</span>f}</span>&quot;</span>)
    <span class="hljs-built_in">print</span>()

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 7. KV Cache å®ç°ç»†èŠ‚ / KV Cache Implementation Details</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;KV Cache å®ç°ç»†èŠ‚ / Implementation Details&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&quot;&quot;
KV Cache çš„å…³é”®ç‚¹:

1. ç¼“å­˜ç»“æ„ / Cache Structure:
   - past_key_values: List[Tuple[Tensor, Tensor]]
   - æ¯å±‚ä¸€ä¸ª (K, V) å…ƒç»„
   - å½¢çŠ¶: [batch, num_heads, past_seq_len, head_dim]

2. å¢é‡æ›´æ–° / Incremental Update:
   - æ–° K/V ä¸ç¼“å­˜æ‹¼æ¥
   - K = concat([past_k, new_k], dim=2)
   - V = concat([past_v, new_v], dim=2)

3. æ³¨æ„äº‹é¡¹ / Notes:
   - éœ€è¦ç®¡ç†ç¼“å­˜çš„åˆ›å»ºå’Œæ›´æ–°
   - é•¿åºåˆ—æ—¶å†…å­˜å ç”¨å¤§
   - å¯ä»¥ç»“åˆè¿ç»­æ‰¹å¤„ç†ä¼˜åŒ–
&quot;&quot;&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># æ€»ç»“ / Summary</span>
<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;æ€»ç»“ / Summary&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-string">&quot;&quot;&quot;
æœ¬ç¤ºä¾‹å±•ç¤ºäº† KV Cache çš„æ ¸å¿ƒæ¦‚å¿µ:
This example demonstrates core concepts of KV Cache:

1. é—®é¢˜ / Problem:
   - è‡ªå›å½’ç”Ÿæˆéœ€è¦é‡å¤è®¡ç®—
   - åºåˆ—è¶Šé•¿ï¼Œè®¡ç®—é‡è¶Šå¤§

2. è§£å†³æ–¹æ¡ˆ / Solution:
   - ç¼“å­˜å·²è®¡ç®—çš„ K å’Œ V
   - åªè®¡ç®—æ–° token çš„ K å’Œ V

3. ä¼˜åŠ¿ / Advantages:
   - æ˜¾è‘—åŠ é€Ÿæ¨ç†
   - è®¡ç®—é‡æ’å®šï¼ˆä¸éšåºåˆ—é•¿åº¦å¢é•¿ï¼‰

4. å†…å­˜ä»£ä»· / Memory Cost:
   - O(L * B * H * D * S)
   - L: å±‚æ•°, B: æ‰¹å¤§å°, H: å¤´æ•°, D: å¤´ç»´åº¦, S: åºåˆ—é•¿åº¦

5. å®é™…åº”ç”¨ / Applications:
   - æ‰€æœ‰ä¸»æµ LLM éƒ½ä½¿ç”¨ KV Cache
   - æ˜¯æ¨ç†ä¼˜åŒ–çš„åŸºç¡€
&quot;&quot;&quot;</span>
</code></pre></div></div></div><div class="chapter"><h1>ç¬¬9ç«  MoE æ··åˆä¸“å®¶æ¨¡å‹</h1><h1>æ··åˆä¸“å®¶æ¨¡å‹ï¼ˆMoEï¼‰ç§‘æ™®ç‰ˆ</h1>
<blockquote>
<p>é¢å‘é›¶åŸºç¡€è¯»è€…çš„æ··åˆä¸“å®¶æ¨¡å‹å…¥é—¨æŒ‡å—</p>
</blockquote>
<h2>ä¸€å¥è¯æ¦‚æ‹¬</h2>
<p><strong>æ··åˆä¸“å®¶æ¨¡å‹è®©æ¨¡å‹&quot;æœ¯ä¸šæœ‰ä¸“æ”»&quot;ï¼Œæ¯ä¸ªéƒ¨åˆ†åªåšè‡ªå·±æ“…é•¿çš„äº‹ï¼Œæœ€åç»¼åˆæ‰€æœ‰äººçš„ï¿½ï¿½ï¿½æ…§ã€‚</strong></p>
<h2>ä»ä¸€ä¸ªé—®é¢˜å¼€å§‹</h2>
<p>æƒ³è±¡ä½ è¦ç»„å»ºä¸€ä¸ªå›¢é˜Ÿæ¥å›ç­”å„ç§é—®é¢˜ï¼š</p>
<ul>
<li>é—®é¢˜ Aï¼šå…³äºæ•°å­¦</li>
<li>é—®é¢˜ Bï¼šå…³äºå†å²</li>
<li>é—®é¢˜ Cï¼šå…³äºç¼–ç¨‹</li>
</ul>
<p><strong>æ–¹æ¡ˆ 1ï¼šä¸€ä¸ªäººå›ç­”æ‰€æœ‰é—®é¢˜</strong></p>
<ul>
<li>è¿™ä¸ªäººéœ€è¦æ‡‚æ‰€æœ‰é¢†åŸŸ</li>
<li>éœ€è¦å¤§é‡&quot;è„‘å®¹é‡&quot;</li>
<li>æ•ˆç‡ä¸é«˜</li>
</ul>
<p><strong>æ–¹æ¡ˆ 2ï¼šå›¢é˜Ÿåä½œ</strong></p>
<ul>
<li>æ•°å­¦å®¶å›ç­”æ•°å­¦é—®é¢˜</li>
<li>å†å²å­¦å®¶å›ç­”å†å²é—®é¢˜</li>
<li>ç¨‹åºå‘˜å›ç­”ç¼–ç¨‹é—®é¢˜</li>
<li>ä¸€ä¸ª&quot;è°ƒåº¦å‘˜&quot;å†³å®šè°æ¥å›ç­”</li>
</ul>
<p>è¿™å°±æ˜¯<strong>æ··åˆä¸“å®¶æ¨¡å‹</strong>çš„æ ¸å¿ƒæ€æƒ³ï¼</p>
<h2>æ ¸å¿ƒæ¦‚å¿µ</h2>
<h3>ä¸“å®¶ï¼ˆExpertï¼‰</h3>
<p>æ¯ä¸ª&quot;ä¸“å®¶&quot;æ˜¯ä¸€ä¸ªå°å‹ç¥ç»ç½‘ç»œï¼Œä¸“é—¨å¤„ç†æŸä¸€ç±»ä»»åŠ¡ã€‚</p>
<p>ç±»æ¯”ï¼š</p>
<ul>
<li>åŒ»é™¢çš„ä¸åŒç§‘å®¤</li>
<li>å…¬å¸çš„ä¸åŒéƒ¨é—¨</li>
<li>å­¦æ ¡çš„ä¸åŒè€å¸ˆ</li>
</ul>
<h3>è·¯ç”±å™¨ï¼ˆRouter/Gating Networkï¼‰</h3>
<p>å†³å®šæŠŠè¾“å…¥é€ç»™å“ªä¸ªä¸“å®¶ã€‚</p>
<p>ç±»æ¯”ï¼š</p>
<ul>
<li>åŒ»é™¢çš„åˆ†è¯Šå°</li>
<li>å…¬å¸çš„é¡¹ç›®ç»ç†</li>
<li>å­¦æ ¡çš„æ•™åŠ¡å¤„</li>
</ul>
<h3>ç¨€ç–æ¿€æ´»</h3>
<p>ä¸æ˜¯æ‰€æœ‰ä¸“å®¶éƒ½å‚ä¸æ¯æ¬¡è®¡ç®—ï¼Œåªæœ‰æœ€ç›¸å…³çš„å‡ ä¸ªè¢«æ¿€æ´»ã€‚</p>
<p>ç±»æ¯”ï¼š</p>
<ul>
<li>çœ‹ç—…åªå»ä¸€ä¸ªç§‘å®¤</li>
<li>é¡¹ç›®åªåˆ†é…ç»™ç›¸å…³å›¢é˜Ÿ</li>
</ul>
<h2>ä¸ºä»€ä¹ˆ MoE å¦‚æ­¤å¼ºå¤§ï¼Ÿ</h2>
<h3>å‚æ•°æ•ˆç‡</h3>
<table>
<thead>
<tr>
<th>æ¨¡å‹ç±»å‹</th>
<th>æ€»å‚æ•°</th>
<th>æ¿€æ´»å‚æ•°</th>
<th>è®¡ç®—é‡</th>
</tr>
</thead>
<tbody>
<tr>
<td>ç¨ å¯†æ¨¡å‹</td>
<td>70B</td>
<td>70B</td>
<td>é«˜</td>
</tr>
<tr>
<td>MoE æ¨¡å‹</td>
<td>70B</td>
<td>13B</td>
<td>ä½</td>
</tr>
</tbody>
</table>
<p>MoE å¯ä»¥æœ‰å¤§é‡å‚æ•°ï¼ˆå­˜å‚¨çŸ¥è¯†ï¼‰ï¼Œä½†æ¯æ¬¡åªæ¿€æ´»ä¸€å°éƒ¨åˆ†ï¼ˆèŠ‚çœè®¡ç®—ï¼‰ã€‚</p>
<h3>å®é™…ä¾‹å­</h3>
<ul>
<li><strong>Mixtral 8x7B</strong>ï¼šæ€»å‚æ•°çº¦ 47Bï¼Œä½†æ¯æ¬¡åªæ¿€æ´»çº¦ 13B</li>
<li><strong>GPT-4</strong>ï¼šæ®æŠ¥é“ä½¿ç”¨äº† MoE æ¶æ„</li>
<li><strong>DeepSeek-MoE</strong>ï¼šåˆ›æ–°çš„ MoE æ¶æ„ï¼Œæ›´é«˜æ•ˆçš„ä¸“å®¶åˆ©ç”¨</li>
</ul>
<h2>å·¥ä½œæµç¨‹</h2>
<ol>
<li><strong>è¾“å…¥è¿›å…¥è·¯ç”±å™¨</strong>ï¼šè·¯ç”±å™¨åˆ†æè¾“å…¥</li>
<li><strong>é€‰æ‹©ä¸“å®¶</strong>ï¼šè·¯ç”±å™¨é€‰æ‹©æœ€ç›¸å…³çš„ K ä¸ªä¸“å®¶</li>
<li><strong>å¹¶è¡Œè®¡ç®—</strong>ï¼šè¢«é€‰ä¸­çš„ä¸“å®¶å„è‡ªå¤„ç†è¾“å…¥</li>
<li><strong>åŠ æƒèåˆ</strong>ï¼šæ ¹æ®è·¯ç”±å™¨åˆ†æ•°ï¼Œèåˆå„ä¸“å®¶çš„è¾“å‡º</li>
</ol>
<h3>ç®€å•ç¤ºä¾‹</h3>
<p>è¾“å…¥ï¼šâ€œè¯·è§£é‡Šé‡å­åŠ›å­¦â€</p>
<ol>
<li>è·¯ç”±å™¨åˆ†æï¼šè¿™æ˜¯ä¸€ä¸ªç‰©ç†é—®é¢˜</li>
<li>é€‰æ‹©ä¸“å®¶ï¼šä¸“å®¶ #3ï¼ˆç‰©ç†ï¼‰ã€ä¸“å®¶ #7ï¼ˆç§‘å­¦ï¼‰è¢«é€‰ä¸­</li>
<li>ä¸“å®¶ #3 è¾“å‡ºï¼šé‡å­åŠ›å­¦è§£é‡Š A</li>
<li>ä¸“å®¶ #7 è¾“å‡ºï¼šé‡å­åŠ›å­¦è§£é‡Š B</li>
<li>èåˆè¾“å‡ºï¼š0.7 Ã— A + 0.3 Ã— Bï¼ˆè·¯ç”±å™¨æƒé‡ï¼‰</li>
</ol>
<h2>è´Ÿè½½å‡è¡¡é—®é¢˜</h2>
<h3>é—®é¢˜</h3>
<p>å¦‚æœæ‰€æœ‰è¾“å…¥éƒ½è¢«è·¯ç”±åˆ°åŒä¸€ä¸ªä¸“å®¶ï¼š</p>
<ul>
<li>é‚£ä¸ªä¸“å®¶è¿‡è½½</li>
<li>å…¶ä»–ä¸“å®¶&quot;å¤±ä¸š&quot;ï¼Œæµªè´¹å‚æ•°</li>
</ul>
<h3>è§£å†³æ–¹æ¡ˆ</h3>
<p>ç»™è·¯ç”±å™¨åŠ ä¸€ä¸ª&quot;å¹³è¡¡å¥–åŠ±&quot;ï¼Œé¼“åŠ±å®ƒå‡åŒ€ä½¿ç”¨æ‰€æœ‰ä¸“å®¶ã€‚</p>
<p>ç±»æ¯”ï¼šé¡¹ç›®ç»ç†è¦å…¬å¹³åˆ†é…ä»»åŠ¡ï¼Œä¸èƒ½æ€»è®©åŒä¸€ä¸ªäººå¹²æ´»ã€‚</p>
<h2>æ€»ç»“</h2>
<table>
<thead>
<tr>
<th>æ¦‚å¿µ</th>
<th>é€šä¿—ç†è§£</th>
</tr>
</thead>
<tbody>
<tr>
<td>ä¸“å®¶</td>
<td>ä¸“é—¨åšæŸç±»äº‹çš„ç½‘ç»œ</td>
</tr>
<tr>
<td>è·¯ç”±å™¨</td>
<td>å†³å®šè°æ¥å¤„ç†çš„ç½‘ç»œ</td>
</tr>
<tr>
<td>Top-K è·¯ç”±</td>
<td>åªé€‰æœ€å¥½çš„ K ä¸ªä¸“å®¶</td>
</tr>
<tr>
<td>ç¨€ç–æ¿€æ´»</td>
<td>åªæ¿€æ´»éƒ¨åˆ†å‚æ•°</td>
</tr>
<tr>
<td>è´Ÿè½½å‡è¡¡</td>
<td>è®©æ‰€æœ‰ä¸“å®¶éƒ½æœ‰æ´»å¹²</td>
</tr>
</tbody>
</table>
<h2>ä¸‹ä¸€æ­¥</h2>
<ul>
<li>æƒ³äº†è§£æ•°å­¦åŸç†ï¼Ÿé˜…è¯» <a href="advanced-guide.md">æ·±å…¥ç‰ˆ</a></li>
<li>æƒ³çœ‹ä»£ç å®ç°ï¼ŸæŸ¥çœ‹ <code>examples/</code> ç›®å½•</li>
</ul>
<h1>æ··åˆä¸“å®¶æ¨¡å‹ï¼ˆMoEï¼‰æ·±å…¥ç‰ˆ</h1>
<blockquote>
<p>é¢å‘æœ‰æœºå™¨å­¦ä¹ åŸºç¡€è¯»è€…çš„æŠ€æœ¯è¯¦è§£</p>
</blockquote>
<h2>æ¦‚è¿°</h2>
<p>æ··åˆä¸“å®¶æ¨¡å‹ï¼ˆMixture of Experts, MoEï¼‰é€šè¿‡æ¡ä»¶è®¡ç®—å®ç°æ¨¡å‹å®¹é‡ä¸è®¡ç®—æ•ˆç‡çš„è§£è€¦ã€‚æœ¬æ–‡æ·±å…¥åˆ†æ MoE çš„æ•°å­¦åŸç†ã€è·¯ç”±ç­–ç•¥å’Œè´Ÿè½½å‡è¡¡æœºåˆ¶ã€‚</p>
<h2>MoE çš„æ•°å­¦å½¢å¼</h2>
<h3>åŸºæœ¬å®šä¹‰</h3>
<p>ç»™å®šè¾“å…¥ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span>ï¼ŒMoE å±‚çš„è¾“å‡ºä¸ºï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">MoE</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">G</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></p>
<p><a id="formula-moe-1"></a>
<a href="#formula-moe-1-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šæ‰€æœ‰ä¸“å®¶çš„è¾“å‡ºåŠ æƒæ±‚å’Œï¼Œæƒé‡ç”±è·¯ç”±å™¨ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">G</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> å†³å®šã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> ä¸ºä¸“å®¶æ€»æ•°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">G</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºç¬¬ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> ä¸ªä¸“å®¶çš„æƒé‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> ä¸ºç¬¬ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> ä¸ªä¸“å®¶çš„è¾“å‡ºã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šä¸åŒä¸“å®¶ä¸“æ³¨äºä¸åŒç±»å‹çš„è¾“å…¥ï¼Œè·¯ç”±å™¨å†³å®šæ¯ä¸ªè¾“å…¥åº”ç”±å“ªäº›ä¸“å®¶å¤„ç†ã€‚</li>
</ul>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> æ˜¯ä¸“å®¶æ•°é‡</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> æ˜¯ç¬¬ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> ä¸ªä¸“å®¶çš„è¾“å‡º</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">G</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> æ˜¯è·¯ç”±å™¨åˆ†é…ç»™ç¬¬ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> ä¸ªä¸“å®¶çš„æƒé‡</li>
</ul>
<h3>ç¨€ç– MoE (Sparse MoE)</h3>
<p>ä¸ºå‡å°‘è®¡ç®—é‡ï¼Œåªæ¿€æ´» top-k ä¸ªä¸“å®¶ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">SparseMoE</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.566em;vertical-align:-1.516em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.809em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">âˆˆ</span><span class="mord text mtight"><span class="mord mtight">TopK</span></span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">G</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">x</span><span class="mclose mtight">))</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.516em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">G</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></p>
<p><a id="formula-moe-2"></a>
<a href="#formula-moe-2-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šåªå–è·¯ç”±åˆ†æ•°æœ€é«˜çš„ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> ä¸ªä¸“å®¶å‚ä¸è®¡ç®—ï¼Œå…¶ä½™æƒé‡ç½®é›¶ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">TopK</span></span><span class="mopen">(</span><span class="mord mathnormal">G</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">))</span></span></span></span> è¿”å›è·¯ç”±åˆ†æ•°æœ€é«˜çš„ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> ä¸ªä¸“å®¶ç´¢å¼•ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> é€šå¸¸ä¸º 1 æˆ– 2ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šç¨€ç–æ¿€æ´»å¤§å¹…å‡å°‘è®¡ç®—é‡ï¼ŒåŒæ—¶ä¿æŒæ¨¡å‹å®¹é‡ã€‚</li>
</ul>
<h2>è·¯ç”±ç­–ç•¥</h2>
<h3>1. Softmax è·¯ç”±</h3>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">G</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Softmax</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><a id="formula-moe-3"></a>
<a href="#formula-moe-3-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šå°†è¾“å…¥ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> çº¿æ€§æ˜ å°„åˆ° <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> ç»´ï¼Œå†ç» softmax å¾—åˆ°æ¯ä¸ªä¸“å®¶çš„æƒé‡ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mbin mtight">Ã—</span><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span></span></span></span> ä¸ºè·¯ç”±å™¨æƒé‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> ä¸ºè¾“å…¥å‘é‡ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šæƒé‡å’Œä¸º 1ï¼Œå¯è§£é‡Šä¸º&quot;é€‰æ‹©ä¸“å®¶çš„æ¦‚ç‡åˆ†å¸ƒ&quot;ã€‚</li>
</ul>
<p>å…¶ä¸­ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mbin mtight">Ã—</span><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span></span></span></span> æ˜¯è·¯ç”±å™¨çš„å¯å­¦ä¹ å‚æ•°ã€‚</p>
<p><strong>é—®é¢˜</strong>ï¼šæ‰€æœ‰ä¸“å®¶éƒ½ä¼šè¢«æ¿€æ´»ï¼ˆæƒé‡éé›¶ï¼‰ã€‚</p>
<h3>2. Top-K è·¯ç”±</h3>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">G</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.1395em;vertical-align:-1.3198em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8198em;"><span style="top:-3.8198em;"><span class="pstrut" style="height:3.0323em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0323em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mop op-symbol small-op mtight" style="position:relative;top:0em;">âˆ‘</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1667em;"><span style="top:-2.1786em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">âˆˆ</span><span class="mord text mtight"><span class="mord mtight">TopK</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.4603em;"><span></span></span></span></span></span></span><span class="mspace mtight" style="margin-right:0.1952em;"></span><span class="mop mtight"><span class="mtight">e</span><span class="mtight">x</span><span class="mtight">p</span></span><span class="mopen mtight">((</span><span class="mord mathnormal mtight">x</span><span class="mbin mtight">â‹…</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.1389em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span></span></span></span></span></span></span><span class="mclose mtight"><span class="mclose mtight">)</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.5073em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mtight">e</span><span class="mtight">x</span><span class="mtight">p</span></span><span class="mopen mtight">((</span><span class="mord mathnormal mtight">x</span><span class="mbin mtight">â‹…</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.1389em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span></span></span></span></span></span></span><span class="mclose mtight"><span class="mclose mtight">)</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.6672em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-2.1445em;"><span class="pstrut" style="height:3.0323em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.3198em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8198em;"><span style="top:-3.8198em;"><span class="pstrut" style="height:3.0323em;"></span><span class="mord"><span class="mord text"><span class="mord">ifÂ </span></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord text"><span class="mord">TopK</span></span></span></span><span style="top:-2.1445em;"><span class="pstrut" style="height:3.0323em;"></span><span class="mord"><span class="mord text"><span class="mord">otherwise</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.3198em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><a id="formula-moe-4"></a>
<a href="#formula-moe-4-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šåªä¿ç•™ top-k ä¸“å®¶çš„æƒé‡ï¼Œå…¶ä½™ç½®é›¶ï¼Œå†å¯¹ä¿ç•™çš„æƒé‡å½’ä¸€åŒ–ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">TopK</span></span></span></span></span> ä¸ºåˆ†æ•°æœ€é«˜çš„ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> ä¸ªä¸“å®¶é›†åˆï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">exp</span><span class="mopen">(</span><span class="mord">â‹…</span><span class="mclose">)</span></span></span></span> ä¿è¯æƒé‡éè´Ÿã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šåªæ¿€æ´»å°‘æ•°ä¸“å®¶ï¼Œè®¡ç®—é‡ä¸ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> æˆæ­£æ¯”è€Œéä¸“å®¶æ€»æ•°ã€‚</li>
</ul>
<p><strong>ç‰¹ç‚¹</strong>ï¼š</p>
<ul>
<li>åªæ¿€æ´» k ä¸ªä¸“å®¶ï¼ˆé€šå¸¸ k=2ï¼‰</li>
<li>æ¿€æ´»çš„ä¸“å®¶æƒé‡é‡æ–°å½’ä¸€åŒ–</li>
</ul>
<h3>3. Top-K with Noiseï¼ˆå¸¦å™ªå£°çš„ Top-Kï¼‰</h3>
<p>ä¸ºå¢åŠ æ¢ç´¢æ€§ï¼Œåœ¨è·¯ç”±åˆ†æ•°ä¸Šæ·»åŠ å™ªå£°ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4445em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">StandardNormal</span></span><span class="mopen">(</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Softplus</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">se</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><a id="formula-moe-5"></a>
<a href="#formula-moe-5-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">G</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Softmax</span></span><span class="mopen">(</span><span class="mord text"><span class="mord">TopK</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)))</span></span></span></span></span></p>
<p><a id="formula-moe-6"></a>
<a href="#formula-moe-6-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šåœ¨è·¯ç”±åˆ†æ•°ä¸Šæ·»åŠ å¯å­¦ä¹ çš„å™ªå£°ï¼Œå¢åŠ è·¯ç”±çš„æ¢ç´¢æ€§ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">StandardNormal</span></span><span class="mopen">(</span><span class="mclose">)</span></span></span></span> ä¸ºæ ‡å‡†æ­£æ€é‡‡æ ·ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Softplus</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">se</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> æ§åˆ¶å™ªå£°å¤§å°ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šå™ªå£°è®©è·¯ç”±åœ¨è®­ç»ƒæ—¶æ¢ç´¢æ›´å¤šä¸“å®¶ç»„åˆï¼Œé¿å…è¿‡æ—©æ”¶æ•›åˆ°æ¬¡ä¼˜åˆ†é…ã€‚</li>
</ul>
<h2>è´Ÿè½½å‡è¡¡</h2>
<h3>é—®é¢˜ï¼šä¸“å®¶åå¡Œ</h3>
<p>è®­ç»ƒè¿‡ç¨‹ä¸­å¯èƒ½å‡ºç°ï¼š</p>
<ul>
<li>å°‘æ•°ä¸“å®¶è¢«é¢‘ç¹é€‰æ‹©</li>
<li>å¤§å¤šæ•°ä¸“å®¶å‡ ä¹ä¸è¢«ä½¿ç”¨</li>
</ul>
<h3>è¾…åŠ©æŸå¤±å‡½æ•°</h3>
<h4>Load Balancing Loss</h4>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">ux</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4445em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.4445em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p><a id="formula-moe-7"></a>
<a href="#formula-moe-7-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šæƒ©ç½šä¸“å®¶è´Ÿè½½ä¸å‡è¡¡ï¼Œé¼“åŠ±æ‰€æœ‰ä¸“å®¶è¢«å‡åŒ€ä½¿ç”¨ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºå®é™…è·¯ç”±åˆ°ä¸“å®¶ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> çš„ token æ¯”ä¾‹ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºä¸“å®¶ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> çš„å¹³å‡è·¯ç”±æ¦‚ç‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span></span></span></span> ä¸ºè°ƒèŠ‚ç³»æ•°ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šå½“ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1/</span><span class="mord mathnormal">n</span></span></span></span> æ—¶æŸå¤±æœ€å°ï¼Œå³æ‰€æœ‰ä¸“å®¶è¢«å‡åŒ€æ¿€æ´»ã€‚</li>
</ul>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> = åˆ†é…ç»™ä¸“å®¶ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> çš„ token æ¯”ä¾‹</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> = ä¸“å®¶ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> çš„å¹³å‡è·¯ç”±æ¦‚ç‡</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span></span></span></span> æ˜¯è°ƒèŠ‚ç³»æ•°</li>
</ul>
<h4>å®Œæ•´æŸå¤±</h4>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">ux</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p><a id="formula-moe-8"></a>
<a href="#formula-moe-8-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šæ€»æŸå¤± = ä»»åŠ¡æŸå¤± + è´Ÿè½½å‡è¡¡è¾…åŠ©æŸå¤±ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºç›®æ ‡ä»»åŠ¡æŸå¤±ï¼ˆå¦‚è¯­è¨€æ¨¡å‹æŸå¤±ï¼‰ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">ux</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºè´Ÿè½½å‡è¡¡æŸå¤±ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šè¾…åŠ©æŸå¤±å¼•å¯¼è·¯ç”±å™¨ï¿½ï¿½åŒ€ä½¿ç”¨æ‰€æœ‰ä¸“å®¶ï¼Œé¿å…&quot;ä¸“å®¶åå¡Œ&quot;ã€‚</li>
</ul>
<h3>è§£é‡Š</h3>
<ul>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>ï¼šå®é™…è·¯ç”±åˆ°ä¸“å®¶ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> çš„é¢‘ç‡</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1901em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">âˆ‘</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.0017em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">G</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>ï¼šä¸“å®¶ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> çš„å¹³å‡è·¯ç”±æ¦‚ç‡</li>
<li>å½“ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1901em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span> æ—¶ï¼ŒæŸå¤±æœ€å°ï¼ˆå®Œå…¨å‡åŒ€ï¼‰</li>
</ul>
<h2>ä¸“å®¶å®¹é‡ï¼ˆExpert Capacityï¼‰</h2>
<p>ä¸ºé˜²æ­¢å•ä¸ªä¸“å®¶è¿‡è½½ï¼Œè®¾ç½®æ¯ä¸ªä¸“å®¶èƒ½å¤„ç†çš„æœ€å¤§ token æ•°ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.912em;vertical-align:-0.2441em;"></span><span class="mord"><span class="mord text"><span class="mord">capacity</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2175em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0574em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">n</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em;"></span><span class="mord text"><span class="mord">capacity_factor</span></span></span></span></span></span></p>
<p><a id="formula-moe-9"></a>
<a href="#formula-moe-9-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šæ¯ä¸ªä¸“å®¶çš„å®¹é‡ = æ€» token æ•° Ã— æ¯ä¸ª token æ¿€æ´»çš„ä¸“å®¶æ•° Ã· ä¸“å®¶æ€»æ•° Ã— å®¹é‡å› å­ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> ä¸ºæ€» token æ•°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> ä¸ºæ¯ä¸ª token æ¿€æ´»çš„ä¸“å®¶æ•°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> ä¸ºä¸“å®¶æ€»æ•°ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šå®¹é‡å› å­ &gt; 1 æä¾›ç¼“å†²ï¼Œé¿å…å› ä¸“å®¶è¿‡è½½è€Œä¸¢å¼ƒ tokenã€‚</li>
</ul>
<p>è¶…è¿‡å®¹é‡çš„ token å¯èƒ½è¢«ä¸¢å¼ƒæˆ–è·¯ç”±åˆ°å…¶ä»–ä¸“å®¶ã€‚</p>
<h2>å®ç°ç»†èŠ‚</h2>
<h3>é«˜æ•ˆçš„ Top-K è®¡ç®—</h3>
<pre class="hljs"><code><span class="hljs-keyword">def</span> <span class="hljs-title function_">top_k_gating</span>(<span class="hljs-params">logits, k</span>):
    <span class="hljs-comment"># è·å– top-k å€¼å’Œç´¢å¼•</span>
    values, indices = torch.topk(logits, k, dim=-<span class="hljs-number">1</span>)
    <span class="hljs-comment"># åˆ›å»ºç¨€ç– mask</span>
    mask = torch.zeros_like(logits).scatter_(-<span class="hljs-number">1</span>, indices, <span class="hljs-number">1</span>)
    <span class="hljs-comment"># åº”ç”¨ softmaxï¼ˆåªå¯¹ top-kï¼‰</span>
    gates = F.softmax(values, dim=-<span class="hljs-number">1</span>)
    <span class="hljs-keyword">return</span> gates, indices, mask
</code></pre>
<h3>æ‰¹é‡ä¸“å®¶è®¡ç®—</h3>
<p>ä½¿ç”¨ <code>torch.einsum</code> æˆ–è‡ªå®šä¹‰ CUDA kernel é«˜æ•ˆè®¡ç®—ï¼š</p>
<pre class="hljs"><code><span class="hljs-comment"># ä¼ ç»Ÿæ–¹å¼ï¼ˆä½æ•ˆï¼‰</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_experts):
    expert_output[i] = experts[i](inputs[mask == i])

<span class="hljs-comment"># é«˜æ•ˆæ–¹å¼ï¼šæ‰¹é‡çŸ©é˜µä¹˜æ³•</span>
<span class="hljs-comment"># å°†è¾“å…¥æŒ‰ä¸“å®¶åˆ†ç»„ï¼Œæ‰¹é‡è®¡ç®—</span>
</code></pre>
<h2>ç°ä»£ MoE æ¶æ„</h2>
<h3>Mixtral 8x7B</h3>
<ul>
<li>8 ä¸ªä¸“å®¶ï¼Œæ¯æ¬¡æ¿€æ´» 2 ä¸ª</li>
<li>ä¸“å®¶æ›¿æ¢ FFN å±‚</li>
<li>æ€»å‚æ•° ~47Bï¼Œæ¿€æ´»å‚æ•° ~13B</li>
</ul>
<h3>DeepSeek-MoE</h3>
<p>åˆ›æ–°ç‚¹ï¼š</p>
<ul>
<li><strong>ç»†ç²’åº¦ä¸“å®¶</strong>ï¼šæ›´å¤šä½†æ›´å°çš„ä¸“å®¶</li>
<li><strong>å…±äº«ä¸“å®¶</strong>ï¼šéƒ¨åˆ†ä¸“å®¶å§‹ç»ˆæ¿€æ´»</li>
<li>æ›´é«˜æ•ˆçš„å‚æ•°åˆ©ç”¨</li>
</ul>
<h3>Switch Transformer</h3>
<ul>
<li>k=1ï¼ˆæ¯ä¸ª token åªè·¯ç”±åˆ°ä¸€ä¸ªä¸“å®¶ï¼‰</li>
<li>ç®€åŒ–è·¯ç”±ï¼Œæé«˜æ•ˆç‡</li>
</ul>
<h2>è®­ç»ƒæŠ€å·§</h2>
<h3>1. åˆå§‹åŒ–</h3>
<ul>
<li>è·¯ç”±å™¨æƒé‡ä½¿ç”¨è¾ƒå°çš„åˆå§‹åŒ–</li>
<li>ä¸“å®¶ä½¿ç”¨æ ‡å‡†åˆå§‹åŒ–</li>
</ul>
<h3>2. å­¦ä¹ ç‡</h3>
<ul>
<li>è·¯ç”±å™¨é€šå¸¸ä½¿ç”¨è¾ƒå°çš„å­¦ä¹ ç‡</li>
<li>ä¸“å®¶ä½¿ç”¨æ ‡å‡†å­¦ä¹ ç‡</li>
</ul>
<h3>3. æ¢¯åº¦å¤„ç†</h3>
<ul>
<li>åªå¯¹è¢«æ¿€æ´»çš„ä¸“å®¶è®¡ç®—æ¢¯åº¦</li>
<li>è¾…åŠ©æŸå¤±ç¡®ä¿æ‰€æœ‰ä¸“å®¶éƒ½è¢«è®­ç»ƒ</li>
</ul>
<h2>æ¨ç†ä¼˜åŒ–</h2>
<h3>1. ä¸“å®¶ç¼“å­˜</h3>
<p>ç¼“å­˜å¸¸ç”¨ä¸“å®¶çš„æƒé‡åœ¨ GPU ä¸Šã€‚</p>
<h3>2. æ‰¹å¤„ç†ä¼˜åŒ–</h3>
<p>å°†ç›¸åŒä¸“å®¶çš„è¯·æ±‚æ‰¹é‡å¤„ç†ã€‚</p>
<h3>3. é‡åŒ–</h3>
<p>å¯¹ä¸“å®¶æƒé‡è¿›è¡Œé‡åŒ–ï¼Œå‡å°‘å†…å­˜å ç”¨ã€‚</p>
<h2>å‚è€ƒæ–‡çŒ®</h2>
<ol>
<li>Jacobs et al. (1991). <em>Adaptive Mixtures of Local Experts</em></li>
<li>Shazeer et al. (2017). <em>Outrageously Large Neural Networks: The Sparsely-Gated Mixture-of-Experts Layer</em></li>
<li>Fedus et al. (2021). <em>Switch Transformers: Scaling to Trillion Parameter Models</em></li>
<li>Jiang et al. (2024). <em>Mixtral of Experts</em></li>
<li>Dai et al. (2024). <em>DeepSeekMoE: Towards Ultimate Expert Specialization in Mixture-of-Experts Language Models</em></li>
</ol>
<h1>MoE (Mixture of Experts) æµç¨‹å›¾è§£</h1>
<blockquote>
<p>é€šè¿‡å¯è§†åŒ–å›¾è¡¨ç†è§£æ··åˆä¸“å®¶æ¨¡å‹çš„å·¥ä½œæµç¨‹</p>
</blockquote>
<h2>MoE æ ¸å¿ƒæ¶æ„</h2>
<p><div class="mermaid">flowchart TB
    A["è¾“å…¥ token"] --&gt; B["Router&lt;br/&gt;è·¯ç”±ç½‘ç»œ"]
    B --&gt; C{"é€‰æ‹© Top-k&lt;br/&gt;ä¸“å®¶"}

    C --&gt;|"Expert 1"| D1["ä¸“å®¶ 1&lt;br/&gt;FFN"]
    C --&gt;|"Expert 2"| D2["ä¸“å®¶ 2&lt;br/&gt;FFN"]
    C --&gt;|"Expert 3"| D3["ä¸“å®¶ 3&lt;br/&gt;FFN"]
    C --&gt;|"..."| D4["ä¸“å®¶ N&lt;br/&gt;FFN"]

    D1 --&gt; E["åŠ æƒç»„åˆ&lt;br/&gt;Î£ w_i * output_i"]
    D2 --&gt; E
    D3 --&gt; E
    D4 --&gt; E

    E --&gt; F["è¾“å‡º"]

    style B fill:#fff9c4
    style F fill:#c8e6c9</div></p>
<h2>Router å·¥ä½œæµç¨‹</h2>
<p><div class="mermaid">flowchart TB
    A["è¾“å…¥ x"] --&gt; B["Router&lt;br/&gt;W_router * x"]
    B --&gt; C["Softmax&lt;br/&gt;å¾—åˆ°ä¸“å®¶æ¦‚ç‡"]
    C --&gt; D["é€‰æ‹© Top-k&lt;br/&gt;æ¦‚ç‡æœ€é«˜çš„ k ä¸ª"]

    D --&gt; E["å½’ä¸€åŒ–æƒé‡&lt;br/&gt;w_i = p_i / Î£ p_topk"]

    style E fill:#c8e6c9</div></p>
<h2>ç¨€ç–æ¿€æ´»</h2>
<p><div class="mermaid">flowchart LR
    subgraph ç¨ å¯†æ¨¡å‹
        D1["æ‰€æœ‰å‚æ•°æ¿€æ´»"]
        D2["è®¡ç®—é‡: 100%"]
    end

    subgraph MoEæ¨¡å‹
        M1["åªæ¿€æ´» Top-k ä¸“å®¶"]
        M2["è®¡ç®—é‡: ~10%"]
    end

    style D2 fill:#ffcdd2
    style M2 fill:#c8e6c9</div></p>
<h2>ä¸“å®¶å¹¶è¡Œ</h2>
<p><div class="mermaid">flowchart TB
    A["è¾“å…¥æ‰¹æ¬¡"] --&gt; B["åˆ†å‘åˆ°å„ GPU"]

    B --&gt; C1["GPU 1&lt;br/&gt;ä¸“å®¶ 1-8"]
    B --&gt; C2["GPU 2&lt;br/&gt;ä¸“å®¶ 9-16"]
    B --&gt; C3["GPU 3&lt;br/&gt;ä¸“å®¶ 17-24"]
    B --&gt; C4["GPU 4&lt;br/&gt;ä¸“å®¶ 25-32"]

    C1 --&gt; D["All-to-All&lt;br/&gt;é€šä¿¡"]
    C2 --&gt; D
    C3 --&gt; D
    C4 --&gt; D

    D --&gt; E["èšåˆç»“æœ"]

    style E fill:#c8e6c9</div></p>
<h2>è´Ÿè½½å‡è¡¡</h2>
<p><div class="mermaid">flowchart TB
    subgraph é—®é¢˜
        A["æŸäº›ä¸“å®¶è¢«è¿‡åº¦ä½¿ç”¨"]
        B["å…¶ä»–ä¸“å®¶é—²ç½®"]
        C["è®­ç»ƒä¸å‡è¡¡"]
    end

    subgraph è§£å†³æ–¹æ¡ˆ
        D["è¾…åŠ©æŸå¤±å‡½æ•°"]
        E["ä¸“å®¶å®¹é‡é™åˆ¶"]
        F["å™ªå£° Top-k"]
    end

    A --&gt; D
    B --&gt; E
    C --&gt; F

    style D fill:#c8e6c9
    style E fill:#c8e6c9
    style F fill:#c8e6c9</div></p>
<h2>MoE vs ç¨ å¯†æ¨¡å‹å¯¹æ¯”</h2>
<p><div class="mermaid">flowchart LR
    subgraph ç¨ å¯†æ¨¡å‹
        D1["å‚æ•°: 7B"]
        D2["æ¿€æ´»: 7B"]
        D3["æ¨ç†æˆæœ¬: 100%"]
    end

    subgraph MoEæ¨¡å‹
        M1["å‚æ•°: 47B"]
        M2["æ¿€æ´»: 8B"]
        M3["æ¨ç†æˆæœ¬: ~15%"]
    end

    style D3 fill:#ffcdd2
    style M3 fill:#c8e6c9</div></p>
<h2>å›¾è§£è¯´æ˜</h2>
<h3>å…³é”®æ¦‚å¿µ</h3>
<table>
<thead>
<tr>
<th>æ¦‚å¿µ</th>
<th>è¯´æ˜</th>
<th>å…¸å‹å€¼</th>
</tr>
</thead>
<tbody>
<tr>
<td>ä¸“å®¶æ•°</td>
<td>FFN çš„æ•°é‡</td>
<td>8-128</td>
</tr>
<tr>
<td>Top-k</td>
<td>æ¯æ¬¡æ¿€æ´»çš„ä¸“å®¶æ•°</td>
<td>1-2</td>
</tr>
<tr>
<td>å®¹é‡å› å­</td>
<td>æ¯ä¸“å®¶æœ€å¤§å¤„ç†é‡</td>
<td>1.25-2.0</td>
</tr>
</tbody>
</table>
<h3>è‘—å MoE æ¨¡å‹</h3>
<table>
<thead>
<tr>
<th>æ¨¡å‹</th>
<th>æ€»å‚æ•°</th>
<th>æ¿€æ´»å‚æ•°</th>
<th>ä¸“å®¶æ•°</th>
</tr>
</thead>
<tbody>
<tr>
<td>Mixtral 8x7B</td>
<td>47B</td>
<td>13B</td>
<td>8</td>
</tr>
<tr>
<td>Switch Transformer</td>
<td>1.6T</td>
<td>-</td>
<td>2048</td>
</tr>
<tr>
<td>GPT-4</td>
<td>?</td>
<td>?</td>
<td>?</td>
</tr>
</tbody>
</table>
<h3>ä¼˜åŠ¿</h3>
<ul>
<li>æ›´å°‘çš„è®¡ç®—é‡</li>
<li>æ›´å¤§çš„çŸ¥è¯†å®¹é‡</li>
<li>æ›´å¥½çš„ä¸“ä¸šåŒ–</li>
</ul>
<div class="code-appendix page-break"><h2>é™„å½•ï¼šä»£ç ç¤ºä¾‹</h2><div class="code-file"><h3>moe_router_example.py</h3><pre class="hljs"><code><span class="hljs-string">&quot;&quot;&quot;
MoE è·¯ç”±å™¨ç¤ºä¾‹ä»£ç  / MoE Router Example Code
============================================

æœ¬ç¤ºä¾‹å±•ç¤ºæ··åˆä¸“å®¶æ¨¡å‹ï¼ˆMoEï¼‰è·¯ç”±å™¨çš„åŸç†å’Œå®ç°ã€‚
This example demonstrates the principle and implementation of MoE router.

ä¾èµ–å®‰è£… / Dependencies:
    pip install torch matplotlib numpy
&quot;&quot;&quot;</span>

<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn
<span class="hljs-keyword">import</span> torch.nn.functional <span class="hljs-keyword">as</span> F
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 1. åŸºç¡€è·¯ç”±å™¨å®ç° / Basic Router Implementation</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MoERouter</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;
    Top-K è·¯ç”±å™¨ / Top-K Router

    åŠŸèƒ½ / Functions:
    1. è®¡ç®—æ¯ä¸ª token å¯¹æ¯ä¸ªä¸“å®¶çš„åˆ†æ•°
    2. é€‰æ‹© top-k ä¸ªä¸“å®¶
    3. è¿”å›è·¯ç”±æƒé‡å’Œç´¢å¼•
    &quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, d_model, num_experts, top_k=<span class="hljs-number">2</span></span>):
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-variable language_">self</span>.num_experts = num_experts
        <span class="hljs-variable language_">self</span>.top_k = top_k

        <span class="hljs-comment"># è·¯ç”±å™¨æƒé‡ / Router weights</span>
        <span class="hljs-variable language_">self</span>.gate = nn.Linear(d_model, num_experts, bias=<span class="hljs-literal">False</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-string">&quot;&quot;&quot;
        å‚æ•° / Args:
            x: [batch, seq_len, d_model]

        è¿”å› / Returns:
            gates: [batch, seq_len, top_k] - è·¯ç”±æƒé‡
            indices: [batch, seq_len, top_k] - é€‰æ‹©çš„ä¸“å®¶ç´¢å¼•
        &quot;&quot;&quot;</span>
        <span class="hljs-comment"># è®¡ç®—è·¯ç”±åˆ†æ•° / Compute routing scores</span>
        logits = <span class="hljs-variable language_">self</span>.gate(x)  <span class="hljs-comment"># [batch, seq_len, num_experts]</span>

        <span class="hljs-comment"># Top-K é€‰æ‹© / Top-K selection</span>
        top_k_logits, top_k_indices = torch.topk(logits, <span class="hljs-variable language_">self</span>.top_k, dim=-<span class="hljs-number">1</span>)

        <span class="hljs-comment"># Softmax å½’ä¸€åŒ–ï¼ˆåªå¯¹ top-kï¼‰/ Softmax normalization (only for top-k)</span>
        top_k_gates = F.softmax(top_k_logits, dim=-<span class="hljs-number">1</span>)

        <span class="hljs-keyword">return</span> top_k_gates, top_k_indices, logits

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 2. æµ‹è¯•è·¯ç”±å™¨ / Test Router</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;MoE è·¯ç”±å™¨æµ‹è¯• / MoE Router Test&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

torch.manual_seed(<span class="hljs-number">42</span>)

d_model = <span class="hljs-number">64</span>
num_experts = <span class="hljs-number">8</span>
top_k = <span class="hljs-number">2</span>
batch_size, seq_len = <span class="hljs-number">4</span>, <span class="hljs-number">10</span>

<span class="hljs-comment"># åˆ›å»ºè·¯ç”±å™¨ / Create router</span>
router = MoERouter(d_model, num_experts, top_k)

<span class="hljs-comment"># åˆ›å»ºè¾“å…¥ / Create input</span>
x = torch.randn(batch_size, seq_len, d_model)

<span class="hljs-comment"># è·¯ç”± / Route</span>
gates, indices, all_logits = router(x)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\né…ç½® / Configuration:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  ä¸“å®¶æ•°é‡ / Num experts: <span class="hljs-subst">{num_experts}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  Top-K: <span class="hljs-subst">{top_k}</span>&quot;</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nè¾“å…¥å½¢çŠ¶ / Input shape: <span class="hljs-subst">{x.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;è·¯ç”±æƒé‡å½¢çŠ¶ / Gates shape: <span class="hljs-subst">{gates.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;ä¸“å®¶ç´¢å¼•å½¢çŠ¶ / Indices shape: <span class="hljs-subst">{indices.shape}</span>&quot;</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nç¬¬ä¸€ä¸ªæ ·æœ¬å‰ 3 ä¸ª token çš„è·¯ç”± / Routing for first 3 tokens of first sample:&quot;</span>)
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  Token <span class="hljs-subst">{i}</span>: ä¸“å®¶ <span class="hljs-subst">{indices[<span class="hljs-number">0</span>, i].tolist()}</span> (æƒé‡ <span class="hljs-subst">{gates[<span class="hljs-number">0</span>, i].tolist()}</span>)&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 3. å¯è§†åŒ–è·¯ç”±åˆ†å¸ƒ / Visualize Routing Distribution</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;è·¯ç”±åˆ†å¸ƒå¯è§†åŒ– / Routing Distribution Visualization&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-comment"># ç»Ÿè®¡æ¯ä¸ªä¸“å®¶è¢«é€‰ä¸­çš„æ¬¡æ•° / Count expert selections</span>
expert_counts = torch.zeros(num_experts)
<span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(batch_size):
    <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(seq_len):
        <span class="hljs-keyword">for</span> idx <span class="hljs-keyword">in</span> indices[b, s]:
            expert_counts[idx] += <span class="hljs-number">1</span>

<span class="hljs-comment"># å¯è§†åŒ– / Visualize</span>
fig, axes = plt.subplots(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, figsize=(<span class="hljs-number">12</span>, <span class="hljs-number">4</span>))

<span class="hljs-comment"># 3.1 ä¸“å®¶é€‰æ‹©é¢‘ç‡ / Expert selection frequency</span>
ax1 = axes[<span class="hljs-number">0</span>]
ax1.bar(<span class="hljs-built_in">range</span>(num_experts), expert_counts.numpy())
ax1.set_xlabel(<span class="hljs-string">&#x27;Expert ID&#x27;</span>)
ax1.set_ylabel(<span class="hljs-string">&#x27;Selection Count&#x27;</span>)
ax1.set_title(<span class="hljs-string">&#x27;Expert Selection Distribution&#x27;</span>)
ax1.set_xticks(<span class="hljs-built_in">range</span>(num_experts))

<span class="hljs-comment"># 3.2 è·¯ç”±åˆ†æ•°çƒ­åŠ›å›¾ / Routing scores heatmap</span>
ax2 = axes[<span class="hljs-number">1</span>]
<span class="hljs-comment"># å±•ç¤ºç¬¬ä¸€ä¸ªæ ·æœ¬çš„è·¯ç”±åˆ†æ•° / Show routing scores for first sample</span>
ax2.imshow(all_logits[<span class="hljs-number">0</span>].detach().numpy(), cmap=<span class="hljs-string">&#x27;RdBu_r&#x27;</span>, aspect=<span class="hljs-string">&#x27;auto&#x27;</span>)
ax2.set_xlabel(<span class="hljs-string">&#x27;Expert ID&#x27;</span>)
ax2.set_ylabel(<span class="hljs-string">&#x27;Token Position&#x27;</span>)
ax2.set_title(<span class="hljs-string">&#x27;Routing Logits (First Sample)&#x27;</span>)
plt.colorbar(ax2.images[<span class="hljs-number">0</span>], ax=ax2)

plt.tight_layout()
plt.savefig(<span class="hljs-string">&#x27;/tmp/moe_router_distribution.png&#x27;</span>, dpi=<span class="hljs-number">150</span>, bbox_inches=<span class="hljs-string">&#x27;tight&#x27;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nè·¯ç”±åˆ†å¸ƒå›¾åƒå·²ä¿å­˜è‡³ / Distribution image saved to: /tmp/moe_router_distribution.png&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 4. è´Ÿè½½å‡è¡¡æŸå¤± / Load Balancing Loss</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;è´Ÿè½½å‡è¡¡æŸå¤± / Load Balancing Loss&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">compute_load_balance_loss</span>(<span class="hljs-params">gates, indices, num_experts</span>):
    <span class="hljs-string">&quot;&quot;&quot;
    è®¡ç®—è´Ÿè½½å‡è¡¡è¾…åŠ©æŸå¤± / Compute load balancing auxiliary loss

    L_aux = n * sum(f_i * P_i)
    å…¶ä¸­:
    - f_i = åˆ†é…ç»™ä¸“å®¶ i çš„ token æ¯”ä¾‹
    - P_i = ä¸“å®¶ i çš„å¹³å‡è·¯ç”±æ¦‚ç‡

    å‚æ•° / Args:
        gates: [batch, seq_len, top_k] - è·¯ç”±æƒé‡
        indices: [batch, seq_len, top_k] - ä¸“å®¶ç´¢å¼•
        num_experts: ä¸“å®¶æ€»æ•°

    è¿”å› / Returns:
        loss: è´Ÿè½½å‡è¡¡æŸå¤±
    &quot;&quot;&quot;</span>
    batch_size, seq_len, top_k = gates.shape
    total_tokens = batch_size * seq_len

    <span class="hljs-comment"># è®¡ç®— f_i: æ¯ä¸ª expert å®é™…å¤„ç†çš„ token æ¯”ä¾‹</span>
    <span class="hljs-comment"># Compute f_i: actual proportion of tokens routed to each expert</span>
    f = torch.zeros(num_experts, device=gates.device)
    <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(batch_size):
        <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(seq_len):
            <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(top_k):
                expert_idx = indices[b, s, k]
                f[expert_idx] += <span class="hljs-number">1</span>

    f = f / (total_tokens * top_k)  <span class="hljs-comment"># å½’ä¸€åŒ–</span>

    <span class="hljs-comment"># è®¡ç®— P_i: æ¯ä¸ª expert çš„å¹³å‡è·¯ç”±æ¦‚ç‡</span>
    <span class="hljs-comment"># Compute P_i: average routing probability for each expert</span>
    <span class="hljs-comment"># è¿™éœ€è¦ä»å®Œæ•´çš„ logits è®¡ç®—ï¼Œè¿™é‡Œç”¨ç®€åŒ–ç‰ˆæœ¬</span>
    <span class="hljs-comment"># é¦–å…ˆé‡å»ºå®Œæ•´çš„ gates çŸ©é˜µ</span>
    full_gates = torch.zeros(batch_size, seq_len, num_experts, device=gates.device)
    <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(batch_size):
        <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(seq_len):
            <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(top_k):
                expert_idx = indices[b, s, k]
                full_gates[b, s, expert_idx] = gates[b, s, k]

    P = full_gates.mean(dim=(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>))  <span class="hljs-comment"># [num_experts]</span>

    <span class="hljs-comment"># è´Ÿè½½å‡è¡¡æŸå¤± / Load balance loss</span>
    loss = num_experts * torch.<span class="hljs-built_in">sum</span>(f * P)

    <span class="hljs-keyword">return</span> loss, f, P

<span class="hljs-comment"># è®¡ç®—æŸå¤± / Compute loss</span>
lb_loss, f, P = compute_load_balance_loss(gates, indices, num_experts)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nè´Ÿè½½å‡è¡¡æŸå¤± / Load balance loss: <span class="hljs-subst">{lb_loss.item():<span class="hljs-number">.4</span>f}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nä¸“å®¶é€‰æ‹©æ¯”ä¾‹ f_i / Expert selection proportion f_i:&quot;</span>)
<span class="hljs-keyword">for</span> i, val <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(f):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  Expert <span class="hljs-subst">{i}</span>: <span class="hljs-subst">{val.item():<span class="hljs-number">.4</span>f}</span>&quot;</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nä¸“å®¶å¹³å‡è·¯ç”±æ¦‚ç‡ P_i / Average routing probability P_i:&quot;</span>)
<span class="hljs-keyword">for</span> i, val <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(P):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  Expert <span class="hljs-subst">{i}</span>: <span class="hljs-subst">{val.item():<span class="hljs-number">.4</span>f}</span>&quot;</span>)

<span class="hljs-comment"># å®Œç¾å‡è¡¡æ—¶çš„æŸå¤± / Loss at perfect balance</span>
perfect_loss = num_experts * (<span class="hljs-number">1</span>/num_experts) * (<span class="hljs-number">1</span>/num_experts)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nå®Œç¾å‡è¡¡æ—¶çš„æŸå¤± / Perfect balance loss: <span class="hljs-subst">{perfect_loss:<span class="hljs-number">.4</span>f}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 5. å¸¦å™ªå£°çš„è·¯ç”± / Noisy Routing</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;å¸¦å™ªå£°çš„è·¯ç”± / Noisy Routing&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">NoisyMoERouter</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;
    å¸¦å™ªå£°çš„ Top-K è·¯ç”±å™¨ / Noisy Top-K Router

    åœ¨è·¯ç”±åˆ†æ•°ä¸Šæ·»åŠ å¯å­¦ä¹ çš„å™ªå£°ï¼Œå¢åŠ æ¢ç´¢æ€§
    Adds learnable noise to routing scores for exploration
    &quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, d_model, num_experts, top_k=<span class="hljs-number">2</span></span>):
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-variable language_">self</span>.num_experts = num_experts
        <span class="hljs-variable language_">self</span>.top_k = top_k

        <span class="hljs-variable language_">self</span>.gate = nn.Linear(d_model, num_experts, bias=<span class="hljs-literal">False</span>)
        <span class="hljs-variable language_">self</span>.noise_weights = nn.Linear(d_model, num_experts, bias=<span class="hljs-literal">False</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-string">&quot;&quot;&quot;
        å¸¦å™ªå£°çš„è·¯ç”± / Noisy routing

        H(x) = x @ W_g + noise * softplus(x @ W_noise)
        &quot;&quot;&quot;</span>
        <span class="hljs-comment"># åŸºç¡€è·¯ç”±åˆ†æ•° / Base routing scores</span>
        logits = <span class="hljs-variable language_">self</span>.gate(x)

        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.training:
            <span class="hljs-comment"># è®¡ç®—å™ªå£° / Compute noise</span>
            noise_logits = <span class="hljs-variable language_">self</span>.noise_weights(x)
            noise = torch.randn_like(logits) * F.softplus(noise_logits)
            logits = logits + noise

        <span class="hljs-comment"># Top-K é€‰æ‹© / Top-K selection</span>
        top_k_logits, top_k_indices = torch.topk(logits, <span class="hljs-variable language_">self</span>.top_k, dim=-<span class="hljs-number">1</span>)
        top_k_gates = F.softmax(top_k_logits, dim=-<span class="hljs-number">1</span>)

        <span class="hljs-keyword">return</span> top_k_gates, top_k_indices, logits

noisy_router = NoisyMoERouter(d_model, num_experts, top_k)
noisy_router.train()

gates_noisy, indices_noisy, _ = noisy_router(x)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nå¸¦å™ªå£°è·¯ç”±ç»“æœ / Noisy routing results:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;ç¬¬ä¸€ä¸ªæ ·æœ¬å‰ 3 ä¸ª token çš„è·¯ç”± / Routing for first 3 tokens:&quot;</span>)
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  Token <span class="hljs-subst">{i}</span>: ä¸“å®¶ <span class="hljs-subst">{indices_noisy[<span class="hljs-number">0</span>, i].tolist()}</span> (æƒé‡ <span class="hljs-subst">{gates_noisy[<span class="hljs-number">0</span>, i].tolist()}</span>)&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 6. ä¸“å®¶å®¹é‡é™åˆ¶ / Expert Capacity Limit</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ä¸“å®¶å®¹é‡é™åˆ¶ / Expert Capacity Limit&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">routing_with_capacity</span>(<span class="hljs-params">x, router, capacity_factor=<span class="hljs-number">1.25</span></span>):
    <span class="hljs-string">&quot;&quot;&quot;
    å¸¦å®¹é‡é™åˆ¶çš„è·¯ç”± / Routing with capacity limit

    æ¯ä¸ª expert æœ€å¤šå¤„ç† (total_tokens * top_k / num_experts) * capacity_factor ä¸ª token
    &quot;&quot;&quot;</span>
    batch_size, seq_len, d_model = x.shape
    num_experts = router.num_experts
    top_k = router.top_k

    <span class="hljs-comment"># è®¡ç®—ä¸“å®¶å®¹é‡ / Compute expert capacity</span>
    tokens_per_batch = batch_size * seq_len
    expert_capacity = <span class="hljs-built_in">int</span>((tokens_per_batch * top_k / num_experts) * capacity_factor)

    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;æ¯ä¸ªä¸“å®¶æœ€å¤§å®¹é‡ / Max capacity per expert: <span class="hljs-subst">{expert_capacity}</span> tokens&quot;</span>)

    <span class="hljs-comment"># è·å–è·¯ç”±ç»“æœ / Get routing results</span>
    gates, indices, logits = router(x)

    <span class="hljs-comment"># æ¨¡æ‹Ÿå®¹é‡é™åˆ¶ / Simulate capacity limit</span>
    expert_load = torch.zeros(num_experts)
    overflow_count = <span class="hljs-number">0</span>

    <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(batch_size):
        <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(seq_len):
            <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(top_k):
                expert_idx = indices[b, s, k].item()
                <span class="hljs-keyword">if</span> expert_load[expert_idx] &lt; expert_capacity:
                    expert_load[expert_idx] += <span class="hljs-number">1</span>
                <span class="hljs-keyword">else</span>:
                    overflow_count += <span class="hljs-number">1</span>
                    <span class="hljs-comment"># å¯ä»¥é€‰æ‹©ä¸¢å¼ƒæˆ–è·¯ç”±åˆ°å…¶ä»– expert</span>

    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nä¸“å®¶è´Ÿè½½ / Expert load:&quot;</span>)
    <span class="hljs-keyword">for</span> i, load <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(expert_load):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  Expert <span class="hljs-subst">{i}</span>: <span class="hljs-subst">{<span class="hljs-built_in">int</span>(load.item())}</span> tokens (å®¹é‡ <span class="hljs-subst">{expert_capacity}</span>)&quot;</span>)

    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\næº¢å‡º token æ•° / Overflow tokens: <span class="hljs-subst">{overflow_count}</span>&quot;</span>)

    <span class="hljs-keyword">return</span> gates, indices

gates_cap, indices_cap = routing_with_capacity(x, router)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># æ€»ç»“ / Summary</span>
<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;æ€»ç»“ / Summary&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-string">&quot;&quot;&quot;
æœ¬ç¤ºä¾‹å±•ç¤ºäº† MoE è·¯ç”±å™¨çš„æ ¸å¿ƒæ¦‚å¿µ:
This example demonstrates core concepts of MoE router:

1. Top-K è·¯ç”± / Top-K routing:
   - è®¡ç®—æ¯ä¸ª token å¯¹æ¯ä¸ª expert çš„åˆ†æ•°
   - é€‰æ‹©åˆ†æ•°æœ€é«˜çš„ K ä¸ª expert
   - å¯¹é€‰ä¸­çš„ expert æƒé‡è¿›è¡Œ softmax å½’ä¸€åŒ–

2. è´Ÿè½½å‡è¡¡ / Load balancing:
   - è¾…åŠ©æŸå¤±é¼“åŠ±å‡åŒ€ä½¿ç”¨æ‰€æœ‰ expert
   - L_aux = n * sum(f_i * P_i)
   - å®Œç¾å‡è¡¡æ—¶æŸå¤±æœ€å°

3. å¸¦å™ªå£°è·¯ç”± / Noisy routing:
   - åœ¨è·¯ç”±åˆ†æ•°ä¸Šæ·»åŠ å™ªå£°
   - å¢åŠ æ¢ç´¢æ€§ï¼Œé˜²æ­¢è¿‡æ—©æ”¶æ•›

4. å®¹é‡é™åˆ¶ / Capacity limit:
   - æ¯ä¸ª expert æœ‰æœ€å¤§å¤„ç† token æ•°
   - é˜²æ­¢å•ä¸ª expert è¿‡è½½
&quot;&quot;&quot;</span>
</code></pre></div><div class="code-file"><h3>sparse_moe_example.py</h3><pre class="hljs"><code><span class="hljs-string">&quot;&quot;&quot;
ç¨€ç– MoE å±‚ç¤ºä¾‹ä»£ç  / Sparse MoE Layer Example Code
===================================================

æœ¬ç¤ºä¾‹å±•ç¤ºå®Œæ•´çš„ç¨€ç–æ··åˆä¸“å®¶æ¨¡å‹ï¼ˆSparse MoEï¼‰å±‚çš„å®ç°ã€‚
This example demonstrates a complete implementation of a Sparse MoE layer.

ä¾èµ–å®‰è£… / Dependencies:
    pip install torch matplotlib numpy
&quot;&quot;&quot;</span>

<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn
<span class="hljs-keyword">import</span> torch.nn.functional <span class="hljs-keyword">as</span> F
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 1. ä¸“å®¶ç½‘ç»œ / Expert Network</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Expert</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;
    å•ä¸ªä¸“å®¶ç½‘ç»œï¼ˆå‰é¦ˆç½‘ç»œï¼‰/ Single Expert Network (Feed-Forward)

    åœ¨ Transformer MoE ä¸­ï¼Œä¸“å®¶é€šå¸¸æ›¿æ¢ FFN å±‚
    In Transformer MoE, experts typically replace the FFN layer
    &quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, d_model, d_ff, dropout=<span class="hljs-number">0.1</span></span>):
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-variable language_">self</span>.w1 = nn.Linear(d_model, d_ff)
        <span class="hljs-variable language_">self</span>.w2 = nn.Linear(d_ff, d_model)
        <span class="hljs-variable language_">self</span>.dropout = nn.Dropout(dropout)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-comment"># FFN with GELU activation</span>
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.w2(<span class="hljs-variable language_">self</span>.dropout(F.gelu(<span class="hljs-variable language_">self</span>.w1(x))))

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 2. å®Œæ•´çš„ Sparse MoE å±‚ / Complete Sparse MoE Layer</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SparseMoE</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;
    ç¨€ç–æ··åˆä¸“å®¶å±‚ / Sparse Mixture of Experts Layer

    ç‰¹ç‚¹ / Features:
    1. Top-K è·¯ç”± / Top-K routing
    2. è´Ÿè½½å‡è¡¡æŸå¤± / Load balancing loss
    3. ä¸“å®¶å®¹é‡é™åˆ¶ / Expert capacity limit
    &quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, d_model, d_ff, num_experts, top_k=<span class="hljs-number">2</span>, dropout=<span class="hljs-number">0.1</span>,
                 capacity_factor=<span class="hljs-number">1.25</span>, aux_loss_weight=<span class="hljs-number">0.01</span></span>):
        <span class="hljs-built_in">super</span>().__init__()

        <span class="hljs-variable language_">self</span>.d_model = d_model
        <span class="hljs-variable language_">self</span>.num_experts = num_experts
        <span class="hljs-variable language_">self</span>.top_k = top_k
        <span class="hljs-variable language_">self</span>.capacity_factor = capacity_factor
        <span class="hljs-variable language_">self</span>.aux_loss_weight = aux_loss_weight

        <span class="hljs-comment"># ä¸“å®¶ç½‘ç»œ / Expert networks</span>
        <span class="hljs-variable language_">self</span>.experts = nn.ModuleList([
            Expert(d_model, d_ff, dropout) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_experts)
        ])

        <span class="hljs-comment"># è·¯ç”±å™¨ / Router</span>
        <span class="hljs-variable language_">self</span>.gate = nn.Linear(d_model, num_experts, bias=<span class="hljs-literal">False</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-string">&quot;&quot;&quot;
        å‚æ•° / Args:
            x: [batch, seq_len, d_model]

        è¿”å› / Returns:
            output: [batch, seq_len, d_model]
            aux_loss: è´Ÿè½½å‡è¡¡è¾…åŠ©æŸå¤±
        &quot;&quot;&quot;</span>
        batch_size, seq_len, d_model = x.shape
        total_tokens = batch_size * seq_len

        <span class="hljs-comment"># 1. è®¡ç®—è·¯ç”±åˆ†æ•° / Compute routing scores</span>
        logits = <span class="hljs-variable language_">self</span>.gate(x)  <span class="hljs-comment"># [batch, seq_len, num_experts]</span>

        <span class="hljs-comment"># 2. Top-K é€‰æ‹© / Top-K selection</span>
        top_k_logits, top_k_indices = torch.topk(logits, <span class="hljs-variable language_">self</span>.top_k, dim=-<span class="hljs-number">1</span>)
        top_k_gates = F.softmax(top_k_logits, dim=-<span class="hljs-number">1</span>)  <span class="hljs-comment"># [batch, seq_len, top_k]</span>

        <span class="hljs-comment"># 3. åˆå§‹åŒ–è¾“å‡º / Initialize output</span>
        output = torch.zeros_like(x)

        <span class="hljs-comment"># 4. åˆ†å‘åˆ°ä¸“å®¶ / Dispatch to experts</span>
        <span class="hljs-comment"># ä¸ºæ¯ä¸ªä¸“å®¶æ”¶é›†éœ€è¦å¤„ç†çš„ token</span>
        <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-variable language_">self</span>.top_k):
            <span class="hljs-keyword">for</span> expert_idx <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-variable language_">self</span>.num_experts):
                <span class="hljs-comment"># æ‰¾å‡ºåœ¨è¿™ä¸ªä½ç½®é€‰æ‹©è¯¥ä¸“å®¶çš„æ‰€æœ‰ token</span>
                mask = (top_k_indices[:, :, k] == expert_idx)  <span class="hljs-comment"># [batch, seq_len]</span>

                <span class="hljs-keyword">if</span> mask.<span class="hljs-built_in">sum</span>() == <span class="hljs-number">0</span>:
                    <span class="hljs-keyword">continue</span>

                <span class="hljs-comment"># æå–è¿™äº› token</span>
                selected_tokens = x[mask]  <span class="hljs-comment"># [num_selected, d_model]</span>
                gate_weights = top_k_gates[:, :, k][mask]  <span class="hljs-comment"># [num_selected]</span>

                <span class="hljs-comment"># é€šè¿‡ä¸“å®¶å¤„ç† / Process through expert</span>
                expert_output = <span class="hljs-variable language_">self</span>.experts[expert_idx](selected_tokens)

                <span class="hljs-comment"># åŠ æƒå¹¶ç´¯åŠ åˆ°è¾“å‡º / Weight and accumulate to output</span>
                output[mask] += gate_weights.unsqueeze(-<span class="hljs-number">1</span>) * expert_output

        <span class="hljs-comment"># 5. è®¡ç®—è¾…åŠ©æŸå¤± / Compute auxiliary loss</span>
        aux_loss = <span class="hljs-variable language_">self</span>._compute_aux_loss(top_k_gates, top_k_indices)

        <span class="hljs-keyword">return</span> output, aux_loss

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_compute_aux_loss</span>(<span class="hljs-params">self, gates, indices</span>):
        <span class="hljs-string">&quot;&quot;&quot;è®¡ç®—è´Ÿè½½å‡è¡¡æŸå¤± / Compute load balancing loss&quot;&quot;&quot;</span>
        <span class="hljs-comment"># f_i: åˆ†é…ç»™ä¸“å®¶ i çš„ token æ¯”ä¾‹</span>
        f = torch.zeros(<span class="hljs-variable language_">self</span>.num_experts, device=gates.device)
        <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-variable language_">self</span>.top_k):
            <span class="hljs-keyword">for</span> idx <span class="hljs-keyword">in</span> indices[:, :, k].flatten():
                f[idx] += <span class="hljs-number">1</span>
        f = f / (gates.shape[<span class="hljs-number">0</span>] * gates.shape[<span class="hljs-number">1</span>] * <span class="hljs-variable language_">self</span>.top_k)

        <span class="hljs-comment"># P_i: ä¸“å®¶ i çš„å¹³å‡è·¯ç”±æ¦‚ç‡</span>
        <span class="hljs-comment"># é‡å»ºå®Œæ•´çš„ gates çŸ©é˜µ</span>
        full_gates = torch.zeros(gates.shape[<span class="hljs-number">0</span>], gates.shape[<span class="hljs-number">1</span>],
                                  <span class="hljs-variable language_">self</span>.num_experts, device=gates.device)
        <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-variable language_">self</span>.top_k):
            full_gates.scatter_(-<span class="hljs-number">1</span>, indices[:, :, k:k+<span class="hljs-number">1</span>], gates[:, :, k:k+<span class="hljs-number">1</span>])
        P = full_gates.mean(dim=(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>))

        <span class="hljs-comment"># è¾…åŠ©æŸå¤±</span>
        aux_loss = <span class="hljs-variable language_">self</span>.num_experts * torch.<span class="hljs-built_in">sum</span>(f * P)

        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.aux_loss_weight * aux_loss

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 3. æµ‹è¯• Sparse MoE å±‚ / Test Sparse MoE Layer</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Sparse MoE å±‚æµ‹è¯• / Sparse MoE Layer Test&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

torch.manual_seed(<span class="hljs-number">42</span>)

d_model = <span class="hljs-number">128</span>
d_ff = <span class="hljs-number">512</span>
num_experts = <span class="hljs-number">8</span>
top_k = <span class="hljs-number">2</span>
batch_size, seq_len = <span class="hljs-number">4</span>, <span class="hljs-number">16</span>

<span class="hljs-comment"># åˆ›å»º MoE å±‚ / Create MoE layer</span>
moe = SparseMoE(d_model, d_ff, num_experts, top_k)

<span class="hljs-comment"># åˆ›å»ºè¾“å…¥ / Create input</span>
x = torch.randn(batch_size, seq_len, d_model)

<span class="hljs-comment"># å‰å‘ä¼ æ’­ / Forward pass</span>
output, aux_loss = moe(x)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\né…ç½® / Configuration:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  d_model: <span class="hljs-subst">{d_model}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  d_ff: <span class="hljs-subst">{d_ff}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  num_experts: <span class="hljs-subst">{num_experts}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  top_k: <span class="hljs-subst">{top_k}</span>&quot;</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nè¾“å…¥å½¢çŠ¶ / Input shape: <span class="hljs-subst">{x.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;è¾“å‡ºå½¢çŠ¶ / Output shape: <span class="hljs-subst">{output.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;è¾…åŠ©æŸå¤± / Aux loss: <span class="hljs-subst">{aux_loss.item():<span class="hljs-number">.6</span>f}</span>&quot;</span>)

<span class="hljs-comment"># å‚æ•°ç»Ÿè®¡ / Parameter statistics</span>
total_params = <span class="hljs-built_in">sum</span>(p.numel() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> moe.parameters())
expert_params = <span class="hljs-built_in">sum</span>(p.numel() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> moe.experts[<span class="hljs-number">0</span>].parameters())
router_params = <span class="hljs-built_in">sum</span>(p.numel() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> moe.gate.parameters())

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nå‚æ•°ç»Ÿè®¡ / Parameter statistics:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  æ€»å‚æ•° / Total: <span class="hljs-subst">{total_params:,}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  æ¯ä¸ª expert / Per expert: <span class="hljs-subst">{expert_params:,}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  è·¯ç”±å™¨ / Router: <span class="hljs-subst">{router_params:,}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  ç­‰æ•ˆç¨ å¯† FFN å‚æ•° / Equivalent dense FFN: <span class="hljs-subst">{d_model * d_ff * <span class="hljs-number">2</span>:,}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 4. MoE vs ç¨ å¯†å±‚å¯¹æ¯” / MoE vs Dense Layer Comparison</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;MoE vs ç¨ å¯†å±‚å¯¹æ¯” / MoE vs Dense Layer Comparison&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DenseFFN</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;æ ‡å‡†ç¨ å¯† FFN å±‚ / Standard dense FFN layer&quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, d_model, d_ff, dropout=<span class="hljs-number">0.1</span></span>):
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-variable language_">self</span>.w1 = nn.Linear(d_model, d_ff)
        <span class="hljs-variable language_">self</span>.w2 = nn.Linear(d_ff, d_model)
        <span class="hljs-variable language_">self</span>.dropout = nn.Dropout(dropout)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.w2(<span class="hljs-variable language_">self</span>.dropout(F.gelu(<span class="hljs-variable language_">self</span>.w1(x))))

<span class="hljs-comment"># å¯¹æ¯”å‚æ•°é‡ / Compare parameters</span>
dense_ffn = DenseFFN(d_model, d_ff)
moe_layer = SparseMoE(d_model, d_ff, num_experts, top_k)

dense_params = <span class="hljs-built_in">sum</span>(p.numel() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> dense_ffn.parameters())
moe_params = <span class="hljs-built_in">sum</span>(p.numel() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> moe_layer.parameters())
active_params = expert_params * top_k + router_params  <span class="hljs-comment"># æ¯æ¬¡æ¿€æ´»çš„å‚æ•°</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nå‚æ•°é‡å¯¹æ¯” / Parameter comparison:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  ç¨ å¯† FFN / Dense FFN: <span class="hljs-subst">{dense_params:,}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  MoE æ€»å‚æ•° / MoE total: <span class="hljs-subst">{moe_params:,}</span> (<span class="hljs-subst">{moe_params/dense_params:<span class="hljs-number">.1</span>f}</span>x)&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  MoE æ¿€æ´»å‚æ•° / MoE active: <span class="hljs-subst">{active_params:,}</span> (<span class="hljs-subst">{active_params/dense_params:<span class="hljs-number">.1</span>f}</span>x)&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 5. å¯è§†åŒ–ä¸“å®¶ä½¿ç”¨æƒ…å†µ / Visualize Expert Usage</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ä¸“å®¶ä½¿ç”¨å¯è§†åŒ– / Expert Usage Visualization&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-comment"># å¤šæ¬¡å‰å‘ä¼ æ’­ï¼Œç»Ÿè®¡ä¸“å®¶ä½¿ç”¨ / Multiple forward passes, track expert usage</span>
expert_usage = torch.zeros(num_experts)

<span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):
    x_test = torch.randn(batch_size, seq_len, d_model)
    <span class="hljs-keyword">with</span> torch.no_grad():
        _, _, logits = moe.gate(x_test), <span class="hljs-literal">None</span>, moe.gate(x_test)
        logits = moe.gate(x_test)
        _, indices = torch.topk(logits, top_k, dim=-<span class="hljs-number">1</span>)

        <span class="hljs-keyword">for</span> idx <span class="hljs-keyword">in</span> indices.flatten():
            expert_usage[idx] += <span class="hljs-number">1</span>

<span class="hljs-comment"># å¯è§†åŒ– / Visualize</span>
plt.figure(figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">5</span>))

plt.subplot(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>)
plt.bar(<span class="hljs-built_in">range</span>(num_experts), expert_usage.numpy())
plt.xlabel(<span class="hljs-string">&#x27;Expert ID&#x27;</span>)
plt.ylabel(<span class="hljs-string">&#x27;Usage Count&#x27;</span>)
plt.title(<span class="hljs-string">&#x27;Expert Usage Distribution&#x27;</span>)

<span class="hljs-comment"># ç»˜åˆ¶æ¿€æ´»æ¨¡å¼ / Plot activation pattern</span>
plt.subplot(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>)
x_vis = torch.randn(<span class="hljs-number">1</span>, <span class="hljs-number">20</span>, d_model)
<span class="hljs-keyword">with</span> torch.no_grad():
    logits_vis = moe.gate(x_vis)
    _, indices_vis = torch.topk(logits_vis, top_k, dim=-<span class="hljs-number">1</span>)

<span class="hljs-comment"># åˆ›å»ºçƒ­åŠ›å›¾ / Create heatmap</span>
activation_map = torch.zeros(<span class="hljs-number">20</span>, num_experts)
<span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">20</span>):
    <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(top_k):
        activation_map[t, indices_vis[<span class="hljs-number">0</span>, t, k]] = <span class="hljs-number">1</span>

plt.imshow(activation_map.numpy(), cmap=<span class="hljs-string">&#x27;Blues&#x27;</span>, aspect=<span class="hljs-string">&#x27;auto&#x27;</span>)
plt.xlabel(<span class="hljs-string">&#x27;Expert ID&#x27;</span>)
plt.ylabel(<span class="hljs-string">&#x27;Token Position&#x27;</span>)
plt.title(<span class="hljs-string">&#x27;Expert Activation Pattern&#x27;</span>)

plt.tight_layout()
plt.savefig(<span class="hljs-string">&#x27;/tmp/moe_expert_usage.png&#x27;</span>, dpi=<span class="hljs-number">150</span>, bbox_inches=<span class="hljs-string">&#x27;tight&#x27;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nä¸“å®¶ä½¿ç”¨å›¾åƒå·²ä¿å­˜è‡³ / Expert usage image saved to: /tmp/moe_expert_usage.png&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># 6. åœ¨ Transformer ä¸­ä½¿ç”¨ MoE / Using MoE in Transformer</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;åœ¨ Transformer ä¸­ä½¿ç”¨ MoE / Using MoE in Transformer&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">TransformerBlockWithMoE</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;
    ä½¿ç”¨ MoE çš„ Transformer Block
    Transformer Block with MoE
    &quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, d_model, num_heads, d_ff, num_experts, top_k=<span class="hljs-number">2</span>, dropout=<span class="hljs-number">0.1</span></span>):
        <span class="hljs-built_in">super</span>().__init__()

        <span class="hljs-comment"># Attention</span>
        <span class="hljs-variable language_">self</span>.norm1 = nn.LayerNorm(d_model)
        <span class="hljs-variable language_">self</span>.attention = nn.MultiheadAttention(d_model, num_heads, batch_first=<span class="hljs-literal">True</span>)

        <span class="hljs-comment"># MoE FFN</span>
        <span class="hljs-variable language_">self</span>.norm2 = nn.LayerNorm(d_model)
        <span class="hljs-variable language_">self</span>.moe = SparseMoE(d_model, d_ff, num_experts, top_k, dropout)

        <span class="hljs-variable language_">self</span>.dropout = nn.Dropout(dropout)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-comment"># Self-Attention with Pre-LN</span>
        residual = x
        x = <span class="hljs-variable language_">self</span>.norm1(x)
        x, _ = <span class="hljs-variable language_">self</span>.attention(x, x, x)
        x = residual + <span class="hljs-variable language_">self</span>.dropout(x)

        <span class="hljs-comment"># MoE FFN with Pre-LN</span>
        residual = x
        x = <span class="hljs-variable language_">self</span>.norm2(x)
        x, aux_loss = <span class="hljs-variable language_">self</span>.moe(x)
        x = residual + <span class="hljs-variable language_">self</span>.dropout(x)

        <span class="hljs-keyword">return</span> x, aux_loss

<span class="hljs-comment"># åˆ›å»ºå¹¶æµ‹è¯• / Create and test</span>
block = TransformerBlockWithMoE(
    d_model=<span class="hljs-number">256</span>, num_heads=<span class="hljs-number">4</span>, d_ff=<span class="hljs-number">1024</span>, num_experts=<span class="hljs-number">8</span>, top_k=<span class="hljs-number">2</span>
)

x_test = torch.randn(<span class="hljs-number">2</span>, <span class="hljs-number">32</span>, <span class="hljs-number">256</span>)
output, aux_loss = block(x_test)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nTransformer Block with MoE:&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  è¾“å…¥å½¢çŠ¶ / Input shape: <span class="hljs-subst">{x_test.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  è¾“å‡ºå½¢çŠ¶ / Output shape: <span class="hljs-subst">{output.shape}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  è¾…åŠ©æŸå¤± / Aux loss: <span class="hljs-subst">{aux_loss.item():<span class="hljs-number">.6</span>f}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  å‚æ•°é‡ / Parameters: <span class="hljs-subst">{<span class="hljs-built_in">sum</span>(p.numel() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> block.parameters()):,}</span>&quot;</span>)

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># æ€»ç»“ / Summary</span>
<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;æ€»ç»“ / Summary&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)
<span class="hljs-string">&quot;&quot;&quot;
æœ¬ç¤ºä¾‹å±•ç¤ºäº† Sparse MoE å±‚çš„å®Œæ•´å®ç°:
This example demonstrates a complete Sparse MoE layer:

1. ç»„ä»¶ / Components:
   - Expert: å•ä¸ªä¸“å®¶ç½‘ç»œï¼ˆé€šå¸¸æ˜¯ FFNï¼‰
   - Router: Top-K è·¯ç”±å™¨
   - Load Balancing: è´Ÿè½½å‡è¡¡æœºåˆ¶

2. ä¼˜åŠ¿ / Advantages:
   - å‚æ•°é‡å¤§ï¼Œä½†æ¿€æ´»å‚æ•°å°‘
   - å¯ä»¥å¢åŠ æ¨¡å‹å®¹é‡è€Œä¸å¢åŠ è®¡ç®—é‡
   - é€‚åˆå¤§è§„æ¨¡æ¨¡å‹

3. è®­ç»ƒè€ƒè™‘ / Training considerations:
   - éœ€è¦è¾…åŠ©æŸå¤±ä¿è¯è´Ÿè½½å‡è¡¡
   - è·¯ç”±å™¨éœ€è¦å•ç‹¬çš„å­¦ä¹ ç‡è®¾ç½®
   - å¯èƒ½éœ€è¦å®¹é‡é™åˆ¶é˜²æ­¢è¿‡è½½

4. å®é™…åº”ç”¨ / Real-world applications:
   - Mixtral 8x7B
   - GPT-4 (æ®æŠ¥é“)
   - DeepSeek-MoE
   - Switch Transformer
&quot;&quot;&quot;</span>
</code></pre></div></div></div><div class="chapter"><h1>ç¬¬10ç«  Fine-tuning å¾®è°ƒæŠ€æœ¯</h1><h1>Fine-tuningï¼ˆå¾®è°ƒï¼‰</h1>
<p>å¾®è°ƒæ˜¯åœ¨é¢„è®­ç»ƒæ¨¡å‹åŸºç¡€ä¸Šï¼Œä½¿ç”¨ç‰¹å®šé¢†åŸŸæ•°æ®è¿›ä¸€æ­¥è®­ç»ƒï¼Œä½¿æ¨¡å‹é€‚åº”ç‰¹å®šä»»åŠ¡æˆ–é¢†åŸŸçš„æŠ€æœ¯ã€‚</p>
<h2>æ¨¡å—ç»“æ„</h2>
<pre class="hljs"><code>fine-tuning/
â”œâ”€â”€ lora-finetune/      # LoRA/QLoRA å‚æ•°é«˜æ•ˆå¾®è°ƒ
â”‚   â”œâ”€â”€ beginner-guide.md
â”‚   â”œâ”€â”€ advanced-guide.md
â”‚   â”œâ”€â”€ diagram.md
â”‚   â””â”€â”€ examples/
â””â”€â”€ full-finetune/      # å…¨å‚æ•°å¾®è°ƒ
    â”œâ”€â”€ beginner-guide.md
    â”œâ”€â”€ advanced-guide.md
    â”œâ”€â”€ diagram.md
    â””â”€â”€ examples/
</code></pre>
<h2>å­¦ä¹ è·¯å¾„</h2>
<h3>1. LoRA å¾®è°ƒï¼ˆæ¨èå…¥é—¨ï¼‰</h3>
<p>LoRA æ˜¯ç›®å‰æœ€æµè¡Œçš„å¾®è°ƒæ–¹æ³•ï¼Œåªè®­ç»ƒ ~1% çš„å‚æ•°å°±èƒ½è¾¾åˆ°æ¥è¿‘å…¨å‚æ•°å¾®è°ƒçš„æ•ˆæœã€‚</p>
<ul>
<li><strong>ç§‘æ™®ç‰ˆ</strong>: <a href="lora-finetune/beginner-guide.md">beginner-guide.md</a> - ç†è§£ LoRA çš„&quot;ä¾¿åˆ©è´´&quot;ç±»æ¯”</li>
<li><strong>æ·±å…¥ç‰ˆ</strong>: <a href="lora-finetune/advanced-guide.md">advanced-guide.md</a> - ä½ç§©åˆ†è§£çš„æ•°å­¦åŸç†</li>
<li><strong>æµç¨‹å›¾</strong>: <a href="lora-finetune/diagram.md">diagram.md</a> - å¯è§†åŒ–ç†è§£ LoRA æµç¨‹</li>
</ul>
<h3>2. å…¨å‚æ•°å¾®è°ƒ</h3>
<p>å…¨å‚æ•°å¾®è°ƒæ•ˆæœæœ€å¥½ï¼Œä½†éœ€è¦å¤§é‡è®¡ç®—èµ„æºã€‚</p>
<ul>
<li><strong>ç§‘æ™®ç‰ˆ</strong>: <a href="full-finetune/beginner-guide.md">beginner-guide.md</a> - ä½•æ—¶é€‰æ‹©å…¨å‚æ•°å¾®è°ƒ</li>
<li><strong>æ·±å…¥ç‰ˆ</strong>: <a href="full-finetune/advanced-guide.md">advanced-guide.md</a> - è®­ç»ƒæŠ€å·§ä¸ä¼˜åŒ–</li>
<li><strong>æµç¨‹ï¿½ï¿½</strong>: <a href="full-finetune/diagram.md">diagram.md</a> - å®Œæ•´å¾®è°ƒæµç¨‹</li>
</ul>
<h2>æ–¹æ³•å¯¹æ¯”</h2>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>LoRA</th>
<th>QLoRA</th>
<th>å…¨å‚æ•°å¾®è°ƒ</th>
</tr>
</thead>
<tbody>
<tr>
<td>å¯è®­ç»ƒå‚æ•°</td>
<td>~1%</td>
<td>~1%</td>
<td>100%</td>
</tr>
<tr>
<td>æ˜¾å­˜éœ€æ±‚</td>
<td>ä½</td>
<td>æœ€ä½</td>
<td>é«˜</td>
</tr>
<tr>
<td>è®­ç»ƒé€Ÿåº¦</td>
<td>å¿«</td>
<td>å¿«</td>
<td>æ…¢</td>
</tr>
<tr>
<td>æ•ˆæœä¸Šé™</td>
<td>æ¥è¿‘å…¨å‚æ•°</td>
<td>æ¥è¿‘ LoRA</td>
<td>æœ€é«˜</td>
</tr>
<tr>
<td>å­˜å‚¨æˆæœ¬</td>
<td>å°ï¼ˆ~200MBï¼‰</td>
<td>å°ï¼ˆ~200MBï¼‰</td>
<td>å¤§ï¼ˆ~14GBï¼‰</td>
</tr>
</tbody>
</table>
<h2>å¿«é€Ÿé€‰æ‹©æŒ‡å—</h2>
<p><div class="mermaid">flowchart TD
    A["éœ€è¦å¾®è°ƒå¤§æ¨¡å‹"] --&gt; B{"ä»»åŠ¡ä¸é¢„è®­ç»ƒå·®å¼‚?"}
    B --&gt;|"å¤§"| C{"æœ‰å……è¶³èµ„æº?"}
    B --&gt;|"å°"| D["LoRA"]

    C --&gt;|"æ˜¯"| E["å…¨å‚æ•°å¾®è°ƒ"]
    C --&gt;|"å¦"| F{"æ˜¾å­˜ &lt; 24GB?"}
    F --&gt;|"æ˜¯"| G["QLoRA"]
    F --&gt;|"å¦"| D

    style D fill:#c8e6c9
    style G fill:#c8e6c9</div></p>
<h2>ä»£ç ç¤ºä¾‹</h2>
<table>
<thead>
<tr>
<th>ç¤ºä¾‹</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="lora-finetune/examples/lora_example.py">lora_example.py</a></td>
<td>LoRA å¾®è°ƒå®Œæ•´æµç¨‹</td>
</tr>
<tr>
<td><a href="lora-finetune/examples/qlora_example.py">qlora_example.py</a></td>
<td>QLoRA 4-bit é‡åŒ–å¾®è°ƒ</td>
</tr>
<tr>
<td><a href="full-finetune/examples/full_finetune_example.py">full_finetune_example.py</a></td>
<td>å…¨å‚æ•°å¾®è°ƒç¤ºä¾‹</td>
</tr>
</tbody>
</table>
<h2>å­¦ä¹ å»ºè®®</h2>
<ol>
<li><strong>ä» LoRA å¼€å§‹</strong>ï¼šå¤§å¤šæ•°åœºæ™¯ LoRA è¶³å¤Ÿ</li>
<li><strong>ç†è§£ QLoRA</strong>ï¼šèµ„æºæœ‰é™æ—¶çš„æœ€ä½³é€‰æ‹©</li>
<li><strong>è°¨æ…ä½¿ç”¨å…¨å‚æ•°å¾®è°ƒ</strong>ï¼šä»…åœ¨å¿…è¦æ—¶ä½¿ç”¨</li>
</ol>
<h2>å‰ç½®çŸ¥è¯†</h2>
<ul>
<li>ç§‘æ™®ç‰ˆï¼šæ— éœ€åŸºç¡€</li>
<li>æ·±å…¥ç‰ˆï¼šçº¿æ€§ä»£æ•°ã€æ·±åº¦å­¦ä¹ åŸºç¡€</li>
<li>ä»£ç ç¤ºä¾‹ï¼šPythonã€PyTorchã€Hugging Face</li>
</ul>
<h2 class="subtopic-title">10.1 å…¨é‡å¾®è°ƒ (Full Fine-tuning)</h2><h1>å…¨å‚æ•°å¾®è°ƒç§‘æ™®ç‰ˆ</h1>
<blockquote>
<p>é¢å‘é›¶åŸºç¡€è¯»è€…çš„å…¨å‚æ•°å¾®è°ƒå…¥é—¨æŒ‡å—</p>
</blockquote>
<h2>ä¸€å¥è¯æ¦‚æ‹¬</h2>
<p><strong>å…¨å‚æ•°å¾®è°ƒå°±æ˜¯æŠŠå¤§æ¨¡å‹çš„æ‰€æœ‰å‚æ•°éƒ½é‡æ–°è®­ç»ƒä¸€éï¼Œè®©å®ƒå®Œå…¨é€‚åº”æ–°ä»»åŠ¡ã€‚</strong></p>
<h2>ä»ä¸€ä¸ªé—®é¢˜å¼€å§‹</h2>
<p>æƒ³è±¡ä½ æœ‰ä¸€ä¸ªå…¨èƒ½çš„ AI åŠ©æ‰‹ï¼Œå®ƒä»€ä¹ˆéƒ½çŸ¥é“ä¸€ç‚¹ã€‚ä½†æ˜¯ä½ å¸Œæœ›å®ƒï¼š</p>
<ul>
<li>æˆä¸ºåŒ»å­¦ä¸“å®¶</li>
<li>å­¦ä¼šç”¨æ³•å¾‹æœ¯è¯­è¯´è¯</li>
<li>æŒæ¡ä½ ä»¬å…¬å¸çš„å†…éƒ¨çŸ¥è¯†</li>
</ul>
<p>æœ€ç›´æ¥çš„æ–¹æ³•æ˜¯ä»€ä¹ˆï¼Ÿ<strong>æŠŠå®ƒçš„&quot;å¤§è„‘&quot;å½»åº•æ”¹é€ ä¸€éï¼</strong></p>
<p>è¿™å°±æ˜¯å…¨å‚æ•°å¾®è°ƒåšçš„äº‹æƒ…ã€‚</p>
<h2>ä»€ä¹ˆæ˜¯å…¨å‚æ•°å¾®è°ƒï¼Ÿ</h2>
<p>å…¨å‚æ•°å¾®è°ƒï¼ˆFull Fine-tuningï¼‰æ˜¯æŒ‡åœ¨é¢„è®­ç»ƒæ¨¡å‹çš„åŸºç¡€ä¸Šï¼Œä½¿ç”¨ç‰¹å®šä»»åŠ¡çš„æ•°æ®ï¼Œ<strong>æ›´æ–°æ¨¡å‹çš„æ‰€æœ‰å‚æ•°</strong>ã€‚</p>
<h3>ç”Ÿæ´»ä¸­çš„ç±»æ¯”</h3>
<p>æƒ³è±¡ä½ æœ‰ä¸€ä¸ªé€šç”¨æŠ€èƒ½çš„å‘˜å·¥ï¼š</p>
<ul>
<li><strong>é¢„è®­ç»ƒ</strong>ï¼šå‘˜å·¥åœ¨å¤§å­¦é‡Œå­¦äº†å„ç§åŸºç¡€çŸ¥è¯†</li>
<li><strong>å…¨å‚æ•°å¾®è°ƒ</strong>ï¼šæŠŠä»–é€åˆ°ä¸“ä¸šåŸ¹è®­æœºæ„ï¼Œä»å¤´åˆ°å°¾é‡æ–°åŸ¹è®­</li>
</ul>
<p>ç»“æœï¼šä»–å˜æˆäº†ä¸€ä¸ªä¸“ä¸šäººæ‰ï¼Œä½†å¯èƒ½å¿˜è®°äº†ä¹‹å‰çš„ä¸€äº›é€šç”¨æŠ€èƒ½ã€‚</p>
<h2>ä¸ LoRA çš„å¯¹æ¯”</h2>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>å…¨å‚æ•°å¾®è°ƒ</th>
<th>LoRA</th>
</tr>
</thead>
<tbody>
<tr>
<td>è®­ç»ƒå‚æ•°é‡</td>
<td>100%</td>
<td>~1%</td>
</tr>
<tr>
<td>æ˜¾å­˜éœ€æ±‚</td>
<td>éå¸¸é«˜</td>
<td>è¾ƒä½</td>
</tr>
<tr>
<td>è®­ç»ƒæ—¶é—´</td>
<td>é•¿</td>
<td>çŸ­</td>
</tr>
<tr>
<td>æ•ˆæœä¸Šé™</td>
<td>æœ€é«˜</td>
<td>æ¥è¿‘å…¨å‚æ•°</td>
</tr>
<tr>
<td>ç¾éš¾æ€§é—å¿˜é£é™©</td>
<td>é«˜</td>
<td>ä½</td>
</tr>
<tr>
<td>å­˜å‚¨æˆæœ¬</td>
<td>æ¯ä¸ªç‰ˆæœ¬ä¸€ä¸ªå®Œæ•´æ¨¡å‹</td>
<td>åªéœ€å­˜å°é€‚é…å™¨</td>
</tr>
</tbody>
</table>
<h2>å…¨å‚æ•°å¾®è°ƒçš„æµç¨‹</h2>
<p><div class="mermaid">flowchart LR
    A[é¢„è®­ç»ƒæ¨¡å‹] --&gt; B[å‡†å¤‡ä»»åŠ¡æ•°æ®]
    B --&gt; C[è®­ç»ƒæ‰€æœ‰å‚æ•°]
    C --&gt; D[å¾—åˆ°å¾®è°ƒæ¨¡å‹]
    D --&gt; E[éƒ¨ç½²ä½¿ç”¨]</div></p>
<h3>ç®€å•æ¥è¯´</h3>
<ol>
<li><strong>åŠ è½½é¢„è®­ç»ƒæ¨¡å‹</strong>ï¼šæ¯”å¦‚ GPTã€LLaMA</li>
<li><strong>å‡†å¤‡ä½ çš„æ•°æ®</strong>ï¼šç‰¹å®šé¢†åŸŸçš„é—®ç­”ã€æ–‡ç« ç­‰</li>
<li><strong>è®­ç»ƒæ‰€æœ‰å‚æ•°</strong>ï¼šè®©æ¨¡å‹é€‚åº”ä½ çš„ä»»åŠ¡</li>
<li><strong>ä¿å­˜æ–°æ¨¡å‹</strong>ï¼šå¾—åˆ°ä¸€ä¸ªä¸“é—¨åŒ–çš„å¤§æ¨¡å‹</li>
</ol>
<h2>ä¼˜ç‚¹</h2>
<ul>
<li><strong>æ•ˆæœæœ€å¥½</strong>ï¼šæ‰€æœ‰å‚æ•°éƒ½èƒ½è°ƒæ•´ï¼Œç†è®ºä¸Šèƒ½å­¦åˆ°æœ€å¤š</li>
<li><strong>çŸ¥è¯†èåˆæ·±å…¥</strong>ï¼šæ–°çŸ¥è¯†å’ŒåŸæœ‰çŸ¥è¯†æ·±åº¦èåˆ</li>
<li><strong>é€‚åˆå¤§å˜åŒ–</strong>ï¼šä»»åŠ¡ä¸é¢„è®­ç»ƒå·®å¼‚å¤§æ—¶æ•ˆæœå¥½</li>
</ul>
<h2>ç¼ºç‚¹</h2>
<h3>å¤ªè´µäº†</h3>
<table>
<thead>
<tr>
<th>æ¨¡å‹è§„æ¨¡</th>
<th>å…¨å‚æ•°å¾®è°ƒæ˜¾å­˜</th>
<th>å¤§çº¦æˆæœ¬</th>
</tr>
</thead>
<tbody>
<tr>
<td>7B</td>
<td>~60GB</td>
<td>å•å¡ A100</td>
</tr>
<tr>
<td>13B</td>
<td>~120GB</td>
<td>2x A100</td>
</tr>
<tr>
<td>70B</td>
<td>~600GB</td>
<td>8x A100</td>
</tr>
<tr>
<td>175B</td>
<td>~1500GB</td>
<td>å¤šæœºé›†ç¾¤</td>
</tr>
</tbody>
</table>
<h3>ç¾éš¾æ€§é—å¿˜</h3>
<p>æ¨¡å‹å¯èƒ½&quot;å­¦äº†æ–°çš„ï¼Œå¿˜äº†æ—§çš„&quot;ï¼š</p>
<ul>
<li>åŸæ¥ä¼šå†™ä»£ç ï¼Œå¾®è°ƒåå¯èƒ½å˜å·®äº†</li>
<li>åŸæ¥ä¼šå¤šè¯­è¨€ï¼Œå¾®è°ƒåå¯èƒ½åªæ‡‚ä¸€ç§äº†</li>
</ul>
<h3>å­˜å‚¨é—®é¢˜</h3>
<p>æ¯ä¸ªå¾®è°ƒç‰ˆæœ¬éƒ½æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ¨¡å‹ï¼š</p>
<ul>
<li>10 ä¸ªå¾®è°ƒç‰ˆæœ¬ = 10 ä¸ª 70GB çš„æ–‡ä»¶</li>
<li>LoRA åªéœ€è¦ 10 ä¸ªå‡ ç™¾ MB çš„é€‚é…å™¨</li>
</ul>
<h2>ä»€ä¹ˆæ—¶å€™ç”¨å…¨å‚æ•°å¾®è°ƒï¼Ÿ</h2>
<p><strong>æ¨èç”¨ï¼š</strong></p>
<ul>
<li>ä»»åŠ¡ä¸é¢„è®­ç»ƒå·®å¼‚å·¨å¤§ï¼ˆæ¯”å¦‚åŒ»å­¦ã€æ³•å¾‹ä¸“ä¸šé¢†åŸŸï¼‰</li>
<li>è¿½æ±‚æè‡´æ•ˆæœ</li>
<li>æœ‰å……è¶³çš„è®¡ç®—èµ„æº</li>
</ul>
<p><strong>ä¸æ¨èç”¨ï¼š</strong></p>
<ul>
<li>åªæ˜¯å°èŒƒå›´è°ƒæ•´ï¼ˆç”¨ LoRA æ›´å¥½ï¼‰</li>
<li>èµ„æºæœ‰é™</li>
<li>éœ€è¦å¤šä¸ªå®šåˆ¶ç‰ˆæœ¬</li>
</ul>
<h2>å®é™…æ¡ˆä¾‹</h2>
<h3>æˆåŠŸæ¡ˆä¾‹ï¼šInstructGPT</h3>
<p>OpenAI ä½¿ç”¨å…¨å‚æ•°å¾®è°ƒ + äººç±»åé¦ˆï¼ˆRLHFï¼‰ï¼Œè®© GPT å­¦ä¼šéµå¾ªæŒ‡ä»¤ã€‚</p>
<h3>æˆåŠŸæ¡ˆä¾‹ï¼šåŒ»å­¦å¤§æ¨¡å‹</h3>
<p>åœ¨åŒ»å­¦æ–‡çŒ®ä¸Šå…¨å‚æ•°å¾®è°ƒï¼Œæ¨¡å‹èƒ½å‡†ç¡®å›ç­”åŒ»å­¦é—®é¢˜ã€‚</p>
<h2>ä½ éœ€è¦è®°ä½çš„</h2>
<table>
<thead>
<tr>
<th>æ¦‚å¿µ</th>
<th>é€šä¿—ç†è§£</th>
</tr>
</thead>
<tbody>
<tr>
<td>å…¨å‚æ•°å¾®è°ƒ</td>
<td>æŠŠæ¨¡å‹æ‰€æœ‰å‚æ•°éƒ½é‡æ–°è®­ç»ƒ</td>
</tr>
<tr>
<td>ç¾éš¾æ€§é—å¿˜</td>
<td>å­¦äº†æ–°çš„ï¼Œå¿˜äº†æ—§çš„</td>
</tr>
<tr>
<td>é¢„è®­ç»ƒæ¨¡å‹</td>
<td>é€šç”¨çŸ¥è¯†çš„&quot;å¤§å­¦æ¯•ä¸šç”Ÿ&quot;</td>
</tr>
<tr>
<td>å¾®è°ƒåçš„æ¨¡å‹</td>
<td>ä¸“ä¸šåŸ¹è®­åçš„&quot;ä¸“å®¶&quot;</td>
</tr>
</tbody>
</table>
<h2>ä¸‹ä¸€æ­¥</h2>
<ul>
<li>æƒ³äº†è§£æŠ€æœ¯ç»†èŠ‚ï¼Ÿé˜…è¯» <a href="advanced-guide.md">æ·±å…¥ç‰ˆ</a></li>
<li>æƒ³çœ‹ä»£ç å®ç°ï¼ŸæŸ¥çœ‹ <code>examples/</code> ç›®å½•</li>
<li>æƒ³çœ‹æµç¨‹å›¾ï¼ŸæŸ¥çœ‹ <a href="diagram.md">æµç¨‹å›¾è§£</a></li>
</ul>
<h1>å…¨å‚æ•°å¾®è°ƒæ·±å…¥ç‰ˆ</h1>
<blockquote>
<p>é¢å‘æœ‰æœºå™¨å­¦ä¹ åŸºç¡€è¯»è€…çš„æŠ€æœ¯è¯¦è§£</p>
</blockquote>
<h2>æ¦‚è¿°</h2>
<p>å…¨å‚æ•°å¾®è°ƒï¼ˆFull Fine-tuningï¼‰æ˜¯æŒ‡åœ¨é¢„è®­ç»ƒæ¨¡å‹ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> çš„åŸºç¡€ä¸Šï¼Œä½¿ç”¨ç›®æ ‡ä»»åŠ¡æ•°æ® <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>ï¼Œé€šè¿‡æ¢¯åº¦ä¸‹é™æ›´æ–°æ‰€æœ‰å‚æ•°ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:3.0954em;vertical-align:-1.2671em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Î·</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8829em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.2671em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord">âˆ‡</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">W</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathcal">L</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.1389em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3473em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><a id="formula-full-finetune-1"></a>
<a href="#formula-full-finetune-1-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šä»é¢„è®­ç»ƒæƒé‡å‡ºå‘ï¼Œç”¨ç›®æ ‡ä»»åŠ¡æ•°æ®åšæ¢¯åº¦ä¸‹é™æ›´æ–°æ‰€æœ‰å‚æ•°ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºé¢„è®­ç»ƒæƒé‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Î·</span></span></span></span> ä¸ºå­¦ä¹ ç‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathcal">L</span></span></span></span> ä¸ºæŸå¤±å‡½æ•°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span> ä¸ºè®­ç»ƒæ­¥æ•°ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šå…¨å‚æ•°æ›´æ–°è®©æ¨¡å‹å……åˆ†é€‚åº”æ–°ä»»åŠ¡ï¼Œæ•ˆæœé€šå¸¸æœ€å¥½ä½†æ˜¾å­˜éœ€æ±‚å¤§ã€‚</li>
</ul>
<p>å…¶ä¸­ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Î·</span></span></span></span> æ˜¯å­¦ä¹ ç‡ï¼Œ<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathcal">L</span></span></span></span> æ˜¯æŸå¤±å‡½æ•°ï¼Œ<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span> æ˜¯è®­ç»ƒæ­¥æ•°ã€‚</p>
<h2>è®­ç»ƒåŠ¨åŠ›å­¦</h2>
<h3>å­¦ä¹ ç‡è°ƒåº¦</h3>
<p>å…¨å‚æ•°å¾®è°ƒçš„å­¦ä¹ ç‡è°ƒåº¦è‡³å…³é‡è¦ï¼š</p>
<pre class="hljs"><code><span class="hljs-comment"># å¸¸è§çš„å­¦ä¹ ç‡è°ƒåº¦ç­–ç•¥</span>
<span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> get_cosine_schedule_with_warmup

scheduler = get_cosine_schedule_with_warmup(
    optimizer,
    num_warmup_steps=<span class="hljs-number">100</span>,      <span class="hljs-comment"># é¢„çƒ­æ­¥æ•°</span>
    num_training_steps=<span class="hljs-number">10000</span>   <span class="hljs-comment"># æ€»è®­ç»ƒæ­¥æ•°</span>
)
</code></pre>
<p><strong>å…³é”®ç‚¹</strong>ï¼š</p>
<ul>
<li><strong>é¢„çƒ­ï¼ˆWarmupï¼‰</strong>ï¼šä»å°å­¦ä¹ ç‡é€æ¸å¢å¤§ï¼Œé¿å…åˆæœŸéœ‡è¡</li>
<li><strong>è¡°å‡ï¼ˆDecayï¼‰</strong>ï¼šåæœŸå‡å°å­¦ä¹ ç‡ï¼Œç¨³å®šæ”¶æ•›</li>
</ul>
<h3>å­¦ä¹ ç‡é€‰æ‹©</h3>
<table>
<thead>
<tr>
<th>é˜¶æ®µ</th>
<th>å­¦ä¹ ç‡èŒƒå›´</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>é¢„è®­ç»ƒ</td>
<td>1e-4 ~ 6e-4</td>
<td>è¾ƒé«˜å­¦ä¹ ç‡</td>
</tr>
<tr>
<td>å…¨å‚æ•°å¾®è°ƒ</td>
<td>1e-5 ~ 5e-5</td>
<td>é€šå¸¸æ¯”é¢„è®­ç»ƒä½ 10x</td>
</tr>
<tr>
<td>PEFT å¾®è°ƒ</td>
<td>1e-4 ~ 1e-3</td>
<td>å¯ä»¥æ›´é«˜ï¼ˆå‚æ•°å°‘ï¼‰</td>
</tr>
</tbody>
</table>
<h2>ä¼˜åŒ–æŠ€æœ¯</h2>
<h3>æ¢¯åº¦ç´¯ç§¯</h3>
<p>æ˜¾å­˜ä¸è¶³æ—¶ï¼Œç”¨æ—¶é—´æ¢ç©ºé—´ï¼š</p>
<pre class="hljs"><code>gradient_accumulation_steps = <span class="hljs-number">4</span>  <span class="hljs-comment"># ç´¯ç§¯ 4 æ­¥åæ›´æ–°</span>

<span class="hljs-comment"># æœ‰æ•ˆæ‰¹æ¬¡å¤§å° = batch_size Ã— accumulation_steps</span>
effective_batch_size = <span class="hljs-number">4</span> Ã— <span class="hljs-number">4</span> = <span class="hljs-number">16</span>
</code></pre>
<h3>æ··åˆç²¾åº¦è®­ç»ƒ</h3>
<p>ä½¿ç”¨ FP16/BF16 å‡å°‘æ˜¾å­˜ï¼ŒåŠ é€Ÿè®¡ç®—ï¼š</p>
<pre class="hljs"><code><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> TrainingArguments

args = TrainingArguments(
    fp16=<span class="hljs-literal">True</span>,              <span class="hljs-comment"># ä½¿ç”¨ FP16</span>
    fp16_opt_level=<span class="hljs-string">&quot;O1&quot;</span>,    <span class="hljs-comment"># ä¼˜åŒ–çº§åˆ«</span>
    <span class="hljs-comment"># æˆ–ä½¿ç”¨ BF16ï¼ˆAmpere åŠä»¥ä¸Š GPUï¼‰</span>
    bf16=<span class="hljs-literal">True</span>,
    tf32=<span class="hljs-literal">True</span>,              <span class="hljs-comment"># å¯ç”¨ TF32</span>
)
</code></pre>
<h3>æ¢¯åº¦æ£€æŸ¥ç‚¹</h3>
<p>ä»¥è®¡ç®—æ¢æ˜¾å­˜ï¼š</p>
<pre class="hljs"><code><span class="hljs-comment"># åªä¿å­˜éƒ¨åˆ†ä¸­é—´æ¿€æ´»ï¼Œéœ€è¦æ—¶é‡æ–°è®¡ç®—</span>
model.gradient_checkpointing_enable()
</code></pre>
<p><strong>æ˜¾å­˜èŠ‚çœ</strong>ï¼šçº¦ 30-50%
<strong>ä»£ä»·</strong>ï¼šè®­ç»ƒé€Ÿåº¦ä¸‹é™çº¦ 20%</p>
<h3>DeepSpeed / FSDP</h3>
<p>åˆ†å¸ƒå¼è®­ç»ƒç­–ç•¥ï¼š</p>
<table>
<thead>
<tr>
<th>æŠ€æœ¯</th>
<th>ç‰¹ç‚¹</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td>DDP</td>
<td>æ•°æ®å¹¶è¡Œï¼Œæ¯å¡å¤åˆ¶å®Œæ•´æ¨¡å‹</td>
<td>å°æ¨¡å‹</td>
</tr>
<tr>
<td>FSDP</td>
<td>åˆ†ç‰‡å¹¶è¡Œï¼Œæ¨¡å‹åˆ‡åˆ†åˆ°å¤šå¡</td>
<td>å¤§æ¨¡å‹</td>
</tr>
<tr>
<td>DeepSpeed ZeRO</td>
<td>ä¼˜åŒ–å™¨çŠ¶æ€åˆ†ç‰‡</td>
<td>è¶…å¤§æ¨¡å‹</td>
</tr>
</tbody>
</table>
<h2>ç¾éš¾æ€§é—å¿˜</h2>
<h3>é—®é¢˜å®šä¹‰</h3>
<p>å¾®è°ƒåæ¨¡å‹åœ¨åŸä»»åŠ¡ä¸Šæ€§èƒ½ä¸‹é™ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">Forgetting</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord text"><span class="mord">Perf</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">or</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord text"><span class="mord">Perf</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">or</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><a id="formula-full-finetune-2"></a>
<a href="#formula-full-finetune-2-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šé—å¿˜é‡ = é¢„è®­ç»ƒæ¨¡å‹åœ¨åŸä»»åŠ¡ä¸Šçš„æ€§èƒ½ - å¾®è°ƒååœ¨åŸä»»åŠ¡ä¸Šçš„æ€§èƒ½ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord text"><span class="mord">Perf</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºé¢„è®­ç»ƒæ¨¡å‹æ€§èƒ½ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord text"><span class="mord">Perf</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºå¾®è°ƒåæ¨¡å‹æ€§èƒ½ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">or</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºåŸä»»åŠ¡ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šé‡åŒ–å¾®è°ƒå¯¹åŸæœ‰èƒ½åŠ›çš„æŸå®³ç¨‹åº¦ï¼Œå€¼è¶Šå¤§è¡¨ç¤ºé—å¿˜è¶Šä¸¥é‡ã€‚</li>
</ul>
<h3>ç¼“è§£ç­–ç•¥</h3>
<ol>
<li>
<p><strong>å­¦ä¹ ç‡è°ƒä½</strong></p>
<pre class="hljs"><code>learning_rate = <span class="hljs-number">2e-5</span>  <span class="hljs-comment"># æ¯”é¢„è®­ç»ƒä½ 10-20 å€</span>
</code></pre>
</li>
<li>
<p><strong>æ—©åœï¼ˆEarly Stoppingï¼‰</strong></p>
<pre class="hljs"><code><span class="hljs-comment"># åœ¨éªŒè¯é›†ä¸Šç›‘æ§ï¼Œé˜²æ­¢è¿‡æ‹Ÿåˆ</span>
early_stopping_patience = <span class="hljs-number">3</span>
</code></pre>
</li>
<li>
<p><strong>æ··åˆæ•°æ®è®­ç»ƒ</strong></p>
<pre class="hljs"><code><span class="hljs-comment"># æ–°ä»»åŠ¡æ•°æ® + åŸå§‹é¢„è®­ç»ƒæ•°æ®æ··åˆ</span>
dataset = ConcatDataset([task_dataset, pretrain_subset])
</code></pre>
</li>
<li>
<p><strong>å¼¹æ€§æƒé‡å›ºåŒ–ï¼ˆEWCï¼‰</strong></p>
<pre class="hljs"><code><span class="hljs-comment"># å¯¹é‡è¦å‚æ•°æ–½åŠ çº¦æŸ</span>
loss = task_loss + Î» * EWC_penalty
</code></pre>
</li>
</ol>
<h2>è®­ç»ƒé…ç½®æœ€ä½³å®è·µ</h2>
<h3>LLaMA-2 7B å…¨å‚æ•°å¾®è°ƒ</h3>
<pre class="hljs"><code><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> TrainingArguments

training_args = TrainingArguments(
    output_dir=<span class="hljs-string">&quot;./full-ft-output&quot;</span>,

    <span class="hljs-comment"># æ‰¹æ¬¡è®¾ç½®</span>
    per_device_train_batch_size=<span class="hljs-number">2</span>,
    gradient_accumulation_steps=<span class="hljs-number">8</span>,  <span class="hljs-comment"># æœ‰æ•ˆæ‰¹æ¬¡ = 16</span>

    <span class="hljs-comment"># å­¦ä¹ ç‡</span>
    learning_rate=<span class="hljs-number">2e-5</span>,
    weight_decay=<span class="hljs-number">0.01</span>,

    <span class="hljs-comment"># è°ƒåº¦</span>
    lr_scheduler_type=<span class="hljs-string">&quot;cosine&quot;</span>,
    warmup_ratio=<span class="hljs-number">0.03</span>,

    <span class="hljs-comment"># ç²¾åº¦</span>
    bf16=<span class="hljs-literal">True</span>,
    tf32=<span class="hljs-literal">True</span>,

    <span class="hljs-comment"># åºåˆ—é•¿åº¦</span>
    max_length=<span class="hljs-number">2048</span>,

    <span class="hljs-comment"># æ¢¯åº¦æ£€æŸ¥ç‚¹</span>
    gradient_checkpointing=<span class="hljs-literal">True</span>,

    <span class="hljs-comment"># è®­ç»ƒè½®æ•°</span>
    num_train_epochs=<span class="hljs-number">3</span>,

    <span class="hljs-comment"># ä¿å­˜ç­–ç•¥</span>
    save_strategy=<span class="hljs-string">&quot;steps&quot;</span>,
    save_steps=<span class="hljs-number">500</span>,
    save_total_limit=<span class="hljs-number">2</span>,

    <span class="hljs-comment"># æ—¥å¿—</span>
    logging_steps=<span class="hljs-number">10</span>,
    eval_steps=<span class="hljs-number">500</span>,
)
</code></pre>
<h3>æ˜¾å­˜ä¼°ç®—</h3>
<p>å…¨å‚æ•°å¾®è°ƒæ˜¾å­˜éœ€æ±‚ï¼ˆä¼˜åŒ–å™¨çŠ¶æ€ + æ¢¯åº¦ + æ¿€æ´»ï¼‰ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">Memory</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â‰ˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord text"><span class="mord">Params</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">Bytes</span></span></span></span></span></span></p>
<p><a id="formula-full-finetune-3"></a>
<a href="#formula-full-finetune-3-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šå…¨å‚æ•°å¾®è°ƒæ˜¾å­˜çº¦ä¸ºæ¨¡å‹å‚æ•°çš„ 4 å€ï¼ˆä»¥åŒç²¾åº¦è®¡ï¼‰ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord text"><span class="mord">Params</span></span></span></span></span> ä¸ºå‚æ•°æ•°é‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">Bytes</span></span></span></span></span> ä¸ºæ¯ä¸ªæ•°å€¼çš„å­—èŠ‚æ•°ï¼ˆå¦‚ FP16 ä¸º 2ï¼‰ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šéœ€è¦å­˜å‚¨æ¨¡å‹å‰¯æœ¬ã€æ¢¯åº¦ã€ä¼˜åŒ–å™¨çŠ¶æ€ï¼ˆå¦‚ Adam çš„åŠ¨é‡ï¼‰å’Œæ¿€æ´»ï¼Œæ€»å¼€é”€å¤§ã€‚</li>
</ul>
<table>
<thead>
<tr>
<th>æ¨¡å‹</th>
<th>å‚æ•°é‡</th>
<th>FP16 æ¨¡å‹</th>
<th>å…¨å‚æ•°å¾®è°ƒæ˜¾å­˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>7B</td>
<td>7Ã—10â¹</td>
<td>14GB</td>
<td>~60GB</td>
</tr>
<tr>
<td>13B</td>
<td>13Ã—10â¹</td>
<td>26GB</td>
<td>~100GB</td>
</tr>
<tr>
<td>70B</td>
<td>70Ã—10â¹</td>
<td>140GB</td>
<td>~500GB</td>
</tr>
</tbody>
</table>
<h2>ä¸ PEFT çš„å¯¹æ¯”å®éªŒ</h2>
<h3>å®éªŒè®¾ç½®</h3>
<ul>
<li>æ¨¡å‹ï¼šLLaMA-2 7B</li>
<li>ä»»åŠ¡ï¼šæŒ‡ä»¤å¾®è°ƒï¼ˆ52K æ ·æœ¬ï¼‰</li>
<li>è¯„ä¼°ï¼šMT-Bench</li>
</ul>
<h3>ç»“æœ</h3>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>å¯è®­ç»ƒå‚æ•°</th>
<th>æ˜¾å­˜</th>
<th>MT-Bench</th>
</tr>
</thead>
<tbody>
<tr>
<td>å…¨å‚æ•°å¾®è°ƒ</td>
<td>7B (100%)</td>
<td>60GB</td>
<td>6.8</td>
</tr>
<tr>
<td>LoRA (r=64)</td>
<td>70M (1%)</td>
<td>24GB</td>
<td>6.5</td>
</tr>
<tr>
<td>LoRA (r=16)</td>
<td>18M (0.3%)</td>
<td>16GB</td>
<td>6.3</td>
</tr>
</tbody>
</table>
<p><strong>ç»“è®º</strong>ï¼šå…¨å‚æ•°å¾®è°ƒæ•ˆæœæœ€å¥½ï¼Œä½† LoRA ä»¥ 1% çš„å‚æ•°è¾¾åˆ° 95% çš„æ•ˆæœã€‚</p>
<h2>å®è·µå»ºè®®</h2>
<ol>
<li><strong>å…ˆå°è¯• PEFT</strong>ï¼šå¤§å¤šæ•°åœºæ™¯ LoRA è¶³å¤Ÿ</li>
<li><strong>å…¨å‚æ•°å¾®è°ƒæ¡ä»¶</strong>ï¼š
<ul>
<li>ä»»åŠ¡ä¸é¢„è®­ç»ƒå·®å¼‚å¤§</li>
<li>æœ‰å……è¶³æ ‡æ³¨æ•°æ®ï¼ˆ&gt;10Kï¼‰</li>
<li>è¿½æ±‚æè‡´æ•ˆæœ</li>
</ul>
</li>
<li><strong>ç›‘æ§é—å¿˜</strong>ï¼šåœ¨åŸå§‹ä»»åŠ¡ä¸Šå®šæœŸè¯„ä¼°</li>
<li><strong>å¤‡ä»½åŸå§‹æ¨¡å‹</strong>ï¼šå…¨å‚æ•°å¾®è°ƒä¸å¯é€†</li>
</ol>
<h2>å‚è€ƒæ–‡çŒ®</h2>
<ol>
<li>Howard &amp; Ruder (2018). <em>Universal Language Model Fine-tuning for Text Classification</em></li>
<li>Kirkpatrick et al. (2017). <em>Overcoming catastrophic forgetting in neural networks</em></li>
<li>Ouyang et al. (2022). <em>Training language models to follow instructions with human feedback</em></li>
</ol>
<h1>å…¨å‚æ•°å¾®è°ƒæµç¨‹å›¾è§£</h1>
<blockquote>
<p>é€šè¿‡å¯è§†åŒ–å›¾è¡¨ç†è§£å…¨å‚æ•°å¾®è°ƒçš„å®Œæ•´å·¥ä½œæµç¨‹</p>
</blockquote>
<h2>å…¨å‚æ•°å¾®è°ƒæ€»ä½“æµç¨‹</h2>
<p><div class="mermaid">flowchart TB
    subgraph å‡†å¤‡é˜¶æ®µ
        A[é¢„è®­ç»ƒæ¨¡å‹&lt;br/&gt;å¦‚ LLaMA, GPT] --&gt; B[å‡†å¤‡ä»»åŠ¡æ•°æ®&lt;br/&gt;æ ‡æ³¨/æŒ‡ä»¤æ•°æ®]
        B --&gt; C[æ•°æ®é¢„å¤„ç†&lt;br/&gt;åˆ†è¯/æ ¼å¼åŒ–]
    end

    subgraph è®­ç»ƒé˜¶æ®µ
        C --&gt; D[åˆå§‹åŒ–ä¼˜åŒ–å™¨&lt;br/&gt;AdamW]
        D --&gt; E[å‰å‘ä¼ æ’­]
        E --&gt; F[è®¡ç®—æŸå¤±]
        F --&gt; G[åå‘ä¼ æ’­&lt;br/&gt;è®¡ç®—æ‰€æœ‰å‚æ•°æ¢¯åº¦]
        G --&gt; H[ä¼˜åŒ–å™¨æ›´æ–°&lt;br/&gt;æ‰€æœ‰å‚æ•°æ”¹å˜]
        H --&gt; I{æ”¶æ•›?}
        I --&gt;|å¦| E
        I --&gt;|æ˜¯| J[ä¿å­˜æ¨¡å‹]
    end

    subgraph éƒ¨ç½²é˜¶æ®µ
        J --&gt; K[è¯„ä¼°éªŒè¯]
        K --&gt; L[æ¨¡å‹éƒ¨ç½²]
    end

    style A fill:#e1f5fe
    style J fill:#c8e6c9
    style L fill:#fff9c4</div></p>
<h2>å…¨å‚æ•°å¾®è°ƒ vs LoRA å¯¹æ¯”</h2>
<p><div class="mermaid">flowchart LR
    subgraph å…¨å‚æ•°å¾®è°ƒ
        direction TB
        FT1["æ›´æ–°æ‰€æœ‰å‚æ•°&lt;br/&gt;W = W - Î·âˆ‡L"] --&gt; FT2["æ¨¡å‹å®Œå…¨æ”¹å˜"]
        FT2 --&gt; FT3["ä¿å­˜å®Œæ•´æ¨¡å‹&lt;br/&gt;~70GB"]
    end

    subgraph LoRAå¾®è°ƒ
        direction TB
        L1["å†»ç»“åŸå‚æ•°&lt;br/&gt;åªè®­ç»ƒ A, B"] --&gt; L2["æ¨¡å‹éƒ¨åˆ†æ”¹å˜&lt;br/&gt;W_new = W + BA"]
        L2 --&gt; L3["ä¿å­˜é€‚é…å™¨&lt;br/&gt;~200MB"]
    end

    style FT3 fill:#ffcdd2
    style L3 fill:#c8e6c9</div></p>
<h2>æ˜¾å­˜ä½¿ç”¨åˆ†æ</h2>
<p><div class="mermaid">flowchart TB
    subgraph 7Bæ¨¡å‹å…¨å‚æ•°å¾®è°ƒæ˜¾å­˜
        M1["æ¨¡å‹æƒé‡ FP16&lt;br/&gt;14 GB"]
        M2["æ¢¯åº¦&lt;br/&gt;14 GB"]
        M3["ä¼˜åŒ–å™¨çŠ¶æ€&lt;br/&gt;28 GB"]
        M4["æ¿€æ´»å€¼&lt;br/&gt;~4 GB"]
        M1 --&gt; SUM["æ€»è®¡ ~60 GB"]
        M2 --&gt; SUM
        M3 --&gt; SUM
        M4 --&gt; SUM
    end

    style M3 fill:#ffcdd2
    style SUM fill:#fff9c4</div></p>
<h2>è®­ç»ƒä¼˜åŒ–æŠ€æœ¯</h2>
<p><div class="mermaid">flowchart LR
    A[æ˜¾å­˜ä¸è¶³?] --&gt; B{é€‰æ‹©ä¼˜åŒ–æ–¹æ¡ˆ}

    B --&gt;|å•å¡| C[æ¢¯åº¦ç´¯ç§¯]
    B --&gt;|è®¡ç®—å¤Ÿ| D[æ¢¯åº¦æ£€æŸ¥ç‚¹]
    B --&gt;|å¤šå¡| E[åˆ†å¸ƒå¼è®­ç»ƒ]

    C --&gt; F["æœ‰æ•ˆæ‰¹æ¬¡ = batch Ã— steps&lt;br/&gt;ç”¨æ—¶é—´æ¢ç©ºé—´"]
    D --&gt; G["é‡è®¡ç®—æ¿€æ´»å€¼&lt;br/&gt;èŠ‚çœ30-50%æ˜¾å­˜"]
    E --&gt; H["FSDP/DeepSpeed&lt;br/&gt;æ¨¡å‹åˆ†ç‰‡åˆ°å¤šå¡"]

    style F fill:#c8e6c9
    style G fill:#c8e6c9
    style H fill:#c8e6c9</div></p>
<h2>ç¾éš¾æ€§é—å¿˜é—®é¢˜</h2>
<p><div class="mermaid">flowchart TB
    subgraph é—®é¢˜
        A[é¢„è®­ç»ƒæ¨¡å‹] --&gt; B[å…¨å‚æ•°å¾®è°ƒ]
        B --&gt; C["æ–°ä»»åŠ¡èƒ½åŠ›å¼º âœ“"]
        B --&gt; D["åŸä»»åŠ¡èƒ½åŠ›ä¸‹é™ âœ—"]
    end

    subgraph è§£å†³æ–¹æ¡ˆ
        E[é™ä½å­¦ä¹ ç‡] --&gt; F["ç¼“æ…¢é€‚åº”&lt;br/&gt;ä¿ç•™åŸçŸ¥è¯†"]
        G[æ··åˆæ•°æ®è®­ç»ƒ] --&gt; H["æ–°æ—§æ•°æ®æ··åˆ&lt;br/&gt;æŒç»­å›é¡¾"]
        I[æ—©åœç­–ç•¥] --&gt; J["ç›‘æ§éªŒè¯é›†&lt;br/&gt;åŠæ—¶åœæ­¢"]
    end

    style D fill:#ffcdd2
    style F fill:#c8e6c9
    style H fill:#c8e6c9
    style J fill:#c8e6c9</div></p>
<h2>å­¦ä¹ ç‡è°ƒåº¦</h2>
<p><div class="mermaid">flowchart LR
    subgraph è°ƒåº¦è¿‡ç¨‹
        A[0] --&gt;|é¢„çƒ­| B[warmup_steps]
        B --&gt;|ä¿æŒ/ä¸Šå‡| C[max_lr]
        C --&gt;|ä½™å¼¦è¡°å‡| D[0]

        A -.-&gt; E["å­¦ä¹ ç‡ = 0"]
        C -.-&gt; F["å­¦ä¹ ç‡ = 2e-5"]
        D -.-&gt; G["å­¦ä¹ ç‡ â†’ 0"]
    end

    style C fill:#fff9c4</div></p>
<h2>å†³ç­–æ ‘ï¼šé€‰æ‹©å¾®è°ƒæ–¹æ³•</h2>
<p><div class="mermaid">flowchart TD
    Start["éœ€è¦å¾®è°ƒå¤§æ¨¡å‹"] --&gt; Q1{"ä»»åŠ¡ä¸é¢„è®­ç»ƒ&lt;br/&gt;å·®å¼‚å¤§å—?"}

    Q1 --&gt;|"æ˜¯&lt;br/&gt;(å¦‚åŒ»å­¦ã€æ³•å¾‹)"| Q2{"æœ‰å……è¶³&lt;br/&gt;è®¡ç®—èµ„æº?"}
    Q1 --&gt;|"å¦&lt;br/&gt;(é€šç”¨ä»»åŠ¡)"| LoRA["ä½¿ç”¨ LoRA/QLoRA&lt;br/&gt;æ¨èæ–¹æ¡ˆ"]

    Q2 --&gt;|"æ˜¯"| Full["å…¨å‚æ•°å¾®è°ƒ&lt;br/&gt;è¿½æ±‚æœ€ä½³æ•ˆæœ"]
    Q2 --&gt;|"å¦"| Q3{"æ•°æ®é‡ &gt; 10K?"}

    Q3 --&gt;|"æ˜¯"| QLoRA["QLoRA&lt;br/&gt;é«˜æ€§ä»·æ¯”"]
    Q3 --&gt;|"å¦"| LoRA

    style Full fill:#bbdefb
    style LoRA fill:#c8e6c9
    style QLoRA fill:#c8e6c9

    Full --&gt; Done["å¼€å§‹è®­ç»ƒ"]
    LoRA --&gt; Done
    QLoRA --&gt; Done</div></p>
<h2>å›¾è§£è¯´æ˜</h2>
<h3>å…³é”®æ¦‚å¿µ</h3>
<table>
<thead>
<tr>
<th>æ¦‚å¿µ</th>
<th>è¯´æ˜</th>
<th>æ¨èå€¼</th>
</tr>
</thead>
<tbody>
<tr>
<td>å­¦ä¹ ç‡</td>
<td>å‚æ•°æ›´æ–°æ­¥é•¿</td>
<td>1e-5 ~ 5e-5</td>
</tr>
<tr>
<td>æ‰¹æ¬¡å¤§å°</td>
<td>ä¸€æ¬¡è®­ç»ƒçš„æ ·æœ¬æ•°</td>
<td>å°½å¯èƒ½å¤§</td>
</tr>
<tr>
<td>æ¢¯åº¦ç´¯ç§¯</td>
<td>æ¨¡æ‹Ÿå¤§æ‰¹æ¬¡</td>
<td>4-16 æ­¥</td>
</tr>
<tr>
<td>é¢„çƒ­æ­¥æ•°</td>
<td>å­¦ä¹ ç‡é¢„çƒ­</td>
<td>æ€»æ­¥æ•°çš„ 3-10%</td>
</tr>
</tbody>
</table>
<h3>æ˜¾å­˜ä¼˜åŒ–æŠ€å·§</h3>
<ol>
<li><strong>æ¢¯åº¦æ£€æŸ¥ç‚¹</strong>ï¼šçœ 30-50% æ˜¾å­˜ï¼Œæ…¢ 20%</li>
<li><strong>æ··åˆç²¾åº¦</strong>ï¼šFP16/BF16ï¼Œçœ 50% æ¨¡å‹æ˜¾å­˜</li>
<li><strong>æ¢¯åº¦ç´¯ç§¯</strong>ï¼šç”¨æ—¶é—´æ¢ç©ºé—´</li>
<li><strong>DeepSpeed ZeRO</strong>ï¼šå¤šå¡åˆ†ç‰‡ï¼Œé€‚åˆè¶…å¤§æ¨¡å‹</li>
</ol>
<h3>ä½•æ—¶é€‰æ‹©å…¨å‚æ•°å¾®è°ƒ</h3>
<ul>
<li>âœ… ä»»åŠ¡ä¸é¢„è®­ç»ƒå·®å¼‚å¤§</li>
<li>âœ… æœ‰å……è¶³çš„è®¡ç®—èµ„æº</li>
<li>âœ… è¿½æ±‚æè‡´æ•ˆæœ</li>
<li>âœ… æ•°æ®é‡å……è¶³ï¼ˆ&gt;10K æ ·æœ¬ï¼‰</li>
</ul>
<div class="code-appendix page-break"><h2>é™„å½•ï¼šä»£ç ç¤ºä¾‹</h2><div class="code-file"><h3>full_finetune_example.py</h3><pre class="hljs"><code><span class="hljs-string">&quot;&quot;&quot;
å…¨å‚æ•°å¾®è°ƒç¤ºä¾‹ä»£ç 

æ¼”ç¤ºå¦‚ä½•å¯¹å¤§è¯­è¨€æ¨¡å‹è¿›è¡Œå…¨å‚æ•°å¾®è°ƒã€‚
é€‚ç”¨äºéœ€è¦æœ€å¤§ç¨‹åº¦é€‚åº”æ–°ä»»åŠ¡çš„åœºæ™¯ã€‚
&quot;&quot;&quot;</span>

<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> (
    AutoModelForCausalLM,
    AutoTokenizer,
    TrainingArguments,
    Trainer,
    DataCollatorForLanguageModeling
)
<span class="hljs-keyword">from</span> datasets <span class="hljs-keyword">import</span> Dataset

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 1. åŠ è½½é¢„è®­ç»ƒæ¨¡å‹</span>
<span class="hljs-comment"># ============================================</span>

model_name = <span class="hljs-string">&quot;meta-llama/Llama-2-7b-hf&quot;</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;åŠ è½½é¢„è®­ç»ƒæ¨¡å‹...&quot;</span>)
tokenizer = AutoTokenizer.from_pretrained(model_name)
tokenizer.pad_token = tokenizer.eos_token

<span class="hljs-comment"># å…¨å‚æ•°å¾®è°ƒéœ€è¦åŠ è½½å®Œæ•´æ¨¡å‹</span>
model = AutoModelForCausalLM.from_pretrained(
    model_name,
    torch_dtype=torch.bfloat16,  <span class="hljs-comment"># ä½¿ç”¨ BF16ï¼ˆAmpere+ GPUï¼‰</span>
    device_map=<span class="hljs-string">&quot;auto&quot;</span>
)

<span class="hljs-comment"># æ‰“å°å‚æ•°é‡</span>
total_params = <span class="hljs-built_in">sum</span>(p.numel() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> model.parameters())
trainable_params = <span class="hljs-built_in">sum</span>(p.numel() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> model.parameters() <span class="hljs-keyword">if</span> p.requires_grad)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;æ€»å‚æ•°: <span class="hljs-subst">{total_params / <span class="hljs-number">1e9</span>:<span class="hljs-number">.2</span>f}</span>B&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;å¯è®­ç»ƒå‚æ•°: <span class="hljs-subst">{trainable_params / <span class="hljs-number">1e9</span>:<span class="hljs-number">.2</span>f}</span>B (100%)&quot;</span>)

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 2. å‡†å¤‡è®­ç»ƒæ•°æ®</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-comment"># ç¤ºä¾‹ï¼šæŒ‡ä»¤å¾®è°ƒæ•°æ®</span>
train_data = [
    {
        <span class="hljs-string">&quot;instruction&quot;</span>: <span class="hljs-string">&quot;è§£é‡Šä»€ä¹ˆæ˜¯ç¥ç»ç½‘ç»œ&quot;</span>,
        <span class="hljs-string">&quot;input&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,
        <span class="hljs-string">&quot;output&quot;</span>: <span class="hljs-string">&quot;ç¥ç»ç½‘ç»œæ˜¯ä¸€ç§æ¨¡ä»¿ç”Ÿç‰©ç¥ç»ç³»ç»Ÿçš„æœºå™¨å­¦ä¹ æ¨¡å‹...&quot;</span>
    },
    {
        <span class="hljs-string">&quot;instruction&quot;</span>: <span class="hljs-string">&quot;ç”¨ç®€å•çš„è¯­è¨€è§£é‡Šé‡å­è®¡ç®—&quot;</span>,
        <span class="hljs-string">&quot;input&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,
        <span class="hljs-string">&quot;output&quot;</span>: <span class="hljs-string">&quot;é‡å­è®¡ç®—ä½¿ç”¨é‡å­åŠ›å­¦çš„åŸç†æ¥å¤„ç†ä¿¡æ¯...&quot;</span>
    },
    <span class="hljs-comment"># ... æ›´å¤šæ•°æ®</span>
]

<span class="hljs-keyword">def</span> <span class="hljs-title function_">format_prompt</span>(<span class="hljs-params">sample</span>):
    <span class="hljs-string">&quot;&quot;&quot;æ ¼å¼åŒ–ä¸ºè®­ç»ƒæ–‡æœ¬&quot;&quot;&quot;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;&quot;&quot;### æŒ‡ä»¤:
<span class="hljs-subst">{sample[<span class="hljs-string">&#x27;instruction&#x27;</span>]}</span>

### è¾“å…¥:
<span class="hljs-subst">{sample[<span class="hljs-string">&#x27;input&#x27;</span>]}</span>

### å›ç­”:
<span class="hljs-subst">{sample[<span class="hljs-string">&#x27;output&#x27;</span>]}</span>&quot;&quot;&quot;</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">tokenize_function</span>(<span class="hljs-params">examples</span>):
    <span class="hljs-string">&quot;&quot;&quot;åˆ†è¯å‡½æ•°&quot;&quot;&quot;</span>
    prompts = [format_prompt(ex) <span class="hljs-keyword">for</span> ex <span class="hljs-keyword">in</span> examples]
    <span class="hljs-keyword">return</span> tokenizer(
        prompts,
        truncation=<span class="hljs-literal">True</span>,
        padding=<span class="hljs-string">&quot;max_length&quot;</span>,
        max_length=<span class="hljs-number">512</span>,
        return_tensors=<span class="hljs-string">&quot;pt&quot;</span>
    )

<span class="hljs-comment"># åˆ›å»ºæ•°æ®é›†</span>
dataset = Dataset.from_list(train_data)
tokenized_dataset = dataset.<span class="hljs-built_in">map</span>(
    tokenize_function,
    batched=<span class="hljs-literal">False</span>,
    remove_columns=dataset.column_names
)

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 3. è®­ç»ƒé…ç½®ï¼ˆå…¨å‚æ•°å¾®è°ƒå…³é”®å‚æ•°ï¼‰</span>
<span class="hljs-comment"># ============================================</span>

training_args = TrainingArguments(
    output_dir=<span class="hljs-string">&quot;./full-finetune-output&quot;</span>,

    <span class="hljs-comment"># ===== æ‰¹æ¬¡è®¾ç½® =====</span>
    <span class="hljs-comment"># å…¨å‚æ•°å¾®è°ƒæ˜¾å­˜éœ€æ±‚é«˜ï¼Œé€šå¸¸ç”¨å°æ‰¹æ¬¡ + æ¢¯åº¦ç´¯ç§¯</span>
    per_device_train_batch_size=<span class="hljs-number">2</span>,
    gradient_accumulation_steps=<span class="hljs-number">8</span>,  <span class="hljs-comment"># æœ‰æ•ˆæ‰¹æ¬¡ = 16</span>

    <span class="hljs-comment"># ===== å­¦ä¹ ç‡è®¾ç½®ï¼ˆå…³é”®ï¼ï¼‰=====</span>
    <span class="hljs-comment"># å…¨å‚æ•°å¾®è°ƒä½¿ç”¨è¾ƒä½çš„å­¦ä¹ ç‡ï¼Œé˜²æ­¢ç¾éš¾æ€§é—å¿˜</span>
    learning_rate=<span class="hljs-number">2e-5</span>,  <span class="hljs-comment"># æ¯”é¢„è®­ç»ƒä½ 10-20 å€</span>

    <span class="hljs-comment"># å­¦ä¹ ç‡è°ƒåº¦</span>
    lr_scheduler_type=<span class="hljs-string">&quot;cosine&quot;</span>,
    warmup_ratio=<span class="hljs-number">0.03</span>,  <span class="hljs-comment"># é¢„çƒ­ 3% çš„æ­¥æ•°</span>

    <span class="hljs-comment"># æƒé‡è¡°å‡ï¼ˆæ­£åˆ™åŒ–ï¼‰</span>
    weight_decay=<span class="hljs-number">0.01</span>,

    <span class="hljs-comment"># ===== ç²¾åº¦è®¾ç½® =====</span>
    bf16=<span class="hljs-literal">True</span>,          <span class="hljs-comment"># ä½¿ç”¨ BF16ï¼ˆæ¨è Ampere+ GPUï¼‰</span>
    tf32=<span class="hljs-literal">True</span>,          <span class="hljs-comment"># å¯ç”¨ TF32 åŠ é€Ÿ</span>

    <span class="hljs-comment"># ===== æ˜¾å­˜ä¼˜åŒ– =====</span>
    gradient_checkpointing=<span class="hljs-literal">True</span>,  <span class="hljs-comment"># æ¢¯åº¦æ£€æŸ¥ç‚¹ï¼ŒèŠ‚çœæ˜¾å­˜</span>
    optim=<span class="hljs-string">&quot;adamw_torch&quot;</span>,          <span class="hljs-comment"># ä¼˜åŒ–å™¨</span>

    <span class="hljs-comment"># ===== è®­ç»ƒè®¾ç½® =====</span>
    num_train_epochs=<span class="hljs-number">3</span>,
    max_grad_norm=<span class="hljs-number">1.0</span>,  <span class="hljs-comment"># æ¢¯åº¦è£å‰ª</span>

    <span class="hljs-comment"># ===== ä¿å­˜è®¾ç½® =====</span>
    save_strategy=<span class="hljs-string">&quot;steps&quot;</span>,
    save_steps=<span class="hljs-number">500</span>,
    save_total_limit=<span class="hljs-number">2</span>,  <span class="hljs-comment"># åªä¿ç•™æœ€è¿‘ 2 ä¸ª checkpoint</span>

    <span class="hljs-comment"># ===== æ—¥å¿—è®¾ç½® =====</span>
    logging_steps=<span class="hljs-number">10</span>,
    logging_dir=<span class="hljs-string">&quot;./logs&quot;</span>,

    <span class="hljs-comment"># ===== å…¶ä»– =====</span>
    dataloader_num_workers=<span class="hljs-number">4</span>,
    remove_unused_columns=<span class="hljs-literal">False</span>,
)

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 4. æ•°æ®æ•´ç†å™¨</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-comment"># ç”¨äºå› æœè¯­è¨€æ¨¡å‹çš„æ•°æ®æ•´ç†å™¨</span>
data_collator = DataCollatorForLanguageModeling(
    tokenizer=tokenizer,
    mlm=<span class="hljs-literal">False</span>  <span class="hljs-comment"># ä¸ä½¿ç”¨æ©ç è¯­è¨€æ¨¡å‹</span>
)

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 5. å¼€å§‹è®­ç»ƒ</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\nå¼€å§‹å…¨å‚æ•°å¾®è°ƒ...&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;é¢„è®¡æ˜¾å­˜ä½¿ç”¨: ~60GB (7B æ¨¡å‹)&quot;</span>)

trainer = Trainer(
    model=model,
    args=training_args,
    train_dataset=tokenized_dataset,
    data_collator=data_collator,
)

trainer.train()

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 6. ä¿å­˜å¾®è°ƒåçš„æ¨¡å‹</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\nä¿å­˜å¾®è°ƒåçš„æ¨¡å‹...&quot;</span>)
model.save_pretrained(<span class="hljs-string">&quot;./full-finetune-output&quot;</span>)
tokenizer.save_pretrained(<span class="hljs-string">&quot;./full-finetune-output&quot;</span>)

<span class="hljs-comment"># æ³¨æ„ï¼šå…¨å‚æ•°å¾®è°ƒä¿å­˜çš„æ˜¯å®Œæ•´æ¨¡å‹ï¼ˆ~14GB for 7Bï¼‰</span>
<span class="hljs-comment"># è€Œ LoRA åªä¿å­˜é€‚é…å™¨ï¼ˆ~200MBï¼‰</span>

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 7. æ¨ç†æµ‹è¯•</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\næ¨ç†æµ‹è¯•...&quot;</span>)
model.<span class="hljs-built_in">eval</span>()

prompt = <span class="hljs-string">&quot;### æŒ‡ä»¤:\nè§£é‡Šä»€ä¹ˆæ˜¯æ·±åº¦å­¦ä¹ \n\n### è¾“å…¥:\n\n### å›ç­”:\n&quot;</span>
inputs = tokenizer(prompt, return_tensors=<span class="hljs-string">&quot;pt&quot;</span>).to(model.device)

<span class="hljs-keyword">with</span> torch.no_grad():
    outputs = model.generate(
        **inputs,
        max_new_tokens=<span class="hljs-number">200</span>,
        temperature=<span class="hljs-number">0.7</span>,
        top_p=<span class="hljs-number">0.9</span>,
        do_sample=<span class="hljs-literal">True</span>
    )

<span class="hljs-built_in">print</span>(tokenizer.decode(outputs[<span class="hljs-number">0</span>], skip_special_tokens=<span class="hljs-literal">True</span>))

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 8. è¯„ä¼°å¯¹æ¯”ï¼ˆå¯é€‰ï¼‰</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluate_on_original_task</span>(<span class="hljs-params">model, tokenizer, test_data</span>):
    <span class="hljs-string">&quot;&quot;&quot;è¯„ä¼°å¾®è°ƒåæ¨¡å‹åœ¨åŸå§‹ä»»åŠ¡ä¸Šçš„è¡¨ç°ï¼ˆæ£€æµ‹ç¾éš¾æ€§é—å¿˜ï¼‰&quot;&quot;&quot;</span>
    <span class="hljs-comment"># å®ç°åŸå§‹ä»»åŠ¡è¯„ä¼°é€»è¾‘</span>
    <span class="hljs-keyword">pass</span>

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># é™„å½•: æ˜¾å­˜ä¼˜åŒ–æŠ€å·§</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-string">&quot;&quot;&quot;
å…¨å‚æ•°å¾®è°ƒæ˜¾å­˜ä¼˜åŒ–æ¸…å•:

1. æ¢¯åº¦æ£€æŸ¥ç‚¹ (gradient_checkpointing=True)
   - èŠ‚çœ: 30-50% æ¿€æ´»æ˜¾å­˜
   - ä»£ä»·: è®­ç»ƒé€Ÿåº¦ä¸‹é™ ~20%

2. æ··åˆç²¾åº¦ (bf16=True / fp16=True)
   - èŠ‚çœ: 50% æ¨¡å‹æ˜¾å­˜
   - åŠ é€Ÿ: 2-3x

3. æ¢¯åº¦ç´¯ç§¯ (gradient_accumulation_steps)
   - ä¸èŠ‚çœæ˜¾å­˜ï¼Œä½†å…è®¸ç”¨å°æ‰¹æ¬¡æ¨¡æ‹Ÿå¤§æ‰¹æ¬¡

4. DeepSpeed / FSDP (å¤šå¡)
   - å°†æ¨¡å‹åˆ†ç‰‡åˆ°å¤šå¼  GPU
   - é€‚åˆ &gt;13B çš„æ¨¡å‹

æ˜¾å­˜éœ€æ±‚ä¼°ç®— (7B æ¨¡å‹):
- æ¨¡å‹æƒé‡ (FP16):     14 GB
- æ¢¯åº¦:                14 GB
- ä¼˜åŒ–å™¨çŠ¶æ€ (AdamW):  28 GB
- æ¿€æ´»å€¼:              ~4 GB
----------------------------------
æ€»è®¡:                  ~60 GB
&quot;&quot;&quot;</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">50</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;å…¨å‚æ•°å¾®è°ƒå®Œæˆ!&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;æ¨¡å‹ä¿å­˜åœ¨: ./full-finetune-output&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">50</span>)
</code></pre></div></div><h2 class="subtopic-title">10.2 LoRA å¾®è°ƒ</h2><h1>LoRA å¾®è°ƒç§‘æ™®ç‰ˆ</h1>
<blockquote>
<p>é¢å‘é›¶åŸºç¡€è¯»è€…çš„ LoRA å¾®è°ƒå…¥é—¨æŒ‡å—</p>
</blockquote>
<h2>ä¸€å¥è¯æ¦‚æ‹¬</h2>
<p><strong>LoRA å°±åƒæ˜¯ç»™å¤§æ¨¡å‹è£…äº†ä¸€ä¸ª&quot;å°æ’ä»¶&quot;ï¼Œåªéœ€è¦è®­ç»ƒå¾ˆå°‘çš„å‚æ•°ï¼Œå°±èƒ½è®©æ¨¡å‹å­¦ä¼šæ–°æŠ€èƒ½ã€‚</strong></p>
<h2>ä»ä¸€ä¸ªé—®é¢˜å¼€å§‹</h2>
<p>æƒ³è±¡ä½ ä¹°äº†ä¸€å°éå¸¸æ˜‚è´µçš„æ™ºèƒ½æ‰‹æœºï¼ˆå°±åƒ GPT-4 è¿™æ ·çš„è¶…å¤§æ¨¡å‹ï¼‰ï¼Œå®ƒä»€ä¹ˆéƒ½ä¼šã€‚ä½†æ˜¯ç°åœ¨ä½ æƒ³è®©å®ƒï¼š</p>
<ul>
<li>ç”¨ä½ ä»¬å…¬å¸çš„ä¸“ä¸šæœ¯è¯­å›ç­”é—®é¢˜</li>
<li>ç”¨ç‰¹å®šçš„è¯­æ°”å†™é‚®ä»¶</li>
<li>ä¸“é—¨è§£ç­”åŒ»å­¦é—®é¢˜</li>
</ul>
<p>ä½ æ€ä¹ˆåŠï¼ŸæŠŠæ•´ä¸ªæ‰‹æœºæ‹†å¼€é‡æ–°ç»„è£…ï¼Ÿé‚£å¤ªè´µäº†ï¼Œè€Œä¸”å¯èƒ½å¼„åã€‚</p>
<p><strong>èƒ½ä¸èƒ½åªåŠ ä¸€ä¸ªå°é…ä»¶ï¼Œå°±è®©æ‰‹æœºè·å¾—æ–°åŠŸèƒ½ï¼Ÿ</strong></p>
<p>è¿™å°±æ˜¯ LoRA ï¿½ï¿½ï¿½è§£å†³çš„é—®é¢˜ï¼</p>
<h2>ä¼ ç»Ÿæ–¹æ³•ï¼šå…¨å‚æ•°å¾®è°ƒ</h2>
<p>ä¼ ç»Ÿåšæ³•æ˜¯æŠŠæ¨¡å‹çš„<strong>æ‰€æœ‰å‚æ•°</strong>éƒ½é‡æ–°è®­ç»ƒä¸€éã€‚</p>
<h3>é—®é¢˜æ¥äº†</h3>
<table>
<thead>
<tr>
<th>é—®é¢˜</th>
<th>å…·ä½“æƒ…å†µ</th>
</tr>
</thead>
<tbody>
<tr>
<td>å¤ªè´µäº†</td>
<td>GPT-3 æœ‰ 1750 äº¿ä¸ªå‚æ•°ï¼Œå…¨è®­ç»ƒéœ€è¦å‡ ç™¾ä¸‡ç¾å…ƒ</td>
</tr>
<tr>
<td>å­˜ä¸ä¸‹</td>
<td>æ¯ä¸ªå¾®è°ƒç‰ˆæœ¬éƒ½è¦ä¿å­˜ä¸€ä»½å®Œæ•´æ¨¡å‹ï¼Œç¡¬ç›˜çˆ†ç‚¸</td>
</tr>
<tr>
<td>å®¹æ˜“å¿˜</td>
<td>è®­ç»ƒå¤ªç‹ ï¼Œæ¨¡å‹å¯èƒ½æŠŠåŸæ¥ä¼šçš„éƒ½å¿˜äº†ï¼ˆç¾éš¾æ€§é—å¿˜ï¼‰</td>
</tr>
</tbody>
</table>
<h2>LoRA çš„èªæ˜åšæ³•</h2>
<p>LoRA çš„æ ¸å¿ƒæ€æƒ³ï¼š<strong>ä¸æ”¹åŠ¨åŸæ¥çš„å‚æ•°ï¼Œåªåœ¨æ—è¾¹åŠ ä¸€å°éƒ¨åˆ†æ–°å‚æ•°ã€‚</strong></p>
<h3>ç”Ÿæ´»ä¸­çš„ç±»æ¯”</h3>
<p>æƒ³è±¡ä½ æœ‰ä¸€æœ¬æ•™ç§‘ä¹¦ï¼ˆåŸå§‹æ¨¡å‹ï¼‰ï¼š</p>
<ul>
<li><strong>å…¨å‚æ•°å¾®è°ƒ</strong>ï¼šæŠŠæ•´æœ¬ä¹¦éƒ½æ“¦æ‰ï¼Œé‡æ–°å†™ä¸€é</li>
<li><strong>LoRA</strong>ï¼šåœ¨ä¹¦æ—è¾¹è´´ä¾¿åˆ©è´´ï¼Œæ–°çŸ¥è¯†å†™åœ¨ä¾¿åˆ©è´´ä¸Š</li>
</ul>
<p>ç”¨çš„æ—¶å€™ï¼Œçœ‹ä¹¦çš„å†…å®¹ + ä¾¿åˆ©è´´çš„å†…å®¹ = å®šåˆ¶ç‰ˆçŸ¥è¯†</p>
<h3>æŠ€æœ¯åŸç†ï¼ˆæç®€ç‰ˆï¼‰</h3>
<p>æ¨¡å‹ä¸­çš„æƒé‡çŸ©é˜µ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span></span></span>ï¼ŒLoRA ä¸ç›´æ¥æ”¹å®ƒï¼Œè€Œæ˜¯ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal">A</span></span></span></span></span></p>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span></span></span>ï¼šåŸå§‹æƒé‡ï¼ˆå†»ç»“ï¼Œä¸è®­ç»ƒï¼‰</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> å’Œ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span>ï¼šä¸¤ä¸ªå°çŸ©é˜µï¼ˆè¿™å°±æ˜¯æˆ‘ä»¬è¦è®­ç»ƒçš„&quot;ä¾¿åˆ©è´´&quot;ï¼‰</li>
</ul>
<p>è¿™ä¸¤ä¸ªå°çŸ©é˜µæœ‰å¤šå°å‘¢ï¼Ÿé€šå¸¸æ˜¯åŸçŸ©é˜µçš„ <strong>1% åˆ° 0.1%</strong>ï¼</p>
<h2>å®é™…æ•ˆæœå¯¹æ¯”</h2>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>å¯è®­ç»ƒå‚æ•°</th>
<th>æ˜¾å­˜éœ€æ±‚</th>
<th>è®­ç»ƒé€Ÿåº¦</th>
</tr>
</thead>
<tbody>
<tr>
<td>å…¨å‚æ•°å¾®è°ƒ</td>
<td>100%</td>
<td>éå¸¸é«˜</td>
<td>æ…¢</td>
</tr>
<tr>
<td>LoRA</td>
<td>~1%</td>
<td>ä½å¾ˆå¤š</td>
<td>å¿«</td>
</tr>
<tr>
<td>QLoRA</td>
<td>~1%</td>
<td>æœ€ä½</td>
<td>å¿«</td>
</tr>
</tbody>
</table>
<h2>QLoRA æ˜¯ä»€ä¹ˆï¼Ÿ</h2>
<p>QLoRA = Quantized LoRAï¼ˆé‡åŒ– LoRAï¼‰</p>
<p>å°±æ˜¯åœ¨ LoRA çš„åŸºç¡€ä¸Šï¼Œå†æŠŠåŸå§‹æ¨¡å‹å‹ç¼©ä¸€ä¸‹ï¼š</p>
<ul>
<li>ç”¨ 4-bit å­˜å‚¨åŸºç¡€æ¨¡å‹ï¼ˆåŸæœ¬æ˜¯ 16-bitï¼‰</li>
<li>è®­ç»ƒæ—¶å†è§£å‹</li>
<li>æ•ˆæœå‡ ä¹ä¸€æ ·ï¼Œä½†æ˜¾å­˜éœ€æ±‚æ›´ä½äº†</li>
</ul>
<p><strong>ä¸€å¥è¯ï¼šQLoRA è®©æ™®é€šæ˜¾å¡ä¹Ÿèƒ½å¾®è°ƒå¤§æ¨¡å‹ã€‚</strong></p>
<h2>ä½ éœ€è¦è®°ä½çš„</h2>
<table>
<thead>
<tr>
<th>æ¦‚å¿µ</th>
<th>é€šä¿—ç†è§£</th>
</tr>
</thead>
<tbody>
<tr>
<td>LoRA</td>
<td>ç»™æ¨¡å‹è´´ä¾¿åˆ©è´´ï¼Œåªè®­ç»ƒä¾¿åˆ©è´´</td>
</tr>
<tr>
<td>Rank Â®</td>
<td>ä¾¿åˆ©è´´çš„&quot;å®¹é‡&quot;ï¼Œè¶Šå¤§èƒ½å­¦çš„ä¸œè¥¿è¶Šå¤šï¼Œä½†ä¹Ÿè¶Šè´µ</td>
</tr>
<tr>
<td>Alpha</td>
<td>ä¾¿åˆ©è´´çš„&quot;å½±å“åŠ›&quot;ï¼Œæ§åˆ¶æ–°çŸ¥è¯†çš„å¼ºåº¦</td>
</tr>
<tr>
<td>QLoRA</td>
<td>å‹ç¼©ç‰ˆ LoRAï¼Œæ›´çœèµ„æº</td>
</tr>
</tbody>
</table>
<h2>ä»€ä¹ˆæ—¶å€™ç”¨ LoRAï¼Ÿ</h2>
<p><strong>æ¨èç”¨ï¼š</strong></p>
<ul>
<li>ä¸ªäºº/å°å›¢é˜Ÿå¾®è°ƒå¤§æ¨¡å‹</li>
<li>æ˜¾å­˜æœ‰é™ï¼ˆæ¯”å¦‚åªæœ‰ä¸€å¼ æ¶ˆè´¹çº§æ˜¾å¡ï¼‰</li>
<li>éœ€è¦è®­ç»ƒå¤šä¸ªå®šåˆ¶ç‰ˆæœ¬</li>
</ul>
<p><strong>ä¸æ¨èç”¨ï¼š</strong></p>
<ul>
<li>éœ€è¦æ¨¡å‹å­¦ä¹ å…¨æ–°çš„çŸ¥è¯†ä½“ç³»</li>
<li>é¢„ç®—å……è¶³ï¼Œè¿½æ±‚æè‡´æ•ˆæœ</li>
<li>ä»»åŠ¡ä¸é¢„è®­ç»ƒå·®å¼‚å·¨å¤§</li>
</ul>
<h2>ä¸‹ä¸€æ­¥</h2>
<ul>
<li>æƒ³äº†è§£æ•°å­¦åŸç†ï¼Ÿé˜…è¯» <a href="advanced-guide.md">æ·±å…¥ç‰ˆ</a></li>
<li>æƒ³çœ‹ä»£ç å®ç°ï¼ŸæŸ¥çœ‹ <code>examples/</code> ç›®å½•</li>
<li>æƒ³çœ‹æµç¨‹å›¾ï¼ŸæŸ¥çœ‹ <a href="diagram.md">æµç¨‹å›¾è§£</a></li>
</ul>
<h1>LoRA å¾®è°ƒæ·±å…¥ç‰ˆ</h1>
<blockquote>
<p>é¢å‘æœ‰æœºå™¨å­¦ä¹ åŸºç¡€è¯»è€…çš„æŠ€æœ¯è¯¦è§£</p>
</blockquote>
<h2>æ¦‚è¿°</h2>
<p>LoRA (Low-Rank Adaptation) æ˜¯ä¸€ç§å‚æ•°é«˜æ•ˆå¾®è°ƒæ–¹æ³•ï¼Œé€šè¿‡ä½ç§©åˆ†è§£æ¥è¿‘ä¼¼æƒé‡æ›´æ–°ã€‚å¯¹äºé¢„è®­ç»ƒæƒé‡çŸ©é˜µ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mbin mtight">Ã—</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span></span></span></span></span>ï¼ŒLoRA å†»ç»“ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> å¹¶ä½¿ç”¨ä¸¤ä¸ªä½ç§©çŸ©é˜µ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mbin mtight">Ã—</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span></span></span></span></span></span></span></span> å’Œ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mbin mtight">Ã—</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span></span></span></span></span> æ¥è¡¨ç¤ºæ›´æ–°ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">Î”</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal">A</span></span></span></span></span></p>
<p><a id="formula-lora-finetune-1"></a>
<a href="#formula-lora-finetune-1-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šå†»ç»“åŸæƒé‡ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>ï¼Œæ–°å¢ä¸¤ä¸ªä½ç§©çŸ©é˜µ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> å’Œ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span> çš„ä¹˜ç§¯æ¥è¡¨ç¤ºæƒé‡æ›´æ–°ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºé¢„è®­ç»ƒæƒé‡ï¼ˆå†»ç»“ï¼‰ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mbin mtight">Ã—</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span></span></span></span></span></span></span></span> ä¸ºé™ç»´çŸ©é˜µï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mbin mtight">Ã—</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span></span></span></span></span> ä¸ºå‡ç»´çŸ©é˜µï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span> ä¸ºç§©ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šç”¨æå°‘çš„å¯è®­ç»ƒå‚æ•°ï¼ˆ<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span></span></span></span>ï¼‰è¿‘ä¼¼å…¨å‚æ•°æ›´æ–°ï¼ˆ<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span>ï¼‰ï¼Œå¤§å¹…é™ä½æ˜¾å­˜éœ€æ±‚ã€‚</li>
</ul>
<p>å…¶ä¸­ç§© <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â‰ª</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">min</span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span></span></span></span>ï¼Œé€šå¸¸ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">4</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">8</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">16</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">64</span><span class="mclose">}</span></span></span></span>ã€‚</p>
<h2>åŠ¨æœºï¼šå†…åœ¨ç»´åº¦å‡è®¾</h2>
<p>é¢„è®­ç»ƒæ¨¡å‹å…·æœ‰ä½å†…åœ¨ç»´åº¦ï¼ˆlow intrinsic dimensionï¼‰ã€‚ç ”ç©¶è¡¨æ˜ï¼Œæ¨¡å‹é€‚åº”æ–°ä»»åŠ¡æ—¶ï¼Œå®é™…éœ€è¦çš„è‡ªç”±åº¦è¿œå°äºå‚æ•°æ€»é‡ã€‚</p>
<p>Aghajanyan et al. (2020) å‘ç°ï¼Œåªéœ€åœ¨å­ç©ºé—´ä¸­ä¼˜åŒ–å°‘é‡å‚æ•°å°±èƒ½è¾¾åˆ°è‰¯å¥½æ•ˆæœã€‚LoRA æ­£æ˜¯åˆ©ç”¨è¿™ä¸€ç‰¹æ€§ã€‚</p>
<h2>æ•°å­¦æ¨å¯¼</h2>
<h3>æƒé‡æ›´æ–°çš„ä½ç§©è¡¨ç¤º</h3>
<p>å‡è®¾å…¨å‚æ•°å¾®è°ƒçš„æƒé‡æ›´æ–°ä¸º <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">Î”</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span></span></span>ã€‚LoRA å°†å…¶åˆ†è§£ä¸ºï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">Î”</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal">A</span></span></span></span></span></p>
<p><a id="formula-lora-finetune-2"></a>
<a href="#formula-lora-finetune-2-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mbin mtight">Ã—</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span></span></span></span></span></span></span></span>ï¼šé™ç»´çŸ©é˜µï¼Œåˆå§‹åŒ–ä¸ºéšæœºé«˜æ–¯</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mbin mtight">Ã—</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span></span></span></span></span>ï¼šå‡ç»´çŸ©é˜µï¼Œåˆå§‹åŒ–ä¸ºé›¶</li>
</ul>
<p>åˆå§‹åŒ– <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span> ç¡®ä¿ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span>ï¼Œå³è®­ç»ƒå¼€å§‹æ—¶æ¨¡å‹è¡Œä¸ºä¸é¢„è®­ç»ƒæ¨¡å‹ä¸€è‡´ã€‚</p>
<h3>å‰å‘ä¼ æ’­</h3>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.7936em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal">A</span><span class="mord mathnormal">x</span></span></span></span></span></p>
<p><a id="formula-lora-finetune-3"></a>
<a href="#formula-lora-finetune-3-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šè¾“å‡º = å†»ç»“æƒé‡çš„è¾“å‡º + LoRA æ›´æ–°çš„è¾“å‡ºï¼ˆå¸¦ç¼©æ”¾å› å­ï¼‰ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal">x</span></span></span></span> ä¸ºåŸæ¨¡å‹è¾“å‡ºï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal">A</span><span class="mord mathnormal">x</span></span></span></span> ä¸º LoRA å¢é‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span></span></span></span> ä¸ºç¼©æ”¾å› å­ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span> ä¸ºç§©ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span> æ§åˆ¶ LoRA æ›´æ–°çš„å½±å“å¼ºåº¦ï¼›é™¤ä»¥ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span> è®©è°ƒ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span></span></span></span> æ—¶æ— éœ€å› ç§©ä¸åŒè€Œé‡æ–°è°ƒå‚ã€‚</li>
</ul>
<p>å…¶ä¸­ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span></span></span></span> æ˜¯ç¼©æ”¾å› å­ï¼Œç”¨äºæ§åˆ¶ LoRA çš„å½±å“å¼ºåº¦ã€‚é™¤ä»¥ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span> ä½¿å¾—è°ƒæ•´ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span></span></span></span> æ—¶æ— éœ€é‡æ–°è°ƒå‚ã€‚</p>
<h3>å‚æ•°é‡å¯¹æ¯”</h3>
<p>å¯¹äº <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mbin mtight">Ã—</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span></span></span></span></span>ï¼š</p>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>å¯è®­ç»ƒå‚æ•°</th>
</tr>
</thead>
<tbody>
<tr>
<td>å…¨å‚æ•°å¾®è°ƒ</td>
<td><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></td>
</tr>
<tr>
<td>LoRA</td>
<td><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span></span></span></span></td>
</tr>
</tbody>
</table>
<p>å‹ç¼©æ¯”ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.355em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.01em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.485em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">d</span><span class="mbin mtight">+</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0404em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6954em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0404em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6954em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â‰ˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1901em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>ï¼ˆå‡è®¾ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â‰ˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span>ï¼‰</p>
<p>å½“ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord">8</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">4096</span></span></span></span> æ—¶ï¼Œå‹ç¼©æ¯”çº¦ä¸º 0.4%ï¼Œå³å‡å°‘ 99.6% çš„å¯è®­ç»ƒå‚æ•°ã€‚</p>
<h2>LoRA é…ç½®è¯¦è§£</h2>
<h3>Rank Â®</h3>
<p>ç§© <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span> å†³å®šäº† LoRA çš„è¡¨è¾¾èƒ½åŠ›ï¼š</p>
<ul>
<li><strong><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">4</span></span></span></span></strong>ï¼šç®€å•ä»»åŠ¡ï¼ˆé£æ ¼è¿ç§»ã€ç®€å•åˆ†ç±»ï¼‰</li>
<li><strong><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">8</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">16</span></span></span></span></strong>ï¼šä¸­ç­‰å¤æ‚åº¦ä»»åŠ¡ï¼ˆæŒ‡ä»¤å¾®è°ƒï¼‰</li>
<li><strong>r=32-64</strong>ï¼šå¤æ‚ä»»åŠ¡ï¼ˆæ–°çŸ¥è¯†å­¦ä¹ ã€å¤šä»»åŠ¡ï¼‰</li>
</ul>
<p><strong>å»ºè®®</strong>ï¼šä»å°ç§©å¼€å§‹ï¼Œé€æ­¥å¢å¤§ç›´åˆ°æ€§èƒ½é¥±å’Œã€‚</p>
<h3>Alpha (Î±)</h3>
<p>ç¼©æ”¾å› å­ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span></span></span></span> æ§åˆ¶ LoRA æ›´æ–°çš„å¼ºåº¦ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em;"></span><span class="mord text"><span class="mord">effective_lr</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.7936em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em;"></span><span class="mord text"><span class="mord">learning_rate</span></span></span></span></span></span></p>
<p><a id="formula-lora-finetune-4"></a>
<a href="#formula-lora-finetune-4-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p>å¸¸è§è®¾ç½®ï¼š</p>
<ul>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span>ï¼ˆä¿å®ˆï¼‰</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span>ï¼ˆæ ‡å‡†ï¼‰</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">16</span></span></span></span>ï¼ˆå›ºå®šï¼Œå¸¸ç”¨äº r=8 æ—¶ï¼‰</li>
</ul>
<h3>Target Modules</h3>
<p>é€‰æ‹©å“ªäº›å±‚åº”ç”¨ LoRAï¼š</p>
<pre class="hljs"><code><span class="hljs-comment"># å¸¸è§é…ç½®</span>
target_modules = [<span class="hljs-string">&quot;q_proj&quot;</span>, <span class="hljs-string">&quot;v_proj&quot;</span>]  <span class="hljs-comment"># åªå¾®è°ƒæ³¨æ„åŠ›</span>
target_modules = [<span class="hljs-string">&quot;q_proj&quot;</span>, <span class="hljs-string">&quot;k_proj&quot;</span>, <span class="hljs-string">&quot;v_proj&quot;</span>, <span class="hljs-string">&quot;o_proj&quot;</span>]  <span class="hljs-comment"># å…¨éƒ¨æ³¨æ„åŠ›</span>
target_modules = [<span class="hljs-string">&quot;all_linear&quot;</span>]  <span class="hljs-comment"># æ‰€æœ‰çº¿æ€§å±‚</span>
</code></pre>
<h2>QLoRAï¼šé‡åŒ– + LoRA</h2>
<p>QLoRA (Dettmers et al., 2023) ç»“åˆäº†é‡åŒ–å’Œ LoRAï¼š</p>
<h3>æ ¸å¿ƒæŠ€æœ¯</h3>
<ol>
<li>
<p><strong>4-bit NormalFloat (NF4)</strong></p>
<ul>
<li>ä¿¡æ¯è®ºæœ€ä¼˜çš„é‡åŒ–æ•°æ®ç±»å‹</li>
<li>å¯¹äºæ­£æ€åˆ†å¸ƒæƒé‡ï¼ŒNF4 æ¯” 4-bit æ•´æ•°æ›´ç²¾ç¡®</li>
</ul>
</li>
<li>
<p><strong>åŒé‡é‡åŒ– (Double Quantization)</strong></p>
<ul>
<li>å¯¹é‡åŒ–å¸¸æ•°å†æ¬¡é‡åŒ–</li>
<li>è¿›ä¸€æ­¥å‡å°‘å†…å­˜ï¼ˆçº¦ 0.5GB/65Bæ¨¡å‹ï¼‰</li>
</ul>
</li>
<li>
<p><strong>åˆ†é¡µä¼˜åŒ–å™¨ (Paged Optimizers)</strong></p>
<ul>
<li>ä½¿ç”¨ NVIDIA Unified Memory</li>
<li>å¤„ç†å†…å­˜å³°å€¼ï¼Œé¿å… OOM</li>
</ul>
</li>
</ol>
<h3>QLoRA vs LoRA</h3>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>LoRA</th>
<th>QLoRA</th>
</tr>
</thead>
<tbody>
<tr>
<td>åŸºç¡€æ¨¡å‹ç²¾åº¦</td>
<td>FP16/BF16</td>
<td>4-bit NF4</td>
</tr>
<tr>
<td>65Bæ¨¡å‹æ˜¾å­˜</td>
<td>~130GB</td>
<td>~48GB</td>
</tr>
<tr>
<td>è®­ç»ƒé€Ÿåº¦</td>
<td>å¿«</td>
<td>ç•¥æ…¢ï¼ˆéœ€åé‡åŒ–ï¼‰</td>
</tr>
<tr>
<td>ç²¾åº¦æŸå¤±</td>
<td>æ— </td>
<td>æå°</td>
</tr>
</tbody>
</table>
<h2>è®­ç»ƒæŠ€å·§</h2>
<h3>å­¦ä¹ ç‡é€‰æ‹©</h3>
<pre class="hljs"><code><span class="hljs-comment"># LoRA å­¦ä¹ ç‡é€šå¸¸æ¯”å…¨å‚æ•°å¾®è°ƒé«˜</span>
learning_rate = <span class="hljs-number">1e-4</span>  <span class="hljs-comment"># èµ·å§‹ç‚¹</span>
learning_rate = <span class="hljs-number">5e-4</span>  <span class="hljs-comment"># å¯å°è¯•æ›´é«˜</span>
</code></pre>
<h3>Dropout</h3>
<pre class="hljs"><code><span class="hljs-comment"># LoRA å±‚å¯ä»¥æ·»åŠ  dropout</span>
lora_dropout = <span class="hljs-number">0.05</span>  <span class="hljs-comment"># å¸¸ç”¨å€¼</span>
</code></pre>
<h3>åˆå¹¶ç­–ç•¥</h3>
<p>è®­ç»ƒå®Œæˆåï¼Œå¯ä»¥å°† LoRA æƒé‡åˆå¹¶åˆ°åŸºç¡€æ¨¡å‹ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">er</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.7936em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal">A</span></span></span></span></span></p>
<p><a id="formula-lora-finetune-5"></a>
<a href="#formula-lora-finetune-5-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šå°† LoRA çš„ä½ç§©æ›´æ–°åˆå¹¶åˆ°åŸæƒé‡ï¼Œå¾—åˆ°æ–°çš„å®Œæ•´æƒé‡çŸ©é˜µã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºé¢„è®­ç»ƒæƒé‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">A</span></span></span></span> ä¸ºè®­ç»ƒåçš„ LoRA çŸ©é˜µï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span> ä¸ºç¼©æ”¾å› å­ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šåˆå¹¶åæ¨¡å‹ä¸åŸæ¨¡å‹ç»“æ„ç›¸åŒï¼Œéƒ¨ç½²æ—¶æ— éœ€ LoRA ä»£ç ï¼Œæ— é¢å¤–æ¨ç†å¼€é”€ã€‚</li>
</ul>
<pre class="hljs"><code><span class="hljs-comment"># åˆå¹¶åçš„æ¨¡å‹å¯ç‹¬ç«‹ä½¿ç”¨ï¼Œæ— éœ€ LoRA ä»£ç </span>
model = model.merge_and_unload()
</code></pre>
<h2>å®éªŒç»“æœ</h2>
<h3>GLUE åŸºå‡†æµ‹è¯•</h3>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>å¯è®­ç»ƒå‚æ•°</th>
<th>RTE</th>
<th>MRPC</th>
<th>CoLA</th>
</tr>
</thead>
<tbody>
<tr>
<td>Fine-tuning</td>
<td>100%</td>
<td>70.2</td>
<td>87.6</td>
<td>63.6</td>
</tr>
<tr>
<td>LoRA (r=8)</td>
<td>0.1%</td>
<td>69.8</td>
<td>87.4</td>
<td>63.2</td>
</tr>
<tr>
<td>QLoRA</td>
<td>0.1%</td>
<td>69.5</td>
<td>87.1</td>
<td>62.8</td>
</tr>
</tbody>
</table>
<h3>LLM æŒ‡ä»¤å¾®è°ƒ</h3>
<p>åœ¨ LLaMA 7B ä¸Šçš„æŒ‡ä»¤å¾®è°ƒç»“æœï¼š</p>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>MMLU</th>
<th>è®­ç»ƒæ˜¾å­˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>å…¨å‚æ•°å¾®è°ƒ</td>
<td>42.1</td>
<td>60GB</td>
</tr>
<tr>
<td>LoRA</td>
<td>41.8</td>
<td>24GB</td>
</tr>
<tr>
<td>QLoRA</td>
<td>41.5</td>
<td>12GB</td>
</tr>
</tbody>
</table>
<h2>å±€é™æ€§</h2>
<ol>
<li><strong>çŸ¥è¯†æ›´æ–°æœ‰é™</strong>ï¼šä½ç§©çº¦æŸé™åˆ¶äº†å­¦ä¹ æ–°çŸ¥è¯†çš„èƒ½åŠ›</li>
<li><strong>ä»»åŠ¡å†²çª</strong>ï¼šå¤šä¸ª LoRA æ¨¡å—å¯èƒ½ç›¸äº’å¹²æ‰°</li>
<li><strong>å±‚é€‰æ‹©æ•æ„Ÿ</strong>ï¼šéœ€è¦é€‰æ‹©åˆé€‚çš„ target modules</li>
</ol>
<h2>æœ€ä½³å®è·µ</h2>
<pre class="hljs"><code><span class="hljs-comment"># æ¨èé…ç½®ï¼ˆLLaMA ç±»æ¨¡å‹ï¼‰</span>
lora_config = LoraConfig(
    r=<span class="hljs-number">16</span>,
    lora_alpha=<span class="hljs-number">32</span>,
    target_modules=[<span class="hljs-string">&quot;q_proj&quot;</span>, <span class="hljs-string">&quot;k_proj&quot;</span>, <span class="hljs-string">&quot;v_proj&quot;</span>, <span class="hljs-string">&quot;o_proj&quot;</span>],
    lora_dropout=<span class="hljs-number">0.05</span>,
    bias=<span class="hljs-string">&quot;none&quot;</span>,
    task_type=<span class="hljs-string">&quot;CAUSAL_LM&quot;</span>
)
</code></pre>
<h2>å‚è€ƒæ–‡çŒ®</h2>
<ol>
<li>Hu et al. (2021). <em>LoRA: Low-Rank Adaptation of Large Language Models</em></li>
<li>Dettmers et al. (2023). <em>QLoRA: Efficient Finetuning of Quantized LLMs</em></li>
<li>Aghajanyan et al. (2020). <em>Intrinsic Dimensionality Explains the Effectiveness of Language Model Fine-Tuning</em></li>
</ol>
<h1>LoRA å¾®è°ƒæµç¨‹å›¾è§£</h1>
<blockquote>
<p>é€šè¿‡å¯è§†åŒ–å›¾è¡¨ç†è§£ LoRA å¾®è°ƒçš„å®Œæ•´å·¥ä½œæµç¨‹</p>
</blockquote>
<h2>LoRA æ ¸å¿ƒåŸç†å›¾</h2>
<p><div class="mermaid">flowchart TB
    subgraph åŸå§‹æ¨¡å‹
        W["æƒé‡çŸ©é˜µ W&lt;br/&gt;(å†»ç»“ä¸è®­ç»ƒ)"]
    end

    subgraph LoRAé€‚é…å™¨
        A["çŸ©é˜µ A&lt;br/&gt;(r Ã— k)&lt;br/&gt;åˆå§‹åŒ–ä¸º0"]
        B["çŸ©é˜µ B&lt;br/&gt;(d Ã— r)&lt;br/&gt;éšæœºåˆå§‹åŒ–"]
    end

    subgraph è¾“å‡º
        SUM["W + Î±/r Ã— BA"]
    end

    Input["è¾“å…¥ x"] --&gt; W
    Input --&gt; A
    A --&gt; B
    W --&gt; SUM
    B --&gt; SUM
    SUM --&gt; Output["è¾“å‡º h"]

    style W fill:#f9f,stroke:#333
    style A fill:#9f9,stroke:#333
    style B fill:#9f9,stroke:#333</div></p>
<h2>LoRA å¾®è°ƒå®Œæ•´æµç¨‹</h2>
<p><div class="mermaid">flowchart LR
    subgraph å‡†å¤‡é˜¶æ®µ
        A[åŠ è½½é¢„è®­ç»ƒæ¨¡å‹] --&gt; B[å†»ç»“æ‰€æœ‰å‚æ•°]
        B --&gt; C[æ·»åŠ LoRAé€‚é…å™¨]
    end

    subgraph è®­ç»ƒé˜¶æ®µ
        C --&gt; D[å‰å‘ä¼ æ’­]
        D --&gt; E[è®¡ç®—æŸå¤±]
        E --&gt; F[åå‘ä¼ æ’­&lt;br/&gt;åªæ›´æ–°LoRAå‚æ•°]
        F --&gt; G{æŸå¤±æ”¶æ•›?}
        G --&gt;|å¦| D
        G --&gt;|æ˜¯| H[ä¿å­˜LoRAæƒé‡]
    end

    subgraph éƒ¨ç½²é˜¶æ®µ
        H --&gt; I[åˆå¹¶LoRAåˆ°åŸºç¡€æ¨¡å‹&lt;br/&gt;æˆ–å•ç‹¬åŠ è½½]
        I --&gt; J[éƒ¨ç½²æ¨ç†]
    end

    style A fill:#e1f5fe
    style H fill:#c8e6c9
    style J fill:#fff9c4</div></p>
<h2>LoRA vs å…¨å‚æ•°å¾®è°ƒå¯¹æ¯”</h2>
<p><div class="mermaid">flowchart TB
    subgraph å…¨å‚æ•°å¾®è°ƒ
        FT1["æ‰€æœ‰å‚æ•°å‚ä¸è®­ç»ƒ"] --&gt; FT2["éœ€è¦å¤§é‡æ˜¾å­˜"]
        FT2 --&gt; FT3["ä¿å­˜å®Œæ•´æ¨¡å‹å‰¯æœ¬"]
        FT3 --&gt; FT4["æ¯ä¸ªä»»åŠ¡ä¸€ä¸ª&lt;br/&gt;å®Œæ•´æ¨¡å‹æ–‡ä»¶"]
    end

    subgraph LoRAå¾®è°ƒ
        L1["åªè®­ç»ƒ1%å‚æ•°"] --&gt; L2["æ˜¾å­˜éœ€æ±‚å¤§å¹…é™ä½"]
        L2 --&gt; L3["åªä¿å­˜å°é€‚é…å™¨"]
        L3 --&gt; L4["å¤šä¸ªä»»åŠ¡å…±äº«&lt;br/&gt;åŒä¸€åŸºç¡€æ¨¡å‹"]
    end

    style FT1 fill:#ffcdd2
    style FT4 fill:#ffcdd2
    style L1 fill:#c8e6c9
    style L4 fill:#c8e6c9</div></p>
<h2>QLoRA é‡åŒ–æµç¨‹</h2>
<p><div class="mermaid">flowchart LR
    subgraph åŠ è½½é˜¶æ®µ
        A[16-bit åŸå§‹æ¨¡å‹] --&gt; B[é‡åŒ–ä¸º 4-bit NF4]
        B --&gt; C[åŒé‡é‡åŒ–&lt;br/&gt;å‹ç¼©é‡åŒ–å¸¸æ•°]
    end

    subgraph è®­ç»ƒé˜¶æ®µ
        C --&gt; D[åˆ†é¡µåŠ è½½åˆ°GPU]
        D --&gt; E[æŒ‰éœ€åé‡åŒ–è®¡ç®—]
        E --&gt; F[åªè®­ç»ƒLoRAå‚æ•°&lt;br/&gt;ä¿æŒ4-bitå­˜å‚¨]
    end

    subgraph æ¨ç†é˜¶æ®µ
        F --&gt; G[åˆå¹¶LoRAæƒé‡]
        G --&gt; H[å¯é€‰: ä¿æŒ4-bit&lt;br/&gt;æˆ–è½¬å›16-bit]
    end

    style A fill:#bbdefb
    style B fill:#e1bee7
    style F fill:#c8e6c9</div></p>
<h2>LoRA å‚æ•°é€‰æ‹©å†³ç­–æ ‘</h2>
<p><div class="mermaid">flowchart TD
    Start["é€‰æ‹© LoRA Rank (r)"] --&gt; Q1{"ä»»åŠ¡å¤æ‚åº¦?"}

    Q1 --&gt;|"ç®€å•&lt;br/&gt;(é£æ ¼/åˆ†ç±»)"| R1["r = 1-4"]
    Q1 --&gt;|"ä¸­ç­‰&lt;br/&gt;(æŒ‡ä»¤å¾®è°ƒ)"| R2["r = 8-16"]
    Q1 --&gt;|"å¤æ‚&lt;br/&gt;(æ–°çŸ¥è¯†)"| R3["r = 32-64"]

    R1 --&gt; Alpha["è®¾ç½® Î± = 2r æˆ– 16"]
    R2 --&gt; Alpha
    R3 --&gt; Alpha

    Alpha --&gt; Modules{"ç›®æ ‡æ¨¡å—?"}
    Modules --&gt;|"æœ€å°å¹²é¢„"| M1["q_proj, v_proj"]
    Modules --&gt;|"æ ‡å‡†é…ç½®"| M2["q,k,v,o_proj"]
    Modules --&gt;|"æœ€å¤§èƒ½åŠ›"| M3["æ‰€æœ‰çº¿æ€§å±‚"]

    M1 --&gt; Done["å¼€å§‹è®­ç»ƒ"]
    M2 --&gt; Done
    M3 --&gt; Done

    style Start fill:#e1f5fe
    style Done fill:#c8e6c9</div></p>
<h2>å›¾è§£è¯´æ˜</h2>
<h3>æ ¸å¿ƒåŸç†å›¾</h3>
<ul>
<li><strong>è“è‰²æ¡†</strong>ï¼šåŸå§‹å†»ç»“æƒé‡ï¼Œä¸å‚ä¸è®­ç»ƒ</li>
<li><strong>ç»¿è‰²æ¡†</strong>ï¼šLoRA å¯è®­ç»ƒå‚æ•°ï¼Œåªæœ‰åŸæ¨¡å‹çš„ 0.1%-1%</li>
<li><strong>æ•°å­¦å…¬å¼</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0404em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6954em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.0037em;">Î±</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal">A</span></span></span></span></li>
</ul>
<h3>å…³é”®æ¦‚å¿µ</h3>
<table>
<thead>
<tr>
<th>æ¦‚å¿µ</th>
<th>è¯´æ˜</th>
<th>æ¨èå€¼</th>
</tr>
</thead>
<tbody>
<tr>
<td>Rank Â®</td>
<td>ä½ç§©ç»´åº¦ï¼Œå†³å®šè¡¨è¾¾èƒ½åŠ›</td>
<td>8-16</td>
</tr>
<tr>
<td>Alpha (Î±)</td>
<td>ç¼©æ”¾å› å­ï¼Œæ§åˆ¶å½±å“å¼ºåº¦</td>
<td>16-32</td>
</tr>
<tr>
<td>Target Modules</td>
<td>åº”ç”¨ LoRA çš„å±‚</td>
<td>q_proj, v_proj</td>
</tr>
</tbody>
</table>
<h3>æµç¨‹è¦ç‚¹</h3>
<ol>
<li><strong>å‡†å¤‡</strong>ï¼šåŠ è½½æ¨¡å‹ â†’ å†»ç»“å‚æ•° â†’ æ³¨å…¥ LoRA</li>
<li><strong>è®­ç»ƒ</strong>ï¼šåªæ›´æ–° <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span> å’Œ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> çŸ©é˜µï¼Œå…¶ä»–ä¸å˜</li>
<li><strong>éƒ¨ç½²</strong>ï¼šå¯åˆå¹¶åˆ°åŸæ¨¡å‹ï¼Œæˆ–å•ç‹¬åŠ è½½é€‚é…å™¨</li>
</ol>
<div class="code-appendix page-break"><h2>é™„å½•ï¼šä»£ç ç¤ºä¾‹</h2><div class="code-file"><h3>lora_example.py</h3><pre class="hljs"><code><span class="hljs-string">&quot;&quot;&quot;
LoRA å¾®è°ƒç¤ºä¾‹ä»£ç 

æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ LoRA å¯¹å¤§è¯­è¨€æ¨¡å‹è¿›è¡Œå‚æ•°é«˜æ•ˆå¾®è°ƒã€‚
ä½¿ç”¨ Hugging Face PEFT åº“å®ç°ã€‚
&quot;&quot;&quot;</span>

<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> AutoModelForCausalLM, AutoTokenizer, TrainingArguments
<span class="hljs-keyword">from</span> peft <span class="hljs-keyword">import</span> LoraConfig, get_peft_model, TaskType
<span class="hljs-keyword">from</span> datasets <span class="hljs-keyword">import</span> Dataset

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 1. åŠ è½½é¢„è®­ç»ƒæ¨¡å‹å’Œåˆ†è¯å™¨</span>
<span class="hljs-comment"># ============================================</span>

model_name = <span class="hljs-string">&quot;meta-llama/Llama-2-7b-hf&quot;</span>  <span class="hljs-comment"># å¯æ›¿æ¢ä¸ºå…¶ä»–æ¨¡å‹</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;åŠ è½½æ¨¡å‹å’Œåˆ†è¯å™¨...&quot;</span>)
tokenizer = AutoTokenizer.from_pretrained(model_name)
tokenizer.pad_token = tokenizer.eos_token

<span class="hljs-comment"># ä»¥ FP16 åŠ è½½ä»¥èŠ‚çœæ˜¾å­˜</span>
model = AutoModelForCausalLM.from_pretrained(
    model_name,
    torch_dtype=torch.float16,
    device_map=<span class="hljs-string">&quot;auto&quot;</span>
)

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 2. é…ç½® LoRA</span>
<span class="hljs-comment"># ============================================</span>

lora_config = LoraConfig(
    <span class="hljs-comment"># ä½ç§©ç»´åº¦ - å†³å®š LoRA çš„è¡¨è¾¾èƒ½åŠ›</span>
    r=<span class="hljs-number">16</span>,

    <span class="hljs-comment"># ç¼©æ”¾å› å­ - æ§åˆ¶ LoRA æ›´æ–°çš„å¼ºåº¦</span>
    lora_alpha=<span class="hljs-number">32</span>,

    <span class="hljs-comment"># åº”ç”¨ LoRA çš„ç›®æ ‡æ¨¡å—</span>
    <span class="hljs-comment"># q_proj, v_proj æ˜¯æœ€å°é…ç½®</span>
    <span class="hljs-comment"># å¯ä»¥æ‰©å±•åˆ° [&quot;q_proj&quot;, &quot;k_proj&quot;, &quot;v_proj&quot;, &quot;o_proj&quot;]</span>
    target_modules=[<span class="hljs-string">&quot;q_proj&quot;</span>, <span class="hljs-string">&quot;v_proj&quot;</span>],

    <span class="hljs-comment"># LoRA å±‚çš„ dropout</span>
    lora_dropout=<span class="hljs-number">0.05</span>,

    <span class="hljs-comment"># ä¸è®­ç»ƒ bias</span>
    bias=<span class="hljs-string">&quot;none&quot;</span>,

    <span class="hljs-comment"># ä»»åŠ¡ç±»å‹</span>
    task_type=TaskType.CAUSAL_LM
)

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 3. åº”ç”¨ LoRA åˆ°æ¨¡å‹</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\nåº”ç”¨ LoRA é…ç½®...&quot;</span>)
model = get_peft_model(model, lora_config)

<span class="hljs-comment"># æ‰“å°å¯è®­ç»ƒå‚æ•°ä¿¡æ¯</span>
model.print_trainable_parameters()
<span class="hljs-comment"># è¾“å‡ºç¤ºä¾‹:</span>
<span class="hljs-comment"># trainable params: 4,194,304 || all params: 6,742,609,920 || trainable%: 0.0622</span>

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 4. å‡†å¤‡è®­ç»ƒæ•°æ®</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-comment"># ç¤ºä¾‹æ•°æ®ï¼ˆå®é™…ä½¿ç”¨æ—¶æ›¿æ¢ä¸ºä½ çš„æ•°æ®é›†ï¼‰</span>
train_data = [
    {<span class="hljs-string">&quot;text&quot;</span>: <span class="hljs-string">&quot;ç”¨æˆ·: ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ?\nåŠ©æ‰‹: æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªåˆ†æ”¯...&quot;</span>},
    {<span class="hljs-string">&quot;text&quot;</span>: <span class="hljs-string">&quot;ç”¨æˆ·: å¦‚ä½•å­¦ä¹ ç¼–ç¨‹?\nåŠ©æ‰‹: å­¦ä¹ ç¼–ç¨‹å¯ä»¥ä»ä»¥ä¸‹æ­¥éª¤å¼€å§‹...&quot;</span>},
    <span class="hljs-comment"># ... æ›´å¤šæ•°æ®</span>
]

<span class="hljs-keyword">def</span> <span class="hljs-title function_">tokenize_function</span>(<span class="hljs-params">examples</span>):
    <span class="hljs-string">&quot;&quot;&quot;å¯¹æ–‡æœ¬è¿›è¡Œåˆ†è¯&quot;&quot;&quot;</span>
    <span class="hljs-keyword">return</span> tokenizer(
        examples[<span class="hljs-string">&quot;text&quot;</span>],
        truncation=<span class="hljs-literal">True</span>,
        padding=<span class="hljs-string">&quot;max_length&quot;</span>,
        max_length=<span class="hljs-number">512</span>
    )

<span class="hljs-comment"># åˆ›å»º Dataset å¹¶åˆ†è¯</span>
dataset = Dataset.from_list(train_data)
tokenized_dataset = dataset.<span class="hljs-built_in">map</span>(tokenize_function, batched=<span class="hljs-literal">True</span>)

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 5. è®­ç»ƒé…ç½®</span>
<span class="hljs-comment"># ============================================</span>

training_args = TrainingArguments(
    output_dir=<span class="hljs-string">&quot;./lora-output&quot;</span>,

    <span class="hljs-comment"># æ‰¹æ¬¡å¤§å°</span>
    per_device_train_batch_size=<span class="hljs-number">4</span>,
    gradient_accumulation_steps=<span class="hljs-number">4</span>,  <span class="hljs-comment"># æœ‰æ•ˆæ‰¹æ¬¡ = 4 * 4 = 16</span>

    <span class="hljs-comment"># å­¦ä¹ ç‡ - LoRA é€šå¸¸å¯ä»¥ç”¨è¾ƒé«˜çš„å­¦ä¹ ç‡</span>
    learning_rate=<span class="hljs-number">1e-4</span>,

    <span class="hljs-comment"># è®­ç»ƒè½®æ•°</span>
    num_train_epochs=<span class="hljs-number">3</span>,

    <span class="hljs-comment"># æ··åˆç²¾åº¦è®­ç»ƒ</span>
    fp16=<span class="hljs-literal">True</span>,

    <span class="hljs-comment"># æ—¥å¿—</span>
    logging_steps=<span class="hljs-number">10</span>,
    save_steps=<span class="hljs-number">100</span>,

    <span class="hljs-comment"># å…¶ä»–</span>
    warmup_steps=<span class="hljs-number">100</span>,
    save_total_limit=<span class="hljs-number">2</span>,
)

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 6. å¼€å§‹è®­ç»ƒ</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> Trainer

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\nå¼€å§‹ LoRA å¾®è°ƒè®­ç»ƒ...&quot;</span>)

trainer = Trainer(
    model=model,
    args=training_args,
    train_dataset=tokenized_dataset,
)

trainer.train()

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 7. ä¿å­˜ LoRA æƒé‡</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\nä¿å­˜ LoRA æƒé‡...&quot;</span>)
model.save_pretrained(<span class="hljs-string">&quot;./lora-output&quot;</span>)

<span class="hljs-comment"># åªä¿å­˜ LoRA é€‚é…å™¨æƒé‡ï¼ˆéå¸¸å°ï¼Œå‡  MBï¼‰</span>
<span class="hljs-comment"># å¯ä»¥éšæ—¶åŠ è½½åˆ°åŸå§‹æ¨¡å‹ä¸Š</span>

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 8. æ¨ç†ç¤ºä¾‹</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\næ¨ç†æµ‹è¯•...&quot;</span>)
prompt = <span class="hljs-string">&quot;ç”¨æˆ·: ä»€ä¹ˆæ˜¯æ·±åº¦å­¦ä¹ ?\nåŠ©æ‰‹:&quot;</span>
inputs = tokenizer(prompt, return_tensors=<span class="hljs-string">&quot;pt&quot;</span>).to(model.device)

<span class="hljs-keyword">with</span> torch.no_grad():
    outputs = model.generate(
        **inputs,
        max_new_tokens=<span class="hljs-number">100</span>,
        temperature=<span class="hljs-number">0.7</span>,
        do_sample=<span class="hljs-literal">True</span>
    )

<span class="hljs-built_in">print</span>(tokenizer.decode(outputs[<span class="hljs-number">0</span>], skip_special_tokens=<span class="hljs-literal">True</span>))

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 9. åˆå¹¶ LoRA åˆ°åŸºç¡€æ¨¡å‹ï¼ˆå¯é€‰ï¼‰</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-comment"># å¦‚æœæƒ³è¦ç‹¬ç«‹çš„æ¨¡å‹ï¼ˆä¸éœ€è¦ PEFT åº“ï¼‰:</span>
<span class="hljs-comment"># merged_model = model.merge_and_unload()</span>
<span class="hljs-comment"># merged_model.save_pretrained(&quot;./merged-model&quot;)</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">50</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;LoRA å¾®è°ƒå®Œæˆ!&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;LoRA æƒé‡ä¿å­˜åœ¨: ./lora-output&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">50</span>)
</code></pre></div><div class="code-file"><h3>qlora_example.py</h3><pre class="hljs"><code><span class="hljs-string">&quot;&quot;&quot;
QLoRA å¾®è°ƒç¤ºä¾‹ä»£ç 

æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ QLoRA (Quantized LoRA) åœ¨æœ‰é™æ˜¾å­˜ä¸‹å¾®è°ƒå¤§æ¨¡å‹ã€‚
QLoRA ç»“åˆäº† 4-bit é‡åŒ–å’Œ LoRAï¼Œå¤§å¹…é™ä½æ˜¾å­˜éœ€æ±‚ã€‚
&quot;&quot;&quot;</span>

<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> (
    AutoModelForCausalLM,
    AutoTokenizer,
    TrainingArguments,
    BitsAndBytesConfig
)
<span class="hljs-keyword">from</span> peft <span class="hljs-keyword">import</span> LoraConfig, get_peft_model, prepare_model_for_kbit_training
<span class="hljs-keyword">from</span> datasets <span class="hljs-keyword">import</span> Dataset

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 1. é…ç½® 4-bit é‡åŒ– (QLoRA çš„æ ¸å¿ƒ)</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-comment"># QLoRA çš„é‡åŒ–é…ç½®</span>
bnb_config = BitsAndBytesConfig(
    <span class="hljs-comment"># ä½¿ç”¨ 4-bit é‡åŒ–</span>
    load_in_4bit=<span class="hljs-literal">True</span>,

    <span class="hljs-comment"># ä½¿ç”¨ NF4 (NormalFloat4) æ•°æ®ç±»å‹</span>
    <span class="hljs-comment"># è¿™æ˜¯ä¸“é—¨ä¸ºæ­£æ€åˆ†å¸ƒæƒé‡è®¾è®¡çš„é‡åŒ–æ ¼å¼</span>
    bnb_4bit_quant_type=<span class="hljs-string">&quot;nf4&quot;</span>,

    <span class="hljs-comment"># ä½¿ç”¨åŒé‡é‡åŒ– (è¿›ä¸€æ­¥å‹ç¼©)</span>
    bnb_4bit_use_double_quant=<span class="hljs-literal">True</span>,

    <span class="hljs-comment"># è®¡ç®—æ—¶ä½¿ç”¨ 16-bit ç²¾åº¦</span>
    bnb_4bit_compute_dtype=torch.float16
)

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 2. åŠ è½½é‡åŒ–æ¨¡å‹</span>
<span class="hljs-comment"># ============================================</span>

model_name = <span class="hljs-string">&quot;meta-llama/Llama-2-7b-hf&quot;</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;åŠ è½½ 4-bit é‡åŒ–æ¨¡å‹...&quot;</span>)
tokenizer = AutoTokenizer.from_pretrained(model_name)
tokenizer.pad_token = tokenizer.eos_token

<span class="hljs-comment"># ä»¥ 4-bit åŠ è½½æ¨¡å‹</span>
model = AutoModelForCausalLM.from_pretrained(
    model_name,
    quantization_config=bnb_config,
    device_map=<span class="hljs-string">&quot;auto&quot;</span>
)

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 3. å‡†å¤‡æ¨¡å‹è¿›è¡Œ k-bit è®­ç»ƒ</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;å‡†å¤‡æ¨¡å‹è¿›è¡Œ QLoRA è®­ç»ƒ...&quot;</span>)

<span class="hljs-comment"># è¿™ä¸€æ­¥å¾ˆé‡è¦ï¼š</span>
<span class="hljs-comment"># - å¯ç”¨æ¢¯åº¦æ£€æŸ¥ç‚¹ä»¥èŠ‚çœæ˜¾å­˜</span>
<span class="hljs-comment"># - è®¾ç½®å¿…è¦çš„ dtype è½¬æ¢</span>
model = prepare_model_for_kbit_training(model)

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 4. é…ç½® LoRA (ä¸æ ‡å‡† LoRA ç±»ä¼¼)</span>
<span class="hljs-comment"># ============================================</span>

lora_config = LoraConfig(
    r=<span class="hljs-number">16</span>,                    <span class="hljs-comment"># ä½ç§©ç»´åº¦</span>
    lora_alpha=<span class="hljs-number">32</span>,           <span class="hljs-comment"># ç¼©æ”¾å› å­</span>
    target_modules=[
        <span class="hljs-string">&quot;q_proj&quot;</span>, <span class="hljs-string">&quot;k_proj&quot;</span>, <span class="hljs-string">&quot;v_proj&quot;</span>, <span class="hljs-string">&quot;o_proj&quot;</span>,  <span class="hljs-comment"># æ³¨æ„åŠ›å±‚</span>
        <span class="hljs-string">&quot;gate_proj&quot;</span>, <span class="hljs-string">&quot;up_proj&quot;</span>, <span class="hljs-string">&quot;down_proj&quot;</span>       <span class="hljs-comment"># FFN å±‚ (å¯é€‰)</span>
    ],
    lora_dropout=<span class="hljs-number">0.05</span>,
    bias=<span class="hljs-string">&quot;none&quot;</span>,
    task_type=<span class="hljs-string">&quot;CAUSAL_LM&quot;</span>
)

<span class="hljs-comment"># åº”ç”¨ LoRA</span>
model = get_peft_model(model, lora_config)
model.print_trainable_parameters()

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 5. æ˜¾å­˜å¯¹æ¯”</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">print_memory_usage</span>():
    <span class="hljs-keyword">if</span> torch.cuda.is_available():
        allocated = torch.cuda.memory_allocated() / <span class="hljs-number">1024</span>**<span class="hljs-number">3</span>
        reserved = torch.cuda.memory_reserved() / <span class="hljs-number">1024</span>**<span class="hljs-number">3</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;GPU æ˜¾å­˜: å·²åˆ†é… <span class="hljs-subst">{allocated:<span class="hljs-number">.2</span>f}</span> GB, å·²é¢„ç•™ <span class="hljs-subst">{reserved:<span class="hljs-number">.2</span>f}</span> GB&quot;</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\nå½“å‰æ˜¾å­˜ä½¿ç”¨:&quot;</span>)
print_memory_usage()

<span class="hljs-comment"># æ˜¾å­˜å¯¹æ¯” (7B æ¨¡å‹):</span>
<span class="hljs-comment"># - å…¨å‚æ•°å¾®è°ƒ (FP16): ~28 GB</span>
<span class="hljs-comment"># - LoRA (FP16):       ~16 GB</span>
<span class="hljs-comment"># - QLoRA (4-bit):     ~6 GB</span>

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 6. è®­ç»ƒé…ç½®</span>
<span class="hljs-comment"># ============================================</span>

training_args = TrainingArguments(
    output_dir=<span class="hljs-string">&quot;./qlora-output&quot;</span>,

    <span class="hljs-comment"># QLoRA å¯ä»¥ä½¿ç”¨æ›´å¤§çš„æ‰¹æ¬¡ï¼ˆæ˜¾å­˜å ç”¨ä½ï¼‰</span>
    per_device_train_batch_size=<span class="hljs-number">8</span>,
    gradient_accumulation_steps=<span class="hljs-number">2</span>,

    <span class="hljs-comment"># å­¦ä¹ ç‡</span>
    learning_rate=<span class="hljs-number">2e-4</span>,

    <span class="hljs-comment"># è®­ç»ƒè½®æ•°</span>
    num_train_epochs=<span class="hljs-number">3</span>,

    <span class="hljs-comment"># ä½¿ç”¨ 16-bit æ··åˆç²¾åº¦</span>
    fp16=<span class="hljs-literal">True</span>,

    <span class="hljs-comment"># æ¢¯åº¦æ£€æŸ¥ç‚¹ï¼ˆè¿›ä¸€æ­¥èŠ‚çœæ˜¾å­˜ï¼‰</span>
    gradient_checkpointing=<span class="hljs-literal">True</span>,

    <span class="hljs-comment"># ä¼˜åŒ–å™¨è®¾ç½®</span>
    optim=<span class="hljs-string">&quot;paged_adamw_8bit&quot;</span>,  <span class="hljs-comment"># ä½¿ç”¨åˆ†é¡µä¼˜åŒ–å™¨ï¼Œé¿å… OOM</span>

    <span class="hljs-comment"># æ—¥å¿—</span>
    logging_steps=<span class="hljs-number">10</span>,
    save_steps=<span class="hljs-number">100</span>,
    warmup_steps=<span class="hljs-number">100</span>,
)

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 7. å‡†å¤‡æ•°æ®</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-comment"># ç¤ºä¾‹ï¼šæŒ‡ä»¤å¾®è°ƒæ•°æ®æ ¼å¼</span>
train_data = [
    {
        <span class="hljs-string">&quot;instruction&quot;</span>: <span class="hljs-string">&quot;è§£é‡Šä»€ä¹ˆæ˜¯è¿‡æ‹Ÿåˆ&quot;</span>,
        <span class="hljs-string">&quot;input&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,
        <span class="hljs-string">&quot;output&quot;</span>: <span class="hljs-string">&quot;è¿‡æ‹Ÿåˆæ˜¯æŒ‡æ¨¡å‹åœ¨è®­ç»ƒæ•°æ®ä¸Šè¡¨ç°å¾ˆå¥½ï¼Œä½†åœ¨æµ‹è¯•æ•°æ®ä¸Šè¡¨ç°è¾ƒå·®çš„ç°è±¡...&quot;</span>
    },
    {
        <span class="hljs-string">&quot;instruction&quot;</span>: <span class="hljs-string">&quot;å†™ä¸€é¦–å…³äºæ˜¥å¤©çš„è¯—&quot;</span>,
        <span class="hljs-string">&quot;input&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,
        <span class="hljs-string">&quot;output&quot;</span>: <span class="hljs-string">&quot;æ˜¥é£æ‹‚é¢æŸ³ä¸é•¿ï¼Œæ¡ƒèŠ±ç››å¼€æ»¡å›­é¦™...&quot;</span>
    },
    <span class="hljs-comment"># ... æ›´å¤šæ•°æ®</span>
]

<span class="hljs-keyword">def</span> <span class="hljs-title function_">format_instruction</span>(<span class="hljs-params">sample</span>):
    <span class="hljs-string">&quot;&quot;&quot;æ ¼å¼åŒ–ä¸ºæŒ‡ä»¤å¾®è°ƒæ ¼å¼&quot;&quot;&quot;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;&quot;&quot;### æŒ‡ä»¤:
<span class="hljs-subst">{sample[<span class="hljs-string">&#x27;instruction&#x27;</span>]}</span>

### è¾“å…¥:
<span class="hljs-subst">{sample[<span class="hljs-string">&#x27;input&#x27;</span>]}</span>

### å›ç­”:
<span class="hljs-subst">{sample[<span class="hljs-string">&#x27;output&#x27;</span>]}</span>&quot;&quot;&quot;</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">tokenize</span>(<span class="hljs-params">sample</span>):
    text = format_instruction(sample)
    result = tokenizer(
        text,
        truncation=<span class="hljs-literal">True</span>,
        padding=<span class="hljs-string">&quot;max_length&quot;</span>,
        max_length=<span class="hljs-number">512</span>
    )
    result[<span class="hljs-string">&quot;labels&quot;</span>] = result[<span class="hljs-string">&quot;input_ids&quot;</span>].copy()
    <span class="hljs-keyword">return</span> result

dataset = Dataset.from_list(train_data)
tokenized_dataset = dataset.<span class="hljs-built_in">map</span>(tokenize)

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 8. è®­ç»ƒ</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> Trainer

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\nå¼€å§‹ QLoRA å¾®è°ƒ...&quot;</span>)

trainer = Trainer(
    model=model,
    args=training_args,
    train_dataset=tokenized_dataset,
)

trainer.train()

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 9. ä¿å­˜å’ŒåŠ è½½</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\nä¿å­˜ QLoRA é€‚é…å™¨...&quot;</span>)
model.save_pretrained(<span class="hljs-string">&quot;./qlora-output&quot;</span>)

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 10. åŠ è½½å·²è®­ç»ƒçš„ QLoRA æ¨¡å‹è¿›è¡Œæ¨ç†</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">load_qlora_for_inference</span>(<span class="hljs-params">model_name, adapter_path</span>):
    <span class="hljs-string">&quot;&quot;&quot;åŠ è½½ QLoRA æ¨¡å‹è¿›è¡Œæ¨ç†&quot;&quot;&quot;</span>
    <span class="hljs-keyword">from</span> peft <span class="hljs-keyword">import</span> PeftModel

    <span class="hljs-comment"># åŠ è½½åŸºç¡€æ¨¡å‹ï¼ˆ4-bitï¼‰</span>
    base_model = AutoModelForCausalLM.from_pretrained(
        model_name,
        quantization_config=bnb_config,
        device_map=<span class="hljs-string">&quot;auto&quot;</span>
    )

    <span class="hljs-comment"># åŠ è½½ LoRA é€‚é…å™¨</span>
    model = PeftModel.from_pretrained(base_model, adapter_path)

    <span class="hljs-keyword">return</span> model

<span class="hljs-comment"># ä½¿ç”¨ç¤ºä¾‹</span>
<span class="hljs-comment"># inference_model = load_qlora_for_inference(model_name, &quot;./qlora-output&quot;)</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">50</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;QLoRA å¾®è°ƒå®Œæˆ!&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;é€‚é…å™¨æƒé‡ä¿å­˜åœ¨: ./qlora-output&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">50</span>)

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># é™„å½•: QLoRA vs LoRA vs å…¨å‚æ•°å¾®è°ƒ</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-string">&quot;&quot;&quot;
æ˜¾å­˜éœ€æ±‚å¯¹æ¯” (7B æ¨¡å‹):

| æ–¹æ³•           | åŸºç¡€æ˜¾å­˜ | è®­ç»ƒæ˜¾å­˜ | æ¨¡å‹ç²¾åº¦ |
|---------------|---------|---------|---------|
| å…¨å‚æ•°å¾®è°ƒ      | 14 GB   | ~28 GB  | FP16    |
| LoRA          | 14 GB   | ~16 GB  | FP16    |
| QLoRA         | 3.5 GB  | ~6 GB   | 4-bit   |

é€‚ç”¨åœºæ™¯:
- QLoRA: æ¶ˆè´¹çº§æ˜¾å¡ (å¦‚ RTX 3060 12GB)
- LoRA: ä¸­ç«¯æ˜¾å¡ (å¦‚ RTX 3090 24GB)
- å…¨å‚æ•°: ä¸“ä¸šæ˜¾å¡ (å¦‚ A100 40GB+)
&quot;&quot;&quot;</span>
</code></pre></div></div></div><div class="chapter"><h1>ç¬¬11ç«  Quantization æ¨¡å‹é‡åŒ–</h1><h1>é‡åŒ–ç§‘æ™®ç‰ˆ</h1>
<blockquote>
<p>é¢å‘é›¶åŸºç¡€è¯»è€…çš„æ¨¡å‹é‡åŒ–å…¥é—¨æŒ‡å—</p>
</blockquote>
<h2>ä¸€å¥è¯æ¦‚æ‹¬</h2>
<p><strong>é‡åŒ–å°±æ˜¯æŠŠæ¨¡å‹çš„æ•°å­—ä»&quot;é«˜ç²¾åº¦&quot;å˜æˆ&quot;ä½ç²¾åº¦&quot;ï¼Œè®©æ¨¡å‹å˜å°ã€å˜å¿«ï¼Œä½†å°½é‡ä¿æŒèªæ˜ï¿½ï¿½ï¿½</strong></p>
<h2>ä»ä¸€ä¸ªé—®é¢˜å¼€å§‹</h2>
<p>ä½ ä¸‹è½½äº†ä¸€ä¸ª 70GB çš„å¤§æ¨¡å‹ï¼Œæƒ³åœ¨è‡ªå·±çš„ç”µè„‘ä¸Šè¿è¡Œã€‚ä½†æ˜¯ï¼š</p>
<ul>
<li>ä½ çš„æ˜¾å¡åªæœ‰ 24GB æ˜¾å­˜</li>
<li>ä½ çš„ç¡¬ç›˜å¿«æ»¡äº†</li>
<li>æ¨¡å‹è¿è¡Œé€Ÿåº¦å¤ªæ…¢</li>
</ul>
<p>æ€ä¹ˆåŠï¼Ÿ<strong>é‡åŒ–</strong>å°±æ˜¯è§£å†³æ–¹æ¡ˆï¼</p>
<h2>ä»€ä¹ˆæ˜¯é‡åŒ–ï¼Ÿ</h2>
<h3>ç”Ÿæ´»ä¸­çš„ç±»æ¯”</h3>
<p>æƒ³è±¡ä½ æœ‰ä¸€å¼ è¶…é«˜æ¸…çš„ 4K ç…§ç‰‡ï¼ˆ100MBï¼‰ï¼š</p>
<ul>
<li><strong>åŸå§‹ç²¾åº¦</strong>ï¼šæ¯ä¸ªåƒç´ ç”¨ 16 ä½æ•°å­—æè¿°ï¼Œå®Œç¾ä½†å ç©ºé—´</li>
<li><strong>é‡åŒ–å</strong>ï¼šæ¯ä¸ªåƒç´ ç”¨ 4 ä½æ•°å­—æè¿°ï¼Œç¨å¾®æ¨¡ç³Šä½†åªæœ‰ 25MB</li>
</ul>
<p>ç…§ç‰‡è¿˜æ˜¯é‚£å¼ ç…§ç‰‡ï¼Œåªæ˜¯ç»†èŠ‚ç¨å¾®æŸå¤±äº†ä¸€ç‚¹ï¼Œä½†æ–‡ä»¶å°äº†å¾ˆå¤šï¼</p>
<h3>æ¨¡å‹é‡åŒ–</h3>
<p>ç¥ç»ç½‘ç»œä¸­çš„å‚æ•°é€šå¸¸æ˜¯ <strong>16-bit æˆ– 32-bit</strong> æµ®ç‚¹æ•°ã€‚é‡åŒ–ï¿½ï¿½ï¿½æ˜¯æŠŠè¿™äº›æ•°å˜æˆ <strong>4-bit æˆ– 8-bit</strong> æ•´æ•°ï¼š</p>
<pre class="hljs"><code>åŸå§‹: 0.123456789012345 (16-bit)  â†’  é‡åŒ–: 0.125 (4-bit)
</code></pre>
<h2>é‡åŒ–èƒ½å¸¦æ¥ä»€ä¹ˆï¼Ÿ</h2>
<table>
<thead>
<tr>
<th>å¥½å¤„</th>
<th>å…·ä½“æ•°å€¼</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ¨¡å‹å˜å°</td>
<td>70GB â†’ 20GB (4-bit)</td>
</tr>
<tr>
<td>æ˜¾å­˜é™ä½</td>
<td>èƒ½åœ¨æ¶ˆè´¹çº§æ˜¾å¡ä¸Šè¿è¡Œ</td>
</tr>
<tr>
<td>é€Ÿåº¦å˜å¿«</td>
<td>è®¡ç®—ã€ä¼ è¾“éƒ½æ›´å¿«</td>
</tr>
<tr>
<td>æˆæœ¬é™ä½</td>
<td>ç”¨æ›´ä¾¿å®œçš„ç¡¬ä»¶</td>
</tr>
</tbody>
</table>
<h2>ç²¾åº¦å¯¹æ¯”</h2>
<table>
<thead>
<tr>
<th>ç²¾åº¦</th>
<th>æ¯ä¸ªå‚æ•°</th>
<th>70B æ¨¡ï¿½ï¿½ï¿½å¤§å°</th>
<th>è´¨é‡</th>
</tr>
</thead>
<tbody>
<tr>
<td>FP32</td>
<td>4 å­—èŠ‚</td>
<td>280 GB</td>
<td>å®Œç¾</td>
</tr>
<tr>
<td>FP16</td>
<td>2 å­—èŠ‚</td>
<td>140 GB</td>
<td>å‡ ä¹å®Œç¾</td>
</tr>
<tr>
<td>INT8</td>
<td>1 å­—èŠ‚</td>
<td>70 GB</td>
<td>å¾ˆå¥½</td>
</tr>
<tr>
<td>INT4</td>
<td>0.5 å­—èŠ‚</td>
<td>35 GB</td>
<td>è‰¯å¥½</td>
</tr>
</tbody>
</table>
<h2>å¸¸è§é‡åŒ–æ–¹æ³•</h2>
<h3>1. GPTQ</h3>
<p>æœ€æµè¡Œçš„é‡åŒ–æ–¹æ³•ä¹‹ä¸€ã€‚</p>
<ul>
<li><strong>ç‰¹ç‚¹</strong>ï¼šè®­ç»ƒåé‡åŒ–ï¼Œä¸éœ€è¦é‡æ–°è®­ç»ƒ</li>
<li><strong>é€Ÿåº¦</strong>ï¼šé‡åŒ–è¿‡ç¨‹è¾ƒæ…¢ï¼Œä½†æ¨ç†å¿«</li>
<li><strong>è´¨é‡</strong>ï¼šINT4 ä¸‹ä¿æŒè¾ƒå¥½</li>
</ul>
<h3>2. AWQ (Activation-aware Weight Quantization)</h3>
<ul>
<li><strong>ç‰¹ç‚¹</strong>ï¼šè€ƒè™‘æ¿€æ´»å€¼çš„é‡è¦æ€§</li>
<li><strong>é€Ÿåº¦</strong>ï¼šé‡åŒ–é€Ÿåº¦å¿«</li>
<li><strong>è´¨é‡</strong>ï¼šé€šå¸¸æ¯” GPTQ ç¨å¥½</li>
</ul>
<h3>3. GGUF (llama.cpp)</h3>
<ul>
<li><strong>ç‰¹ç‚¹</strong>ï¼šä¸“ä¸º CPU æ¨ç†è®¾è®¡</li>
<li><strong>é€‚ç”¨</strong>ï¼šæ²¡æœ‰ GPU çš„è®¾å¤‡</li>
<li><strong>æµè¡Œ</strong>ï¼šå¾ˆå¤šå¼€æºæ¨¡å‹éƒ½æä¾› GGUF ç‰ˆæœ¬</li>
</ul>
<h2>é‡åŒ–ä¼šæœ‰ä»€ä¹ˆæŸå¤±ï¼Ÿ</h2>
<h3>è´¨é‡ä¸‹é™</h3>
<p>é‡åŒ–ä¼šæŸå¤±ä¸€äº›ç²¾åº¦ï¼Œå°±åƒå‹ç¼©ç…§ç‰‡ä¼šæ¨¡ç³Šä¸€æ ·ï¼š</p>
<table>
<thead>
<tr>
<th>é‡åŒ–ç¨‹åº¦</th>
<th>è´¨é‡å½±å“</th>
</tr>
</thead>
<tbody>
<tr>
<td>INT8</td>
<td>å‡ ä¹æ— æŸ</td>
</tr>
<tr>
<td>INT4</td>
<td>è½»å¾®æŸå¤±ï¼Œå¤§éƒ¨åˆ†ä»»åŠ¡å¯ç”¨</td>
</tr>
<tr>
<td>INT3</td>
<td>æ˜æ˜¾æŸå¤±ï¼Œç®€å•ä»»åŠ¡å¯ç”¨</td>
</tr>
</tbody>
</table>
<h3>ä»€ä¹ˆæ—¶å€™ä¸æ¨èé‡åŒ–ï¼Ÿ</h3>
<ul>
<li>ä»»åŠ¡éœ€è¦æœ€é«˜ç²¾åº¦ï¼ˆå¦‚åŒ»ç–—è¯Šæ–­ï¼‰</li>
<li>æ¨¡å‹æœ¬èº«å°±å¾ˆå¤æ‚</li>
<li>æœ‰å……è¶³çš„ç¡¬ä»¶èµ„æº</li>
</ul>
<h2>å®é™…é€‰æ‹©å»ºè®®</h2>
<p><div class="mermaid">flowchart LR
    A[é€‰æ‹©é‡åŒ–ç²¾åº¦] --&gt; B{"æœ‰GPUå—?"}
    B --&gt;|"æ˜¯"| C{æ˜¾å­˜å¤§å°?}
    B --&gt;|"å¦"| D["ä½¿ç”¨ GGUF&lt;br/&gt;(CPUæ¨ç†)"]

    C --&gt;|"&gt;48GB"| E["INT8 æˆ– FP16"]
    C --&gt;|"24-48GB"| F["INT4 (GPTQ/AWQ)"]
    C --&gt;|"&lt;24GB"| G["INT4 QLoRA"]

    style E fill:#c8e6c9
    style F fill:#c8e6c9
    style G fill:#fff9c4</div></p>
<h2>ä½ éœ€è¦è®°ä½çš„</h2>
<table>
<thead>
<tr>
<th>æ¦‚å¿µ</th>
<th>é€šä¿—ç†è§£</th>
</tr>
</thead>
<tbody>
<tr>
<td>é‡åŒ–</td>
<td>æŠŠæ•°å­—ç²¾åº¦é™ä½ï¼Œæ¨¡å‹å˜å°</td>
</tr>
<tr>
<td>FP16/INT8/INT4</td>
<td>ç²¾åº¦çº§åˆ«ï¼Œæ•°å­—è¶Šå°è¶Šçœç©ºé—´</td>
</tr>
<tr>
<td>GPTQ/AWQ</td>
<td>å¸¸ç”¨çš„é‡åŒ–æ–¹æ³•</td>
</tr>
<tr>
<td>GGUF</td>
<td>é€‚åˆ CPU çš„é‡åŒ–æ ¼å¼</td>
</tr>
</tbody>
</table>
<h2>ä¸‹ä¸€æ­¥</h2>
<ul>
<li>æƒ³äº†è§£æŠ€æœ¯ç»†èŠ‚ï¼Ÿé˜…è¯» <a href="advanced-guide.md">æ·±å…¥ç‰ˆ</a></li>
<li>æƒ³çœ‹ä»£ç å®ç°ï¼ŸæŸ¥çœ‹ <code>examples/</code> ç›®å½•</li>
<li>æƒ³çœ‹æµç¨‹å›¾ï¼ŸæŸ¥çœ‹ <a href="diagram.md">æµç¨‹å›¾è§£</a></li>
</ul>
<h1>é‡åŒ–æ·±å…¥ç‰ˆ</h1>
<blockquote>
<p>é¢å‘æœ‰æœºå™¨å­¦ä¹ åŸºç¡€è¯»è€…çš„æŠ€æœ¯è¯¦è§£</p>
</blockquote>
<h2>æ¦‚è¿°</h2>
<p>é‡åŒ–ï¼ˆQuantizationï¼‰æ˜¯å°†é«˜ç²¾åº¦æµ®ç‚¹æ•°æ˜ å°„åˆ°ä½ç²¾åº¦è¡¨ç¤ºçš„æŠ€æœ¯ã€‚å¯¹äºæƒé‡çŸ©é˜µ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7713em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7713em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">Ã—</span><span class="mord mathnormal mtight">m</span></span></span></span></span></span></span></span></span></span></span></span>ï¼Œé‡åŒ–æ“ä½œå¯è¡¨ç¤ºä¸ºï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9468em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9468em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span><span style="top:-3.2523em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">^</span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4445em;"></span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="mord text"><span class="mord">clamp</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord text"><span class="mord">round</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">s</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">âˆ’</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span></span></span></span></span></p>
<p><a id="formula-quantization-1"></a>
<a href="#formula-quantization-1-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šå°†æµ®ç‚¹æ•°é™¤ä»¥ç¼©æ”¾å› å­ã€å››èˆäº”å…¥ã€æˆªæ–­åˆ°ç›®æ ‡èŒƒå›´ï¼Œå†ä¹˜å›å¤åŸã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">s</span></span></span></span> ä¸ºç¼©æ”¾å› å­ï¼ˆscaleï¼‰ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">b</span></span></span></span> ä¸ºç›®æ ‡ä½å®½ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord">round</span></span></span></span></span> ä¸ºèˆå…¥ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">clamp</span></span></span></span></span> ä¸ºæˆªæ–­åˆ° <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0991em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">âˆ’</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span>ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šç”¨æœ‰é™çš„æ•´æ•°è¿‘ä¼¼è¿ç»­æµ®ç‚¹æ•°ï¼Œç‰ºç‰²å°‘é‡ç²¾åº¦æ¢å–å¤§å¹…å‹ç¼©ã€‚</li>
</ul>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">s</span></span></span></span> æ˜¯é‡åŒ–ç¼©æ”¾å› å­ï¼ˆscaleï¼‰</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">b</span></span></span></span> æ˜¯ç›®æ ‡ä½å®½ï¼ˆå¦‚ 4, 8ï¼‰</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord">round</span></span></span></span></span> æ˜¯èˆå…¥å‡½æ•°</li>
</ul>
<h2>é‡åŒ–åŸºç¡€</h2>
<h3>é‡åŒ–ç±»å‹</h3>
<h4>1. å¯¹ç§°é‡åŒ–</h4>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.113em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7751em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop">max</span><span class="mopen">(</span><span class="mord">âˆ£</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mord">âˆ£</span><span class="mclose">)</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><a id="formula-quantization-2"></a>
<a href="#formula-quantization-2-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4445em;"></span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.836em;vertical-align:-0.686em;"></span><span class="mord text"><span class="mord">round</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size2">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">s</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">x</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size2">)</span></span></span></span></span></span></span></p>
<p><a id="formula-quantization-3"></a>
<a href="#formula-quantization-3-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šç¼©æ”¾å› å­ç”±æœ€å¤§ç»å¯¹å€¼å†³å®šï¼Œé‡ï¿½ï¿½èŒƒå›´å…³äº 0 å¯¹ç§°ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">s</span></span></span></span> ä¸ºç¼©æ”¾å› å­ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">b</span></span></span></span> ä¸ºä½å®½ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span> ä¸ºé‡åŒ–çº§åˆ«æ•°çš„ä¸€åŠã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šé›¶ç‚¹ä¿æŒä¸å˜ï¼Œå®ç°ç®€å•ï¼Œä½†éå‡åŒ€åˆ†å¸ƒæ—¶ä¼šæµªè´¹éƒ¨åˆ†é‡åŒ–èŒƒå›´ã€‚</li>
</ul>
<p><strong>ä¼˜ç‚¹</strong>ï¼šç®€å•ï¼Œé›¶ç‚¹ä¸å˜
<strong>ç¼ºç‚¹</strong>ï¼šéå‡åŒ€åˆ†å¸ƒæ—¶æµªè´¹åŠ¨æ€èŒƒå›´</p>
<h4>2. éå¯¹ç§°é‡åŒ–</h4>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.1963em;vertical-align:-0.7693em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7751em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop">max</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mop">min</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mclose">)</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><a id="formula-quantization-4"></a>
<a href="#formula-quantization-4-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="mord text"><span class="mord">round</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord">âˆ’</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">s</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop">min</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mclose">)</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span></span></span></span></span></p>
<p><a id="formula-quantization-5"></a>
<a href="#formula-quantization-5-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4445em;"></span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">round</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord">/</span><span class="mord mathnormal">s</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mclose">)</span></span></span></span></span></p>
<p><a id="formula-quantization-6"></a>
<a href="#formula-quantization-6-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šç¼©æ”¾å› å­ç”±å€¼åŸŸèŒƒå›´å†³å®šï¼Œå¼•å…¥é›¶ç‚¹åç§» <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span></span> é€‚é…éå¯¹ç§°åˆ†å¸ƒã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">s</span></span></span></span> ä¸ºç¼©æ”¾å› å­ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span></span> ä¸ºé›¶ç‚¹ï¼ˆzero pointï¼‰ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9324em;vertical-align:-0.0833em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> ä¸ºé‡åŒ–çº§åˆ«æ•°ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šå……åˆ†åˆ©ç”¨æ•´ä¸ªé‡åŒ–èŒƒå›´ï¼Œç²¾åº¦æ›´é«˜ï¼Œä½†éœ€è¦é¢å¤–å­˜å‚¨é›¶ç‚¹ã€‚</li>
</ul>
<p><strong>ä¼˜ç‚¹</strong>ï¼šæ›´å……åˆ†åˆ©ç”¨åŠ¨æ€èŒƒå›´
<strong>ç¼ºç‚¹</strong>ï¼šéœ€è¦é¢å¤–å­˜å‚¨é›¶ç‚¹</p>
<h3>é‡åŒ–ç²’åº¦</h3>
<table>
<thead>
<tr>
<th>ç²’åº¦</th>
<th>è¯´æ˜</th>
<th>å‚æ•°é‡</th>
</tr>
</thead>
<tbody>
<tr>
<td>Per-tensor</td>
<td>æ•´ä¸ªå¼ é‡ä¸€ä¸ª scale</td>
<td>æœ€å°‘</td>
</tr>
<tr>
<td>Per-channel</td>
<td>æ¯ä¸ªé€šé“ä¸€ä¸ª scale</td>
<td>ä¸­ç­‰</td>
</tr>
<tr>
<td>Per-group</td>
<td>æ¯ç»„å…ƒç´ ä¸€ä¸ª scale</td>
<td>è¾ƒå¤š</td>
</tr>
</tbody>
</table>
<h2>GPTQ</h2>
<h3>åŸç†</h3>
<p>GPTQ (Frantar et al., 2023) åŸºäº Optimal Brain Quantizationï¼Œé€å±‚é‡åŒ–æƒé‡ï¼š</p>
<p><strong>ç›®æ ‡</strong>ï¼šæ‰¾åˆ°é‡åŒ–æƒé‡ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9468em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9468em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span><span style="top:-3.2523em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">^</span></span></span></span></span></span></span></span></span></span>ï¼Œä½¿å¾—è¾“å‡ºè¯¯å·®æœ€å°ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.6787em;vertical-align:-0.9287em;"></span><span class="mop">ar<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6679em;"><span style="top:-2.1713em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord accent mtight"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9468em;"><span style="top:-2.7em;"><span class="pstrut" style="height:2.7em;"></span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">W</span></span><span style="top:-2.9523em;"><span class="pstrut" style="height:2.7em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord mtight">^</span></span></span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">min</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.9287em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">âˆ¥</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.1968em;vertical-align:-0.25em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9468em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span><span style="top:-3.2523em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">^</span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mord"><span class="mord">âˆ¥</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><a id="formula-quantization-7"></a>
<a href="#formula-quantization-7-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šå¯»æ‰¾é‡åŒ–åçš„ï¿½ï¿½ï¿½é‡ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9468em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9468em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span><span style="top:-3.2523em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">^</span></span></span></span></span></span></span></span></span></span>ï¼Œä½¿å…¶è¾“å‡ºä¸åŸå§‹æƒé‡ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span></span></span> çš„è¾“å‡ºå°½å¯èƒ½æ¥è¿‘ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span></span></span> ä¸ºåŸå§‹æƒé‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9468em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9468em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span><span style="top:-3.2523em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">^</span></span></span></span></span></span></span></span></span></span> ä¸ºé‡åŒ–åæƒé‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span> ä¸ºè¾“å…¥æ¿€æ´»ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">âˆ¥</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord">âˆ¥</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span> ä¸º L2 èŒƒæ•°å¹³æ–¹ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šç›´æ¥ä¼˜åŒ–ä»»åŠ¡ç›¸å…³è¯¯å·®ï¼ˆè¾“å‡ºå·®å¼‚ï¼‰ï¼Œè€Œéå•çº¯çš„æƒé‡è¯¯å·®ã€‚</li>
</ul>
<h3>ç®—æ³•æµç¨‹</h3>
<p>å¯¹äºæƒé‡çŸ©é˜µçš„æ¯ä¸€åˆ— <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>ï¼š</p>
<ol>
<li><strong>é‡åŒ–</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1667em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></li>
<li><strong>è®¡ç®—è¯¯å·®</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03785em;">Î´</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0379em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1667em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></li>
<li><strong>æ›´æ–°æœªé‡åŒ–çš„æƒé‡</strong>ï¼š
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0385em;vertical-align:-0.3552em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">[</span><span class="mrel mtight">:</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â†</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0385em;vertical-align:-0.3552em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">[</span><span class="mrel mtight">:</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:2.5765em;vertical-align:-0.99em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5865em;"><span style="top:-2.2869em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8231em;"><span style="top:-2.4231em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.0448em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2769em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">Ïµ</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.7452em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03785em;">Î´</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0379em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4413em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">[</span><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.99em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></li>
</ol>
<p><a id="formula-quantization-8"></a>
<a href="#formula-quantization-8-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šå°†å½“å‰åˆ—çš„é‡åŒ–è¯¯å·®é€šè¿‡ Hessian é€†çŸ©é˜µä¼ æ’­åˆ°åç»­æœªé‡åŒ–çš„åˆ—ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03785em;">Î´</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0379em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºç¬¬ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> åˆ—çš„é‡åŒ–è¯¯å·®ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1965em;vertical-align:-0.3552em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4413em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">[</span><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºæ¿€æ´»åæ–¹å·®ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">Ïµ</span></span></span></span> ä¸ºæ•°å€¼ç¨³å®šæ€§å¸¸æ•°ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šç”¨åç»­åˆ—çš„è°ƒæ•´æ¥è¡¥å¿å½“å‰åˆ—é‡åŒ–å¸¦æ¥çš„è¾“å‡ºè¯¯å·®ã€‚</li>
</ul>
<h3>å®ç°</h3>
<pre class="hljs"><code><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> AutoModelForCausalLM
<span class="hljs-keyword">from</span> auto_gptq <span class="hljs-keyword">import</span> AutoGPTQForCausalLM, BaseQuantizeConfig

<span class="hljs-comment"># é‡åŒ–é…ç½®</span>
quantize_config = BaseQuantizeConfig(
    bits=<span class="hljs-number">4</span>,              <span class="hljs-comment"># ç›®æ ‡ä½å®½</span>
    group_size=<span class="hljs-number">128</span>,      <span class="hljs-comment"># åˆ†ç»„å¤§å°</span>
    desc_act=<span class="hljs-literal">True</span>,       <span class="hljs-comment"># æ¿€æ´»æ„ŸçŸ¥</span>
)

<span class="hljs-comment"># åŠ è½½å¹¶é‡åŒ–æ¨¡å‹</span>
model = AutoGPTQForCausalLM.from_quantized(
    model_name,
    quantize_config=quantize_config
)
</code></pre>
<h3>ç‰¹ç‚¹</h3>
<ul>
<li><strong>ç¦»çº¿é‡åŒ–</strong>ï¼šé‡åŒ–åæ— éœ€æ ¡å‡†</li>
<li><strong>é«˜å‹ç¼©ç‡</strong>ï¼š4-bit å¯è¾¾åŸå§‹å¤§å°çš„ 1/4</li>
<li><strong>ç²¾åº¦ä¿æŒ</strong>ï¼šåœ¨å¤§å¤šæ•°ä»»åŠ¡ä¸ŠæŸå¤± &lt; 1%</li>
</ul>
<h2>AWQ</h2>
<h3>åŸç†</h3>
<p>AWQ (Lin et al., 2023) å‘ç°ï¼š<strong>åªæœ‰ 1% çš„æƒé‡å¯¹æ¨¡å‹è¾“å‡ºå½±å“æœ€å¤§</strong>ã€‚</p>
<p><strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼š</p>
<ol>
<li>åˆ†æå“ªäº›æƒé‡&quot;æ›´é‡è¦&quot;ï¼ˆåŸºäºæ¿€æ´»å€¼å¤§å°ï¼‰</li>
<li>å¯¹é‡è¦æƒé‡ä¿æŒæ›´é«˜ç²¾åº¦</li>
<li>å¯¹å…¶ä»–æƒé‡æ¿€è¿›é‡åŒ–</li>
</ol>
<h3>ç®—æ³•</h3>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9468em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9468em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span><span style="top:-3.2523em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">^</span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">s</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8641em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><a id="formula-quantization-9"></a>
<a href="#formula-quantization-9-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šå…ˆå¯¹æƒé‡åšç¼©æ”¾ï¼Œé‡åŒ–åå†é€†å‘ç¼©æ”¾ï¼Œä½¿é‡è¦æƒé‡è·å¾—æ›´é«˜ç²¾åº¦ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span></span></span> ä¸ºåŸå§‹æƒé‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">s</span></span></span></span> ä¸ºæ¯é€šé“ç¼©æ”¾å› å­ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord">â‹…</span><span class="mclose">)</span></span></span></span> ä¸ºé‡åŒ–å‡½æ•°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span> ä¸ºé€å…ƒç´ é™¤æ³•ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šç¼©æ”¾åé‡è¦æƒé‡çš„å€¼åŸŸæ‰©å¤§ï¼Œï¿½ï¿½åŒ–æ—¶è¢«åˆ†é…æ›´å¤šé‡åŒ–çº§åˆ«ã€‚</li>
</ul>
<p>å…¶ä¸­ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">s</span></span></span></span> æ˜¯æ¯é€šé“çš„ç¼©æ”¾å› å­ï¼ŒåŸºäºæ¿€æ´»å€¼åˆ†å¸ƒè®¡ç®—ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">max</span><span class="mopen">(</span><span class="mord">âˆ£</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">âˆ£</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7144em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.0037em;">Î±</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span></span></p>
<p><a id="formula-quantization-10"></a>
<a href="#formula-quantization-10-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šç¼©æ”¾å› å­ç”±æ¿€æ´»å€¼çš„å¹…å€¼å†³å®šï¼Œæ¿€æ´»è¶Šå¤§çš„é€šé“æƒé‡è¶Šé‡è¦ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºç¬¬ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> é€šé“çš„æ¿€æ´»å€¼ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span></span></span></span> ä¸ºè°ƒèŠ‚å¹‚æ¬¡ï¼ˆé€šå¸¸æ¥è¿‘ 1ï¼‰ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šæ¿€æ´»å¤§çš„é€šé“å¯¹è¾“å‡ºå½±å“æ›´å¤§ï¼Œåº”ä¿ç•™æ›´é«˜ç²¾åº¦çš„æƒé‡ã€‚</li>
</ul>
<h3>å®ç°</h3>
<pre class="hljs"><code><span class="hljs-keyword">from</span> awq <span class="hljs-keyword">import</span> AutoAWQForCausalLM

<span class="hljs-comment"># åŠ è½½æ¨¡å‹</span>
model = AutoAWQForCausalLM.from_pretrained(model_name)

<span class="hljs-comment"># é‡åŒ–é…ç½®</span>
quant_config = {
    <span class="hljs-string">&quot;zero_point&quot;</span>: <span class="hljs-literal">True</span>,
    <span class="hljs-string">&quot;q_group_size&quot;</span>: <span class="hljs-number">128</span>,
    <span class="hljs-string">&quot;w_bit&quot;</span>: <span class="hljs-number">4</span>
}

<span class="hljs-comment"># é‡åŒ–ï¼ˆéœ€è¦æ ¡å‡†æ•°æ®ï¼‰</span>
model.quantize(
    tokenizer,
    quant_config=quant_config,
    calib_data=calibration_data
)
</code></pre>
<h2>GGUF</h2>
<h3>ç‰¹ç‚¹</h3>
<p>GGUF æ˜¯ llama.cpp ä½¿ç”¨çš„é‡åŒ–æ ¼å¼ï¼š</p>
<table>
<thead>
<tr>
<th>é‡åŒ–ç±»å‹</th>
<th>è¯´æ˜</th>
<th>å‹ç¼©æ¯”</th>
</tr>
</thead>
<tbody>
<tr>
<td>Q4_0</td>
<td>4-bitï¼Œæ— é¢å¤–ç¼©æ”¾</td>
<td>~4x</td>
</tr>
<tr>
<td>Q4_K_M</td>
<td>4-bitï¼ŒK-é‡åŒ–ï¼Œä¸­ç­‰</td>
<td>~4x</td>
</tr>
<tr>
<td>Q5_K_M</td>
<td>5-bitï¼ŒK-é‡åŒ–ï¼Œä¸­ç­‰</td>
<td>~3x</td>
</tr>
<tr>
<td>Q8_0</td>
<td>8-bitï¼Œæ— é¢å¤–ç¼©æ”¾</td>
<td>~2x</td>
</tr>
</tbody>
</table>
<h3>ä½¿ç”¨</h3>
<pre class="hljs"><code><span class="hljs-comment"># ä¸‹è½½ GGUF æ¨¡å‹</span>
wget https://huggingface.co/.../model-Q4_K_M.gguf

<span class="hljs-comment"># ä½¿ç”¨ llama.cpp è¿è¡Œ</span>
./main -m model-Q4_K_M.gguf -p <span class="hljs-string">&quot;ä½ å¥½&quot;</span>
</code></pre>
<h2>ç²¾åº¦å¯¹æ¯”å®éªŒ</h2>
<h3>LLaMA-2 70B é‡åŒ–ç»“æœ</h3>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>ä½å®½</th>
<th>æ¨¡å‹å¤§å°</th>
<th>MMLU</th>
<th>Perplexity</th>
</tr>
</thead>
<tbody>
<tr>
<td>FP16</td>
<td>16</td>
<td>140 GB</td>
<td>69.8</td>
<td>3.32</td>
</tr>
<tr>
<td>GPTQ</td>
<td>4</td>
<td>35 GB</td>
<td>68.9</td>
<td>3.45</td>
</tr>
<tr>
<td>AWQ</td>
<td>4</td>
<td>35 GB</td>
<td>69.2</td>
<td>3.41</td>
</tr>
<tr>
<td>GGUF Q4_K_M</td>
<td>4</td>
<td>40 GB</td>
<td>68.5</td>
<td>3.52</td>
</tr>
</tbody>
</table>
<h3>æ¶ˆè´¹çº§æ˜¾å¡å¯ç”¨æ€§</h3>
<table>
<thead>
<tr>
<th>æ¨¡å‹</th>
<th>FP16</th>
<th>INT8</th>
<th>INT4</th>
</tr>
</thead>
<tbody>
<tr>
<td>7B</td>
<td>14 GB</td>
<td>7 GB</td>
<td>4 GB</td>
</tr>
<tr>
<td>13B</td>
<td>26 GB</td>
<td>13 GB</td>
<td>7 GB</td>
</tr>
<tr>
<td>70B</td>
<td>140 GB</td>
<td>70 GB</td>
<td>35 GB</td>
</tr>
</tbody>
</table>
<p><strong>ç»“è®º</strong>ï¼š70B æ¨¡å‹ INT4 é‡åŒ–åå¯åœ¨å•å¼  A100 40GB ä¸Šè¿è¡Œã€‚</p>
<h2>æ··åˆç²¾åº¦é‡åŒ–</h2>
<p>ä¸åŒå±‚ä½¿ç”¨ä¸åŒç²¾åº¦ï¼š</p>
<pre class="hljs"><code><span class="hljs-comment"># å…³é”®å±‚ï¼ˆå¦‚ Attentionï¼‰ä½¿ç”¨æ›´é«˜ç²¾åº¦</span>
<span class="hljs-comment"># å…¶ä»–å±‚ä½¿ç”¨è¾ƒä½ç²¾åº¦</span>

quant_config = {
    <span class="hljs-string">&quot;q_proj&quot;</span>: {<span class="hljs-string">&quot;bits&quot;</span>: <span class="hljs-number">8</span>},    <span class="hljs-comment"># æ³¨æ„åŠ›ä½¿ç”¨ 8-bit</span>
    <span class="hljs-string">&quot;k_proj&quot;</span>: {<span class="hljs-string">&quot;bits&quot;</span>: <span class="hljs-number">8</span>},
    <span class="hljs-string">&quot;v_proj&quot;</span>: {<span class="hljs-string">&quot;bits&quot;</span>: <span class="hljs-number">8</span>},
    <span class="hljs-string">&quot;o_proj&quot;</span>: {<span class="hljs-string">&quot;bits&quot;</span>: <span class="hljs-number">8</span>},
    <span class="hljs-string">&quot;gate_proj&quot;</span>: {<span class="hljs-string">&quot;bits&quot;</span>: <span class="hljs-number">4</span>},  <span class="hljs-comment"># FFN ä½¿ç”¨ 4-bit</span>
    <span class="hljs-string">&quot;up_proj&quot;</span>: {<span class="hljs-string">&quot;bits&quot;</span>: <span class="hljs-number">4</span>},
    <span class="hljs-string">&quot;down_proj&quot;</span>: {<span class="hljs-string">&quot;bits&quot;</span>: <span class="hljs-number">4</span>},
}
</code></pre>
<h2>æœ€ä½³å®è·µ</h2>
<h3>é€‰æ‹©å»ºè®®</h3>
<table>
<thead>
<tr>
<th>åœºæ™¯</th>
<th>æ¨èæ–¹æ³•</th>
</tr>
</thead>
<tbody>
<tr>
<td>GPU æ¨ç†ï¼ˆè¿½æ±‚é€Ÿåº¦ï¼‰</td>
<td>AWQ</td>
</tr>
<tr>
<td>GPU æ¨ç†ï¼ˆè¿½æ±‚ç²¾åº¦ï¼‰</td>
<td>GPTQ</td>
</tr>
<tr>
<td>CPU æ¨ç†</td>
<td>GGUF</td>
</tr>
<tr>
<td>è¾¹ç¼˜è®¾å¤‡</td>
<td>GGUF Q4_K_M</td>
</tr>
</tbody>
</table>
<h3>é‡åŒ–æµç¨‹</h3>
<ol>
<li><strong>é€‰æ‹©ç²¾åº¦</strong>ï¼šINT8ï¼ˆæ— æŸï¼‰æˆ– INT4ï¼ˆé«˜å‹ç¼©ï¼‰</li>
<li><strong>é€‰æ‹©æ–¹æ³•</strong>ï¼šAWQï¼ˆå¿«ï¼‰æˆ– GPTQï¼ˆå‡†ï¼‰</li>
<li><strong>å‡†å¤‡æ ¡å‡†æ•°æ®</strong>ï¼š~512 æ ·æœ¬</li>
<li><strong>é‡åŒ–å¹¶æµ‹è¯•</strong>ï¼šéªŒè¯å…³é”®ä»»åŠ¡æ€§èƒ½</li>
</ol>
<h2>å‚è€ƒæ–‡çŒ®</h2>
<ol>
<li>Frantar et al. (2023). <em>GPTQ: Accurate Post-Training Quantization for Generative Pre-trained Transformers</em></li>
<li>Lin et al. (2023). <em>AWQ: Activation-aware Weight Quantization for LLM Compression and Acceleration</em></li>
<li>Xiao et al. (2023). <em>SmoothQuant: Accurate and Efficient Post-Training Quantization</em></li>
</ol>
<h1>é‡åŒ–æµç¨‹å›¾è§£</h1>
<blockquote>
<p>é€šè¿‡å¯è§†åŒ–å›¾è¡¨ç†è§£æ¨¡å‹é‡åŒ–çš„å®Œæ•´å·¥ä½œæµç¨‹</p>
</blockquote>
<h2>é‡åŒ–æ ¸å¿ƒåŸç†</h2>
<p><div class="mermaid">flowchart LR
    subgraph åŸå§‹ç²¾åº¦
        A["FP16 æƒé‡&lt;br/&gt;0.123456789&lt;br/&gt;2 å­—èŠ‚/å‚æ•°"]
    end

    subgraph é‡åŒ–è¿‡ç¨‹
        B["ç¼©æ”¾ Scale&lt;br/&gt;s = max|W| / 2^(b-1)"]
        C["èˆå…¥ Round&lt;br/&gt;q = round(w/s)"]
        D["é’³ä½ Clamp&lt;br/&gt;é™åˆ¶åœ¨ [-2^(b-1), 2^(b-1)-1]"]
    end

    subgraph é‡åŒ–ç»“æœ
        E["INT4 æƒé‡&lt;br/&gt;5&lt;br/&gt;0.5 å­—èŠ‚/å‚æ•°"]
    end

    A --&gt; B --&gt; C --&gt; D --&gt; E

    style A fill:#bbdefb
    style E fill:#c8e6c9</div></p>
<h2>é‡åŒ–æ–¹æ³•å¯¹æ¯”</h2>
<p><div class="mermaid">flowchart TB
    subgraph GPTQ
        G1["é€åˆ—é‡åŒ–"] --&gt; G2["Hessian é€†æ›´æ–°"]
        G2 --&gt; G3["ç²¾åº¦é«˜ï¼Œé‡åŒ–æ…¢"]
    end

    subgraph AWQ
        A1["æ¿€æ´»æ„ŸçŸ¥"] --&gt; A2["ä¿æŠ¤é‡è¦æƒé‡"]
        A2 --&gt; A3["é€Ÿåº¦å¿«ï¼Œç²¾åº¦å¥½"]
    end

    subgraph GGUF
        GG1["CPU ä¼˜åŒ–"] --&gt; GG2["å¤šç§é‡åŒ–çº§åˆ«"]
        GG2 --&gt; GG3["é€‚åˆè¾¹ç¼˜è®¾å¤‡"]
    end

    style G3 fill:#fff9c4
    style A3 fill:#c8e6c9
    style GG3 fill:#bbdefb</div></p>
<h2>ç²¾åº¦ä¸å¤§å°å…³ç³»</h2>
<p><div class="mermaid">flowchart LR
    subgraph æ¨¡å‹å¤§å°å¯¹æ¯”["70B æ¨¡å‹"]
        FP16["FP16&lt;br/&gt;140 GB"] --&gt; INT8["INT8&lt;br/&gt;70 GB"]
        INT8 --&gt; INT4["INT4&lt;br/&gt;35 GB"]
    end

    subgraph è´¨é‡å½±å“
        Q1["FP16: åŸºå‡†"]
        Q2["INT8: ~0% æŸå¤±"]
        Q3["INT4: ~1% æŸå¤±"]
    end

    FP16 -.-&gt; Q1
    INT8 -.-&gt; Q2
    INT4 -.-&gt; Q3

    style FP16 fill:#ffcdd2
    style INT4 fill:#c8e6c9</div></p>
<h2>GPTQ é‡åŒ–æµç¨‹</h2>
<p><div class="mermaid">flowchart TB
    A[åŠ è½½é¢„è®­ç»ƒæ¨¡å‹] --&gt; B[å‡†å¤‡æ ¡å‡†æ•°æ®&lt;br/&gt;~512 æ ·æœ¬]
    B --&gt; C[é€å±‚å¤„ç†]

    subgraph æ¯å±‚å¤„ç†
        C --&gt; D[é‡åŒ–å½“å‰åˆ—&lt;br/&gt;w_i â†’ q_i]
        D --&gt; E[è®¡ç®—è¯¯å·®&lt;br/&gt;Î´ = w - q]
        E --&gt; F[æ›´æ–°åç»­åˆ—&lt;br/&gt;è¡¥å¿è¯¯å·®]
        F --&gt; G{è¿˜æœ‰åˆ—?}
        G --&gt;|æ˜¯| D
        G --&gt;|å¦| H[ä¿å­˜é‡åŒ–æ¨¡å‹]
    end

    style H fill:#c8e6c9</div></p>
<h2>AWQ é‡åŒ–æµç¨‹</h2>
<p><div class="mermaid">flowchart TB
    A[åŠ è½½é¢„è®­ç»ƒæ¨¡å‹] --&gt; B[è¿è¡Œæ ¡å‡†æ•°æ®&lt;br/&gt;è·å–æ¿€æ´»å€¼]
    B --&gt; C[åˆ†ææƒé‡é‡è¦æ€§&lt;br/&gt;åŸºäºæ¿€æ´»å€¼åˆ†å¸ƒ]
    C --&gt; D[è®¡ç®—ç¼©æ”¾å› å­&lt;br/&gt;ä¿æŠ¤é‡è¦æƒé‡]
    D --&gt; E[æ‰§è¡Œé‡åŒ–&lt;br/&gt;ç¼©æ”¾â†’é‡åŒ–â†’åç¼©æ”¾]
    E --&gt; F[ä¿å­˜é‡åŒ–æ¨¡å‹]

    style F fill:#c8e6c9</div></p>
<h2>é€‰æ‹©é‡åŒ–æ–¹æ³•å†³ç­–æ ‘</h2>
<p><div class="mermaid">flowchart TD
    Start["éœ€è¦é‡åŒ–å¤§æ¨¡å‹"] --&gt; Q1{"æ¨ç†è®¾å¤‡?"}

    Q1 --&gt;|"CPU/è¾¹ç¼˜è®¾å¤‡"| GGUF["ä½¿ç”¨ GGUF&lt;br/&gt;llama.cpp"]
    Q1 --&gt;|"GPU"| Q2{"ä¼˜å…ˆçº§?"}

    Q2 --&gt;|"é€Ÿåº¦ä¼˜å…ˆ"| AWQ["AWQ&lt;br/&gt;å¿«é€Ÿé‡åŒ–"]
    Q2 --&gt;|"ç²¾åº¦ä¼˜å…ˆ"| GPTQ["GPTQ&lt;br/&gt;é«˜ç²¾åº¦"]
    Q2 --&gt;|"å¹³è¡¡"| Q3{"æ˜¾å­˜å¤§å°?"}

    Q3 --&gt;|"&lt; 24GB"| Q4["INT4 é‡åŒ–"]
    Q3 --&gt;|"&gt;= 24GB"| Q5["INT8 æˆ–æ··åˆç²¾åº¦"]

    GGUF --&gt; Done["å¼€å§‹é‡åŒ–"]
    AWQ --&gt; Done
    GPTQ --&gt; Done
    Q4 --&gt; Done
    Q5 --&gt; Done

    style Done fill:#c8e6c9</div></p>
<h2>é‡åŒ–ç²’åº¦å¯¹æ¯”</h2>
<p><div class="mermaid">flowchart TB
    subgraph Per-Tensor["Per-Tensor (å¼ é‡çº§)"]
        T1["æ•´ä¸ªçŸ©é˜µä¸€ä¸ª scale"]
        T2["å‚æ•°å°‘ï¼Œé€Ÿåº¦å¿«"]
        T3["ç²¾åº¦æŸå¤±è¾ƒå¤§"]
    end

    subgraph Per-Channel["Per-Channel (é€šé“çº§)"]
        C1["æ¯è¡Œ/åˆ—ä¸€ä¸ª scale"]
        C2["å‚æ•°é€‚ä¸­"]
        C3["ç²¾åº¦è¾ƒå¥½"]
    end

    subgraph Per-Group["Per-Group (åˆ†ç»„çº§)"]
        G1["æ¯ç»„ 128 ä¸ªå…ƒç´ "]
        G2["å‚æ•°è¾ƒå¤š"]
        G3["ç²¾åº¦æœ€å¥½"]
    end

    style T3 fill:#ffcdd2
    style C3 fill:#fff9c4
    style G3 fill:#c8e6c9</div></p>
<h2>å›¾è§£è¯´æ˜</h2>
<h3>å…³é”®æ¦‚å¿µ</h3>
<table>
<thead>
<tr>
<th>æ¦‚å¿µ</th>
<th>è¯´æ˜</th>
<th>æ¨èå€¼</th>
</tr>
</thead>
<tbody>
<tr>
<td>ä½å®½ (bits)</td>
<td>æ¯ä¸ªå‚æ•°çš„ä½æ•°</td>
<td>4 æˆ– 8</td>
</tr>
<tr>
<td>åˆ†ç»„å¤§å°</td>
<td>Per-group çš„ç»„å¤§å°</td>
<td>128</td>
</tr>
<tr>
<td>æ ¡å‡†æ•°æ®</td>
<td>é‡åŒ–æ—¶çš„å‚è€ƒæ•°æ®</td>
<td>512 æ ·æœ¬</td>
</tr>
</tbody>
</table>
<h3>æ–¹æ³•é€‰æ‹©</h3>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>ä¼˜ç‚¹</th>
<th>ç¼ºç‚¹</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td>GPTQ</td>
<td>ç²¾åº¦é«˜</td>
<td>é‡åŒ–æ…¢</td>
<td>è¿½æ±‚ç²¾åº¦</td>
</tr>
<tr>
<td>AWQ</td>
<td>é€Ÿåº¦å¿«</td>
<td>ç•¥ä½äº GPTQ</td>
<td>ç”Ÿäº§ç¯å¢ƒ</td>
</tr>
<tr>
<td>GGUF</td>
<td>CPU å‹å¥½</td>
<td>GPU ä¸æœ€ä¼˜</td>
<td>è¾¹ç¼˜è®¾å¤‡</td>
</tr>
</tbody>
</table>
<h3>æ˜¾å­˜èŠ‚çœ</h3>
<pre class="hljs"><code>70B æ¨¡å‹:
FP16:  140 GB  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
INT8:   70 GB  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
INT4:   35 GB  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ

èŠ‚çœ 75% æ˜¾å­˜ï¼
</code></pre>
<div class="code-appendix page-break"><h2>é™„å½•ï¼šä»£ç ç¤ºä¾‹</h2><div class="code-file"><h3>awq_example.py</h3><pre class="hljs"><code><span class="hljs-string">&quot;&quot;&quot;
AWQ é‡åŒ–ç¤ºä¾‹ä»£ç 

æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ AWQ (Activation-aware Weight Quantization) è¿›è¡Œæ¨¡å‹é‡åŒ–ã€‚
AWQ æ˜¯ä¸€ç§é€Ÿåº¦å¿«ã€ç²¾åº¦é«˜çš„é‡åŒ–æ–¹æ³•ã€‚
&quot;&quot;&quot;</span>

<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> AutoTokenizer, AutoModelForCausalLM
<span class="hljs-keyword">from</span> awq <span class="hljs-keyword">import</span> AutoAWQForCausalLM

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 1. æ¨¡å‹é…ç½®</span>
<span class="hljs-comment"># ============================================</span>

model_name = <span class="hljs-string">&quot;meta-llama/Llama-2-7b-hf&quot;</span>
output_dir = <span class="hljs-string">&quot;./quantized-awq&quot;</span>

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 2. åŠ è½½æ¨¡å‹</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;åŠ è½½é¢„è®­ç»ƒæ¨¡å‹...&quot;</span>)

<span class="hljs-comment"># åŠ è½½æ¨¡å‹</span>
model = AutoAWQForCausalLM.from_pretrained(
    model_name,
    device_map=<span class="hljs-string">&quot;auto&quot;</span>,
    torch_dtype=torch.float16
)

tokenizer = AutoTokenizer.from_pretrained(model_name)
tokenizer.pad_token = tokenizer.eos_token

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 3. é…ç½®é‡åŒ–å‚æ•°</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-comment"># AWQ é‡åŒ–é…ç½®</span>
quant_config = {
    <span class="hljs-string">&quot;zero_point&quot;</span>: <span class="hljs-literal">True</span>,      <span class="hljs-comment"># ä½¿ç”¨é›¶ç‚¹ï¼ˆéå¯¹ç§°é‡åŒ–ï¼‰</span>
    <span class="hljs-string">&quot;q_group_size&quot;</span>: <span class="hljs-number">128</span>,     <span class="hljs-comment"># åˆ†ç»„å¤§å°</span>
    <span class="hljs-string">&quot;w_bit&quot;</span>: <span class="hljs-number">4</span>,              <span class="hljs-comment"># æƒé‡ä½å®½</span>
    <span class="hljs-string">&quot;version&quot;</span>: <span class="hljs-string">&quot;GEMM&quot;</span>        <span class="hljs-comment"># ä½¿ç”¨ GEMM å†…æ ¸ï¼ˆæ›´å¿«ï¼‰</span>
}

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 4. å‡†å¤‡æ ¡å‡†æ•°æ®</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;å‡†å¤‡æ ¡å‡†æ•°æ®...&quot;</span>)

<span class="hljs-comment"># AWQ éœ€è¦æ ¡å‡†æ•°æ®æ¥ç¡®å®šå“ªäº›æƒé‡æ›´é‡è¦</span>
<span class="hljs-comment"># é€šå¸¸ä½¿ç”¨ 512 ä¸ªæ ·æœ¬</span>
calibration_data = [
    <span class="hljs-string">&quot;äººå·¥æ™ºèƒ½æ­£åœ¨æ”¹å˜æˆ‘ä»¬çš„ç”Ÿæ´»æ–¹å¼ã€‚&quot;</span>,
    <span class="hljs-string">&quot;æœºå™¨å­¦ä¹ ç®—æ³•å¯ä»¥ä»æ•°æ®ä¸­å­¦ä¹ æ¨¡å¼ã€‚&quot;</span>,
    <span class="hljs-string">&quot;æ·±åº¦å­¦ä¹ ä½¿ç”¨å¤šå±‚ç¥ç»ç½‘ç»œå¤„ç†å¤æ‚ä»»åŠ¡ã€‚&quot;</span>,
    <span class="hljs-string">&quot;è‡ªç„¶è¯­è¨€å¤„ç†è®©è®¡ç®—æœºç†è§£äººç±»è¯­è¨€ã€‚&quot;</span>,
    <span class="hljs-string">&quot;è®¡ç®—æœºè§†è§‰ä½¿æœºå™¨èƒ½å¤Ÿ&#x27;çœ‹è§&#x27;ä¸–ç•Œã€‚&quot;</span>,
    <span class="hljs-comment"># ... æ·»åŠ æ›´å¤šæ ·æœ¬ (å»ºè®® 512+)</span>
]

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 5. æ‰§è¡Œé‡åŒ–</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;å¼€å§‹ AWQ é‡åŒ–...&quot;</span>)

<span class="hljs-comment"># AWQ é‡åŒ–ï¼ˆæ¯” GPTQ æ›´å¿«ï¼‰</span>
model.quantize(
    tokenizer,
    quant_config=quant_config,
    calib_data=calibration_data,
    <span class="hljs-comment"># å¯é€‰å‚æ•°</span>
    <span class="hljs-comment"># max_calib_seq_len=512,  # æ ¡å‡†åºåˆ—æœ€å¤§é•¿åº¦</span>
    <span class="hljs-comment"># max_calib_samples=512,  # æ ¡å‡†æ ·æœ¬æ•°é‡</span>
)

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 6. ä¿å­˜é‡åŒ–æ¨¡å‹</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;ä¿å­˜é‡åŒ–æ¨¡å‹åˆ° <span class="hljs-subst">{output_dir}</span>...&quot;</span>)

model.save_quantized(output_dir)
tokenizer.save_pretrained(output_dir)

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 7. åŠ è½½é‡åŒ–æ¨¡å‹æ¨ç†</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\nåŠ è½½é‡åŒ–æ¨¡å‹è¿›è¡Œæ¨ç†...&quot;</span>)

<span class="hljs-comment"># åŠ è½½é‡åŒ–æ¨¡å‹</span>
quantized_model = AutoAWQForCausalLM.from_quantized(
    output_dir,
    device_map=<span class="hljs-string">&quot;auto&quot;</span>,
    fuse_layers=<span class="hljs-literal">True</span>  <span class="hljs-comment"># èåˆå±‚ä»¥æé«˜æ¨ç†é€Ÿåº¦</span>
)

<span class="hljs-comment"># æ¨ç†æµ‹è¯•</span>
prompt = <span class="hljs-string">&quot;è¯·è§£é‡Šä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ&quot;</span>
inputs = tokenizer(prompt, return_tensors=<span class="hljs-string">&quot;pt&quot;</span>).to(quantized_model.device)

<span class="hljs-keyword">with</span> torch.no_grad():
    outputs = quantized_model.generate(
        **inputs,
        max_new_tokens=<span class="hljs-number">150</span>,
        temperature=<span class="hljs-number">0.7</span>,
        top_p=<span class="hljs-number">0.9</span>,
        do_sample=<span class="hljs-literal">True</span>
    )

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\nç”Ÿæˆçš„å›ç­”:&quot;</span>)
<span class="hljs-built_in">print</span>(tokenizer.decode(outputs[<span class="hljs-number">0</span>], skip_special_tokens=<span class="hljs-literal">True</span>))

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 8. ä¸ vLLM é›†æˆ</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-string">&quot;&quot;&quot;
AWQ é‡åŒ–çš„æ¨¡å‹å¯ä»¥ä¸ vLLM é…åˆä½¿ç”¨ä»¥è·å¾—æœ€ä½³æ¨ç†æ€§èƒ½:

from vllm import LLM, SamplingParams

llm = LLM(
    model=&quot;./quantized-awq&quot;,
    quantization=&quot;awq&quot;,
    tensor_parallel_size=1
)

sampling_params = SamplingParams(temperature=0.7, max_tokens=100)
outputs = llm.generate([&quot;ä»€ä¹ˆæ˜¯AI?&quot;], sampling_params)
&quot;&quot;&quot;</span>

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 9. æ€§èƒ½æµ‹è¯•</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">benchmark_inference</span>(<span class="hljs-params">model, tokenizer, num_iterations=<span class="hljs-number">10</span></span>):
    <span class="hljs-string">&quot;&quot;&quot;ç®€å•çš„æ¨ç†æ€§èƒ½æµ‹è¯•&quot;&quot;&quot;</span>
    <span class="hljs-keyword">import</span> time

    prompt = <span class="hljs-string">&quot;æµ‹è¯•æ€§èƒ½çš„æç¤ºè¯ã€‚&quot;</span>
    inputs = tokenizer(prompt, return_tensors=<span class="hljs-string">&quot;pt&quot;</span>).to(model.device)

    <span class="hljs-comment"># é¢„çƒ­</span>
    <span class="hljs-keyword">with</span> torch.no_grad():
        model.generate(**inputs, max_new_tokens=<span class="hljs-number">50</span>)

    <span class="hljs-comment"># è®¡æ—¶</span>
    start_time = time.time()
    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_iterations):
        <span class="hljs-keyword">with</span> torch.no_grad():
            model.generate(**inputs, max_new_tokens=<span class="hljs-number">50</span>)
    end_time = time.time()

    avg_time = (end_time - start_time) / num_iterations
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nå¹³å‡æ¨ç†æ—¶é—´: <span class="hljs-subst">{avg_time:<span class="hljs-number">.2</span>f}</span> ç§’&quot;</span>)
    <span class="hljs-keyword">return</span> avg_time

<span class="hljs-comment"># benchmark_inference(quantized_model, tokenizer)</span>

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 10. AWQ vs GPTQ å¯¹æ¯”</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-string">&quot;&quot;&quot;
AWQ vs GPTQ å¯¹æ¯”:

| ç‰¹æ€§          | AWQ              | GPTQ             |
|--------------|------------------|------------------|
| é‡åŒ–é€Ÿåº¦      | å¿« (~10åˆ†é’Ÿ)     | æ…¢ (~1å°æ—¶)      |
| æ¨ç†é€Ÿåº¦      | å¿« (èåˆå†…æ ¸)    | å¿« (ExLlama)     |
| ç²¾åº¦          | ç•¥å¥½             | å¥½               |
| æ˜¾å­˜ä½¿ç”¨      | ç›¸åŒ             | ç›¸åŒ             |
| CPUæ”¯æŒ       | æœ‰é™             | æœ‰é™             |

æ¨èé€‰æ‹©:
- è¿½æ±‚é€Ÿåº¦: AWQ
- è¿½æ±‚ç²¾åº¦: GPTQ
- ç”Ÿäº§ç¯å¢ƒ: AWQ (ä¸ vLLM é…åˆ)
&quot;&quot;&quot;</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">50</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;AWQ é‡åŒ–å®Œæˆ!&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;é‡åŒ–æ¨¡å‹ä¿å­˜åœ¨: <span class="hljs-subst">{output_dir}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">50</span>)

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># é™„å½•: ä» Hugging Face ä¸‹è½½é¢„é‡åŒ–æ¨¡å‹</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-string">&quot;&quot;&quot;
å¾ˆå¤šæ¨¡å‹å·²ç»æä¾›äº†é¢„é‡åŒ–çš„ AWQ ç‰ˆæœ¬:

from awq import AutoAWQForCausalLM

# ä¸‹è½½é¢„é‡åŒ–æ¨¡å‹
model = AutoAWQForCausalLM.from_quantized(
    &quot;TheBloke/Llama-2-7B-AWQ&quot;,
    device_map=&quot;auto&quot;
)

æ¨èçš„ AWQ æ¨¡å‹æº:
- TheBloke: https://huggingface.co/TheBloke
- CasperhAI: https://huggingface.co/casperhansen
&quot;&quot;&quot;</span>
</code></pre></div><div class="code-file"><h3>gptq_example.py</h3><pre class="hljs"><code><span class="hljs-string">&quot;&quot;&quot;
GPTQ é‡åŒ–ç¤ºä¾‹ä»£ç 

æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ GPTQ å¯¹å¤§è¯­è¨€æ¨¡å‹è¿›è¡Œ 4-bit é‡åŒ–ã€‚
GPTQ æ˜¯æœ€æµè¡Œçš„è®­ç»ƒåé‡åŒ–æ–¹æ³•ä¹‹ä¸€ã€‚
&quot;&quot;&quot;</span>

<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> AutoTokenizer
<span class="hljs-keyword">from</span> auto_gptq <span class="hljs-keyword">import</span> AutoGPTQForCausalLM, BaseQuantizeConfig

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 1. æ¨¡å‹é…ç½®</span>
<span class="hljs-comment"># ============================================</span>

model_name = <span class="hljs-string">&quot;meta-llama/Llama-2-7b-hf&quot;</span>
output_dir = <span class="hljs-string">&quot;./quantized-gptq&quot;</span>

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 2. é…ç½®é‡åŒ–å‚æ•°</span>
<span class="hljs-comment"># ============================================</span>

quantize_config = BaseQuantizeConfig(
    <span class="hljs-comment"># ç›®æ ‡ä½å®½ (4-bit æ˜¯æœ€å¸¸ç”¨çš„é€‰æ‹©)</span>
    bits=<span class="hljs-number">4</span>,

    <span class="hljs-comment"># åˆ†ç»„å¤§å° - è¶Šå°ç²¾åº¦è¶Šé«˜ï¼Œä½†æ¨¡å‹è¶Šå¤§</span>
    <span class="hljs-comment"># 128 æ˜¯å¸¸ç”¨çš„å¹³è¡¡ç‚¹</span>
    group_size=<span class="hljs-number">128</span>,

    <span class="hljs-comment"># æ˜¯å¦ä½¿ç”¨æ¿€æ´»æ„ŸçŸ¥é‡åŒ–</span>
    <span class="hljs-comment"># True å¯ä»¥æé«˜ç²¾åº¦ï¼Œä½†é‡åŒ–æ—¶é—´æ›´é•¿</span>
    desc_act=<span class="hljs-literal">True</span>,

    <span class="hljs-comment"># éå¯¹ç§°é‡åŒ– (é€šå¸¸æ›´å¥½)</span>
    sym=<span class="hljs-literal">False</span>,

    <span class="hljs-comment"># åŠ¨æ€é‡åŒ– (æŸäº›å±‚)</span>
    dynamic=<span class="hljs-literal">None</span>,

    <span class="hljs-comment"># æ˜¯å¦ä½¿ç”¨ ExLlama å†…æ ¸ (æ›´å¿«æ¨ç†)</span>
    use_exllama=<span class="hljs-literal">True</span>,
)

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 3. åŠ è½½æ¨¡å‹</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;åŠ è½½é¢„è®­ç»ƒæ¨¡å‹...&quot;</span>)

<span class="hljs-comment"># åŠ è½½æœªé‡åŒ–çš„æ¨¡å‹ç”¨äºé‡åŒ–è¿‡ç¨‹</span>
model = AutoGPTQForCausalLM.from_pretrained(
    model_name,
    quantize_config=quantize_config,
    max_memory={<span class="hljs-number">0</span>: <span class="hljs-string">&quot;24GB&quot;</span>}  <span class="hljs-comment"># é™åˆ¶ GPU æ˜¾å­˜ä½¿ç”¨</span>
)

tokenizer = AutoTokenizer.from_pretrained(model_name)

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 4. å‡†å¤‡æ ¡å‡†æ•°æ®</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;å‡†å¤‡æ ¡å‡†æ•°æ®...&quot;</span>)

<span class="hljs-comment"># GPTQ éœ€è¦æ ¡å‡†æ•°æ®æ¥è®¡ç®—æœ€ä¼˜é‡åŒ–å‚æ•°</span>
<span class="hljs-comment"># é€šå¸¸ä½¿ç”¨ 512-1024 ä¸ªæ ·æœ¬</span>
calibration_data = [
    <span class="hljs-string">&quot;äººå·¥æ™ºèƒ½æ˜¯è®¡ç®—æœºç§‘å­¦çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œå®ƒä¼å›¾äº†è§£æ™ºèƒ½çš„å®è´¨ã€‚&quot;</span>,
    <span class="hljs-string">&quot;æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„æ ¸å¿ƒï¼Œæ˜¯ä½¿è®¡ç®—æœºå…·æœ‰æ™ºèƒ½çš„æ ¹æœ¬é€”å¾„ã€‚&quot;</span>,
    <span class="hljs-string">&quot;æ·±åº¦å­¦ä¹ æ˜¯æœºå™¨å­¦ä¹ çš„ä¸€ä¸ªå­é›†ï¼Œå®ƒä½¿ç”¨å¤šå±‚ç¥ç»ç½‘ç»œæ¥å­¦ä¹ æ•°æ®è¡¨ç¤ºã€‚&quot;</span>,
    <span class="hljs-comment"># ... æ›´å¤šæ ·æœ¬</span>
]

<span class="hljs-keyword">def</span> <span class="hljs-title function_">tokenize_for_calibration</span>(<span class="hljs-params">data</span>):
    <span class="hljs-string">&quot;&quot;&quot;å°†æ ¡å‡†æ•°æ®åˆ†è¯&quot;&quot;&quot;</span>
    <span class="hljs-keyword">return</span> tokenizer(
        data,
        return_tensors=<span class="hljs-string">&quot;pt&quot;</span>,
        padding=<span class="hljs-literal">True</span>,
        truncation=<span class="hljs-literal">True</span>,
        max_length=<span class="hljs-number">512</span>
    )

<span class="hljs-comment"># é‡åŒ–æ ¡å‡†æ•°æ®</span>
calibration_examples = [tokenize_for_calibration(text) <span class="hljs-keyword">for</span> text <span class="hljs-keyword">in</span> calibration_data]

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 5. æ‰§è¡Œé‡åŒ–</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;å¼€å§‹ GPTQ é‡åŒ–ï¼ˆè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼‰...&quot;</span>)

<span class="hljs-comment"># é‡åŒ–æ¨¡å‹</span>
model.quantize(calibration_examples)

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 6. ä¿å­˜é‡åŒ–æ¨¡å‹</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;ä¿å­˜é‡åŒ–æ¨¡å‹åˆ° <span class="hljs-subst">{output_dir}</span>...&quot;</span>)

model.save_quantized(output_dir)
tokenizer.save_pretrained(output_dir)

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 7. åŠ è½½é‡åŒ–æ¨¡å‹è¿›è¡Œæ¨ç†</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\nåŠ è½½é‡åŒ–æ¨¡å‹è¿›è¡Œæ¨ç†...&quot;</span>)

<span class="hljs-comment"># åŠ è½½é‡åŒ–åçš„æ¨¡å‹</span>
quantized_model = AutoGPTQForCausalLM.from_quantized(
    output_dir,
    device_map=<span class="hljs-string">&quot;auto&quot;</span>,
    use_exllama=<span class="hljs-literal">True</span>  <span class="hljs-comment"># ä½¿ç”¨ä¼˜åŒ–çš„ ExLlama å†…æ ¸</span>
)

<span class="hljs-comment"># æ¨ç†æµ‹è¯•</span>
prompt = <span class="hljs-string">&quot;ä»€ä¹ˆæ˜¯æ·±åº¦å­¦ä¹ ï¼Ÿ&quot;</span>
inputs = tokenizer(prompt, return_tensors=<span class="hljs-string">&quot;pt&quot;</span>).to(quantized_model.device)

<span class="hljs-keyword">with</span> torch.no_grad():
    outputs = quantized_model.generate(
        **inputs,
        max_new_tokens=<span class="hljs-number">100</span>,
        temperature=<span class="hljs-number">0.7</span>,
        do_sample=<span class="hljs-literal">True</span>
    )

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\nç”Ÿæˆçš„å›ç­”:&quot;</span>)
<span class="hljs-built_in">print</span>(tokenizer.decode(outputs[<span class="hljs-number">0</span>], skip_special_tokens=<span class="hljs-literal">True</span>))

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 8. æ€§èƒ½å¯¹æ¯”</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">compare_model_sizes</span>():
    <span class="hljs-string">&quot;&quot;&quot;å¯¹æ¯”é‡åŒ–å‰åçš„æ¨¡å‹å¤§å°&quot;&quot;&quot;</span>
    <span class="hljs-keyword">import</span> os

    <span class="hljs-comment"># åŸå§‹æ¨¡å‹å¤§å°ä¼°ç®—</span>
    original_size = <span class="hljs-number">7e9</span> * <span class="hljs-number">2</span>  <span class="hljs-comment"># 7B å‚æ•° * 2 bytes (FP16)</span>

    <span class="hljs-comment"># é‡åŒ–åæ¨¡å‹å¤§å°ä¼°ç®—</span>
    quantized_size = <span class="hljs-number">7e9</span> * <span class="hljs-number">0.5</span>  <span class="hljs-comment"># 7B å‚æ•° * 0.5 bytes (INT4)</span>

    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\næ¨¡å‹å¤§å°å¯¹æ¯”:&quot;</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;åŸå§‹ (FP16): <span class="hljs-subst">{original_size / <span class="hljs-number">1e9</span>:<span class="hljs-number">.1</span>f}</span> GB&quot;</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;é‡åŒ– (INT4): <span class="hljs-subst">{quantized_size / <span class="hljs-number">1e9</span>:<span class="hljs-number">.1</span>f}</span> GB&quot;</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;å‹ç¼©æ¯”: <span class="hljs-subst">{original_size / quantized_size:<span class="hljs-number">.1</span>f}</span>x&quot;</span>)

compare_model_sizes()

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 9. ä¸ Transformers é›†æˆ</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-string">&quot;&quot;&quot;
ä¹Ÿå¯ä»¥ä½¿ç”¨ transformers çš„åŸç”Ÿæ¥å£åŠ è½½ GPTQ æ¨¡å‹:

from transformers import AutoModelForCausalLM

model = AutoModelForCausalLM.from_pretrained(
    &quot;TheBloke/Llama-2-7B-GPTQ&quot;,
    device_map=&quot;auto&quot;,
    torch_dtype=torch.float16,
    revision=&quot;gptq-4bit-128g&quot;
)
&quot;&quot;&quot;</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">50</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;GPTQ é‡åŒ–å®Œæˆ!&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;é‡åŒ–æ¨¡å‹ä¿å­˜åœ¨: <span class="hljs-subst">{output_dir}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">50</span>)
</code></pre></div></div></div><div class="chapter"><h1>ç¬¬12ç«  Inference Acceleration æ¨ç†åŠ é€Ÿ</h1><h1>æ¨ç†åŠ é€Ÿç§‘æ™®ç‰ˆ</h1>
<blockquote>
<p>é¢å‘é›¶åŸºç¡€è¯»è€…çš„æ¨ç†åŠ é€Ÿå…¥é—¨æŒ‡å—</p>
</blockquote>
<h2>ä¸€å¥è¯æ¦‚æ‹¬</h2>
<p><strong>æ¨ç†åŠ é€Ÿå°±æ˜¯è®©å¤§æ¨¡å‹&quot;è·‘å¾—æ›´å¿«&quot;ï¼Œç”¨å„ç§æŠ€å·§è®©å®ƒç”Ÿæˆç­”æ¡ˆçš„æ—¶é—´å¤§å¤§ç¼©çŸ­ã€‚</strong></p>
<h2>ä»ä¸€ä¸ªé—®é¢˜å¼€å§‹</h2>
<p>ä½ ç”¨è¿‡å¤§æ¨¡å‹å§ï¼Ÿæœ‰æ²¡æœ‰é‡åˆ°è¿‡ï¼š</p>
<ul>
<li>é—®ä¸€ä¸ªé—®é¢˜ï¼Œç­‰äº†å¥½å‡ ç§’æ‰å¼€å§‹å›ç­”</li>
<li>ç”Ÿæˆä¸€æ®µè¯ï¼Œåƒ&quot;æŒ¤ç‰™è†&quot;ä¸€æ ·æ…¢æ…¢å‡ºæ¥</li>
<li>å¤šäººåŒæ—¶ç”¨ï¼Œç³»ç»Ÿå°±å¡ä½äº†</li>
</ul>
<p>è¿™å°±æ˜¯<strong>æ¨ç†é€Ÿåº¦</strong>çš„é—®é¢˜ã€‚æ¨ç†åŠ é€Ÿå°±æ˜¯è¦è§£å†³è¿™äº›é—®é¢˜ï¼</p>
<h2>ä»€ä¹ˆæ˜¯æ¨ç†ï¼Ÿ</h2>
<p><strong>æ¨ç†</strong>å°±æ˜¯æ¨¡å‹&quot;æ€è€ƒ&quot;å¹¶ç”Ÿæˆç­”æ¡ˆçš„è¿‡ç¨‹ï¼š</p>
<pre class="hljs"><code>ç”¨æˆ·æé—® â†’ æ¨¡å‹å¤„ç† â†’ ç”Ÿæˆç­”æ¡ˆ
                â†‘
            è¿™å°±æ˜¯æ¨ç†
</code></pre>
<h3>æ¨ç†ä¸ºä»€ä¹ˆæ…¢ï¼Ÿ</h3>
<table>
<thead>
<tr>
<th>åŸå› </th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ¨¡å‹å¤ªå¤§</td>
<td>70 äº¿å‚æ•°ï¼Œæ¯æ¬¡è®¡ç®—é‡å·¨å¤§</td>
</tr>
<tr>
<td>é€å­—ç”Ÿæˆ</td>
<td>æ¯ä¸ªå­—éƒ½è¦é‡æ–°è®¡ç®—ä¸€é</td>
</tr>
<tr>
<td>å†…å­˜ç“¶é¢ˆ</td>
<td>æ•°æ®æ¬è¿æ¯”è®¡ç®—è¿˜æ…¢</td>
</tr>
<tr>
<td>ä¸²è¡Œå¤„ç†</td>
<td>å¤šä¸ªè¯·æ±‚æ’é˜Ÿç­‰å¾…</td>
</tr>
</tbody>
</table>
<h2>æ¨ç†åŠ é€Ÿçš„æ ¸å¿ƒæŠ€æœ¯</h2>
<h3>1. æ‰¹å¤„ç†ï¼ˆBatchingï¼‰</h3>
<p>æŠŠå¤šä¸ªè¯·æ±‚æ‰“åŒ…ä¸€èµ·å¤„ç†ï¼š</p>
<pre class="hljs"><code>ä¸²è¡Œ: è¯·æ±‚1 â†’ è¯·æ±‚2 â†’ è¯·æ±‚3 â†’ è¯·æ±‚4
      (4ä¸ªæ—¶é—´å•ä½)

æ‰¹å¤„ç†: [è¯·æ±‚1, è¯·æ±‚2, è¯·æ±‚3, è¯·æ±‚4] ä¸€èµ·å¤„ç†
      (1ä¸ªæ—¶é—´å•ä½)
</code></pre>
<h3>2. KV Cacheï¼ˆç¼“å­˜ï¼‰</h3>
<p><strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼šä¸è¦é‡å¤è®¡ç®—å·²ç»ç®—è¿‡çš„ä¸œè¥¿ã€‚</p>
<pre class="hljs"><code>ç”Ÿæˆç¬¬1ä¸ªå­—: è®¡ç®— A, B, C â†’ è¾“å‡º&quot;ä½ &quot;
ç”Ÿæˆç¬¬2ä¸ªå­—: ä¸éœ€è¦é‡æ–°ç®— A, B, Cï¼
            åªéœ€è¦ç”¨ç¼“å­˜ + è®¡ç®—æ–°å†…å®¹ â†’ è¾“å‡º&quot;å¥½&quot;
</code></pre>
<p>è¿™å°±åƒä½ èƒŒä¹¦ï¼šç¬¬ä¸€éè®¤çœŸè¯»ï¼Œåé¢åªéœ€è¦&quot;å›å¿†&quot;å°±è¡Œäº†ã€‚</p>
<h3>3. è¿ç»­æ‰¹å¤„ç†ï¼ˆContinuous Batchingï¼‰</h3>
<p>ä¼ ç»Ÿæ‰¹å¤„ç†è¦ç­‰æœ€æ…¢çš„è¯·æ±‚å®Œæˆã€‚è¿ç»­æ‰¹å¤„ç†ï¼š</p>
<ul>
<li>æ–°è¯·æ±‚æ¥äº†å°±åŠ å…¥</li>
<li>å®Œæˆçš„è¯·æ±‚å°±é€€å‡º</li>
<li>ä¸æµªè´¹ä»»ä½•è®¡ç®—èµ„æº</li>
</ul>
<h3>4. æ³¨æ„åŠ›ä¼˜åŒ–</h3>
<p>æ³¨æ„åŠ›æœºåˆ¶æ˜¯ Transformer çš„æ ¸å¿ƒï¼Œä½†è®¡ç®—é‡å·¨å¤§ã€‚</p>
<p>ä¼˜åŒ–æ–¹æ³•ï¼š</p>
<ul>
<li><strong>Flash Attention</strong>ï¼šä¼˜åŒ–å†…å­˜è®¿é—®ï¼Œé€Ÿåº¦æå‡ 2-4 å€</li>
<li><strong>PagedAttention</strong>ï¼šåƒæ“ä½œç³»ç»Ÿç®¡ç†å†…å­˜ä¸€æ ·ç®¡ç† KV Cache</li>
</ul>
<h2>ä¸»æµæ¨ç†æ¡†æ¶</h2>
<h3>vLLM</h3>
<p><strong>æœ€æµè¡Œçš„æ¨ç†åŠ é€Ÿæ¡†æ¶</strong></p>
<ul>
<li>ä½¿ç”¨ PagedAttention</li>
<li>ååé‡æå‡ 10-20 å€</li>
<li>æ”¯æŒå¤šç§æ¨¡å‹</li>
</ul>
<h3>TensorRT-LLM</h3>
<p><strong>NVIDIA å®˜æ–¹æ–¹æ¡ˆ</strong></p>
<ul>
<li>é’ˆå¯¹ NVIDIA GPU ä¼˜åŒ–</li>
<li>æè‡´çš„æ€§èƒ½</li>
<li>é…ç½®ç›¸å¯¹å¤æ‚</li>
</ul>
<h3>llama.cpp</h3>
<p><strong>CPU æ¨ç†ä¹‹ç‹</strong></p>
<ul>
<li>å¯ä»¥åœ¨æ²¡æœ‰ GPU çš„æœºå™¨ä¸Šè¿è¡Œ</li>
<li>æ”¯æŒ Apple Silicon</li>
<li>è½»é‡çº§éƒ¨ç½²</li>
</ul>
<h2>å®é™…æ•ˆæœå¯¹æ¯”</h2>
<table>
<thead>
<tr>
<th>åœºæ™¯</th>
<th>ä¼˜åŒ–å‰</th>
<th>ä¼˜åŒ–å (vLLM)</th>
</tr>
</thead>
<tbody>
<tr>
<td>å•è¯·æ±‚å»¶è¿Ÿ</td>
<td>2 ç§’</td>
<td>1.5 ç§’</td>
</tr>
<tr>
<td>å¹¶å‘ 10 è¯·æ±‚</td>
<td>20 ç§’</td>
<td>3 ç§’</td>
</tr>
<tr>
<td>ååé‡ (tokens/s)</td>
<td>50</td>
<td>500</td>
</tr>
</tbody>
</table>
<h2>ä½ éœ€è¦è®°ä½çš„</h2>
<table>
<thead>
<tr>
<th>æ¦‚å¿µ</th>
<th>é€šä¿—ç†è§£</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ¨ç†</td>
<td>æ¨¡å‹ç”Ÿæˆç­”æ¡ˆçš„è¿‡ç¨‹</td>
</tr>
<tr>
<td>æ‰¹å¤„ç†</td>
<td>å¤šä¸ªè¯·æ±‚ä¸€èµ·å¤„ç†</td>
</tr>
<tr>
<td>KV Cache</td>
<td>ç¼“å­˜ä¸­é—´ç»“æœï¼Œé¿å…é‡å¤è®¡ç®—</td>
</tr>
<tr>
<td>vLLM</td>
<td>æœ€æµè¡Œçš„æ¨ç†åŠ é€Ÿæ¡†æ¶</td>
</tr>
</tbody>
</table>
<h2>ä¸‹ä¸€æ­¥</h2>
<ul>
<li>æƒ³äº†è§£æŠ€æœ¯ç»†èŠ‚ï¼Ÿé˜…è¯» <a href="advanced-guide.md">æ·±å…¥ç‰ˆ</a></li>
<li>æƒ³çœ‹ä»£ç å®ç°ï¼ŸæŸ¥çœ‹ <code>examples/</code> ç›®å½•</li>
<li>æƒ³çœ‹æµç¨‹å›¾ï¼ŸæŸ¥çœ‹ <a href="diagram.md">æµç¨‹å›¾è§£</a></li>
</ul>
<h1>æ¨ç†åŠ é€Ÿæ·±å…¥ç‰ˆ</h1>
<blockquote>
<p>é¢å‘æœ‰æœºå™¨å­¦ä¹ åŸºç¡€è¯»è€…çš„æŠ€æœ¯è¯¦è§£</p>
</blockquote>
<h2>æ¦‚è¿°</h2>
<p>LLM æ¨ç†çš„æ ¸å¿ƒæŒ‘æˆ˜ï¼š</p>
<ol>
<li><strong>å†…å­˜å¸¦å®½ç“¶é¢ˆ</strong>ï¼šæ¨¡å‹å‚æ•°å’Œ KV Cache çš„ä¼ è¾“æ¯”è®¡ç®—æ›´æ…¢</li>
<li><strong>è‡ªå›å½’ç”Ÿæˆ</strong>ï¼šæ¯ä¸ª token éƒ½éœ€è¦å®Œæ•´å‰å‘ä¼ æ’­</li>
<li><strong>åŠ¨æ€é•¿åº¦</strong>ï¼šä¸åŒè¯·æ±‚çš„ç”Ÿæˆé•¿åº¦ä¸åŒï¼Œéš¾ä»¥æ‰¹å¤„ç†</li>
</ol>
<h2>KV Cache è¯¦è§£</h2>
<h3>åŸç†</h3>
<p>åœ¨è‡ªå›å½’ç”Ÿæˆä¸­ï¼Œè®¡ç®—ç¬¬ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span> ä¸ª token çš„æ³¨æ„åŠ›ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Attention</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><a id="formula-inference-acceleration-1"></a>
<a href="#formula-inference-acceleration-1-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šç”Ÿæˆç¬¬ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span> ä¸ª token æ—¶ï¼Œéœ€è¦å½“å‰æŸ¥è¯¢ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸æ‰€æœ‰å†å²é”®å€¼ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> è®¡ç®—æ³¨æ„åŠ›ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºå½“å‰ä½ç½®çš„æŸ¥è¯¢å‘é‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºä»ä½ç½® 1 åˆ° <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span> çš„é”®å€¼åºåˆ—ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šæ¯ç”Ÿæˆä¸€ä¸ª token éƒ½è¦&quot;çœ‹&quot;ä¹‹å‰æ‰€æœ‰ä½ç½®ï¼Œè®¡ç®—é‡éšé•¿åº¦çº¿æ€§å¢é•¿ã€‚</li>
</ul>
<p>KV Cache å­˜å‚¨ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8917em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight">t</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span></span></span></span> å’Œ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8917em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight">t</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span></span></span></span>ï¼Œé¿å…é‡å¤è®¡ç®—ã€‚</p>
<h3>å†…å­˜éœ€æ±‚</h3>
<p>å¯¹äº <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">L</span></span></span></span> å±‚ã€<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">h</span></span></span></span> å¤´ã€<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ç»´åº¦ã€åºåˆ—é•¿åº¦ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">s</span></span></span></span>ï¼š</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord">KVÂ Cache</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">bytes</span></span></span></span></span></span></p>
<p><a id="formula-inference-acceleration-2"></a>
<a href="#formula-inference-acceleration-2-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šKV Cache å¤§å°ä¸å±‚æ•°ã€å¤´æ•°ã€æ¯å¤´ç»´åº¦ã€åºåˆ—é•¿åº¦æˆæ­£æ¯”ã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">L</span></span></span></span> ä¸ºå±‚æ•°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">h</span></span></span></span> ä¸ºæ³¨æ„åŠ›å¤´æ•°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºæ¯å¤´ç»´åº¦ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">s</span></span></span></span> ä¸ºåºåˆ—é•¿åº¦ï¼›bytes ä¸ºæ¯ä¸ªæ•°å€¼çš„å­—èŠ‚æ•°ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šåºåˆ—è¶Šé•¿ç¼“å­˜è¶Šå¤§ï¼Œæ˜¯é•¿ä¸Šä¸‹æ–‡æ¨ç†çš„ä¸»è¦å†…å­˜ç“¶é¢ˆï¼›2 è¡¨ç¤º K å’Œ V ä¸¤ä»½ç¼“å­˜ã€‚</li>
</ul>
<p><strong>ç¤ºä¾‹</strong>ï¼ˆLLaMA-2 70B, FP16ï¼‰ï¼š</p>
<ul>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">80</span></span></span></span>, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">64</span></span></span></span>, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">128</span></span></span></span></li>
<li>åºåˆ—é•¿åº¦ 2048ï¼š~40GB KV Cache</li>
<li>åºåˆ—é•¿åº¦ 4096ï¼š~80GB KV Cache</li>
</ul>
<h3>PagedAttention</h3>
<p>vLLM çš„æ ¸å¿ƒåˆ›æ–°ï¼Œå°† KV Cache åˆ†é¡µç®¡ç†ï¼š</p>
<pre class="hljs"><code>ä¼ ç»Ÿæ–¹å¼:
è¯·æ±‚1: [è¿ç»­å¤§å—å†…å­˜]
è¯·æ±‚2: [è¿ç»­å¤§å—å†…å­˜] â†’ é¢„ç•™æœ€å¤§é•¿åº¦ï¼Œæµªè´¹ä¸¥é‡

PagedAttention:
è¯·æ±‚1: [é¡µ1][é¡µ3][é¡µ5]... æŒ‰éœ€åˆ†é…
è¯·æ±‚2: [é¡µ2][é¡µ4]...
</code></pre>
<p><strong>ä¼˜åŠ¿</strong>ï¼š</p>
<ul>
<li>å†…å­˜åˆ©ç”¨ç‡ä» ~50% æå‡åˆ° ~95%</li>
<li>æ”¯æŒæ›´é•¿ä¸Šä¸‹æ–‡</li>
<li>å‡å°‘å†…å­˜ç¢ç‰‡</li>
</ul>
<h2>è¿ç»­æ‰¹å¤„ç†ï¼ˆContinuous Batchingï¼‰</h2>
<h3>é™æ€æ‰¹å¤„ç†é—®é¢˜</h3>
<pre class="hljs"><code><span class="hljs-comment"># ä¼ ç»Ÿæ‰¹å¤„ç†</span>
batch = [req1, req2, req3]  <span class="hljs-comment"># é•¿åº¦: 50, 100, 20 tokens</span>

<span class="hljs-comment"># ç­‰å¾…æœ€é•¿è¯·æ±‚å®Œæˆ</span>
<span class="hljs-comment"># req3 ç”Ÿæˆ 20 tokens åå°±ç©ºé—²äº†ï¼Œä½†è¦ç­‰ req2</span>
</code></pre>
<h3>è¿ç»­æ‰¹å¤„ç†</h3>
<pre class="hljs"><code><span class="hljs-comment"># è¿­ä»£çº§è°ƒåº¦</span>
iteration_1: [req1, req2, req3]  <span class="hljs-comment"># éƒ½åœ¨ç”Ÿæˆ</span>
iteration_2: [req1, req2, req3]  <span class="hljs-comment"># ...</span>
iteration_3: [req1, req2]        <span class="hljs-comment"># req3 å®Œæˆï¼Œé€€å‡º</span>
iteration_4: [req1, req4]        <span class="hljs-comment"># æ–°è¯·æ±‚ req4 åŠ å…¥</span>
</code></pre>
<p><strong>ååé‡æå‡</strong>ï¼š2-4x</p>
<h2>Flash Attention</h2>
<h3>æ ‡å‡†æ³¨æ„åŠ›</h3>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Attention</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4684em;vertical-align:-0.95em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.1778em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9322em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord mathnormal">d</span></span></span><span style="top:-2.8922em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1078em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span></p>
<p><a id="formula-inference-acceleration-3"></a>
<a href="#formula-inference-acceleration-3-detail">ğŸ“– æŸ¥çœ‹å…¬å¼é™„å½•è¯¦è§£</a></p>
<p><strong>å…¬å¼è§£é‡Š</strong></p>
<ul>
<li><strong>å…¬å¼å«ä¹‰</strong>ï¼šè®¡ç®— Q ä¸ K çš„ç›¸ä¼¼åº¦ï¼Œç¼©æ”¾å softmax å¾—åˆ°æƒé‡ï¼Œå†å¯¹ V åŠ æƒæ±‚å’Œã€‚</li>
<li><strong>å˜é‡è¯´æ˜</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span> ä¸ºæŸ¥è¯¢ã€é”®ã€å€¼çŸ©é˜µï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span> ä¸ºé”®ç»´åº¦ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.04em;vertical-align:-0.1078em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9322em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord mathnormal">d</span></span></span><span style="top:-2.8922em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1078em;"><span></span></span></span></span></span></span></span></span> ä¸ºç¼©æ”¾å› å­ã€‚</li>
<li><strong>ç›´è§‰/ä½œç”¨</strong>ï¼šæ ¸å¿ƒæ³¨æ„åŠ›å…¬å¼ï¼Œä½†éœ€è¦å­˜å‚¨ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> çš„æ³¨æ„åŠ›çŸ©é˜µï¼Œå†…å­˜å¼€é”€å¤§ã€‚</li>
</ul>
<p>é—®é¢˜ï¼š</p>
<ul>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> å†…å­˜ï¼ˆ<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> çš„æ³¨æ„åŠ›çŸ©é˜µï¼‰</li>
<li>å¤šæ¬¡ HBM è®¿é—®</li>
</ul>
<h3>Flash Attention ä¼˜åŒ–</h3>
<p><strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼šåˆ†å—è®¡ç®—ï¼Œé¿å…å­˜å‚¨å®Œæ•´æ³¨æ„åŠ›çŸ©é˜µ</p>
<pre class="hljs"><code><span class="hljs-comment"># ä¼ªä»£ç </span>
<span class="hljs-keyword">for</span> block_q <span class="hljs-keyword">in</span> Q:
    <span class="hljs-keyword">for</span> block_k, block_v <span class="hljs-keyword">in</span> K, V:
        <span class="hljs-comment"># åœ¨ SRAM ä¸­è®¡ç®—</span>
        local_attention = block_q @ block_k.T
        local_output = local_attention @ block_v
        <span class="hljs-comment"># ç´¯åŠ åˆ°å…¨å±€è¾“å‡º</span>
</code></pre>
<p><strong>æ€§èƒ½</strong>ï¼š</p>
<ul>
<li>å†…å­˜ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span> è€Œé <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></li>
<li>é€Ÿåº¦ï¼š2-4x åŠ é€Ÿï¼ˆå‡å°‘ HBM è®¿é—®ï¼‰</li>
</ul>
<h2>ä¸»æµæ¡†æ¶å¯¹æ¯”</h2>
<h3>vLLM</h3>
<pre class="hljs"><code><span class="hljs-keyword">from</span> vllm <span class="hljs-keyword">import</span> LLM, SamplingParams

llm = LLM(model=<span class="hljs-string">&quot;meta-llama/Llama-2-7b-hf&quot;</span>)
params = SamplingParams(max_tokens=<span class="hljs-number">100</span>, temperature=<span class="hljs-number">0.7</span>)

outputs = llm.generate([<span class="hljs-string">&quot;Hello&quot;</span>, <span class="hljs-string">&quot;Hi there&quot;</span>], params)
</code></pre>
<p><strong>ç‰¹ç‚¹</strong>ï¼š</p>
<ul>
<li>PagedAttention</li>
<li>è¿ç»­æ‰¹å¤„ç†</li>
<li>ä¼˜åŒ–çš„ CUDA å†…æ ¸</li>
</ul>
<h3>TensorRT-LLM</h3>
<pre class="hljs"><code><span class="hljs-keyword">import</span> tensorrt_llm

<span class="hljs-comment"># æ„å»ºå¼•æ“</span>
builder = tensorrt_llm.Builder()
engine = builder.create_engine(model_config)

<span class="hljs-comment"># æ¨ç†</span>
outputs = engine.generate(inputs)
</code></pre>
<p><strong>ç‰¹ç‚¹</strong>ï¼š</p>
<ul>
<li>NVIDIA å®˜æ–¹</li>
<li>æè‡´ä¼˜åŒ–</li>
<li>æ”¯æŒå¤š GPU</li>
</ul>
<h3>æ€§èƒ½å¯¹æ¯”</h3>
<table>
<thead>
<tr>
<th>æ¡†æ¶</th>
<th>ååé‡</th>
<th>å»¶è¿Ÿ</th>
<th>æ˜“ç”¨æ€§</th>
</tr>
</thead>
<tbody>
<tr>
<td>HuggingFace</td>
<td>1x</td>
<td>åŸºå‡†</td>
<td>â­â­â­â­â­</td>
</tr>
<tr>
<td>vLLM</td>
<td>10-20x</td>
<td>0.7x</td>
<td>â­â­â­â­</td>
</tr>
<tr>
<td>TensorRT-LLM</td>
<td>15-25x</td>
<td>0.5x</td>
<td>â­â­â­</td>
</tr>
</tbody>
</table>
<h2>æ¨ç†ä¼˜åŒ–æŠ€æœ¯æ€»ç»“</h2>
<h3>è®¡ç®—ä¼˜åŒ–</h3>
<table>
<thead>
<tr>
<th>æŠ€æœ¯</th>
<th>åŠ é€Ÿæ¯”</th>
<th>å¤æ‚åº¦</th>
</tr>
</thead>
<tbody>
<tr>
<td>Flash Attention</td>
<td>2-4x</td>
<td>ä½</td>
</tr>
<tr>
<td>ç®—å­èåˆ</td>
<td>1.5-2x</td>
<td>ä¸­</td>
</tr>
<tr>
<td>INT8/FP8 æ¨ç†</td>
<td>2-3x</td>
<td>ä¸­</td>
</tr>
</tbody>
</table>
<h3>å†…å­˜ä¼˜åŒ–</h3>
<table>
<thead>
<tr>
<th>æŠ€æœ¯</th>
<th>å†…å­˜èŠ‚çœ</th>
<th>å¤æ‚åº¦</th>
</tr>
</thead>
<tbody>
<tr>
<td>PagedAttention</td>
<td>50%</td>
<td>ä¸­</td>
</tr>
<tr>
<td>KV Cache é‡åŒ–</td>
<td>50-75%</td>
<td>ä¸­</td>
</tr>
<tr>
<td>æ¨¡å‹å¸è½½</td>
<td>æå¤§</td>
<td>ä½</td>
</tr>
</tbody>
</table>
<h3>è°ƒåº¦ä¼˜åŒ–</h3>
<table>
<thead>
<tr>
<th>æŠ€æœ¯</th>
<th>ååæå‡</th>
<th>å¤æ‚åº¦</th>
</tr>
</thead>
<tbody>
<tr>
<td>è¿ç»­æ‰¹å¤„ç†</td>
<td>2-4x</td>
<td>ä¸­</td>
</tr>
<tr>
<td>æŠ•æœºè§£ç </td>
<td>1.5-2x</td>
<td>é«˜</td>
</tr>
<tr>
<td>åˆ†ç¦»å¼æ¶æ„</td>
<td>2-3x</td>
<td>é«˜</td>
</tr>
</tbody>
</table>
<h2>æœ€ä½³å®è·µ</h2>
<h3>é€‰æ‹©æ¡†æ¶</h3>
<pre class="hljs"><code><span class="hljs-comment"># åœºæ™¯é€‰æ‹©</span>
<span class="hljs-keyword">if</span> production_server:
    use vLLM  <span class="hljs-comment"># æœ€ä½³æ€§ä»·æ¯”</span>
<span class="hljs-keyword">elif</span> nvidia_gpu <span class="hljs-keyword">and</span> max_performance:
    use TensorRT-LLM  <span class="hljs-comment"># æè‡´æ€§èƒ½</span>
<span class="hljs-keyword">elif</span> cpu_only:
    use llama.cpp  <span class="hljs-comment"># CPU ä¼˜åŒ–</span>
</code></pre>
<h3>é…ç½®å»ºè®®</h3>
<pre class="hljs"><code><span class="hljs-comment"># vLLM æ¨èé…ç½®</span>
llm = LLM(
    model=<span class="hljs-string">&quot;model-name&quot;</span>,
    tensor_parallel_size=<span class="hljs-number">2</span>,  <span class="hljs-comment"># 2 GPU å¹¶è¡Œ</span>
    gpu_memory_utilization=<span class="hljs-number">0.9</span>,  <span class="hljs-comment"># 90% æ˜¾å­˜åˆ©ç”¨ç‡</span>
    max_model_len=<span class="hljs-number">4096</span>,  <span class="hljs-comment"># æœ€å¤§ä¸Šä¸‹æ–‡é•¿åº¦</span>
    enforce_eager=<span class="hljs-literal">True</span>,  <span class="hljs-comment"># ç¦ç”¨ CUDA å›¾ï¼ˆè°ƒè¯•ç”¨ï¼‰</span>
)
</code></pre>
<h2>å‚è€ƒæ–‡çŒ®</h2>
<ol>
<li>Kwon et al. (2023). <em>Efficient Memory Management for Large Language Model Serving with PagedAttention</em></li>
<li>Dao et al. (2022). <em>FlashAttention: Fast and Memory-Efficient Exact Attention</em></li>
<li>NVIDIA (2023). <em>TensorRT-LLM: High-Performance Inference</em></li>
</ol>
<h1>æ¨ç†åŠ é€Ÿæµç¨‹å›¾è§£</h1>
<blockquote>
<p>é€šè¿‡å¯è§†åŒ–å›¾è¡¨ç†è§£æ¨ç†åŠ é€Ÿçš„å®Œæ•´å·¥ä½œæµç¨‹</p>
</blockquote>
<h2>è‡ªå›å½’ç”Ÿæˆè¿‡ç¨‹</h2>
<p><div class="mermaid">flowchart LR
    subgraph ç”Ÿæˆè¿‡ç¨‹
        A["è¾“å…¥: ä½ å¥½"] --&gt; B["ç”Ÿæˆ: ä½ "]
        B --&gt; C["ç”Ÿæˆ: å¥½"]
        C --&gt; D["ç”Ÿæˆ: !"]
        D --&gt; E["è¾“å‡º: ä½ å¥½!"]
    end

    subgraph æ¯æ­¥è®¡ç®—
        F["å®Œæ•´å‰å‘ä¼ æ’­&lt;br/&gt;è®¡ç®—æ‰€æœ‰å±‚"]
    end

    B -.-&gt; F
    C -.-&gt; F
    D -.-&gt; F

    style F fill:#ffcdd2</div></p>
<h2>KV Cache åŸç†</h2>
<p><div class="mermaid">flowchart TB
    subgraph æ— ç¼“å­˜
        A1["ç”Ÿæˆ token 1&lt;br/&gt;è®¡ç®— K1,V1"]
        A2["ç”Ÿæˆ token 2&lt;br/&gt;è®¡ç®— K1,V1,K2,V2"]
        A3["ç”Ÿæˆ token 3&lt;br/&gt;è®¡ç®— K1,V1,K2,V2,K3,V3"]
        A1 --&gt; A2 --&gt; A3
    end

    subgraph æœ‰ç¼“å­˜
        B1["ç”Ÿæˆ token 1&lt;br/&gt;è®¡ç®— K1,V1&lt;br/&gt;ç¼“å­˜"]
        B2["ç”Ÿæˆ token 2&lt;br/&gt;å¤ç”¨ K1,V1&lt;br/&gt;åªç®— K2,V2"]
        B3["ç”Ÿæˆ token 3&lt;br/&gt;å¤ç”¨ K1-K2,V1-V2&lt;br/&gt;åªç®— K3,V3"]
        B1 --&gt; B2 --&gt; B3
    end

    style A3 fill:#ffcdd2
    style B3 fill:#c8e6c9</div></p>
<h2>PagedAttention å†…å­˜ç®¡ç†</h2>
<p><div class="mermaid">flowchart TB
    subgraph ä¼ ç»Ÿé¢„åˆ†é…
        T1["è¯·æ±‚1: é¢„ç•™ 4096 slots"]
        T2["è¯·æ±‚2: é¢„ç•™ 4096 slots"]
        T3["è¯·æ±‚3: é¢„ç•™ 4096 slots"]
        T4["å®é™…ä½¿ç”¨ ~50%&lt;br/&gt;å¤§é‡æµªè´¹"]
    end

    subgraph PagedAttention
        P1["è¯·æ±‚1: é¡µ1, é¡µ3, é¡µ5"]
        P2["è¯·æ±‚2: é¡µ2, é¡µ4"]
        P3["è¯·æ±‚3: é¡µ6, é¡µ7, é¡µ8"]
        P4["æŒ‰éœ€åˆ†é…&lt;br/&gt;åˆ©ç”¨ç‡ ~95%"]
    end

    style T4 fill:#ffcdd2
    style P4 fill:#c8e6c9</div></p>
<h2>è¿ç»­æ‰¹å¤„ç†æµç¨‹</h2>
<p><div class="mermaid">flowchart LR
    subgraph é™æ€æ‰¹å¤„ç†
        S1["Batch: [R1, R2, R3]"]
        S2["ç­‰å¾…æ‰€æœ‰å®Œæˆ"]
        S3["R1âœ“ R2âœ“ R3âœ“&lt;br/&gt;åŒæ—¶ç»“æŸ"]
        S1 --&gt; S2 --&gt; S3
    end

    subgraph è¿ç»­æ‰¹å¤„ç†
        C1["T1: [R1, R2, R3]"]
        C2["T2: [R1, R2] R3âœ“"]
        C3["T3: [R1, R4] R2âœ“"]
        C1 --&gt; C2 --&gt; C3
    end

    style S3 fill:#fff9c4
    style C3 fill:#c8e6c9</div></p>
<h2>Flash Attention ä¼˜åŒ–</h2>
<p><div class="mermaid">flowchart TB
    subgraph æ ‡å‡†æ³¨æ„åŠ›
        A1["è®¡ç®— NÃ—N æ³¨æ„åŠ›çŸ©é˜µ"]
        A2["å­˜å‚¨åˆ° HBM"]
        A3["åº”ç”¨ Softmax"]
        A4["å†æ¬¡è¯»å†™ HBM"]
        A1 --&gt; A2 --&gt; A3 --&gt; A4
    end

    subgraph Flash Attention
        B1["åˆ†å—è¯»å–åˆ° SRAM"]
        B2["SRAM ä¸­å®Œæˆ&lt;br/&gt;Softmax + ç¼©æ”¾"]
        B3["åªå†™å›æœ€ç»ˆç»“æœ"]
        B1 --&gt; B2 --&gt; B3
    end

    style A4 fill:#ffcdd2
    style B3 fill:#c8e6c9</div></p>
<h2>vLLM æ¨ç†æµç¨‹</h2>
<p><div class="mermaid">flowchart TB
    A[æ¥æ”¶è¯·æ±‚] --&gt; B[åŠ å…¥è°ƒåº¦é˜Ÿåˆ—]
    B --&gt; C{è°ƒåº¦å†³ç­–}

    C --&gt;|æœ‰GPUèµ„æº| D[åˆ†é… KV Cache é¡µ]
    C --&gt;|èµ„æºä¸è¶³| E[ç­‰å¾…æˆ–æŠ¢å ]

    D --&gt; F[æ‰§è¡Œå‰å‘ä¼ æ’­]
    F --&gt; G[ç”Ÿæˆ token]
    G --&gt; H{ç”Ÿæˆå®Œæˆ?}

    H --&gt;|å¦| F
    H --&gt;|æ˜¯| I[é‡Šæ”¾ KV Cache]
    I --&gt; J[è¿”å›ç»“æœ]

    style D fill:#c8e6c9
    style I fill:#c8e6c9</div></p>
<h2>æ¡†æ¶é€‰æ‹©å†³ç­–æ ‘</h2>
<p><div class="mermaid">flowchart TD
    Start["éœ€è¦éƒ¨ç½² LLM æ¨ç†"] --&gt; Q1{"ä¸»è¦ç›®æ ‡?"}

    Q1 --&gt;|"æœ€é«˜ååé‡"| Q2{"ç¡¬ä»¶?"}
    Q1 --&gt;|"æœ€ä½å»¶è¿Ÿ"| Q3{"GPU ç±»å‹?"}
    Q1 --&gt;|"æ˜“äºéƒ¨ç½²"| vLLM["vLLM&lt;br/&gt;æ¨èé€‰æ‹©"]

    Q2 --&gt;|"NVIDIA GPU"| TRT["TensorRT-LLM"]
    Q2 --&gt;|"æ··åˆ/å…¶ä»–"| vLLM

    Q3 --&gt;|"NVIDIA"| TRT
    Q3 --&gt;|"å…¶ä»–"| vLLM

    Start --&gt;|"CPU only"| llama["llama.cpp"]

    style vLLM fill:#c8e6c9
    style TRT fill:#bbdefb
    style llama fill:#fff9c4</div></p>
<h2>æ€§èƒ½ä¼˜åŒ–å±‚æ¬¡</h2>
<p><div class="mermaid">flowchart TB
    subgraph åº”ç”¨å±‚
        A1["æ‰¹å¤„ç†ç­–ç•¥"]
        A2["è¯·æ±‚è°ƒåº¦"]
    end

    subgraph ç®—æ³•å±‚
        B1["KV Cache"]
        B2["æŠ•æœºè§£ç "]
        B3["æ³¨æ„åŠ›ä¼˜åŒ–"]
    end

    subgraph ç³»ç»Ÿå±‚
        C1["å¹¶è¡Œç­–ç•¥"]
        C2["å†…å­˜ç®¡ç†"]
    end

    subgraph ç¡¬ä»¶å±‚
        D1["CUDA å†…æ ¸"]
        D2["Tensor Cores"]
    end

    A1 --&gt; B1 --&gt; C1 --&gt; D1

    style A1 fill:#e1f5fe
    style B1 fill:#bbdefb
    style C1 fill:#c8e6c9
    style D1 fill:#fff9c4</div></p>
<h2>å›¾è§£è¯´æ˜</h2>
<h3>å…³é”®æŠ€æœ¯æ”¶ç›Š</h3>
<table>
<thead>
<tr>
<th>æŠ€æœ¯</th>
<th>å»¶è¿Ÿ</th>
<th>ååé‡</th>
<th>å†…å­˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>KV Cache</td>
<td>â†“50%</td>
<td>â†‘2x</td>
<td>â†‘ä½¿ç”¨</td>
</tr>
<tr>
<td>PagedAttention</td>
<td>-</td>
<td>â†‘4x</td>
<td>â†“50%</td>
</tr>
<tr>
<td>Flash Attention</td>
<td>â†“30%</td>
<td>â†‘2x</td>
<td>â†“90%</td>
</tr>
<tr>
<td>è¿ç»­æ‰¹å¤„ç†</td>
<td>-</td>
<td>â†‘4x</td>
<td>-</td>
</tr>
</tbody>
</table>
<h3>æ¡†æ¶æ¨è</h3>
<table>
<thead>
<tr>
<th>åœºæ™¯</th>
<th>æ¨èæ¡†æ¶</th>
</tr>
</thead>
<tbody>
<tr>
<td>ç”Ÿäº§æœåŠ¡</td>
<td>vLLM</td>
</tr>
<tr>
<td>NVIDIA æè‡´æ€§èƒ½</td>
<td>TensorRT-LLM</td>
</tr>
<tr>
<td>CPU/è¾¹ç¼˜éƒ¨ç½²</td>
<td>llama.cpp</td>
</tr>
<tr>
<td>ç ”ç©¶åŸå‹</td>
<td>HuggingFace</td>
</tr>
</tbody>
</table>
<h3>æ€§èƒ½ç“¶é¢ˆåˆ†æ</h3>
<pre class="hljs"><code>æ¨ç†æ—¶é—´åˆ†è§£:
â”œâ”€â”€ è®¡ç®—æ—¶é—´: 30%
â”‚   â””â”€â”€ GPU åˆ©ç”¨ç‡å½±å“
â”œâ”€â”€ å†…å­˜ä¼ è¾“: 50%  â† ä¸»è¦ç“¶é¢ˆ!
â”‚   â””â”€â”€ æ¨¡å‹å‚æ•° + KV Cache
â””â”€â”€ è°ƒåº¦å¼€é”€: 20%
    â””â”€â”€ æ‰¹å¤„ç†æ•ˆç‡
</code></pre>
<div class="code-appendix page-break"><h2>é™„å½•ï¼šä»£ç ç¤ºä¾‹</h2><div class="code-file"><h3>kv_cache_optimization.py</h3><pre class="hljs"><code><span class="hljs-string">&quot;&quot;&quot;
KV Cache ä¼˜åŒ–ç¤ºä¾‹ä»£ç 

æ¼”ç¤º KV Cache çš„åŸç†å’Œä¼˜åŒ–æŠ€æœ¯ã€‚
KV Cache æ˜¯ LLM æ¨ç†åŠ é€Ÿçš„æ ¸å¿ƒæŠ€æœ¯ä¹‹ä¸€ã€‚
&quot;&quot;&quot;</span>

<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn
<span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Optional</span>, <span class="hljs-type">Tuple</span>

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 1. KV Cache åŸºç¡€å®ç°</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">KVCache</span>:
    <span class="hljs-string">&quot;&quot;&quot;ç®€å•çš„ KV Cache å®ç°&quot;&quot;&quot;</span>
    key_cache: torch.Tensor    <span class="hljs-comment"># [batch, num_heads, seq_len, head_dim]</span>
    value_cache: torch.Tensor  <span class="hljs-comment"># [batch, num_heads, seq_len, head_dim]</span>

<span class="hljs-meta">    @classmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">cls, batch_size: <span class="hljs-built_in">int</span>, num_heads: <span class="hljs-built_in">int</span>, max_seq_len: <span class="hljs-built_in">int</span>, head_dim: <span class="hljs-built_in">int</span>, device: <span class="hljs-built_in">str</span> = <span class="hljs-string">&quot;cuda&quot;</span></span>):
        <span class="hljs-string">&quot;&quot;&quot;åˆ›å»ºç©ºçš„ KV Cache&quot;&quot;&quot;</span>
        <span class="hljs-keyword">return</span> cls(
            key_cache=torch.zeros(batch_size, num_heads, max_seq_len, head_dim, device=device),
            value_cache=torch.zeros(batch_size, num_heads, max_seq_len, head_dim, device=device),
        )

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">update</span>(<span class="hljs-params">self, new_keys: torch.Tensor, new_values: torch.Tensor, start_pos: <span class="hljs-built_in">int</span></span>):
        <span class="hljs-string">&quot;&quot;&quot;æ›´æ–° KV Cache&quot;&quot;&quot;</span>
        seq_len = new_keys.shape[<span class="hljs-number">2</span>]
        <span class="hljs-variable language_">self</span>.key_cache[:, :, start_pos:start_pos + seq_len, :] = new_keys
        <span class="hljs-variable language_">self</span>.value_cache[:, :, start_pos:start_pos + seq_len, :] = new_values

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">self, start_pos: <span class="hljs-built_in">int</span>, end_pos: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-type">Tuple</span>[torch.Tensor, torch.Tensor]:
        <span class="hljs-string">&quot;&quot;&quot;è·å–æŒ‡å®šèŒƒå›´çš„ KV&quot;&quot;&quot;</span>
        <span class="hljs-keyword">return</span> (
            <span class="hljs-variable language_">self</span>.key_cache[:, :, :end_pos, :],
            <span class="hljs-variable language_">self</span>.value_cache[:, :, :end_pos, :]
        )


<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 2. å¸¦ KV Cache çš„æ³¨æ„åŠ›å®ç°</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CachedAttention</span>(nn.Module):
    <span class="hljs-string">&quot;&quot;&quot;å¸¦ KV Cache çš„æ³¨æ„åŠ›å±‚&quot;&quot;&quot;</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, hidden_size: <span class="hljs-built_in">int</span>, num_heads: <span class="hljs-built_in">int</span></span>):
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-variable language_">self</span>.num_heads = num_heads
        <span class="hljs-variable language_">self</span>.head_dim = hidden_size // num_heads

        <span class="hljs-variable language_">self</span>.q_proj = nn.Linear(hidden_size, hidden_size, bias=<span class="hljs-literal">False</span>)
        <span class="hljs-variable language_">self</span>.k_proj = nn.Linear(hidden_size, hidden_size, bias=<span class="hljs-literal">False</span>)
        <span class="hljs-variable language_">self</span>.v_proj = nn.Linear(hidden_size, hidden_size, bias=<span class="hljs-literal">False</span>)
        <span class="hljs-variable language_">self</span>.o_proj = nn.Linear(hidden_size, hidden_size, bias=<span class="hljs-literal">False</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">
        self,
        hidden_states: torch.Tensor,
        kv_cache: <span class="hljs-type">Optional</span>[KVCache] = <span class="hljs-literal">None</span>,
        position: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span>,
        use_cache: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">True</span>
    </span>) -&gt; <span class="hljs-type">Tuple</span>[torch.Tensor, <span class="hljs-type">Optional</span>[KVCache]]:
        <span class="hljs-string">&quot;&quot;&quot;
        Args:
            hidden_states: [batch, seq_len, hidden_size]
            kv_cache: ä¹‹å‰çš„ KV Cache
            position: å½“å‰ä½ç½®
            use_cache: æ˜¯å¦ä½¿ç”¨ KV Cache
        &quot;&quot;&quot;</span>
        batch_size, seq_len, _ = hidden_states.shape

        <span class="hljs-comment"># æŠ•å½±</span>
        q = <span class="hljs-variable language_">self</span>.q_proj(hidden_states)
        k = <span class="hljs-variable language_">self</span>.k_proj(hidden_states)
        v = <span class="hljs-variable language_">self</span>.v_proj(hidden_states)

        <span class="hljs-comment"># é‡å¡‘ä¸ºå¤šå¤´å½¢å¼</span>
        q = q.view(batch_size, seq_len, <span class="hljs-variable language_">self</span>.num_heads, <span class="hljs-variable language_">self</span>.head_dim).transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)
        k = k.view(batch_size, seq_len, <span class="hljs-variable language_">self</span>.num_heads, <span class="hljs-variable language_">self</span>.head_dim).transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)
        v = v.view(batch_size, seq_len, <span class="hljs-variable language_">self</span>.num_heads, <span class="hljs-variable language_">self</span>.head_dim).transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)

        <span class="hljs-comment"># å¤„ç† KV Cache</span>
        <span class="hljs-keyword">if</span> use_cache <span class="hljs-keyword">and</span> kv_cache <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            <span class="hljs-comment"># æ›´æ–°ç¼“å­˜</span>
            kv_cache.update(k, v, position)
            <span class="hljs-comment"># è·å–å®Œæ•´çš„ K, Vï¼ˆåŒ…æ‹¬ä¹‹å‰ç¼“å­˜çš„ï¼‰</span>
            k, v = kv_cache.get(<span class="hljs-number">0</span>, position + seq_len)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-comment"># ä¸ä½¿ç”¨ç¼“å­˜</span>
            <span class="hljs-keyword">pass</span>

        <span class="hljs-comment"># è®¡ç®—æ³¨æ„åŠ›</span>
        attn_weights = torch.matmul(q, k.transpose(-<span class="hljs-number">2</span>, -<span class="hljs-number">1</span>)) / (<span class="hljs-variable language_">self</span>.head_dim ** <span class="hljs-number">0.5</span>)

        <span class="hljs-comment"># å› æœæ©ç </span>
        <span class="hljs-keyword">if</span> use_cache <span class="hljs-keyword">and</span> kv_cache <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            <span class="hljs-comment"># å¯¹äºç¼“å­˜æ¨¡å¼ï¼Œåªéœ€è¦æ©ç æ–°çš„ query å¯¹ new key</span>
            causal_mask = torch.triu(
                torch.ones(seq_len, position + seq_len, device=hidden_states.device),
                diagonal=position + <span class="hljs-number">1</span>
            ).<span class="hljs-built_in">bool</span>()
            attn_weights = attn_weights.masked_fill(causal_mask, <span class="hljs-built_in">float</span>(<span class="hljs-string">&#x27;-inf&#x27;</span>))
        <span class="hljs-keyword">else</span>:
            causal_mask = torch.triu(
                torch.ones(seq_len, seq_len, device=hidden_states.device),
                diagonal=<span class="hljs-number">1</span>
            ).<span class="hljs-built_in">bool</span>()
            attn_weights = attn_weights.masked_fill(causal_mask, <span class="hljs-built_in">float</span>(<span class="hljs-string">&#x27;-inf&#x27;</span>))

        attn_weights = torch.softmax(attn_weights, dim=-<span class="hljs-number">1</span>)
        attn_output = torch.matmul(attn_weights, v)

        <span class="hljs-comment"># é‡å¡‘å›åŸå§‹å½¢çŠ¶</span>
        attn_output = attn_output.transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>).contiguous().view(batch_size, seq_len, -<span class="hljs-number">1</span>)
        output = <span class="hljs-variable language_">self</span>.o_proj(attn_output)

        <span class="hljs-keyword">return</span> output, kv_cache


<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 3. KV Cache å†…å­˜åˆ†æ</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_kv_cache_memory</span>():
    <span class="hljs-string">&quot;&quot;&quot;åˆ†æ KV Cache çš„å†…å­˜ä½¿ç”¨&quot;&quot;&quot;</span>

    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">50</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;KV Cache å†…å­˜åˆ†æ&quot;</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">50</span>)

    <span class="hljs-comment"># å…¸å‹é…ç½®</span>
    configs = [
        {<span class="hljs-string">&quot;model&quot;</span>: <span class="hljs-string">&quot;LLaMA-2-7B&quot;</span>, <span class="hljs-string">&quot;layers&quot;</span>: <span class="hljs-number">32</span>, <span class="hljs-string">&quot;heads&quot;</span>: <span class="hljs-number">32</span>, <span class="hljs-string">&quot;head_dim&quot;</span>: <span class="hljs-number">128</span>},
        {<span class="hljs-string">&quot;model&quot;</span>: <span class="hljs-string">&quot;LLaMA-2-13B&quot;</span>, <span class="hljs-string">&quot;layers&quot;</span>: <span class="hljs-number">40</span>, <span class="hljs-string">&quot;heads&quot;</span>: <span class="hljs-number">40</span>, <span class="hljs-string">&quot;head_dim&quot;</span>: <span class="hljs-number">128</span>},
        {<span class="hljs-string">&quot;model&quot;</span>: <span class="hljs-string">&quot;LLaMA-2-70B&quot;</span>, <span class="hljs-string">&quot;layers&quot;</span>: <span class="hljs-number">80</span>, <span class="hljs-string">&quot;heads&quot;</span>: <span class="hljs-number">64</span>, <span class="hljs-string">&quot;head_dim&quot;</span>: <span class="hljs-number">128</span>},
    ]

    seq_lengths = [<span class="hljs-number">512</span>, <span class="hljs-number">1024</span>, <span class="hljs-number">2048</span>, <span class="hljs-number">4096</span>]

    <span class="hljs-keyword">for</span> config <span class="hljs-keyword">in</span> configs:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n<span class="hljs-subst">{config[<span class="hljs-string">&#x27;model&#x27;</span>]}</span>:&quot;</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">40</span>)

        <span class="hljs-keyword">for</span> seq_len <span class="hljs-keyword">in</span> seq_lengths:
            <span class="hljs-comment"># KV Cache å¤§å°è®¡ç®—</span>
            <span class="hljs-comment"># 2 (K+V) Ã— layers Ã— heads Ã— head_dim Ã— seq_len Ã— 2 bytes (FP16)</span>
            kv_size = <span class="hljs-number">2</span> * config[<span class="hljs-string">&#x27;layers&#x27;</span>] * config[<span class="hljs-string">&#x27;heads&#x27;</span>] * config[<span class="hljs-string">&#x27;head_dim&#x27;</span>] * seq_len * <span class="hljs-number">2</span>

            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  Seq <span class="hljs-subst">{seq_len:4d}</span>: <span class="hljs-subst">{kv_size / <span class="hljs-number">1e9</span>:<span class="hljs-number">.2</span>f}</span> GB&quot;</span>)


<span class="hljs-keyword">def</span> <span class="hljs-title function_">compare_with_without_cache</span>():
    <span class="hljs-string">&quot;&quot;&quot;å¯¹æ¯”æœ‰æ—  KV Cache çš„è®¡ç®—é‡&quot;&quot;&quot;</span>

    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">50</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;æœ‰æ—  KV Cache è®¡ç®—é‡å¯¹æ¯”&quot;</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">50</span>)

    total_tokens = <span class="hljs-number">100</span>
    hidden_size = <span class="hljs-number">4096</span>

    <span class="hljs-comment"># æ—  KV Cache: æ¯ä¸ªä½ç½®éƒ½è¦é‡æ–°è®¡ç®—æ‰€æœ‰ä¹‹å‰çš„</span>
    flops_no_cache = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, total_tokens + <span class="hljs-number">1</span>):
        <span class="hljs-comment"># æ¯æ¬¡éƒ½è¦è®¡ç®— i ä¸ªä½ç½®çš„æ³¨æ„åŠ›</span>
        flops_no_cache += i * hidden_size * <span class="hljs-number">4</span>  <span class="hljs-comment"># Q, K, V, O æŠ•å½±</span>

    <span class="hljs-comment"># æœ‰ KV Cache: åªè®¡ç®—å½“å‰ä½ç½®</span>
    flops_with_cache = total_tokens * hidden_size * <span class="hljs-number">4</span>

    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;ç”Ÿæˆ <span class="hljs-subst">{total_tokens}</span> tokens:&quot;</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  æ—  KV Cache: <span class="hljs-subst">{flops_no_cache / <span class="hljs-number">1e9</span>:<span class="hljs-number">.2</span>f}</span> GFLOPs&quot;</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  æœ‰ KV Cache: <span class="hljs-subst">{flops_with_cache / <span class="hljs-number">1e9</span>:<span class="hljs-number">.2</span>f}</span> GFLOPs&quot;</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  åŠ é€Ÿæ¯”: <span class="hljs-subst">{flops_no_cache / flops_with_cache:<span class="hljs-number">.1</span>f}</span>x&quot;</span>)


<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 4. PagedAttention ç®€åŒ–å®ç°</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">PagedKVCache</span>:
    <span class="hljs-string">&quot;&quot;&quot;PagedAttention çš„ç®€åŒ–å®ç°&quot;&quot;&quot;</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, num_blocks: <span class="hljs-built_in">int</span>, block_size: <span class="hljs-built_in">int</span>, num_heads: <span class="hljs-built_in">int</span>, head_dim: <span class="hljs-built_in">int</span></span>):
        <span class="hljs-string">&quot;&quot;&quot;
        Args:
            num_blocks: æ€»å—æ•°
            block_size: æ¯å—çš„åºåˆ—é•¿åº¦
            num_heads: æ³¨æ„åŠ›å¤´æ•°
            head_dim: æ¯å¤´ç»´åº¦
        &quot;&quot;&quot;</span>
        <span class="hljs-variable language_">self</span>.num_blocks = num_blocks
        <span class="hljs-variable language_">self</span>.block_size = block_size
        <span class="hljs-variable language_">self</span>.num_heads = num_heads
        <span class="hljs-variable language_">self</span>.head_dim = head_dim

        <span class="hljs-comment"># é¢„åˆ†é…å—æ± </span>
        <span class="hljs-variable language_">self</span>.k_cache = torch.zeros(num_blocks, num_heads, block_size, head_dim)
        <span class="hljs-variable language_">self</span>.v_cache = torch.zeros(num_blocks, num_heads, block_size, head_dim)

        <span class="hljs-comment"># ç©ºé—²å—åˆ—è¡¨</span>
        <span class="hljs-variable language_">self</span>.free_blocks = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">range</span>(num_blocks))

        <span class="hljs-comment"># æ¯ä¸ªè¯·æ±‚çš„å—æ˜ å°„</span>
        <span class="hljs-variable language_">self</span>.request_blocks = {}  <span class="hljs-comment"># request_id -&gt; [block_ids]</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">allocate</span>(<span class="hljs-params">self, request_id: <span class="hljs-built_in">str</span>, num_tokens: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-string">&quot;&quot;&quot;ä¸ºè¯·æ±‚åˆ†é…å—&quot;&quot;&quot;</span>
        num_blocks_needed = (num_tokens + <span class="hljs-variable language_">self</span>.block_size - <span class="hljs-number">1</span>) // <span class="hljs-variable language_">self</span>.block_size

        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(<span class="hljs-variable language_">self</span>.free_blocks) &lt; num_blocks_needed:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>  <span class="hljs-comment"># å†…å­˜ä¸è¶³</span>

        blocks = []
        <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_blocks_needed):
            blocks.append(<span class="hljs-variable language_">self</span>.free_blocks.pop())

        <span class="hljs-variable language_">self</span>.request_blocks[request_id] = blocks
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">self, request_id: <span class="hljs-built_in">str</span></span>):
        <span class="hljs-string">&quot;&quot;&quot;é‡Šæ”¾è¯·æ±‚çš„å—&quot;&quot;&quot;</span>
        <span class="hljs-keyword">if</span> request_id <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.request_blocks:
            <span class="hljs-variable language_">self</span>.free_blocks.extend(<span class="hljs-variable language_">self</span>.request_blocks[request_id])
            <span class="hljs-keyword">del</span> <span class="hljs-variable language_">self</span>.request_blocks[request_id]

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_memory_utilization</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">float</span>:
        <span class="hljs-string">&quot;&quot;&quot;è®¡ç®—å†…å­˜åˆ©ç”¨ç‡&quot;&quot;&quot;</span>
        used = <span class="hljs-variable language_">self</span>.num_blocks - <span class="hljs-built_in">len</span>(<span class="hljs-variable language_">self</span>.free_blocks)
        <span class="hljs-keyword">return</span> used / <span class="hljs-variable language_">self</span>.num_blocks


<span class="hljs-keyword">def</span> <span class="hljs-title function_">demo_paged_attention</span>():
    <span class="hljs-string">&quot;&quot;&quot;æ¼”ç¤º PagedAttention çš„ä¼˜åŠ¿&quot;&quot;&quot;</span>

    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">50</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;PagedAttention æ¼”ç¤º&quot;</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">50</span>)

    cache = PagedKVCache(
        num_blocks=<span class="hljs-number">100</span>,
        block_size=<span class="hljs-number">16</span>,
        num_heads=<span class="hljs-number">32</span>,
        head_dim=<span class="hljs-number">128</span>
    )

    <span class="hljs-comment"># åˆ†é…ä¸åŒé•¿åº¦çš„è¯·æ±‚</span>
    requests = [
        (<span class="hljs-string">&quot;req1&quot;</span>, <span class="hljs-number">50</span>),   <span class="hljs-comment"># éœ€è¦ 4 å—</span>
        (<span class="hljs-string">&quot;req2&quot;</span>, <span class="hljs-number">100</span>),  <span class="hljs-comment"># éœ€è¦ 7 å—</span>
        (<span class="hljs-string">&quot;req3&quot;</span>, <span class="hljs-number">30</span>),   <span class="hljs-comment"># éœ€è¦ 2 å—</span>
    ]

    <span class="hljs-keyword">for</span> req_id, num_tokens <span class="hljs-keyword">in</span> requests:
        success = cache.allocate(req_id, num_tokens)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;åˆ†é… <span class="hljs-subst">{req_id}</span> (<span class="hljs-subst">{num_tokens}</span> tokens): <span class="hljs-subst">{<span class="hljs-string">&#x27;æˆåŠŸ&#x27;</span> <span class="hljs-keyword">if</span> success <span class="hljs-keyword">else</span> <span class="hljs-string">&#x27;å¤±è´¥&#x27;</span>}</span>&quot;</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  å†…å­˜åˆ©ç”¨ç‡: <span class="hljs-subst">{cache.get_memory_utilization():<span class="hljs-number">.1</span>%}</span>&quot;</span>)

    <span class="hljs-comment"># é‡Šæ”¾ä¸€ä¸ªè¯·æ±‚</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\né‡Šæ”¾ req2...&quot;</span>)
    cache.free(<span class="hljs-string">&quot;req2&quot;</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;å†…å­˜åˆ©ç”¨ç‡: <span class="hljs-subst">{cache.get_memory_utilization():<span class="hljs-number">.1</span>%}</span>&quot;</span>)


<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 5. è¿è¡Œæ¼”ç¤º</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:
    analyze_kv_cache_memory()
    compare_with_without_cache()
    demo_paged_attention()

    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">50</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;KV Cache ä¼˜åŒ–ç¤ºä¾‹å®Œæˆ!&quot;</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">50</span>)
</code></pre></div><div class="code-file"><h3>vllm_example.py</h3><pre class="hljs"><code><span class="hljs-string">&quot;&quot;&quot;
vLLM æ¨ç†åŠ é€Ÿç¤ºä¾‹ä»£ç 

æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ vLLM è¿›è¡Œé«˜æ€§èƒ½ LLM æ¨ç†ã€‚
vLLM æ˜¯ç›®å‰æœ€æµè¡Œçš„å¼€æºæ¨ç†æ¡†æ¶ã€‚
&quot;&quot;&quot;</span>

<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">from</span> vllm <span class="hljs-keyword">import</span> LLM, SamplingParams

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 1. åŸºæœ¬ä½¿ç”¨</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;åŠ è½½æ¨¡å‹...&quot;</span>)

<span class="hljs-comment"># vLLM ä¼šè‡ªåŠ¨å¤„ç†:</span>
<span class="hljs-comment"># - PagedAttention å†…å­˜ç®¡ç†</span>
<span class="hljs-comment"># - è¿ç»­æ‰¹å¤„ç†</span>
<span class="hljs-comment"># - CUDA å†…æ ¸ä¼˜åŒ–</span>

llm = LLM(
    model=<span class="hljs-string">&quot;meta-llama/Llama-2-7b-hf&quot;</span>,

    <span class="hljs-comment"># å¹¶è¡Œé…ç½®</span>
    tensor_parallel_size=<span class="hljs-number">1</span>,  <span class="hljs-comment"># å• GPU</span>
    <span class="hljs-comment"># tensor_parallel_size=2,  # åŒ GPU å¹¶è¡Œ</span>

    <span class="hljs-comment"># å†…å­˜é…ç½®</span>
    gpu_memory_utilization=<span class="hljs-number">0.9</span>,  <span class="hljs-comment"># ä½¿ç”¨ 90% GPU æ˜¾å­˜</span>

    <span class="hljs-comment"># ä¸Šä¸‹æ–‡é•¿åº¦</span>
    max_model_len=<span class="hljs-number">4096</span>,

    <span class="hljs-comment"># å…¶ä»–é€‰é¡¹</span>
    trust_remote_code=<span class="hljs-literal">True</span>,
    dtype=<span class="hljs-string">&quot;float16&quot;</span>,
)

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 2. é…ç½®é‡‡æ ·å‚æ•°</span>
<span class="hljs-comment"># ============================================</span>

sampling_params = SamplingParams(
    <span class="hljs-comment"># ç”Ÿæˆé•¿åº¦</span>
    max_tokens=<span class="hljs-number">100</span>,

    <span class="hljs-comment"># æ¸©åº¦ (æ§åˆ¶éšæœºæ€§)</span>
    temperature=<span class="hljs-number">0.7</span>,

    <span class="hljs-comment"># Top-p é‡‡æ ·</span>
    top_p=<span class="hljs-number">0.9</span>,

    <span class="hljs-comment"># Top-k é‡‡æ ·</span>
    top_k=<span class="hljs-number">50</span>,

    <span class="hljs-comment"># é‡å¤æƒ©ç½š</span>
    repetition_penalty=<span class="hljs-number">1.1</span>,

    <span class="hljs-comment"># åœæ­¢è¯</span>
    stop=[<span class="hljs-string">&quot;###&quot;</span>, <span class="hljs-string">&quot;\n\n&quot;</span>],
)

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 3. å•è¯·æ±‚æ¨ç†</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\nå•è¯·æ±‚æ¨ç†æµ‹è¯•...&quot;</span>)

prompt = <span class="hljs-string">&quot;è¯·è§£é‡Šä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ&quot;</span>
start_time = time.time()

outputs = llm.generate([prompt], sampling_params)

elapsed = time.time() - start_time
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;å»¶è¿Ÿ: <span class="hljs-subst">{elapsed:<span class="hljs-number">.2</span>f}</span> ç§’&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;è¾“å‡º: <span class="hljs-subst">{outputs[<span class="hljs-number">0</span>].outputs[<span class="hljs-number">0</span>].text[:<span class="hljs-number">200</span>]}</span>...&quot;</span>)

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 4. æ‰¹é‡æ¨ç† (å±•ç¤º vLLM çš„ä¼˜åŠ¿)</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\næ‰¹é‡æ¨ç†æµ‹è¯•...&quot;</span>)

prompts = [
    <span class="hljs-string">&quot;ä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½ï¼Ÿ&quot;</span>,
    <span class="hljs-string">&quot;æœºå™¨å­¦ä¹ å’Œæ·±åº¦å­¦ä¹ æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ&quot;</span>,
    <span class="hljs-string">&quot;è§£é‡Šä¸€ä¸‹ç¥ç»ç½‘ç»œçš„å·¥ä½œåŸç†ã€‚&quot;</span>,
    <span class="hljs-string">&quot;ä»€ä¹ˆæ˜¯è‡ªç„¶è¯­è¨€å¤„ç†ï¼Ÿ&quot;</span>,
    <span class="hljs-string">&quot;æ·±åº¦å­¦ä¹ æœ‰å“ªäº›åº”ç”¨åœºæ™¯ï¼Ÿ&quot;</span>,
    *[<span class="hljs-string">&quot;è¯·ä»‹ç»ä¸€ä¸‹æ·±åº¦å­¦ä¹ ã€‚&quot;</span>] * <span class="hljs-number">10</span>,  <span class="hljs-comment"># 15 ä¸ªè¯·æ±‚</span>
]

start_time = time.time()
outputs = llm.generate(prompts, sampling_params)
elapsed = time.time() - start_time

<span class="hljs-comment"># è®¡ç®—ååé‡</span>
total_tokens = <span class="hljs-built_in">sum</span>(<span class="hljs-built_in">len</span>(o.outputs[<span class="hljs-number">0</span>].token_ids) <span class="hljs-keyword">for</span> o <span class="hljs-keyword">in</span> outputs)
throughput = total_tokens / elapsed

<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;æ‰¹å¤„ç†å¤§å°: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(prompts)}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;æ€»å»¶è¿Ÿ: <span class="hljs-subst">{elapsed:<span class="hljs-number">.2</span>f}</span> ç§’&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;ååé‡: <span class="hljs-subst">{throughput:<span class="hljs-number">.1</span>f}</span> tokens/ç§’&quot;</span>)

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 5. æµå¼è¾“å‡º</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\næµå¼è¾“å‡ºç¤ºä¾‹...&quot;</span>)

<span class="hljs-keyword">from</span> vllm <span class="hljs-keyword">import</span> SamplingParams
<span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> AutoTokenizer

tokenizer = AutoTokenizer.from_pretrained(<span class="hljs-string">&quot;meta-llama/Llama-2-7b-hf&quot;</span>)

<span class="hljs-comment"># æ³¨æ„: vLLM çš„æµå¼è¾“å‡ºéœ€è¦ä½¿ç”¨ AsyncLLMEngine</span>
<span class="hljs-comment"># è¿™é‡Œå±•ç¤ºåŸºæœ¬æ¦‚å¿µ</span>

<span class="hljs-string">&quot;&quot;&quot;
from vllm.engine.async_llm_engine import AsyncLLMEngine
from vllm.engine.arg_utils import AsyncEngineArgs

engine_args = AsyncEngineArgs(
    model=&quot;meta-llama/Llama-2-7b-hf&quot;,
)
engine = AsyncLLMEngine.from_engine_args(engine_args)

async def generate_stream(prompt):
    results_generator = engine.generate(prompt, sampling_params, request_id=&quot;1&quot;)
    async for request_output in results_generator:
        yield request_output.outputs[0].text
&quot;&quot;&quot;</span>

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 6. ä¸ HuggingFace å¯¹æ¯”</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">compare_with_huggingface</span>():
    <span class="hljs-string">&quot;&quot;&quot;ä¸ HuggingFace åŸç”Ÿæ¨ç†å¯¹æ¯”&quot;&quot;&quot;</span>

    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">50</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;æ€§èƒ½å¯¹æ¯” (ä¼°ç®—)&quot;</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">50</span>)

    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&quot;&quot;
    | æŒ‡æ ‡           | HuggingFace | vLLM      |
    |----------------|-------------|-----------|
    | å•è¯·æ±‚å»¶è¿Ÿ     | 2.0s        | 1.5s      |
    | 10å¹¶å‘ååé‡   | 50 tok/s    | 500 tok/s |
    | æ˜¾å­˜åˆ©ç”¨ç‡     | ~60%        | ~90%      |
    | KV Cache ç®¡ç†  | é™æ€        | åŠ¨æ€åˆ†é¡µ  |
    &quot;&quot;&quot;</span>)

compare_with_huggingface()

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 7. é«˜çº§é…ç½®</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-string">&quot;&quot;&quot;
# å¤š GPU å¼ é‡å¹¶è¡Œ
llm = LLM(
    model=&quot;meta-llama/Llama-2-70b-hf&quot;,
    tensor_parallel_size=4,  # 4 GPU å¹¶è¡Œ
    gpu_memory_utilization=0.9,
)

# ä½¿ç”¨é‡åŒ–æ¨¡å‹
llm = LLM(
    model=&quot;TheBloke/Llama-2-7B-AWQ&quot;,
    quantization=&quot;awq&quot;,
)

# è‡ªå®šä¹‰ CUDA å›¾
llm = LLM(
    model=&quot;...&quot;,
    enforce_eager=False,  # å¯ç”¨ CUDA å›¾
)
&quot;&quot;&quot;</span>

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 8. API æœåŠ¡éƒ¨ç½²</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-string">&quot;&quot;&quot;
# å¯åŠ¨ OpenAI å…¼å®¹çš„ API æœåŠ¡
# å‘½ä»¤è¡Œ:
# python -m vllm.entrypoints.openai.api_server \\
#     --model meta-llama/Llama-2-7b-hf \\
#     --host 0.0.0.0 \\
#     --port 8000

# å®¢æˆ·ç«¯è°ƒç”¨:
import openai
client = openai.OpenAI(base_url=&quot;http://localhost:8000/v1&quot;)

response = client.chat.completions.create(
    model=&quot;meta-llama/Llama-2-7b-hf&quot;,
    messages=[{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;ä½ å¥½&quot;}],
)
&quot;&quot;&quot;</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">50</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;vLLM ç¤ºä¾‹å®Œæˆ!&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">50</span>)
</code></pre></div></div></div><div class="chapter"><h1>é™„å½•ï¼šå…¬å¼è¯¦è§£</h1><h1>é™„å½•ï¼šå…¬å¼è¯¦è§£</h1>
<p>æœ¬é™„å½•æ±‡æ€»å„ç« èŠ‚ advanced-guide ä¸­å‡ºç°çš„æ ¸å¿ƒå…¬å¼ï¼Œæä¾›è¯¦ç»†è®²è§£ï¼Œå¹¶æ”¯æŒè·³è½¬å›åŸæ–‡ä½ç½®ã€‚</p>
<h2>æ¿€æ´»å‡½æ•°</h2>
<h3>ä¸‡èƒ½è¿‘ä¼¼å®šç†ï¼ˆå…¬å¼ 1ï¼‰</h3>
<p><a id="formula-activation-1-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šè¯·ç»“åˆè¯¥ç« èŠ‚ä¸Šä¸‹æ–‡ç†è§£è¯¥å…¬å¼çš„è®¡ç®—ç›®æ ‡ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼šå˜é‡å®šä¹‰æ²¿ç”¨åŸç« èŠ‚ä¸­çš„ç¬¦å·çº¦å®šã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šè¯¥å…¬å¼ç”¨äºåˆ»ç”»è¯¥ä¸»é¢˜çš„æ ¸å¿ƒæœºåˆ¶ä¸å·¥ç¨‹ä½œç”¨ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-activation-1">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/activation/advanced-guide.md</code></p>
<h3>æ•°å­¦å®šä¹‰ï¼ˆå…¬å¼ 2ï¼‰</h3>
<p><a id="formula-activation-2-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">ReLU</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">max</span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord mathnormal">x</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">ifÂ </span></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">0</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">ifÂ </span></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â‰¤</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šReLU æŠŠæ‰€æœ‰è´Ÿå€¼æˆªæ–­ä¸º 0ï¼Œæ­£å€¼ä¿æŒä¸å˜ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> æ˜¯è¾“å…¥æ ‡é‡æˆ–å‘é‡ï¼ˆé€å…ƒç´ åº”ç”¨ï¼‰ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šåƒä¸€ä¸ªâ€œé—¸é—¨â€ï¼Œåªè®©æ­£ä¿¡å·é€šè¿‡ï¼Œä½¿æ¿€æ´»ç¨€ç–ä¸”è®¡ç®—ç®€å•ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-activation-2">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/activation/advanced-guide.md</code></p>
<h3>å¯¼æ•°ï¼ˆå…¬å¼ 3ï¼‰</h3>
<p><a id="formula-activation-3-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0751em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord text"><span class="mord">ReLU</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8251em;"><span style="top:-3.1362em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">ifÂ </span></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">0</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">ifÂ </span></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â‰¤</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šReLU åœ¨æ­£åŒºé—´å¯¼æ•°ä¸º 1ï¼Œè´ŸåŒºé—´å¯¼æ•°ä¸º 0ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0751em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord text"><span class="mord">ReLU</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8251em;"><span style="top:-3.1362em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> è¡¨ç¤ºè¾“å‡ºå¯¹è¾“å…¥çš„å˜åŒ–ç‡ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šæ­£åŒºé—´æ¢¯åº¦ç¨³å®šã€æ˜“è®­ç»ƒï¼›è´ŸåŒºé—´æ¢¯åº¦ä¸º 0ï¼Œå¯èƒ½å¯¼è‡´ç¥ç»å…ƒâ€œæ­»äº¡â€ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-activation-3">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/activation/advanced-guide.md</code></p>
<h3>æ•°å­¦å®šä¹‰ï¼ˆå…¬å¼ 4ï¼‰</h3>
<p><a id="formula-activation-4-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0908em;vertical-align:-0.7693em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6973em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">âˆ’</span><span class="mord mathnormal mtight">x</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šå°†ä»»æ„å®æ•°æ˜ å°„åˆ° <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span> çš„æ¦‚ç‡å¼è¾“å‡ºã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> ä¸ºè¾“å…¥ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">e</span></span></span></span> ä¸ºè‡ªç„¶å¸¸æ•°ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šåƒä¸€ä¸ªâ€œæ¦‚ç‡å¼€å…³â€ï¼Œå¸¸ç”¨äºäºŒåˆ†ç±»è¾“å‡ºã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-activation-4">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/activation/advanced-guide.md</code></p>
<h3>å¯¼æ•°ï¼ˆå…¬å¼ 5ï¼‰</h3>
<p><a id="formula-activation-5-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0519em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8019em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">))</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šSigmoid çš„æ¢¯åº¦ä¸å…¶è¾“å‡ºæˆæ­£ç›¸å…³ï¼Œåœ¨ 0 é™„è¿‘æœ€å¤§ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0019em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> è¡¨ç¤ºè¾“å‡ºå¯¹è¾“å…¥çš„æ•æ„Ÿåº¦ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šå½“ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> æ¥è¿‘ 0 æˆ– 1 æ—¶ï¼Œæ¢¯åº¦è¶‹è¿‘ 0ï¼Œå®¹æ˜“å¯¼è‡´æ¢¯åº¦æ¶ˆå¤±ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-activation-5">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/activation/advanced-guide.md</code></p>
<h3>å˜ä½“ï¼šHard Sigmoidï¼ˆå…¬å¼ 6ï¼‰</h3>
<p><a id="formula-activation-6-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">HardSigmoid</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0074em;vertical-align:-0.686em;"></span><span class="mop">max</span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">min</span><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">))</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šç”¨åˆ†æ®µçº¿æ€§å‡½æ•°è¿‘ä¼¼ Sigmoidï¼ŒæŠŠè¾“å‡ºé™åˆ¶åœ¨ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span>ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼šå½“ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7719em;vertical-align:-0.136em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â‰¤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">âˆ’</span><span class="mord">1</span></span></span></span> è¾“å‡º 0ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7719em;vertical-align:-0.136em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â‰¥</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> è¾“å‡º 1ï¼›ä¸­é—´çº¿æ€§å˜åŒ–ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šç‰ºç‰²ç²¾åº¦æ¢å–æ›´å¿«è®¡ç®—å’Œæ›´ç¨³å®šçš„æ¢¯åº¦ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-activation-6">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/activation/advanced-guide.md</code></p>
<h3>æ•°å­¦å®šä¹‰ï¼ˆå…¬å¼ 7ï¼‰</h3>
<p><a id="formula-activation-7-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">tanh</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.2177em;vertical-align:-0.7693em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.4483em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5904em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6973em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">âˆ’</span><span class="mord mathnormal mtight">x</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7713em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">âˆ’</span><span class="mord mathnormal mtight">x</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="mopen">(</span><span class="mord">2</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šåŒæ›²æ­£åˆ‡æŠŠè¾“å…¥æ˜ å°„åˆ° <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">âˆ’</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span>ï¼Œæ˜¯â€œé›¶ä¸­å¿ƒâ€çš„ Sigmoid å˜ä½“ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> ä¸ºè¾“å…¥ï¼›ç­‰å¼å³ä¾§è¯´æ˜å®ƒä¸ Sigmoid çš„å…³ç³»ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šè¾“å‡ºå‡å€¼æ›´æ¥è¿‘ 0ï¼Œæœ‰åˆ©äºä¼˜åŒ–ï¼Œä½†ä»å¯èƒ½æ¢¯åº¦æ¶ˆå¤±ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-activation-7">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/activation/advanced-guide.md</code></p>
<h3>å¯¼æ•°ï¼ˆå…¬å¼ 8ï¼‰</h3>
<p><a id="formula-activation-8-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0862em;vertical-align:-0.25em;"></span><span class="mop"><span class="mop">tanh</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8362em;"><span style="top:-3.1473em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.1484em;vertical-align:-0.25em;"></span><span class="mop"><span class="mop">tanh</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8984em;"><span style="top:-3.1473em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼štanh çš„æ¢¯åº¦ç”±è¾“å‡ºå€¼å†³å®šï¼Œè¾“å‡ºè¶Šæ¥è¿‘ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">Â±</span><span class="mord">1</span></span></span></span>ï¼Œæ¢¯åº¦è¶Šå°ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0862em;vertical-align:-0.25em;"></span><span class="mop"><span class="mop">tanh</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8362em;"><span style="top:-3.1473em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> æ˜¯å¯¼æ•°ï¼Œè¡¡é‡è¾“å‡ºå¯¹è¾“å…¥çš„å˜åŒ–ç‡ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šå½“æ¿€æ´»é¥±å’Œæ—¶ï¼ˆæ¥è¿‘ -1 æˆ– 1ï¼‰ï¼Œå­¦ä¹ é€Ÿåº¦å˜æ…¢ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-activation-8">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/activation/advanced-guide.md</code></p>
<h3>æ•°å­¦å®šä¹‰ï¼ˆå…¬å¼ 9ï¼‰</h3>
<p><a id="formula-activation-9-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">GELU</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4445em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">Î¦</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4445em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â‰¤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šGELU å°†è¾“å…¥ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> ä¸å…¶è¢«â€œä¿ç•™â€çš„æ¦‚ç‡ç›¸ä¹˜ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆ¼</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.14736em;">N</span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span>ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">Î¦</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> æ˜¯æ ‡å‡†æ­£æ€åˆ†å¸ƒ CDFã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šè¾“å…¥è¶Šå¤§ï¼Œä¿ç•™æ¦‚ç‡è¶Šé«˜ï¼›è¾“å…¥ä¸ºè´Ÿæ—¶ä»å¯èƒ½ä¿ç•™ä¸€éƒ¨åˆ†ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-activation-9">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/activation/advanced-guide.md</code></p>
<h3>æ•°å­¦å®šä¹‰ï¼ˆå…¬å¼ 10ï¼‰</h3>
<p><a id="formula-activation-10-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">Î¦</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord text"><span class="mord">erf</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em;"><span style="top:-2.2028em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9072em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord">2</span></span></span><span style="top:-2.8672em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1328em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">x</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šæ ‡å‡†æ­£æ€åˆ†å¸ƒçš„ç´¯è®¡æ¦‚ç‡å‡½æ•°ï¼ˆCDFï¼‰ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">erf</span></span><span class="mopen">(</span><span class="mord">â‹…</span><span class="mclose">)</span></span></span></span> æ˜¯è¯¯å·®å‡½æ•°ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šç»™å‡º <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8193em;vertical-align:-0.136em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â‰¤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> çš„æ¦‚ç‡ï¼Œç”¨äºå¹³æ»‘åœ°â€œç­›é€‰â€è¾“å…¥ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-activation-10">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/activation/advanced-guide.md</code></p>
<h3>è¿‘ä¼¼å…¬å¼ï¼ˆå…¬å¼ 11ï¼‰</h3>
<p><a id="formula-activation-11-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">GELU</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â‰ˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.5</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.4445em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">(</span></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mop">tanh</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">[</span></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6516em;"><span class="svg-align" style="top:-4.4em;"><span class="pstrut" style="height:4.4em;"></span><span class="mord" style="padding-left:1em;"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">Ï€</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-3.6116em;"><span class="pstrut" style="height:4.4em;"></span><span class="hide-tail" style="min-width:1.02em;height:2.48em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="2.48em" viewBox="0 0 400000 2592" preserveAspectRatio="xMinYMin slice"><path d="M424,2478
c-1.3,-0.7,-38.5,-172,-111.5,-514c-73,-342,-109.8,-513.3,-110.5,-514
c0,-2,-10.7,14.3,-32,49c-4.7,7.3,-9.8,15.7,-15.5,25c-5.7,9.3,-9.8,16,-12.5,20
s-5,7,-5,7c-4,-3.3,-8.3,-7.7,-13,-13s-13,-13,-13,-13s76,-122,76,-122s77,-121,77,-121
s209,968,209,968c0,-2,84.7,-361.7,254,-1079c169.3,-717.3,254.7,-1077.7,256,-1081
l0 -0c4,-6.7,10,-10,18,-10 H400000
v40H1014.6
s-87.3,378.7,-272.6,1166c-185.3,787.3,-279.3,1182.3,-282,1185
c-2,6,-10,9,-24,9
c-8,0,-12,-0.7,-12,-2z M1001 80
h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.7884em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">0.044715</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size4">]</span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size4">)</span></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šç”¨ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mop">tanh</span></span></span></span> è¿‘ä¼¼ GELUï¼Œé¿å…è®¡ç®—è¯¯å·®å‡½æ•°å¸¦æ¥çš„å¼€é”€ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.044715</span></span></span></span> ä¸ºç»éªŒå¸¸æ•°ï¼Œ<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span></span></span></span> æä¾›éçº¿æ€§è°ƒèŠ‚ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šåœ¨ä¿è¯å½¢çŠ¶æ¥è¿‘ GELU çš„åŒæ—¶æå‡è®¡ç®—æ•ˆç‡ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-activation-11">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/activation/advanced-guide.md</code></p>
<h3>è¿‘ä¼¼å…¬å¼ï¼ˆå…¬å¼ 12ï¼‰</h3>
<p><a id="formula-activation-12-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">SiLU</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4445em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šè¾“å…¥ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> ä¸ Sigmoid é—¨æ§åçš„ç»“æœç›¸ä¹˜ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> ä¸º Sigmoidã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šæ—¢ä¿ç•™æ­£å€¼ï¼Œåˆåœ¨è´Ÿå€¼åŒºä¿ç•™å°å“åº”ï¼Œå¹³æ»‘ä¸”éå•è°ƒã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-activation-12">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/activation/advanced-guide.md</code></p>
<h3>å¯¼æ•°ï¼ˆå…¬å¼ 13ï¼‰</h3>
<p><a id="formula-activation-13-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0751em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord text"><span class="mord">GELU</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8251em;"><span style="top:-3.1362em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">Î¦</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.4445em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">Ï•</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šGELU çš„æ¢¯åº¦ç”± CDF å’Œ PDF ä¸¤éƒ¨åˆ†ç»„æˆã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">Ï•</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> æ˜¯æ ‡å‡†æ­£æ€åˆ†å¸ƒçš„æ¦‚ç‡å¯†åº¦å‡½æ•°ï¼ˆPDFï¼‰ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šæ¢¯åº¦éš <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> å¹³æ»‘å˜åŒ–ï¼Œè®­ç»ƒæ›´ç¨³å®šã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-activation-13">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/activation/advanced-guide.md</code></p>
<h3>æ•°å­¦å®šä¹‰ï¼ˆå…¬å¼ 14ï¼‰</h3>
<p><a id="formula-activation-14-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Swish</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4445em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05278em;">Î²</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šåœ¨ Sigmoid é—¨æ§åå†ä¹˜ä»¥è¾“å…¥ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span>ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05278em;">Î²</span></span></span></span> æ§åˆ¶é—¨æ§çš„â€œé™¡å³­åº¦â€ï¼Œå¯ä¸ºå¸¸æ•°æˆ–å¯å­¦ä¹ ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05278em;">Î²</span></span></span></span> è¶Šå¤§ï¼Œå‡½æ•°è¶Šæ¥è¿‘ ReLUï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05278em;">Î²</span></span></span></span> è¶Šå°ï¼Œè¶Šå¹³æ»‘ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-activation-14">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/activation/advanced-guide.md</code></p>
<h3>æ•°å­¦å®šä¹‰ï¼ˆå…¬å¼ 15ï¼‰</h3>
<p><a id="formula-activation-15-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Softmax</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.6484em;vertical-align:-1.307em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3414em;"><span style="top:-2.1288em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">âˆ‘</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.4358em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6065em;"><span style="top:-3.0051em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.307em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šæŠŠä¸€ç»„å®æ•° <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> å˜æˆæ¦‚ç‡åˆ†å¸ƒï¼ˆå’Œä¸º 1ï¼‰ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span> ä¸ºç±»åˆ«æ•°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºç¬¬ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> ç±»çš„æ‰“åˆ†ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šåˆ†æ•°è¶Šå¤§ï¼ŒæŒ‡æ•°æ”¾å¤§æ•ˆåº”è¶Šå¼ºï¼Œæ¦‚ç‡è¶Šé«˜ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-activation-15">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/activation/advanced-guide.md</code></p>
<h3>å¯¼æ•°ï¼ˆå…¬å¼ 16ï¼‰</h3>
<p><a id="formula-activation-16-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.3991em;vertical-align:-0.9721em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="mord text"><span class="mord">Softmax</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.9721em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord text"><span class="mord">Softmax</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03785em;">Î´</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0379em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord text"><span class="mord">Softmax</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">))</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šè¯·ç»“åˆè¯¥ç« èŠ‚ä¸Šä¸‹æ–‡ç†è§£è¯¥å…¬å¼çš„è®¡ç®—ç›®æ ‡ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼šå˜é‡å®šä¹‰æ²¿ç”¨åŸç« èŠ‚ä¸­çš„ç¬¦å·çº¦å®šã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šè¯¥å…¬å¼ç”¨äºåˆ»ç”»è¯¥ä¸»é¢˜çš„æ ¸å¿ƒæœºåˆ¶ä¸å·¥ç¨‹ä½œç”¨ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-activation-16">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/activation/advanced-guide.md</code></p>
<h3>æ•°å€¼ç¨³å®šæ€§ï¼ˆå…¬å¼ 17ï¼‰</h3>
<p><a id="formula-activation-17-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Softmax</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.872em;vertical-align:-1.307em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.565em;"><span style="top:-2.1288em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">âˆ‘</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.4358em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8301em;"><span style="top:-3.0051em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span></span></span></span></span></span></span><span class="mbin mtight">âˆ’</span><span class="mop mtight"><span class="mtight">m</span><span class="mtight">a</span><span class="mtight">x</span></span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">x</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mbin mtight">âˆ’</span><span class="mop mtight"><span class="mtight">m</span><span class="mtight">a</span><span class="mtight">x</span></span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">x</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.307em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šåœ¨æ‰€æœ‰ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸Šå‡å»æœ€å¤§å€¼ä¸æ”¹å˜ç»“æœï¼Œä½†é¿å…æŒ‡æ•°æº¢å‡ºã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">max</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> ä¸ºæ‰€æœ‰è¾“å…¥ä¸­çš„æœ€å¤§å€¼ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šæ•°å€¼ç¨³å®šæ€§æŠ€å·§ï¼Œè¾“å‡ºæ¦‚ç‡ä¸å˜ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-activation-17">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/activation/advanced-guide.md</code></p>
<h3>æ¸©åº¦å‚æ•° (Temperature)ï¼ˆå…¬å¼ 18ï¼‰</h3>
<p><a id="formula-activation-18-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Softmax</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.872em;vertical-align:-1.307em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.565em;"><span style="top:-2.1288em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">âˆ‘</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.4358em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8301em;"><span style="top:-3.0051em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span></span></span></span></span></span></span><span class="mord mtight">/</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mord mtight">/</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.307em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šåŠ å…¥æ¸©åº¦å‚æ•° <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span> æ¥æ§åˆ¶åˆ†å¸ƒçš„â€œå°–é”ç¨‹åº¦â€ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span> è¶Šå¤§ï¼Œåˆ†å¸ƒè¶Šå¹³æ»‘ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span> è¶Šå°ï¼Œåˆ†å¸ƒè¶Šå°–é”ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šå¯ç”¨äºé‡‡æ ·æ—¶æ§åˆ¶éšæœºæ€§ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-activation-18">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/activation/advanced-guide.md</code></p>
<h2>æ³¨æ„åŠ›æœºåˆ¶</h2>
<h3>æ•°å­¦å®šä¹‰ï¼ˆå…¬å¼ 1ï¼‰</h3>
<p><a id="formula-attention-1-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Attention</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4684em;vertical-align:-0.95em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.2528em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šè¯·ç»“åˆè¯¥ç« èŠ‚ä¸Šä¸‹æ–‡ç†è§£è¯¥å…¬å¼çš„è®¡ç®—ç›®æ ‡ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼šå˜é‡å®šä¹‰æ²¿ç”¨åŸç« èŠ‚ä¸­çš„ç¬¦å·çº¦å®šã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šè¯¥å…¬å¼ç”¨äºåˆ»ç”»è¯¥ä¸»é¢˜çš„æ ¸å¿ƒæœºåˆ¶ä¸å·¥ç¨‹ä½œç”¨ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-attention-1">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/attention/advanced-guide.md</code></p>
<h3>ä¸ºä»€ä¹ˆé™¤ä»¥ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.04em;vertical-align:-0.1828em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice">&lt;path d=&quot;M95,702</h3>
<p>c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z&quot;/&gt;</svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span></span></span></span></span></span></span></span></span>ï¼Ÿï¼ˆå…¬å¼ 2ï¼‰</p>
<p><a id="formula-attention-2-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="mord text"><span class="mord">Var</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.2528em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.2074em;vertical-align:-0.836em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šç¼©æ”¾åçš„ç‚¹ç§¯æ–¹å·®è¢«å½’ä¸€åˆ° 1ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> æ˜¯ç‚¹ç§¯ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Var</span></span><span class="mopen">(</span><span class="mord">â‹…</span><span class="mclose">)</span></span></span></span> æ˜¯æ–¹å·®ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šé¿å… softmax è¾“å…¥è¿‡å¤§å¯¼è‡´æ¢¯åº¦é¥±å’Œã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-attention-2">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/attention/advanced-guide.md</code></p>
<h3>Self-Attentionï¼ˆå…¬å¼ 3ï¼‰</h3>
<p><a id="formula-attention-3-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0858em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0858em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8913em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šè¯·ç»“åˆè¯¥ç« èŠ‚ä¸Šä¸‹æ–‡ç†è§£è¯¥å…¬å¼çš„è®¡ç®—ç›®æ ‡ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼šå˜é‡å®šä¹‰æ²¿ç”¨åŸç« èŠ‚ä¸­çš„ç¬¦å·çº¦å®šã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šè¯¥å…¬å¼ç”¨äºåˆ»ç”»è¯¥ä¸»é¢˜çš„æ ¸å¿ƒæœºåˆ¶ä¸å·¥ç¨‹ä½œç”¨ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-attention-3">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/attention/advanced-guide.md</code></p>
<h3>æ•°å­¦å®šä¹‰ï¼ˆå…¬å¼ 4ï¼‰</h3>
<p><a id="formula-attention-4-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">MultiHead</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1413em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Concat</span></span><span class="mopen">(</span><span class="mord"><span class="mord text"><span class="mord">head</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">â€¦</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord text"><span class="mord">head</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">h</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">O</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šè¯·ç»“åˆè¯¥ç« èŠ‚ä¸Šä¸‹æ–‡ç†è§£è¯¥å…¬å¼çš„è®¡ç®—ç›®æ ‡ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼šå˜é‡å®šä¹‰æ²¿ç”¨åŸç« èŠ‚ä¸­çš„ç¬¦å·çº¦å®šã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šè¯¥å…¬å¼ç”¨äºåˆ»ç”»è¯¥ä¸»é¢˜çš„æ ¸å¿ƒæœºåˆ¶ä¸å·¥ç¨‹ä½œç”¨ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-attention-4">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/attention/advanced-guide.md</code></p>
<h3>æ•°å­¦å®šä¹‰ï¼ˆå…¬å¼ 5ï¼‰</h3>
<p><a id="formula-attention-5-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord text"><span class="mord">head</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2361em;vertical-align:-0.2769em;"></span><span class="mord text"><span class="mord">Attention</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9592em;"><span style="top:-2.4231em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.1809em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2769em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šå°†æ³¨æ„åŠ›åˆ†æˆ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">h</span></span></span></span> ä¸ªå­ç©ºé—´å¹¶è¡Œè®¡ç®—ï¼Œæœ€åæ‹¼æ¥å¹¶çº¿æ€§æ˜ å°„ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">h</span></span></span></span> ä¸ºå¤´æ•°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2361em;vertical-align:-0.2769em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9592em;"><span style="top:-2.4231em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.1809em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2769em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4413em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4413em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºæ¯ä¸ªå¤´çš„æŠ•å½±çŸ©é˜µï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">O</span></span></span></span></span></span></span></span></span></span></span> ä¸ºè¾“å‡ºæ˜ å°„ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šä¸åŒå¤´å…³æ³¨ä¸åŒå…³ç³»ï¼Œæå‡è¡¨è¾¾èƒ½åŠ›ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-attention-5">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/attention/advanced-guide.md</code></p>
<h3>Padding Maskï¼ˆå…¬å¼ 6ï¼‰</h3>
<p><a id="formula-attention-6-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord">âˆ’</span><span class="mord">âˆ</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">ifÂ </span></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mord text"><span class="mord">Â isÂ valid</span></span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">ifÂ </span></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mord text"><span class="mord">Â isÂ padding</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šå¯¹ padding ä½ç½®æ–½åŠ  <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord">âˆ’</span><span class="mord">âˆ</span></span></span></span>ï¼Œä½¿ softmax åæƒé‡å˜ä¸º 0ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºæ³¨æ„åŠ›åˆ†æ•°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span> ä¸ºè¢«å…³æ³¨ä½ç½®ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šè®©æ¨¡å‹å¿½ç•¥æ— æ•ˆå¡«å……ä½ç½®ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-attention-6">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/attention/advanced-guide.md</code></p>
<h3>Causal Mask (Look-ahead Mask)ï¼ˆå…¬å¼ 7ï¼‰</h3>
<p><a id="formula-attention-7-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord">âˆ’</span><span class="mord">âˆ</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">ifÂ </span></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â‰¤</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal">i</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">ifÂ </span></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šè¯·ç»“åˆè¯¥ç« èŠ‚ä¸Šä¸‹æ–‡ç†è§£è¯¥å…¬å¼çš„è®¡ç®—ç›®æ ‡ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼šå˜é‡å®šä¹‰æ²¿ç”¨åŸç« èŠ‚ä¸­çš„ç¬¦å·çº¦å®šã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šè¯¥å…¬å¼ç”¨äºåˆ»ç”»è¯¥ä¸»é¢˜çš„æ ¸å¿ƒæœºåˆ¶ä¸å·¥ç¨‹ä½œç”¨ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-attention-7">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/attention/advanced-guide.md</code></p>
<h3>Causal Mask (Look-ahead Mask)ï¼ˆå…¬å¼ 8ï¼‰</h3>
<p><a id="formula-attention-8-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Attention</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4684em;vertical-align:-0.95em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.2528em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šç”¨æ©ç  <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span></span> æŠŠæœªæ¥ä½ç½®çš„æ³¨æ„åŠ›åˆ†æ•°ç½®ä¸º <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord">âˆ’</span><span class="mord">âˆ</span></span></span></span>ï¼Œä¿è¯å› æœæ€§ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> è¡¨ç¤ºä½ç½® <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> æ˜¯å¦å…è®¸çœ‹ä½ç½® <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span>ï¼›å…è®¸ä¸º 0ï¼Œä¸å…è®¸ä¸º <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord">âˆ’</span><span class="mord">âˆ</span></span></span></span>ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šè§£ç å™¨ç”Ÿæˆæ—¶åªèƒ½çœ‹â€œè¿‡å»â€ï¼Œé¿å…ä¿¡æ¯æ³„éœ²ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-attention-8">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/attention/advanced-guide.md</code></p>
<h3>Cross-Attentionï¼ˆå…¬å¼ 9ï¼‰</h3>
<p><a id="formula-attention-9-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0858em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">ec</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0858em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0413em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šè¯·ç»“åˆè¯¥ç« èŠ‚ä¸Šä¸‹æ–‡ç†è§£è¯¥å…¬å¼çš„è®¡ç®—ç›®æ ‡ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼šå˜é‡å®šä¹‰æ²¿ç”¨åŸç« èŠ‚ä¸­çš„ç¬¦å·çº¦å®šã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šè¯¥å…¬å¼ç”¨äºåˆ»ç”»è¯¥ä¸»é¢˜çš„æ ¸å¿ƒæœºåˆ¶ä¸å·¥ç¨‹ä½œç”¨ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-attention-9">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/attention/advanced-guide.md</code></p>
<h2>å½’ä¸€åŒ–</h2>
<h3>æ•°å­¦å®šä¹‰ï¼ˆå…¬å¼ 1ï¼‰</h3>
<p><a id="formula-normalization-1-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">x</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.3903em;vertical-align:-1.13em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.2603em;"><span style="top:-2.1777em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9323em;"><span class="svg-align" style="top:-3.2em;"><span class="pstrut" style="height:3.2em;"></span><span class="mord" style="padding-left:1em;"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7959em;"><span style="top:-2.3987em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.0448em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3013em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">Ïµ</span></span></span><span style="top:-2.8923em;"><span class="pstrut" style="height:3.2em;"></span><span class="hide-tail" style="min-width:1.02em;height:1.28em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.28em" viewBox="0 0 400000 1296" preserveAspectRatio="xMinYMin slice"><path d="M263,681c0.7,0,18,39.7,52,119
c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120
c340,-704.7,510.7,-1060.3,512,-1067
l0 -0
c4.7,-7.3,11,-11,19,-11
H40000v40H1012.3
s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232
c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1
s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26
c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z
M1001 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3077em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">Î¼</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.13em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šè¯·ç»“åˆè¯¥ç« èŠ‚ä¸Šä¸‹æ–‡ç†è§£è¯¥å…¬å¼çš„è®¡ç®—ç›®æ ‡ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼šå˜é‡å®šä¹‰æ²¿ç”¨åŸç« èŠ‚ä¸­çš„ç¬¦å·çº¦å®šã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šè¯¥å…¬å¼ç”¨äºåˆ»ç”»è¯¥ä¸»é¢˜çš„æ ¸å¿ƒæœºåˆ¶ä¸å·¥ç¨‹ä½œç”¨ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-normalization-1">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/normalization/advanced-guide.md</code></p>
<h3>æ•°å­¦å®šä¹‰ï¼ˆå…¬å¼ 2ï¼‰</h3>
<p><a id="formula-normalization-2-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05556em;">Î³</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0556em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">x</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">Î²</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šå¯¹æ¯ä¸ªç‰¹å¾ç»´åº¦ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span>ï¼Œå‡å» batch å†…å‡å€¼ã€é™¤ä»¥æ ‡å‡†å·®ï¼Œå†ç¼©æ”¾å¹³ç§»ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0972em;vertical-align:-0.2831em;"></span><span class="mord"><span class="mord mathnormal">Î¼</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4169em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2831em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºç¬¬ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> ç»´åœ¨ batch å†…çš„å‡å€¼å’Œæ–¹å·®ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05556em;">Î³</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0556em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">Î²</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºå¯å­¦ä¹ çš„ç¼©æ”¾å’Œåç§»å‚æ•°ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šå°†æ¯ç»´ç‰¹å¾å½’ä¸€åŒ–åˆ°æ ‡å‡†åˆ†å¸ƒï¼Œå†é€šè¿‡ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">Î³</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.05278em;">Î²</span></span></span></span> æ¢å¤è¡¨è¾¾èƒ½åŠ›ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">Ïµ</span></span></span></span> é˜²æ­¢é™¤é›¶ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-normalization-2">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/normalization/advanced-guide.md</code></p>
<h3>æ¢¯åº¦è®¡ç®—ï¼ˆå…¬å¼ 3ï¼‰</h3>
<p><a id="formula-normalization-3-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.2074em;vertical-align:-0.836em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="mord mathnormal">L</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.1638em;vertical-align:-1.4138em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em;"><span style="top:-2.1966em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9134em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">Ïµ</span></span></span><span style="top:-2.8734em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1266em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05556em;">Î³</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="mord mathnormal">L</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.8804em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">m</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.4138em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="mord mathnormal">L</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.9721em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">m</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">x</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.4138em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="mord mathnormal">L</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.9721em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">x</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size4">)</span></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šBatchNorm åå‘ä¼ æ’­æ—¶ï¼Œæ¢¯åº¦ä¸ä»…ä¾èµ–è‡ªèº«è¾“å‡ºï¼Œè¿˜ä¸ batch å†…æ‰€æœ‰æ ·æœ¬ç›¸å…³ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span> ä¸º batch å¤§å°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">x</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºå½’ä¸€åŒ–åçš„å€¼ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="mord mathnormal">L</span><span class="mord">/</span><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºä¸Šæ¸¸æ¢¯åº¦ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šå½’ä¸€åŒ–æ“ä½œçš„æ¢¯åº¦ä¼š&quot;åˆ†æ•£&quot;åˆ°æ•´ä¸ª batchï¼Œå¢åŠ è®­ç»ƒçš„æ­£è§„åŒ–æ•ˆæœã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-normalization-3">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/normalization/advanced-guide.md</code></p>
<h3>æ•°å­¦å®šä¹‰ï¼ˆå…¬å¼ 4ï¼‰</h3>
<p><a id="formula-normalization-4-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Î¼</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.106em;vertical-align:-1.2777em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.08125em;">H</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šè¯·ç»“åˆè¯¥ç« èŠ‚ä¸Šä¸‹æ–‡ç†è§£è¯¥å…¬å¼çš„è®¡ç®—ç›®æ ‡ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼šå˜é‡å®šä¹‰æ²¿ç”¨åŸç« èŠ‚ä¸­çš„ç¬¦å·çº¦å®šã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šè¯¥å…¬å¼ç”¨äºåˆ»ç”»è¯¥ä¸»é¢˜çš„æ ¸å¿ƒæœºåˆ¶ä¸å·¥ç¨‹ä½œç”¨ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-normalization-4">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/normalization/advanced-guide.md</code></p>
<h3>æ•°å­¦å®šä¹‰ï¼ˆå…¬å¼ 5ï¼‰</h3>
<p><a id="formula-normalization-5-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8641em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.106em;vertical-align:-1.2777em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.08125em;">H</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.1141em;vertical-align:-0.25em;"></span><span class="mord mathnormal">Î¼</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šè¯·ç»“åˆè¯¥ç« èŠ‚ä¸Šä¸‹æ–‡ç†è§£è¯¥å…¬å¼çš„è®¡ç®—ç›®æ ‡ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼šå˜é‡å®šä¹‰æ²¿ç”¨åŸç« èŠ‚ä¸­çš„ç¬¦å·çº¦å®šã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šè¯¥å…¬å¼ç”¨äºåˆ»ç”»è¯¥ä¸»é¢˜çš„æ ¸å¿ƒæœºåˆ¶ä¸å·¥ç¨‹ä½œç”¨ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-normalization-5">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/normalization/advanced-guide.md</code></p>
<h3>æ•°å­¦å®šä¹‰ï¼ˆå…¬å¼ 6ï¼‰</h3>
<p><a id="formula-normalization-6-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0376em;vertical-align:-0.93em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em;"><span style="top:-2.1966em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9134em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">Ïµ</span></span></span><span style="top:-2.8734em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1266em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05556em;">Î³</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âŠ™</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">Î¼</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05278em;">Î²</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šå¯¹å•ä¸ªæ ·æœ¬çš„æ‰€æœ‰ç‰¹å¾ç»´è®¡ç®—å‡å€¼å’Œæ–¹å·®ï¼Œç„¶åå½’ä¸€åŒ–ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span></span></span></span> ä¸ºç‰¹å¾ç»´åº¦æ•°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0085em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Î¼</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span> ä¸ºå•æ ·æœ¬å†…çš„ç»Ÿè®¡é‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">Î³</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.05278em;">Î²</span></span></span></span> ä¸ºå¯å­¦ä¹ å‚æ•°ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šä¸ BatchNorm ä¸åŒï¼Œä¸ä¾èµ– batch å¤§å°ï¼Œé€‚åˆåºåˆ—æ¨¡å‹å’Œ NLP ä»»åŠ¡ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-normalization-6">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/normalization/advanced-guide.md</code></p>
<h3>æ•°å­¦å®šä¹‰ï¼ˆå…¬å¼ 7ï¼‰</h3>
<p><a id="formula-normalization-7-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">RMS</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.3338em;vertical-align:-1.2777em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.0561em;"><span class="svg-align" style="top:-5.2938em;"><span class="pstrut" style="height:5.2938em;"></span><span class="mord" style="padding-left:1.056em;"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.08125em;">H</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7959em;"><span style="top:-2.4231em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.0448em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2769em;"><span></span></span></span></span></span></span></span></span><span style="top:-4.0161em;"><span class="pstrut" style="height:5.2938em;"></span><span class="hide-tail" style="min-width:0.742em;height:3.3738em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="3.3738em" viewBox="0 0 400000 3373" preserveAspectRatio="xMinYMin slice"><path d="M702 80H40000040
H742v3239l-4 4-4 4c-.667.7 -2 1.5-4 2.5s-4.167 1.833-6.5 2.5-5.5 1-9.5 1
h-12l-28-84c-16.667-52-96.667 -294.333-240-727l-212 -643 -85 170
c-4-3.333-8.333-7.667-13 -13l-13-13l77-155 77-156c66 199.333 139 419.667
219 661 l218 661zM702 80H400000v40H742z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šè¯·ç»“åˆè¯¥ç« èŠ‚ä¸Šä¸‹æ–‡ç†è§£è¯¥å…¬å¼çš„è®¡ç®—ç›®æ ‡ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼šå˜é‡å®šä¹‰æ²¿ç”¨åŸç« èŠ‚ä¸­çš„ç¬¦å·çº¦å®šã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šè¯¥å…¬å¼ç”¨äºåˆ»ç”»è¯¥ä¸»é¢˜çš„æ ¸å¿ƒæœºåˆ¶ä¸å·¥ç¨‹ä½œç”¨ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-normalization-7">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/normalization/advanced-guide.md</code></p>
<h3>æ•°å­¦å®šä¹‰ï¼ˆå…¬å¼ 8ï¼‰</h3>
<p><a id="formula-normalization-8-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0436em;vertical-align:-0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord text"><span class="mord">RMS</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">x</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">Î³</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šåªç”¨å‡æ–¹ï¿½ï¿½å½’ä¸€åŒ–ï¼Œçœå»å‡å€¼è®¡ç®—ï¼Œå†ä¹˜ä»¥å¯å­¦ä¹ ç¼©æ”¾å› å­ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">RMS</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> ä¸ºå‡æ–¹æ ¹å€¼ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">Î³</span></span></span></span> ä¸ºç¼©æ”¾å‚æ•°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span></span></span></span> ä¸ºç‰¹å¾ç»´åº¦æ•°ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šç®€åŒ–è®¡ç®—ä½†ä¿æŒå½’ä¸€åŒ–æ•ˆæœï¼ŒLLaMA ç­‰ç°ä»£ LLM å¹¿æ³›ä½¿ç”¨ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-normalization-8">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/normalization/advanced-guide.md</code></p>
<h3>æ•°å­¦å®šä¹‰ï¼ˆå…¬å¼ 9ï¼‰</h3>
<p><a id="formula-normalization-9-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.8376em;vertical-align:-1.73em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em;"><span style="top:-2.11em;"><span class="pstrut" style="height:3.3031em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3031em;"><span class="svg-align" style="top:-3.8em;"><span class="pstrut" style="height:3.8em;"></span><span class="mord" style="padding-left:1em;"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.08125em;">H</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">âˆ‘</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.08125em;">H</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7959em;"><span style="top:-2.4231em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.0448em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2769em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">Ïµ</span></span></span><span style="top:-3.2631em;"><span class="pstrut" style="height:3.8em;"></span><span class="hide-tail" style="min-width:1.02em;height:1.88em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.88em" viewBox="0 0 400000 1944" preserveAspectRatio="xMinYMin slice"><path d="M983 90
l0 -0
c4,-6.7,10,-10,18,-10 H400000v40
H1013.1s-83.4,268,-264.1,840c-180.7,572,-277,876.3,-289,913c-4.7,4.7,-12.7,7,-24,7
s-12,0,-12,0c-1.3,-3.3,-3.7,-11.7,-7,-25c-35.3,-125.3,-106.7,-373.3,-214,-744
c-10,12,-21,25,-33,39s-32,39,-32,39c-6,-5.3,-15,-14,-27,-26s25,-30,25,-30
c26.7,-32.7,52,-63,76,-91s52,-60,52,-60s208,722,208,722
c56,-175.3,126.3,-397.3,211,-666c84.7,-268.7,153.8,-488.2,207.5,-658.5
c53.7,-170.3,84.5,-266.8,92.5,-289.5z
M1001 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.5369em;"><span></span></span></span></span></span></span></span><span style="top:-3.5331em;"><span class="pstrut" style="height:3.3031em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.9801em;"><span class="pstrut" style="height:3.3031em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05556em;">Î³</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.73em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šå°† RMSNorm å†™æˆä¸ LayerNorm ç±»ä¼¼çš„å½¢å¼ï¼Œæ–¹ä¾¿å¯¹æ¯”ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼šåˆ†æ¯æ˜¯å‡æ–¹æ ¹åŠ  <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">Ïµ</span></span></span></span>ï¼Œåˆ†å­æ˜¯ç¼©æ”¾å‚æ•° <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">Î³</span></span></span></span>ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šä¸ LayerNorm çš„åŒºåˆ«åœ¨äºæ²¡æœ‰ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">Î¼</span><span class="mclose">)</span></span></span></span>ï¼Œå³ä¸åšä¸­å¿ƒåŒ–ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-normalization-9">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/normalization/advanced-guide.md</code></p>
<h2>å‰é¦ˆç½‘ç»œ</h2>
<h3>æ•°å­¦å®šä¹‰ï¼ˆå…¬å¼ 1ï¼‰</h3>
<p><a id="formula-ffn-1-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">FFN</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">GELU</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šå…ˆå‡ç»´åˆ° <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>ï¼Œç» GELU æ¿€æ´»åå†é™ç»´å› <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> ä¸ºè¾“å…¥å‘é‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºæƒé‡çŸ©é˜µï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºåç½®ï¼›GELU ä¸ºæ¿€æ´»å‡½æ•°ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šå®ƒçš„æ ¸å¿ƒä½œç”¨æ˜¯è®©æ¨¡å‹æ›´å®¹æ˜“æå–æœ‰ç”¨ä¿¡æ¯ã€å‹åˆ¶å™ªå£°ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-ffn-1">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/ffn/advanced-guide.md</code></p>
<h3>Position-wise å«ä¹‰ï¼ˆå…¬å¼ 2ï¼‰</h3>
<p><a id="formula-ffn-2-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord text"><span class="mord">FFN</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mrel mtight">:</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord text"><span class="mord">FFN</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mrel mtight">:</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šåºåˆ—ä¸­æ¯ä¸ªä½ç½®çš„å‘é‡ç‹¬ç«‹é€šè¿‡åŒä¸€ä¸ª FFN å˜æ¢ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mrel mtight">:</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºç¬¬ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> ä¸ªä½ç½®çš„å‘é‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord text"><span class="mord">FFN</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mrel mtight">:</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºå…¶å˜æ¢åè¾“å‡ºã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šå„ä½ç½®å…±äº«å‚æ•°ä½†ç‹¬ç«‹å¤„ç†ï¼Œä¿è¯ä½ç½®é—´ä¿¡æ¯ä¸ä¸²æ‰°ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-ffn-2">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/ffn/advanced-guide.md</code></p>
<h3>å‚æ•°é‡åˆ†æï¼ˆå…¬å¼ 3ï¼‰</h3>
<p><a id="formula-ffn-3-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">F</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">F</span><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šFFN å‚æ•°é‡ = ä¸¤ä¸ªæƒé‡çŸ©é˜µ + ä¸¤ä¸ªåç½®å‘é‡ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºè¾“å…¥/è¾“å‡ºç»´åº¦ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºä¸­é—´éšè—ç»´åº¦ï¼ˆé€šå¸¸ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord">4</span><span class="mord mathnormal">d</span></span></span></span>ï¼‰ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šå‚æ•°é‡ä¸ç»´åº¦å¹³æ–¹æˆæ­£æ¯”ï¼ŒFFN çº¦å  Transformer æ€»å‚æ•°çš„ 2/3ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-ffn-3">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/ffn/advanced-guide.md</code></p>
<h3>å‚æ•°é‡åˆ†æï¼ˆå…¬å¼ 4ï¼‰</h3>
<p><a id="formula-ffn-4-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">F</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">F</span><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">768</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">3072</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">768</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3072</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em;"></span><span class="mord">4</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">722</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">432</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šä»£å…¥å…·ä½“æ•°å€¼è®¡ç®— BERT-Base æ¯å±‚ FFN çš„å‚æ•°é‡ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">768</span></span></span></span> ä¸ºéšè—ç»´åº¦ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3072</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">768</span></span></span></span> ä¸ºä¸­é—´ç»´åº¦ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šçº¦ 470 ä¸‡å‚æ•°ï¼Œæ˜¯ BERT-Base å‚æ•°é‡çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-ffn-4">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/ffn/advanced-guide.md</code></p>
<h3>ReLUï¼ˆå…¬å¼ 5ï¼‰</h3>
<p><a id="formula-ffn-5-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord text"><span class="mord">FFN</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.00773em;">R</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.10903em;">LU</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">max</span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">x</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šç”¨ ReLU æ¿€æ´»ï¼Œå°†è´Ÿå€¼æˆªæ–­ä¸º 0ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal">x</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºå‡ç»´åçš„ç»“æœï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">max</span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">â‹…</span><span class="mclose">)</span></span></span></span> ä¸ºé€å…ƒç´  ReLUã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šè®¡ç®—ç®€å•ï¼Œæ­£åŒºé—´æ¢¯åº¦ç¨³å®šï¼Œæ˜¯åŸå§‹ Transformer çš„é€‰æ‹©ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-ffn-5">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/ffn/advanced-guide.md</code></p>
<h3>GELUï¼ˆå…¬å¼ 6ï¼‰</h3>
<p><a id="formula-ffn-6-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord text"><span class="mord">FFN</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">GE</span><span class="mord mathnormal mtight" style="margin-right:0.10903em;">LU</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">GELU</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šç”¨ GELU æ›¿ä»£ ReLUï¼Œåœ¨ 0 é™„è¿‘æ›´å¹³æ»‘ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼šGELU ä¸ºé«˜æ–¯è¯¯å·®çº¿æ€§å•å…ƒï¼Œä¸æ­£æ€åˆ†å¸ƒ CDF ç›¸å…³ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šå¹³æ»‘è¿‡æ¸¡é¿å…ç¡¬æˆªæ–­ï¼Œè®­ç»ƒæ›´ç¨³å®šï¼ŒBERT/GPT ä½¿ç”¨ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-ffn-6">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/ffn/advanced-guide.md</code></p>
<h3>Swish/SiLUï¼ˆå…¬å¼ 7ï¼‰</h3>
<p><a id="formula-ffn-7-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord text"><span class="mord">FFN</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">h</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âŠ™</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">))</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šç”¨ Swish æ¿€æ´»ï¼Œè¾“å…¥ä¸ sigmoid é—¨æ§çš„ä¹˜ç§¯ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord">âŠ™</span></span></span></span> ä¸ºé€å…ƒç´ ä¹˜æ³•ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span></span></span></span> ä¸º Sigmoid å‡½æ•°ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šéå•è°ƒã€æœ‰ä¸‹ç•Œæ— ä¸Šç•Œï¼Œæ·±å±‚ç½‘ç»œæ•ˆæœæ›´å¥½ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-ffn-7">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/ffn/advanced-guide.md</code></p>
<h3>GLU (Gated Linear Unit)ï¼ˆå…¬å¼ 8ï¼‰</h3>
<p><a id="formula-ffn-8-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">GLU</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âŠ™</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šä¸¤ä¸ªå¹¶è¡Œçº¿æ€§å˜æ¢ï¼Œä¸€ä¸ªä½œä¸ºé—¨æ§ä¿¡å·æ§åˆ¶å¦ä¸€ä¸ªã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span> ä¸ºä¸¤ç»„æƒé‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span></span></span></span> ä¸ºé—¨æ§å€¼ï¼ˆ0-1ï¼‰ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord">âŠ™</span></span></span></span> ä¸ºé€å…ƒç´ ä¹˜ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šé—¨æ§æœºåˆ¶è®©æ¨¡å‹è‡ªé€‚åº”é€‰æ‹©å“ªäº›ä¿¡æ¯é€šè¿‡ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-ffn-8">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/ffn/advanced-guide.md</code></p>
<h3>SwiGLUï¼ˆå…¬å¼ 9ï¼‰</h3>
<p><a id="formula-ffn-9-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">SwiGLU</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Swish</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âŠ™</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šç”¨ Swish æ›¿ä»£ Sigmoid ä½œä¸ºé—¨æ§æ¿€æ´»ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Swish</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4445em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span>ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span> ä¸ºä¸¤ç»„æƒé‡ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šSwish æ¯” Sigmoid æ›´å¹³æ»‘ï¼ŒLLaMA ç­‰ç°ä»£ LLM é‡‡ç”¨ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-ffn-9">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/ffn/advanced-guide.md</code></p>
<h3>SwiGLUï¼ˆå…¬å¼ 10ï¼‰</h3>
<p><a id="formula-ffn-10-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">SwiGLU</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âŠ™</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mclose">))</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âŠ™</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šè¯·ç»“åˆè¯¥ç« èŠ‚ä¸Šä¸‹æ–‡ç†è§£è¯¥å…¬å¼çš„è®¡ç®—ç›®æ ‡ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼šå˜é‡å®šä¹‰æ²¿ç”¨åŸç« èŠ‚ä¸­çš„ç¬¦å·çº¦å®šã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šè¯¥å…¬å¼ç”¨äºåˆ»ç”»è¯¥ä¸»é¢˜çš„æ ¸å¿ƒæœºåˆ¶ä¸å·¥ç¨‹ä½œç”¨ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-ffn-10">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/ffn/advanced-guide.md</code></p>
<h3>GeGLUï¼ˆå…¬å¼ 11ï¼‰</h3>
<p><a id="formula-ffn-11-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">GeGLU</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">GELU</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âŠ™</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šç”¨ GELU æ›¿ä»£ Sigmoid ä½œä¸ºé—¨æ§æ¿€æ´»ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼šGELU ä¸ºé«˜æ–¯è¯¯å·®çº¿æ€§å•å…ƒï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span> ä¸ºä¸¤ç»„æƒé‡ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šGELU çš„å¹³æ»‘æ€§å¸¦æ¥æ›´å¥½çš„è®­ç»ƒç¨³å®šæ€§ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-ffn-11">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/ffn/advanced-guide.md</code></p>
<h2>ç¼–ç å™¨</h2>
<h3>å•å±‚ç»“æ„ï¼ˆå…¬å¼ 1ï¼‰</h3>
<p><a id="formula-encoder-1-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">Output</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">LayerNorm</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Sublayer</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">))</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šæ®‹å·®è¿æ¥å°†è¾“å…¥ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> ä¸å­å±‚è¾“å‡ºç›¸åŠ ï¼Œå†é€šè¿‡å±‚å½’ä¸€åŒ–å¾—åˆ°æœ€ç»ˆè¾“å‡ºã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> ä¸ºå­å±‚è¾“å…¥ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Sublayer</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> ä¸ºæ³¨æ„åŠ›æˆ–å‰é¦ˆç½‘ç»œçš„è¾“å‡ºï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">LayerNorm</span></span></span></span></span> ä¸ºå±‚å½’ä¸€åŒ–æ“ä½œã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šæ®‹å·®è¿æ¥è®©æ¢¯åº¦å¯ä»¥ç›´æ¥æµè¿‡ï¼Œç¼“è§£æ·±å±‚ç½‘ç»œçš„æ¢¯åº¦æ¶ˆå¤±ï¼›å±‚å½’ä¸€åŒ–ç¨³å®šæ¯å±‚çš„è¾“å…¥åˆ†å¸ƒã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-encoder-1">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/encoder/advanced-guide.md</code></p>
<h3>å®Œæ•´å…¬å¼ï¼ˆå…¬å¼ 2ï¼‰</h3>
<p><a id="formula-encoder-2-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">LayerNorm</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">MultiHead</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mclose">))</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šå¯¹è¾“å…¥ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span> åšå¤šå¤´è‡ªæ³¨æ„åŠ›ï¼ŒåŠ æ®‹å·®åå†åšå±‚å½’ä¸€åŒ–ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span> ä¸ºè¾“å…¥åºåˆ—ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord">MultiHead</span></span></span></span></span> ä¸ºå¤šå¤´æ³¨æ„åŠ›ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span></span></span></span> ä¸ºå­å±‚è¾“å‡ºã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šè®©æ¯ä¸ªä½ç½®éƒ½èƒ½&quot;çœ‹åˆ°&quot;å…¨åºåˆ—ä¿¡æ¯ï¼Œæ®‹å·®å’Œå½’ä¸€åŒ–ä¿è¯è®­ç»ƒç¨³å®šã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-encoder-2">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/encoder/advanced-guide.md</code></p>
<h3>å®Œæ•´å…¬å¼ï¼ˆå…¬å¼ 3ï¼‰</h3>
<p><a id="formula-encoder-3-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">LayerNorm</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">FFN</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mclose">))</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šå¯¹æ³¨æ„åŠ›è¾“å‡º <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span></span></span></span> åšå‰é¦ˆç½‘ç»œå˜æ¢ï¼ŒåŠ æ®‹å·®åå†å±‚å½’ä¸€åŒ–ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span></span></span></span> ä¸ºä¸Šä¸€å±‚è¾“å‡ºï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord text"><span class="mord">FFN</span></span></span></span></span> ä¸ºé€ä½ç½®å‰é¦ˆç½‘ç»œï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span></span></span></span> ä¸ºæœ€ç»ˆå±‚è¾“å‡ºã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šFFN å¯¹æ¯ä¸ªä½ç½®ç‹¬ç«‹åšéçº¿æ€§ç‰¹å¾æå–ï¼Œå¢å¼ºè¡¨è¾¾èƒ½åŠ›ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-encoder-3">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/encoder/advanced-guide.md</code></p>
<h3>å®Œæ•´å…¬å¼ï¼ˆå…¬å¼ 4ï¼‰</h3>
<p><a id="formula-encoder-4-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">FFN</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">GELU</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šå…ˆå‡ç»´å†åš GELU æ¿€æ´»ï¼Œæœ€åé™ç»´å›åŸç»´åº¦ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> å‡ç»´åˆ° <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord">4</span><span class="mord mathnormal">d</span></span></span></span>ï¼Œ<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> é™å› <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span>ï¼›GELU ä¸ºå¹³æ»‘æ¿€æ´»å‡½æ•°ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šæ‰©å±•ä¸­é—´ç»´åº¦å¢åŠ éçº¿æ€§è¡¨è¾¾èƒ½åŠ›ï¼Œæ˜¯ Transformer çš„æ ¸å¿ƒè®¡ç®—æ¨¡å—ä¹‹ä¸€ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-encoder-4">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/encoder/advanced-guide.md</code></p>
<h3>æ¢¯åº¦åˆ†æï¼ˆå…¬å¼ 5ï¼‰</h3>
<p><a id="formula-encoder-5-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.2074em;vertical-align:-0.836em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="mord mathnormal">L</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.2074em;vertical-align:-0.836em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">L</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="mord mathnormal">L</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:3.1304em;vertical-align:-1.3021em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8479em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.3021em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="mord mathnormal">L</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.8804em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šç¬¬ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span></span></span> å±‚çš„æ¢¯åº¦ç­‰äºæœ€åä¸€å±‚ç›´æ¥ä¼ å›çš„æ¢¯åº¦åŠ ä¸Šä¸­é—´å„å­å±‚çš„æ¢¯åº¦è´¡çŒ®ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºç¬¬ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span></span></span> å±‚è¾“å…¥ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">L</span></span></span></span> ä¸ºæ€»å±‚æ•°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºç¬¬ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> ä¸ªå­å±‚å˜æ¢ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šç¬¬ä¸€é¡¹ï¼ˆç›´è¿æ¢¯åº¦ï¼‰ä¿è¯å³ä½¿ç½‘ç»œå¾ˆæ·±ï¼Œæ¢¯åº¦ä¹Ÿèƒ½æ— æŸä¼ å›ï¼Œé˜²æ­¢æ¢¯åº¦æ¶ˆå¤±ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-encoder-5">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/encoder/advanced-guide.md</code></p>
<h3>Sinusoidalï¼ˆåŸå§‹ï¼‰ï¼ˆå…¬å¼ 6ï¼‰</h3>
<p><a id="formula-encoder-6-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0385em;vertical-align:-0.3552em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">os</span><span class="mpunct mtight">,</span><span class="mord mtight">2</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em;"></span><span class="mop">sin</span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mord mathnormal">os</span><span class="mord">/1000</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight">i</span><span class="mord mtight">/</span><span class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šè¯·ç»“åˆè¯¥ç« èŠ‚ä¸Šä¸‹æ–‡ç†è§£è¯¥å…¬å¼çš„è®¡ç®—ç›®æ ‡ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼šå˜é‡å®šä¹‰æ²¿ç”¨åŸç« èŠ‚ä¸­çš„ç¬¦å·çº¦å®šã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šè¯¥å…¬å¼ç”¨äºåˆ»ç”»è¯¥ä¸»é¢˜çš„æ ¸å¿ƒæœºåˆ¶ä¸å·¥ç¨‹ä½œç”¨ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-encoder-6">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/encoder/advanced-guide.md</code></p>
<h3>Sinusoidalï¼ˆåŸå§‹ï¼‰ï¼ˆå…¬å¼ 7ï¼‰</h3>
<p><a id="formula-encoder-7-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0385em;vertical-align:-0.3552em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">os</span><span class="mpunct mtight">,</span><span class="mord mtight">2</span><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em;"></span><span class="mop">cos</span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mord mathnormal">os</span><span class="mord">/1000</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight">i</span><span class="mord mtight">/</span><span class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šå¶æ•°ç»´åº¦ç”¨æ­£å¼¦ã€å¥‡æ•°ç»´åº¦ç”¨ä½™å¼¦ç¼–ç ä½ç½®ä¿¡æ¯ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">os</span></span></span></span> ä¸ºä½ç½®ç´¢å¼•ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> ä¸ºç»´åº¦ç´¢å¼•ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span> ä¸ºåµŒå…¥ç»´åº¦ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šä¸åŒé¢‘ç‡çš„æ­£å¼¦æ³¢ç»„åˆï¼Œè®©æ¨¡å‹èƒ½åŒºåˆ†ç›¸å¯¹ä½ç½®å…³ç³»ï¼›æ— å‚æ•°ä¸”å¯å¤–æ¨åˆ°ä»»æ„é•¿åº¦ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-encoder-7">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/encoder/advanced-guide.md</code></p>
<h3>è¾“å…¥è¡¨ç¤ºï¼ˆå…¬å¼ 8ï¼‰</h3>
<p><a id="formula-encoder-8-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">Input</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">TokenÂ Embedding</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">SegmentÂ Embedding</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">PositionÂ Embedding</span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šBERT è¾“å…¥ç”±ä¸‰ç§åµŒå…¥ç›¸åŠ å¾—åˆ°ï¼šè¯åµŒå…¥ã€å¥å­åµŒå…¥ã€ä½ç½®åµŒå…¥ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼šToken Embedding è¡¨ç¤ºè¯æœ¬èº«ï¼›Segment Embedding åŒºåˆ†å¥å­å¯¹ï¼›Position Embedding ç¼–ç ä½ç½®ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šå°†è¯è¯­ä¹‰ã€å¥å­å½’å±ã€ä½ç½®ä¿¡æ¯ç»Ÿä¸€ç¼–ç åˆ°åŒä¸€å‘é‡ç©ºé—´ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-encoder-8">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/encoder/advanced-guide.md</code></p>
<h3>Masked Language Model (MLM)ï¼ˆå…¬å¼ 9ï¼‰</h3>
<p><a id="formula-encoder-9-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal">ma</span><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord">âˆ£</span><span class="mord mathnormal">co</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mord mathnormal">t</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mopen">(</span><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.1413em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šç”¨ <code>[MASK]</code> ä½ç½®çš„éšè—çŠ¶æ€ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">h</span></span></span></span> ä¸è¯åµŒå…¥çŸ©é˜µ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span></span> è®¡ç®—ç›¸ä¼¼åº¦ï¼Œå†ç”¨ softmax å¾—åˆ°è¯æ¦‚ç‡åˆ†å¸ƒã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">h</span></span></span></span> ä¸º <code>[MASK]</code> ä½ç½®çš„è¡¨ç¤ºå‘é‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span></span> ä¸ºè¯åµŒå…¥çŸ©é˜µï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span> ä¸ºå…¶è½¬ç½®ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šå°†éšè—çŠ¶æ€æ˜ å°„å›è¯è¡¨ç©ºé—´ï¼Œé¢„æµ‹è¢«é®ç›–çš„åŸå§‹è¯ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-encoder-9">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/encoder/advanced-guide.md</code></p>
<h3>Next Sentence Prediction (NSP)ï¼ˆå…¬å¼ 10ï¼‰</h3>
<p><a id="formula-encoder-10-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mord mathnormal">t</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1052em;vertical-align:-0.3552em;"></span><span class="mord text"><span class="mord">sigmoid</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">[</span><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span><span class="mord mathnormal mtight">L</span><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mclose">)</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šç”¨ <code>[CLS]</code> ä½ç½®çš„éšè—çŠ¶æ€åšäºŒåˆ†ç±»ï¼Œåˆ¤æ–­ä¸¤å¥å­æ˜¯å¦è¿ç»­ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0496em;vertical-align:-0.3552em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">[</span><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span><span class="mord mathnormal mtight">L</span><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span></span></span></span></span></span></span> ä¸º <code>[CLS]</code> token çš„è¡¨ç¤ºï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span></span></span></span> ä¸ºåˆ†ç±»æƒé‡å‘é‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">sigmoid</span></span></span></span></span> å°†è¾“å‡ºå‹ç¼©åˆ° <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span>ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼š<code>[CLS]</code> èšåˆäº†å…¨å¥ä¿¡æ¯ï¼Œç”¨äºå¥å­çº§åˆ«çš„é¢„æµ‹ä»»åŠ¡ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-encoder-10">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/encoder/advanced-guide.md</code></p>
<h3>1. åŒå‘ä¸Šä¸‹æ–‡ï¼ˆå…¬å¼ 11ï¼‰</h3>
<p><a id="formula-encoder-11-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">â€¦</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šç¼–ç å™¨ä¸­æ¯ä¸ªä½ç½®çš„è¡¨ç¤ºéƒ½ä¾èµ–å…¨åºåˆ—ä¿¡æ¯ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºä½ç½® <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> çš„è¾“å‡ºè¡¨ç¤ºï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">â€¦</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºåºåˆ—æ‰€æœ‰ä½ç½®çš„è¾“å…¥ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šåŒå‘å»ºæ¨¡è®©æ¯ä¸ªè¯éƒ½èƒ½&quot;çœ‹åˆ°&quot;å‰åæ–‡ï¼Œæ›´é€‚åˆç†è§£ä»»åŠ¡ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-encoder-11">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/encoder/advanced-guide.md</code></p>
<h3>å‚æ•°å…±äº«ï¼ˆå…¬å¼ 12ï¼‰</h3>
<p><a id="formula-encoder-12-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em;"></span><span class="mord text"><span class="mord">MLM_logits</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9747em;vertical-align:-0.0833em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">b</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šé¢„æµ‹è¢«é®ç›–è¯æ—¶ï¼Œç›´æ¥å¤ç”¨è¾“å…¥è¯åµŒå…¥çŸ©é˜µä½œä¸ºè¾“å‡ºæŠ•å½±ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">h</span></span></span></span> ä¸ºéšè—çŠ¶æ€ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span> ä¸ºè¯åµŒå…¥çŸ©é˜µè½¬ç½®ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">b</span></span></span></span> ä¸ºåç½®ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šå…±äº«çŸ©é˜µå‡å°‘å‚æ•°é‡ï¼ŒåŒæ—¶è¾“å…¥å’Œè¾“å‡ºè¯­ä¹‰å¯¹é½æ›´ä¸€è‡´ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-encoder-12">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/encoder/advanced-guide.md</code></p>
<h2>è§£ç å™¨</h2>
<h3>æ•°å­¦å…¬å¼ï¼ˆå…¬å¼ 1ï¼‰</h3>
<p><a id="formula-decoder-1-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0489em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8019em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">LayerNorm</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">MaskedMHSA</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mclose">))</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šè¯·ç»“åˆè¯¥ç« èŠ‚ä¸Šä¸‹æ–‡ç†è§£è¯¥å…¬å¼çš„è®¡ç®—ç›®æ ‡ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼šå˜é‡å®šä¹‰æ²¿ç”¨åŸç« èŠ‚ä¸­çš„ç¬¦å·çº¦å®šã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šè¯¥å…¬å¼ç”¨äºåˆ»ç”»è¯¥ä¸»é¢˜çš„æ ¸å¿ƒæœºåˆ¶ä¸å·¥ç¨‹ä½œç”¨ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-decoder-1">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/decoder/advanced-guide.md</code></p>
<h3>æ•°å­¦å…¬å¼ï¼ˆå…¬å¼ 2ï¼‰</h3>
<p><a id="formula-decoder-2-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0489em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8019em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²â€²</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0519em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">LayerNorm</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8019em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0519em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">CrossAttention</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8019em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">c</span><span class="mclose">))</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šè¯·ç»“åˆè¯¥ç« èŠ‚ä¸Šä¸‹æ–‡ç†è§£è¯¥å…¬å¼çš„è®¡ç®—ç›®æ ‡ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼šå˜é‡å®šä¹‰æ²¿ç”¨åŸç« èŠ‚ä¸­çš„ç¬¦å·çº¦å®šã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šè¯¥å…¬å¼ç”¨äºåˆ»ç”»è¯¥ä¸»é¢˜çš„æ ¸å¿ƒæœºåˆ¶ä¸å·¥ç¨‹ä½œç”¨ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-decoder-2">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/decoder/advanced-guide.md</code></p>
<h3>æ•°å­¦å…¬å¼ï¼ˆå…¬å¼ 3ï¼‰</h3>
<p><a id="formula-decoder-3-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0519em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">LayerNorm</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8019em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²â€²</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0519em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">FFN</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8019em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²â€²</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose">))</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šè¯·ç»“åˆè¯¥ç« èŠ‚ä¸Šä¸‹æ–‡ç†è§£è¯¥å…¬å¼çš„è®¡ç®—ç›®æ ‡ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼šå˜é‡å®šä¹‰æ²¿ç”¨åŸç« èŠ‚ä¸­çš„ç¬¦å·çº¦å®šã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šè¯¥å…¬å¼ç”¨äºåˆ»ç”»è¯¥ä¸»é¢˜çš„æ ¸å¿ƒæœºåˆ¶ä¸å·¥ç¨‹ä½œç”¨ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-decoder-3">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/decoder/advanced-guide.md</code></p>
<h3>å› æœæ©ç ï¼ˆå…¬å¼ 4ï¼‰</h3>
<p><a id="formula-decoder-4-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord">âˆ’</span><span class="mord">âˆ</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">ifÂ </span></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â‰¤</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal">i</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">ifÂ </span></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šè¯·ç»“åˆè¯¥ç« èŠ‚ä¸Šä¸‹æ–‡ç†è§£è¯¥å…¬å¼çš„è®¡ç®—ç›®æ ‡ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼šå˜é‡å®šä¹‰æ²¿ç”¨åŸç« èŠ‚ä¸­çš„ç¬¦å·çº¦å®šã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šè¯¥å…¬å¼ç”¨äºåˆ»ç”»è¯¥ä¸»é¢˜çš„æ ¸å¿ƒæœºåˆ¶ä¸å·¥ç¨‹ä½œç”¨ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-decoder-4">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/decoder/advanced-guide.md</code></p>
<h3>å› æœæ©ç ï¼ˆå…¬å¼ 5ï¼‰</h3>
<p><a id="formula-decoder-5-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Attention</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4684em;vertical-align:-0.95em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.2528em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šç”¨æ©ç  <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span></span> æŠŠæœªæ¥ä½ç½®çš„æ³¨æ„åŠ›åˆ†æ•°è®¾ä¸º <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord">âˆ’</span><span class="mord">âˆ</span></span></span></span>ï¼Œsoftmax åæƒé‡ä¸º 0ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> è¡¨ç¤ºä½ç½® <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> æ˜¯å¦èƒ½çœ‹ä½ç½® <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span>ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºé”®ç»´åº¦ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šç¡®ä¿è§£ç æ—¶åªä½¿ç”¨å†å²ä¿¡æ¯ï¼Œç¬¦åˆè‡ªå›å½’ç”Ÿæˆã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-decoder-5">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/decoder/advanced-guide.md</code></p>
<h3>æ³¨æ„åŠ›çŸ©é˜µå½¢çŠ¶ï¼ˆå…¬å¼ 6ï¼‰</h3>
<p><a id="formula-decoder-6-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:4.8em;vertical-align:-2.15em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.65em;"><span class="pstrut" style="height:6.8em;"></span><span style="width:0.667em;height:4.800em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.800em" viewBox="0 0 667 4800"><path d="M403 1759 V84 H666 V0 H319 V1759 v1200 v1759 h347 v-84
H403z M403 1759 V0 H319 V1759 v1200 v1759 h84z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">âˆ’</span><span class="mord">âˆ</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">âˆ’</span><span class="mord">âˆ</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">âˆ’</span><span class="mord">âˆ</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">âˆ’</span><span class="mord">âˆ</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">âˆ’</span><span class="mord">âˆ</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">âˆ’</span><span class="mord">âˆ</span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.65em;"><span class="pstrut" style="height:6.8em;"></span><span style="width:0.667em;height:4.800em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.800em" viewBox="0 0 667 4800"><path d="M347 1759 V0 H0 V84 H263 V1759 v1200 v1759 H0 v84 H347z
M347 1759 V0 H263 V1759 v1200 v1759 h84z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šè¯·ç»“åˆè¯¥ç« èŠ‚ä¸Šä¸‹æ–‡ç†è§£è¯¥å…¬å¼çš„è®¡ç®—ç›®æ ‡ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼šå˜é‡å®šä¹‰æ²¿ç”¨åŸç« èŠ‚ä¸­çš„ç¬¦å·çº¦å®šã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šè¯¥å…¬å¼ç”¨äºåˆ»ç”»è¯¥ä¸»é¢˜çš„æ ¸å¿ƒæœºåˆ¶ä¸å·¥ç¨‹ä½œç”¨ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-decoder-6">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/decoder/advanced-guide.md</code></p>
<h3>ç”Ÿæˆè¿‡ç¨‹ï¼ˆå…¬å¼ 7ï¼‰</h3>
<p><a id="formula-decoder-7-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mord">âˆ£</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šè¯·ç»“åˆè¯¥ç« èŠ‚ä¸Šä¸‹æ–‡ç†è§£è¯¥å…¬å¼çš„è®¡ç®—ç›®æ ‡ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼šå˜é‡å®šä¹‰æ²¿ç”¨åŸç« èŠ‚ä¸­çš„ç¬¦å·çº¦å®šã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šè¯¥å…¬å¼ç”¨äºåˆ»ç”»è¯¥ä¸»é¢˜çš„æ ¸å¿ƒæœºåˆ¶ä¸å·¥ç¨‹ä½œç”¨ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-decoder-7">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/decoder/advanced-guide.md</code></p>
<h3>å®Œæ•´åºåˆ—æ¦‚ç‡ï¼ˆå…¬å¼ 8ï¼‰</h3>
<p><a id="formula-decoder-8-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">â€¦</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.0954em;vertical-align:-1.2671em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8829em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.2671em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">âˆ£</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight">t</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šæ•´å¥æ¦‚ç‡ç­‰äºæ¯ä¸€æ­¥æ¡ä»¶æ¦‚ç‡çš„è¿ä¹˜ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span> ä¸ºåºåˆ—é•¿åº¦ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight">t</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºå†å²ä¸Šä¸‹æ–‡ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šä½“ç°è‡ªå›å½’åˆ†è§£å‡è®¾ï¼Œé€æ­¥ç”Ÿæˆæ•´å¥ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-decoder-8">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/decoder/advanced-guide.md</code></p>
<h3>Greedy Decodingï¼ˆå…¬å¼ 9ï¼‰</h3>
<p><a id="formula-decoder-9-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.45em;vertical-align:-0.7em;"></span><span class="mop">ar<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4306em;"><span style="top:-2.4em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">max</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.7em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord">âˆ£</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šæ¯ä¸€æ­¥éƒ½é€‰å–æ¦‚ç‡æœ€é«˜çš„ tokenã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mop">ar<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">max</span></span></span></span> è¡¨ç¤ºå–å¾—ä½¿æ¦‚ç‡æœ€å¤§çš„ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span>ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šç¡®å®šæ€§è¾“å‡ºï¼Œä½†å¯èƒ½ç¼ºä¹å¤šæ ·æ€§ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-decoder-9">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/decoder/advanced-guide.md</code></p>
<h3>Samplingï¼ˆå…¬å¼ 10ï¼‰</h3>
<p><a id="formula-decoder-10-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆ¼</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord">âˆ£</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šæŒ‰ç…§æ¦‚ç‡åˆ†å¸ƒéšæœºé‡‡æ ·ä¸‹ä¸€ä¸ª tokenã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"></span><span class="mrel">âˆ¼</span></span></span></span> è¡¨ç¤ºâ€œæœä»è¯¥åˆ†å¸ƒé‡‡æ ·â€ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šæé«˜å¤šæ ·æ€§ï¼Œä½†å¯èƒ½å¼•å…¥å™ªå£°ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-decoder-10">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/decoder/advanced-guide.md</code></p>
<h3>Temperature Samplingï¼ˆå…¬å¼ 11ï¼‰</h3>
<p><a id="formula-decoder-11-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">p</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord">âˆ£</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4127em;vertical-align:-0.9857em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">âˆ‘</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1783em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6828em;"><span style="top:-2.786em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">exp</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6779em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop">exp</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mclose">)</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.9857em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šè¯·ç»“åˆè¯¥ç« èŠ‚ä¸Šä¸‹æ–‡ç†è§£è¯¥å…¬å¼çš„è®¡ç®—ç›®æ ‡ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼šå˜é‡å®šä¹‰æ²¿ç”¨åŸç« èŠ‚ä¸­çš„ç¬¦å·çº¦å®šã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šè¯¥å…¬å¼ç”¨äºåˆ»ç”»è¯¥ä¸»é¢˜çš„æ ¸å¿ƒæœºåˆ¶ä¸å·¥ç¨‹ä½œç”¨ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-decoder-11">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/decoder/advanced-guide.md</code></p>
<h3>è§£å†³æ–¹æ¡ˆï¼ˆå…¬å¼ 12ï¼‰</h3>
<p><a id="formula-decoder-12-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">â€¦</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šè¯·ç»“åˆè¯¥ç« èŠ‚ä¸Šä¸‹æ–‡ç†è§£è¯¥å…¬å¼çš„è®¡ç®—ç›®æ ‡ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼šå˜é‡å®šä¹‰æ²¿ç”¨åŸç« èŠ‚ä¸­çš„ç¬¦å·çº¦å®šã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šè¯¥å…¬å¼ç”¨äºåˆ»ç”»è¯¥ä¸»é¢˜çš„æ ¸å¿ƒæœºåˆ¶ä¸å·¥ç¨‹ä½œç”¨ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-decoder-12">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/decoder/advanced-guide.md</code></p>
<h3>è§£å†³æ–¹æ¡ˆï¼ˆå…¬å¼ 13ï¼‰</h3>
<p><a id="formula-decoder-13-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">â€¦</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šè¯·ç»“åˆè¯¥ç« èŠ‚ä¸Šä¸‹æ–‡ç†è§£è¯¥å…¬å¼çš„è®¡ç®—ç›®æ ‡ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼šå˜é‡å®šä¹‰æ²¿ç”¨åŸç« èŠ‚ä¸­çš„ç¬¦å·çº¦å®šã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šè¯¥å…¬å¼ç”¨äºåˆ»ç”»è¯¥ä¸»é¢˜çš„æ ¸å¿ƒæœºåˆ¶ä¸å·¥ç¨‹ä½œç”¨ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-decoder-13">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/decoder/advanced-guide.md</code></p>
<h3>å†…å­˜åˆ†æï¼ˆå…¬å¼ 14ï¼‰</h3>
<p><a id="formula-decoder-14-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">s</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šè¯·ç»“åˆè¯¥ç« èŠ‚ä¸Šä¸‹æ–‡ç†è§£è¯¥å…¬å¼çš„è®¡ç®—ç›®æ ‡ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼šå˜é‡å®šä¹‰æ²¿ç”¨åŸç« èŠ‚ä¸­çš„ç¬¦å·çº¦å®šã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šè¯¥å…¬å¼ç”¨äºåˆ»ç”»è¯¥ä¸»é¢˜çš„æ ¸å¿ƒæœºåˆ¶ä¸å·¥ç¨‹ä½œç”¨ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-decoder-14">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/decoder/advanced-guide.md</code></p>
<h3>è®­ç»ƒç›®æ ‡ï¼ˆå…¬å¼ 15ï¼‰</h3>
<p><a id="formula-decoder-15-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathcal">L</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.0954em;vertical-align:-1.2671em;"></span><span class="mord">âˆ’</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8829em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.2671em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">âˆ£</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight">t</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šå¯¹æ¯ä¸€æ­¥çš„æ­£ç¡® token æ¦‚ç‡å–å¯¹æ•°å¹¶æ±‚å’Œï¼Œå–è´Ÿå·å¾—åˆ°æŸå¤±ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">âˆ£</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight">t</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> ä¸ºæ¨¡å‹åœ¨ç¬¬ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span> æ­¥å¯¹çœŸå® token çš„æ¦‚ç‡ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šæ¦‚ç‡è¶Šå¤§ï¼ŒæŸå¤±è¶Šå°ï¼›è®­ç»ƒç›®æ ‡æ˜¯æœ€å¤§åŒ–çœŸå®åºåˆ—æ¦‚ç‡ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-decoder-15">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/decoder/advanced-guide.md</code></p>
<h3>Cross-Attentionï¼ˆç”¨äº Encoder-Decoderï¼‰ï¼ˆå…¬å¼ 16ï¼‰</h3>
<p><a id="formula-decoder-16-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">CrossAttention</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">e</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">e</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4684em;vertical-align:-0.95em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.2528em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.453em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">e</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">e</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šè¯·ç»“åˆè¯¥ç« èŠ‚ä¸Šä¸‹æ–‡ç†è§£è¯¥å…¬å¼çš„è®¡ç®—ç›®æ ‡ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼šå˜é‡å®šä¹‰æ²¿ç”¨åŸç« èŠ‚ä¸­çš„ç¬¦å·çº¦å®šã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šè¯¥å…¬å¼ç”¨äºåˆ»ç”»è¯¥ä¸»é¢˜çš„æ ¸å¿ƒæœºåˆ¶ä¸å·¥ç¨‹ä½œç”¨ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-decoder-16">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/decoder/advanced-guide.md</code></p>
<h2>æ··åˆä¸“å®¶æ¨¡å‹</h2>
<h3>åŸºæœ¬å®šä¹‰ï¼ˆå…¬å¼ 1ï¼‰</h3>
<p><a id="formula-moe-1-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">MoE</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">G</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šæ‰€æœ‰ä¸“å®¶çš„è¾“å‡ºåŠ æƒæ±‚å’Œï¼Œæƒé‡ç”±è·¯ç”±å™¨ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">G</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> å†³å®šã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> ä¸ºä¸“å®¶æ€»æ•°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">G</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºç¬¬ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> ä¸ªä¸“å®¶çš„æƒé‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> ä¸ºç¬¬ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> ä¸ªä¸“å®¶çš„è¾“å‡ºã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šä¸åŒä¸“å®¶ä¸“æ³¨äºä¸åŒç±»å‹çš„è¾“å…¥ï¼Œè·¯ç”±å™¨å†³å®šæ¯ä¸ªè¾“å…¥åº”ç”±å“ªäº›ä¸“å®¶å¤„ç†ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-moe-1">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/moe/advanced-guide.md</code></p>
<h3>ç¨€ç– MoE (Sparse MoE)ï¼ˆå…¬å¼ 2ï¼‰</h3>
<p><a id="formula-moe-2-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">SparseMoE</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.566em;vertical-align:-1.516em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.809em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">âˆˆ</span><span class="mord text mtight"><span class="mord mtight">TopK</span></span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">G</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">x</span><span class="mclose mtight">))</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.516em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">G</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šåªå–è·¯ç”±åˆ†æ•°æœ€é«˜çš„ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> ä¸ªä¸“å®¶å‚ä¸è®¡ç®—ï¼Œå…¶ä½™æƒé‡ç½®é›¶ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">TopK</span></span><span class="mopen">(</span><span class="mord mathnormal">G</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">))</span></span></span></span> è¿”å›è·¯ç”±åˆ†æ•°æœ€é«˜çš„ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> ä¸ªä¸“å®¶ç´¢å¼•ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> é€šå¸¸ä¸º 1 æˆ– 2ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šç¨€ç–æ¿€æ´»å¤§å¹…å‡å°‘è®¡ç®—é‡ï¼ŒåŒæ—¶ä¿æŒæ¨¡å‹å®¹é‡ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-moe-2">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/moe/advanced-guide.md</code></p>
<h3>1. Softmax è·¯ç”±ï¼ˆå…¬å¼ 3ï¼‰</h3>
<p><a id="formula-moe-3-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">G</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Softmax</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šå°†è¾“å…¥ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> çº¿æ€§æ˜ å°„åˆ° <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> ç»´ï¼Œå†ç» softmax å¾—åˆ°æ¯ä¸ªä¸“å®¶çš„æƒé‡ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mbin mtight">Ã—</span><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span></span></span></span> ä¸ºè·¯ç”±å™¨æƒé‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> ä¸ºè¾“å…¥å‘é‡ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šæƒé‡å’Œä¸º 1ï¼Œå¯è§£é‡Šä¸º&quot;é€‰æ‹©ä¸“å®¶çš„æ¦‚ç‡åˆ†å¸ƒ&quot;ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-moe-3">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/moe/advanced-guide.md</code></p>
<h3>2. Top-K è·¯ç”±ï¼ˆå…¬å¼ 4ï¼‰</h3>
<p><a id="formula-moe-4-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">G</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.1395em;vertical-align:-1.3198em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8198em;"><span style="top:-3.8198em;"><span class="pstrut" style="height:3.0323em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0323em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mop op-symbol small-op mtight" style="position:relative;top:0em;">âˆ‘</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1667em;"><span style="top:-2.1786em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">âˆˆ</span><span class="mord text mtight"><span class="mord mtight">TopK</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.4603em;"><span></span></span></span></span></span></span><span class="mspace mtight" style="margin-right:0.1952em;"></span><span class="mop mtight"><span class="mtight">e</span><span class="mtight">x</span><span class="mtight">p</span></span><span class="mopen mtight">((</span><span class="mord mathnormal mtight">x</span><span class="mbin mtight">â‹…</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.1389em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span></span></span></span></span></span></span><span class="mclose mtight"><span class="mclose mtight">)</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.5073em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mtight">e</span><span class="mtight">x</span><span class="mtight">p</span></span><span class="mopen mtight">((</span><span class="mord mathnormal mtight">x</span><span class="mbin mtight">â‹…</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.1389em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span></span></span></span></span></span></span><span class="mclose mtight"><span class="mclose mtight">)</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.6672em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-2.1445em;"><span class="pstrut" style="height:3.0323em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.3198em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8198em;"><span style="top:-3.8198em;"><span class="pstrut" style="height:3.0323em;"></span><span class="mord"><span class="mord text"><span class="mord">ifÂ </span></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord text"><span class="mord">TopK</span></span></span></span><span style="top:-2.1445em;"><span class="pstrut" style="height:3.0323em;"></span><span class="mord"><span class="mord text"><span class="mord">otherwise</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.3198em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šåªä¿ç•™ top-k ä¸“å®¶çš„æƒé‡ï¼Œå…¶ä½™ç½®é›¶ï¼Œå†å¯¹ä¿ç•™çš„æƒé‡å½’ä¸€åŒ–ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">TopK</span></span></span></span></span> ä¸ºåˆ†æ•°æœ€é«˜çš„ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> ä¸ªä¸“å®¶é›†åˆï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">exp</span><span class="mopen">(</span><span class="mord">â‹…</span><span class="mclose">)</span></span></span></span> ä¿è¯æƒé‡éè´Ÿã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šåªæ¿€æ´»å°‘æ•°ä¸“å®¶ï¼Œè®¡ç®—é‡ä¸ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> æˆæ­£æ¯”è€Œéä¸“å®¶æ€»æ•°ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-moe-4">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/moe/advanced-guide.md</code></p>
<h3>3. Top-K with Noiseï¼ˆå¸¦å™ªå£°çš„ Top-Kï¼‰ï¼ˆå…¬å¼ 5ï¼‰</h3>
<p><a id="formula-moe-5-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4445em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">StandardNormal</span></span><span class="mopen">(</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Softplus</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">se</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šè¯·ç»“åˆè¯¥ç« èŠ‚ä¸Šä¸‹æ–‡ç†è§£è¯¥å…¬å¼çš„è®¡ç®—ç›®æ ‡ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼šå˜é‡å®šä¹‰æ²¿ç”¨åŸç« èŠ‚ä¸­çš„ç¬¦å·çº¦å®šã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šè¯¥å…¬å¼ç”¨äºåˆ»ç”»è¯¥ä¸»é¢˜çš„æ ¸å¿ƒæœºåˆ¶ä¸å·¥ç¨‹ä½œç”¨ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-moe-5">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/moe/advanced-guide.md</code></p>
<h3>3. Top-K with Noiseï¼ˆå¸¦å™ªå£°çš„ Top-Kï¼‰ï¼ˆå…¬å¼ 6ï¼‰</h3>
<p><a id="formula-moe-6-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">G</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Softmax</span></span><span class="mopen">(</span><span class="mord text"><span class="mord">TopK</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)))</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šåœ¨è·¯ç”±åˆ†æ•°ä¸Šæ·»åŠ å¯å­¦ä¹ çš„å™ªå£°ï¼Œå¢åŠ è·¯ç”±çš„æ¢ç´¢æ€§ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">StandardNormal</span></span><span class="mopen">(</span><span class="mclose">)</span></span></span></span> ä¸ºæ ‡å‡†æ­£æ€é‡‡æ ·ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Softplus</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">se</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> æ§åˆ¶å™ªå£°å¤§å°ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šå™ªå£°è®©è·¯ç”±åœ¨è®­ç»ƒæ—¶æ¢ç´¢æ›´å¤šä¸“å®¶ç»„åˆï¼Œé¿å…è¿‡æ—©æ”¶æ•›åˆ°æ¬¡ä¼˜åˆ†é…ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-moe-6">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/moe/advanced-guide.md</code></p>
<h3>Load Balancing Lossï¼ˆå…¬å¼ 7ï¼‰</h3>
<p><a id="formula-moe-7-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">ux</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4445em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.4445em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šæƒ©ç½šä¸“å®¶è´Ÿè½½ä¸å‡è¡¡ï¼Œé¼“åŠ±æ‰€æœ‰ä¸“å®¶è¢«å‡åŒ€ä½¿ç”¨ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºå®é™…è·¯ç”±åˆ°ä¸“å®¶ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> çš„ token æ¯”ä¾‹ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºä¸“å®¶ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> çš„å¹³å‡è·¯ç”±æ¦‚ç‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span></span></span></span> ä¸ºè°ƒèŠ‚ç³»æ•°ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šå½“ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1/</span><span class="mord mathnormal">n</span></span></span></span> æ—¶æŸå¤±æœ€å°ï¼Œå³æ‰€æœ‰ä¸“å®¶è¢«å‡åŒ€æ¿€æ´»ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-moe-7">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/moe/advanced-guide.md</code></p>
<h3>å®Œæ•´æŸå¤±ï¼ˆå…¬å¼ 8ï¼‰</h3>
<p><a id="formula-moe-8-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">ux</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šæ€»æŸå¤± = ä»»åŠ¡æŸå¤± + è´Ÿè½½å‡è¡¡è¾…åŠ©æŸå¤±ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºç›®æ ‡ä»»åŠ¡æŸå¤±ï¼ˆå¦‚è¯­è¨€æ¨¡å‹æŸå¤±ï¼‰ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">ux</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºè´Ÿè½½å‡è¡¡æŸå¤±ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šè¾…åŠ©æŸå¤±å¼•å¯¼è·¯ç”±å™¨ï¿½ï¿½åŒ€ä½¿ç”¨æ‰€æœ‰ä¸“å®¶ï¼Œé¿å…&quot;ä¸“å®¶åå¡Œ&quot;ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-moe-8">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/moe/advanced-guide.md</code></p>
<h3>ä¸“å®¶å®¹é‡ï¼ˆExpert Capacityï¼‰ï¼ˆå…¬å¼ 9ï¼‰</h3>
<p><a id="formula-moe-9-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.912em;vertical-align:-0.2441em;"></span><span class="mord"><span class="mord text"><span class="mord">capacity</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2175em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0574em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">n</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em;"></span><span class="mord text"><span class="mord">capacity_factor</span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šæ¯ä¸ªä¸“å®¶çš„å®¹é‡ = æ€» token æ•° Ã— æ¯ä¸ª token æ¿€æ´»çš„ä¸“å®¶æ•° Ã· ä¸“å®¶æ€»æ•° Ã— å®¹é‡å› å­ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> ä¸ºæ€» token æ•°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> ä¸ºæ¯ä¸ª token æ¿€æ´»çš„ä¸“å®¶æ•°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> ä¸ºä¸“å®¶æ€»æ•°ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šå®¹é‡å› å­ &gt; 1 æä¾›ç¼“å†²ï¼Œé¿å…å› ä¸“å®¶è¿‡è½½è€Œä¸¢å¼ƒ tokenã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-moe-9">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/moe/advanced-guide.md</code></p>
<h2>è¯åµŒå…¥</h2>
<h3>æ¦‚è¿°ï¼ˆå…¬å¼ 1ï¼‰</h3>
<p><a id="formula-word-embedding-1-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â†’</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8991em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šå°†è¯æ±‡è¡¨ä¸­çš„æ¯ä¸ªè¯æ˜ å°„åˆ°ä¸€ä¸ª <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span> ç»´å®æ•°å‘é‡ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span> ä¸ºè¯æ±‡è¡¨ï¼ˆç¦»æ•£ç¬¦å·é›†åˆï¼‰ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span></span></span></span> ä¸º <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span> ç»´å®æ•°å‘é‡ç©ºé—´ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šç”¨ç¨ å¯†å‘é‡è¡¨ç¤ºè¯è¯­ï¼Œä½¿è¯­ä¹‰ç›¸è¿‘çš„è¯åœ¨å‘é‡ç©ºé—´ä¸­è·ç¦»ä¹Ÿç›¸è¿‘ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-word-embedding-1">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/embedding/word-embedding/advanced-guide.md</code></p>
<h3>1. Skip-gram æ¨¡å‹ï¼ˆå…¬å¼ 2ï¼‰</h3>
<p><a id="formula-word-embedding-2-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3.2666em;vertical-align:-1.4382em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8829em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.2671em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8479em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">âˆ’</span><span class="mord mathnormal mtight">c</span><span class="mrel mtight">â‰¤</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">â‰¤</span><span class="mord mathnormal mtight">c</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight"><span class="mrel mtight"><span class="mord vbox mtight"><span class="thinbox mtight"><span class="rlap mtight"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="inner"><span class="mord mtight"><span class="mrel mtight">î€ </span></span></span><span class="fix"></span></span></span></span></span><span class="mspace nobreak mtight"></span><span class="mrel mtight">=</span></span><span class="mord mtight">0</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.4382em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord">âˆ£</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šç”¨ä¸­å¿ƒè¯é¢„æµ‹ä¸Šä¸‹æ–‡è¯ï¼Œæœ€å¤§åŒ–æ‰€æœ‰ä½ç½®çš„å¯¹æ•°æ¦‚ç‡ä¹‹å’Œã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span> ä¸ºåºåˆ—é•¿åº¦ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">c</span></span></span></span> ä¸ºä¸Šä¸‹æ–‡çª—å£å¤§å°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord">âˆ£</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> ä¸ºç”¨ä¸­å¿ƒè¯é¢„æµ‹ä¸Šä¸‹æ–‡è¯çš„æ¦‚ç‡ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šè®©ä¸­å¿ƒè¯çš„å‘é‡èƒ½&quot;é¢„æµ‹&quot;å‘¨å›´è¯ï¼Œè¯­ä¹‰ç›¸è¿‘çš„è¯ä¼šæœ‰ç›¸ä¼¼çš„å‘é‡ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-word-embedding-2">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/embedding/word-embedding/advanced-guide.md</code></p>
<h3>1. Skip-gram æ¨¡å‹ï¼ˆå…¬å¼ 3ï¼‰</h3>
<p><a id="formula-word-embedding-3-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">o</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">âˆ£</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.7494em;vertical-align:-1.1709em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5784em;"><span style="top:-2.1288em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">âˆ‘</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">W</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">exp</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7673em;"><span style="top:-2.453em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2501em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.7371em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop">exp</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.453em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">o</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3471em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2501em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.1709em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šç”¨ä¸¤ä¸ªè¯å‘é‡çš„ç‚¹ç§¯è®¡ç®—ç›¸ä¼¼åº¦ï¼Œå†ç» softmax å½’ä¸€åŒ–ä¸ºæ¦‚ç‡ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6807em;vertical-align:-0.2501em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">o</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2501em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºä¸Šä¸‹æ–‡è¯å‘é‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6807em;vertical-align:-0.2501em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2501em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºä¸­å¿ƒè¯å‘é‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span></span></span> ä¸ºè¯è¡¨å¤§å°ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šç‚¹ç§¯è¡¡é‡ç›¸ä¼¼åº¦ï¼Œç›¸ä¼¼åº¦é«˜çš„è¯å¯¹é¢„æµ‹æ¦‚ç‡æ›´å¤§ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-word-embedding-3">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/embedding/word-embedding/advanced-guide.md</code></p>
<h3>2. è´Ÿé‡‡æ · (Negative Sampling)ï¼ˆå…¬å¼ 4ï¼‰</h3>
<p><a id="formula-word-embedding-4-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">o</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">âˆ£</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2384em;vertical-align:-0.3471em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.453em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">o</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3471em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2501em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:3.1304em;vertical-align:-1.3021em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8479em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.3021em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathbb">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span><span class="mrel mtight">âˆ¼</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.1389em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span></span></span></span><span class="mopen">[</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="mopen">(</span><span class="mord">âˆ’</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.453em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3529em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2501em;"><span></span></span></span></span></span></span><span class="mclose">)]</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šæ­£æ ·æœ¬ï¼ˆçœŸå®ä¸Šä¸‹æ–‡ï¼‰æ¦‚ç‡æœ€å¤§åŒ– + è´Ÿæ ·æœ¬ï¼ˆå™ªå£°è¯ï¼‰æ¦‚ç‡æœ€å°åŒ–ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span></span></span></span> ä¸º sigmoid å‡½æ•°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span> ä¸ºè´Ÿæ ·æœ¬æ•°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mclose">)</span></span></span></span> ä¸ºå™ªå£°åˆ†å¸ƒï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6864em;vertical-align:-0.2559em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2559em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºè´Ÿæ ·æœ¬è¯å‘é‡ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šåªéœ€è®¡ç®— <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> ä¸ªè¯è€Œéæ•´ä¸ªè¯è¡¨ï¼Œå¤§å¹…åŠ é€Ÿè®­ç»ƒã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-word-embedding-4">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/embedding/word-embedding/advanced-guide.md</code></p>
<h3>3. CBOW æ¨¡å‹ï¼ˆå…¬å¼ 5ï¼‰</h3>
<p><a id="formula-word-embedding-5-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">âˆ£</span><span class="mord text"><span class="mord">context</span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.7494em;vertical-align:-1.1709em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5784em;"><span style="top:-2.1288em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">âˆ‘</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">W</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">exp</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7673em;"><span style="top:-2.453em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">Ë‰</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">context</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.7371em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop">exp</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.453em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2963em;"><span style="top:-2.357em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3471em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">Ë‰</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">context</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.1709em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šç”¨ä¸Šä¸‹æ–‡è¯å‘é‡çš„å¹³å‡æ¥é¢„æµ‹ä¸­å¿ƒè¯çš„æ¦‚ç‡åˆ†å¸ƒã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7178em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">Ë‰</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">context</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºä¸Šä¸‹æ–‡è¯å‘é‡çš„å¹³å‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6807em;vertical-align:-0.2501em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2963em;"><span style="top:-2.357em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2501em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºä¸­å¿ƒè¯å‘é‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span></span></span> ä¸ºè¯è¡¨å¤§å°ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šä¸Šä¸‹æ–‡ä¿¡æ¯èšåˆæˆä¸€ä¸ªè¡¨ç¤ºï¼Œå†é¢„æµ‹æœ€å¯èƒ½çš„ä¸­å¿ƒè¯ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-word-embedding-5">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/embedding/word-embedding/advanced-guide.md</code></p>
<h3>ç›®æ ‡å‡½æ•°ï¼ˆå…¬å¼ 6ï¼‰</h3>
<p><a id="formula-word-embedding-6-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.2421em;vertical-align:-1.4138em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.4138em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.453em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6679em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span></span><span style="top:-3.35em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1667em;"><span class="mord">~</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.2174em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9313em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">b</span></span><span style="top:-3.6134em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">~</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.1502em;vertical-align:-0.2861em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šè®©è¯å‘é‡çš„ç‚¹ç§¯ + åç½®é€¼è¿‘å…±ç°æ¬¡æ•°çš„å¯¹æ•°ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºè¯ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> å’Œ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span> çš„å…±ç°æ¬¡æ•°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.954em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6679em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span></span><span style="top:-3.35em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1667em;"><span class="mord">~</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºä¸­å¿ƒè¯å’Œä¸Šä¸‹æ–‡è¯å‘é‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> ä¸ºæƒé‡å‡½æ•°ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šåˆ©ç”¨å…¨å±€å…±ç°ç»Ÿè®¡ï¼Œå­¦ä¹ èƒ½æ•æ‰è¯é—´å…³ç³»çš„å‘é‡è¡¨ç¤ºã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-word-embedding-6">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/embedding/word-embedding/advanced-guide.md</code></p>
<h3>ç›®æ ‡å‡½æ•°ï¼ˆå…¬å¼ 7ï¼‰</h3>
<p><a id="formula-word-embedding-7-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord">/</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mtight">m</span><span class="mtight">a</span><span class="mtight">x</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.0037em;">Î±</span></span></span></span></span></span></span></span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">ifÂ </span></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mtight">m</span><span class="mtight">a</span><span class="mtight">x</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">otherwise</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šå¯¹ä½é¢‘å…±ç°ç»™äºˆè¾ƒå°æƒé‡ï¼Œé«˜é¢‘å…±ç°æƒé‡å°é¡¶ä¸º 1ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mtight">m</span><span class="mtight">a</span><span class="mtight">x</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºæˆªæ–­é˜ˆå€¼ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span></span></span></span> ä¸ºå¹‚æ¬¡å‚æ•°ï¼ˆé€šå¸¸ 0.75ï¼‰ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šé˜²æ­¢é«˜é¢‘è¯ï¼ˆå¦‚&quot;çš„&quot;ï¼‰ä¸»å¯¼è®­ç»ƒç›®æ ‡ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-word-embedding-7">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/embedding/word-embedding/advanced-guide.md</code></p>
<h3>1. ä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆå…¬å¼ 8ï¼‰</h3>
<p><a id="formula-word-embedding-8-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">sim</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0575em;vertical-align:-0.9361em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1215em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">âˆ¥</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2501em;"><span></span></span></span></span></span></span><span class="mord">âˆ¥âˆ¥</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2501em;"><span></span></span></span></span></span></span><span class="mord">âˆ¥</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2501em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2501em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.9361em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šç”¨ä¸¤ä¸ªå‘é‡çš„å¤¹è§’ä½™å¼¦å€¼è¡¡é‡ç›¸ä¼¼åº¦ï¼ŒèŒƒå›´ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">âˆ’</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span>ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6807em;vertical-align:-0.2501em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2501em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2501em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºä¸¤ä¸ªè¯çš„å‘é‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">âˆ¥</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">âˆ¥</span></span></span></span> ä¸ºå‘é‡æ¨¡é•¿ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šå½’ä¸€åŒ–ååªçœ‹æ–¹å‘ä¸çœ‹å¤§å°ï¼Œè¯­ä¹‰ç›¸è¿‘çš„è¯å¤¹è§’å°ã€ä½™å¼¦å€¼å¤§ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-word-embedding-8">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/embedding/word-embedding/advanced-guide.md</code></p>
<h3>2. ç±»æ¯”å…³ç³»ï¼ˆå…¬å¼ 9ï¼‰</h3>
<p><a id="formula-word-embedding-9-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0001em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2077em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z"/></svg></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mord mathnormal mtight">in</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.864em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2077em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z"/></svg></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">man</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.864em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2077em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z"/></svg></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">man</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â‰ˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0001em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2077em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z"/></svg></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">ee</span><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šè¯å‘é‡ç©ºé—´ä¸­çš„çº¿æ€§è¿ç®—å¯è¡¨ç¤ºè¯­ä¹‰ç±»æ¯”å…³ç³»ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.864em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2077em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z"/></svg></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">or</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºè¯çš„å‘é‡è¡¨ç¤ºï¼›å‡æ³•å’ŒåŠ æ³•ä¸ºå‘é‡è¿ç®—ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šâ€œking - man + womanâ€ ä½“ç°äº†&quot;ç”·æ€§â†’å¥³æ€§&quot;çš„è¯­ä¹‰æ–¹å‘ï¼Œåº”ç”¨åˆ° king å¾—åˆ° queenã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-word-embedding-9">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/embedding/word-embedding/advanced-guide.md</code></p>
<h2>ä½ç½®åµŒå…¥</h2>
<h3>ä¸ºä»€ä¹ˆéœ€è¦ä½ç½®ä¿¡æ¯ï¼Ÿï¼ˆå…¬å¼ 1ï¼‰</h3>
<p><a id="formula-position-embedding-1-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Attention</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4684em;vertical-align:-0.95em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.2528em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šæ³¨æ„åŠ›çš„è¾“å‡ºåªä¾èµ– Qã€Kã€V çš„å€¼ï¼Œä¸åºåˆ—é¡ºåºæ— å…³ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span> ä¸ºæŸ¥è¯¢ã€é”®ã€å€¼çŸ©é˜µï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºé”®ç»´åº¦ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šæ‰“ä¹±è¾“å…¥é¡ºåºåªæ”¹å˜è¾“å‡ºé¡ºåºï¼Œä¸æ”¹å˜å†…å®¹ï¼›å› æ­¤éœ€è¦é¢å¤–æ³¨å…¥ä½ç½®ä¿¡æ¯ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-position-embedding-1">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/embedding/position-embedding/advanced-guide.md</code></p>
<h3>Sinusoidal Position Encodingï¼ˆå…¬å¼ 2ï¼‰</h3>
<p><a id="formula-position-embedding-2-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0385em;vertical-align:-0.3552em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">os</span><span class="mpunct mtight">,</span><span class="mord mtight">2</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.854em;vertical-align:-0.704em;"></span><span class="mop">sin</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size2">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em;"><span style="top:-2.296em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1000</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.814em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight">i</span><span class="mord mtight">/</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="mord mathnormal">os</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.704em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size2">)</span></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šè¯·ç»“åˆè¯¥ç« èŠ‚ä¸Šä¸‹æ–‡ç†è§£è¯¥å…¬å¼çš„è®¡ç®—ç›®æ ‡ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼šå˜é‡å®šä¹‰æ²¿ç”¨åŸç« èŠ‚ä¸­çš„ç¬¦å·çº¦å®šã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šè¯¥å…¬å¼ç”¨äºåˆ»ç”»è¯¥ä¸»é¢˜çš„æ ¸å¿ƒæœºåˆ¶ä¸å·¥ç¨‹ä½œç”¨ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-position-embedding-2">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/embedding/position-embedding/advanced-guide.md</code></p>
<h3>Sinusoidal Position Encodingï¼ˆå…¬å¼ 3ï¼‰</h3>
<p><a id="formula-position-embedding-3-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0385em;vertical-align:-0.3552em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">os</span><span class="mpunct mtight">,</span><span class="mord mtight">2</span><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.854em;vertical-align:-0.704em;"></span><span class="mop">cos</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size2">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em;"><span style="top:-2.296em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1000</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.814em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight">i</span><span class="mord mtight">/</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="mord mathnormal">os</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.704em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size2">)</span></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šå¶æ•°ç»´åº¦ç”¨æ­£å¼¦ã€å¥‡æ•°ç»´åº¦ç”¨ä½™å¼¦ç¼–ç ä½ç½®ä¿¡æ¯ï¼Œä¸åŒç»´åº¦ä½¿ç”¨ä¸åŒé¢‘ç‡ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">os</span></span></span></span> ä¸ºä½ç½®ç´¢å¼•ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> ä¸ºç»´åº¦ç´¢å¼•ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºåµŒå…¥ç»´åº¦ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">10000</span></span></span></span> ä¸ºåº•æ•°æ§åˆ¶é¢‘ç‡èŒƒå›´ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šæ¯ä¸ªä½ç½®æœ‰å”¯ä¸€ç¼–ç ï¼›ä½ç»´æ•æ‰å±€éƒ¨ä½ç½®ï¼Œé«˜ç»´æ•æ‰å…¨å±€ä½ç½®ï¼›å¯å¤–æ¨åˆ°è®­ç»ƒæœªè§é•¿åº¦ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-position-embedding-3">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/embedding/position-embedding/advanced-guide.md</code></p>
<h3>3. ç›¸å¯¹ä½ç½®å…³ç³»ï¼ˆå…¬å¼ 4ï¼‰</h3>
<p><a id="formula-position-embedding-4-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">sin</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">sin</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">cos</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">cos</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">sin</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šæ­£å¼¦å‡½æ•°çš„åŠ æ³•å…¬å¼è¡¨æ˜ä½ç½® <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">os</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> çš„ç¼–ç å¯ç”±ä½ç½® <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">os</span></span></span></span> çš„ç¼–ç çº¿æ€§å˜æ¢å¾—åˆ°ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> ä¸ºå½“å‰ä½ç½®ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> ä¸ºåç§»é‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">cos</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">sin</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span></span></span></span> ä¸ºå›ºå®šå¸¸æ•°ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šæ¨¡å‹å¯é€šè¿‡å­¦ä¹ çº¿æ€§å˜æ¢æ¥&quot;è®¡ç®—&quot;ç›¸å¯¹ä½ç½®å…³ç³»ï¼Œæ— éœ€æ˜¾å¼ç¼–ç æ‰€æœ‰ä½ç½®å¯¹ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-position-embedding-4">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/embedding/position-embedding/advanced-guide.md</code></p>
<h3>é¢‘ç‡åˆ†æï¼ˆå…¬å¼ 5ï¼‰</h3>
<p><a id="formula-position-embedding-5-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">Î»</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.03588em;">Ï€</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.938em;"></span><span class="mord">1000</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight">i</span><span class="mord mtight">/</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šä¸åŒç»´åº¦çš„æ­£å¼¦æ³¢æœ‰ä¸åŒçš„å‘¨æœŸ/æ³¢é•¿ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">Î»</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºç¬¬ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> ç»´çš„æ³¢é•¿ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.03588em;">Ï€</span></span></span></span> ä¸ºæ­£å¼¦å‘¨æœŸç³»æ•°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.888em;"></span><span class="mord">1000</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight">i</span><span class="mord mtight">/</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> æ§åˆ¶æ³¢é•¿å¢é•¿é€Ÿåº¦ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šä½ç»´åº¦æ³¢é•¿çŸ­ï¼ˆæ•æ„Ÿäºä½ç½®å˜åŒ–ï¼‰ï¼Œé«˜ç»´åº¦æ³¢é•¿å¤§ï¼ˆæ•æ‰è¿œè·ç¦»å…³ç³»ï¼‰ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-position-embedding-5">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/embedding/position-embedding/advanced-guide.md</code></p>
<h3>Learnable Position Embeddingï¼ˆå…¬å¼ 6ï¼‰</h3>
<p><a id="formula-position-embedding-6-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">ina</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">or</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">os</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šå°†è¯åµŒå…¥ä¸ä½ç½®åµŒå…¥ç›¸åŠ å¾—åˆ°æœ€ç»ˆè¾“å…¥è¡¨ç¤ºã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">or</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºè¯åµŒå…¥ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">os</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºå¯å­¦ä¹ çš„ä½ç½®åµŒå…¥ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">L</span></span></span></span> ä¸ºæœ€å¤§åºåˆ—é•¿åº¦ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span> ä¸ºç»´åº¦ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šï¿½ï¿½ç½®åµŒå…¥ä½œä¸ºå‚æ•°å­¦ä¹ ï¼Œèƒ½è‡ªé€‚åº”æ•°æ®åˆ†å¸ƒï¼Œä½†é•¿åº¦å—é™äºè®­ç»ƒæ—¶çš„æœ€å¤§é•¿åº¦ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-position-embedding-6">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/embedding/position-embedding/advanced-guide.md</code></p>
<h3>Shawâ€™s Relative Position Encodingï¼ˆå…¬å¼ 7ï¼‰</h3>
<p><a id="formula-position-embedding-7-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.5561em;vertical-align:-0.93em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6261em;"><span style="top:-2.2528em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.7848em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3948em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šåœ¨é”®å‘é‡ä¸ŠåŠ ä¸Šç›¸å¯¹ä½ç½®ç¼–ç  <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2361em;vertical-align:-0.3948em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3948em;"><span></span></span></span></span></span></span></span></span></span>ï¼Œè®©æ³¨æ„åŠ›è€ƒè™‘ä½ç½®å…³ç³»ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºä½ç½® <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span> çš„è¾“å…¥ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0358em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span></span></span></span></span></span></span> ä¸ºæŠ•å½±çŸ©é˜µï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2361em;vertical-align:-0.3948em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3948em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºç›¸å¯¹ä½ç½® <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7429em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span> çš„ç¼–ç ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šæ³¨æ„åŠ›åˆ†æ•°ä¸ä»…ä¾èµ–å†…å®¹ç›¸ä¼¼åº¦ï¼Œè¿˜ä¾èµ–ç›¸å¯¹ä½ç½®å…³ç³»ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-position-embedding-7">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/embedding/position-embedding/advanced-guide.md</code></p>
<h3>T5 Biasï¼ˆå…¬å¼ 8ï¼‰</h3>
<p><a id="formula-position-embedding-8-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Attention</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4684em;vertical-align:-0.95em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.2528em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šåœ¨æ³¨æ„åŠ›åˆ†æ•°ä¸ŠåŠ ä¸€ä¸ªç›¸å¯¹ä½ç½®åç½®çŸ©é˜µ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span>ï¼Œå† softmaxã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1072em;vertical-align:-0.25em;"></span><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mord">/</span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span></span></span></span></span></span></span></span></span> ä¸ºå†…å®¹åˆ†æ•°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> ä¸ºç›¸å¯¹ä½ç½®åç½®çŸ©é˜µï¼ˆ<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> ä¾èµ– <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7429em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span>ï¼‰ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šç®€å•ç›´æ¥åœ°è®©æ¨¡å‹å­¦ä¹ &quot;è·ç¦»è¶Šè¿œ/è¿‘&quot;åº”è¯¥å¦‚ä½•å½±å“æ³¨æ„åŠ›ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-position-embedding-8">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/embedding/position-embedding/advanced-guide.md</code></p>
<h3>RoPE (Rotary Position Embedding)ï¼ˆå…¬å¼ 9ï¼‰</h3>
<p><a id="formula-position-embedding-9-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">RoPE</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">m</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">(</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6548em;"><span style="top:-3.6548em;"><span class="pstrut" style="height:3.0448em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.5834em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1166em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.0448em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.5834em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">2</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1166em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.1548em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size4">)</span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âŠ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop">cos</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="mclose">)</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop">sin</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="mclose">)</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šå¯¹å‘é‡æ¯ä¸¤ç»´ä¸€ç»„ï¼Œä¹˜ä»¥ä½ç½® <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span> å¯¹åº”çš„æ—‹è½¬è§’åº¦çš„æ­£å¼¦ä½™å¼¦ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2392em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.5834em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1166em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.5834em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">2</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1166em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºç¬¬ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span> ä¸ªä½ç½®çš„å‘é‡åˆ†é‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">m</span><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span></span></span></span> ä¸ºæ—‹è½¬è§’åº¦ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord">âŠ—</span></span></span></span> ä¸ºé€å…ƒç´ ä¹˜ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šä½ç½®ä¿¡æ¯é€šè¿‡æ—‹è½¬è§’åº¦æ³¨å…¥ï¼Œç›¸å¯¹ä½ç½®ç›¸åŒåˆ™å†…ç§¯ä¹Ÿç›¸åŒã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-position-embedding-9">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/embedding/position-embedding/advanced-guide.md</code></p>
<h3>RoPE (Rotary Position Embedding)ï¼ˆå…¬å¼ 10ï¼‰</h3>
<p><a id="formula-position-embedding-10-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">âŸ¨</span><span class="mord text"><span class="mord">RoPE</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">m</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord">RoPE</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">n</span><span class="mclose">)âŸ©</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Re</span></span><span class="mopen">[âŸ¨</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">âŸ©</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">m</span><span class="mbin mtight">âˆ’</span><span class="mord mathnormal mtight">n</span><span class="mclose mtight">)</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">Î¸</span></span></span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šä¸¤ä¸ªä½ç½®çš„ RoPE ç¼–ç çš„å†…ç§¯åªä¾èµ–å®ƒä»¬çš„ç›¸å¯¹ä½ç½® <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span>ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">âŸ¨</span><span class="mord">â‹…</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">â‹…</span><span class="mclose">âŸ©</span></span></span></span> ä¸ºå†…ç§¯ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.888em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">m</span><span class="mbin mtight">âˆ’</span><span class="mord mathnormal mtight">n</span><span class="mclose mtight">)</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">Î¸</span></span></span></span></span></span></span></span></span></span></span></span> ä¸ºå¤æŒ‡æ•°å½¢å¼è¡¨ç¤ºç›¸å¯¹ä½ç½®æ—‹è½¬ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šæ— è®ºç»å¯¹ä½ç½®åœ¨å“ªï¼Œåªè¦ç›¸å¯¹è·ç¦»ç›¸åŒï¼Œæ³¨æ„åŠ›åˆ†æ•°çš„ç»“æ„å°±ç›¸åŒã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-position-embedding-10">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/embedding/position-embedding/advanced-guide.md</code></p>
<h3>ALiBi (Attention with Linear Biases)ï¼ˆå…¬å¼ 11ï¼‰</h3>
<p><a id="formula-position-embedding-11-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord text"><span class="mord">score</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.4445em;"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">âˆ£</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mord">âˆ£</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šåœ¨å†…å®¹åˆ†æ•°ä¸Šå‡å»ä¸è·ç¦»æˆæ­£æ¯”çš„æƒ©ç½šé¡¹ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºå†…å®¹åˆ†æ•°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span> ä¸ºæ¯ä¸ªå¤´çš„æ–œç‡ï¼ˆæ§åˆ¶è·ç¦»è¡°å‡é€Ÿåº¦ï¼‰ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">âˆ£</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mord">âˆ£</span></span></span></span> ä¸ºç»å¯¹è·ç¦»ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šè·ç¦»è¶Šè¿œæƒ©ç½šè¶Šå¤§ï¼Œæ¨¡å‹è‡ªç„¶åå¥½å…³æ³¨è¿‘å¤„ï¼›æ— å‚æ•°ä¸”å¤–æ¨èƒ½åŠ›å¼ºã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-position-embedding-11">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/embedding/position-embedding/advanced-guide.md</code></p>
<h2>å…¨é‡å¾®è°ƒ</h2>
<h3>æ¦‚è¿°ï¼ˆå…¬å¼ 1ï¼‰</h3>
<p><a id="formula-full-finetune-1-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:3.0954em;vertical-align:-1.2671em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Î·</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8829em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.2671em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord">âˆ‡</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">W</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathcal">L</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.1389em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3473em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šä»é¢„è®­ç»ƒæƒé‡å‡ºå‘ï¼Œç”¨ç›®æ ‡ä»»åŠ¡æ•°æ®åšæ¢¯åº¦ä¸‹é™æ›´æ–°æ‰€æœ‰å‚æ•°ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºé¢„è®­ç»ƒæƒé‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Î·</span></span></span></span> ä¸ºå­¦ä¹ ç‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathcal">L</span></span></span></span> ä¸ºæŸå¤±å‡½æ•°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span> ä¸ºè®­ç»ƒæ­¥æ•°ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šå…¨å‚æ•°æ›´æ–°è®©æ¨¡å‹å……åˆ†é€‚åº”æ–°ä»»åŠ¡ï¼Œæ•ˆæœé€šå¸¸æœ€å¥½ä½†æ˜¾å­˜éœ€æ±‚å¤§ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-full-finetune-1">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/fine-tuning/full-finetune/advanced-guide.md</code></p>
<h3>é—®é¢˜å®šä¹‰ï¼ˆå…¬å¼ 2ï¼‰</h3>
<p><a id="formula-full-finetune-2-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">Forgetting</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord text"><span class="mord">Perf</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">or</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord text"><span class="mord">Perf</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">or</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šé—å¿˜é‡ = é¢„è®­ç»ƒæ¨¡å‹åœ¨åŸä»»åŠ¡ä¸Šçš„æ€§èƒ½ - å¾®è°ƒååœ¨åŸä»»åŠ¡ä¸Šçš„æ€§èƒ½ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord text"><span class="mord">Perf</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºé¢„è®­ç»ƒæ¨¡å‹æ€§èƒ½ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord text"><span class="mord">Perf</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºå¾®è°ƒåæ¨¡å‹æ€§èƒ½ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">or</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºåŸä»»åŠ¡ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šé‡åŒ–å¾®è°ƒå¯¹åŸæœ‰èƒ½åŠ›çš„æŸå®³ç¨‹åº¦ï¼Œå€¼è¶Šå¤§è¡¨ç¤ºé—å¿˜è¶Šä¸¥é‡ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-full-finetune-2">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/fine-tuning/full-finetune/advanced-guide.md</code></p>
<h3>æ˜¾å­˜ä¼°ç®—ï¼ˆå…¬å¼ 3ï¼‰</h3>
<p><a id="formula-full-finetune-3-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">Memory</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â‰ˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord text"><span class="mord">Params</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">Bytes</span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šå…¨å‚æ•°å¾®è°ƒæ˜¾å­˜çº¦ä¸ºæ¨¡å‹å‚æ•°çš„ 4 å€ï¼ˆä»¥åŒç²¾åº¦è®¡ï¼‰ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord text"><span class="mord">Params</span></span></span></span></span> ä¸ºå‚æ•°æ•°é‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">Bytes</span></span></span></span></span> ä¸ºæ¯ä¸ªæ•°å€¼çš„å­—èŠ‚æ•°ï¼ˆå¦‚ FP16 ä¸º 2ï¼‰ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šéœ€è¦å­˜å‚¨æ¨¡å‹å‰¯æœ¬ã€æ¢¯åº¦ã€ä¼˜åŒ–å™¨çŠ¶æ€ï¼ˆå¦‚ Adam çš„åŠ¨é‡ï¼‰å’Œæ¿€æ´»ï¼Œæ€»å¼€é”€å¤§ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-full-finetune-3">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/fine-tuning/full-finetune/advanced-guide.md</code></p>
<h2>LoRAå¾®è°ƒ</h2>
<h3>æ¦‚è¿°ï¼ˆå…¬å¼ 1ï¼‰</h3>
<p><a id="formula-lora-finetune-1-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">Î”</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal">A</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šå†»ç»“åŸæƒé‡ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>ï¼Œæ–°å¢ä¸¤ä¸ªä½ç§©çŸ©é˜µ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> å’Œ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span> çš„ä¹˜ç§¯æ¥è¡¨ç¤ºæƒé‡æ›´æ–°ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºé¢„è®­ç»ƒæƒé‡ï¼ˆå†»ç»“ï¼‰ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mbin mtight">Ã—</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span></span></span></span></span></span></span></span> ä¸ºé™ç»´çŸ©é˜µï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mbin mtight">Ã—</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span></span></span></span></span> ä¸ºå‡ç»´çŸ©é˜µï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span> ä¸ºç§©ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šç”¨æå°‘çš„å¯è®­ç»ƒå‚æ•°ï¼ˆ<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span></span></span></span>ï¼‰è¿‘ä¼¼å…¨å‚æ•°æ›´æ–°ï¼ˆ<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span>ï¼‰ï¼Œå¤§å¹…é™ä½æ˜¾å­˜éœ€æ±‚ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-lora-finetune-1">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/fine-tuning/lora-finetune/advanced-guide.md</code></p>
<h3>æƒé‡æ›´æ–°çš„ä½ç§©è¡¨ç¤ºï¼ˆå…¬å¼ 2ï¼‰</h3>
<p><a id="formula-lora-finetune-2-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">Î”</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal">A</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šè¯·ç»“åˆè¯¥ç« èŠ‚ä¸Šä¸‹æ–‡ç†è§£è¯¥å…¬å¼çš„è®¡ç®—ç›®æ ‡ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼šå˜é‡å®šä¹‰æ²¿ç”¨åŸç« èŠ‚ä¸­çš„ç¬¦å·çº¦å®šã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šè¯¥å…¬å¼ç”¨äºåˆ»ç”»è¯¥ä¸»é¢˜çš„æ ¸å¿ƒæœºåˆ¶ä¸å·¥ç¨‹ä½œç”¨ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-lora-finetune-2">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/fine-tuning/lora-finetune/advanced-guide.md</code></p>
<h3>å‰å‘ä¼ æ’­ï¼ˆå…¬å¼ 3ï¼‰</h3>
<p><a id="formula-lora-finetune-3-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.7936em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal">A</span><span class="mord mathnormal">x</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šè¾“å‡º = å†»ç»“æƒé‡çš„è¾“å‡º + LoRA æ›´æ–°çš„è¾“å‡ºï¼ˆå¸¦ç¼©æ”¾å› å­ï¼‰ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal">x</span></span></span></span> ä¸ºåŸæ¨¡å‹è¾“å‡ºï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal">A</span><span class="mord mathnormal">x</span></span></span></span> ä¸º LoRA å¢é‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span></span></span></span> ä¸ºç¼©æ”¾å› å­ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span> ä¸ºç§©ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span> æ§åˆ¶ LoRA æ›´æ–°çš„å½±å“å¼ºåº¦ï¼›é™¤ä»¥ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span> è®©è°ƒ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span></span></span></span> æ—¶æ— éœ€å› ç§©ä¸åŒè€Œé‡æ–°è°ƒå‚ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-lora-finetune-3">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/fine-tuning/lora-finetune/advanced-guide.md</code></p>
<h3>Alpha (Î±)ï¼ˆå…¬å¼ 4ï¼‰</h3>
<p><a id="formula-lora-finetune-4-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em;"></span><span class="mord text"><span class="mord">effective_lr</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.7936em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em;"></span><span class="mord text"><span class="mord">learning_rate</span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šè¯·ç»“åˆè¯¥ç« èŠ‚ä¸Šä¸‹æ–‡ç†è§£è¯¥å…¬å¼çš„è®¡ç®—ç›®æ ‡ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼šå˜é‡å®šä¹‰æ²¿ç”¨åŸç« èŠ‚ä¸­çš„ç¬¦å·çº¦å®šã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šè¯¥å…¬å¼ç”¨äºåˆ»ç”»è¯¥ä¸»é¢˜çš„æ ¸å¿ƒæœºåˆ¶ä¸å·¥ç¨‹ä½œç”¨ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-lora-finetune-4">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/fine-tuning/lora-finetune/advanced-guide.md</code></p>
<h3>åˆå¹¶ç­–ç•¥ï¼ˆå…¬å¼ 5ï¼‰</h3>
<p><a id="formula-lora-finetune-5-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">er</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.7936em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal">A</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šå°† LoRA çš„ä½ç§©æ›´æ–°åˆå¹¶åˆ°åŸæƒé‡ï¼Œå¾—åˆ°æ–°çš„å®Œæ•´æƒé‡çŸ©é˜µã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºé¢„è®­ç»ƒæƒé‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">A</span></span></span></span> ä¸ºè®­ç»ƒåçš„ LoRA çŸ©é˜µï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span> ä¸ºç¼©æ”¾å› å­ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šåˆå¹¶åæ¨¡å‹ä¸åŸæ¨¡å‹ç»“æ„ç›¸åŒï¼Œéƒ¨ç½²æ—¶æ— éœ€ LoRA ä»£ç ï¼Œæ— é¢å¤–æ¨ç†å¼€é”€ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-lora-finetune-5">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/fine-tuning/lora-finetune/advanced-guide.md</code></p>
<h2>æ¨¡å‹é‡åŒ–</h2>
<h3>æ¦‚è¿°ï¼ˆå…¬å¼ 1ï¼‰</h3>
<p><a id="formula-quantization-1-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9468em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9468em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span><span style="top:-3.2523em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">^</span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4445em;"></span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="mord text"><span class="mord">clamp</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord text"><span class="mord">round</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">s</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">âˆ’</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šå°†æµ®ç‚¹æ•°é™¤ä»¥ç¼©æ”¾å› å­ã€å››èˆäº”å…¥ã€æˆªæ–­åˆ°ç›®æ ‡èŒƒå›´ï¼Œå†ä¹˜å›å¤åŸã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">s</span></span></span></span> ä¸ºç¼©æ”¾å› å­ï¼ˆscaleï¼‰ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">b</span></span></span></span> ä¸ºç›®æ ‡ä½å®½ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord">round</span></span></span></span></span> ä¸ºèˆå…¥ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">clamp</span></span></span></span></span> ä¸ºæˆªæ–­åˆ° <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0991em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">âˆ’</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span>ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šç”¨æœ‰é™çš„æ•´æ•°è¿‘ä¼¼è¿ç»­æµ®ç‚¹æ•°ï¼Œç‰ºç‰²å°‘é‡ç²¾åº¦æ¢å–å¤§å¹…å‹ç¼©ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-quantization-1">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/inference/quantization/advanced-guide.md</code></p>
<h3>1. å¯¹ç§°é‡åŒ–ï¼ˆå…¬å¼ 2ï¼‰</h3>
<p><a id="formula-quantization-2-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.113em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7751em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop">max</span><span class="mopen">(</span><span class="mord">âˆ£</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mord">âˆ£</span><span class="mclose">)</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šè¯·ç»“åˆè¯¥ç« èŠ‚ä¸Šä¸‹æ–‡ç†è§£è¯¥å…¬å¼çš„è®¡ç®—ç›®æ ‡ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼šå˜é‡å®šä¹‰æ²¿ç”¨åŸç« èŠ‚ä¸­çš„ç¬¦å·çº¦å®šã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šè¯¥å…¬å¼ç”¨äºåˆ»ç”»è¯¥ä¸»é¢˜çš„æ ¸å¿ƒæœºåˆ¶ä¸å·¥ç¨‹ä½œç”¨ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-quantization-2">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/inference/quantization/advanced-guide.md</code></p>
<h3>1. å¯¹ç§°é‡åŒ–ï¼ˆå…¬å¼ 3ï¼‰</h3>
<p><a id="formula-quantization-3-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4445em;"></span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.836em;vertical-align:-0.686em;"></span><span class="mord text"><span class="mord">round</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size2">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">s</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">x</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size2">)</span></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šç¼©æ”¾å› å­ç”±æœ€å¤§ç»å¯¹å€¼å†³å®šï¼Œé‡ï¿½ï¿½èŒƒå›´å…³äº 0 å¯¹ç§°ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">s</span></span></span></span> ä¸ºç¼©æ”¾å› å­ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">b</span></span></span></span> ä¸ºä½å®½ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span> ä¸ºé‡åŒ–çº§åˆ«æ•°çš„ä¸€åŠã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šé›¶ç‚¹ä¿æŒä¸å˜ï¼Œå®ç°ç®€å•ï¼Œä½†éå‡åŒ€åˆ†å¸ƒæ—¶ä¼šæµªè´¹éƒ¨åˆ†é‡åŒ–èŒƒå›´ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-quantization-3">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/inference/quantization/advanced-guide.md</code></p>
<h3>2. éå¯¹ç§°é‡åŒ–ï¼ˆå…¬å¼ 4ï¼‰</h3>
<p><a id="formula-quantization-4-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.1963em;vertical-align:-0.7693em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7751em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop">max</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mop">min</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mclose">)</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šè¯·ç»“åˆè¯¥ç« èŠ‚ä¸Šä¸‹æ–‡ç†è§£è¯¥å…¬å¼çš„è®¡ç®—ç›®æ ‡ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼šå˜é‡å®šä¹‰æ²¿ç”¨åŸç« èŠ‚ä¸­çš„ç¬¦å·çº¦å®šã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šè¯¥å…¬å¼ç”¨äºåˆ»ç”»è¯¥ä¸»é¢˜çš„æ ¸å¿ƒæœºåˆ¶ä¸å·¥ç¨‹ä½œç”¨ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-quantization-4">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/inference/quantization/advanced-guide.md</code></p>
<h3>2. éå¯¹ç§°é‡åŒ–ï¼ˆå…¬å¼ 5ï¼‰</h3>
<p><a id="formula-quantization-5-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="mord text"><span class="mord">round</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord">âˆ’</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">s</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop">min</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mclose">)</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šè¯·ç»“åˆè¯¥ç« èŠ‚ä¸Šä¸‹æ–‡ç†è§£è¯¥å…¬å¼çš„è®¡ç®—ç›®æ ‡ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼šå˜é‡å®šä¹‰æ²¿ç”¨åŸç« èŠ‚ä¸­çš„ç¬¦å·çº¦å®šã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šè¯¥å…¬å¼ç”¨äºåˆ»ç”»è¯¥ä¸»é¢˜çš„æ ¸å¿ƒæœºåˆ¶ä¸å·¥ç¨‹ä½œç”¨ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-quantization-5">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/inference/quantization/advanced-guide.md</code></p>
<h3>2. éå¯¹ç§°é‡åŒ–ï¼ˆå…¬å¼ 6ï¼‰</h3>
<p><a id="formula-quantization-6-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4445em;"></span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">round</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord">/</span><span class="mord mathnormal">s</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mclose">)</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šç¼©æ”¾å› å­ç”±å€¼åŸŸèŒƒå›´å†³å®šï¼Œå¼•å…¥é›¶ç‚¹åç§» <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span></span> é€‚é…éå¯¹ç§°åˆ†å¸ƒã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">s</span></span></span></span> ä¸ºç¼©æ”¾å› å­ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span></span> ä¸ºé›¶ç‚¹ï¼ˆzero pointï¼‰ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9324em;vertical-align:-0.0833em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> ä¸ºé‡åŒ–çº§åˆ«æ•°ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šå……åˆ†åˆ©ç”¨æ•´ä¸ªé‡åŒ–èŒƒå›´ï¼Œç²¾åº¦æ›´é«˜ï¼Œä½†éœ€è¦é¢å¤–å­˜å‚¨é›¶ç‚¹ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-quantization-6">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/inference/quantization/advanced-guide.md</code></p>
<h3>åŸç†ï¼ˆå…¬å¼ 7ï¼‰</h3>
<p><a id="formula-quantization-7-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.6787em;vertical-align:-0.9287em;"></span><span class="mop">ar<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6679em;"><span style="top:-2.1713em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord accent mtight"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9468em;"><span style="top:-2.7em;"><span class="pstrut" style="height:2.7em;"></span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">W</span></span><span style="top:-2.9523em;"><span class="pstrut" style="height:2.7em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord mtight">^</span></span></span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">min</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.9287em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">âˆ¥</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.1968em;vertical-align:-0.25em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9468em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span><span style="top:-3.2523em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">^</span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mord"><span class="mord">âˆ¥</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šå¯»æ‰¾é‡åŒ–åçš„ï¿½ï¿½ï¿½é‡ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9468em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9468em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span><span style="top:-3.2523em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">^</span></span></span></span></span></span></span></span></span></span>ï¼Œä½¿å…¶è¾“å‡ºä¸åŸå§‹æƒé‡ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span></span></span> çš„è¾“å‡ºå°½å¯èƒ½æ¥è¿‘ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span></span></span> ä¸ºåŸå§‹æƒé‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9468em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9468em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span><span style="top:-3.2523em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">^</span></span></span></span></span></span></span></span></span></span> ä¸ºé‡åŒ–åæƒé‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span> ä¸ºè¾“å…¥æ¿€æ´»ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">âˆ¥</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord">âˆ¥</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span> ä¸º L2 èŒƒæ•°å¹³æ–¹ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šç›´æ¥ä¼˜åŒ–ä»»åŠ¡ç›¸å…³è¯¯å·®ï¼ˆè¾“å‡ºå·®å¼‚ï¼‰ï¼Œè€Œéå•çº¯çš„æƒé‡è¯¯å·®ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-quantization-7">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/inference/quantization/advanced-guide.md</code></p>
<h3>ç®—æ³•æµç¨‹ï¼ˆå…¬å¼ 8ï¼‰</h3>
<p><a id="formula-quantization-8-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0385em;vertical-align:-0.3552em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">[</span><span class="mrel mtight">:</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â†</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0385em;vertical-align:-0.3552em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">[</span><span class="mrel mtight">:</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:2.5765em;vertical-align:-0.99em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5865em;"><span style="top:-2.2869em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8231em;"><span style="top:-2.4231em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.0448em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2769em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">Ïµ</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.7452em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03785em;">Î´</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0379em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4413em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">[</span><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.99em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šå°†å½“å‰åˆ—çš„é‡åŒ–è¯¯å·®é€šè¿‡ Hessian é€†çŸ©é˜µä¼ æ’­åˆ°åç»­æœªé‡åŒ–çš„åˆ—ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03785em;">Î´</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0379em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºç¬¬ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> åˆ—çš„é‡åŒ–è¯¯å·®ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1965em;vertical-align:-0.3552em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4413em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">[</span><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºæ¿€æ´»åæ–¹å·®ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">Ïµ</span></span></span></span> ä¸ºæ•°å€¼ç¨³å®šæ€§å¸¸æ•°ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šç”¨åç»­åˆ—çš„è°ƒæ•´æ¥è¡¥å¿å½“å‰åˆ—é‡åŒ–å¸¦æ¥çš„è¾“å‡ºè¯¯å·®ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-quantization-8">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/inference/quantization/advanced-guide.md</code></p>
<h3>ç®—æ³•ï¼ˆå…¬å¼ 9ï¼‰</h3>
<p><a id="formula-quantization-9-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9468em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9468em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span><span style="top:-3.2523em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">^</span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">s</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8641em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šå…ˆå¯¹æƒé‡åšç¼©æ”¾ï¼Œé‡åŒ–åå†é€†å‘ç¼©æ”¾ï¼Œä½¿é‡è¦æƒé‡è·å¾—æ›´é«˜ç²¾åº¦ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span></span></span> ä¸ºåŸå§‹æƒé‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">s</span></span></span></span> ä¸ºæ¯é€šé“ç¼©æ”¾å› å­ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord">â‹…</span><span class="mclose">)</span></span></span></span> ä¸ºé‡åŒ–å‡½æ•°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span> ä¸ºé€å…ƒç´ é™¤æ³•ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šç¼©æ”¾åé‡è¦æƒé‡çš„å€¼åŸŸæ‰©å¤§ï¼Œï¿½ï¿½åŒ–æ—¶è¢«åˆ†é…æ›´å¤šé‡åŒ–çº§åˆ«ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-quantization-9">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/inference/quantization/advanced-guide.md</code></p>
<h3>ç®—æ³•ï¼ˆå…¬å¼ 10ï¼‰</h3>
<p><a id="formula-quantization-10-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">max</span><span class="mopen">(</span><span class="mord">âˆ£</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">âˆ£</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7144em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.0037em;">Î±</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šç¼©æ”¾å› å­ç”±æ¿€æ´»å€¼çš„å¹…å€¼å†³å®šï¼Œæ¿€æ´»è¶Šå¤§çš„é€šé“æƒé‡è¶Šé‡è¦ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºç¬¬ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> é€šé“çš„æ¿€æ´»å€¼ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span></span></span></span> ä¸ºè°ƒèŠ‚å¹‚æ¬¡ï¼ˆé€šå¸¸æ¥è¿‘ 1ï¼‰ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šæ¿€æ´»å¤§çš„é€šé“å¯¹è¾“å‡ºå½±å“æ›´å¤§ï¼Œåº”ä¿ç•™æ›´é«˜ç²¾åº¦çš„æƒé‡ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-quantization-10">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/inference/quantization/advanced-guide.md</code></p>
<h2>æ¨ç†åŠ é€Ÿ</h2>
<h3>åŸç†ï¼ˆå…¬å¼ 1ï¼‰</h3>
<p><a id="formula-inference-acceleration-1-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Attention</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šç”Ÿæˆç¬¬ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span> ä¸ª token æ—¶ï¼Œéœ€è¦å½“å‰æŸ¥è¯¢ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸æ‰€æœ‰å†å²é”®å€¼ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> è®¡ç®—æ³¨æ„åŠ›ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºå½“å‰ä½ç½®çš„æŸ¥è¯¢å‘é‡ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºä»ä½ç½® 1 åˆ° <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span> çš„é”®å€¼åºåˆ—ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šæ¯ç”Ÿæˆä¸€ä¸ª token éƒ½è¦&quot;çœ‹&quot;ä¹‹å‰æ‰€æœ‰ä½ç½®ï¼Œè®¡ç®—é‡éšé•¿åº¦çº¿æ€§å¢é•¿ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-inference-acceleration-1">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/inference/inference-acceleration/advanced-guide.md</code></p>
<h3>å†…å­˜éœ€æ±‚ï¼ˆå…¬å¼ 2ï¼‰</h3>
<p><a id="formula-inference-acceleration-2-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord">KVÂ Cache</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">bytes</span></span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šKV Cache å¤§å°ä¸å±‚æ•°ã€å¤´æ•°ã€æ¯å¤´ç»´åº¦ã€åºåˆ—é•¿åº¦æˆæ­£æ¯”ã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">L</span></span></span></span> ä¸ºå±‚æ•°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">h</span></span></span></span> ä¸ºæ³¨æ„åŠ›å¤´æ•°ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸ºæ¯å¤´ç»´åº¦ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">s</span></span></span></span> ä¸ºåºåˆ—é•¿åº¦ï¼›bytes ä¸ºæ¯ä¸ªæ•°å€¼çš„å­—èŠ‚æ•°ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šåºåˆ—è¶Šé•¿ç¼“å­˜è¶Šå¤§ï¼Œæ˜¯é•¿ä¸Šä¸‹æ–‡æ¨ç†çš„ä¸»è¦å†…å­˜ç“¶é¢ˆï¼›2 è¡¨ç¤º K å’Œ V ä¸¤ä»½ç¼“å­˜ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-inference-acceleration-2">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/inference/inference-acceleration/advanced-guide.md</code></p>
<h3>æ ‡å‡†æ³¨æ„åŠ›ï¼ˆå…¬å¼ 3ï¼‰</h3>
<p><a id="formula-inference-acceleration-3-detail"></a>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Attention</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4684em;vertical-align:-0.95em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.1778em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9322em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord mathnormal">d</span></span></span><span style="top:-2.8922em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1078em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span></p>
<p><strong>è¯¦ç»†è®²è§£ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰</strong></p>
<ul>
<li><strong>ä¸€å¥è¯å…ˆæ‡‚</strong>ï¼šè®¡ç®— Q ä¸ K çš„ç›¸ä¼¼åº¦ï¼Œç¼©æ”¾å softmax å¾—åˆ°æƒé‡ï¼Œå†å¯¹ V åŠ æƒæ±‚å’Œã€‚</li>
<li><strong>åˆ†æ­¥ç†è§£</strong>ï¼šä½ å¯ä»¥æŠŠè¿™æ¡å…¬å¼çœ‹æˆ 3 æ­¥ï¼šå…ˆæ‹¿åˆ°è¾“å…¥ï¼›å†æŒ‰å…¬å¼é‡Œçš„è§„åˆ™åšè¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å½’ä¸€åŒ–ã€åŠ æƒç­‰ï¼‰ï¼›æœ€åå¾—åˆ°è¾“å‡ºç»“æœã€‚</li>
<li><strong>å˜é‡ç™½è¯</strong>ï¼š<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span> ä¸ºæŸ¥è¯¢ã€é”®ã€å€¼çŸ©é˜µï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span> ä¸ºé”®ç»´åº¦ï¼›<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.04em;vertical-align:-0.1078em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9322em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord mathnormal">d</span></span></span><span style="top:-2.8922em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1078em;"><span></span></span></span></span></span></span></span></span> ä¸ºç¼©æ”¾å› å­ã€‚</li>
<li><strong>ç›´è§‰ç†è§£</strong>ï¼šæ ¸å¿ƒæ³¨æ„åŠ›å…¬å¼ï¼Œä½†éœ€è¦å­˜å‚¨ <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> çš„æ³¨æ„åŠ›çŸ©é˜µï¼Œå†…å­˜å¼€é”€å¤§ã€‚</li>
<li><strong>ç”Ÿæ´»ç±»æ¯”</strong>ï¼šæŠŠå®ƒæƒ³æˆâ€œåšèœé…æ–¹â€ã€‚è¾“å…¥æ˜¯é£Ÿæï¼Œå‚æ•°æ˜¯è°ƒæ–™æ¯”ä¾‹ï¼Œå…¬å¼æ˜¯åšèœæ­¥éª¤ï¼Œè¾“å‡ºå°±æ˜¯æˆå“å‘³é“ã€‚</li>
<li><strong>å®é™…æœ‰ä»€ä¹ˆç”¨</strong>ï¼šå®ƒå¸®åŠ©æ¨¡å‹å†³å®šâ€œå“ªäº›ä¿¡æ¯è¯¥æ”¾å¤§ã€å“ªäº›è¯¥å¿½ç•¥â€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚</li>
<li><strong>ç»™æ–°æ‰‹çš„è®°å¿†æ³•</strong>ï¼šå…ˆè®°è¿™æ¡å…¬å¼è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œå†è®°æœ€å…³é”®çš„ 2-3 ä¸ªç¬¦å·ï¼Œæœ€åå†çœ‹å®Œæ•´å†™æ³•ï¼Œä¸è¦ä¸€æ¬¡ç¡¬èƒŒå…¨éƒ¨ç¬¦å·ã€‚
<a href="#formula-inference-acceleration-3">â†© è¿”å›åŸä½ç½®</a></li>
</ul>
<p>æ¥æºï¼š<code>topics/inference/inference-acceleration/advanced-guide.md</code></p>
</div>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: 'default',
      maxTextSize: 100000,
      themeVariables: {
        fontFamily: 'Noto Sans SC, PingFang SC, Microsoft YaHei, sans-serif'
      }
    });
  </script>
</body>
</html>